/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-notice-list/fs-notice-list",["util","uilibs/pagination","moment","./fs-notice-list.html","./fs-notice-list.css","modules/feed-list/feed-list-helper","modules/fs-attach/fs-attach-preview"],function(a,b,c){var d=window,e=d.FS;e.tpl;var f=a("util"),g=a("uilibs/pagination"),h=a("moment"),i=a("./fs-notice-list.html");a("./fs-notice-list.css");var j=a("modules/feed-list/feed-list-helper"),k=a("modules/fs-attach/fs-attach-preview"),l=new k({belongToType:"notice"}).render();j.picturesFormat;var m=f.getContactData();m.u;var i=$(i),n=Backbone.Model.extend({}),o=Backbone.Collection.extend({model:n,sync:function(a,b,c){var d=c.data||{};c.data=_.extend({pageSize:10,pageNumber:1},d),Backbone.sync("read",b,c)},parse:function(a){var b=a.value.notices;return a.success?_.each(b,function(a){var b=a.noticeType,c=a.noticeTypeDesc,d=a.title,f=a.noticeContent,g=a.noticeTime,i=a.isNew,j=a.pasths||[],k=j.length,l="",m="",n="";g=h.unix(g).format("MMMDD日 HH:mm"),k>0&&(m=j[0].attachPath,l='<div class="feed-img"><div class="img-warp"><table><tr><td valign="middle" align="center"><img src="'+e.API_PATH+"/df/GetGlobal/?id="+m+'3.jpg"/></td></tr></table></div></div>',k>1&&(l='<div class="feedpics-bor feed-img"><div class="fpt-group"><div class="img-warp" style="position: absolute;"><table><tr><td valign="middle" align="center"><img src="'+e.API_PATH+"/df/GetGlobal/?id="+m+'3.jpg" alt=""/></td></tr></table></div></div></div><p class="pic-num">图集(共'+k+"张)</p>")),b=2==b?"notice-re":"",i&&(n='<div class="img-new"></div>'),_.extend(a,{noticeType:b,noticeTypeDesc:c,noticeTime:g,title:d,feedPic:l,newico:n,noticeContent:f})}):b=[],b}}),p=Backbone.View.extend({tagName:"div",className:"fs-notice-list-item",events:{"click .item-media .feed-img":"_previewImg"},initialize:function(){var a=i.filter(".fs-notice-list-tpl").html();this.template=_.template(a),this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},_previewImg:function(){var a=this.model,b=a.get("pasths"),c=[];_.each(b,function(a,b){c[b]={previewPath:a.attachPath+"2",originPath:a.attachPath+"1",thumbPath:a.attachPath+"3",createTime:a.createTime,fileName:"系统通知.jpg",fileSize:a.attachSize}}),l.preview({type:"img",data:c,refId:0,belongToType:"notice"})}}),q=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:15,visiblePageNums:7},listPath:"/attach_html/getAttachImgFilesOfIReceive",defaultRequestData:{},searchOpts:{inputSelector:null,btnSelector:null},listCb:e.EMPTY_FN,listEmptyText:"暂无记录"},a||{}),this.opts=a,this.element=$(a.element),this.pagEl=$(a.pagSelector),this.pagination=null,this.tempRequestData={},this.init()};_.extend(q.prototype,{init:function(){var a,b=this,c=this.opts,d=this.element;d.addClass("fs-notice-list"),a=new o,a.on("add",function(a){var b;b=new p({model:a}).render(),b.$el.data("itemV",b).appendTo(d)}),this.list=a,this.pagination=new g(_.extend({element:this.pagEl},c.pagOpts)),this.pagination.on("page",function(){b.empty(),b.fetch()}),this.pagination.render(),this._initListEmptyTip()},_searchBarInit:function(){var a,b=this,c=this.opts,d=c.searchOpts,e=this.element,f=$(d.inputSelector),g=$(d.btnSelector);a=$('<div class="list-search-bar fn-clear"></div>'),a.html('<span class="result-info fn-left">共搜索到<span class="num color-red">0</span>条信息</span><a class="back-l fn-right" href="#" title="返回查看全部"><< 返回查看全部</a>'),a.hide().prependTo(e);var h=$('<span class="empty-h">&#10005;</span>'),i=$('<span class="list-search-input-wrapper"></span>');f.wrap(i),i=f.closest(".list-search-input-wrapper"),h.hide().appendTo(i),f.keydown(function(a){13==a.keyCode&&g.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(h.show(),f.addClass("with-input-value")):(h.hide(),f.removeClass("with-input-value"))}),h.click(function(){f.val(""),f.removeClass("with-input-value"),h.hide()}),a.on("click",".back-l",function(a){b.reload({keyword:""}),f.val(""),f.removeClass("with-input-value"),h.hide(),a.preventDefault()})},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".num",d);return!a.isFirstChar&&a.keyword.length>0&&b.success?(e.text(b.value.totalCount),d.show(),void 0):(d.hide(),void 0)},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+e.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.appendTo(a)},_updatelistStatus:function(a){var b,c=this.element,d=$(".list-empty-tip",c);a.success&&(b=a.value.totalCount,0==b?d.show():d.hide())},fetch:function(){var a=this,b=this.opts;this.list;var c=this.pagination,d=_.extend({pageSize:c.get("pageSize"),pageNumber:c.get("activePageNumber")});d=_.isFunction(b.defaultRequestData)?_.extend(b.defaultRequestData(),d):_.extend(b.defaultRequestData,d),d=_.extend(d,this.tempRequestData),this.tempRequestData={},this.showLoading(),this.list.fetch({url:b.listPath,data:d,success:function(d,e){var f;e.success&&(f=e.value,c.setTotalSize(f.totalCount),a._updatelistStatus(e),b.listCb.call(a,e),a.hideLoading())}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a){this.tempRequestData=a,this.pagination.jump(1)},reload:function(a){this.load(a)},empty:function(){var a=this.element,b=$(".fs-notice-list-item",a);b.each(function(){var a=$(this),b=a.data("itemV");b.remove(),a.removeData()}),a.empty()},destroy:function(){this.list=null,this.pagination.destroy(),this.loading&&this.loading.stop(),this.empty(),this.pagination=null,this.tempRequestData={},this.element=null}}),c.exports=q});