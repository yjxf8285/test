/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-map/fs-map",["events","overlay","position","moment","util","./fs-map.html","./fs-map.css"],function(a,b,c){var d=window,e=d.FS,f=a("events"),g=a("overlay"),h=a("position"),i=a("moment"),j=a("util"),k=a("./fs-map.html"),l=(a("./fs-map.css"),($.browser||0).msie&&6==$.browser.version),m=$(document.body),n=($("html"),$(document),$(window)),o=$(k),p=function(a){a=_.extend({element:null,enforcRefresh:!0,autoOpenTip:!0,tipTpl:""},a||{}),this.element=$(a.element),this.opts=a,this.pointers=[],this.init()};_.extend(p.prototype,{init:function(){this.opts},_initMap:function(a){var b,c,d,e,f=a.AMap;b=new f.Map("map",{center:new f.LngLat(116.392936,39.919479)}),b.plugin(["AMap.ToolBar","AMap.OverView,AMap.Scale"],function(){c=new f.ToolBar({direction:!1,ruler:!1,autoPosition:!1}),b.addControl(c),d=new f.OverView({visible:!1}),b.addControl(d),e=new f.Scale,b.addControl(e)}),this.mapCore=b,this.AMap=f,this.trigger("mapinit",a)},_getMapIframe:function(){var a=this,b=this.element,c=$(".map-ifr",b);return 0==c.length&&(c=$('<iframe class="map-ifr" src="'+e.BASE_PATH+'/html/fs/modules/fs-map/fs-map-container.html" frameborder="0" scrolling="no" />'),c.load(function(){a._initMap(this.contentWindow)}),c.appendTo(b),this.adjustSize()),c},adjustSize:function(){var a=this.element,b=$(".map-ifr",a);b.length>0&&(b.attr("width",a.width()),b.attr("height",a.height())),this.mapCore&&this.mapCore.setFitView()},setLocation:function(a){var b=this.opts,c=b.enforcRefresh;this.mapCore&&c&&this.clear(),this.mapCore?this._setLocation(a):(this._getMapIframe(),this.one("mapinit",function(){this._setLocation(a)}))},_setLocation:function(a){var b=this,c=this.opts,d=c.tipTpl,e=this.mapCore,f=this.AMap;a=[].concat(a),e.clearMap(),e.clearInfoWindow(),_.each(this.pointers,function(a){f.event.removeListener(a.clickHandler)}),this.pointers=[],_.each(a,function(a,g){var h;h=_.isFunction(d)?d.call(b,a):h.toString();var i=new f.Marker({map:e,position:new f.LngLat(a.longitude,a.latitude),offset:new f.Pixel(0,-30),content:'<span class="tip-pointer">'+(g+1)+"</span>"}),j=new f.InfoWindow({isCustom:!0,content:'<div class="fs-map-tip"><div class="tip-content">'+h+'</div><span class="triangle-down-wrapper"><span class="triangle-down-1 triangle-down">&#9660;</span><span class="triangle-down-2 triangle-down">&#9660;</span></span></div>',offset:new f.Pixel(0,-45)}),k=f.event.addListener(i,"click",function(){j.getIsOpen()?j.close():(j.open(e,i.getPosition()),e.setCenter(i.getPosition()))});c.autoOpenTip&&j.open(e,i.getPosition()),b.pointers.push({clickHandler:k,pointer:i,data:a})});try{e.setFitView()}catch(g){}},clear:function(){var a=this.element,b=$(".map-ifr",a);this.off(),this.mapCore&&this.mapCore.destroy(),this.mapCore=null,this.AMap=null,this.pointers=null,b.length>0&&b.unbind("load").remove(),a.empty()},destroy:function(){return this.clear(),this.element=null,this.opts=null,this}}),f.mixTo(p);var q=g.extend({attrs:{width:l?n.width():"100%",height:l?n.height():"100%",className:"fs-map-overlay",opacity:1,backgroundColor:"#000",style:{position:l?"absolute":"fixed",top:0,left:0},align:{baseElement:l?m:void 0},zIndex:100},events:{"click .close-l":"_clickCloseLink","click .qd-l":"hide"},show:function(){return l&&(this.set("width",n.width()),this.set("height",n.height()),this.element.css({top:n.scrollTop(),left:n.scrollLeft()})),q.superclass.show.call(this)},setup:function(){var a=this;return this._createEl(),this._setupMap(),this.before("show",function(){j.setFullScreen(!0)}),this.after("show",function(){a.adjustPosSize()}),this.after("hide",function(){j.setFullScreen(!1)}),this.element.on("click",function(){}),this.after("_setPosition",function(){l&&(this.element.css({top:n.scrollTop(),left:n.scrollLeft()}),this.set("width",n.width()),this.set("height",n.height())),a.adjustPosSize()}),l&&n.scroll(function(){var b=a.element;b.is(":visible")&&(b.css({top:n.scrollTop(),left:n.scrollLeft()}),a.adjustPosSize())}),this._regEvents(),q.superclass.setup.call(this)},_setupMap:function(){var a=this,b=this.element,c=$(".iframe-wrapper",b);this.map=new p({element:c,tipTpl:function(b){var c=a._addressHelper(b);return'<h3 style="margin-bottom: 15px;">'+c+'</h3><p style="color:#999999;">'+j.getDateSummaryDesc(i.unix(b.createTime),new Date,2)+"</p>"}})},_addressHelper:function(a){return j.getLocationInfo(a)},adjustPosSize:function(){var a=this.element,b=$(".map-wrapper",a);b.width(.9*a.width()),b.height(.8*a.height()),h.center(b,a),this.map&&this.map.adjustSize()},_regEvents:function(){},_unRegEvents:function(){},_clickCloseLink:function(a){this.hide(),a.preventDefault(),a.stopPropagation()},_createEl:function(){var a=this.element;a.html(o.filter(".fs-map-overlay-tpl").html())},fixLocation:function(a,b){var c=this.map;b=_.extend({showQd:!0},b||{}),c.setLocation(a),this.updateSummary(a,b),this.show()},updateSummary:function(a,b){var c=this.element,d=$(".map-summary",c),e=$(".address",d),f=$(".qd-l",d),g=b.showQd;e.text(this._addressHelper(a)),g?f.show():f.hide(),f.attr("href","#profile/profilelocations/=/id-"+a.employeeID)},render:function(){var a;return a=q.superclass.render.apply(this,arguments)},destroy:function(){var a;return this._unRegEvents(),this.map&&this.map.destroy(),this.element.empty(),a=q.superclass.destroy.apply(this,arguments)}});c.exports={FsMap:p,FsMapOverlay:q}});