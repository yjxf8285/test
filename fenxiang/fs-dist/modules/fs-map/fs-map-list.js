/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-map/fs-map-list",["util","uilibs/pagination","moment","./fs-map-list.html","./fs-map-list.css","dialog","modules/feed-list/feed-list-v","modules/feed-list/feed-list-m","modules/feed-list/feed-list-c"],function(a,b,c){var d=window,e=d.FS;e.tpl;var f=a("util"),g=a("uilibs/pagination"),h=a("moment"),i=a("./fs-map-list.html");a("./fs-map-list.css");var j=a("dialog"),k=a("modules/feed-list/feed-list-v"),l=a("modules/feed-list/feed-list-m"),m=a("modules/feed-list/feed-list-c"),n=f.getContactData();n.u;var i=$(i),o=k.itemV,p=l.itemM,q=m.listC,r=new q,s=j.extend({attrs:{width:570,height:420,content:i.filter(".map-showdetail-dialog-templet").html(),className:"common-style-richard map-showdetail-dialog",webDisk:null,feedId:0,zIndex:99},events:{},render:function(){var a=s.superclass.render.apply(this,arguments);return a},hide:function(){var a=s.superclass.hide.apply(this,arguments);return this._clear(),a},show:function(){var a=s.superclass.show.apply(this,arguments);return a},_clear:function(){},_onRenderFeedId:function(a){var b=this,c=this.element,d=$(".feed-wrapper",c);0!=a&&(this.feedV&&this.feedV.destroy(),f.api({url:"/Feed/GetFeedByFeedID",data:{feedID:a},type:"get",success:function(a){var c;a.success&&(c=r.parse(a),k=new o({model:new p(c[0]),replyListOpts:{listPath:"/Feed/GetFeedReplysByFeedID",withPagination:!0,activePageNumber:1},replyWithMedia:!0,withShowBoteFeed:!1,withAvatar:!1,detailStyle:1}).render(),k.$el.appendTo(d),$(".aj-Reply",k.$el).click(),b.feedV=k,b.show())}}))},destroy:function(){var a;return this.feedV&&this.feedV.destroy(),a=s.superclass.destroy.apply(this,arguments)}}),t=new s,u=Backbone.Model.extend({}),v=Backbone.Collection.extend({model:u,sync:function(a,b,c){var d=c.data||{};c.data=_.extend({pageSize:10,pageNumber:1},d),Backbone.sync("read",b,c)},parse:function(a){var b,c=[];return a.success&&(b=a.value.locations,_.each(b,function(b,d){var e=b.country+b.province+b.city+b.district+b.street+b.streetNumber,g=f.getDateSummaryDesc(h.unix(b.createTime),h.unix(a.serviceTime),2),i=d+1,e=e;c.push(_.extend({},b,{createTime:g,listNum:i,slocation:e}))})),c}}),w=Backbone.View.extend({tagName:"div",className:"fs-maplist-item",events:{click:"setCur","click .map-showdetail":"mapShowDetail"},mapShowDetail:function(a){return $(a.currentTarget),t.rendered||t.render(),t.set("feedId",this.model.get("feedID")),t.show(),!1},setCur:function(){var a=this.options,b=this.$el,c=b.hasClass("cur");$(".fs-maplist-item").removeClass("cur"),c||(b.addClass("cur"),a.selectCb&&a.selectCb.call(this,this.model.toJSON()))},initialize:function(){var a=i.filter(".fs-maplist-receive-item-tpl").html();this.template=_.template(a),this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),x=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:20,visiblePageNums:7},oData:null,listPath:"/attach_html/getAttachImgFilesOfIReceive",defaultRequestData:{},searchOpts:{inputSelector:null,btnSelector:null},listCb:e.EMPTY_FN,listEmptyText:"暂无记录",selectCb:e.EMPTY_FN},a||{}),this.opts=a,this.element=$(a.element),this.pagEl=$(a.pagSelector),this.pagination=null,this.tempRequestData={},this.init()};_.extend(x.prototype,{init:function(){var a,b,c=this,d=this.opts,e=this.element;e.html('<div class="fs-maplist-inner"></div>'),a=$(".fs-maplist-inner",e),b=new v,b.on("add",function(b){var c;c=new w({model:b,selectCb:d.selectCb}).render(),c.$el.data("itemV",c).appendTo(a)}),this.list=b,this.pagination=new g(_.extend({element:this.pagEl},d.pagOpts)),this.pagination.on("page",function(){c.empty(),c.fetch()}),this.pagination.render(),d.searchOpts&&d.searchOpts.inputSelector,this._initListEmptyTip()},_searchBarInit:function(){var a,b=this,c=this.opts,d=c.searchOpts,e=this.element,f=$(d.inputSelector),g=$(d.btnSelector);a=$('<div class="list-search-bar fn-clear"></div>'),a.html('<span class="result-info fn-left">共搜索到<span class="num color-red">0</span>条信息</span><a class="back-l fn-right" href="#" title="返回查看全部"><< 返回查看全部</a>'),a.hide().prependTo(e);var h=$('<span class="empty-h">x</span>'),i=$('<span class="list-search-input-wrapper"></span>');f.wrap(i),i=f.closest(".list-search-input-wrapper"),h.hide().appendTo(i),f.keydown(function(a){13==a.keyCode&&g.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(h.show(),f.addClass("with-input-value")):(h.hide(),f.removeClass("with-input-value"))}),h.click(function(){f.val(""),f.removeClass("with-input-value"),h.hide()}),a.on("click",".back-l",function(a){b.reload({keyword:""}),f.val(""),f.removeClass("with-input-value"),h.hide(),a.preventDefault()})},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".num",d);return!a.isFirstChar&&a.keyword.length>0&&b.success?(e.text(b.value.totalCount),d.show(),void 0):(d.hide(),void 0)},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+e.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.appendTo(a)},_updatelistStatus:function(a){var b,c=this.element,d=$(".list-empty-tip",c);a.success&&(b=a.value.totalCount,0==b?d.show():d.hide())},fetch:function(){var a=this,b=this.opts;this.list;var c=this.pagination,d=_.extend({pageSize:c.get("pageSize"),pageNumber:c.get("activePageNumber"),maxID:0},b.oData);d=_.isFunction(b.defaultRequestData)?_.extend(b.defaultRequestData(),d):_.extend(b.defaultRequestData,d),d=_.extend(d,this.tempRequestData),this.tempRequestData={},this.showLoading(),this.list.fetch({url:b.listPath,data:d,success:function(d,e){var f;e.success&&(f=e.value,c.setTotalSize(f.totalCount),a._updatelistStatus(e),b.listCb.call(a,e),a.hideLoading())}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a){this.tempRequestData=a,this.pagination.jump(1)},reload:function(a){this.load(a)},empty:function(){var a=this.element,b=$(".fs-maplist-item",a),c=$(".fs-maplist-inner",a);b.each(function(){var a=$(this),b=a.data("itemV");b.remove(),a.removeData()}),c.empty()},destroy:function(){this.list=null,this.pagination.destroy(),this.loading&&this.loading.stop(),this.empty(),this.pagination=null,this.tempRequestData={},this.element=null}}),c.exports=x});