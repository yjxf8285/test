/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-topic/fs-topic",["util","./fs-topic.html","./fs-topic.css","uilibs/pagination","modules/publish/publish","modules/feed-list/fl-util","dialog","spin","moment"],function(a,b,c){var d=window,e=d.FS;e.tpl;var f=a("util"),g=a("./fs-topic.html");a("./fs-topic.css");var h=a("uilibs/pagination"),i=a("modules/publish/publish"),j=a("modules/feed-list/fl-util"),k=a("dialog");a("spin"),a("moment");var l=i.selectBar,m=i.atInput,n=f.getContactData(),o=n.u,p=$(g),q=k.extend({attrs:{width:600,className:"fs-topic-edit-dialog",content:p.filter(".fs-topic-edit-tpl").html(),defaultSbData:[],topicType:"",topicId:0,successCb:e.EMPTY_FN,cancelCb:e.EMPTY_FN},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel","click .topic-type":"_clickTopicType"},hide:function(){var a=q.superclass.hide.apply(this,arguments);return a},render:function(){var a=q.superclass.render.apply(this,arguments);return this._renderCpt(),a},_renderCpt:function(){var a=this.element,b=$(".range-sb",a),c=new l({element:b,data:[{title:"部门",type:"g",list:n.g,unitSuffix:"个部门"}],acInitData:f.getPublishRange("circle"),title:"选择可查阅该话题的范围",autoCompleteTitle:"请输入姓名或拼音"});this.sb=c},getRequestData:function(){var a=this.element,b=$(".topic-type",a),c=b.filter(":checked"),d=this.sb,e=d.getSelectedData(),f={topicID:this.get("topicId"),isOpen:"1"==c.val()?!0:!1,circleIDs:e.g||[]};return f},isValid:function(){this.element;var a=this.sb,b=this.get("topicType"),c=a.getSelectedData();return"1"!=b||c.g?!0:($(".input-tip",a.element).click(),!1)},_clear:function(){},_submit:function(a){var b=this,c=this.getRequestData();this.isValid()&&f.api({data:c,url:"/Topic/SetTopicOpenStatus",success:function(a){a.success&&(b.get("successCb").apply(b,[a,c]),b._hasChanged=!0,b.hide())}}),a.stopPropagation()},_cancel:function(){this.hide(),this.get("cancelCb").call(this)},_clickTopicType:function(a){var b=$(a.currentTarget);this.set("topicType",b.val())},_onRenderDefaultSbData:function(a){var b=this.sb;a.length>0?_.each(a,function(a){b.addItem(a)}):b.removeAllItem()},_onRenderTopicType:function(a){var b=this.element,c=$(".topic-type",b),d=$(".range-field",b);c.filter('[value="'+a+'"]').prop("checked",!0),"1"==a?d.show():d.hide()},destroy:function(){var a;return this.sb&&this.sb.destroy(),a=q.superclass.destroy.apply(this,arguments)}}),r=k.extend({attrs:{width:500,className:"fs-topic-desc-dialog",content:p.filter(".fs-topic-desc-tpl").html(),topicId:0,defaultDesc:"",successCb:e.EMPTY_FN,cancelCb:e.EMPTY_FN},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel"},hide:function(){var a=r.superclass.hide.apply(this,arguments);return a},render:function(){var a=r.superclass.render.apply(this,arguments);return this._renderCpt(),a},_renderCpt:function(){var a=this.element,b=$(".topic-desc-input",a),c=new m({element:b});this.autoInputH=c},getRequestData:function(){var a=this.element,b=$(".topic-desc-input",a),c={topicID:this.get("topicId"),description:_.str.trim(b.val())};return c},isValid:function(){var a=this.getRequestData();return a.description.length>250?(f.alert("话题描述不能超过250字，目前已超出<em>"+(a.description.length-250)+"</em>个字"),!1):!0},_clear:function(){var a=this.element,b=$(".topic-desc-input",a);b.val("").trigger("autosize.resize")},_submit:function(){var a=this,b=this.getRequestData();this.isValid()&&f.api({data:b,url:"/Topic/ModifyTopicDescription",success:function(c){c.success&&(a.get("successCb").apply(a,[c,b]),a.hide())}})},_onRenderDefaultDesc:function(a){var b=this.element,c=$(".topic-desc-input",b);c.val(a).trigger("autosize.resize")},_cancel:function(){this.hide(),this.get("cancelCb").call(this)},destroy:function(){var a;return this.autoInputH&&this.autoInputH.destroy(),a=r.superclass.destroy.apply(this,arguments)}}),s=k.extend({attrs:{width:580,content:p.filter(".fn-setting-dialog-templet").html(),className:"fn-setting-dialog common-style-richard"},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel","click .topictype input":"_labelTab"},render:function(){var a=s.superclass.render.apply(this,arguments);return this._rangeSelectBar(),a},_labelTab:function(a){var b=$(a.currentTarget),c=b.closest(".ui-dialog-body"),d=$(".readrange",c),e=b.attr("id");"radio-normal"==e?(d.hide(),this.isOpen=!1):(d.show(),this.isOpen=!0)},_rangeSelectBar:function(){var a=this.element,b=$(".selectbar",a);this.circles;var c=new l({element:b,data:[{title:"部门",type:"g",list:n.g,unitSuffix:"个部门"}],singleCked:!1,title:"选择可查阅该话题的范围",acInitData:f.getPublishRange("circle"),autoCompleteTitle:"请输入部门名称的拼音"});this.rangeSelectSb=c},hide:function(){var a=s.superclass.hide.apply(this,arguments);return this._clear(),a},show:function(){var a=s.superclass.show.apply(this,arguments),b=this.element,c=$(".topictype",b),d=$(".readrange",b),e=this.circles,f=this.rangeSelectSb;return e.length<=0?($('input[id="radio-normal"]',c).prop("checked","true"),d.hide()):($('input[id="radio-range"]',c).prop("checked","true"),d.show()),_.each(e,function(a){a.type="g",f.addItem(a)}),a},_clear:function(){var a=this.element;$(".topictype",a),$(".readrange",a),this.circles;var b=this.rangeSelectSb;b.removeAllItem(),this.isOpen=!0},_sendSettingAJAX:function(){var a=this,b=this.element,c=this.topicID,d=!1,e=this.rangeSelectSb,g=e.getSelectedData(),h=g.g||[],i=$(".topictype input:checked",b);return d="1"==i.val()?!0:!1,d&&0==h.length?($(".input-tip",e.element).click(),void 0):(f.api({url:"/Topic/SetTopicOpenStatus",type:"post",data:{topicID:c,isOpen:d,circleIDs:h},success:function(b){b.success&&(a.hide(),a.Mytopics.reload())}}),void 0)},_submit:function(a){this._sendSettingAJAX(),a.stopPropagation()},_cancel:function(){this.hide()}}),t=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:20,totalSize:0,visiblePageNums:7},listPath:"/Mytopics_html/getMytopicss",listSuccessCb:e.EMPTY_FN,defaultRequestData:{},searchOpts:{inputSelector:null,btnSelector:null},showTopAction:!1,listEmptyText:"暂无记录"},a||{}),this.opts=a,this.element=$(a.element),this._initPagination(),this.pagination=null,this.tempRequestData={},this._lastRequestData=null,this.init()},u={_initPagination:function(){var a=this.opts;a.pagSelector===!1?(this.pagEl=$('<div class="topic-list-pagination"></div>').appendTo(this.element),this.pagEl.hide(),a.pagOpts.pageSize=1e4):this.pagEl=$(a.pagSelector)},init:function(){var a=this,b=this.opts,c=this.element,d=$(g).filter(".mytopicstpl-warp").html();c.html(d);var e=new s;this.settingDialog=e,b.showTopAction?$(".fn-settop-btn",c).show():$(".fn-settop-btn",c).hide(),this.pagination=new h(_.extend({element:this.pagEl},b.pagOpts)),this.pagination.on("page",function(){a.empty(),a.fetch()}),this.pagination.render(),b.searchOpts&&b.searchOpts.inputSelector&&this._searchBarInit(),this._initListEmptyTip(),this._bindEvents()},setTopVisible:function(a){var b=this.element,c=$(".fn-settop-btn",b);a?c.show():c.hide()},setFollowAction:function(a){var b=this.element,c=$(".fn-follow-btn a",b);a?c.text("关注"):c.text("取消关注")},_bindEvents:function(){var a=this,b=this.element;b.on("click",".fn-follow-btn",function(b){a._fnFollow(b)}),b.on("click",".fn-fixed-btn",function(b){a._fnFixed(b)}),b.on("click",".fn-settop-btn",function(b){a._fnSettop(b)}),b.on("click",".fn-setting-btn",function(){var b=$(this),c=b.closest(".mtlist-item"),d=c.attr("topicid"),e=c.data("circles");a.settingDialog.topicID=d,a.settingDialog.Mytopics=a,a.settingDialog.circles=e,a.settingDialog.show()})},_fnSettop:function(a){var b=this,c=$(a.currentTarget),d=c.closest(".mtlist-item"),e=d.attr("topicid");return f.api({url:"/Topic/SetTopicToTop",type:"post",data:{topicID:e},success:function(a){a.success&&b.load()}}),!1},_fnFixed:function(a){var b=this,c=$(a.currentTarget).find("a"),d=c.text(),e=c.closest(".mtlist-item"),f=e.attr("topicid"),g=!0,h="/Topic/FixTopic",i='<img src="../../html/fs/assets/images/dot_r.png" alt=""/>固定成功',k='<div><img src="../../html/fs/assets/images/tipconfirm.png" alt=""/>确定要取消固定这个话题吗？</div><div class="button-warp"><button class="f-sub button-green">确定</button>&nbsp;&nbsp;<button class="f-cancel button-green">取消</button></div>';if("固定"==d)c.text("已固定").attr("class","disable"),new j.showSlideUpTip({element:c,width:116,height:56,template:i}),this._fnsSubmit(h,f,g);else{if(g=!1,"已固定"==c.text())return!1;new j.showSlideUpTip({element:c,autohide:!1,width:221,height:85,template:k,callback:function(){b._fnsSubmit(h,f,g)}})}return!1},_fnFollow:function(a){var b=this,c=$(a.currentTarget).find("a"),d=c.text(),e=c.closest(".mtlist-item"),f=e.attr("topicid"),g=!0,h="/Topic/FollowTopic",i='<img src="../../html/fs/assets/images/dot_r.png" alt=""/>关注成功',k='<div><img src="../../html/fs/assets/images/tipconfirm.png" alt=""/>确定要取消关注这个话题吗？</div><div class="button-warp"><button class="f-sub button-green">确定</button>&nbsp;&nbsp;<button class="f-cancel button-green">取消</button></div>';if("关注"==d)c.text("已关注").attr("class","disable"),new j.showSlideUpTip({element:c,width:116,height:56,template:i}),this._fnsSubmit(h,f,g);else{if(g=!1,"已关注"==c.text())return!1;new j.showSlideUpTip({element:c,autohide:!1,width:221,height:85,template:k,callback:function(){b._fnsSubmit(h,f,g)}})}return!1},_fnsSubmit:function(a,b,c){var d=this;f.api({url:a,type:"post",data:{id:b,flag:c},success:function(a){a.success&&(c||d.load())}})},_createItem:function(a){var b="",c=a.count,d=a.name,e=a.circles,f=a.topicID,g=a.isFixed,h=a.isFollow,i=a.isOpen,j=a.isPublic,k="",l='<span class="fn-follow-btn"><a href="javascript:void(0);">关注</a></span>',m='<span class="fn-fixed-btn"> | <a href="javascript:void(0);">固定</a></span>',n='<span class="fn-settop-btn"> | <a href="javascript:void(0);" >置顶</a></span>',p='<span class="fn-setting-btn"> | <a href="javascript:void(0);">设置</a></span>',q=!1,r=o.functionPermissions;return _.each(r,function(a){2==a.value&&(q=!0)}),i?j?k="开放范围：全公司":e.length>0&&(_.each(e,function(a){k+=a.name+"，"}),k="开放范围："+k.substr(0,k.length-1)):k="",g&&(m='<span class="fn-fixed-btn"> | <a href="javascript:void(0);">取消固定</a></span>'),h&&(l='<span class="fn-follow-btn"><a href="javascript:void(0);">取消关注</a></span>'),q||(m="",n="",p=""),b='<div class="mtlist-item fn-clear" topicid="'+f+'"> <span class="mtlist-item-tit"><a href="#stream/showtopic/=/id-'+f+'">#'+d+"#</a> ("+c+')</span> <span class="mtlist-item-range" title="'+k+'">'+k+'</span> <span class="mtlist-item-fn">'+l+m+n+p+"</span> </div>",$(b)},fetch:function(){var a=this,b={},c=this.opts,d=this.pagination,e=this.element,g=$(".mtlistwrap",e);b=_.extend({pageSize:d.get("pageSize"),pageNumber:d.get("activePageNumber")},b||{}),b=_.isFunction(c.defaultRequestData)?_.extend(c.defaultRequestData(),b):_.extend(c.defaultRequestData,b),b=_.extend({type:"-1",keyword:"",pageSize:d.get("pageSize"),pageNumber:d.get("activePageNumber")},b,this.tempRequestData),this.tempRequestData={},this._lastRequestData=b,this.showLoading(),f.api({type:"get",data:b,url:c.listPath,success:function(e){var f,h;e.success&&(f=e.value,h=f.items,_.each(h,function(b){var c=a._createItem(b),d=b.circles;c.data("circles",d),c.appendTo(g)}),d.setTotalSize(f.totalCount),a._updateSearchBarState(b,e),a._updatelistStatus(e),a.hideLoading(),c.listSuccessCb.apply(a,[e,b]))}},{abortLast:!0})},_searchBarInit:function(){var a,b,c,d=this,e=this.opts,f=e.searchOpts,g=this.element,h=$(f.inputSelector),i=$(f.btnSelector),j=h.data("isInit");j||(b=$('<span class="empty-h">&#10005;</span>'),c=$('<span class="list-search-input-wrapper"></span>'),h.wrap(c),c=h.closest(".list-search-input-wrapper"),b.hide().appendTo(c),h.keydown(function(a){13==a.keyCode&&i.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(b.show(),h.addClass("with-input-value")):(b.hide(),h.removeClass("with-input-value"))}),b.click(function(){h.val(""),h.removeClass("with-input-value"),b.hide()}),h.data("isInit",!0)),a=$('<div class="list-search-bar fn-clear"></div>'),a.html('<span class="result-info fn-left">共搜索到<span class="num color-red">0</span>条信息</span><a class="back-l fn-right" href="#" title="返回查看全部"><< 返回查看全部</a>'),a.hide().prependTo(g),a.on("click",".back-l",function(b){var c=$(".list-empty-tip",g),e=$(".empty-h",h.closest(".list-search-input-wrapper"));h.val(""),h.removeClass("with-input-value"),e.hide(),a.hide(),c.hide(),d.reload({keyword:""}),b.preventDefault()}),this.searchBarEl=a},_searchBarDestroy:function(){var a,b,c=this.opts,d=c.searchOpts;this.searchBarEl&&(a=$(d.inputSelector),b=a.closest(".list-search-input-wrapper"),a.insertAfter(b),b.remove(),a.val("").unbind(),a.data("isInit",!1),this.searchBarEl.remove(),this.searchBarEl=null)},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".num",d);return a.keyword.length>0&&b.success?(e.text(b.value.totalCount),d.show(),void 0):(d.hide(),void 0)},resetSearch:function(){var a=this.opts,b=a.searchOpts,c=$(b.inputSelector),d=c.closest(".list-search-input-wrapper"),e=$(".empty-h",d);e.click().hide(),this.searchBarEl&&this.searchBarEl.hide()},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+e.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.appendTo(a)},_updatelistStatus:function(a){var b,c=this.element,d=$(".list-empty-tip",c);a.success&&(b=a.value.totalCount,0==b?d.show():d.hide())},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a){this.tempRequestData=a,this.pagination.jump(1)},reload:function(){this.tempRequestData=this._lastRequestData||{},this.empty(),this.fetch()},empty:function(){var a=$(".mtlistwrap",this.element),b=$(".mtlist-item",a);b.each(function(){var a=$(this),b=a.data("feedV");b&&b.destroy&&b.destroy(),a.removeData()}),$(".show-slide-up-tip-warp").remove(),a.empty()},destroy:function(){this.pagination.destroy(),this.loading&&this.loading.stop(),this.empty(),this._searchBarDestroy(),this.pagination=null,this.tempRequestData={},this._lastRequestData=null,this.element=null}};_.extend(t.prototype,u),f.tplRouterReg("#stream/showtopic/=/:key-:value"),c.exports={TopicEditDialog:q,Mytopics:t,TopicDescDialog:r}});