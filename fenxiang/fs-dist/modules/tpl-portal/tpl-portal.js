/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/tpl-portal/tpl-portal",["util","moment","modules/left-list/left-list.html","dialog","tabs","modules/feed-list/feed-list","modules/fs-reply/fs-reply-list"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=(e.store,e.event),g=a("util"),h=a("moment"),i=a("modules/left-list/left-list.html"),j=a("dialog"),k=a("tabs"),l=a("modules/feed-list/feed-list"),m=a("modules/fs-reply/fs-reply-list"),n=$(i),o=n.filter(".home-left-list").html(),p=n.filter(".circles-left-list").html(),q=n.filter(".work-left-list").html(),r=n.filter(".approve-left-list").html(),s=n.filter(".plan-left-list").html(),t=n.filter(".search-left-list").html(),u=n.filter(".search-colleagues-left-list").html(),v={};_.extend(v,{common:function(){var a=b.tplEl;$(".files-nav-list",a).html(o),$(".circles-nav-list",a).html(p),$(".work-nav-list",a).html(q),$(".approve-nav-list",a).html(r),$(".plan-nav-list",a).html(s),$(".search-nav-list",a).html(t),$(".search-colleagues-nav-list",a).html(u),$(".depw-menu li").find(">a").bind("click",function(){$(".depw-menu li").find(">a").removeClass("depw-menu-aon"),$(this).addClass("depw-menu-aon"),"eff-inf"==$(this).attr("id")?($(".tpl-c").width("80%"),$(".tpl-r").hide(),$("#profile-work").hide(),$("#profile-eff").show()):($(".tpl-c").width(""),$(".tpl-r").show(),$("#profile-work").show(),$("#profile-eff").hide())});var c=window.location.hash;$(".files-nav-item a",a).each(function(){var a=$(this).attr("href");a==c&&$(this).addClass("tpl-nav-lbon")}),g.tplRouterReg($(".tpl-nav-l",a)),g.tplRouterReg($(".tpl-nav-lb",a));var a=b.tplEl,e=d.getAppStore("contactData"),f=e.currentMember,h=$(".head-img-wrap",a),i=$(".head-img-wrap-tpl",h).html(),j=_.template(i),k=j({userName:f.name,profileImage:f.profileImage});h.html(k)},leftDepartment:function(){var a=b.tplEl,c=g.getContactData(),d=c.u,e=$(".group-list",a),f=$(".group-item-tpl",e),h=f.html(),i=_.template(h),j=c.groups,k=d.groupIDs,l="";_.each(k,function(a){var b=_.find(j,function(b){return b.id==a});l+=i({groupName:b.name,groupID:b.id,cTitle:b.name})}),e.append(l),f.remove(),g.tplRouterReg("#department/=/:cid-:value/:ctitle-:value")},doTabReplyList:function(){var a,c=b.tplEl,d=b.tplName,e=$(".home-center-list",c),g=m.replyList;return a=new k({element:e,triggers:$(".ui-tab-item",e),panels:$(".ui-tab-panel",e),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click"}).render(),a.on("switched",function(a){var b=this.get("panels").eq(a),c=$(".reply-list",b),d=$(".reply-list-pagination",b),e=b.data("replyList");e?e.reload():(e=new g({element:c,pagSelector:d,pagOpts:{pageSize:45,totalSize:0,visiblePageNums:7},defaultRequestData:{circleID:999999,subType:0,feedType:0,keyword:""}}),e.load(),b.data("feedList",e))}),a.trigger("switched",0,-1),f.on("switched",function(b){b==d&&a.switchTo(0)}),a},UiTabList:function(){var a,c=b.tplEl,d=b.tplName,e=$(".home-center-list",c),g=function(a){var b=$(a),c=b.data("feedList");c&&c.loadKill()};a=new k({element:e,triggers:$(".ui-tab-item",e),panels:$(".ui-tab-panel",e),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click"}).render(),a.on("switched",function(a){var b=this.get("panels").eq(a),c=$(".feed-list",b),d=$(".feed-list-pagination",b),e=b.data("feedList");e?e.reload():(e=new l({element:c,pagSelector:d,pagOpts:{pageSize:45,totalSize:0,visiblePageNums:7},loadSize:15,defaultRequestData:{circleID:999999,subType:0,feedType:0,keyword:""}}),e.load(),b.data("feedList",e))}).on("switch",function(a,b){g(this.get("panels").eq(b))}),a.trigger("switched",0,-1),f.on("switched",function(b){b==d&&a.switchTo(0)})},"plan-right":function(){var a=b.tplEl,c=$(".planr-my-list-wrap",a),e=$(".planr-ups-list-wrap",a);g.api({type:"get",data:{},url:"/content/fs/data/plan-right-nav.json",success:function(a){if(a.success){var b=a.value.iSends,f=a.value.iSendCount;$(".planr-my-title-count").text(f),b.length>5&&(b=b.slice(0,5)),_.each(b,function(a){var b=a.employee.name,e=d.FILES_PATH+"/"+a.employee.profileImage+"3.jpg",f=h.unix(a.dateTime).format("MM-DD HH:mm"),g=a.feedContent,i="<div class='rightc-listwrap fn-clear'><a href='javascript:;' class='rlist-headimg-wrap'><img class='rlist-headimg' src='"+e+"' /></a><p class='rlist-pname'><a href='javascript:;' class='fna-blue'>"+b+"</a> <span class='rlist-pname-apvdate'>"+f+"</span></p><a class='rlist-atext fna-grey' href='javascript:;'>"+g+"</a></div>";c.append(i)});var g=a.value.toBeIs,i=a.value.toBeICount;$(".planr-ups-title-count").text(i),g.length>5&&(g=g.slice(0,5)),_.each(g,function(a){var b=a.employee.name,c=d.FILES_PATH+"/"+a.employee.profileImage+"3.jpg",f=h.unix(a.dateTime).format("MM-DD HH:mm"),g=a.feedContent,i="<div class='rightc-listwrap fn-clear'><a href='javascript:;' class='rlist-headimg-wrap'><img class='rlist-headimg' src='"+c+"' /></a><p class='rlist-pname'><a href='javascript:;' class='fna-blue'>"+b+"</a> <span class='rlist-pname-apvdate'>"+f+"</span></p><a class='rlist-atext fna-grey' href='javascript:;'>"+g+"</a></div>";e.append(i)})}}})},"approve-right":function(){var a=b.tplEl,c=$(".approver-my-list-wrap",a),e=$(".approver-ups-list-wrap",a);g.api({type:"get",data:{},url:"/content/fs/data/approve-right-nav.json",success:function(a){if(a.success){var b=a.value.iSends,f=a.value.iSendCount;$(".approver-my-title-count").text(f),b.length>5&&(b=b.slice(0,5)),_.each(b,function(a){var b=a.employee.name,e=d.FILES_PATH+"/"+a.employee.profileImage+"3.jpg",f=h.unix(a.dateTime).format("MM-DD HH:mm"),g=a.feedContent,i="<div class='rightc-listwrap fn-clear'><a href='javascript:;' class='rlist-headimg-wrap'><img class='rlist-headimg' src='"+e+"' /></a><p class='rlist-pname'><a href='javascript:;' class='fna-blue'>"+b+"</a> <span class='rlist-pname-apvdate'>"+f+"</span></p><a class='rlist-atext fna-grey' href='javascript:;'>"+g+"</a></div>";c.append(i)});var g=a.value.toBeIs,i=a.value.toBeICount;$(".approver-ups-title-count").text(i),g.length>5&&(g=g.slice(0,5)),_.each(g,function(a){var b=a.employee.name,c=d.FILES_PATH+"/"+a.employee.profileImage+"3.jpg",f=h.unix(a.dateTime).format("MM-DD HH:mm"),g=a.feedContent,i="<div class='rightc-listwrap fn-clear'><a href='javascript:;' class='rlist-headimg-wrap'><img class='rlist-headimg' src='"+c+"' /></a><p class='rlist-pname'><a href='javascript:;' class='fna-blue'>"+b+"</a> <span class='rlist-pname-apvdate'>"+f+"</span></p><a class='rlist-atext fna-grey' href='javascript:;'>"+g+"</a></div>";e.append(i)})}}})},"work-right":function(){var a=b.tplEl,c=$(".workr-do-list-wrap",a),e=$(".workr-my-list-wrap",a),f=$(".workr-ups-list-wrap",a);g.api({type:"get",data:{},url:"/content/fs/data/work-right-nav.json",success:function(a){if(a.success){var b=a.value.iExecuters,g=a.value.iExecuterCount;$(".workr-do-title-count").text(g),b.length>5&&(b=b.slice(0,5)),_.each(b,function(a){var b=a.employee.name,e=d.FILES_PATH+"/"+a.employee.profileImage+"3.jpg",f=h.unix(a.dateTime).format("MM-DD HH:mm"),g=a.feedContent,i="<div class='rightc-listwrap fn-clear'><a href='javascript:;' class='rlist-headimg-wrap'><img class='rlist-headimg' src='"+e+"' /></a><p class='rlist-pname'><a href='javascript:;' class='fna-blue'>"+b+"</a> <span class='rlist-pname-apvdate'>"+f+"</span></p><a class='rlist-atext fna-grey' href='javascript:;'>"+g+"</a></div>";c.append(i)});var i=a.value.iSends,j=a.value.iSendCount;$(".workr-my-title-count").text(j),i.length>5&&(i=i.slice(0,5)),_.each(i,function(a){var b=a.employee.name,c=d.FILES_PATH+"/"+a.employee.profileImage+"3.jpg",f=h.unix(a.dateTime).format("MM-DD HH:mm"),g=a.feedContent,i="<div class='rightc-listwrap fn-clear'><a href='javascript:;' class='rlist-headimg-wrap'><img class='rlist-headimg' src='"+c+"' /></a><p class='rlist-pname'><a href='javascript:;' class='fna-blue'>"+b+"</a> <span class='rlist-pname-apvdate'>"+f+"</span></p><a class='rlist-atext fna-grey' href='javascript:;'>"+g+"</a></div>";e.append(i)});var k=a.value.toBeIs,l=a.value.toBeICount;$(".workr-ups-title-count").text(l),k.length>5&&(k=k.slice(0,5)),_.each(k,function(a){var b=a.employee.name,c=d.FILES_PATH+"/"+a.employee.profileImage+"3.jpg",e=h.unix(a.dateTime).format("MM-DD HH:mm"),g=a.feedContent,i="<div class='rightc-listwrap fn-clear'><a href='javascript:;' class='rlist-headimg-wrap'><img class='rlist-headimg' src='"+c+"' /></a><p class='rlist-pname'><a href='javascript:;' class='fna-blue'>"+b+"</a> <span class='rlist-pname-apvdate'>"+e+"</span></p><a class='rlist-atext fna-grey' href='javascript:;'>"+g+"</a></div>";f.append(i)})}}})},plan:function(){var a,c,d=b.tplEl,e=$(".feed-list",d),f=$(".feed-list-pagination",d),g=$(".plan-status-type",d);a=new j({trigger:$("#btn-remark-plan",d),width:"440px",className:"plan-bat-remark-dialog",content:$(".bat-remark-plan-tpl",d).html()}).render(),$(".f-cancel",a.element).click(function(){a.hide()}),c=new l({element:e,pagSelector:f,pagOpts:{pageSize:45,totalSize:0,visiblePageNums:7},loadSize:15,defaultRequestData:{circleID:999999,subType:0,feedType:0,keyword:""}}),c.load(),g.on("click",".plan-status,.plan-type",function(a){var b=$(this);b.hasClass("plan-status")?($(".plan-status",g).removeClass("depw-tabs-aon"),b.addClass("depw-tabs-aon")):($(".plan-type",g).removeClass("depw-tabs-aon"),b.addClass("depw-tabs-aon")),c.reload(),a.preventDefault()}),v["plan-right"]()},"plan-assignedplans":function(){v["plan-right"]()},"plan-followedplans":function(){v["plan-right"]()},"plan-receivedplanreplies":function(){v["plan-right"]()},"plan-atmeplans":function(){v["plan-right"]()},approve:function(){v.UiTabList(),v["approve-right"]()},"approve-sentapproves":function(){v.UiTabList(),v["approve-right"]()},"approve-followedapproves":function(){v.UiTabList(),v["approve-right"]()},"approve-receivedapprovereplies":function(){v["approve-right"]()},"approve-atmeapproves":function(){v.UiTabList(),v["approve-right"]()},work:function(){v.UiTabList(),v["work-right"]()},"work-assignedworks":function(){v.UiTabList(),v["work-right"]()},"work-followedworks":function(){v.UiTabList(),v["work-right"]()},"work-receivedworkreplies":function(){v["work-right"]()},"work-atmeworks":function(){v.UiTabList(),v["work-right"]()},"stream-atmefeeds":function(){v.leftDepartment(),v.UiTabList()},"stream-followedfeeds":function(){v.leftDepartment(),v.UiTabList()},"stream-receivedreplies":function(){v.leftDepartment(),v.doTabReplyList()},"stream-archivetag":function(){v.leftDepartment()},"stream-votes":function(){v.leftDepartment()},search:function(){v.UiTabList()},"search-attachs":function(){},"search-colleagues":function(){},schedules:function(){},worktodo:function(){},department:function(){v.leftDepartment();var a,c=g.getTplQueryParams(),e=b.tplEl,f=$(".feed-list",e),h=$(".feed-list-pagination",e),i=$(".plan-status-type",e);a=new l({element:f,pagSelector:h,pagOpts:{pageSize:45,totalSize:0,visiblePageNums:7},loadSize:15,listPath:"/feed_html/getFeedsFromCircleSend",defaultRequestData:function(){var a=$(".subtype-wrapper",i).filter(":visible");return{circleID:c?c.cid:0,subType:$(".depw-tabs-aon",a).attr("subtype"),feedAttachType:$(".include-file-wrap .depw-tabs-aon",e).attr("attachtype"),feedType:$(".plan-status-wrap .depw-tabs-aon",e).attr("feedtype"),keyword:""}}}),a.load(),i.on("click",".plan-status",function(a){var b=$(this);b.hasClass("plan-status")&&($(".subtype-wrapper",i).hide(),b.is("[feedname]")&&$("."+b.attr("feedname")+"-wrapper").show()),a.preventDefault()}).on("click",".depw-tabs-a",function(){var b=$(this),c=b.closest(".status-wrapper"),d=b.attr("infotype");$(".depw-tabs-a",c).removeClass("depw-tabs-aon"),b.addClass("depw-tabs-aon"),"send"==d?a.opts.listPath="/feed_html/getFeedsFromCircleSend":"received"==d&&(a.opts.listPath="/feed_html/getFeeds"),a.reload()}),$(".depw-menu li").find(">a").on("click",function(){a.reload()});var j=d.getAppStore("contactData"),k=$(".right-img-wrap",e),m=$(".right-htitle-wrap",e);g.api({type:"get",data:{},url:"/content/fs/data/stream-right-nav.json",success:function(a){var b,c=j.members;if(a.success){b=a.value.inCircleEmployeeIDs,b.length>14&&(b=b.slice(0,14)),_.each(b,function(a){var b=_.find(c,function(b){return b.id==a});if(b){var e=b.name,f=d.FILES_PATH+"/"+b.profileImage+"3.jpg",g="<a href='javascript:;' title='"+e+"'><img src='"+f+"' /></a>";k.append(g)}});var e;e=a.value.thisCircle,m.html(e.name+"（"+e.memberCount+"）")}}})}}),b.init=function(){var a=b.tplName;v.common(),v[a]&&v[a]()}});