/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-qx/fs-qx",["dialog","overlay","position","./fs-qx.css","./fs-qx.html","events","util","moment","filter","json","uilibs/audio-player","h5uploader","flashuploader","modules/fs-attach/fs-attach-preview","modules/fs-attach/fs-attach-file-preview","modules/fs-map/fs-map","scrollbar","./fs-qx-helper"],function(a,b,c){var d=window,e=d.FS,f=e.tpl,g=(a("dialog"),a("overlay")),h=a("position"),i=(a("./fs-qx.css"),a("./fs-qx.html")),j=(a("events"),a("util")),k=a("moment"),l=a("filter"),m=a("json"),n=a("uilibs/audio-player"),o=(a("h5uploader"),a("flashuploader"),a("modules/fs-attach/fs-attach-preview")),p=a("modules/fs-attach/fs-attach-file-preview"),q=a("modules/fs-map/fs-map"),r=a("scrollbar"),s=a("./fs-qx-helper"),t=$(i),u=_.template(t.filter(".fs-qx-chat-item-tpl").html()),v=_.template(t.filter(".fs-qx-message-item-text-tpl").html()),w=_.template(t.filter(".fs-qx-message-item-img-tpl").html()),x=_.template(t.filter(".fs-qx-message-item-attach-tpl").html()),y=_.template(t.filter(".fs-qx-message-item-audio-tpl").html()),z=_.template(t.filter(".fs-qx-message-item-control-tpl").html()),A=_.template(t.filter(".fs-qx-message-item-location-tpl").html()),B=e.getAppStore("contactData"),C=j.getContactData(),D=C.u,E=l.stringMatch,F=l.startsWith,G=(new o).render(),H=p.FileReader,I=new H,J=q.FsMapOverlay,K=new J,L="state-offline state-pc-online state-mobile-online",M=new RegExp("(http[s]{0,1}|ftp)://[a-zA-Z0-9\\.\\-]+\\.([a-zA-Z]{2,4})(:\\d+)?(/[a-zA-Z0-9\\.\\-~!@#$%^&amp;*+?:_/=<>]*)?","gi"),N="纷享科技";j.tplRouterReg("#shortmessage/showsession/=/:id-:value");var O=function(a){return a=[].concat(a),_.reject(C.p,function(b){return _.some(a,function(a){return b.id==a})})},P=function(a){return _.find(a,function(a){return a!=D.id})},Q=s.Uploader,R=s.QueryInput;s.LetterGroupList;var S=s.JoinDialog,T=g.extend({attrs:{align:{selfXY:["100%+242px","100%"],baseElement:h.VIEWPORT,baseXY:["100%","100%"]},className:"fs-chat-panel",maxHisNum:100,zIndex:100,activeIndex:-1,joinDialog:null,qxPanel:null},events:{click:"_clickSelf","click .fs-qx-chat-shown .fs-qx-chat-tbar .hide-l":"_clickMinBtn","click .fs-qx-chat-hidden .fs-qx-chat-title":"_clickHiddenTitle","click .fs-qx-chat-shown .fs-qx-chat-tbar .close-l":"_switchToClosed","click .fs-qx-chat-shown .open-dg-l":"_openJoinDialog","click .fs-qx-chat-shown .open-dg-btn":"_openJoinDialog","mouseenter .fs-qx-chat-shown .chat-item":"_enterChatItem","mouseleave .fs-qx-chat-shown .chat-item":"_leaveChatItem","click .chat-nav-panel .chat-item-content":"_clickChatItemNav","click .chat-nav-panel .remove-l":"_clickRemoveChatItemNav","click .fs-qx-chat-shown .chat-title-edit-enable .chat-title-shown":"_clickChatTitleShown","blur .fs-qx-chat-shown .chat-title-edit-enable .title-edit":"_blurChatTitleEdit","keydown .fs-qx-chat-shown .chat-title-edit-enable .title-edit":"_keydownChatTitleEdit","keyup .fs-qx-chat-shown .chat-title-edit-enable .title-edit":"_keyupChatTitleEdit","click .fs-qx-chat-shown .nav-up":"_clickNavUp","click .fs-qx-chat-shown .nav-down":"_clickNavDown","click .message-submit-wrapper .remove-l":"_clickUploadRemove","click .message-submit-bbar .f-sub":"_clickSubmit","keydown .fs-qx-chat-shown .message-input":"_keydownInput","click .logout-btn":"_clickLogout","click .message-type-img .preview-l":"_previewImg","click .message-type-img .img-wrapper":"_previewImg","click .message-type-attach .preview-l":"_previewAttach","click .message-type-location .message-location":"_showLocation","click .message-type-audio .ctr-btn":"_clickAudioPlay","click .state-offline-tip .close-tip-l":"_clickCloseOfflineTip"},setup:function(){var a=T.superclass.setup.apply(this,arguments);return this.messageTid=null,this.sessionListData=null,this.audioCpts=[],this._newMessageStore={},this._sessionXhr=null,this._bindEvents(),a},_bindEvents:function(){var a,b,c,e,f,g=this,h=this.get("qxPanel"),i=this.element;h.on("qxstatus",function(d){var k,l=(d.shortMessageCount,d.statusData),m=l.sessions,n=l.newMessages;a=$(".fs-qx-chat-shown",i),b=$(".fs-qx-chat-hidden",i),c=$(".chat-nav-panel .chat-item",i),e=$(".participant-item",i),f=$(".avatar-win-inner",i),i.is(":hidden")&&l.newMessages.length>0&&g.switchPanelStatus("hidden",!0),k=g.getActiveSession(),a.is(":visible")&&(c.each(function(){var a,b=$(this),c=b.attr("employeeid");c&&(a=h.getEmployeeChatState(c),b.removeClass(L).addClass("state-"+a))}),e.each(function(){var a,b=$(this),c=b.attr("participantid");c&&(a=h.getEmployeeChatState(c),b.removeClass(L).addClass("state-"+a))}),"pair"==k.sessionType?f.removeClass(L).addClass("state-"+h.getEmployeeChatState(P(k.employeeIds))):f.removeClass(L)),b.is(":visible")&&l.newMessages.length>0&&(g.show(),g.showNewMessageAlert(l.newMessages.length)),m.length>0&&n.length>0&&(j.api({url:"/ShortMessage/GetSessionNames",data:{sessionIDs:_.map(m,function(a){return a.value})},success:function(b){var c,d=[];b.success&&(c=b.value,_.each(c,function(b){var c=_.find(m,function(a){return a.value==b.value});'<img src="'+j.getAvatarLink(b.value2,3)+'" class="avatar-thumb" alt="" />',g.addOrUpdateSession({sessionId:c.value,sessionType:c.value1?"discussion":"pair",employeeIds:c.value2,data:{name:b.value1,profileImage:b.value2}},!1,{profileImage:j.getAvatarLink(b.value2,3),chatStateCls:c.value1?"":h.getEmployeeChatState(P(c.value2)),title:b.value1,name:b.value1}),_.each(g.sessionListData,function(a,b){var d=$(".chat-nav-panel .chat-item-content",i).eq(b);if(a.sessionId==c.value){if(k&&c.value==k.sessionId)return;j.toggleAnimate({element:d,startProperty:{backgroundColor:"#f4f4f4"},endProperty:{backgroundColor:"#fff1ba"},animateOpts:{easing:"swing",duration:260},count:2}),d.addClass("cic-come-on")}}),a.is(":visible")&&g.updateLayout(),c.value1&&d.push({sessionID:c.value,profileImage:b.value2,name:b.value1,participantsCount:c.value2.length,participantsIDs:c.value2,lastCreateTime:c.value3})}),h._groupListRendered&&d.length>0&&(h.addDiscussionMemberData(d),h.reRenderDiscussionGroup()))}}),a.is(":visible")&&_.some(m,function(a){return a.value!=k.sessionId})&&(g.starHtmlTitle(),g.operNewMessageSound(n)),b.is(":visible")&&(g.starHtmlTitle(),g.operNewMessageSound(n)))}),$(d).scroll(function(){g._setPosition()}),$("body").click(function(){"shown"==g.getPanelStatus()&&g._clickMinBtn()})},_onRenderVisible:function(a){var b=T.superclass._onRenderVisible.apply(this,arguments);return a&&!this._uploaderReady&&(this._lazyRenderUploader(),this._uploaderReady=!0),b},_clickSelf:function(a){a.stopPropagation()},_clickCloseOfflineTip:function(a){var b=this.getActiveSession(),c=$(a.currentTarget),d=c.closest(".state-offline-tip");d.hide(),b.hideOfflineTip=!0},_clickAudioPlay:function(a){var b,c=$(a.currentTarget),d=c.closest(".message-content"),e=$(".is-unread",d);e.length>0&&(b=e.attr("messageid"),j.api({url:"/ShortMessage/ReadAudioShortMessage",type:"post",data:{shortMessageID:b},success:function(a){a.success&&e.remove()}}))},_switchToClosed:function(a){this.hide(),this.stopAllAudio(),this.resetPanel(),a.preventDefault()},resetPanel:function(){var a=this.element,b=$(".chat-list-wrapper",a),c=$(".participant-list-wrapper",a),d=$(".fs-qx-chat-shown .fs-qx-chat-tbar",a),f=$(".chat-title-shown",d),g=$(".join-num .num",d),h=$(".avatar-thumb",d);$(".chat-list",b).empty(),$(".participant-list",c).empty(),this.reRenderMessageList([]),f.text(""),g.text("0"),h.attr("src",e.BLANK_IMG)},resetPanelExceptChatNav:function(){var a=this.element,b=$(".participant-list-wrapper",a),c=$(".fs-qx-chat-shown .fs-qx-chat-tbar",a),d=$(".chat-title-shown",c),f=$(".join-num .num",c),g=$(".avatar-thumb",c);$(".participant-list",b).empty(),this.reRenderMessageList([]),d.text(""),f.text("0"),g.attr("src",e.BLANK_IMG)},starHtmlTitle:function(){var a=0;clearInterval(this.starHtmlTitleTid),this.starHtmlTitleTid=setInterval(function(){document.title=0==a%2?"【新企信】"+N:"【　　　】"+N,a++},1e3)},stopStarHtmlTitle:function(){clearInterval(this.starHtmlTitleTid),document.title=N},operNewMessageSound:function(a){var b,c,d=this.newMessageAlertPlayer,f=this._newMessageStore,g=!1;c=_.groupBy(a,function(a){return a.value}),_.each(c,function(a,b){c[b]=[],_.each(a,function(a){c[b].push(a.value1)})}),d||(b=$('<div class="fn-hide-abs"></div>'),b.appendTo("body"),d=new n({element:b,audioSrc:e.MODULE_PATH+"/fs-qx/shortmessage.mp3"}),d.shadowEl=b,this.newMessageAlertPlayer=d),_.each(c,function(a,b){f[b]?j.isArrayElementEq(f[b],a)||(g=!0,f[b]=a):(g=!0,f[b]=a)}),g&&d.play()},clearNewMessageStore:function(a){var b=this._newMessageStore;b[a]=[]},switchPanelStatus:function(a,b){var c=this.element,d=$(".fs-qx-chat-shown",c),e=$(".fs-qx-chat-hidden",c);"shown"==a?(c.is(":hidden")&&this.show(),d.show(),e.hide(),this.stopStarHtmlTitle(),this.updateLayout(),this._adjustNavScrollTop(),$(".message-input",d)[0].focus(),b&&this.startMessageInterval()):"hidden"==a?(c.is(":hidden")&&this.show(),b&&this.stopMessageInterval(),d.hide(),e.show()):"closed"==a&&(b&&this.stopMessageInterval(),d.hide(),e.show(),this.hide())},getPanelStatus:function(){var a=this.element,b=$(".fs-qx-chat-shown",a),c=$(".fs-qx-chat-hidden",a);return b.is(":visible")&&c.is(":hidden")?"shown":b.is(":hidden")&&c.is(":visible")?"hidden":a.is(":hidden")?"closed":void 0},_previewImg:function(a){var b=$(a.currentTarget),c=b.attr("path"),d=m.parse(decodeURIComponent(b.attr("attachdata")));G.preview({type:"img",data:[{previewPath:c+"2",originPath:c+"1",thumbPath:c+"3",createTime:d.createTime,fileName:d.attachName,fileSize:d.attachSize,fileId:d.attachID}],refId:0,belongToType:"qx"}),a.preventDefault()},_previewAttach:function(a){var b=$(a.currentTarget);b.attr("path");var c=m.parse(decodeURIComponent(b.attr("attachdata")));I.readFile({fileId:c.attachID,fileName:c.attachName,filePath:c.attachPath}),a.preventDefault()},_showLocation:function(a){var b=$(a.currentTarget),c=m.parse(decodeURIComponent(b.attr("locationdata")));K.fixLocation(c,{showQd:!1}),a.preventDefault()},_openJoinDialog:function(a){var b,c,d=this,e=this.get("joinDialog"),f=this.get("qxPanel"),g=this.getActiveSession(),h=g.data,i=h.participantIds,k=g.sessionType,l=$(a.currentTarget);l.hasClass("state-disabled")||(e&&e.show(),b=_.map(i,function(a){return j.getContactDataById(a,"p")}),e.setInitData({joinData:b,unjoinData:O(i)}),c="pair"==k?"/ShortMessage/CreateSessionForDiscussion":"/ShortMessage/ParticipantsChanged",e.set("successCb",function(a){var b=_.map(a,function(a){return a.id});return b.length>100?(j.alert("讨论组的人数上限为100位同事，请确认。",function(){e.hide()}),void 0):(j.api({url:c,data:{sessionID:g.sessionId,participantsIDs:b},success:function(a){var b,c;a.success&&(b=a.value,c="pair"==k?b:b.session,f.addDiscussionMemberData(c),f.reRenderDiscussionGroup(),"discussion"==k?(d._updateSessionData(c),d._renderActiveSessionInfo()):d.addOrUpdateSession({sessionId:c.sessionID,sessionType:c.isDiscussion?"discussion":"pair",employeeIds:c.participantsIDs,data:c},!0,{profileImage:j.getAvatarLink(c.profileImage,3),chatStateCls:c.isDiscussion?"":f.getEmployeeChatState(P(c.participantsIDs)),title:c.name,name:c.name}),e.hide())}},{submitSelector:$(".f-sub",e.element)}),void 0)})),a.preventDefault()},_enterChatItem:function(a){var b=$(a.currentTarget),c=$(".remove-l",b);c.show()},_leaveChatItem:function(a){var b=$(a.currentTarget),c=$(".remove-l",b);c.hide()},_clickChatItemNav:function(a){var b=this.element,c=$(".chat-nav-panel",b),d=$(a.currentTarget).closest(".chat-item"),e=$(".chat-item",c);this.set("activeIndex",e.index(d))},_clickRemoveChatItemNav:function(a){var b=this.element,c=$(".chat-nav-panel",b),d=$(a.currentTarget).closest(".chat-item"),e=$(".chat-item",c);this.stopMessageInterval(),d.remove(),0==$(".chat-item",c).length?this.switchPanelStatus("closed",!0):this.removeSession(e.index(d)),this._adjustNavScrollTop()},_blurChatTitleEdit:function(a){var b=this.element,c=$(".chat-nav-panel",b),d=$(".state-active",c),e=$(a.currentTarget),f=e.closest(".fs-qx-chat-title"),g=$(".chat-title-shown",f),h=$(".join-num",f),i=_.str.trim(e.val()),k=this.getActiveSession(),l=k.data,m=this.get("qxPanel");return 0==i.length&&l.isDefaultName?(g.show(),h.show(),e.hide(),void 0):i.length>200?(j.alert("请控制名称在200字内"),void 0):(e.data("request")||(i!=_.str.trim(g.text())?(e.data("request",!0),j.api({url:"/ShortMessage/ModifySessionName",data:{sessionID:k.sessionId,name:i},success:function(a){var b;a.success?(b=a.value,g.text(b.value2).show(),$(".chat-name",d).text(b.value2),h.show(),e.hide(),m.addDiscussionMemberData({sessionID:k.sessionId,name:b.value2}),m.reRenderDiscussionGroup(),l.isDefaultName=b.value1):(g.show(),h.show(),e.hide())},complete:function(){e.data("request",!1)}})):(g.show(),h.show(),e.hide())),void 0)},_keydownChatTitleEdit:function(a){var b=$(a.currentTarget);_.str.trim(b.val()),13==a.keyCode&&b.blur()},_keyupChatTitleEdit:function(a){var b=$(a.currentTarget);_.str.trim(b.val())},_clickChatTitleShown:function(a){var b=$(a.currentTarget),c=b.closest(".fs-qx-chat-title"),d=$(".title-edit",c),e=$(".join-num",c),f=this.getActiveSession(),g=f.data;b.hasClass("state-disabled")||(b.hide(),e.hide(),d.val(g.isDefaultName?"":b.text()).show().get(0).focus()),a.preventDefault()},_clickNavDown:function(a){var b=this.element,c=$(".chat-nav-panel .chat-list-wrapper",b),d=$(".chat-list",c),e=c.scrollTop(),f=c.height(),g=d.height();g+4>e+f&&c.scrollTop(e+32),a.preventDefault()},_clickNavUp:function(a){var b=this.element,c=$(".chat-nav-panel .chat-list-wrapper",b),d=c.scrollTop();d>0&&c.scrollTop(d-32),a.preventDefault()},_clickHiddenTitle:function(a){var b=this.get("qxPanel");b._prepareGroupList(),this.sessionListData.length>0?-1==this.get("activeIndex")?(this.set("activeIndex",0,{}),this.switchPanelStatus("shown",!1)):this.switchPanelStatus("shown",!0):this.switchPanelStatus("shown",!0),a.preventDefault()},_clickMinBtn:function(a){var b=this.getActiveSession(),c=b.data,d=this.element,e=$(".fs-qx-chat-hidden .fs-qx-chat-tbar",d),f=$(".fs-qx-chat-title",e);e.removeClass("fs-qx-new-message"),f.html(c.name).css({background:"#eaeaea",color:"#3d3d3d"}),this.stopAllAudio(),this.switchPanelStatus("hidden",!0),a&&a.preventDefault()},_clickUploadRemove:function(a){var b=this.element,c=$(".message-submit-wrapper",b),d=$(".upload-file",c),e=d.attr("fileid"),f=d.attr("uploadtype");this.imgUploader.setDisable(!1),this.attachUploader.setDisable(!1),this[f+"Uploader"].removeFile(e),c.removeClass("with-upload"),a.preventDefault()},_clickSubmit:function(a){var b,c,d=this,e=this.get("qxPanel"),f=this.element,g=$(".message-submit-wrapper .submit-modal",f),h=$(".message-submit-wrapper .upload-file",f),i=$(".remove-l",h),k=$(".message-input",f),l=$(".history-h",f),m=$(a.currentTarget),n=_.str.trim(k.val()),o=this.getActiveSession(),p=o.sessionType,q=o.data;return h.is(":hidden")&&0==n.length?(j.showInputError(k),!1):(a.preventDefault(),n.length>2e3?(j.alert("发布内容不能超过2000字，目前已超出<em>"+(n.length-2e3)+"</em>个字"),void 0):(e._prepareGroupList(),g.show(),this._sendMessage(function(a,f){var h={sessionID:o.sessionId,messageContent:n,receiveIDs:q.participantIds,fileInfo:a[0]};h.shortMessageType=a.length>0?0==n.length?"img"==f?3:4:1:2,j.api({url:"/ShortMessage/SendShortMessage",data:h,success:function(g){a.length>0&&i.click(),k.val(""),g.success&&0==o.sessionId&&(o.sessionId=g.value.value,d.isCurrentSession(o)&&l.attr("href","#shortmessage/showsession/=/id-"+o.sessionId)),g.success&&("pair"==p?(b=_.find(q.participantIds,function(a){return a!=D.id}),c=j.getContactDataById(b,"p"),c=_.extend({state:e.getEmployeeChatState(c.id),lastChatDate:g.serviceTime},c),e.addRlmMemberData(c),e.reRenderRlmGroup()):"discussion"==p&&(e.addDiscussionMemberData({sessionID:o.sessionId,lastCreateTime:g.serviceTime}),e.reRenderDiscussionGroup()),d._appendMessageAfterSend(g,h,{uploadType:f}))},complete:function(){g.hide()}},{submitSelector:m})},function(){j.alert("上传附件失败，请重试"),g.hide()}),void 0))},_keydownInput:function(a){var b=this.element,c=$(".fs-qx-chat-shown .f-sub",b);13==a.keyCode&&(c.click(),a.preventDefault())},_clickLogout:function(a){var b=this.getActiveSession(),c=this.element,d=$(".chat-nav-panel",c),e=$(".chat-item",d),f=e.eq(this.get("activeIndex")),g=this.get("qxPanel");j.confirm("是否要确定退出并删除当前讨论组"," ",function(a){var c=this;j.api({url:"/ShortMessage/QuitAndDeleteSession",data:{sessionID:b.sessionId},success:function(a){a.success&&($(".remove-l",f).click(),g.removeDiscussionMemberData(b.sessionId),g.reRenderDiscussionGroup()),c.hide()}},{submitSelector:$(a.currentTarget)})},{messageType:"question",autoHide:!1}),a.preventDefault()},shortCutDelDiscussion:function(a){var b,c=-1,d=this.get("qxPanel"),e=this.element,f=$(".chat-nav-panel",e),g=$(".chat-item",f),h=this.sessionListData;_.some(h,function(b,d){return b.sessionId==a?(c=d,!0):void 0}),c>-1&&(b=g.eq(c),$(".remove-l",b).click()),d.removeDiscussionMemberData(a),d.reRenderDiscussionGroup()},_renderNewChatItem:function(a){var b=this.element,c=($(".chat-nav-panel .chat-list-wrapper",b),$(".chat-list",b));a=a||{},c.append(u(_.extend({profileImage:e.BLANK_IMG,chatStateCls:"",blankImage:e.BLANK_IMG,title:"",name:""},a))),this._adjustNavScrollTop()},_adjustNavScrollTop:function(){var a,b,c=this.element,d=$(".chat-nav-panel .chat-list-wrapper",c),e=$(".chat-list",c),f=$(".state-active",e),g=$(".chat-item",e).index(f);a=d.height(),b=e.height(),d.scrollTop(0),b>a?f.length>0?32*(g+2)+4>a&&d.scrollTop(32*(g+2)-a+4):d.scrollTop(b-a+10):d.scrollTop(0)},_sendMessage:function(a,b){var c,d=this,e=this.element,f=$(".message-submit-wrapper .upload-file",e),g=f.attr("uploadtype"),h=f.attr("fileid");f.is(":visible")?(c=this[g+"Uploader"],this.on("uploaded",function(e,f,g){var i=m.parse(f),j=[];i.success?(j.push({value:"img"==g?2:3,value1:i.value.filePath,value2:e.size,value3:e.name}),a.call(d,j,g),c.removeFile(h)):b&&b.call(d),d.off("uploaded")}),this.on("uploadederror",function(){b&&b.call(d),d.off("uploadederror")}),c.startUpload()):a.call(d,[],g)},_appendMessageAfterSend:function(a,b,c){var d=[],e=a.value,f=e.value1,g=e.value2,h=e.value4,i=e.value5;g?(1==b.shortMessageType&&d.push({messageType:2,messageShowContent:b.messageContent,createTime:a.serviceTime,shortMessageID:f[0],employeeID:D.id,employee:{name:D.name}}),d.push({messageType:"img"==c.uploadType?3:4,createTime:a.serviceTime,shortMessageID:f[1]||f[0],employeeID:D.id,employee:{name:D.name},attach:[{attachPath:g,attachName:b.fileInfo.value3,fileIcon:"img"==c.uploadType?"jpg":j.getFileExtText(b.fileInfo.value3),attachSize:h,canPreview:i}]})):d.push({messageType:2,messageShowContent:b.messageContent,createTime:a.serviceTime,shortMessageID:f[0],employeeID:D.id,employee:{name:D.name}}),this.appendAllNewMessage(d)},getActiveSession:function(){var a,b=this.get("activeIndex"),c=this.sessionListData;return a=c&&c.length>0&&b>-1?c[b]:null},isCurrentSession:function(a){var b=this.getActiveSession(),c=b.sessionId,d=b.sessionType,e=b.employeeIds;return c==a.sessionId?!0:"pair"==d&&a.sessionType==d&&this.isEqualParticipantIds(a.employeeIds,e)?!0:!1},getSessionById:function(a){var b=this.sessionListData;return _.find(b,function(b){return b.sessionId==a})},removeSession:function(a){var b=this.get("activeIndex"),c=this.sessionListData;c.splice(a,1),this.sessionListData=c,b>a?this.set("activeIndex",b-1,{silent:!0}):a==b&&(a==c.length?this.set("activeIndex",a-1):this._onRenderActiveIndex(a))},isEqualParticipantIds:function(a,b){var c=!0;return a=_.map(a,function(a){return parseInt(a)}),b=_.map(b,function(a){return parseInt(a)}),a.length!=b.length?c=!1:(_.some(a,function(a){return _.contains(b,a)?void 0:(c=!1,!0)}),c)},addOrUpdateSession:function(a,b,c){var d,e=this,f=a.sessionId,g=a.sessionType,h=a.employeeIds,i=this.sessionListData||[],j=_.find(i,function(a,b){return d=b,a.sessionId==f?!0:"pair"==g&&a.sessionType==g&&e.isEqualParticipantIds(a.employeeIds,h)?(f>0&&(a.sessionId=f),!0):void 0});j||(i.push(_.extend({sessionId:0,sessionType:g},a)),d=i.length-1,this._renderNewChatItem(c)),this.sessionListData=i,b&&(d==this.get("activeIndex")?this.switchPanelStatus("shown",!0):this.set("activeIndex",d))},updateLayout:function(){var a,b=this.get("qxPanel"),c=this.element,d=$(".fs-qx-chat-shown .fs-qx-chat-tbar",c),e=$(".fs-qx-chat-shown .fs-qx-chat-title",c),f=$(".chat-title-shown",e),g=$(".join-num",e),h=$(".open-dg-l",d),i=$(".fs-qx-chat-shown .open-dg-btn",c),j=$(".fs-qx-chat-shown .logout-btn",c),k=$(".chat-nav-panel",c),l=$(".chat-message-panel",c),m=$(".state-offline-tip",l),n=$(".message-submit-wrapper",c),o=$(".message-input",c),p=$(".participant-panel",c),q=$(".message-list-wrapper",c),r=$(".message-submit-bbar .f-sub",c),s=this.sessionListData,t=this.get("activeIndex"),u=s[t],v=u.employeeIds,w=$("html");if(w.hasClass("lt-ie8")&&d.removeAttr("style"),s.length>1?k.show():k.hide(),n.hasClass("with-upload"))try{this.imgUploader.setDisable(!0),this.attachUploader.setDisable(!0)}catch(x){}else try{this.imgUploader.setDisable(!1),this.attachUploader.setDisable(!1)}catch(x){}if(o.prop("disabled",!1),r.removeClass("button-state-disabled").prop("disabled",!1),f.removeClass("state-disabled"),h.removeClass("state-disabled"),i.removeClass("button-state-disabled").prop("disabled",!1),j.removeClass("button-state-disabled").prop("disabled",!1),"discussion"==u.sessionType){if(p.show(),l.width(294),o.width(284),g.show(),e.addClass("chat-title-edit-enable"),!_.some(v,function(a){return a==D.id})){try{this.imgUploader.setDisable(!0),this.attachUploader.setDisable(!0)}catch(x){}o.prop("disabled",!0),r.addClass("button-state-disabled").prop("disabled",!0),f.addClass("state-disabled"),h.addClass("state-disabled"),i.addClass("button-state-disabled").prop("disabled",!0),j.addClass("button-state-disabled").prop("disabled",!0)}m.hide()}else p.hide(),l.width(394),o.width(384),g.hide(),e.removeClass("chat-title-edit-enable"),a=b.getEmployeeChatState(P(v)),"pc-online"==a||"mobile-online"==a?m.hide():u.hideOfflineTip?m.hide():m.show();w.hasClass("lt-ie8")&&d.width(c.width()-2),$(".chat-item",k).eq(t).find("a").removeAttr("style"),q.scrollTop(1e4)},_updateSessionData:function(a){var b=this.get("activeIndex"),c=this.sessionListData,d=c[b];a.sessionID&&(d.sessionId=a.sessionID),a.participantIds&&(d.employeeIds=a.participantIds),d.data=_.extend(d.data||{},a)},_updateLastMessageMark:function(a,b){var c=this.getSessionById(a);c.lastMessageCreatTime=b?b.createTime:0,c.lastMessageID=b?b.shortMessageID:0},_renderActiveSessionInfo:function(){var a,b=this.get("qxPanel"),c=this.get("activeIndex"),d=this.sessionListData,f=d[c],g=f.sessionType,h=f.data,i=h.participantIds,k=this.element,l=$(".fs-qx-chat-shown .fs-qx-chat-title",k),m=$(".fs-qx-chat-shown .avatar-win",k),n=$(".chat-title-shown",l),o=$(".join-num .num",l),p=$(".chat-list-wrapper",k),q=$(".chat-item",p).eq(c),r=$(".chat-item-content",q),s=$(".avatar-thumb",q),t=$(".chat-name",q),u=$(".participant-list-wrapper",k),v=$(".history-h",k),w="",x="";"pair"==g&&(a=P(f.employeeIds),x="state-"+b.getEmployeeChatState(a),q.attr("employeeid",a).removeClass("state-pc-online state-mobile-online state-offline").addClass(x)),m.html('<a class="avatar-win-inner '+x+'"><img width="50" height="50" src="'+j.getAvatarLink(h.profileImage,2)+'" alt="'+h.name+'" class="avatar-thumb" />'+'<img src="'+e.BLANK_IMG+'" class="fs-qx-flag-state"></a>'),"pair"==g?(n.attr("href","#profile/=/empid-"+a),$(".avatar-win-inner",m).attr("href","#profile/=/empid-"+a)):(n.attr("href","javascript:;"),$(".avatar-win-inner",m).attr("href","javascript:;")),s.attr("src",j.getAvatarLink(h.profileImage,3)),n.html(h.name),t.html(h.name),o.html(i.length),r.attr("title",h.name),_.each(i,function(a){var c=b.getEmployeeChatState(a),d=j.getContactDataById(a,"p");d&&(w+='<li class="participant-item state-'+c+'" participantid="'+a+'">'+'<a title="'+d.name+'" class="participant-item-content fn-clear" href="javascript:;">'+'<span class="avatar-wrapper fn-left"><img width="20" height="20" alt="" class="avatar-thumb" src="'+j.getAvatarLink(d.profileImagePath,3)+'" />'+'<img src="'+e.BLANK_IMG+'" class="fs-qx-flag-state" />'+"</span>"+'<span class="participant-name fn-left">'+d.name+"</span>"+"</a>"+"</li>")}),u.html('<ul class="participant-list">'+w+"</ul>"),f.sessionId>0?v.attr("href","#shortmessage/showsession/=/id-"+f.sessionId):v.attr("href","javascript:;")},_onRenderActiveIndex:function(a){var b,c,d,e=this,f=this.element,g=this.sessionListData,h=this.get("qxPanel");this._sessionXhr&&this._sessionXhr.abort(),this.stopAllAudio(),this.resetPanelExceptChatNav(),a>-1?(this.stopMessageInterval(),this.switchPanelStatus("shown",!1),b=$(".chat-item",f),c=b.eq(a),d=g[a],b.removeClass("state-active"),c.show().addClass("state-active"),$("a",c).removeAttr("style").removeClass("cic-come-on"),this.emptyMessageList(),this.clearNewMessageStore(d.sessionId),this._sessionXhr=j.api({url:"/ShortMessage/GetSessionAndNewMessages",data:{employeeIDs:d.employeeIds,sessionID:d.sessionId},type:"post",success:function(a){var b,c,f,g;if(a.success){if(b=a.value,c=b.session,f=b.shortMessages.reverse(),g=f[f.length-1],c.isDeleted&&c.isDiscussion)return j.alert("该讨论组已被删除"),e.shortCutDelDiscussion(c.sessionID),void 0;c.isDiscussion&&g&&(h._prepareGroupList(),h.addDiscussionMemberData(_.extend({lastCreateTime:g.createTime},c)),h.reRenderDiscussionGroup()),!c.isDiscussion&&_.isUndefined(c.profileImage)&&(c.profileImage=j.getContactDataById(P(d.employeeIds),"p").profileImagePath),e._updateSessionData(c),e.updateLayout(),e._renderActiveSessionInfo(),e.reRenderMessageList(f),e.serverTime=a.serverTime,e._updateLastMessageMark(b.session.sessionID,g),e.startMessageInterval()}}})):this.emptyMessageList()},startMessageInterval:function(){var a=this,b=function(){a.requestNewMessage(function(){clearTimeout(this.messageTid),a.messageTid=setTimeout(function(){b()},3e3)})};b()},stopMessageInterval:function(){clearTimeout(this.messageTid)},reStartMessageInterval:function(){this.stopMessageInterval(),this.startMessageInterval()},requestNewMessage:function(a){var b,c=this,d=this.get("qxPanel"),e=this.getActiveSession();e&&(b=e.lastMessageID||0,j.api({url:"/ShortMessage/GetNewMessageFromOneSession1",type:"get",data:{sessionID:e.sessionId,lastMessageID:b},success:function(a){var b,f,g,h,i,j=e.lastMessageID||0;a.success&&(b=a.value,f=b.shortMessages,f.length>0&&(f.reverse(),h=f[0],g=f[f.length-1],h.shortMessageID>j&&(c.appendAllNewMessage(f),_.each(f,function(a){7==a.messageType&&c._updateSessionFromControl(m.parse(a.messageContent))}),c._updateLastMessageMark(g.sessionID,g),_.some(f,function(a){return 7!=a.messageType})&&(i=e.employeeIds,_.contains(i,D.id)||(i.push(D.id),c._updateSessionData({participantIds:i}),c._renderActiveSessionInfo(),c.updateLayout())),"discussion"==e.sessionType&&(d.addDiscussionMemberData({sessionID:e.sessionId,lastCreateTime:g.createTime}),d.reRenderDiscussionGroup()))))},complete:function(){a.call(c)}},{abortLast:!0,errorAlertModel:1}))},_updateSessionFromControl:function(a){var b=this.get("qxPanel"),c=this.getActiveSession(),d=a.A,e=a.B,f=a.D,g=d.split(",");this._updateSessionData({name:e,profileImage:f,participantIds:g}),this._renderActiveSessionInfo(),this.updateLayout(),"discussion"==c.sessionType&&(b.addDiscussionMemberData({sessionID:c.sessionId,name:e,profileImage:f,participantsIDs:g,participantsCount:g.length}),b.reRenderDiscussionGroup())},getFormatCreateTime:function(a){var b=this.serverTime?k.unix(this.serviceTime):k(),a=k.unix(a),c="",d=a.year(),e=a.month(),f=a.date();return b.year()!=a.year()&&(c+=d+"-"),(b.month()!=e||b.date()!=f)&&(c+=e+1+"-"+f),c+=" "+a.format("HH:mm")},getMessageTypeKey:function(a){var b;switch(a){case 2:b="text";break;case 3:b="img";break;case 4:b="attach";break;case 5:b="audio";break;case 6:b="location";break;case 7:b="control";break;default:b="unknown"}return b},getMessageItemHtml:function(a){var b,c,d,f,g=a.messageType,h=this.getActiveSession();switch("discussion"==h.sessionType?(d=a.employee.name,a.employeeID==D.id&&(d="我")):d="",g){case 3:f=a.attach[0],b=w({messageContent:a.messageShowContent,createTime:this.getFormatCreateTime(a.createTime),employeeName:d,img:'<img class="img-thumb" src="'+j.getDfLink(f.attachPath+"3",f.attachName,!1,f.fileIcon)+'" alt="" />',attachSize:j.getFileSize(f.attachSize),path:f.attachPath,attachData:encodeURIComponent(m.stringify(f))});break;case 4:f=a.attach[0],b=x({messageContent:a.messageShowContent,createTime:this.getFormatCreateTime(a.createTime),employeeName:d,attachName:f.attachName,attachSize:j.getFileSize(f.attachSize),attachIcon:'<img class="fs-attach-'+j.getFileType({name:f.attachName})+'-icon attach-icon" src="'+e.BLANK_IMG+'" alt="" />',downloadPath:j.getDfLink(f.attachPath,f.attachName,!0),attachData:encodeURIComponent(m.stringify(f)),canPreview:f.canPreview});break;case 5:f=a.attach[0],b=y({messageContent:a.messageShowContent,createTime:this.getFormatCreateTime(a.createTime),employeeName:d,audioSrc:j.getDfLink(j.getFileNamePath(f.attachPath),f.attachName,!1,"mp3"),audioLength:f.attachSize,isAudioUnread:a.isAudioUnread,messageId:a.shortMessageID});break;case 6:b=A({messageContent:j.getLocationInfo(a.messageLocation),createTime:this.getFormatCreateTime(a.createTime),employeeName:d,locationData:encodeURIComponent(m.stringify(a.messageLocation))});break;case 7:b=z({messageContent:("我"==d?"你":d)+a.messageShowContent});break;case 2:default:c=a.messageShowContent,c=c.replace(/</g,"&lt;"),c=c.replace(/>/g,"&gt;"),c=c.replace(/[\n\r]/g,"<br/>"),c=c.replace(new RegExp(" ","g"),"&nbsp;"),c=c.replace(M,function(a){return'<a href="'+a+'" target="_blank">'+a+"</a>"}),b=v({messageContent:c,createTime:this.getFormatCreateTime(a.createTime),employeeName:d})}return b},getMessageCompiled:function(){},getMessagePosition:function(){},reRenderMessageList:function(a){var b=this.element,c=$(".message-list",b);_.each(this.audioCpts,function(a){a.destroy()}),this.audioCpts=[],c.empty(),this.appendAllNewMessage(a)},emptyMessageList:function(){this.reRenderMessageList([])},appendAllNewMessage:function(a){var b=this,c=this.element,d=$(".message-list-wrapper",c);a=[].concat(a),_.each(a,function(a){b.appendNewMessage(a)}),d.scrollTop(1e4)},appendNewMessage:function(a){var b,c,d,e=this.element,f=$(".message-list-wrapper",e),g=$(".message-list",f),h=!1;if(!_.isUndefined(a.shortMessageID)&&($(".message-item",g).each(function(){var b=$(this),c=b.attr("messageid");return c==a.shortMessageID?(h=!0,!1):void 0}),!h)){c=$(".message-item",g).filter('[messageid="'+(a.shortMessageID-1)+'"]'),0==c.length&&(d=$(".message-item",g).last(),c=a.shortMessageID-1>d.attr("messageid")?"last":"first");var i,j,k=this.getMessageTypeKey(a.messageType),l=this.getMessageItemHtml(a);7==a.messageType?i="center":a.employeeID==D.id?(i="right",j=3):(i="left",j=2),b=$('<li messageid="'+a.shortMessageID+'" class="message-item message-type-'+k+" message-position-"+i+' fn-clear">'+l+"</li>");var m=b.find("img");m.length>0&&m.load(function(){f.scrollTop(1e4)}),"last"==c?b.appendTo(g):"first"==c?b.prependTo(g):b.insertAfter(c);var o;5==a.messageType&&(o=$(".audio-box",b),this.audioCpts.push(new n({element:o,audioSrc:o.attr("audiosrc"),themeStyle:j,length:a.attach[0].attachSize})));var p,q=this.get("maxHisNum"),r=$(".message-item",g);r.length>q&&(p=r.slice(0,r.length-q),_.each(this.audioCpts.splice(0,p.filter(".message-type-audio").length),function(a){a.destroy()}),p.remove())}},stopAllAudio:function(){_.each(this.audioCpts,function(a){a.stop()})},showNewMessageAlert:function(a){var b=this.element,c=$(".fs-qx-chat-hidden .fs-qx-chat-tbar",b),d=$(".fs-qx-chat-title",c);c.addClass("fs-qx-new-message"),d.css({color:"#ffffff"}).text("您有"+a+"条新企信"),j.toggleAnimate({element:d,startProperty:{backgroundColor:"#ffffff"},endProperty:{backgroundColor:"#f76c05"},animateOpts:{easing:"swing",duration:130},count:2})},_lazyRenderUploader:function(){var a=this,b=this.element,c=$(".upload-img-h .upload-field",b),d=$(".upload-attach-h .upload-field",b),f=$(".message-submit-wrapper",b),g=$(".upload-file",f),h=function(a,b){var c=j.getFileSize(a.size),d=j.getFileType(a);f.addClass("with-upload"),g.attr("fileid",a.id),g.attr("uploadtype",b),$(".file-name",g).html('<img class="file-icon fs-attach-'+d+'-small-icon" src="'+e.BLANK_IMG+'" /><span class="file-name-content">'+a.name+"（"+c+")</span>"),k.setDisable(!0),l.setDisable(!0)
},i=C.u.uploadFileSizeLimit,k=new Q({element:c,h5Opts:{multiple:!1,accept:"image/*",filter:function(a){var b=[];return _.each(a,function(a){a.size<1024*1024*i&&a.size>0?"jpg"==j.getFileType(a)?b.push(a):j.alert("请选择图片格式的文件"):j.alert("上传文件不能大于"+i+"m，内容不能为空")}),b}},flashOpts:{file_types:"*.jpg;*.gif;*.jpeg;*.png",file_types_description:"图片格式",file_queued_handler:function(a){return a.size<1024*1024*i&&a.size>0?k.opts.onSelect.call(k,a):(k.core.cancelUpload(a.id,!1),j.alert("上传文件不能大于"+i+"m，内容不能为空"),void 0)}},onSelect:function(a){h(a,"img")},onSuccess:function(b,c){a.trigger("uploaded",b,c,"img")},onFailure:function(b){a.trigger("uploadederror",b)}}),l=new Q({element:d,h5Opts:{multiple:!1,accept:"*/*",filter:function(a){var b=[];return _.each(a,function(a){a.size<1024*1024*i&&a.size>0?b.push(a):j.alert("上传文件不能大于"+i+"m，内容不能为空")}),b}},flashOpts:{file_types:"*.*",file_types_description:"所有文件",file_queued_handler:function(a){return a.size<1024*1024*i&&a.size>0?l.opts.onSelect.call(l,a):(l.core.cancelUpload(a.id,!1),j.alert("上传文件不能大于"+i+"m，内容不能为空"),void 0)}},onSelect:function(a){h(a,"attach")},onSuccess:function(b,c){a.trigger("uploaded",b,c,"attach")},onFailure:function(b){a.trigger("uploadederror",b)}});this.imgUploader=k,this.attachUploader=l},render:function(){this.element.html(t.filter(".fs-qx-chat-tpl").html());var a=T.superclass.render.apply(this,arguments);return this._renderCpt(),a},_renderCpt:function(){var a=this.element,b=$(".fs-qx-chat-shown",a);$(".message-list-wrapper",b),$(".participant-list-wrapper",b)},show:function(){var a=T.superclass.show.apply(this,arguments);return a},hide:function(){var a=T.superclass.hide.apply(this,arguments);return this.clear(),a},clear:function(){var a=this.element,b=$(".chat-nav-panel",a),c=$(".participant-panel",a);this.sessionListData=null,this.set("activeIndex",-1),$(".chat-list",b).empty(),b.hide(),$(".participant-list",b).remove(),c.hide()},destroy:function(){var a;return this.serverTime=null,clearTimeout(this.messageTid),this.messageTid=null,clearInterval(this.starHtmlTitleTid),this.starHtmlTitleTid=null,_.each(this.audioCpts,function(a){a.destroy&&a.destroy()}),this.audioCpts=null,this._newMessageStore=null,this.newMessageAlertPlayer&&this.newMessageAlertPlayer.destroy(),this.newMessageAlertPlayer&&this.newMessageAlertPlayer.shadowEl.remove(),this.newMessageAlertPlayer&&(this.newMessageAlertPlayer.shadowEl=null),this.newMessageAlertPlayer=null,this._sessionXhr=null,this._chatMessageScrollBar&&this._chatMessageScrollBar.destroy(),this._participantScrollBar&&this._participantScrollBar.destroy(),this.joinDialog&&this.joinDialog.destroy(),this.imgUploader&&this.imgUploader.destroy(),this.attachUploader&&this.attachUploader.destroy(),this.sessionListData=null,a=T.superclass.destroy.apply(this,arguments)}}),U=g.extend({attrs:{align:{selfXY:["100%+20px","100%"],baseElement:h.VIEWPORT,baseXY:["100%","100%"]},className:"fs-qx",zIndex:100,qxStatus:null},events:{click:"_clickSelf","click .fs-qx-shown .fs-qx-tbar":"_clickToHidden","click .fs-qx-shown .fs-qx-bbar .hide-h":"_clickToHidden","click .fs-qx-hidden .fs-qx-tbar":"_switchToShown","click .open-dg-l":"_openNewDg","click .fs-qx-group-item .fs-qx-group-hd":"_clickGroupItem","click .online-group .fs-qx-member-item":"_clickEmployeeItem","click .circle-group .fs-qx-member-item":"_clickEmployeeItem","click .no-circle-group .fs-qx-member-item":"_clickEmployeeItem","click .fs-qx-list-search .fs-qx-member-item":"_clickEmployeeItem","click .rlm-group .fs-qx-member-item":"_clickEmployeeItem","click .discussion-group .fs-qx-member-item":"_clickTeamItem"},setup:function(){var a=U.superclass.setup.apply(this,arguments);return this.groupListData=null,this._setupCpt(),this._initGroupListData(),this._bindEvents(),a},_setupCpt:function(){var a=new S({moveLeftIntercept:function(a){return a.id==D.id?(this.joinList.unselectItem(a.id),!1):void 0},moveRightIntercept:function(a){return a.id==D.id?(this.unjoinList.unselectItem(a.id),!1):void 0},joinMinNum:2,joinMinNumTpl:"讨论组最少{{joinMinNum}}人"}),b=new T({joinDialog:a,qxPanel:this}).render();this.joinDialog=a,this.chatPanel=b},_initGroupListData:function(){var a=[],b=C.g,c=B.myDiscussions,d=B.recentlyLinkMans,e=this.getNoCircleEmployees();c=_.map(c,function(a){return _.extend({},a)}),a.push({name:'讨论组[<span class="total-num">'+c.length+"</span>]",title:"讨论组",groupType:"discussion",cls:"discussion-group",memberListData:c}),d=_.map(d,function(a){var b=j.getContactDataById(a.value,"p");return b?_.extend({state:"offline",lastChatDate:a.value1},b):null}),d=_.filter(d,function(a){return!!a}),a.push({name:'最近联系同事[<span class="online-num">0</span>/<span class="total-num">'+d.length+"</span>]",title:"最近联系同事",groupType:"rlm",cls:"rlm-group",memberListData:d}),a.push({name:'全部在线[<span class="total-num">0</span>]',title:"全部在线",groupType:"online",cls:"online-group",memberListData:[]}),b=_.filter(b,function(a){return"999999"!=a.id}),_.each(b,function(b){var c=j.getEmployeeListByCircleId(b.id);c=_.filter(c,function(a){return a.id!=D.id}),c=_.map(c,function(a){return _.extend({state:"offline"},a)}),c=_.sortBy(c,function(a){return a.spell}),a.push({name:b.name+'[<span class="online-num">0</span>/<span class="total-num">'+c.length+"</span>]",title:b.name,groupType:"circle",cls:"circle-group",memberListData:c})}),e=_.filter(e,function(a){return a.id!=D.id}),e=_.map(e,function(a){return _.extend({state:"offline"},a)}),a.push({name:'无部门[<span class="online-num">0</span>/<span class="total-num">'+e.length+"</span>]",title:"无部门",groupType:"noCircle",cls:"no-circle-group",memberListData:e}),this.groupListData=a},_bindEvents:function(){var a=this;f.event.on("globalremind",function(b){b.success&&a.pullSessionInfo(b.value)}),$(d).scroll(function(){a._setPosition()}),$("body").on("click",function(){a._switchToHidden()})},_clickSelf:function(a){a.stopPropagation()},_clickToHidden:function(a){this._switchToHidden(),a.preventDefault()},_switchToHidden:function(){var a=this.element,b=$(".fs-qx-shown",a),c=$(".fs-qx-hidden",a);b.hide(),c.show()},_switchToShown:function(a){var b=this.element,c=$(".fs-qx-shown",b),d=$(".fs-qx-hidden",b);c.show(),d.hide(),this._prepareGroupList(),this._setPosition(),this.updateQxScrollBar(),a.preventDefault()},_prepareGroupList:function(){var a=this;this._groupListRendered||(this._renderGroupList(),setTimeout(function(){a._onRenderQxStatus(a.get("qxStatus"))},0),this._groupListRendered=!0)},_openNewDg:function(a){var b=this,c=this.joinDialog,d=this.chatPanel,e=$(a.currentTarget);e.hasClass("state-disabled")||(c.show(),c.setInitData({joinData:[D],unjoinData:O(D.id)}),c.set("successCb",function(a){var e=_.map(a,function(a){return a.id});return e.length>100?(j.alert("讨论组的人数上限为100位同事，请确认。",function(){c.hide()}),void 0):(j.api({url:"/ShortMessage/CreateSessionForDiscussion",data:{name:"",participantsIDs:e},success:function(a){var e;a.success&&(e=a.value,b.addDiscussionMemberData(e),b.reRenderDiscussionGroup(),d.addOrUpdateSession({employeeIds:e.participantsIDs,sessionId:e.sessionID,sessionType:"discussion"},!0,{profileImage:j.getAvatarLink(e.profileImage,3),chatStateCls:"",title:e.name,name:e.name}),c.hide())}}),void 0)})),a.preventDefault(),a.stopPropagation()},_updateGroupItemIconView:function(a){var b=$(a),c=$(".fs-qx-member-list-wrapper",groupItemEl);0==c.length||c.is(":hidden")?b.addClass("state-collapse").removeClass("state-open"):b.addClass("state-open").removeClass("state-collapse")},_clickGroupItem:function(a){var b=$(a.currentTarget).closest(".fs-qx-group-item"),c=$(".fs-qx-member-list-wrapper",b);b.hasClass("state-open")?(c.hide(),b.addClass("state-collapse").removeClass("state-open")):(this._renderMemberList(b),c=$(".fs-qx-member-list-wrapper",b),c.show(),b.addClass("state-open").removeClass("state-collapse")),this.updateQxScrollBar(),a.preventDefault()},_clickEmployeeItem:function(a){var b=this.chatPanel,c=$(a.currentTarget),d=c.attr("employeeid"),e=j.getContactDataById(d,"p");b.addOrUpdateSession({employeeIds:[parseInt(d),D.id],sessionType:"pair",data:{name:e.name,profileImage:e.profileImagePath,participantIds:[D.id,e.id]}},!0,{profileImage:j.getAvatarLink(e.profileImagePath,3),chatStateCls:this.getEmployeeChatState(e.id),title:e.name,name:e.name})},_clickTeamItem:function(a){var b,c=this.chatPanel,d=$(a.currentTarget),e=d.attr("sessionid"),f=this.groupListData,g=f[0];b=_.find(g.memberListData,function(a){return a.sessionID==e}),c.addOrUpdateSession({employeeIds:b.participantsIDs,sessionId:e,sessionType:"discussion"},!0,{profileImage:j.getAvatarLink(b.profileImage,3),chatStateCls:"",title:b.name,name:b.name})},_getDiscussionAvatar:function(a){var b;return b=a?j.getDfLink(a+"3","",!1,"jpg"):e.ASSETS_PATH+"/images/icon-discussion-avatar.png"},_renderCpt:function(){var a=this,b=this.element,c=$(".fs-qx-list-wrapper",b),d=$(".fs-qx-search",b),e=$(".fs-qx-list-search",b);this.employeeQuery=new R({element:d,cls:"employee-query"}),this.employeeQuery.on("query",function(b){b.length>0?(a._renderSearchList(b),a.switchListPanel("search")):a.switchListPanel("group"),$(".fs-qx-member-item",e).eq(0).addClass("state-selected")}).on("keynav",function(a){var b,c=$(".fs-qx-member-item",e),d=c.filter(".state-selected");0==d.length&&(d=c.eq(0)),"up"==a?(b=d.prev(),0==b.length&&(b=c.last())):"down"==a&&(b=d.next(),0==b.length&&(b=c.first())),d.removeClass("state-selected"),b.addClass("state-selected")}).on("submit",function(a){var b=$(".fs-qx-member-item",e),c=b.filter(".state-selected");0==c.length&&(c=b.eq(0)),$(".member-info",c).click(),a.preventDefault()}),e.on("mouseenter",".fs-qx-member-item",function(a){var b=$(a.currentTarget);$(".fs-qx-member-item",e).removeClass("state-selected"),b.addClass("state-selected")}),this.qxListScrollBar=new r({element:c}),this.qxSearchScrollBar=new r({element:e}),this.qxSearchScrollBar.hide()},_renderSearchList:function(a){var b,c,d=this.element,e=$(".fs-qx-list-search",d),f=this.get("qxStatus"),g=f.statusData.onlineEmployeeIDs,h=f.statusData.mobileOnlineEmployeeIDs,i=O(D.id),j=[];b=E(i,a,{key:"name"}),c=F(i,a,{key:"spell"}),_.each(c,function(a){_.find(b,function(b){return b.id==a.id})||j.push(a)}),j=j.concat(b),j=_.map(j,function(a){var b;return b=_.contains(g,a.id)?_.contains(h,a.id)?"mobile-online":"pc-online":"offline",_.extend({state:b},a)}),this._renderMemberList_circle(e,{memberListData:j})},_renderMemberList:function(a){var b=this.getGroupDataByIndex($(a).attr("groupindex")),c=b.groupType;this["_renderMemberList_"+c].call(this,a,b)},_renderMemberList_discussion:function(a,b){var c=this,d=$(a),f=$(".fs-qx-member-list-wrapper",d),g="",h=b.memberListData;h.length>0&&(g+='<ul class="fs-qx-member-list">',_.each(h,function(a){var b=a.participantsIDs||[];g+='<li class="fs-qx-member-item" sessionid="'+a.sessionID+'"><a href="javascript:;" title="'+a.name+"&nbsp;[共"+b.length+'人]" class="member-info fn-clear"><span class="avatar-wrapper fn-left"><img src="'+c._getDiscussionAvatar(a.profileImage)+'" alt="" class="avatar-thumb" /><img src="'+e.BLANK_IMG+'" class="fs-qx-flag-state" /></span><span class="member-name fn-left">'+a.name+'<span class="working-state">&nbsp;['+b.length+"]</span></span></a></li>"}),g+="</ul>"),f.html(g),this.updateQxScrollBar()},_renderMemberList_rlm:function(a,b){b.memberListData=b.memberListData.slice(0,20),this._renderMemberList_circle(a,b)},_renderMemberList_online:function(a,b){this._renderMemberList_circle(a,b)},_renderMemberList_circle:function(a,b){var c=$(a),d=$(".fs-qx-member-list-wrapper",c),f="",g=b.memberListData;g.length>0&&(f+='<ul class="fs-qx-member-list">',_.each(g,function(a){var b=a.workingState;_.isString(b)&&b.length>0&&(b="&nbsp;-&nbsp;"+b),f+='<li class="fs-qx-member-item state-'+a.state+'" employeeid="'+a.id+'"><a href="javascript:;" title="'+a.name+b+'" class="member-info fn-clear"><span class="avatar-wrapper fn-left"><img src="'+j.getAvatarLink(a.profileImagePath,3)+'" alt="" class="avatar-thumb" /><img src="'+e.BLANK_IMG+'" class="fs-qx-flag-state" /></span><span class="member-name fn-left">'+a.name+'<span class="working-state">'+b+"</span></span></a></li>"}),f+="</ul>"),d.html(f),this.updateQxScrollBar()},_renderMemberList_noCircle:function(a,b){this._renderMemberList_circle(a,b)},_renderGroupList:function(){var a=this.groupListData,b=this.element,c=$(".fs-qx-list-wrapper",b),d="";a.length>0&&(d+='<ul class="fs-qx-group-list">',_.each(a,function(a,b){d+='<li class="'+a.cls+' fs-qx-group-item state-collapse" groupindex="'+b+'"><div class="fs-qx-group-hd"><a href="javascript:;" title="'+a.title+'">'+a.name+'</a></div><div class="fs-qx-member-list-wrapper"></div></li>'}),d+="</ul>"),c.html(d),this.updateQxScrollBar()},render:function(){this.element.html(t.filter(".fs-qx-tpl").html());var a=U.superclass.render.apply(this,arguments);return this._renderCpt(),a},show:function(){var a=U.superclass.show.apply(this,arguments);return a},switchListPanel:function(a){a=a||"group";var b=this.qxListScrollBar,c=this.qxSearchScrollBar;"group"==a?(b.show(),b.update(),c.hide()):"search"==a&&(b.hide(),c.show(),c.update())},getNoCircleEmployees:function(){var a,b=C.p;return a=_.filter(b,function(a){return!a.groupIDs||0==a.groupIDs.length})},getGroupDataBySelector:function(a){var b=this.element,c=$(".fs-qx-group-item",b),d=$(a),e=c.index(d),f=this.groupListData,g=f[e];return g},getGroupDataByIndex:function(a){return a=parseInt(a),_.isNumber(a)?this.groupListData[a]:void 0},getEmployeeChatState:function(a){a=parseInt(a);var b,c=this.get("qxStatus"),d=c.statusData,e=d.onlineEmployeeIDs,f=d.mobileOnlineEmployeeIDs;return b=_.contains(e,a)?_.contains(f,a)?"mobile-online":"pc-online":"offline"},pullSessionInfo:function(a){var b={shortMessageCount:a.shortMessageCount,statusData:a.shortMessage};this.set("qxStatus",b),this.trigger("qxstatus",b)},updateCircleMemberData:function(a){var b=this,c=this.getGroupDataByIndex($(a).attr("groupindex")),d=c.memberListData,e=_.groupBy(d,function(a){var c=b.getEmployeeChatState(a.id);return a.state=c,"offline"!=c?"online":"offline"});e.online=_.sortBy(e.online,function(a){return a.spell}),e.offline=_.sortBy(e.offline,function(a){return a.spell}),c.memberListData=e.online.concat(e.offline)},updateRlmMemberData:function(a){var b=this,c=this.getGroupDataByIndex($(a).attr("groupindex")),d=c.memberListData;_.each(d,function(a){a.state=b.getEmployeeChatState(a.id)}),d=_.sortBy(d,function(a){return a.lastChatDate}),d.reverse(),c.memberListData=d},addRlmMemberData:function(a){a=[].concat(a);var b=this.groupListData,c=b[1],d=c.memberListData,e=[];_.each(a,function(a){_.some(d,function(b){return b.id==a.id?(b.lastChatDate=a.lastChatDate,!0):void 0})||e.push(a)}),d=d.concat(e),d=_.sortBy(d,function(a){return a.lastChatDate}),d.reverse(),c.memberListData=d},reRenderRlmGroup:function(){var a=this.element,b=$(".rlm-group",a),c=$(".fs-qx-member-list",b),d=$(".total-num",b),e=this.getGroupDataByIndex(b.attr("groupindex"));d.text(e.memberListData.length>20?20:e.memberListData.length),c.is(":visible")&&this._renderMemberList_rlm(b,e)},addOnlineMemberData:function(a){a=[].concat(a);var b=this.groupListData,c=b[2],d=c.memberListData,e=[];_.each(a,function(a){_.some(d,function(b){return b.id==a.id?(_.extend(b,a),!0):void 0})||e.push(a)}),d=d.concat(e),d=_.sortBy(d,function(a){return a.spell}),c.memberListData=d},removeOnlineMemberData:function(a){var b=this.groupListData,c=b[2],d=c.memberListData;d=_.filter(d,function(b){return b.id!=a}),d=_.sortBy(d,function(a){return a.spell}),c.memberListData=d},removeAllOnlineMemberData:function(){var a=this.groupListData,b=a[2];b.memberListData=[]},reRenderOnlineGroup:function(){var a=this.element,b=$(".online-group",a),c=$(".fs-qx-member-list",b),d=$(".total-num",b),e=this.getGroupDataByIndex(b.attr("groupindex"));d.text(e.memberListData.length),c.is(":visible")&&this._renderMemberList_online(b,e)},isExistDiscussion:function(a){var b=this.groupListData,c=b[0],d=c.memberListData;return _.some(d,function(b){return b.sessionID==a})},addDiscussionMemberData:function(a){a=[].concat(a);var b=this.groupListData,c=b[0],d=c.memberListData,e=[];_.each(a,function(a){_.some(d,function(b,c){return b.sessionID==a.sessionID?(d[c]=_.extend(b,a),a.participantIds&&(d[c].participantsIDs=a.participantIds||[]),!0):void 0})||(a.participantIds&&(a.participantsIDs=a.participantIds),e.push(a))}),d=d.concat(e),d=_.sortBy(d,function(a){return a.lastCreateTime}),d.reverse(),c.memberListData=d},removeDiscussionMemberData:function(a){var b=this.groupListData,c=b[0],d=c.memberListData;d=_.filter(d,function(b){return b.sessionID!=a}),c.memberListData=d},reRenderDiscussionGroup:function(){var a=this.element,b=$(".discussion-group",a),c=$(".fs-qx-member-list",b),d=$(".total-num",b),e=this.getGroupDataByIndex(b.attr("groupindex"));d.text(e.memberListData.length),c.is(":visible")&&this._renderMemberList_discussion(b,e)},_onRenderQxStatus:function(a){var b,c=this,d=this.element,e=$(".fs-qx-hidden .fs-qx-summary",d),f=$(".fs-qx-group-item",d),g=a.statusData,h=g.onlineEmployeeIDs;g.mobileOnlineEmployeeIDs,$(".online-num",e).text(h.length-1),f.not(".discussion-group").each(function(){var a=$(this),d=$(".online-num",a),e=c.getGroupDataByIndex(a.attr("groupindex")).memberListData,f=0;_.each(e,function(a){_.contains(h,a.id)&&f++}),d.text(f),a.hasClass("circle-group")||a.hasClass("no-circle-group")?c.updateCircleMemberData(a):a.hasClass("rlm-group")?c.updateRlmMemberData(a):a.hasClass("online-group")&&(c.removeAllOnlineMemberData(),b=_.map(h,function(a){return _.extend({state:c.getEmployeeChatState(a)},j.getContactDataById(a,"p"))}),b=_.reject(b,function(a){return a.id==D.id}),c.addOnlineMemberData(b),c.reRenderOnlineGroup()),a.hasClass("state-open")&&c._renderMemberList(a)})},updateQxScrollBar:function(){this.qxListScrollBar&&this.qxListScrollBar.update("relative")},destroy:function(){var a;return this.groupListData=null,this.employeeQuery&&this.employeeQuery.destroy(),this.chatPanel&&this.chatPanel.destroy(),this.qxListScrollBar&&this.qxListScrollBar.destroy(),a=U.superclass.destroy.apply(this,arguments)}});c.exports=new U});