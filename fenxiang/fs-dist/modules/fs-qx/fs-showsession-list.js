/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-qx/fs-showsession-list",["util","uilibs/pagination","moment","./fs-showsession-list.html","./fs-showsession-list.css","modules/feed-list/feed-list-helper","modules/fs-attach/fs-attach-preview","modules/fs-attach/fs-attach-file-preview","json","modules/fs-map/fs-map","uilibs/audio-player"],function(a,b,c){var d=window,e=d.FS;e.tpl;var f=a("util"),g=a("uilibs/pagination"),h=a("moment"),i=a("./fs-showsession-list.html");a("./fs-showsession-list.css");var j=a("modules/feed-list/feed-list-helper"),k=a("modules/fs-attach/fs-attach-preview"),l=a("modules/fs-attach/fs-attach-file-preview"),m=a("json"),n=a("modules/fs-map/fs-map");j.picturesFormat,j.filesFormat;var o=(new k).render(),p=l.FileReader,q=new p,r=a("uilibs/audio-player"),s=n.FsMapOverlay,t=new s,u=f.getContactData(),v=u.u,i=$(i),w=Backbone.Model.extend({}),x=Backbone.Collection.extend({model:w,sync:function(a,b,c){var d=c.data||{};c.data=_.extend({pageSize:10,pageNumber:1},d),Backbone.sync("read",b,c)},parse:function(a){var b=a.value.shortMessages,c=a.value.sessions;return a.success?_.each(b,function(b){b.originData=f.deepClone(b);var d=b.sessionID,g=b.messageLocation,i=b.employee,j=i.name,k=i.employeeID,l=i.profileImage,n="",o=b.messageShowContent,p=b.messageType,q="",r=b.createTime,s=b.attach||[];b.attach="";var t=new RegExp("(http[s]{0,1}|ftp)://[a-zA-Z0-9\\.\\-]+\\.([a-zA-Z]{2,4})(:\\d+)?(/[a-zA-Z0-9\\.\\-~!@#$%^&amp;*+?:_/=<>]*)?","gi");j='<a href="#profile/=/empid-'+k+'">'+j+"</a>",l=f.getAvatarLink(l,2),l='<a href="#profile/=/empid-'+k+'"><img src="'+l+'" alt="" class="profileImage-mid"></a>',v.employeeID==k&&(n=l,l="",j='<a href="#profile/=/empid-'+k+'">我</a>',q="ismysession"),7==p?q=v.employeeID==k?"myoperatesession":"operatesession":o="说："+o,o=o.replace(t,function(a){return'<a href="'+a+'" target="_blank">'+a+"</a>"}),r=f.getDateSummaryDesc(h.unix(r),h.unix(a.serviceTime),1),s&&_.each(s,function(a){var c=a.attachID,d=a.attachType,g=a.attachName,h=a.attachPath,i=a.attachSize,j=a.fileIcon,k=a.canPreview,l='<a href="#" class="attach-preview-l v">预览</a>';switch(k||(l=""),d){case 1:h=f.getDfLink(h,"",!1,""),i=i>60&&3600>i?parseInt(i/60)+":"+parseInt(60*(parseFloat(i/60)-parseInt(i/60))):"00:"+parseInt(i),b.attach='<div class="audio-btn">('+i+')</div><div class="audio-warp"> <div class="audio-close"><img src="../../html/fs/assets/images/audio_colse_ico.gif" alt="">收起</div> <div class="audio-box" audiosrc="'+h+'" attachsize="'+a.attachSize+'"></div></div>';break;case 2:b.attach='<div class="item-media"> <div class="feed-img"><div class="img-warp"><table><tbody><tr><td valign="middle" align="center" class=""><img src="'+f.getDfLink(h+"3",g,!1,"jpg")+'" alt="" class="feed-img-thumb" /></td></tr></tbody></table></div></div></div>';break;case 3:i=f.getFileSize(a.attachSize),b.attach='<div class="item-media"> <div class="feed-files feed-attach fn-clear"> <dl attachid="'+c+'"><dt><img src="'+e.ASSETS_PATH+"/images/file/"+j+'.png" alt=""></dt><dd><p>'+g+"("+i+')</p><p><a href="'+f.getDfLink(h,g,!0,"")+'" class="d" title="" target="_blank">下载</a>'+l+"</p></dd></dl> </div></div>"}}),c&&c.length>0&&(b.session=_.find(c,function(a){return a.value==d}));var u,w="",x="",y="",z="",A="",B="",C="",D="",E="";b.feedLocationStr="",6==p&&(u=g.isTokenChenged,y=g.country,z=g.province,A=g.city,B=g.district,C=g.street,D=g.streetNumber,x=y+z+A+B+C+D,u&&(E='<img src="../../html/fs/assets/images/location_istokenchenged.png" class="istokenchenged-ico" title="该用户本次签到所用设备与上次不同"> '),w='<div class="feed-location"><img src="../../html/fs/assets/images/feedlocation_ico.gif" alt=""/ class="feed-location-ico"><span class="feed-location-text">'+x+'</span><span class="feed-location-fn"><a locationdata="'+encodeURIComponent(m.stringify(g))+'" href="#" class="feed-location-fn-map">显示地图</a> |</span>'+E+"</div>",b.feedLocationStr=w),_.extend(b,{sessionID:d,messageContent:o,sessiontype:q,name:j,employeeID:k,profileImage:l,myProfileImage:n,createTime:r})}):b=[],b}}),y=Backbone.View.extend({tagName:"div",className:"fs-showsession-item fn-clear",events:{"click .audio-btn":"audioBtn","click .audio-close":"audioCloseBtn","click .feed-img-thumb":"previewImg","click .attach-preview-l":"previewAttach","click .feed-location-fn-map":"showLocation"},audioCloseBtn:function(a){var b=$(a.currentTarget),c=b.closest(".session-attachs"),d=$(".audio-btn",c),e=$(".audio-warp",c);e.hide(),d.show()},audioBtn:function(a){var b=$(a.currentTarget),c=b.closest(".session-attachs"),d=this.$el,e=$(".audio-warp",c),f=$(".audio-box",d),g=f.attr("audiosrc"),h=parseInt(f.attr("attachsize"));b.hide(),e.show(),this.audioPlayer||(this.audioPlayer=new r({element:$(".audio-box",e),audioSrc:g,length:h})),this.audioPlayer.play()},previewImg:function(){var a=this.model,b=a.get("originData"),c=b.attach,d=[];_.each(c,function(a,b){d[b]={previewPath:a.attachPath+"2",originPath:a.attachPath+"1",thumbPath:a.attachPath+"3",createTime:a.createTime,fileName:a.attachName,fileSize:a.attachSize}}),o.preview({type:"img",data:d,refId:b.shortMessageID,belongToType:"qx"})},previewAttach:function(a){var b,c=this.model,d=c.get("originData"),e=d.attach,f=$(a.currentTarget),g=f.closest("dl"),h=g.attr("attachid");b=_.find(e,function(a){return a.attachID==h}),q.readFile({fileId:b.attachID,fileName:b.attachName,filePath:b.attachPath}),a.preventDefault()},showLocation:function(a){var b=$(a.currentTarget),c=m.parse(decodeURIComponent(b.attr("locationdata")));t.fixLocation(c),a.preventDefault()},initialize:function(){var a=i.filter(".fs-showsession-item-tpl").html();this.template=_.template(a),this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},destroy:function(){this.audioPlayer&&this.audioPlayer.destroy(),this.remove()}}),z=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:20,visiblePageNums:7},listPath:"/attach_html/getAttachImgFilesOfIReceive",defaultRequestData:{},searchOpts:{inputSelector:null,btnSelector:null},itemRenderCb:e.EMPTY_FN,listCb:e.EMPTY_FN,listEmptyText:"当前会话内没有对话"},a||{}),this.opts=a,this.element=$(a.element),this.pagEl=$(a.pagSelector),this.pagination=null,this.tempRequestData={},this.init()};_.extend(z.prototype,{init:function(){this._initListEmptyTip();var a,b=this,c=this.opts,d=this.element;a=new x,a.on("add",function(a){var e;e=new y({model:a}).render(),e.$el.data("itemV",e).appendTo(d),c.itemRenderCb.call(b,e,a)}),this.list=a,this.pagination=new g(_.extend({element:this.pagEl},c.pagOpts)),this.pagination.on("page",function(){b.empty(),b.fetch()}),this.pagination.render(),c.searchOpts&&c.searchOpts.inputSelector},_searchBarInit:function(){var a,b=this,c=this.opts,d=c.searchOpts,e=this.element,f=$(d.inputSelector),g=$(d.btnSelector);a=$('<div class="list-search-bar fn-clear"></div>'),a.html('<span class="result-info fn-left">共搜索到<span class="num color-red">0</span>条信息</span><a class="back-l fn-right" href="#" title="返回查看全部"><< 返回查看全部</a>'),a.hide().prependTo(e);var h=$('<span class="empty-h">&#10005;</span>'),i=$('<span class="list-search-input-wrapper"></span>');f.wrap(i),i=f.closest(".list-search-input-wrapper"),h.hide().appendTo(i),f.keydown(function(a){13==a.keyCode&&g.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(h.show(),f.addClass("with-input-value")):(h.hide(),f.removeClass("with-input-value"))}),h.click(function(){f.val(""),f.removeClass("with-input-value"),h.hide()}),a.on("click",".back-l",function(a){var c=$(".list-empty-tip",e);b.reload({keyword:""}),f.val(""),f.removeClass("with-input-value"),h.hide(),c.hide(),a.preventDefault()})},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".num",d);return!a.isFirstChar&&a.keyword.length>0&&b.success?(e.text(b.value.totalCount),d.show(),void 0):(d.hide(),void 0)},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+e.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.insertAfter(a)},_updatelistStatus:function(a){var b,c=this.element,d=$(".list-empty-tip",c.closest(".depw-content-list"));a.success&&(b=a.value.totalCount,0==b?d.show():d.hide())},_hideEmptyTip:function(){var a=this.element,b=$(".list-empty-tip",a.closest(".depw-content-list"));b.hide()},fetch:function(){var a=this,b=this.opts;this.list;var c=this.pagination,d=_.extend({pageSize:c.get("pageSize"),pageNumber:c.get("activePageNumber")});d=_.isFunction(b.defaultRequestData)?_.extend(b.defaultRequestData(),d):_.extend(b.defaultRequestData,d),d=_.extend(d,this.tempRequestData),this.tempRequestData={},this.showLoading(),this.list.fetch({url:b.listPath,data:d,success:function(d,e){var f;e.success&&(f=e.value,c.setTotalSize(f.totalCount),a._updatelistStatus(e),b.listCb.call(a,e),a.hideLoading())}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a){this.tempRequestData=a,this.pagination.jump(1)},reload:function(a){this.load(a)},emptyToService:function(a){var b=this;this.element,f.api({url:"/ShortMessage/ClearDiscussionShortMessages",type:"post",dataType:"json",data:{sessionID:a},success:function(a){a.success&&(b.empty(),b._updatelistStatus({success:!0,value:{totalCount:0}}),b.pagination.reset())}})},empty:function(){var a=this.element,b=$(".fs-showsession-item",a);b.each(function(){var a=$(this),b=a.data("itemV");b.remove(),a.removeData()}),a.empty()},destroy:function(){this.list=null,this.pagination.destroy(),this.loading&&this.loading.stop(),this.empty(),this.pagination=null,this.tempRequestData={},this.element=null}}),c.exports=z});