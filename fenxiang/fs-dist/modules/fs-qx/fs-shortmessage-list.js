/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-qx/fs-shortmessage-list",["util","modules/feed-list/fl-util","uilibs/pagination","moment","./fs-shortmessage-list.html","./fs-shortmessage-list.css","modules/feed-list/feed-list-helper","modules/fs-attach/fs-attach-preview","modules/fs-attach/fs-attach-file-preview","modules/fs-qx/fs-qx","uilibs/audio-player"],function(a,b,c){var d=window,e=d.FS;e.tpl;var f=a("util");a("modules/feed-list/fl-util");var g=a("uilibs/pagination"),h=a("moment"),i=a("./fs-shortmessage-list.html");a("./fs-shortmessage-list.css");var j=a("modules/feed-list/feed-list-helper"),k=a("modules/fs-attach/fs-attach-preview"),l=a("modules/fs-attach/fs-attach-file-preview"),m=a("modules/fs-qx/fs-qx.js");j.picturesFormat,j.filesFormat;var n=(new k).render(),o=l.FileReader,p=new o,q=a("uilibs/audio-player"),r=f.getContactData();r.u;var i=$(i),s=Backbone.Model.extend({}),t=Backbone.Collection.extend({model:s,sync:function(a,b,c){var d=c.data||{};c.data=_.extend({pageSize:10,pageNumber:1},d),Backbone.sync("read",b,c)},parse:function(a){var b=a.value.session;if(a.success){var c="";_.each(b,function(b){b.originData=f.deepClone(b);var d=b.sessionID,g=b.lastEmployee,i=b.isDiscussion,j=b.name,k=g.name,l=g.employeeID,m=b.profileImage,n=b.messageCount,o=b.lastMessageShowContent||"",p=b.lastCreateTime,q=b.lstShortMessageAttach||[],r="",s=b.inSession,t=new RegExp("(http[s]{0,1}|ftp)://[a-zA-Z0-9\\.\\-]+\\.([a-zA-Z]{2,4})(:\\d+)?(/[a-zA-Z0-9\\.\\-~!@#$%^&amp;*+?:_/=<>]*)?","gi");b.attach="",c=s?"":"disable",i||(r="我与",m=g.profileImage),m=f.getAvatarLink(m,2),o=o.replace(t,function(a){return'<a href="'+a+'" target="_blank">'+a+"</a>"}),j='<a href="#shortmessage/showsession/=/id-'+d+"/empid-"+l+'" title="'+j+'">'+r+j+"</a>",n='<a href="#shortmessage/showsession/=/id-'+d+"/empid-"+l+'">查看共'+n+"条企信</a>",p=f.getDateSummaryDesc(h.unix(p),h.unix(a.serviceTime),1),q&&_.each(q,function(a){var c=a.attachID,d=a.attachType,g=a.attachName,h=a.attachPath,i=a.attachSize,j=a.fileIcon;switch(d){case 1:h=f.getDfLink(h,"",!1,""),h=f.getFileNamePath(h)+".mp3",i=i>60&&3600>i?parseInt(i/60)+":"+parseInt(60*(parseFloat(i/60)-parseInt(i/60))):"00:"+parseInt(i),b.attach='<div class="audio-btn">('+i+')</div><div class="audio-warp"> <div class="audio-close"><img src="../../html/fs/assets/images/audio_colse_ico.gif" alt="">收起</div> <div class="audio-box" audiosrc="'+h+'" attachsize="'+a.attachSize+'"></div></div>';break;case 2:b.attach='<div class="item-media"> <div class="feed-img"><div class="img-warp"><table><tbody><tr><td valign="middle" align="center"><img src="'+f.getDfLink(h+"3",g,!1,"jpg")+'" alt="" class="feed-img-thumb" /></td></tr></tbody></table></div></div></div>';break;case 3:i=f.getFileSize(a.attachSize),b.attach='<div class="item-media"> <div class="feed-files feed-attach fn-clear"> <dl attachid="'+c+'"><dt><img src="'+e.ASSETS_PATH+"/images/file/"+j+'.png" alt=""></dt><dd><p>'+g+"("+i+')</p><p><a href="'+f.getDfLink(h,g,!0)+'" class="d" title="" target="_blank">下载</a> <a href="#" class="attach-preview-l v">预览</a></p></dd></dl> </div></div>'}}),b.newico=b.hasUnread?'<div class="img-new"></div>':"",_.extend(b,{sessionID:d,fromName:j,lastMessageShowContent:o,name:k,employeeID:l,profileImage:m,lastCreateTime:p,disable:c,messageCount:n})})}else b=[];return b}}),u=Backbone.View.extend({tagName:"div",className:"fs-shortmessage-item",events:{"click .audio-btn":"audioBtn","click .audio-close":"audioCloseBtn","click .feed-img-thumb":"previewImg","click .attach-preview-l":"previewAttach","click .shortcut-reply-l":"clickScReply","click .shortcut-del-btn":"shortcutDel"},shortcutDel:function(){var a=this,b=a.options;this.$el;var c=this.model,d=c.get("originData"),e=d.sessionID;f.confirm("你确定要从企信列表删除该对话吗？","提示",function(){f.api({url:"/ShortMessage/RemoveSessionFromList",type:"post",dataType:"json",data:{sessionID:e},success:function(c){c.success&&(a.remove(),b.removeItemCb&&b.removeItemCb.call(a,c))}})},{onCancel:function(){},width:338})},audioCloseBtn:function(){var a=this.$el,b=$(".audio-btn",a),c=$(".audio-warp",a);c.hide(),b.show(),this.audioPlayer&&this.audioPlayer.stop()},audioBtn:function(a){var b=$(a.currentTarget),c=this.$el,d=$(".audio-warp",c),e=$(".audio-box",c),f=e.attr("audiosrc"),g=parseInt(e.attr("attachsize"));b.hide(),d.show(),this.audioPlayer||(this.audioPlayer=new q({element:$(".audio-box",d),audioSrc:f,length:g})),this.audioPlayer.play()},previewImg:function(){var a=this.model,b=a.get("originData"),c=b.lstShortMessageAttach,d=[];_.each(c,function(a,b){d[b]={previewPath:a.attachPath+"2",originPath:a.attachPath+"1",thumbPath:a.attachPath+"3",createTime:a.createTime,fileName:a.attachName,fileSize:a.attachSize}}),n.preview({type:"img",data:d,refId:b.shortMessageID,belongToType:"qx"})},previewAttach:function(a){var b,c=this.model,d=c.get("originData"),e=d.lstShortMessageAttach,f=$(a.currentTarget),g=f.closest("dl"),h=g.attr("attachid");b=_.find(e,function(a){return a.attachID==h}),p.readFile({fileId:b.attachID,fileName:b.attachName,filePath:b.attachPath}),a.preventDefault()},clickScReply:function(a){var b,c=this.model,d=c.get("originData"),e=c.get("sessionID"),g=d.isDiscussion,h=m.chatPanel,i=$(a.currentTarget),j=d.participantsIDs.split(","),k={name:d.name,profileImage:d.profileImagePath,participantIds:j};if(!i.is(".disable")){if(a.preventDefault(),a.stopPropagation(),g&&!m.isExistDiscussion(e))return;b=g?"":m.getEmployeeChatState(d.lastEmployee.employeeID),h.addOrUpdateSession({employeeIds:d.participantsIDs.split(","),sessionId:e,sessionType:g?"discussion":"pair",data:k},!0,{profileImage:f.getAvatarLink(d.profileImage,3),chatStateCls:b,title:d.name,name:d.name})}},initialize:function(){var a=i.filter(".fs-shortmessage-send-item-tpl").html();this.template=_.template(a),this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},destroy:function(){this.audioPlayer&&this.audioPlayer.destroy(),this.remove()}}),v=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:20,visiblePageNums:7},listPath:"/attach_html/getAttachImgFilesOfIReceive",defaultRequestData:{},searchOpts:{inputSelector:null,btnSelector:null},listCb:e.EMPTY_FN,listEmptyText:"暂无记录"},a||{}),this.opts=a,this.element=$(a.element),this.pagEl=$(a.pagSelector),this.pagination=null,this.tempRequestData={},this.init()};_.extend(v.prototype,{init:function(){var a,b=this,c=this.opts,d=this.element,e=m.chatPanel;a=new t,a.on("add",function(a){var c;c=new u({model:a,removeItemCb:function(a){a.success&&(e.shortCutDelDiscussion(a.value.sessionID),b.reload())}}).render(),c.$el.data("itemV",c).appendTo(d)}),this.list=a,this.pagination=new g(_.extend({element:this.pagEl},c.pagOpts)),this.pagination.on("page",function(){b.empty(),b.fetch()}),this.pagination.render(),c.searchOpts&&c.searchOpts.inputSelector,this._initListEmptyTip()},_searchBarInit:function(){var a,b=this,c=this.opts,d=c.searchOpts,e=this.element,f=$(d.inputSelector),g=$(d.btnSelector);a=$('<div class="list-search-bar fn-clear"></div>'),a.html('<span class="result-info fn-left">共搜索到<span class="num color-red">0</span>条信息</span><a class="back-l fn-right" href="#" title="返回查看全部"><< 返回查看全部</a>'),a.hide().prependTo(e);var h=$('<span class="empty-h">&#10005;</span>'),i=$('<span class="list-search-input-wrapper"></span>');f.wrap(i),i=f.closest(".list-search-input-wrapper"),h.hide().appendTo(i),f.keydown(function(a){13==a.keyCode&&g.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(h.show(),f.addClass("with-input-value")):(h.hide(),f.removeClass("with-input-value"))}),h.click(function(){f.val(""),f.removeClass("with-input-value"),h.hide()}),a.on("click",".back-l",function(a){var c=$(".list-empty-tip",e);b.reload({keyword:""}),f.val(""),f.removeClass("with-input-value"),h.hide(),c.hide(),a.preventDefault()})},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".num",d);return!a.isFirstChar&&a.keyword.length>0&&b.success?(e.text(b.value.totalCount),d.show(),void 0):(d.hide(),void 0)},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+e.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.appendTo(a)},_updatelistStatus:function(a){var b,c=this.element,d=$(".list-empty-tip",c);a.success&&(b=a.value.totalCount,0==b?d.show():d.hide())},fetch:function(){var a=this,b=this.opts;this.list;var c=this.pagination,d=_.extend({pageSize:c.get("pageSize"),pageNumber:c.get("activePageNumber")});d=_.isFunction(b.defaultRequestData)?_.extend(b.defaultRequestData(),d):_.extend(b.defaultRequestData,d),d=_.extend(d,this.tempRequestData),this.tempRequestData={},this.showLoading(),this.list.fetch({url:b.listPath,data:d,success:function(d,e){var f;e.success&&(f=e.value,c.setTotalSize(f.totalCount),a._updatelistStatus(e),b.listCb.call(a,e),a.hideLoading())}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a){this.tempRequestData=a,this.pagination.jump(1)},reload:function(a){this.load(a)},empty:function(){var a=this.element,b=$(".fs-shortmessagelist-item",a);b.each(function(){var a=$(this),b=a.data("itemV");b.destroy(),a.removeData()}),a.empty()},destroy:function(){this.list=null,this.pagination.destroy(),this.loading&&this.loading.stop(),this.empty(),this.pagination=null,this.tempRequestData={},this.element=null}}),c.exports=v});