/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-preview/fs-preview",["preview","moment","util","./fs-preview.css","./fs-preview.html"],function(a,b,c){var d=a("preview"),e=a("moment"),f=a("util"),g=(a("./fs-preview.css"),$(a("./fs-preview.html"))),h="/feed/GetFeedByFeedID",i="/feed/GetFeedReplysByFeedID",j=FS.BASE_PATH+"/sl/DF/Get",k=d.extend({attrs:{belongToFeed:!0,dataId:""},events:{"click .reply-input":"showSubmit","blur .reply-input":"hideSubmit"},setup:function(){return k.superclass.setup.apply(this,arguments)},showSubmit:function(a){var b=$(a.currentTarget),c=b.closest(".reply-form");c.addClass("inputting")},hideSubmit:function(a){var b=$(a.currentTarget),c=b.closest(".reply-form");c.removeClass("inputting")},preview:function(a,b,c){c=c||FS.UNDEFINED,this.render(),this.set("type",a),this.get("feedId")==b?this._setActiveIndexByAttachId(c):(this.set("feedId",b),this.set("attachId",c)),this.show()},_renderPanel:function(a){var b=this.get("type"),c=[];"img"==b&&a.pictures?_.each(a.pictures,function(a){c.push({previewPath:j+"/"+a.attachPath+"2."+a.fileIcon,originPath:j+"/"+a.attachPath+"1."+a.fileIcon,thumbPath:j+"/"+a.attachPath+"3."+a.fileIcon,attachId:a.attachID})}):"attach"==b&&a.files&&_.each(a.files,function(a){c.push({previewPath:j+"/"+a.attachPath+"2."+a.fileIcon,originPath:j+"/"+a.attachPath+"1."+a.fileIcon,thumbPath:j+"/"+a.attachPath+"3."+a.fileIcon,fileSize:a.attachSize,fileName:a.attachName,attachId:a.attachID})}),this.set("data",c),this._setActiveIndexByAttachId(),this._renderItemInfo(a)},_setActiveIndexByAttachId:function(a){a=a||this.get("attachId");var b=0,c=this.get("data");0!==a&&_.find(c,function(c,d){return c.attachId==a?(b=d,!0):void 0}),this.set("activeIndex",b)},_formatFeedData:function(a){var b={};return _.extend(b,{avaterPath:j+"/"+a.sender.profileImage+"3.jpg",userName:a.sender.name,createTime:e(a.createTime).startOf("hour").fromNow(),replyCounts:0,feedRangeTip:a.feedRangeTip,feedContent:createFeedContent(a)}),b},_formatReplyData:function(a){var b={};return _.extend(b,{avaterPath:j+"/"+a.sender.profileImage+"3.jpg",userName:a.sender.name,createTime:e(a.createTime).startOf("hour").fromNow(),replyContent:createReplyContent(a)}),b},_renderReplyPanel:function(a){var b,c=this,d=this.get("feedId"),e=this.element,g=$(".ui-preview-info",e),h=$(".fs-preview-reply-list",g),j=$(".reply-counts",g);f.api({url:i,type:"get",data:{feedid:d,pagesize:1e3,pageNumber:1},apiCb:function(d){var e=[];d.success&&(_.each(d.value.items,function(a,b){e[b]=c._formatReplyData(a)}),b=_.template(a),h.html(b({replyItems:e})),j.text(e.length))}})},_renderItemInfo:function(b){var c,d,e,h,i=this.element,j=$(".ui-preview-info",i),k=g.clone(),l=this._formatFeedData(b);$(".fs-preview-reply-list",k).empty(),d=k.html(),e=$(".fs-preview-reply-list",g.clone()).html(),h=_.template(d),j.addClass("fs-preview-info").html(h(l)),c=$("textarea",j),f.placeholder(c),a.async(["jslibs/jquery.autosize.js"],function(){c.autosize()}),this._renderReplyPanel(e)},_onRenderFeedId:function(a){var b=this;a.length>0&&f.api({url:h,type:"get",data:{feedID:a},apiCb:function(a){var c;a.success&&(c=a.value.items[0],b._renderPanel(c))}})}});c.exports=k});