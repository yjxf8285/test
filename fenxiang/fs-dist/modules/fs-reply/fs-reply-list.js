/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-reply/fs-reply-list",["modules/feed-list/feed-list-helper","modules/feed-list/fl-util","modules/feed-list/feed-list.css","modules/fs-reply/fs-reply.html","uilibs/pagination","modules/fs-attach/fs-attach-preview","modules/fs-attach/fs-attach-file-preview","spin","moment","util","uilibs/audio-player","modules/fs-reply/fs-reply"],function(a,b,c){function d(a){var b={};return b=_.extend(b,D.common(a)),b.originData=a,b}var e,f,g,h,i=window,j=i.FS,k=a("modules/feed-list/feed-list-helper"),l=a("modules/feed-list/fl-util"),m=(a("modules/feed-list/feed-list.css"),a("modules/fs-reply/fs-reply.html")),n=a("uilibs/pagination"),o=a("modules/fs-attach/fs-attach-preview"),p=a("modules/fs-attach/fs-attach-file-preview"),q=(a("spin"),a("moment")),r=a("util"),s=$(m).filter(".myreply-list-item").html(),t=k.feedContentFormat,u=k.picturesFormat,v=k.filesFormat,w=k.feedContentFormat_,x=(new o).render(),y=p.FileReader,z=new y,A=a("uilibs/audio-player"),B=r.getContactData(),C=B.u;h=Backbone.Model.extend({defaults:{}});var D={common:function(a){var b={};b.replyContent=a.replyContent||"",b.feedID=a.feedID||"",b.senderId=a.sender&&a.sender.employeeID||"",b.feedsenderId=a.feedSender&&a.feedSender.employeeID||"",b.profileImage=a.sender&&a.sender.profileImage||"",b.sendername=a.sender&&a.sender.name||"";var c=a.replyToReplyID;C.id==b.senderId&&(b.sendername="我"),b.feedSenderName=a.feedSender&&a.feedSender.name||"",b.feedSenderName='<a href="#profile/=/empid-'+b.feedsenderId+'">'+b.feedSenderName+"</a>",c>0?b.feedSenderName='<a href="#profile/=/empid-'+a.replyToEmployee.employeeID+'">'+a.replyToEmployee.name+"</a>":b.feedSenderName.length>0&&C.id==b.feedsenderId&&(b.feedSenderName="我"),b.feedText=a.feedText||"",b.feedPic=a.feedPic||"",b.feedFiles=a.feedFiles||"",b.feedTypeDescription=a.feedTypeDescription||"",b.createTime=a.createTime||"",b.sourceDescription=a.sourceDescription||"",b.feedContent=a.feedContent,b.replyToContent=a.replyToContent,b.profileImage=r.getAvatarLink(b.profileImage,2),_.extend(b,u(a.pictures||[])),_.extend(b,v(a.files||[]));var d,e,f=a.audio;f?(e=f.attachPath,e=r.getFileNamePath(e)+".mp3",e=r.getDfLink(e,"",!1,""),d=f.attachSize,d=d>60&&3600>d?parseInt(d/60)+":"+parseInt(60*(parseFloat(d/60)-parseInt(d/60))):"00:"+parseInt(d),b.audioBtn='<div class="reply-audio-open-btn audio-btn">('+d+")</div>",b.attachPath=e,b.audioWarp=' <div class="audio-warp"> <div class="reply-audio-close-btn audio-close"><img src="../../html/fs/assets/images/audio_colse_ico.gif" alt="">收起</div> <div><div class="audio-box"></div></div>'):(b.audioBtn="",b.attachPath="",b.audioWarp="");var g=r.getDateSummaryDesc(q.unix(b.createTime),q.unix(a.serviceTime),1);b.createTime=g,b.operationType="";var h="";switch(b.isagreeImg="",a.feedType){case 1:b.operationType="";break;case 2:r.getPlanOperationType(a.operationType)&&(b.operationType="，"+r.getPlanOperationType(a.operationType));break;case 3:r.getWorkOperationTypeName(a.operationType)&&(b.operationType="，"+r.getWorkOperationTypeName(a.operationType));break;case 4:r.getApproveOperationTypeName(a.operationType)&&(b.operationType="，"+r.getApproveOperationTypeName(a.operationType)),h=1==a.operationType?'<img src="../../html/fs/assets/images/agree.gif" alt="" class="approve-isagree">':2==a.operationType?'<img src="../../html/fs/assets/images/unagree.gif" alt="" class="approve-isagree">':"",b.isagreeImg=h;break;default:b.operationType=""}b.source=b.sourceDescription?1==a.source?"":"，来自"+r.getSourceNameFromCode(a.source):"";var i="";_.each(a.replyContent,function(a){i+=t(a)}),b.feedText=i;var j='<div class="img-new"></div>';return b.newico=a.isUnRead?j:"",b.feedFormatContent=w(300,a),a.replyToReplyID>0?(b.feedContent=b.replyToContent,b.feedTypeDescription="回复"):b.feedTypeDescription=r.getFeedTypeName(a.feedType),b}};f=Backbone.Collection.extend({sync:function(a,b,c){var d=c.data||{};c.data=_.extend({circleID:0,subType:0,feedType:0,keyword:"",pageSize:30,pageNumber:2},d),Backbone.sync("read",b,_.extend(c,{apiCb:function(){}}))},parse:function(a){var b=a.value.items,c=a.value,e=[];return _.each(b,function(b,f){b.serviceTime=a.serviceTime,_.isUndefined(b.feedType)&&(b.feedType=c.feedType),_.isUndefined(b.feedSender)&&(b.feedSender=c.feedSender),_.isUndefined(b.feedExtendData)&&(b.feedExtendData=c.feedExtendData),e[f]=d(b)}),e}}),g=Backbone.View.extend({tagName:"div",className:"reply-item fs-list-item",template:_.template(s),events:{"click .aj-Reply":"reply","click .feed-reply-content-visible-h":"frcVisibleH","click .item-media .feed-img":"_previewImg","click .item-media .feed-attach .attach-preview-l":"_previewAttach","click .item-media .feed-attach .attach-play-l":"_playAttach","click .reply-audio-open-btn":"_openAudio","click .reply-audio-close-btn":"_closeAudio"},frcVisibleH:function(a){var b=this.model,c=b.get("feedFormatContent"),d=c.leftHtml,e=this.$el,f=$(".feed-summary-text",e),g=$(".feed-left-text",e),h=$(".feed-reply-content-visible-h",e),i=$(".feed-content-ellipsis",e);0==g.length?(g=$('<span class="feed-left-text">'+d+"</span>"),g.insertAfter(f),h.text("收起正文"),i.hide()):g.is(":visible")?(g.hide(),h.text("展开正文，（共"+c.feedWordNum+"个字）"),i.show()):(g.show(),h.text("收起正文"),i.hide()),a.preventDefault()},_openAudio:function(a){var b=$(a.currentTarget),c=this.$el,d=$(".audio-warp",c),e=this.model,f=e.get("attachPath"),g=e.get("originData");b.hide(),d.show(),this.audioPlayer||(this.audioPlayer=new A({element:$(".audio-box",d),audioSrc:f,length:g.audio.attachSize}),this.compStore.push(this.audioPlayer)),this.audioPlayer.play()},_closeAudio:function(){var a=this.$el,b=$(".audio-btn",a),c=$(".audio-warp",a);c.hide(),b.show(),this.audioPlayer&&this.audioPlayer.stop()},_previewImg:function(a){var b=this.model,c=b.get("originData"),d=c.pictures,e=[];_.each(d,function(a,b){e[b]={previewPath:a.attachPath+"2",originPath:a.attachPath+"1",thumbPath:a.attachPath+"3",createTime:a.createTime,fileName:a.attachName,fileSize:a.attachSize}}),x.preview({type:"img",data:e,refId:c.feedID,belongToType:"reply"}),a.preventDefault(),a.stopPropagation()},_previewAttach:function(a){var b,c=this.model,d=c.get("originData"),e=d.files,f=$(a.currentTarget),g=f.closest("dl"),h=g.attr("attachid");b=_.find(e,function(a){return a.attachID==h}),z.readFile({fileId:b.attachID,fileName:b.attachName,filePath:b.attachPath}),a.preventDefault(),a.stopPropagation()},_playAttach:function(a){var b,c=this.model,d=c.get("originData"),e=d.files,f=$(a.currentTarget),g=f.closest("dl"),h=g.attr("attachid");b=_.find(e,function(a){return a.attachID==h}),x.preview({type:"audio",data:[{previewPath:j.BLANK_IMG,originPath:b.attachPath,thumbPath:j.BLANK_IMG,createTime:b.createTime,fileName:b.attachName,fileSize:b.attachSize,fileId:b.attachID,employeeName:d.sender.name}],refId:d.feedReplyID,belongToType:r.getAttachSourceName(b.source)}),a.preventDefault(),a.stopPropagation()},reply:function(b){var c,d=this,e=this.options,f=this.model,g=f.get("originData"),h=$(b.currentTarget),i=h.closest(".reply-item"),j=$(".feed-reply",i),k=a("modules/fs-reply/fs-reply"),m=h.closest(".fs-reply-list-wrapper"),n=$(".feed-reply",m),o=$(".aj-Reply",m),p="";g.sender.employeeID==C.id&&(p="disabled"),i.data("fsReply")||(c=new k({trigger:h,element:j,bbarTpl:'<span class="fs-reply-send-sms label-for fn-hide"><input type="checkbox" name="send_sms" class="is-send-sms" '+p+' />&nbsp;<label>推送短信给：<em class="user-name">'+g.sender.name+"</em></label></span>",replyDefaultRequestData:function(){var a=g.feedReplyID,b=g.sender.employeeID,c=0,d=0,e=g.feedType,h=g.feedExtendData;3==e?(c=h.value1,d=h.value2):4==e&&(c=g.feedSender.employeeID,d=h.value1);var i={feedID:f.get("feedID"),isSendSms:$(".is-send-sms",j).prop("checked")};return _.extend(i,{feedType:e,feedSenderID:c,feedReceiverID:d,replyToReplyID:a,replyToEmployeeID:b}),i},detailDefaultRequestData:function(){var a=g.feedType;return{feedType:a}},replyCb:function(){var a=d.options;n.hide(),o.removeClass("fl-common-up-arrow"),$(".is-send-sms",j).prop("checked",!1),c.hide(),h.removeClass("fl-common-up-arrow"),e.withReplySuccessTip&&l.showAlertDialog("回复成功"),a.replyCb&&a.replyCb.apply(this,arguments)},defaultContent:"回复@"+g.sender.name+"：",listOpts:null}),c.show(),this.compStore.push(c),i.data("fsReply",c)),j.is(":visible")?h.addClass("fl-common-up-arrow"):h.removeClass("fl-common-up-arrow")},initialize:function(){this.compStore=[],this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.options.hideReplyRef&&$(".myreply-content",this.$el).hide(),this.options.hideReplyBtn&&$(".aj-Reply",this.$el).hide(),this},destroy:function(){_.each(this.compStore,function(a){a.destroy&&a.destroy()}),this.compStore=null,this.remove()}}),e=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:45,totalSize:0,visiblePageNums:7},hideReplyBtn:!1,listPath:"/feed_html/getFeedReplysOfAtMe",defaultRequestData:{},replyCb:function(a){a.success&&this.addNewReply(a.value)},searchOpts:{inputSelector:null,btnSelector:null},listEmptyText:"暂无记录"},a||{}),this.opts=a,this.element=$(a.element),this.pagEl=$(a.pagSelector),this.items=[],this.list=new f,this.paginations=[],this.tempRequestData={},this.init()},_.extend(e.prototype,{init:function(){var a,b=this,c=this.opts,d=this.element,e=this.list;d.addClass("fs-reply-list").html('<div class="fs-reply-list-inner"></div>'),a=$(".fs-reply-list-inner",d),e.on("add",function(d,e){var f,h=e.indexOf(d);f=new g({model:d,hideReplyBtn:c.hideReplyBtn,withReplySuccessTip:!0,replyCb:function(a){c.replyCb.call(this,a)}}).render(),0==h?f.$el.prependTo(a):f.$el.appendTo(a),b.items.push(f)}),this.pagEl.each(function(){var a=$(this),d=new n(_.extend({element:a},c.pagOpts));d.on("page",function(a){_.each(b.paginations,function(b){b!==d&&b.set("activePageNumber",a)}),b.empty(),b.fetch()}),d.render(),b.paginations.push(d)}),c.searchOpts&&c.searchOpts.inputSelector&&this._searchBarInit(),this._initListEmptyTip(),this._regEvents()},_searchBarInit:function(){var a,b,c,d=this,e=this.opts,f=e.searchOpts,g=this.element,h=$(f.inputSelector),i=$(f.btnSelector),j=h.data("isInit");j||(b=$('<span class="empty-h">&#10005;</span>'),c=$('<span class="list-search-input-wrapper"></span>'),h.wrap(c),c=h.closest(".list-search-input-wrapper"),b.hide().appendTo(c),h.keydown(function(a){13==a.keyCode&&i.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(b.show(),h.addClass("with-input-value")):(b.hide(),h.removeClass("with-input-value"))}),b.click(function(){h.val(""),h.removeClass("with-input-value"),b.hide()}),h.data("isInit",!0)),a=$('<div class="list-search-bar fn-clear"></div>'),a.html('<span class="result-info fn-left">共搜索到<span class="num color-red">0</span>条信息</span><a class="back-l fn-right" href="#" title="返回查看全部"><< 返回查看全部</a>'),a.hide().prependTo(g),a.on("click",".back-l",function(b){var c=$(".list-empty-tip",g),e=$(".empty-h",h.closest(".list-search-input-wrapper"));h.val(""),h.removeClass("with-input-value"),e.hide(),a.hide(),c.hide(),d.reload({keyword:""}),b.preventDefault()}),this.searchBarEl=a},_searchBarDestroy:function(){var a,b,c=this.opts,d=c.searchOpts;this.searchBarEl&&(a=$(d.inputSelector),b=a.closest(".list-search-input-wrapper"),a.insertAfter(b),b.remove(),a.val("").unbind(),a.data("isInit",!1),this.searchBarEl.remove(),this.searchBarEl=null)},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".num",d);return a.keyword.length>0&&b.success?(e.text(b.value.totalCount),d.show(),void 0):(d.hide(),void 0)},resetSearch:function(){var a=this.opts,b=a.searchOpts,c=$(b.inputSelector),d=c.closest(".list-search-input-wrapper"),e=$(".empty-h",d);e.click().hide(),this.searchBarEl&&this.searchBarEl.hide()},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+j.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.appendTo(a)},_updatelistStatus:function(a){var b,c=this.element,d=$(".list-empty-tip",c);a.success&&(b=a.value.totalCount,0==b?d.show():d.hide())},_hideEmptyTip:function(){var a=this.element,b=$(".list-empty-tip",a);b.hide()},_setTotalSize:function(a){var b=this.paginations;_.each(b,function(b){b.setTotalSize(a)})},_regEvents:function(){},setReplyBtnVisible:function(a){var b=this.opts;b.hideReplyBtn=!!a},fetch:function(){var a=this,b={},c=this.opts,d=this.paginations[0];b=_.extend({pageSize:d.get("pageSize"),pageNumber:d.get("activePageNumber")},b||{}),b=_.isFunction(c.defaultRequestData)?_.extend(c.defaultRequestData(),b):_.extend(c.defaultRequestData,b),b=_.extend(b,this.tempRequestData),this.tempRequestData={},this.showLoading(),this.list.fetch({url:c.listPath,data:b,success:function(b,c,d){var e;c.success&&(e=c.value,a._setTotalSize(e.totalCount),a.list.lastOriginData=c,a._updateSearchBarState(d.data,c),a._updatelistStatus(c),a.hideLoading())}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"><img src="'+j.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a){this._hideEmptyTip(),_.each(this.paginations,function(a){a.reset()}),this.tempRequestData=a,this.paginations[0].jump(1)},reload:function(a){this.list.lastOriginData=null,this.load(a)},empty:function(){var a=this.items,b=$(".fs-reply-list-inner",this.element);_.each(a,function(a){a.destroy&&a.destroy()}),b.empty()},destroy:function(){this._searchBarDestroy(),_.each(this.paginations,function(a){a.destroy()}),this.paginations=[],this.loading&&this.loading.stop(),this.empty(),this.list.lastOriginData=null,this.list=null,this.tempRequestData={},this.element.off(),this.element=null}}),_.extend(c.exports,{replyList:e,itemV:g,listC:f,itemM:h})});