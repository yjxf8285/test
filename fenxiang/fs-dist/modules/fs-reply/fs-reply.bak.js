/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-reply/fs-reply.bak",["modules/publish/publish","widget","util","moment","modules/fs-reply/fs-reply.css","modules/fs-reply/fs-reply.html","uilibs/pagination","modules/feed-list/feed-list-helper"],function(a,b,c){var d=window,e=d.FS;e.tpl;var f=a("modules/publish/publish"),g=a("widget"),h=a("util"),i=a("moment"),j=(a("modules/fs-reply/fs-reply.css"),a("modules/fs-reply/fs-reply.html")),k=a("uilibs/pagination"),l=a("modules/feed-list/feed-list-helper"),m=f.atInput,n=f.mediaMaker,o=$(j),p=g.extend({attrs:{trigger:{value:null,getter:function(a){return $(a)}},publishAction:{value:["imgUpload","attachUpload","at"],getter:function(a){return[].concat(a)}},listPath:"/Feed/GetFeedReplysByFeedID",sendPath:"/feed_html/sendFeedReply",defaultRequestData:{value:{},getter:function(a){return _.isFunction(a)?a():a}},replyDefaultRequestData:{value:{},getter:function(a){return _.isFunction(a)?a():a}},replyCb:e.EMPTY_FN,bbarTpl:'<span class="fs-reply-send-sms"><input type="checkbox" name="send_sms" />&nbsp;<label>立即发送短信息给：<span class="user-name">xx</span></label></span>',submitText:"回复",placeholder:"添加回复……",withPagination:!0},events:{"click .text-visible-l":"_textVisibleCtrl","click .fs-reply-reply-trigger":"_subReplyCtrl","click .fs-reply-sub":"reply"},setup:function(){var a=p.superclass.setup.apply(this,arguments);return this._setupElement(),this._setupTrigger(),this._bindEvents(),this._initPagination(),this.listStore=[],a},_textVisibleCtrlInit:function(a){var b=$(a),c=this._getItemEl(b),d=$(".fs-reply-text-inner",c),e=$("p",d);e.height()>d.height()?b.show():b.hide()},_textVisibleCtrl:function(a){var b=this._getItemEl(a.currentTarget),c=$(".fs-reply-text-inner",b),d=$(".text-visible-l",b);d.data("initText")||d.data("initText",d.text()),c.data("initHeight")||c.data("initHeight",c.height()),"auto"==c.get(0).style.height?(d.text(d.data("initText")),c.height(c.data("initHeight"))):(d.text("收起正文"),c.css("height","auto")),a.preventDefault()},_subReplyCtrl:function(a){var b=this._getItemEl(a.currentTarget),c=$(".fs-reply-sub-wrapper",b);0==c.length&&(c=this._renderSubHtml(b)),c.is(":visible")?c.hide():c.show(),a.preventDefault()},_getItemEl:function(a){return $(a).closest(".fs-reply-item")},_setupElement:function(){this.element.addClass("fs-reply").hide(),this._renderHtml()},_setupTrigger:function(){var a=this,b=this.element;this.get("trigger").addClass("fs-reply-trigger").on("click",function(c){c.preventDefault(),b.is(":visible")?a.hide():a.show()})},_initPagination:function(){var a=this,b=this.element,c=$(".fs-reply-pagination",b);this.pagination=new k({element:c,pageSize:10}).on("page",function(){a._renderReplyList()})},show:function(){var a=this.element;this.rendered||this.render(),a.show(),this.trigger("show")},hide:function(){var a=this.element;a.hide(),this.trigger("hide")},refresh:function(){var a=this.pagination.get("activePageNumber");1!=a?this.pagination.jump(1):this._renderReplyList()},clearSubmit:function(a){var b=$(a),c=$(".fs-reply-input",b),d=$(".fs-reply-media",b),e=d.data("media");c.val(""),e.resetAll()},_bindEvents:function(){this.on("show",function(){this._renderReplyList()})},_getInputTpl:function(){var a='<div class="fs-reply-input-wrapper"><div class="fs-reply-input-inner"><textarea class="fs-reply-input" placeholder="'+this.get("placeholder")+'"></textarea>'+"</div>"+'<div class="fs-reply-media"></div>'+'<div class="fs-reply-bbar fn-clear">'+'<div class="fs-reply-bbar-l">'+this.get("bbarTpl")+"</div>"+'<div class="fs-reply-bbar-r"><button type="button" class="fs-reply-sub button-green">'+this.get("submitText")+"</button></div>"+"</div>"+"</div>";return a},_renderHtml:function(){var a=this.element;return a.html('<div class="LR-arrow"> <em class="S_line1_c">◆</em> <span>◆</span> </div><div class="fs-reply-main-wrapper fs-reply-submit-box">'+this._getInputTpl()+"</div>"+'<div class="fs-reply-list-wrapper"><ul class="fs-reply-list"></ul><div class="fs-reply-pagination"></div></div>'),this._renderInput(),this._renderMedia(),a},_renderSubHtml:function(a){var b=$(a),c=$(".fs-reply-item-content",b),d=$('<div class="fs-reply-sub-wrapper fs-reply-submit-box"></div>');return d.html(this._getInputTpl()).hide().appendTo(c),this._renderInput(d),this._renderMedia(d),d},_getItemCompiled:function(){var a='<li class="fs-reply-item fn-clear">'+o.filter(".fs-reply-item").html()+"</li>",b=_.template(a);return b},_renderReplyList:function(){var a=this,b=this.element,c=$(".fs-reply-list",b),d={};d=_.extend(d,this.get("defaultRequestData")),d=_.extend(d,{pageSize:this.pagination.get("pageSize"),pageNumber:this.pagination.get("activePageNumber")}),this._emptyList(),h.api({data:d,type:"get",url:this.get("listPath"),success:function(b){var d,f=[],g=a._getItemCompiled();b.success&&(a.pagination.setTotalSize(b.value.totalCount),d=b.value.items,_.each(d,function(a,b){var c=l.feedContentFormat(a.replyContent);f[b]=g({thumbSrc:e.BASE_PATH+"/"+a.sender.profileImage+"2.jpg",replyContent:c,createTime:i(a.createTime).startOf("hour").fromNow(),replyContentLength:a.replyContentLength,feedReplyID:a.feedReplyID,senderName:a.sender.name,senderId:a.sender.employeeID})}),a.listStore=d,c.html(f.join("")),$(".text-visible-l",c).each(function(){a._textVisibleCtrlInit(this)}))}})},_renderInput:function(a){var b,c,d=this.element,e=$(a);b=_.isUndefined(a)?$(".fs-reply-main-wrapper .fs-reply-input",d):$(".fs-reply-input",e),c=new m({element:b,data:[]}),h.placeholder(b),b.data("atInput",c)},_renderMedia:function(a){var b,c,d=this.element,e=$(a);b=_.isUndefined(a)?$(".fs-reply-main-wrapper .fs-reply-media",d):$(".fs-reply-media",e),c=new n({element:b,action:this.get("publishAction")}),b.data("media",c)},_emptyList:function(){var a=this.element,b=$(".fs-reply-list",a);$(".fs-reply-input",b).each(function(){$(this).data("atInput").destroy()}),$(".fs-reply-media",b).each(function(){$(this).data("media").destroy()}),b.empty()},replyValid:function(a){var b=$(a),c=$(".fs-reply-input",b),d=_.str.trim(c.val()),e=!0;return 0==d.length&&(h.toggleAnimate({element:c,startProperty:{backgroundColor:"#DD4B39"},endProperty:{backgroundColor:"white"},animateOpts:{easing:"swing",duration:130},count:2}),e=!1),e},getReplyRequestData:function(a){var b,c,d,e,f=$(a),g=$(".fs-reply-media",f),h=g.data("media"),i={};return f.hasClass("fs-reply-main-wrapper")?i.feedID=this.get("defaultRequestData").feedID:(e=f.closest(".fs-reply-list"),c=$("[feedreplyid]",e).attr("feedreplyid"),d=this.getReplyDataById(c),i.feedID=d.feedID,i.replyToReplyID=c,i.replyToEmployeeID=d.employeeID),i.replyContent=_.str.trim($(".fs-reply-input",f).val()),i.fileInfos=[],b=h.getUploadValue(),_.each(b,function(a){"img"==a.uploadType?i.fileInfos.push({v:2,v1:a.pathName,v2:a.size,v3:a.name}):"attach"==a.uploadType&&i.fileInfos.push({v:3,v1:a.pathName,v2:a.size,v3:a.name})}),i},getReplyDataById:function(a){var b=this.listStore;return _.find(b,function(b){return b.feedReplyID==a})},reply:function(a){var b,c,d,e=this,f=$(a.currentTarget),g=f.closest(".fs-reply-submit-box");this.replyValid(g)&&(b=this.getReplyRequestData(g),_.extend(b,this.get("replyDefaultRequestData")),c=$(".fs-reply-media",g),d=c.data("media"),d.send(function(a){h.api({type:"post",data:b,url:e.get("sendPath"),success:function(b){b.success&&(e.addNewReply(b.value),e.clearSubmit(g),a()),e.get("replyCb")(b)}})},g))},addNewReply:function(a){var b=this,c=this.element,d=$(".fs-reply-list",c);h.api({type:"get",data:{feedReplyID:a},url:"/feed_html/getFeedReplyByID",success:function(a){var c,f,g="",h="",j=b._getItemCompiled();a.success&&(c=a.value.items[0],h=l.feedContentFormat(c.replyContent),g=j({thumbSrc:e.BASE_PATH+"/"+c.sender.profileImage+"2.jpg",replyContent:h,createTime:i(c.createTime).startOf("hour").fromNow(),replyContentLength:c.replyContentLength,feedReplyID:c.feedReplyID,senderName:c.sender.name,senderId:c.sender.employeeID}),b.listStore.push(c),f=$(g),d.prepend(f),$(".text-visible-l",f).each(function(){b._textVisibleCtrlInit(this)}),b.pagination.setTotalSize(b.pagination.get("totalSize")+1))}})},render:function(){var a=p.superclass.render.apply(this,arguments);return this.pagination.render(),a},destroy:function(){var a,b=this.element;return $(".fs-reply-input",b).each(function(){var a=$(this).data("atInput");a&&a.destroy()}),$(".fs-reply-media",b).each(function(){var a=$(this).data("media");a&&a.destroy()}),this.listStore=[],this.pagination.destroy(),a=p.superclass.destroy.apply(this,arguments)}});c.exports=p});