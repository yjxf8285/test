/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-plan-calendar/fs-plan-calendar",["modules/publish/publish","dialog","mask","innercalendar","./fs-plan-calendar.html","./fs-plan-calendar.css","modules/feed-list/feed-list","util","moment"],function(a,b,c){var d=window,e=d.FS,f=e.tpl,g=a("modules/publish/publish"),h=a("dialog"),i=(a("mask"),a("innercalendar")),j=a("./fs-plan-calendar.html"),k=(a("./fs-plan-calendar.css"),a("modules/feed-list/feed-list")),l=a("util"),m=a("moment"),g=a("modules/publish/publish"),n=$(j),o=g.dateSelect,p=[],q="YYYY-MM-DD",r="YYYY年MM月DD日",s=h.extend({attrs:{className:"fs-plan-export-dialog",content:n.filter(".fs-plan-export-tpl").html(),employeeId:0,successCb:e.EMPTY_FN},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel","click .date-shortcut":"_clickDateSc","click .ff-success-a":"_clickAhref"},_clickAhref:function(){var a=this.element;$(".ff-success-a",a).hide()},_clickDateSc:function(a){var b=$(a.currentTarget),c=this.sd,d=this.ed;b.hasClass("current-week")&&(c.setValue(m().startOf("week").add("d",1)),d.setValue(m().endOf("week").add("d",1))),b.hasClass("last-week")&&(c.setValue(m().startOf("week").subtract("w",1).add("d",1)),d.setValue(m().startOf("week"))),b.hasClass("current-month")&&(c.setValue(m().startOf("month")),d.setValue(m().endOf("month"))),b.hasClass("last-month")&&(c.setValue(m().startOf("month").subtract("M",1)),d.setValue(m().endOf("month").subtract("M",1))),a.preventDefault()},_renderCpt:function(){var a=this.element,b=$(".start-date",a),c=$(".end-date",a),d=new o({element:b,placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）"}),e=new o({element:c,placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）"});this.sd=d,this.ed=e},render:function(){var a=s.superclass.render.apply(this,arguments);return this._renderCpt(),a},show:function(){var a=s.superclass.show.apply(this,arguments);return a},hide:function(){var a=s.superclass.hide.apply(this,arguments);return this._clear(),a},getRequestData:function(){var a=this.element,b=$('[name="plan_type"]',a),c=this.sd,d=this.ed,e=b.filter(":checked").val(),f=this.get("employeeId"),g={employeeID:f,feedPlanType:e,startTime:c.getValue(!0).unix(),endTime:d.getValue(!0).add("days",1).subtract("seconds",1).unix()};return g},isValid:function(){var a=this.element,b=$(".start-date .fs-publish-dateselect-input",a),c=$(".end-date .fs-publish-dateselect-input",a);if(""==b.val()||""==c.val())return l.alert("起始时间不能为空！"),!1;this.getRequestData();var d=!0;return d},_clear:function(){var a=this.element,b=$('[name="plan_type"]',a),c=$(".start-date .fs-publish-dateselect-input",a),d=$(".end-date .fs-publish-dateselect-input",a);$(".ff-success-a",a).hide(),$(".ff-success-a",a).attr("href","#"),b.eq(0).attr("checked","checked"),c.val(""),d.val("")},_submit:function(){var a=this,b=this.element,c=$(".ff-success-a",b);if(this.isValid()){var d=this.getRequestData();l.api({data:d,url:"/Feedplan/GetFeedPlanExcelOfOneEmployee",success:function(b){var f,g;b.success&&(a.get("successCb").apply(a,[b,d]),f=l.getContactDataById(d.employeeID,"p"),g=f.name+"_"+m.unix(d.startTime).format("YYYYMMDD")+"-"+m.unix(d.endTime).format("YYYYMMDD")+"_日志统计报表."+l.getFileExtText(b.value),c.show(),c.attr("href",e.API_PATH+"/DF/GetTemp?id="+b.value+"&name="+encodeURIComponent(g)+"&isAttachment=1"))}},{submitSelector:$(".f-sub",b)})}},_cancel:function(){this.hide()},destroy:function(){var a;return this.sd&&this.sd.destroy(),this.ed&&this.ed.destroy(),a=s.superclass.destroy.apply(this,arguments)}}),t=i.extend({attrs:{listDefaultRequest:{value:{},getter:function(a){return _.isFunction(a)?a():a}},refreshDefaultRequest:{value:{},getter:function(a){return _.isFunction(a)?a():a}},showTodayBtn:!1,className:"fs-plan-calendar",planDate:[],activePlanDate:"",refreshCb:e.EMPTY_FN},events:{"click .fs-calendar-state-ordered":"_showPlan"},setup:function(){var a=this,b=t.superclass.setup.call(this);return this.planDialog=new h({content:n.filter(".fs-plan-calendar-dialog-tpl").html(),className:"fs-plan-calendar-dialog",width:600,height:500,zIndex:101}),this.model.on("changeMonth changeYear",function(){a.refreshPlanDate()}),this.planList=null,this.deleteStore=[this.planDialog],this._regEvents(),p.push({trigger:$(this.get("trigger")),ins:this}),b},_showPlan:function(a){var b=$(a.currentTarget),c=b.attr("data-value"),d=m(c,q);this.set("activePlanDate",c),this.showPlanDialog(d)},showPlanDialog:function(a){this.planDialog.rendered||this._renderPlanDialog(),$(".fs-plan-calendar-dialog-title",this.planDialog.element).text(m(a).format(r)+"的日志"),this.planDialog.show(),this.fetchPlanList()},hidePlanDialog:function(){this.planDialog.hide()},_regEvents:function(){var a=this,b=this.planDialog,c=b.element;c.on("click",".close-btn",function(){a.hidePlanDialog()})},_renderPlanDialog:function(){this.planDialog.render(),this._initPlanList()},_initPlanList:function(){var a=this,b=$(".plan-list",this.planDialog.element);this.planList=new k({element:b,pagSelector:!1,withLazyload:!1,listPath:"/FeedPlan/GetFeedPlanScheduleInfosByCurrentEmployeeID",defaultRequestData:function(){var b=a.get("activePlanDate");return _.extend({date:m(b,q).unix()},a.get("listDefaultRequest"))}})},getCurrentMonthRange:function(){var a,b,c=$('[data-role="date"]',this.element);return a=m(c.first().attr("data-value"),q),b=m(c.last().attr("data-value"),q),{startDate:a,endDate:b}},_renderPlanDate:function(){var a,b=this.get("planDate"),c=this.getCurrentMonthRange(),d=$('[data-role="date"]',this.element),e=c.startDate,f=c.endDate;a=_.filter(b,function(a){return a.startDate>=e&&a.startDate<=f?!0:void 0}),d.removeClass("fs-calendar-state-ordered"),_.each(a,function(a){d.filter('[data-value="'+m(a.startDate).format(q)+'"]').addClass("fs-calendar-state-ordered")})},_onRenderPlanDate:function(){this._renderPlanDate()},refreshPlanDate:function(){var a=this,b=this.getCurrentMonthRange(),c=this.get("refreshCb");l.api({url:"/employee/getEmployeeShortcutInfos",data:_.extend({startTime:b.startDate.unix(),endTime:b.endDate.unix()},this.get("refreshDefaultRequest")),type:"get",success:function(b){var d,e=[];b.success&&(d=b.value.feedPlanScheduleInfos,_.each(d,function(a){e.push({startDate:new Date(1e3*a)})}),a.set("planDate",e),c&&c.call(a,b))}})},_onRenderActivePlanDate:function(){},fetchPlanList:function(){this.planList.empty(),this.planList.reload()},destroy:function(){var a,b=this;return _.each(this.deleteStore,function(a){a.destroy()}),this.planList&&this.planList.destroy(),this.deleteStore=[],p=_.filter(p,function(a){return a.ins!==b}),a=t.superclass.destroy.call(this)}});f.event.on("beforeswitch",function(){_.each(p,function(a){var b=a.ins;b.hide()})}),f.event.on("switch",function(a,b){_.each(p,function(a){var c=a.trigger,d=a.ins;$.contains(b.get(0),c.get(0))?d.show():d.hide()})}),c.exports={FsPlanCalendar:t,ExportPlanDialog:s}});