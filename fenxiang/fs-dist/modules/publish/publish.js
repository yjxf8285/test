/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/publish/publish",["util","detector","json","position","moment","events","widget","overlay","dialog","uilibs/tabs","filter","autocomplete","select","placeholder","calendar","swfupload","fsupload","h5uploader","flashuploader","scrollbar","modules/publish/publish.html","modules/publish/publish.css","./publish-helper"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.store,e.event;var f=a("util"),g=(a("detector"),a("json")),h=a("position"),i=a("moment"),j=a("events"),k=(a("widget"),a("overlay"),a("dialog")),l=a("uilibs/tabs"),m=a("filter"),n=a("autocomplete"),o=(a("select"),a("placeholder"),a("calendar"),a("swfupload"),a("fsupload")),p=a("h5uploader"),q=a("flashuploader"),r=a("scrollbar"),s=a("modules/publish/publish.html"),t=(a("modules/publish/publish.css"),a("./publish-helper")),u=$(s),v=t.DateSelect,w=t.TimeSelect;d.BASE_PATH+"/Files/Temp";var x=0,y=f.getContactData(),z=function(a){var b;a=_.extend({element:null,withAt:!1},a||{}),b=$(a.element),this.element=b,f.placeholder(b),f.asyncOrder(["jslibs/jquery.autosize.js"],function(){b.addClass("autosize-animated").autosize({append:" "})}),a.withAt&&(f.asyncOrder(["stylelibs/jquery.atwho.css","jslibs/jquery.atwho.js","jslibs/jquery.atwho.custom.js"],function(){b.atwho("@",{data:y.p.concat(_.reject(y.g,function(a){return 999999==a.id})),callbacks:{filter:function(a,b){var c,e,f=m.stringMatch,g=m.startsWith,h=[],i=B.prototype.atGetDefaultSpData(),j=$("#at-view .at-view-title"),k=$("#at-view .loading-mask");return 0==k.length&&(k=$('<div class="loading-mask"><img src="'+d.BLANK_IMG+'" class="loading-img" alt="loading" /></div>'),k.prependTo("#at-view")),0==j.length&&(j=$('<h3 class="at-view-title"></h3>'),j.prependTo("#at-view")),k.hide(),0==_.str.trim(a).length?(h=i[0].list.slice(0),h.length>0?j.text("选择最近@提到的或直接输入").show():j.hide()):(c=f.apply(this,[b,a,{key:"name"}]),e=g.apply(this,[b,a.toLowerCase(),{key:"spell"}]),_.each(e,function(a){_.find(c,function(b){return b.id==a.id})||h.push(a)}),h=h.concat(c),h.length>0?j.text("选择名称或轻敲空格完成输入").show():j.hide()),h},matcher:function(a,b){var c,d,e;return e=new RegExp(a+"([a-zA-Z0-9_\\u4e00-\\u9fa5]*)$","gi"),c=e.exec(b),d=null,c&&(d=c[2]?c[2]:c[1]),d},sorter:function(a,b){return b}}}).addClass("fs-publish-input")}),b.change(function(){b.trigger("autosize.resize")}))};_.extend(z.prototype,{destroy:function(){this.element.trigger("autosize.destroy").removeClass("autosize-animated")}});var A=k.extend({attrs:{className:"fs-publish-g-upload-dialog",content:u.filter(".global-upload-dialog-wrapper").html(),media:null,actionModel:"attach",zIndex:1001},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel","click .remove-l":"_removeFile"},render:function(){var a=A.superclass.render.apply(this,arguments);return this._createUploader(),a},_updateListView:function(){var a=this.uploader,b=a.uploadFiles,c=$(".file-item",this.element);c.each(function(){var a=$(this),c=a.attr("fileid");_.find(b,function(a){return a.id==c})||a.remove()})},show:function(){var a,b=this.uploader,c=b.uploadFiles,d=this.element,e=$(".list-body",d),g=this.get("media");return g.id!=this.mediaId&&this.uploading?(f.confirm("有上传操作占用，确定要结束上传吗","确认操作",function(){_.each(c,function(a){b.cancelUpload(a.id,!1)}),b.uploadFiles=[],$("tbody",e).empty(),a=A.superclass.show.apply(this,arguments)}),this.mediaId=g.id):a=A.superclass.show.apply(this,arguments),a},uploadValid:function(){return!0},_updateFileView:function(a,b){var c,d=this.element,e=$(".list-body",d),f=$('[fileid="'+a.id+'"]',e),g=$(".upload-pbar",f);0==f.length&&(f=$('<tr class="file-item" fileid="'+a.id+'"><td class="file-name">'+a.name+'</td><td class="upload-progress"><div class="upload-pbar-wrapper"><div class="upload-pbar"></div></div></td><td class="operation"><a href="#" class="remove-l">删除</a></td></tr>'),f.appendTo($("tbody",e)),g=$(".upload-pbar",f),g.css({width:"100px"}),c=new D({element:g}),g.data("progressBar",c));var h=Math.ceil(100*(b/a.size))+"%";c=g.data("progressBar"),c.setProgress(h)},_syncUploadFile:function(a){var b,c=this.element,d=$(".list-body",c),e=this.get("media"),g=e.gUploadStore,h=this.uploader;b=e.getUploadFile(h,a.id),b.uploadType=f.getUploadType(b.name),g.push(b),h.core.cancelUpload(a.id,!1),e.removeUploadFile(h,a.id),$('[fileid="'+a.id+'"]',d).fadeOut(2e3,function(){$(this).remove()})},_createUploader:function(){var a=this,b=new o({upload_url:d.API_PATH+"/uploadfile_html/fileUpload",file_types:"*.*",file_types_description:"所有格式",button_placeholder_id:"fs-publish-global-upload-btn",button_text:'<span class="upload-text">上传</span>',button_width:50,button_height:20,fileDialogComplete:function(a,b){try{b>0&&this.startUpload()}catch(c){this.debug(c)}},upload_start_handler:function(b){var c=a.get("media"),d=a.get("actionModel"),e=c.uploadStartHandler(b,d,"g");return e&&(a._updateFileView(b,0),a.uploading=!0),e},upload_progress_handler:function(b,c){var d=a.get("media"),e=a.get("actionModel"),f=d.uploadProgressHandler(b,c,e,"g");return a._updateFileView(b,c),f},upload_success_handler:function(b,c){var d=a.get("media"),e=a.get("actionModel"),f=d.uploadSuccessHandler(b,c,e,"g");return a._updateFileView(b,b.size),a._syncUploadFile(b),f},upload_error_handler:function(b,c){var d=a.get("media"),e=a.get("actionModel"),f=d.uploadErrorHandler(b,c,e,"g");return f},upload_complete_handler:function(){var b=a.get("media"),c=a.get("actionModel"),d=b.uploadCompleteHandler(c,"g");return a.uploading=!1,d}});b.uploadFiles=[],b.type="global",b.uploaded=!0,this.uploader=b},_removeFile:function(a){var b=$(a.currentTarget),c=b.closest("tr"),d=c.attr("fileid"),e=this.uploader,f=this.get("actionModel"),g=this.get("media"),h=g.element,i=$(".fs-publish-g"+f+"upload-panel .fs-publish-upload-list",h),j=$('[fileid="'+d+'"]',i);e.core.cancelUpload(d),$(".file-remove-l",j).click(),c.remove(),a.preventDefault()},_submit:function(){this.hide()},_cancel:function(){this.hide()},_onRenderActionModel:function(a){var b=this.uploader;b&&setTimeout(function(){"img"==a?b.core.setFileTypes("*.jpg;*.gif;*.jpeg;*.png","图片"):b.core.setFileTypes("*.*","文件")},500)},destroy:function(){var a;return this.uploader&&this.uploader.destroy(),this.uploader=null,a=A.superclass.destroy.apply(this,arguments)}}),B=function(a){a=_.extend({element:null,limitUploadSingle:!1,action:["h5imgupload","h5attachupload","vote","at","topic"],actionOpts:{}},a||{}),this.id="media-"+B.idIndex,this.opts=a,this.element=$(a.element),this.uploaders={},this.uploadFiles={},this.init(),B.idIndex++};_.extend(B.prototype,{init:function(){var a,b,c=this,d=this.element,e=this.opts;d.html('<div class="fs-publish-action-btns"></div><div class="fs-publish-action-panels"></div>'),a=$(".fs-publish-action-btns",d),b=$(".fs-publish-action-panels",d),_.each(e.action,function(d){var e=d.toLowerCase(),f=$('<a href="javascript:;" class="fs-publish-'+e+'-btn fs-publish-media-btn"></a>'),g=$('<div class="fs-publish-media-panel-wrapper"></div>'),h=$('<span class="close-btn">×</span>'),i=$('<div class="fs-publish-'+e+'-panel fs-publish-media-panel"></div>');f.appendTo(a),h.appendTo(g),i.appendTo(g),g.appendTo(b),f.bind("showpanel",function(){g.show()}),h.click(function(){c[d+"Clear"](),g.hide(),c.trigger("closeaction",d)}),c[d].call(c)}),this.on("showpanel",function(a){var b=a.toLowerCase(),c=$(".fs-publish-"+b+"-panel",d),e=c.closest(".fs-publish-media-panel-wrapper");e.show()}),this.on("uploadstart",function(){}),this.on("uploadprogress",function(){}),this.on("uploadsuccess",function(){}),this.on("uploadfailure",function(){}),this.on("alluploadcomplete",function(){}),this.on("typeuploadcomplete",function(){var a=c.getTotalUploadStatus();a.uploaded&&c.trigger("alluploadcomplete")})},getDomByActionName:function(a){var b=this.element,c=$(".fs-publish-"+a+"-btn",b),d=$(".fs-publish-"+a+"-panel",b);return{button:c,panel:d}},getUploadItem:function(a,b){var c=this.getDomByActionName(a),d=c.panel,e=(b.uploadType,$(".fs-publish-upload-list",d)),f=b.name,g=b.id,h=$('[fileid="'+g+'"]',e);return 0==h.length&&(h=$('<div class="fs-publish-upload-item" filename="'+f+'" fileid="'+g+'"></div>'),h.html('<div class="fs-publish-upload-item-inner fn-clear"><div class="thumb"></div><div class="summary"></div></div><div class="fs-publish-upload-pbar"></div>'),h.appendTo(e)),h},renderUploadItem:function(a,b){var c=b.serverData,e=this.getUploadItem(a,b),g=$(".fs-publish-upload-item-inner",e),h=$(".thumb",g),i=$(".summary",g);return"img"==b.uploadType?h.html('<div class="thumb-img"><img class="blank-place" src="'+c.value+'" alt="'+b.name+'" /></div>'):h.html('<div class="thumb-attach"><img src="'+d.ASSETS_PATH+'/images/clear.gif" alt="'+b.name+'" class="icon-file fs-attach-'+f.getFileType(b)+'-icon" /></div>'),i.html('<p class="file-name"><a href="javascript:;" title="'+b.name+'">'+b.name+'</a></p><p class="file-remove-wrapper"><a href="#" class="file-remove-l">取消</a></p>'),e},renderUploadError:function(a,b){var c=this.getUploadItem(a,b),e=$(".fs-publish-upload-item-inner",c),f=$(".thumb",e),g=$(".summary",e);f.html('<img src="'+d.ASSETS_PATH+'/images/error.png" alt="'+b.name+'" />'),g.html('<p class="file-error">上传失败('+b.serverData.message+')，请取消后重试</p><p class="file-remove-wrapper"><a href="#" class="file-remove-l">取消</a></p>')},removeUploadItem:function(a,b){var c=this.getUploadItem(a,{name:"",id:b}),d=this.uploadFiles,e=d[a];e=_.filter(e,function(a){return b!=a.id}),this.uploadFiles[a]=e,c.remove()},updateUploadInfo:function(a){var b=this.getDomByActionName(a),c=b.panel,d=$(".fs-publish-upload-info",c),e=this.uploadFiles,g=e[a],h=0;_.each(g,function(a){h+=a.size}),d.html("共添加了"+g.length+"个文件，总大小"+f.getFileSize(h)+'&nbsp;&nbsp;<a href="#" class="file-remove-all-l" title="全部取消">全部取消</a>'),g.length>0?d.show():(d.hide(),c.closest(".fs-publish-media-panel-wrapper").hide())},uploadFilter:function(a,b,c){b=[].concat(b);var d,e=[],g=this.uploadFiles,h=g[a],i=y.u.uploadFileSizeLimit;return _.each(b,function(a){a.size<1024*1024*i&&a.size>0&&(_.find(h,function(b){return b.name==a.name})||("img"==c&&"jpg"==f.getFileType(a)&&e.push(a),"attach"==c&&e.push(a)))}),e.length<b.length&&("img"==c?d="选择的文件类型必须为jpg、gif、jpeg或png，大小不能超过"+i+"MB且文件名不能相同，内容不能为空。本次添加了"+e.length+"个文件。":"attach"==c&&(d="选择的文件大小不能超过"+i+"MB且文件名不能相同，内容不能为空。本次添加了"+e.length+"个文件。"),f.alert(d)),e},setUploadFile:function(a,b){var c=this.uploadFiles,d=c[a]||[];_.find(d,function(a){return a.id==b.id?(_.extend(a,b),!0):void 0})||d.push(b),c[a]=d},getUploadFile:function(a,b){var c=this.uploadFiles,d=c[a]||[];return _.find(d,function(a){return a.id==b})},removeUploadFile:function(a,b){var c,d=this.uploadFiles,e=d[a]||[];return e=_.filter(e,function(a){return a.id!=b?!0:(c=a,!1)}),d[a]=e,c},getTotalUploadStatus:function(){var a=this.uploadFiles,b=0,c=0,d=!0;return _.each(a,function(a){_.each(a,function(a){b+=a.uploadedSize,c+=a.size,a.uploaded||(d=!1)})}),{uploadedSize:b,totalSize:c,uploaded:d}},getUploadValue:function(){var a=this.uploadFiles,b=[];return _.each(a,function(a){_.each(a,function(a){b.push(_.extend({pathName:a.serverData.value.filePath},a))})}),b},h5imgupload:function(){var a,b=this,c=this.opts,e=c.limitUploadSingle,h=c.actionOpts,i=h.h5imgupload||{},j=i.limitUploadSingle,k=this.element,l=$(".fs-publish-h5imgupload-btn",k),m=$(".fs-publish-h5imgupload-panel",k);l.html('<img src="'+d.BLANK_IMG+'" alt="upload" class="btn-shadow" /><input class="fs-publish-h5-img-upload fs-publish-h5-upload" type="file" title="添加图片（多张）" />'),l.attr("title","添加图片（多张）"),e&&j!==!1?(l.attr("title","添加图片（一张）"),$(".fs-publish-h5-upload",l).attr("title","添加图片（一张）"),a=!1):a=!0,m.html('<div class="fs-publish-upload-list fn-clear"></div><div class="fs-publish-upload-info color-333333"></div>');var n=new p({multiple:a,accept:"image/*",fileInput:$(".fs-publish-h5-upload",l).get(0),url:"/File/UploadFile",filter:function(a){return b.uploadFilter("h5imgupload",a,"img")},onSelect:function(a){if(!(a.length<=0)){m.is(":hidden")&&b.trigger("showpanel","h5ImgUpload");var c=b.uploadFiles.h5imgupload||[];_.each(a,function(a){var e,f;f={id:a.id,name:a.name,size:a.size,uploaded:!1,uploadedSize:0,uploadType:"img",serverData:{success:!0,value:d.BLANK_IMG}},e=b.renderUploadItem("h5imgupload",f),$(".thumb-img img",e).replaceWith('<canvas width="120" height="120"></canvas>'),c.push(f)}),b.uploadFiles.h5imgupload=c;for(var f=0,g=a.length;g>f;f++)!function(c){var d,e,f=a[c],g=window.URL||window.webkitURL,h=b.getUploadItem("h5imgupload",f);d=$("canvas",h).get(0),e=d.getContext("2d");var i=new Image;i.onload=function(){var a=i.width,b=a,c=i.height,f=c,h=1,j=0,k=0;h=a>=c?a>120?120/a:1:c>120?120/c:1,b=h*a,f=h*c,d.width=b,d.height=f,e.drawImage(i,k,j,b,f),g.revokeObjectURL(i.src),i=null},i.src=g.createObjectURL(f)}(f);b.updateUploadInfo("h5imgupload"),e&&(b.disableAction("h5imgupload"),b.disableAction("h5attachupload")),j===!1&&b.enableAction("h5imgupload")}},onDelete:function(){},onProgress:function(a,c){b.setUploadFile("h5imgupload",{uploadedSize:c,id:a.id}),b.trigger("uploadprogress","h5imgupload",b.getUploadFile("h5imgupload",a.id))},onTotalProgress:function(){},onSuccess:function(a,c){b.setUploadFile("h5imgupload",{uploadedSize:a.size,uploaded:!0,serverData:g.parse(c),id:a.id}),b.trigger("uploadsuccess","h5imgupload",b.getUploadFile("h5imgupload",a.id))},onFailure:function(a){var c=b.removeUploadFile("h5imgupload",a.id);b.trigger("uploadfailure","h5imgupload",c)},onComplete:function(){b.trigger("typeuploadcomplete","h5imgupload")}});this.uploaders.h5imgupload=n,n.isSupport()&&(window.URL||window.webkitURL)||($('input[type="file"]',l).hide(),i.flashFallback?this.h5imgupload_fb():l.on("click",function(){return f.alert("当前浏览器不能满足html5版的上传功能，请尝试其他浏览器"),!1})),m.on("click",".file-remove-l",function(a){var c=$(this).closest(".fs-publish-upload-item"),d=c.attr("fileid"),f=b.uploaders.h5imgupload;b.removeUploadItem("h5imgupload",d),f.removeFile(d),b.updateUploadInfo("h5imgupload"),e&&0==$(".file-remove-l",m).length&&(b.enableAction("h5imgupload"),b.enableAction("h5attachupload")),a.preventDefault()}).on("click",".file-remove-all-l",function(a){$(".file-remove-l",m).each(function(){$(this).click()}),a.preventDefault()}),this.on("closeaction",function(a){e&&"h5imgupload"==a&&(b.enableAction("h5imgupload"),b.enableAction("h5attachupload"))})},h5imguploadClear:function(){var a=this.uploaders.h5imgupload,b=this.uploadFiles,c=this.getDomByActionName("h5imgupload"),d=c.panel;b.h5imgupload=[],a.removeAllFile(),$(".fs-publish-upload-list",d).empty()},h5imgupload_fb:function(){var a,b,c,e=this,f=this.opts,h=f.limitUploadSingle,i=f.actionOpts,j=i.h5imgupload||{},k=j.limitUploadSingle,l=this.element,m=$(".fs-publish-h5imgupload-btn",l),n=$(".fs-publish-h5imgupload-panel",l);c="fs-publish-media-upload-"+x,x++,b=$('<span id="'+c+'"></span>'),b.appendTo(m),a=h&&k!==!1?!1:!0;var o=new q({upload_url:d.API_PATH+"/File/UploadFileByForm",file_types:"*.jpg;*.gif;*.jpeg;*.png",file_upload_limit:a?0:1,file_types_description:"图片格式",button_placeholder_id:c,button_text:"",file_queued_handler:function(a){var b,c,f=e.uploadFilter("h5imgupload",a,"img");0==f.length?o.cancelUpload(a.id,!1):(n.is(":hidden")&&e.trigger("showpanel","h5ImgUpload"),b=e.uploadFiles.h5imgupload||[],c={id:a.id,name:a.name,size:a.size,uploaded:!1,uploadedSize:0,uploadType:"img",serverData:{success:!0,value:d.BLANK_IMG}},e.renderUploadItem("h5imgupload",c),b.push(c),e.uploadFiles.h5imgupload=b,e.updateUploadInfo("h5imgupload"),h&&(e.disableAction("h5imgupload"),e.disableAction("h5attachupload")),k===!1&&e.enableAction("h5imgupload"))},file_dialog_complete_handler:function(a,b){b>0&&this.startUpload()},upload_progress_handler:function(a,b){e.setUploadFile("h5imgupload",{uploadedSize:b,id:a.id}),e.trigger("uploadprogress","h5imgupload",e.getUploadFile("h5imgupload",a.id))},upload_error_handler:function(a){var b=e.getUploadItem("h5imgupload",a),c=$(".thumb-img",b);c.html("上传失败，请取消后重试");var d=e.removeUploadFile("h5imgupload",a.id);e.trigger("uploadfailure","h5imgupload",d)},upload_success_handler:function(a,b){var c=e.getUploadItem("h5imgupload",a),f=$(".thumb-img img",c),h=g.parse(b);f.removeClass("blank-place").attr("src",d.API_PATH+"/df/getTempImg?id="+h.value.filePath),e.setUploadFile("h5imgupload",{uploadedSize:a.size,uploaded:!0,serverData:h,id:a.id}),e.trigger("uploadsuccess","h5imgupload",e.getUploadFile("h5imgupload",a.id))},upload_complete_handler:function(){this.getStats().files_queued>0&&this.startUpload()},upload_all_complete_handler:function(){e.trigger("typeuploadcomplete","h5imgupload")}});this.uploaders.h5imgupload=o},h5attachupload:function(){var a=this,b=this.opts,c=b.limitUploadSingle,e=b.actionOpts,h=e.h5attachupload||{},i=this.element,j=$(".fs-publish-h5attachupload-btn",i),k=$(".fs-publish-h5attachupload-panel",i);j.html('<img src="'+d.BLANK_IMG+'" alt="upload" class="btn-shadow" /><input class="fs-publish-h5-img-upload fs-publish-h5-upload" type="file" title="添加附件（多个）" />'),j.attr("title","添加附件（多个）"),c&&(j.attr("title","添加附件（一个）"),$(".fs-publish-h5-upload",j).attr("title","添加附件（一个）")),k.html('<div class="fs-publish-upload-list fn-clear"></div><div class="fs-publish-upload-info color-333333"></div>');var l=new p({multiple:!c,accept:"*/*",fileInput:$(".fs-publish-h5-upload",j).get(0),url:"/File/UploadFile",filter:function(b){return a.uploadFilter("h5attachupload",b,"attach")},onSelect:function(b){if(!(b.length<=0)){k.is(":hidden")&&a.trigger("showpanel","h5attachupload");var e=a.uploadFiles.h5attachupload||[];_.each(b,function(b){var c;c={id:b.id,name:b.name,size:b.size,uploaded:!1,uploadedSize:0,uploadType:"attach",serverData:{success:!0,value:d.BLANK_IMG}},a.renderUploadItem("h5attachupload",c),e.push(c)}),a.uploadFiles.h5attachupload=e,a.updateUploadInfo("h5attachupload"),c&&(a.disableAction("h5imgupload"),a.disableAction("h5attachupload"))}},onDelete:function(){},onProgress:function(b,c){a.setUploadFile("h5attachupload",{uploadedSize:c,id:b.id}),a.trigger("uploadprogress","h5attachupload",a.getUploadFile("h5attachupload",b.id))},onTotalProgress:function(){},onSuccess:function(b,c){a.setUploadFile("h5attachupload",{uploadedSize:b.size,uploaded:!0,serverData:g.parse(c),id:b.id}),a.trigger("uploadsuccess","h5attachupload",a.getUploadFile("h5attachupload",b.id))},onFailure:function(b){var c=a.removeUploadFile("h5attachupload",b.id);a.trigger("uploadfailure","h5attachupload",c)},onComplete:function(){a.trigger("typeuploadcomplete","h5attachupload")}});this.uploaders.h5attachupload=l,l.isSupport()||($('input[type="file"]',j).hide(),h.flashFallback?this.h5attachupload_fb():j.on("click",function(){return f.alert("当前浏览器不能满足html5版的上传功能，请尝试其他浏览器"),!1})),k.on("click",".file-remove-l",function(b){var d=$(this).closest(".fs-publish-upload-item"),e=d.attr("fileid"),f=a.uploaders.h5attachupload;a.removeUploadItem("h5attachupload",e),f.removeFile(e),a.updateUploadInfo("h5attachupload"),c&&0==$(".file-remove-l",k).length&&(a.enableAction("h5imgupload"),a.enableAction("h5attachupload")),b.preventDefault()}).on("click",".file-remove-all-l",function(a){$(".file-remove-l",k).each(function(){$(this).click()}),a.preventDefault()}),this.on("closeaction",function(b){c&&"h5attachupload"==b&&(a.enableAction("h5imgupload"),a.enableAction("h5attachupload"))})},h5attachuploadClear:function(){var a=this.uploaders.h5attachupload,b=this.uploadFiles,c=this.getDomByActionName("h5attachupload"),d=c.panel;b.h5attachupload=[],a.removeAllFile(),$(".fs-publish-upload-list",d).empty()},h5attachupload_fb:function(){var a,b,c=this,e=this.opts,f=e.limitUploadSingle,h=this.element,i=$(".fs-publish-h5attachupload-btn",h),j=$(".fs-publish-h5attachupload-panel",h);b="fs-publish-media-upload-"+x,x++,a=$('<span id="'+b+'"></span>'),a.appendTo(i);var k=new q({upload_url:d.API_PATH+"/File/UploadFileByForm",file_types:"*.*",file_upload_limit:f?1:0,file_types_description:"所有格式",button_placeholder_id:b,button_text:"",file_queued_handler:function(a){var b,e,g=c.uploadFilter("h5attachupload",a,"attach");0==g.length?k.cancelUpload(a.id,!1):(j.is(":hidden")&&c.trigger("showpanel","h5attachupload"),b=c.uploadFiles.h5attachupload||[],e={id:a.id,name:a.name,size:a.size,uploaded:!1,uploadedSize:0,uploadType:"attach",serverData:{success:!0,value:d.BLANK_IMG}},c.renderUploadItem("h5attachupload",e),b.push(e),c.uploadFiles.h5attachupload=b,c.updateUploadInfo("h5attachupload"),f&&(c.disableAction("h5imgupload"),c.disableAction("h5attachupload")))},file_dialog_complete_handler:d.EMPTY_FN,upload_progress_handler:function(a,b){c.setUploadFile("h5attachupload",{uploadedSize:b,id:a.id}),c.trigger("uploadprogress","h5attachupload",c.getUploadFile("h5attachupload",a.id))},upload_error_handler:function(a){var b=c.removeUploadFile("h5attachupload",a.id);c.trigger("uploadfailure","h5attachupload",b)},upload_success_handler:function(a,b){c.setUploadFile("h5attachupload",{uploadedSize:a.size,uploaded:!0,serverData:g.parse(b),id:a.id}),c.trigger("uploadsuccess","h5attachupload",c.getUploadFile("h5attachupload",a.id))},upload_complete_handler:function(){this.getStats().files_queued>0&&this.startUpload()},upload_all_complete_handler:function(){c.trigger("typeuploadcomplete","h5attachupload")}});this.uploaders.h5attachupload=k},vote:function(){var a,b=this.opts,c=b.actionOpts,e=c.vote||{},g=e.contactData,h=this.element,i=$(".fs-publish-vote-btn",h),j=$(".fs-publish-vote-panel",h),k=u.filter(".vote-wrapper").html();j.html(k),i.html('<img src="'+d.BLANK_IMG+'" alt="vote" />'),a=$(".vote",j),i.attr("title","添加投票"),f.placeholder($("[placeholder]",a));var l=$(".custom-range",a),m=new F({element:l,data:[{title:"同事",type:"p",list:g}],singleCked:!1,title:"选择投票后可见人",autoCompleteTitle:"请输入姓名或拼音"});l.data("sb",m);var n,o,p=$(".deadline-ticks",a),q=$(".dealine-date-time",a),r=$(".date-wrapper",q),s=$(".time-wrapper",q);n=new v({element:r,placeholder:"请选择日期"}),o=new w({element:s,placeholder:"请选择时间"}),n.on("change",function(){""==o.getValue()&&o.selector.select(0)}),q.data("ds",n),q.data("ts",o);var t=$(".add-vote-option-l",a),x=$(".option-wrapper",a),y=$(".option-tpl",a),z=_.template(y.html());t.click(function(a){var b,c=$(".option-item",x).length+1;b=z({index:c}),20>=c&&$(b).appendTo(x),a.preventDefault()}),x.on("click",".remove-l",function(){var a=$(this),b=a.closest(".option-item");b.remove(),$(".option-index",x).each(function(a){$(this).text(a+1+"、")}),$(".vote-option",x).change()}),p.change(function(){var a=$(this).val();"5"==a?q.show():q.hide()}).change(),$(".result-view-type",a).click(function(){var b=$(this),c=$(".custom-range",a);"3"==b.val()?c.show():c.hide()}).eq(0).click(),x.on("change",".vote-option",function(){var b=$(".vote-option",x),c=$(".vote-count",a),d=c.val(),e=0;b.each(function(){_.str.trim($(this).val()).length>0&&e++}),1>e&&(e=1);for(var f="",g=1;e>=g;g++)f+=1==g?'<option value="1">单选</option>':'<option value="'+g+'">最多选'+g+"个项目</option>";c.html(f).val(d),e>1?c.prop("disabled",!1):c.prop("disabled",!0)}),i.click(function(a){$(this).trigger("showpanel"),a.preventDefault()})},voteClear:function(){var a=this.voteGetValue();a.employeeIDs.element.removeAllItem(),a.title.element.val(""),a.voteOptions.element.each(function(){var a=$(this),b=a.closest(".option-item");$(".remove-l",b).length>0?b.remove():a.val("")}).change(),a.voteCount.element.val("1"),a.timeType.element.val("1").change(),a.deadline.element.data("ds").clear(),a.deadline.element.data("ts").clear(),a.isAnoymouse.element.prop("checked",!1)},voteIsValid:function(){var a=!0,b=this.voteGetValue(),c=b.voteOptions,d=c.value;return 0==b.title.value.length?(f.alert("投票标题不能为空"),a=!1):b.title.value.length>25?(f.alert("投票标题不能超过25个字符"),a=!1):d.length<2?(f.alert("投票选项最少为2项，请填写"),a=!1):0==b.deadline.value.length?(f.alert("请设置自定义截止时间"),a=!1):"3"==b.resultViewType.value?(0==b.employeeIDs.value.length&&(f.alert("请选择自定义范围"),a=!1),a):a},voteGetValue:function(){var a,b,c,d={},e=this.element,f=$(".fs-publish-vote-panel",e),g=$(".vote",f),h=$(".vote-title",g),j=$(".vote-option",g),k=$(".vote-count",g),l=$(".deadline-ticks",g),m=$(".dealine-date-time",g),n=$(".is-anoymouse",g),o=$(".result-view-type",g),p=$(".custom-range",g),q=p.data("sb"),r=q.getSelectedData(),s=[],t=m.data("ds"),u=m.data("ts"),v=i();return d.timeType={element:l,value:l.val()},d.title={element:h,value:_.str.trim(h.val())},d.deadline={element:m,value:l.val()},c=parseInt(d.timeType.value),5!=c?d.deadline.value=3>=c?v.add("weeks",c).unix():v.add("months",1).unix():(a=t.getValue(),b=u.getValue(),d.deadline.value=a.length>0?i(a+" "+b,"YYYYMMDD HH:mm").unix():""),d.isAnoymouse={element:n,value:n.prop("checked")},d.resultViewType={element:o,value:o.filter(":checked").val()},d.employeeIDs={element:q,value:r.p||[]},j.each(function(){var a=_.str.trim($(this).val());a.length>0&&s.push(a)}),d.voteOptions={element:j,value:s},d.voteCount={element:k,value:k.val()},d},at:function(){var a=this,b=this.element,c=$(".fs-publish-at-btn",b);$(".fs-publish-at-panel",b);var e=this.opts,g=e.actionOpts,h=g.at||{},i=$(h.inputSelector),j=this.atGetDefaultSpData();c.html('<img src="'+d.BLANK_IMG+'" alt="vote" />'),c.attr("title","添加提到");var k=new E(_.extend({trigger:c,singleCked:!1,data:j},h.spOpts||{}));k.on("select",function(a){var b=i.filter(".fs-publish-at-focus").get(0)||i.eq(0).get(0);_.each(a,function(a){f.appendInput(b,"@"+a[0].name+" ")}),$(b).trigger("autosize.resize"),k.unselect("all","all")}),f.asyncOrder(["stylelibs/jquery.atwho.css","jslibs/jquery.atwho.js","jslibs/jquery.atwho.custom.js"],function(){m.stringMatch,i.atwho("@",{data:y.p.concat(_.reject(y.g,function(a){return 999999==a.id})),callbacks:{filter:function(b,c){var e,f,g=m.stringMatch,h=m.startsWith,i=[],j=a.atGetDefaultSpData(),k=$("#at-view .at-view-title"),l=$("#at-view .loading-mask");return 0==l.length&&(l=$('<div class="loading-mask"><img src="'+d.BLANK_IMG+'" class="loading-img" alt="loading" /></div>'),l.prependTo("#at-view")),0==k.length&&(k=$('<h3 class="at-view-title"></h3>'),k.prependTo("#at-view")),l.hide(),0==_.str.trim(b).length?(i=j[0].list.slice(0),i.length>0?k.text("选择最近@提到的或直接输入").show():k.hide()):(e=g.apply(this,[c,b,{key:"name"}]),f=h.apply(this,[c,b.toLowerCase(),{key:"spell"}]),_.each(f,function(a){_.find(e,function(b){return b.id==a.id})||i.push(a)}),i=i.concat(e),i.length>0?k.text("选择名称或轻敲空格完成输入").show():k.hide()),i},matcher:function(a,b){var c,d,e;return e=new RegExp(a+"([a-zA-Z0-9_\\u4e00-\\u9fa5]*)$","gi"),c=e.exec(b),d=null,c&&(d=c[2]?c[2]:c[1]),d},sorter:function(a,b){return b}}}).addClass("fs-publish-input")}),i.focus(function(){i.removeClass("fs-publish-at-focus"),$(this).addClass("fs-publish-at-focus")}),i.change(function(){i.trigger("autosize.resize")}),this.atSelectPanel=k},atClear:function(){},atGetDefaultSpData:function(){var a,b=f.getContactData(!0),c=[],d=b.p,e=b.g,g=f.getPersonalConfig("lastAtData");return _.each(g,function(a){var b=f.getContactDataById(a.dataID,a.isCircle?"g":"p");b&&c.push({name:b.name,id:b.id,spell:b.spell})}),c=_.reject(c,function(a){return 999999==a.id}),e=_.reject(e,function(a){return 999999==a.id}),a=[{title:"常用",type:"mix",sortType:"origin",list:c},{title:"同事",unitSuffix:"位同事",type:"p",list:d},{title:"部门",unitSuffix:"个部门",type:"g",list:e}]},atUpdateSpData:function(){var a=this.opts,b=a.actionOpts,c=b.at||{},d=$(c.inputSelector),e=f.getPersonalConfig("lastAtData")||[];d.each(function(){var a=f.getAtFromInput(this);_.each(a,function(a){var b=f.getContactDataByName(a,"g");b?e=f.toListTop(e,{dataID:b.id,name:b.name,isCircle:!0},function(a){return a.dataID==b.id}):(b=f.getContactDataByName(a,"p"),b&&(e=f.toListTop(e,{dataID:b.id,name:b.name,isCircle:!1},function(a){return a.dataID==b.id})))})}),f.setPersonalConfig("lastAtData",e),this.atSelectPanel.updateData(this.atGetDefaultSpData())},topic:function(){var a=this.element,b=$(".fs-publish-topic-btn",a);$(".fs-publish-topic-panel",a);var c=this.opts,e=c.actionOpts,g=e.topic||{},h=$(g.inputSelector);b.html('<img src="'+d.BLANK_IMG+'" alt="topic" />'),b.attr("title","添加话题");var i=new C(_.extend({trigger:b,align:{selfXY:[0,0],baseElement:b,baseXY:[-227,22]},listPath:"/Topic/GetRecentlySendAndNewTopics"},g.dialogOpts||{})).render();i.on("itemclick",function(a){var b=h.filter(".fs-publish-topic-focus");0==b.length&&(b=h.eq(0)),f.appendInput(b.get(0),"#"+a.name+"# "),b.keyup(),i.hide()}),i.on("inserttopic",function(){var a,b=h.filter(".fs-publish-topic-focus").get(0)||h.eq(0).get(0);f.appendInput(b,"#请输入话题（10个以内连续汉字）# "),$(b).trigger("autosize.resize"),a=f.getCursorPosition(b),$(b).keyup(),i.hide(),a.start=a.start-18,a.end=a.end-2,f.setCursorPosition(b,a)}),h.change(function(){h.trigger("autosize.resize")}),h.focus(function(){h.removeClass("fs-publish-topic-focus"),$(this).addClass("fs-publish-topic-focus")});var j;f.asyncOrder(["stylelibs/jquery.atwho.css","jslibs/jquery.atwho.js","jslibs/jquery.atwho.custom.js"],function(){m.stringMatch,i.dataStore,h.atwho("#",{data:"/Topic/Get10Topics",insertSeparator:!1,emptyTipTpl:"没有搜索到话题",withEmptyTip:!1,callbacks:{remote_filter:function(a,b,c){var e=$("#at-view .at-view-title"),g=$("#at-view .loading-mask");return 0==g.length&&(g=$('<div class="loading-mask"><img src="'+d.BLANK_IMG+'" class="loading-img" alt="loading" /></div>'),g.prependTo("#at-view")),0==e.length&&(e=$('<h3 class="at-view-title"></h3>'),e.prependTo("#at-view")),0==_.str.trim(a.q).length?(e.hide(),g.hide(),c([]),void 0):(g.show(),clearTimeout(j),j=setTimeout(function(){return f.api({url:b,type:"get",data:{keyword:a.q},success:function(a){var b;a.success?(b=a.value||[],e.text("#相似话题#").show(),g.hide(),b=_.map(b,function(a){return{name:a}}),c(b)):(e.hide(),g.hide(),c([]))}})},80),void 0)},matcher:function(a,b){var c,d,e,f=this.$inputor.val(),g=f.slice(b.length,b.length+1),h=b.split(/\n/),i=0;e=new RegExp(a+"([^\\s|^#]*)$","gi"),c=e.exec(b),h=h[h.length-1].split("");for(var j=0,k=h.length;k>j;j++)"#"==h[j]&&i++;return d=null,1==i%2&&"#"==g&&c&&(d=c[2]?c[2]:c[1]),d},sorter:function(a,b){return b}}})}),i.element.on("click",function(a){a.stopPropagation()}),f.regGlobalClick(i.element,function(a){var c=$(a.target);b[0]===c[0]||$.contains(b[0],c[0])||i.element.is(":visible")&&i.hide()}),this.topicDialog=i},topicClear:function(){},isActive:function(a){var b=this.element,c=$(".fs-publish-"+a+"-panel",b);return c.is(":visible")?!0:!1},disableAction:function(a){var b=a.toLowerCase(),c=this.element,d=$(".fs-publish-"+b+"-btn",c);("h5imgupload"==a||"h5attachupload"==a)&&this.uploaders[a].setDisable(!0),d.addClass("fs-publish-"+b+"-disabled fs-publish-media-disabled")},enableAction:function(a){var b=a.toLowerCase(),c=this.element,d=$(".fs-publish-"+b+"-btn",c);("h5imgupload"==a||"h5attachupload"==a)&&this.uploaders[a].setDisable(!1),d.removeClass("fs-publish-"+b+"-disabled fs-publish-media-disabled")},hideAction:function(a){var b=a.toLowerCase(),c=this.element,d=$(".fs-publish-"+b+"-btn",c),e=$(".fs-publish-"+b+"-panel",c).closest(".fs-publish-media-panel-wrapper");d.hide(),e.hide()},showAction:function(a){var b=a.toLowerCase(),c=this.element,d=$(".fs-publish-"+b+"-btn",c);d.show()},resetAll:function(){var a=this,b=this.element,c=this.opts;_.each(c.action,function(b){a[b+"Clear"]()}),$(".fs-publish-media-panel-wrapper",b).hide()},send:function(a,b){var c,d,e=this,g=b?$(b):$("body"),i=new Date,j=function(){c.hide(),d.reset(),d.setPipeVisible(!1)},k=function(){c.width(g.outerWidth()),c.height(g.outerHeight())},l=function(){d.setWidth(g.width()-40),h.center(d.element,g)};c=g.children(".fs-publish-media-send-model"),0==c.length&&(c=$('<div class="fs-publish-media-send-model"></div>'),c.html('<div class="fs-publish-allupload-pbar"></div><div class="fs-publish-send-info"></div>'),c.appendTo(g),d=new D({element:$(".fs-publish-allupload-pbar",c)}),c.data("pbar",d).hide(),d.setPipeVisible(!1),"static"==g.css("position")&&g.css("position","relative")),d=c.data("pbar"),k(),this.atSelectPanel&&this.atUpdateSpData();var m;_.each(this.uploaders,function(a){a.startUpload()}),m=this.getTotalUploadStatus(),c.show(),m.uploaded?(d.setTbar("正在提交请稍候..."),l(),a(j,c)):(d.isPipeVisible()||(d.setPipeVisible(!0),l()),this.on("uploadprogress",function(){var a,b=new Date,c=0,g=e.getTotalUploadStatus(),h=g.uploadedSize,j=g.totalSize,k=Math.ceil(100*(h/j))+"%";
parseFloat(k)>100&&(k="100%"),d.setProgress(k),c=h/((b.getTime()-i.getTime())/1e3),a=(j-h)/c,d.setTbar("正在上传&nbsp;"+f.getFileSize(h)+"&nbsp;/&nbsp;"+f.getFileSize(j)+"&nbsp;&nbsp;&nbsp;剩余时间："+a.toFixed(2)+"秒"),d.setBbar("速度："+f.getFileSize(c)+"/秒")}),this.one("alluploadcomplete",function(){this.off("uploadprogress"),d.setProgress("100%"),a(j,c),d.setTbar("正在提交请稍候...")}))},destroy:function(){this.atSelectPanel&&(this.atSelectPanel.destroy(),this.atSelectPanel=null),this.topicDialog&&(this.topicDialog.destroy(),this.topicDialog=null),this.uploaders&&(_.each(this.uploaders,function(a){a.destroy()}),this.uploaders=null),this.uploadFiles=null,this.off(),this.element.empty()}}),B.idIndex=0,B.uploadCount=0,B.gUploadDia=new A,j.mixTo(B);var C=k.extend({attrs:{content:u.filter(".topic-dialog-tpl").html(),className:"fs-publish-topic-dialog",width:240,height:412,hasMask:!1,listPath:"/Topic/GetRecentlySendAndNewTopics"},events:{"mouseenter .topic-item":"_enterTopicItem","mouseleave .topic-item":"_leaveTopicItem","click .topic-item":"_clickTopicItem","click .insert-topic-btn":"_clickInsertBtn","click .f-cancel":"hide"},setup:function(){var a=C.superclass.setup.apply(this,arguments);return a},render:function(){var a=C.superclass.render.apply(this,arguments);return this._renderList(),a},_enterTopicItem:function(a){var b=$(a.target);b.addClass("state-hover")},_leaveTopicItem:function(a){var b=$(a.target);b.removeClass("state-hover")},_clickTopicItem:function(a){var b=$(a.target),c=b.attr("keyid"),d=this.getItemData(c);this.trigger("itemclick",d)},_clickInsertBtn:function(){this.trigger("inserttopic")},_renderList:function(){var a=this,b=this.get("listPath");f.api({url:b,type:"get",success:function(b){var c,d=[];b.success&&(c=b.value,_.each(c,function(a,b){var c="recentlyTopics"==b?"常用话题":"最新话题",e=[];_.each(a,function(a){a=_.str.trim(a),_.some(e,function(b){return b.name==a})||e.push({name:a})}),d.push({title:c,list:e,key:b})}),a.dataStore=d,a._createListHtml(d))}})},_createListHtml:function(a){var b=this.element,c=$(".cate-list",b),d="";_.each(a,function(a,b){var c=a.title,e=a.list,f="";d+='<li class="cate-item"><div class="cate-title">'+c+'</div><ul class="topic-list">',_.each(e,function(a,c){f+='<li class="topic-item" keyid="'+b+"-"+c+'">'+a.name+"</li>"}),d+=f+"</ul><li>"}),c.html(d)},getItemData:function(a){var b=a.split("-"),c=this.dataStore;return c[b[0]].list[b[1]]}}),D=function(a){a=_.extend({element:null,width:"auto"},a||{});var b=$(a.element);this.element=b,this.opts=a,b.data("progressBar",this),this.init()};D.prototype.init=function(){var a=this.opts,b=this.element;b.html('<div class="fs-progressbar-tbar"></div><div class="fs-progressbar-pipe"><div class="fs-progress-indicator"></div><div class="fs-progress-text"></div></div><div class="fs-progressbar-bbar"></div>'),b.addClass("fs-progressbar"),"auto"!=a.width&&$(".fs-progressbar-pipe",b).width(a.width)},D.prototype.setProgress=function(a){var b=this.element,c=$(".fs-progress-indicator",b),d=$(".fs-progress-text",b);c.css({width:a}),d.text(a)},D.prototype.setTbar=function(a){var b=this.element,c=$(".fs-progressbar-tbar",b);c.html(a)},D.prototype.setBbar=function(a){var b=this.element,c=$(".fs-progressbar-bbar",b);c.html(a)},D.prototype.setWidth=function(a){var b=this.element,c=$(".fs-progressbar-pipe",b),d=$(".fs-progressbar-tbar",b),e=$(".fs-progressbar-bbar",b);c.width(a),d.width(a),e.width(a)},D.prototype.setPipeVisible=function(a,b){var c=this.element,d=$(".fs-progressbar-pipe",c);b=!!b,a?b?d.fadeIn():d.show():b?d.fadeOut():d.hide()},D.prototype.isPipeVisible=function(){var a=this.element,b=$(".fs-progressbar-pipe",a);return b.is(":visible")},D.prototype.reset=function(){this.setProgress("0%"),this.setTbar(""),this.setBbar("")},D.prototype.destroy=function(){var a=this.element;a.removeData("progressBar"),a.addClass("fs-progressbar").empty(),this.element=null};var E=function(a){a=_.extend({trigger:null,singleCked:!1,data:[{title:"标题 A",type:"a",sortType:"letter",list:[{name:"测试",id:"test",spell:"test"},{name:"测试a",id:"test2",spell:"aest"},{name:"测试b-1",id:"test3",spell:"best"},{name:"测试b-2",id:"test4",spell:"best"}]},{title:"标题 B",type:"b",unitSuffix:"位同事",list:[{name:"测试A",id:"test1",spell:"aest"}]},{title:"标题 B",type:"c",list:[{name:"测试b",id:"test1",spell:"best"}]}]},a||{});var b='<div class="fs-contact-letter-nav fn-clear"></div><div class="fs-contact-list-wrapper"><ul class="fs-contact-list"></ul></div>',c="",d="";_.each(a.data,function(){c+='<li class="ui-tab-item" data-role="trigger"></li>',d+='<div data-role="panel" class="ui-tab-panel fn-clear">'+b+"</div>"});var e=$(a.trigger),f=new k(_.extend({hasMask:!1,width:280,height:415,className:"fs-contact-dialog",content:'<div class="fs-contact-content"><div class="fs-contact-tabs ui-tab"><ul class="ui-switchable-nav ui-tab-items" data-role="nav">'+c+'</ul><div class="ui-switchable-content">'+d+"</div></div>"+'<div class="fs-contact-bbar fn-clear"><div class="fs-contact-summary">共有<span class="num">0</span>位同事</div><div class="fs-contact-action"><button class="fs-contact-close-btn">关闭</button></div></div>'+"</div>",align:{selfXY:["right",0],baseElement:e,baseXY:[e.width(),e.height()]},zIndex:2e3},a.dialogOpts||{})).render(),g=new l(_.extend({element:$(".fs-contact-tabs",f.element),triggers:$(".ui-tab-item",f.element),panels:$(".ui-tab-panel",f.element),activeIndex:0,triggerType:"click",withTabEffect:!1},a.tabOpts||{})).render();this.opts=a,this.dialog=f,this.tab=g,E.ins.push(this),$(".fs-contact-list-wrapper",f.element).each(function(){new r({element:$(this)})}),this.init()};_.extend(E.prototype,{init:function(){var a=this,b=this.opts,c=b.data;_.each(c,function(b,c){a.updateTab(b,c)}),this.bindEvents()},updateData:function(a){var b=this;_.each(a,function(a,c){b.updateTab(a,c)})},updateTab:function(a,b){var c=a.title,d=a.type;a.list;var e=(this.dialog,this.tab),f=e.get("triggers").eq(b),g=e.get("panels").eq(b);f.html('<a href="javascript:;">'+c+"</a>"),g.attr("emptype",d),this.doTabPanel(g,a)},doTabPanel:function(a,b){var c,d,e,f,g=$(a),c=$(".fs-contact-letter-nav",g),h=$(".fs-contact-list",g),i="",j=b.list,k=b.sortType||"letter",l=b.unitSuffix||"位同事";for(c.html('<ul class="list-0"></ul><ul class="list-1"></ul>'),d=65;77>=d;d++)i+="<li>"+String.fromCharCode(d)+"</li>";for($(".list-0",c).html(i),i="",d=78;90>=d;d++)i+="<li>"+String.fromCharCode(d)+"</li>";$(".list-1",c).html(i),c=$("li",c),i="","letter"==k?(e=this.groupByLetter(j),f=_.sortBy(_.keys(e),function(a){return a}),_.each(f,function(a){var b=e[a],d=b.length,f="";i+='<li><div class="index-box fn-clear"><div class="index-keyword">'+a+'</div><div class="item-length">'+d+'项</div></div><ul class="fs-contact-view">',_.each(b,function(a){f+='<li class="fs-contact-item" itemid="'+a.id+'">'+a.name+"</li>"}),i+=f+"</ul></li>",c.each(function(){var b=$(this),c=b.text();c==a&&b.addClass("fs-contact-letter-selected")})}),h.html(i)):"origin"==k&&(i+='<ul class="fs-contact-view">',_.each(j,function(a){i+='<li class="fs-contact-item" itemid="'+a.id+'">'+a.name+"</li>"}),i+="</ul>",h.html(i)),g.data("unitSuffix",l),this.updateSummary()},show:function(a){var b=this.opts,c=b.dialogOpts||{},d=$(this.opts.trigger);this.dialog.set("align",_.extend({selfXY:["right",0],baseElement:d,baseXY:[d.width(),d.height()]},c.align||{})),this.dialog.show(),a!==!1&&this.trigger("show")},hide:function(a){this.dialog.hide(),a!==!1&&this.trigger("hide")},groupByLetter:function(a){var b=[];return b=_.groupBy(a,function(a){return a.spell.slice(0,1).toUpperCase()})},updateSummary:function(){var a=this.tab,b=this.dialog,c=b.element,d=a.get("panels").eq(a.get("activeIndex")),e=$(".fs-contact-item",d),f=e.filter(".fs-contact-item-selected"),g=$(".fs-contact-summary",c),h=d.data("unitSuffix");f.length>0?g.html("已选中"+f.length+"/"+e.length):g.html("共有"+e.length+h)},select:function(a,b,c){var d,e=this.opts,f=this.tab,g=f.element,h=f.get("panels"),i={};a=[].concat(a),"all"==b?(d=$(".fs-contact-item",g),h.each(function(){var a=$(this),b=a.attr("emptype");i[b]=[]})):(d=$(".fs-contact-item",$('[emptype="'+b+'"]',g)),i[h.filter('[emptype="'+b+'"]').attr("emptype")]=[]),"all"==a[0]?(d.addClass("fs-contact-item-selected"),d.each(function(){var a=$(this),b=a.closest(".ui-tab-panel"),c=a.attr("itemid"),d=b.attr("emptype");i[d].push({name:a.text(),id:c})})):_.each(a,function(a){var b=d.filter('[itemid="'+a+'"]');b.addClass("fs-contact-item-selected"),b.each(function(){var a=$(this),b=a.closest(".ui-tab-panel"),c=a.attr("itemid"),d=b.attr("emptype");i[d].push({name:a.text(),id:c})})}),e.singleCked&&this.hide(),c||this.trigger("select",i)},unselect:function(a,b,c){var d,e=this.tab,f=e.element,g=e.get("panels"),h={};a=[].concat(a),"all"==b?(d=$(".fs-contact-item",f),g.each(function(){var a=$(this),b=a.attr("emptype");h[b]=[]})):(d=$(".fs-contact-item",$('[emptype="'+b+'"]',f)),h[b]=[]),"all"==a[0]?(d.removeClass("fs-contact-item-selected"),d.each(function(){var a=$(this),b=a.closest(".ui-tab-panel"),c=a.attr("itemid"),d=b.attr("emptype");h[d].push({name:a.text(),id:c})})):_.each(a,function(a){var b=d.filter('[itemid="'+a+'"]');b.removeClass("fs-contact-item-selected"),b.each(function(){var a=$(this),b=a.closest(".ui-tab-panel"),c=a.attr("itemid"),d=b.attr("emptype");h[d].push({name:a.text(),id:c})})}),c||this.trigger("unselect",h)},bindEvents:function(){var a=this,b=this.tab,c=b.element,d=this.dialog,e=d.element,g=this.opts,h=$(g.trigger);c.on("click",".fs-contact-item",function(){var b=$(this),c=b.closest(".ui-tab-panel"),d=b.attr("itemid"),e=c.attr("emptype");b.hasClass("fs-contact-item-selected")?a.unselect(d,e):(g.singleCked&&a.unselect("all","all"),a.select(d,e)),a.updateSummary()}),b.on("switched",function(c){var d=b.get("panels").eq(c),e=$(".fs-contact-list-wrapper",d);a.updateSummary(),e.data("ins").update()}),d.after("show",function(){var a=this.element,b=$(".fs-contact-list-wrapper",a);b.data("ins").update()}),e.click(function(a){a.stopPropagation()}),e.on("click",".fs-contact-close-btn",function(){a.hide()}),c.on("click",".fs-contact-letter-selected",function(){var a,b=$(this),c=b.text(),d=b.closest(".ui-tab-panel").find(".fs-contact-list-wrapper"),e=$(".fs-contact-list",d);$("li",e).each(function(){var b=$(this),d=$(".index-keyword",b);return d.text()==c?(a=b,!1):void 0}),a&&d.data("ins").update(a.position().top)}),h.click(function(b){_.each(_.filter(E.ins,function(b){return b!==a}),function(a){a.hide()}),a.dialog.element.is(":visible")?a.hide():a.show(),a.updateSummary(),b.preventDefault()}),f.regGlobalClick(this.dialog.element,function(b){var c=$(b.target);h.length>0&&!$.contains(h[0],c[0])&&h[0]!==c[0]&&a.dialog.element.is(":visible")&&a.hide()})},destroy:function(){var a=this,b=this.opts;this.dialog.destroy(),this.tab.destroy(),this.off(),$(b.trigger).unbind("click"),E.ins=_.filter(E.ins,function(b){return b!==a})}}),E.ins=[],j.mixTo(E);var F=function(a){a=_.extend({element:null,data:null,title:"",autoCompleteTitle:"",acTpl:"",singleCked:!1,defaultSelectedData:[]},a||{});var b,d=$(a.element),e=this,g="",h=u.filter(".publish-ac");0==a.acTpl.length?(h=u.filter(".publish-ac"),$(".fs-publish-ac-title",h).html(a.autoCompleteTitle),g=h.html()):g=a.acTpl,$(".fs-publish-ac-title",h).html(a.autoCompleteTitle),this.opts=a,this.element=d,b=this.getAcData(),d.length>0&&(d.each(function(){var d,h,i,j=$(this);j.html('<div class="fs-contact-bar fn-clear"><div class="fs-contact-bar-content fn-clear"><ul class="fs-contact-bar-list"></ul><div class="input-wrapper"><span class="input-tip"><i class="prefix">+</i>'+a.title+'</span><input class="input-field" type="text" /></div></div><em class="show-select-panel-h">&nbsp;</em></div>'),h=new n({trigger:$(".input-field",j),template:g,delay:0,submitOnEnter:!1,dataSource:b.slice(0),zIndex:2e3,initDataSource:a.acInitData,className:"fs-contact-bar-ac",selectFirst:!0}).render(),i=h.get("filter"),i.func=function(a,b){var c=e.getSelectedData(j),d=m.stringMatch,f=m.startsWith,g=[],i=d.apply(this,[a,b,{key:"name"}]),k=f.apply(this,[a,b.toLowerCase(),{key:"spell"}]);return _.each(k,function(a){_.find(i,function(b){return b.id==a.id})||g.push(a)}),g=g.concat(i),_.each(c,function(a,b){_.each(a,function(a){g=_.reject(g,function(c){return c.type==b&&c.id==a?!0:void 0})})}),h.model.query=b,h.renderPartial(".ac-title"),g},h.set("filter",i),h.on("itemSelect",function(b){a.singleCked&&e.removeAllItem(j),e.addItem(b,j),e.switchInputState(j,"hide")}),h.after("show",function(){var a,b,d,e,f,g=$(".ui-autocomplete-init-panel",h.element),i=$(".ui-autocomplete-query .ui-autocomplete-ctn",h.element);g.css({height:"auto",overflow:"auto"}),i.css({height:"auto",overflow:"auto"}),g.is(":visible")?(a=g.offset(),b=g.height(),e=$(c).height(),f=$(c).scrollTop(),a.top+b>e+f&&(d=e-a.top+f-10,g.height(d>180?d:180))):(a=i.offset(),b=i.height(),e=$(c).height(),f=$(c).scrollTop(),a.top+b>e+f&&(d=e-a.top+f-30,i.height(d>180?d:180)))}),h.element.on("click",function(a){a.stopPropagation()}),d=new E({trigger:$(".show-select-panel-h",j),data:a.data,singleCked:a.singleCked}),d.on("show",function(){var b=$(".show-select-panel-h",j),c=e.getSelectedData(j);d.unselect("all","all",!0),_.each(c,function(a,b){d.select(a,b,!0)}),a.singleCked&&d.show(!1),b.addClass("show-select-panel-h-up")}),d.on("hide",function(){var a=$(".show-select-panel-h",j);a.removeClass("show-select-panel-h-up")}),d.on("select",function(a){_.each(a,function(a,b){_.each(a,function(a){e.addItem({type:b,id:a.id,name:a.name},j)})})}),d.on("unselect",function(a){_.each(a,function(a,b){_.each(a,function(a){e.removeItem({type:b,id:a.id,name:a.name},j)})})}),j.on("click",".fs-contact-bar-content",function(a){$("body").click(),e.switchInputState(j,"show"),d.hide(),a.stopPropagation()}).on("click",".fs-contact-bar-list,.input-field",function(a){a.stopPropagation()}),$(".input-field",j).keydown(function(a){var b=$(this),c=$(".fs-contact-bar-list",j),d=$(".fs-contact-bar-item",c).slice(-1),f=_.str.trim(b.val());0==f.length&&d.length>0&&8==a.keyCode&&e.removeItem({id:d.attr("itemid"),type:d.attr("emptype")},j)}),f.regGlobalClick(j,function(){e.switchInputState(j,"hide")}),j.on("click",".fs-contact-bar-list .remove-h",function(){var a=$(this),b=a.closest(".fs-contact-bar-item"),c=b.attr("itemid"),f=b.attr("emptype");e.removeItem({id:c,type:f},j),d.hide()}),a.defaultSelectedData.length>0&&_.each(a.defaultSelectedData,function(a){var b=e.getItemData(a.id,a.type);b&&e.addItem(b,j)}),j.data("ins",{ac:h,selectPanel:d})}),this.on("add",function(b,c){a.acInitData&&e.updateAcState(c,a.acInitData)}),this.on("remove",function(b,c){a.acInitData&&e.updateAcState(c,a.acInitData)}))};j.mixTo(F),F.prototype.updateData=function(a){var b,c=this.opts,d=this.element;c.data=a,b=this.getAcData(),d.each(function(){var c=$(this),d=c.data("ins"),e=d.ac,f=d.selectPanel;e.dataSource.set("source",b),f.updateData(a)})},F.prototype.getAcData=function(){var a,b=this.opts,c=b.data,d=[];return _.each(c,function(b){a=b.type,_.each(b.list,function(b){d.push({name:b.name,id:b.id,spell:b.spell.toLowerCase(),type:a})})}),d},F.prototype.setAcInitData=function(a,b){var c=this.getEl(b),d=c.data("ins").ac;d.set("initDataSource",a)},F.prototype.addItem=function(a,b){var c,d,e=this.getEl(b),f=$(".fs-contact-bar-list",e),g=a.valueType||a.type,h="";d=$('[itemid="'+a.id+'"]',f).filter('[emptype="'+g+'"]'),0==d.length&&("g"==g&&(h=" fs-cbi-dept",999999==parseInt(a.id)&&(h=" fs-cbi-allcomp")),c='<li class="fs-contact-bar-item'+h+'" itemid="'+a.id+'" emptype="'+g+'"><span class="item-name">'+a.name+'</span><span class="remove-h">×</span></li>',$(c).appendTo(f),this.trigger("add",a,b))},F.prototype.removeItem=function(a,b){var c,d=this.getEl(b),e=$(".fs-contact-bar-list",d),f=a.valueType||a.type;c=$('[itemid="'+a.id+'"]',e).filter('[emptype="'+f+'"]'),c.length>0&&(c.remove(),this.trigger("remove",a,b))},F.prototype.removeAllItem=function(a){var b=this,c=this.getEl(a),d=$(".fs-contact-bar-list",c),e=$(".fs-contact-bar-item",d);e.each(function(){var a=$(this);b.removeItem({id:a.attr("itemid"),type:a.attr("emptype")},c)})},F.prototype.switchInputState=function(a,b){var c,d,e,f;b?c=this.getEl(a):(b=a,c=this.getEl()),d=$(".input-wrapper",c),e=$(".input-tip",d),f=$(".input-field",d);var g=c.data("ins");b=b||"show","show"==b?(e.hide(),f.show(),setTimeout(function(){f.get(0).focus()},0),this.trigger("inputshow")):"hide"==b&&(e.show(),f.val("").hide(),g.ac.hide(),this.trigger("inputhide"))},F.prototype.getSelectedData=function(a){var b,c={},d=this.getEl(a);return b=$(".fs-contact-bar-item",d),b.length>0&&b.each(function(){var a=$(this),b=a.attr("emptype"),d=a.attr("itemid");c[b]||(c[b]=[]),c[b]=c[b].concat(d.split(","))}),c},F.prototype.getItemData=function(a,b){var c=this.getAcData();return _.find(c,function(c){return c.id==a&&c.type==b?!0:void 0})},F.prototype.updateAcState=function(a,b){var c=this.getEl(a),d=c.data("ins").ac,e=this.getSelectedData(c),g=[];_.each(b,function(a,b){g[b]={parseData:a.parseData,createHtml:a.createHtml,eqFields:a.eqFields,renderCb:a.renderCb},g[b].store=f.deepClone(a.store)}),_.each(e,function(a,b){_.each(a,function(a){_.each(g,function(c){var d=c.parseData,e=c.store;c.store=_.filter(e,function(c){var e;return c?(e=d(c)[0],"mix"==c.type?!0:e.id==a&&e.type==b?!1:!0):void 0})})})}),d.set("initDataSource",g)},F.prototype.getEl=function(a){return a?$(a):this.element.eq(0)},F.prototype.destroy=function(){this.element.each(function(){var a=$(this),b=a.data("ins");b&&b.ac.destroy(),b&&b.selectPanel.destroy()}),this.off(),this.element.removeData(),this.element.empty(),this.element=null};var G=function(){},H=k.extend({attrs:{content:u.filter(".receipt-dialog-tpl").html(),className:"fs-publish-receipt",inputSelector:null,rangeSb:null,submitCb:d.EMPTY_FN,cancelCb:d.EMPTY_FN,zIndex:"1001"},events:{"click .f-sub:enabled":"_submit","click .f-cancel":"_cancel","click .content-at-h.state-active":"_clickContentAt","click .send-range-h.state-active":"_clickSendRange","click .ui-dialog-close":"_cancel"},_renderCpt:function(){var a=this,b=this.element,c=$(".sb-range",b),d=new F({element:c,data:[{title:"部门",type:"g",list:y.g},{title:"同事",type:"p",list:y.p}],title:"选择同事和范围&#8230;",acInitData:f.getPublishRange("receipt"),autoCompleteTitle:"请输入同事的名称或拼音"});d.on("add",function(){a.updateSubmitState()}),d.on("remove",function(){a.updateSubmitState()}),this.sb=d},render:function(){var a=H.superclass.render.apply(this,arguments);return this._renderCpt(),a},show:function(){var a=H.superclass.show.apply(this,arguments);return this._setShortcutData(),a},hide:function(){var a=H.superclass.hide.apply(this,arguments);return this._clear(),a},updateSubmitState:function(){var a=this.element,b=$(".f-sub",a),c=this.sb,d=c.getSelectedData();_.isEmpty(d)?b.addClass("button-state-disabled").prop("disabled",!0):b.removeClass("button-state-disabled").prop("disabled",!1)},_setShortcutData:function(){var a,b,c=this.element,d=$(".content-at-h",c),e=$(".send-range-h",c),g=$(this.get("inputSelector")),h=this.get("rangeSb"),i=[],j=[];g.length>0&&(a=f.getAtFromInput(g),_.each(a,function(a){var b=f.getContactDataByName(a,"g");b||(b=f.getContactDataByName(a,"p")),b&&(_.some(i,function(a){return a.id==b.id})||i.push(b))})),h&&(b=h.getSelectedData(),_.each(b.p,function(a){j.push(f.getContactDataById(a,"p"))}),_.each(b.g,function(a){j.push(f.getContactDataById(a,"g"))})),this.shortcutData={atData:i,rangeData:j},i.length>0?(d.addClass("state-active"),$(".num",d).text(i.length)):(d.removeClass("state-active"),$(".num",d).text(0)),j.length>0?(e.addClass("state-active"),$(".num",e).text(j.length)):(e.removeClass("state-active"),$(".num",e).text(0))},_clickContentAt:function(){var a=this.shortcutData,b=a.atData,c=this.sb;_.each(b,function(a){c.addItem(a)})},_clickSendRange:function(){var a=this.shortcutData,b=a.rangeData,c=this.sb;_.each(b,function(a){c.addItem(a)})},_clear:function(){var a=this.element,b=$(".content-at-h",a),c=$(".send-range-h",a),d=$(".is-sms-send",a),e=this.sb;e.removeAllItem(),this.shortcutData=null,b.removeClass("state-active"),$(".num",b).text("0"),c.removeClass("state-active"),$(".num",c).text("0"),d.prop("checked",!1)},_getReceiptConfig:function(){var a=this.sb,b=a.getSelectedData(),c=b.p||[],d=b.g||[],e=d.join(",")+"|"+c.join(","),g="",h=f.getPersonalConfig("receiptEmployees")||[],i=f.getPersonalConfig("receiptRanges")||[];return _.each(c,function(a){var b=f.getContactDataById(a,"p");h=_.filter(h,function(b){return b.dataID!=a}),h.unshift({dataID:a,isCircle:!1,name:b.name}),h.length>5&&h.pop()}),d.length+c.length>1&&(i=_.filter(i,function(a){return a.dataIDs!=e}),_.each(d,function(a){var b=f.getContactDataById(a,"g");g+=b.name+","}),_.each(c,function(a){var b=f.getContactDataById(a,"p");g+=b.name+","}),g.length>0&&(g=g.slice(0,-1)),i.unshift({dataIDs:e,names:g}),i.length>5&&i.pop()),{receiptEmployees:h,receiptRanges:i}},_setReceiptConfig:function(){var a=this._getReceiptConfig();_.each(a,function(a,b){f.setPersonalConfig(b,a)})},_updateReceiptConfig:function(){f.updatePersonalConfig()},_submit:function(){var a=this.get("submitCb"),b=this.sb,c=b.getSelectedData();this._setReceiptConfig(),this._updateReceiptConfig(),a&&a.call(this,c)},_cancel:function(){var a=this.get("cancelCb");a&&a.call(this),this.hide()},destroy:function(){var a;return this.sb&&this.sb.destroy(),this.shortcutData=null,a=H.superclass.destroy.apply(this,arguments)}}),I=k.extend({attrs:{content:_.template(u.filter(".my-history-plan-tpl").html())({blankImgSrc:d.BLANK_IMG}),className:"my-history-plan",width:990,height:507,inputSelector:{today:null,tomorrow:null,xdth:null},planType:1},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel","click .nav-l":"_clickNavLeft","click .nav-r":"_clickNavRight"},setup:function(){var a;return a=I.superclass.setup.apply(this,arguments)},_renderCpt:function(){var a=this,b=this.element,c=$(".switch-l",b),d=$(".user-name",b),e=$(".user-avatar",b),g=$(".media",b),h=$(".publish-input",b),i=$(".publish-topic-tip",b),j=new E({trigger:c,data:[{title:"同事",type:"p",list:y.p}],singleCked:!0,dialogOpts:{align:{selfXY:[0,0],baseElement:c,baseXY:[0,20]}}});j.on("select",function(b){var c=b.p,g=c[0];g=f.getContactDataById(g.id,"p"),d.attr("employeeid",g.id).text(g.name),e.attr("src",f.getAvatarLink(g.profileImagePath,3)),j.unselect(g.id,"p"),a._updateHistory({feedID:0,isForward:!0})});var k=new B({element:g,action:["at","topic"],actionOpts:{at:{inputSelector:h},topic:{inputSelector:h}}}),l=new z({element:h});h.keyup(function(){var a=$(this),b=_.str.trim(a.val());a.attr("name"),/#[^\n]+?#/g.test(b)?i.slideDown(200):i.slideUp(200)}),this.after("show",function(){h.keyup()}),this.sp=j,this.media=k,this.atInput=l},render:function(){var a;return a=I.superclass.render.apply(this,arguments),this._renderCpt(),a},_submit:function(){var a=this.element,b=$(".today-input",a),c=$(".tomorrow-input",a),d=$(".xdth-input",a),e=this.get("inputSelector");$(e.today).val(b.val()).keyup().change().trigger("autosize.resize"),$(e.tomorrow).val(c.val()).keyup().change().trigger("autosize.resize"),$(e.xdth).val(d.val()).keyup().change().trigger("autosize.resize"),this.hide()},_cancel:function(){this.hide()},show:function(){var a;return a=I.superclass.show.apply(this,arguments),this._resetState(),a},_clickNavLeft:function(a){var b=$(a.currentTarget);b.hasClass("state-disabled")||this._updateHistory({isForward:!0})},_clickNavRight:function(a){var b=$(a.currentTarget);b.hasClass("state-disabled")||this._updateHistory({isForward:!1})},_resetState:function(){var a=y.u,b=this.sp;this.currentFeedId=0,b.select(a.id,"p"),this._updateEditContent()},_updateHistory:function(a){var b=this,c=this.element,d=$(".user-name",c),e=$(".nav-l",c),g=$(".nav-r",c),h=$(".show-area",c),j=d.attr("employeeid");f.api({url:"/Feed/GetSomeOnePlanWithForwardOrBackward",type:"get",data:_.extend({employeeID:j,feedID:this.currentFeedId||0,planType:b.get("planType"),isForward:!1},a),success:function(a){var c,d;a.success&&(c=a.value,b.currentFeedId=c.feedID,b._renderHisPlan(c,a),g.addClass("state-disabled"),e.addClass("state-disabled"),c.hasForward&&e.removeClass("state-disabled"),c.hasBackward&&g.removeClass("state-disabled"),d=0==c.createTime?i():i.unix(c.createTime),h.text(d.format("MM月DD日（dddd）")))}})},_renderHisPlan:function(a,b){var c=this.element,e=$(".plan-content",c),g=a.report||"",h=a.planContent||"",j=a.feedContent||"",k="",l=this._getPlanTypeName(),m=a.commentContent,n="",o="",p="",q="",r="",s="",t="",u="以下为日志点评人的点评";_.each([{title:l[0]+"工作总结",content:g},{title:l[1]+"工作计划",content:h},{title:"工作心得体会",content:j}],function(a){k+='<li class="content-item"><div class="content-item-title">'+a.title+'</div><div class="content-item-text">'+a.content.replace(/[\n\r]/g,"<br/>").replace(new RegExp(" ","g"),"&nbsp;")+"</div></li>"}),0==g.length&&0==h.length&&0==j.length?k='<div class="content-empty-tip"><img class="empty-icon" src="'+d.BLANK_IMG+'" />&nbsp;<span>没有内容</span></div>':(m?(p=f.getDateSummaryDesc(i.unix(a.replyTime),i.unix(b.serviceTime),1),s=m,r=a.leader.profileImage,o=a.leader.name,q=a.leader.employeeID,n='<dl class="comment-list fn-clear"><dt><a class="master-reply-face-l" href="javascript:void(0);"><a href="javascript:;"><img src = "'+f.getAvatarLink(r,"3")+'" / ></a></a></dt><dd><span class="color-blue">'+o+"</span>："+s+" ("+p+"，点评)</dd></dl>",t='<div class="fs-list-item"><div class="reply-content"><div class="RC-arrow"><em class="S_line1_c">◆</em><span>◆</span></div><div class="RC-tit">'+u+'</div><div class="RC-feed">'+n+"</div></div></div>"):t="",k='<ul class="content-list">'+k+t+"</ul>"),e.html(k)},_getPlanTypeName:function(a){a=a||this.get("planType");var b=[];switch(a){case 1:b[0]="今日",b[1]="明日";break;case 2:b[0]="本周",b[1]="下周";break;case 3:b[0]="本月",b[1]="下月"}return b},_onRenderPlanType:function(a){var b=this.element,c=$(".body-r",b),d=$(".plan-type-name",c),e=this._getPlanTypeName(a);d.each(function(a){$(this).text(e[a])})},_updateEditContent:function(){var a=this.element,b=$(".today-input",a),c=$(".tomorrow-input",a),d=$(".xdth-input",a),e=this.get("inputSelector");b.val($(e.today).val()).trigger("autosize.resize"),c.val($(e.tomorrow).val()).trigger("autosize.resize"),d.val($(e.xdth).val()).trigger("autosize.resize")},destroy:function(){var a;return this.sp&&this.sp.destroy(),this.sp=null,this.media&&this.media.destroy(),this.media=null,this.atInput&&this.atInput.destroy(),this.atInput=null,a=I.superclass.destroy.apply(this,arguments)}}),J=function(a){a=_.extend({element:null},a||{}),this.element=$(a.element),this.opts=a,this.init()};_.extend(J.prototype,{init:function(){var a,b,c,e,f=this,g=this.element;g.addClass("fs-publish-search-input").wrap('<span class="fs-publish-search"></span>'),a=g.closest(".fs-publish-search"),b=$('<img src="'+d.BLANK_IMG+'" class="icon-search" />'),b.appendTo(a),c=$('<span class="icon-clear fn-hide">&#10005;</span>'),c.appendTo(a),e=g.height(),g.width(g.width()-44),b.height(e),c.height(e),c.css({"line-height":e+"px"}),a.on("keyup",".fs-publish-search-input",function(){var a=_.str.trim($(this).val());a.length>0?(c.show(),g.addClass("with-input-value")):(c.hide(),g.removeClass("with-input-value"))}).on("keydown",".fs-publish-search-input",function(a){13==a.keyCode&&f.trigger("search",f.getValue())}).on("click",".icon-clear",function(){g.val(""),c.hide()}).on("click",".icon-search",function(){f.trigger("search",f.getValue())})},getValue:function(){return _.str.trim(this.element.val())},setValue:function(a){var b=this.element;b.val(a)},clear:function(){var a=this.element,b=a.closest(".fs-publish-search"),c=$(".icon-clear",b);a.val(""),c.hide()},destroy:function(){var a=this.element,b=a.closest(".fs-publish-search");b.off(),a.insertAfter(b),b.remove()}}),j.mixTo(J);var K=k.extend({attrs:{width:300,className:"fs-publish-fpv-dialog",content:u.filter(".fs-publish-fpv-tpl").html(),defaultRequestData:{},successCb:d.EMPTY_FN,cancelCb:d.EMPTY_FN},events:{"keydown .feed-pwd":"_keydownPwd","click .f-sub":"_submit","click .f-cancel":"_cancel"},hide:function(){var a=K.superclass.hide.apply(this,arguments);return this._clear(),a},getRequestData:function(){var a=this.element,b=$(".feed-pwd",a),c=_.extend({feedID:0,password:_.str.trim(b.val())},this.get("defaultRequestData"));return c},isValid:function(){var a=this.element,b=$(".feed-pwd",a);return 0==_.str.trim(b.val()).length?(f.showInputError(b),!1):!0},_clear:function(){var a=this.element,b=$(".feed-pwd",a);b.val("")},_submit:function(a){var b=this,c=this.getRequestData(),d=$(a.currentTarget);this.isValid()&&f.api({data:c,url:"/FeedExtend/CheckPasswords",success:function(a){a.success&&(b.get("successCb").apply(b,[a,c]),b.hide())}},{submitSelector:d})},_keydownPwd:function(a){var b=this.element,c=$(".f-sub",b);13==a.keyCode&&(c.click(),a.preventDefault())},_cancel:function(){this.hide(),this.get("cancelCb").call(this)}}),L=function(a,b,c){var e=L.pwdDialog;e||(e=new K),e.set("successCb",function(){a&&a.apply(this,arguments),e.set("successCb",d.EMPTY_FN),e.set("defaultRequestData",{})}),e.set("cancelCb",function(){b&&b.apply(this,arguments),e.set("cancelCb",d.EMPTY_FN),e.set("defaultRequestData",{})}),e.set("defaultRequestData",c||{}),e.show()};_.extend(b,{progressBar:D,atInput:z,selectPanel:E,selectBar:F,mediaMaker:B,inputAutoHeight:G,dateSelect:t.DateSelect,timeSelect:t.TimeSelect,Receipt:H,MyHistoryPlan:I,SearchInput:J,showFeedPwdValid:L}),b.atInput=z});