/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/publish/publish-bak20130725",["util","detector","json","moment","events","overlay","dialog","uilibs/tabs","filter","autocomplete","select","placeholder","calendar","swfupload","fsupload","modules/publish/publish.html","modules/publish/publish.css"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.store,e.event;var f=a("util"),g=(a("detector"),a("json")),h=a("moment"),i=a("events"),j=a("overlay"),k=a("dialog"),l=a("uilibs/tabs"),m=a("filter"),n=a("autocomplete"),o=a("select"),p=a("placeholder"),q=a("calendar"),r=a("swfupload"),s=a("fsupload"),t=a("modules/publish/publish.html");a("modules/publish/publish.css");var u=$(t);d.BASE_PATH+"/Files/Temp";var v=f.getContactData(),w=function(a){var b;a=_.extend({element:null,data:f.getContactData().p},a||{}),b=$(a.element),this.element=b,f.asyncOrder(["stylelibs/jquery.atwho.css","jslibs/jquery.atwho.min.js","jslibs/jquery.atwho.custom.js","jslibs/jquery.autosize.js"],function(){var c=m.stringMatch;b.atwho("@",{data:a.data,callbacks:{filter:function(a,b){var d,e,g=[];if(0==_.str.trim(a).length){var h=f.getPersonalConfig("lastAtEmployees");_.each(h,function(a){var b=f.getContactDataById(a.dataID,"p");g.push(b)})}else d=c.apply(this,[b,a,{key:"name"}]),e=c.apply(this,[b,a.toLowerCase(),{key:"spell"}]),_.each(e,function(a){_.find(d,function(b){return b.id==a.id})||g.push(a)}),g=g.concat(d);return g},matcher:function(a,b){var c,d,e;return e=new RegExp(a+"([\\S]*)$","gi"),c=e.exec(b),d=null,c&&(d=c[2]?c[2]:c[1]),d}}}).addClass("fs-publish-input"),b.atwho("#",{data:a.data,callbacks:{filter:function(a,b){var d,e,g=[];if(0==_.str.trim(a).length){var h=f.getPersonalConfig("lastAtEmployees");_.each(h,function(a){var b=f.getContactDataById(a.dataID,"p");g.push(b)})}else d=c.apply(this,[b,a,{key:"name"}]),e=c.apply(this,[b,a.toLowerCase(),{key:"spell"}]),_.each(e,function(a){_.find(d,function(b){return b.id==a.id})||g.push(a)}),g=g.concat(d);return g},matcher:function(a,b){var c,d,e,f=this.$inputor.val(),g=f.slice(b.length,b.length+1),h=b.split(/\n/),i=0;e=new RegExp(a+"([^\\s|^#]*)$","gi"),c=e.exec(b),h=h[h.length-1].split("");for(var j=0,k=h.length;k>j;j++)"#"==h[j]&&i++;return d=null,1==i%2&&"#"==g&&c&&(d=c[2]?c[2]:c[1]),d}}}),b.addClass("autosize-animated").autosize()})};_.extend(w.prototype,{destroy:function(){this.element.trigger("autosize.destroy").removeClass("autosize-animated")}});var x=k.extend({attrs:{className:"fs-publish-g-upload-dialog",content:u.filter(".global-upload-dialog-wrapper").html(),media:null,actionModel:"attach",zIndex:1001},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel","click .remove-l":"_removeFile"},render:function(){var a=x.superclass.render.apply(this,arguments);return this._createUploader(),a},_updateListView:function(){var a=this.uploader,b=a.uploadFiles,c=$(".file-item",this.element);c.each(function(){var a=$(this),c=a.attr("fileid");_.find(b,function(a){return a.id==c})||a.remove()})},show:function(){var a,b=this.uploader,c=b.uploadFiles,d=this.element,e=$(".list-body",d),g=this.get("media");return g.id!=this.mediaId&&this.uploading?(f.confirm("有上传操作占用，确定要结束上传吗","确认操作",function(){_.each(c,function(a){b.cancelUpload(a.id,!1)}),b.uploadFiles=[],$("tbody",e).empty(),a=x.superclass.show.apply(this,arguments)}),this.mediaId=g.id):a=x.superclass.show.apply(this,arguments),a},uploadValid:function(){return!0},_updateFileView:function(a,b){var c,d=this.element,e=$(".list-body",d),f=$('[fileid="'+a.id+'"]',e),g=$(".upload-pbar",f);0==f.length&&(f=$('<tr class="file-item" fileid="'+a.id+'"><td class="file-name">'+a.name+'</td><td class="upload-progress"><div class="upload-pbar-wrapper"><div class="upload-pbar"></div></div></td><td class="operation"><a href="#" class="remove-l">删除</a></td></tr>'),f.appendTo($("tbody",e)),g=$(".upload-pbar",f),g.css({width:"100px"}),c=new A({element:g}),g.data("progressBar",c));var h=Math.ceil(100*(b/a.size))+"%";c=g.data("progressBar"),c.setProgress(h)},_syncUploadFile:function(a){var b,c=this.element,d=$(".list-body",c),e=this.get("media"),g=e.gUploadStore,h=this.uploader;b=e.getUploadFile(h,a.id),b.uploadType=f.getUploadType(b.name),g.push(b),h.core.cancelUpload(a.id,!1),e.removeUploadFile(h,a.id),$('[fileid="'+a.id+'"]',d).fadeOut(2e3,function(){$(this).remove()})},_createUploader:function(){var a=this,b=new s({upload_url:d.API_PATH+"/uploadfile_html/fileUpload",file_types:"*.*",file_types_description:"所有格式",button_placeholder_id:"fs-publish-global-upload-btn",button_text:'<span class="upload-text">上传</span>',button_width:50,button_height:20,fileDialogComplete:function(a,b){try{b>0&&this.startUpload()}catch(c){this.debug(c)}},upload_start_handler:function(b){var c=a.get("media"),d=a.get("actionModel"),e=c.uploadStartHandler(b,d,"g");return e&&(a._updateFileView(b,0),a.uploading=!0),e},upload_progress_handler:function(b,c){var d=a.get("media"),e=a.get("actionModel"),f=d.uploadProgressHandler(b,c,e,"g");return a._updateFileView(b,c),f},upload_success_handler:function(b,c){var d=a.get("media"),e=a.get("actionModel"),f=d.uploadSuccessHandler(b,c,e,"g");return a._updateFileView(b,b.size),a._syncUploadFile(b),f},upload_error_handler:function(b,c){var d=a.get("media"),e=a.get("actionModel"),f=d.uploadErrorHandler(b,c,e,"g");return f},upload_complete_handler:function(){var b=a.get("media"),c=a.get("actionModel"),d=b.uploadCompleteHandler(c,"g");return a.uploading=!1,d}});b.uploadFiles=[],b.type="global",b.uploaded=!0,this.uploader=b},_removeFile:function(a){var b=$(a.currentTarget),c=b.closest("tr"),d=c.attr("fileid"),e=this.uploader,f=this.get("actionModel"),g=this.get("media"),h=g.element,i=$(".fs-publish-g"+f+"upload-panel .fs-publish-upload-list",h),j=$('[fileid="'+d+'"]',i);e.core.cancelUpload(d),$(".file-remove-l",j).click(),c.remove(),a.preventDefault()},_submit:function(){this.hide()},_cancel:function(){this.hide()},_onRenderActionModel:function(a){var b=this.uploader;b&&setTimeout(function(){"img"==a?b.core.setFileTypes("*.jpg;*.gif;*.jpeg;*.png","图片"):b.core.setFileTypes("*.*","文件")},500)},destroy:function(){var a;return this.uploader&&this.uploader.destroy(),this.uploader=null,a=x.superclass.destroy.apply(this,arguments)}}),y=function(a){a=_.extend({element:null,action:["imgUpload","attachUpload","vote","at","topic"],actionOpts:{}},a||{}),this.id="media-"+y.idIndex,this.opts=a,this.element=$(a.element),this.init(),this.allUploaded=!0,y.idIndex++};_.extend(y.prototype,{init:function(){var a,b,c=this,d=this.element,e=this.opts;d.html('<div class="fs-publish-action-btns"></div><div class="fs-publish-action-panels"></div>'),a=$(".fs-publish-action-btns",d),b=$(".fs-publish-action-panels",d),_.each(e.action,function(d){var e=d.toLowerCase(),f=$('<a href="#" class="fs-publish-'+e+'-btn fs-publish-media-btn"></a>'),g=$('<div class="fs-publish-media-panel-wrapper"></div>'),h=$('<span class="close-btn">×</span>'),i=$('<div class="fs-publish-'+e+'-panel fs-publish-media-panel"></div>');f.appendTo(a),h.appendTo(g),i.appendTo(g),g.appendTo(b),f.bind("showpanel",function(){g.show()}),h.click(function(){c[d+"Clear"](),g.hide(),c.trigger("closeaction",d)}),c[d].call(c)}),this.on("uploadstart",function(a,b,c,d){this.trigger("uploadprogress",a,b,c,d)}),this.on("uploadprogress",function(a,b,d,e){var f=c[d+"Uploader"],g=f.uploadFiles||[],h=_.find(g,function(c){return c.id==a.id?(_.extend(c,a,{uploadedSize:b}),!0):void 0});h||g.push(_.extend(a,{uploadedSize:b})),f.uploadFiles=g,c.updateUploadInfo(f,e)}),this.on("uploadsuccess",function(a,b,d){var e=c[d+"Uploader"],f=e.uploadFiles||[],h=_.find(f,function(c){return c.id==a.id?(_.extend(c,a,{pathName:g.parse(b).value}),!0):void 0});h||f.push(_.extend(a,{pathName:g.parse(b).value})),e.uploadFiles=f}),this.on("alluploadcomplete",function(){}),this.on("typeuploadcomplete",function(a){var b=!0,d=[c.imgUploader,c.attachUploader,c.gUploader];a.uploaded=!0,d=_.filter(d,function(a){return!!a}),_.find(d,function(a){return a&&a.uploaded===!1?(b=!1,!0):void 0}),b&&(c.allUploaded=!0,c.trigger("alluploadcomplete"))})},getUploadItem:function(a,b){var c=$(b),d=a.name,e=$('[filename="'+d+'"]',c);return 0==e.length&&(e=$('<div class="fs-publish-upload-item" filename="'+d+'" fileid="'+a.id+'"></div>'),e.html('<div class="fs-publish-upload-item-inner fn-clear"><div class="thumb"></div><div class="summary"></div></div><div class="fs-publish-upload-pbar"></div>'),e.appendTo(c)),e},renderUploadItem:function(a,b,c,e){var h=$(c),b=g.parse(b),i=this.getUploadItem(a,h),j=$(".fs-publish-upload-item-inner",i),k=$(".thumb",j),l=$(".summary",j);"img"==e?k.html('<div class="thumb-img"><img src="'+d.BASE_PATH+"/"+b.value+'" alt="'+a.name+'" /></div>'):k.html('<div class="thumb-attach"><img src="'+d.ASSETS_PATH+'/images/clear.gif" alt="'+a.name+'" class="icon-file fs-attach-'+f.getFileType(a)+'-icon" /></div>'),l.html('<p class="file-name">'+a.name+'</p><p class="file-remove-wrapper"><a href="#" class="file-remove-l">取消</a></p>')},renderUploadError:function(a,b,c){var e=$(c),f=this.getUploadItem(a,e),g=$(".fs-publish-upload-item-inner",f),h=$(".thumb",g),i=$(".summary",g);h.html('<img src="'+d.ASSETS_PATH+'/images/error.png" alt="'+a.name+'" />'),i.html('<p class="file-error">上传失败('+b+')，请取消后重试</p><p class="file-remove-wrapper"><a href="#" class="file-remove-l">取消</a></p>')},getUploadStatus:function(a){var b=(a.core,[]),c=a.uploadFiles,d=0,e=0;return _.each(b,function(b){e+=b.size,_.find(c,function(a){return a.id==b.id?(d+=a.uploadedSize,!0):void 0}),b.uploadType=a.type}),{files:b,uploadedSize:d,totalSize:e}},updateUploadInfo:function(a,b){var c=$(b),d=this.gUploadStore,e=this.getUploadStatus(a),g=e.files,h=e.uploadedSize,i=e.totalSize;_.each(d,function(a){h+=a.size,i+=a.size,g.push(a)}),c.html("共添加了"+g.length+"个文件，总大小"+f.getFileSize(i)+'&nbsp;&nbsp;<a href="#" class="file-remove-all-l" title="全部取消">全部取消</a>')},getAllUploadStatus:function(){var a,b=this,c=this.imgUploader,d=this.attachUploader,e=this.gUploader,f=this.gUploadStore,g=0,h=0,i=[];return a=_.filter([c,d,e],function(a){return!!a}),_.each(a,function(a){var c=b.getUploadStatus(a);g+=c.uploadedSize,h+=c.totalSize,i=i.concat(c.files)}),_.each(f,function(a){g+=a.size,h+=a.size,i.push(a)}),{files:i,uploadedSize:g,totalSize:h}},getUploadValue:function(){var a=this.getAllUploadStatus();return a.files},getUploadFile:function(a,b){var c=a.uploadFiles;return _.find(c,function(a){return a.id==b})},removeUploadFile:function(a,b){var c=a.uploadFiles;c=_.filter(c,function(a){return a.id!=b}),a.uploadFiles=c},removeGUploadFile:function(a){var b=this.gUploadStore;b=_.filter(b,function(b){return b.id!=a}),this.gUploadStore=b},uploadValid:function(a,b){var c=!0,d=a.uploadFiles;return _.find(d,function(a){return a.name==b.name?(c=!1,f.alert("有同名文件存在"),!0):void 0}),c},uploadStartHandler:function(a,b,c){c=c||"";var d=this.element,e=$(".fs-publish-"+c+b+"upload-btn",d),f=$(".fs-publish-"+c+b+"upload-panel",d),g=$(".fs-publish-upload-list",f),h=$(".fs-publish-upload-info",f);c=c||b;var i,j,k=this[c+"Uploader"];return this.uploadValid(k,a)?(i=this.getUploadItem(a,g),j=$(".fs-publish-upload-pbar",i),j.css({top:"50px",left:"14px",width:"100px"}),new A({element:j}),this.trigger("uploadstart",a,0,c,h,b),f.is(":hidden")&&e.trigger("showpanel"),this.allUploaded=!1,k.uploaded=!1,void 0):!1},uploadProgressHandler:function(a,b,c,d){d=d||"";var e=this.element,f=$(".fs-publish-"+d+c+"upload-panel",e),g=$(".fs-publish-upload-list",f),h=$(".fs-publish-upload-info",f);d=d||c;var i=Math.ceil(100*(b/a.size))+"%",j=this.getUploadItem(a,g),k=$(".fs-publish-upload-pbar",j),l=k.data("progressBar");l.setProgress(i),this.trigger("uploadprogress",a,b,d,h,c)},uploadSuccessHandler:function(a,b,c,d){d=d||"";var e=this.element,f=$(".fs-publish-"+d+c+"upload-panel",e),g=$(".fs-publish-upload-list",f);$(".fs-publish-upload-info",f),d=d||c;var h=this[d+"Uploader"],i=h.core.getStats(),j=this.getUploadItem(a,g),k=$(".fs-publish-upload-pbar",j);k.hide(),this.renderUploadItem(a,b,g,c),i.files_queued>0&&h.core.startUpload(),this.trigger("uploadsuccess",a,b,d,c)},uploadErrorHandler:function(a,b,c,d){d=d||"";var e=this.element,f=$(".fs-publish-"+d+c+"upload-panel",e),g=$(".fs-publish-upload-list",f);$(".fs-publish-upload-info",f),d=d||c;var h=this[d+"Uploader"],i=h.core.getStats();b==r.UPLOAD_ERROR.FILE_VALIDATION_FAILED?h.core.cancelUpload(a.id,!1):this.renderUploadError(a,b,g),i.files_queued>0&&h.core.startUpload()},uploadCompleteHandler:function(a,b){b=b||a;var c=this[b+"Uploader"],d=c.core.getStats();0==d.files_queued&&this.trigger("typeuploadcomplete",c,a)},uploadInit:function(a){var b,c,e=this,f=this.element,g=$(".fs-publish-"+a+"upload-btn",f),h=$(".fs-publish-"+a+"upload-panel",f),i="fs-publish-upload-"+y.uploadCount;g.html('<span id="'+i+'"></span>'),h.html('<div class="fs-publish-upload-list fn-clear"></div><div class="fs-publish-upload-info color-333333"></div>'),b=$(".fs-publish-upload-list",h),c=$(".fs-publish-upload-info",h),"img"==a?g.attr("title","添加图片（多张）"):g.attr("title","添加附件（多个）"),g.click(function(a){a.preventDefault()}),y.uploadCount++;var j=new s({upload_url:d.API_PATH+"/uploadfile_html/fileUpload",file_types:"img"==a?"*.jpg;*.gif;*.jpeg;*.png":"*.*",file_types_description:"img"==a?"图片格式":"所有格式",button_placeholder_id:i,button_image_url:d.BASE_PATH+"/html/fs/modules/publish/images/icon-upload-"+a+".png",button_width:18,button_height:"img"==a?14:15,fileDialogComplete:function(a,b){try{b>0&&this.startUpload()}catch(c){this.debug(c)}},upload_start_handler:function(b){return e.uploadStartHandler(b,a)},upload_progress_handler:function(b,c){return e.uploadProgressHandler(b,c,a)},upload_success_handler:function(b,c){return e.uploadSuccessHandler(b,c,a)},upload_error_handler:function(b,c){return e.uploadErrorHandler(b,c,a)},upload_complete_handler:function(){return e.uploadCompleteHandler(a)}});j.type=a,j.uploaded=!0,this[a+"Uploader"]=j,h.on("click",".file-remove-l",function(a){var d=$(this),f=d.closest(".fs-publish-upload-item"),g=f.attr("fileid");j.core.cancelUpload(g),f.remove(),e.removeUploadFile(j,g),e.updateUploadInfo(j,c),0==$(".fs-publish-upload-item",b).length&&$(".close-btn",h.closest(".fs-publish-media-panel-wrapper")).click(),a.preventDefault()}).on("click",".file-remove-all-l",function(a){$(".file-remove-l",h).click(),a.preventDefault()})},imgUpload:function(){this.uploadInit("img")},imgUploadClear:function(){var a=this.element,b=$(".fs-publish-imgupload-panel",a),c=$(".fs-publish-upload-list",b),d=$(".fs-publish-upload-info",b);c.empty(),d.empty(),this.imgUpload.uploadFiles=[]},attachUpload:function(){this.uploadInit("attach")},attachUploadClear:function(){var a=this.element,b=$(".fs-publish-attachupload-panel",a),c=$(".fs-publish-upload-list",b),d=$(".fs-publish-upload-info",b);c.empty(),d.empty(),this.attachUpload.uploadFiles=[]},getGUploadDialog:function(){var a=y.gUploadDia;return a.rendered||a.render(),this.gUploader||(this.gUploader=a.uploader,this.gUploadStore=[]),a},gUploadInit:function(a){var b=this,c=this.getGUploadDialog(),e=this.gUploader,f=this.opts;f.actionOpts;var g,h,i=this.element,j=$(".fs-publish-g"+a+"upload-btn",i),k=$(".fs-publish-g"+a+"upload-panel",i);j.html('<img src="'+d.BLANK_IMG+'" alt="upload" />'),k.html('<div class="fs-publish-upload-list fn-clear"></div><div class="fs-publish-upload-info color-333333"></div>'),g=$(".fs-publish-upload-list",k),h=$(".fs-publish-upload-info",k),"img"==a?j.attr("title","添加图片（多张）"):j.attr("title","添加附件（多个）"),j.click(function(d){c.set("media",b),c.set("actionModel",a),c.show(),d.preventDefault()}),k.on("click",".file-remove-l",function(a){var c=$(this),d=c.closest(".fs-publish-upload-item"),f=d.attr("fileid");e.core.cancelUpload(f),d.remove(),b.removeUploadFile(e,f),b.removeGUploadFile(f),b.updateUploadInfo(e,h),0==$(".fs-publish-upload-item",g).length&&$(".close-btn",k.closest(".fs-publish-media-panel-wrapper")).click(),a.preventDefault()}).on("click",".file-remove-all-l",function(a){$(".file-remove-l",k).click(),a.preventDefault()})},gImgUpload:function(){this.gUploadInit("img")},gImgUploadClear:function(){this.gUploadClear("img")},gAttachUpload:function(){this.gUploadInit("attach")},gAttachUploadClear:function(){this.gUploadClear("attach")},gUploadClear:function(a){var b=this.element,c=$(".fs-publish-g"+a+"upload-panel",b),d=$(".fs-publish-upload-list",c),e=$(".fs-publish-upload-info",c);d.empty(),e.empty(),this.gUploadStore=[]},vote:function(){var a,b=this.opts,c=b.actionOpts,e=c.vote||{},g=e.contactData,h=this.element,i=$(".fs-publish-vote-btn",h),j=$(".fs-publish-vote-panel",h),k=u.filter(".vote-wrapper").html();j.html(k),i.html('<img src="'+d.BLANK_IMG+'" alt="vote" />'),a=$(".vote",j),i.attr("title","添加投票"),f.placeholder($("[placeholder]",a));var l=$(".custom-range",a),m=new C({element:l,data:[{title:"同事",type:"p",list:g}],singleCked:!1,title:"选择投票后可见人",autoCompleteTitle:"请输入姓名或拼音"});l.data("sb",m);var n,o,p=$(".deadline-ticks",a),q=$(".dealine-date-time",a),r=$(".date-wrapper",q),s=$(".time-wrapper",q);n=new E({element:r,placeholder:"请选择日期"}),o=new F({element:s,placeholder:"请选择时间"}),n.on("change",function(){""==o.getValue()&&o.selector.select(0)}),q.data("ds",n),q.data("ts",o);var t=$(".add-vote-option-l",a),v=$(".option-wrapper",a),w=$(".option-tpl",a),x=_.template(w.html());t.click(function(a){var b,c=$(".option-item",v).length+1;b=x({index:c}),$(b).appendTo(v),a.preventDefault()}),v.on("click",".remove-l",function(){var a=$(this),b=a.closest(".option-item");b.remove(),$(".option-index",v).each(function(a){$(this).text(a+1+"、")}),$(".vote-option",v).change()}),p.change(function(){var a=$(this).val();"0"==a?q.show():q.hide()}).change(),$(".result-view-type",a).click(function(){var b=$(this),c=$(".custom-range",a);"3"==b.val()?c.show():c.hide()}).eq(0).click(),v.on("change",".vote-option",function(){var b=$(".vote-option",v),c=$(".vote-count",a),d=c.val(),e=0;b.each(function(){_.str.trim($(this).val()).length>0&&e++}),1>e&&(e=1);for(var f="",g=1;e>=g;g++)f+=1==g?'<option value="1">单选</option>':'<option value="'+g+'">最多选'+g+"个项目</option>";c.html(f).val(d)}),i.click(function(a){$(this).trigger("showpanel"),a.preventDefault()})},voteClear:function(){var a=this.voteGetValue();a.employeeIDs.element.removeAllItem(),a.title.element.val(""),a.voteOptions.element.each(function(){var a=$(this),b=a.closest(".option-item");$(".remove-l",b).length>0?b.remove():a.val("")}).change(),a.voteCount.element.val("1"),a.deadlineTicks.element.val("1").change(),a.isAnoymouse.element.prop("checked",!1)},voteIsValid:function(){var a=!0,b=this.voteGetValue(),c=b.voteOptions,d=c.value;return 0==b.title.value.length?(f.alert("投票标题不能为空"),a=!1):b.title.value.length>25?(f.alert("投票标题不能超过25个字符"),a=!1):d.length<2?(f.alert("至少两个投票选项"),a=!1):0==b.deadlineTicks.value.length?(f.alert("请设置自定义截止时间"),a=!1):"3"==b.resultViewType.value?(0==b.employeeIDs.value.length&&(f.alert("请选择自定义范围"),a=!1),a):a},voteGetValue:function(){var a,b,c,d={},e=this.element,f=$(".fs-publish-vote-panel",e),g=$(".vote",f),i=$(".vote-title",g),j=$(".vote-option",g),k=$(".vote-count",g),l=$(".deadline-ticks",g),m=$(".dealine-date-time",g),n=$(".is-anoymouse",g),o=$(".result-view-type",g),p=$(".custom-range",g),q=p.data("sb"),r=q.getSelectedData(),s=[],t=m.data("ds"),u=m.data("ts"),v=h();return d.timeType={element:l,value:l.val()},d.title={element:i,value:_.str.trim(i.val())},d.deadlineTicks={element:m,value:l.val()},c=parseInt(d.timeType.value),0!=c?d.deadlineTicks.value=3>=c?v.add("weeks",c).unix():v.add("months",1).unix():(a=t.getValue(),b=u.getValue(),d.deadlineTicks.value=a.length>0?h(a+" "+b,"YYYYMMDD HH:mm").unix():""),d.isAnoymouse={element:n,value:n.prop("checked")},d.resultViewType={element:o,value:o.filter(":checked").val()},d.employeeIDs={element:q,value:r.p||[]},j.each(function(){var a=_.str.trim($(this).val());a.length>0&&s.push(a)}),d.voteOptions={element:j,value:s},d.voteCount={element:k,value:k.val()},d},at:function(){var a=this.element,b=$(".fs-publish-at-btn",a);$(".fs-publish-at-panel",a);var c=this.opts,e=c.actionOpts,g=e.at||{},h=$(g.inputSelector);b.html('<img src="'+d.BLANK_IMG+'" alt="vote" />'),b.attr("title","添加提到");var i=new B(_.extend({trigger:b,singleCked:!0,data:this.atGetDefaultSpData()},g.spOpts||{}));i.on("select",function(a){var b=h.filter(".fs-publish-at-focus").get(0)||h.eq(0).get(0);_.each(a,function(a){f.appendInput(b,"@"+a[0].name+" ")}),$(b).trigger("autosize.resize"),i.unselect("all","all"),i.hide()}),h.focus(function(){h.removeClass("fs-publish-at-focus"),$(this).addClass("fs-publish-at-focus")}),this.atSelectPanel=i},atClear:function(){},atGetDefaultSpData:function(){var a,b=[],c=f.getContactData().p,d=f.getPersonalConfig("lastAtEmployees");return _.each(d,function(a,c){var d=f.getContactDataById(a.dataID,"p");b[c]=_.extend({},d)}),a=[{title:"常用联系人",type:"p",list:b},{title:"同事",type:"p",list:c}]},atUpdateSpData:function(){var a=this.opts,b=a.actionOpts,c=b.at||{},d=$(c.inputSelector),e=f.getPersonalConfig("lastAtEmployees")||[];d.each(function(){var a=f.getAtFromInput(this);_.each(a,function(a){var b=f.getContactDataByName(a,"p");b&&!_.find(e,function(a){return a.dataID==b.id})&&e.push({dataID:b.id,name:b.name,isCircle:!1})})}),f.setPersonalConfig("lastAtEmployees",e),this.atSelectPanel.updateData(this.atGetDefaultSpData())},topic:function(){var a=this.element,b=$(".fs-publish-topic-btn",a);$(".fs-publish-topic-panel",a);var c=this.opts,e=c.actionOpts,g=e.topic||{},h=$(g.inputSelector);b.html('<img src="'+d.BLANK_IMG+'" alt="topic" />'),b.attr("title","添加话题");var i=new z(_.extend({trigger:b,align:{selfXY:[0,0],baseElement:b,baseXY:[-207,24]}},g.dialogOpts||{})).render();i.on("itemclick",function(a){f.appendInput(h.filter(".fs-publish-topic-focus").get(0),"#"+a.name+"# "),i.hide()}),i.on("inserttopic",function(){var a,b=h.filter(".fs-publish-topic-focus").get(0)||h.eq(0).get(0);f.appendInput(b,"#请输入话题（10个以内连续汉字）# "),$(b).trigger("autosize.resize"),a=f.getCursorPosition(b),i.hide(),a.start=a.start-18,a.end=a.end-2,f.setCursorPosition(b,a)}),h.focus(function(){h.removeClass("fs-publish-topic-focus"),$(this).addClass("fs-publish-topic-focus")}),b.on("click",function(a){a.stopPropagation()}),i.element.on("click",function(a){a.stopPropagation()}),f.regGlobalClick(i.element,function(){i.element.is(":visible")&&i.hide()}),this.topicDialog=i},topicClear:function(){},isActive:function(a){var b=this.element,c=$(".fs-publish-"+a+"-panel",b);return c.is(":visible")?!0:!1},disableAction:function(a){var b=a.toLowerCase(),c=this.element,d=$(".fs-publish-"+b+"-btn",c);("imgUpload"==a||"attachUpload"==a)&&this[a+"er"].core.setButtonDisabled(!0),d.addClass("fs-publish-"+b+"-disabled")},enableAction:function(a){var b=a.toLowerCase(),c=this.element,d=$(".fs-publish-"+b+"-btn",c);("imgUpload"==a||"attachUpload"==a)&&this[a+"er"].core.setButtonDisabled(!1),d.removeClass("fs-publish-"+b+"-disabled")},hideAction:function(a){var b=a.toLowerCase(),c=this.element,d=$(".fs-publish-"+b+"-btn",c),e=$(".fs-publish-"+b+"-panel",c).closest(".fs-publish-media-panel-wrapper");d.hide(),e.hide()},showAction:function(a){var b=a.toLowerCase(),c=this.element,d=$(".fs-publish-"+b+"-btn",c);d.show()},resetAll:function(){var a=this,b=this.element,c=this.opts;_.each(c.action,function(b){a[b+"Clear"]()}),$(".fs-publish-media-panel-wrapper",b).hide()},send:function(a,b){var c,d=this,e=this.sendDialog,g=this.sendPbar,h=b?$(b):$(document),i=function(){e.hide(),g.setProgress(0),g.element.hide(),c.empty()};e||(e=new j({height:"100px",className:"fs-publish-allupload-dialog",template:'<div><div class="fs-publish-allupload-pbar"></div><div class="fs-publish-send-info"></div></div>'}).render(),g=new A({element:$(".fs-publish-allupload-pbar",e.element)}),g.element.hide(),this.sendDialog=e,this.sendPbar=g),c=$(".fs-publish-send-info",e.element),e.set("width",h.outerWidth()),e.set("height",h.outerHeight()),e.set("align",{selfXY:[0,0],baseElement:h,baseXY:[0,0]}),this.atSelectPanel&&this.atUpdateSpData(),this.allUploaded?(c.html("正在提交请稍后..."),a(i)):(this.one("uploadprogress",function(){var a=d.getAllUploadStatus(),b=a.uploadedSize,e=a.totalSize,h=Math.ceil(100*(b/e))+"%";g.element.is(":hidden")&&g.element.show(),parseFloat(h)>100&&(h="100%"),g.setProgress(h),c.html("已上传"+f.getFileSize(b)+"/"+f.getFileSize(e))}),this.one("alluploadcomplete",function(){e.hide(),a(i),c.html("正在提交请稍后..."),g.element.hide()})),e.show()},destroy:function(){this.imgUploader&&(this.imgUploader.destroy(),this.imgUploader=null),this.attachUploader&&(this.attachUploader.destroy(),this.attachUploader=null),this.atSelectPanel&&(this.atSelectPanel.destroy(),this.atSelectPanel=null),this.gUploadDia&&(this.gUploadDia.destroy(),this.gUploadDia=null),this.topicDialog&&(this.topicDialog.destroy(),this.topicDialog=null),this.off(),this.element.empty()}}),y.idIndex=0,y.uploadCount=0,y.gUploadDia=new x,i.mixTo(y);var z=k.extend({attrs:{content:u.filter(".topic-dialog-tpl").html(),className:"fs-publish-topic-dialog",width:240,height:412,hasMask:!1,data:[{title:"常用话题",list:[{name:"研发每日计划"},{name:"研发周计划"}]},{title:"最新话题",list:[{name:"研发每日计划"},{name:"研发周计划"}]}]},events:{"mouseenter .topic-item":"_enterTopicItem","mouseleave .topic-item":"_leaveTopicItem","click .topic-item":"_clickTopicItem","click .insert-topic-btn":"_clickInsertBtn","click .f-cancel":"hide"},render:function(){var a=z.superclass.render.apply(this,arguments);return this._renderList(),a},_enterTopicItem:function(a){var b=$(a.target);b.addClass("state-hover")},_leaveTopicItem:function(a){var b=$(a.target);b.removeClass("state-hover")},_clickTopicItem:function(a){var b=$(a.target),c=b.attr("keyid"),d=this.getItemData(c);this.trigger("itemclick",d)},_clickInsertBtn:function(){this.trigger("inserttopic")},_renderList:function(){var a=this.get("data"),b=this.element,c=$(".cate-list",b),d="";_.each(a,function(a,b){var c=a.title,e=a.list,f="";d+='<li class="cate-item"><div class="cate-title">'+c+'</div><ul class="topic-list">',_.each(e,function(a,c){f+='<li class="topic-item" keyid="'+b+"-"+c+'">'+a.name+"</li>"}),d+=f+"</ul><li>"}),c.html(d)},getItemData:function(a){var b=a.split("-"),c=this.get("data");return c[b[0]].list[b[1]]}}),A=function(a){a=_.extend({element:null},a||{});var b=$(a.element);this.element=b,this.opts=a,b.data("progressBar",this),this.init()};A.prototype.init=function(){var a=this.element;a.html('<div class="fs-progress-indicator"></div><div class="fs-progress-text"></div>'),a.addClass("fs-progressbar")},A.prototype.setProgress=function(a){var b=this.element,c=$(".fs-progress-indicator",b),d=$(".fs-progress-text",b);c.css({width:a}),d.text(a)},A.prototype.reset=function(){this.setProgress("0%")};var B=function(a){a=_.extend({trigger:null,singleCked:!1,data:[{title:"标题 A",type:"a",list:[{name:"测试",id:"test",spell:"test"},{name:"测试a",id:"test2",spell:"aest"},{name:"测试b-1",id:"test3",spell:"best"},{name:"测试b-2",id:"test4",spell:"best"}]},{title:"标题 B",type:"b",list:[{name:"测试A",id:"test1",spell:"aest"}]},{title:"标题 B",type:"c",list:[{name:"测试b",id:"test1",spell:"best"}]}]},a||{});var b='<div class="fs-contact-letter-nav fn-clear"></div><div class="fs-contact-list-wrapper"><ul class="fs-contact-list"></ul></div>',c="",d="";_.each(a.data,function(){c+='<li class="ui-tab-item" data-role="trigger"></li>',d+='<div data-role="panel" class="ui-tab-panel fn-clear">'+b+"</div>"});var e=$(a.trigger),f=new k(_.extend({hasMask:!1,width:280,height:415,className:"fs-contact-dialog",content:'<div class="fs-contact-content"><div class="fs-contact-tabs ui-tab"><ul class="ui-switchable-nav ui-tab-items" data-role="nav">'+c+'</ul><div class="ui-switchable-content">'+d+"</div></div>"+'<div class="fs-contact-bbar fn-clear"><div class="fs-contact-summary">共有<span class="num">0</span>位同事</div><div class="fs-contact-action"><button class="fs-contact-close-btn">关闭</button></div></div>'+"</div>",align:{selfXY:["right",0],baseElement:e,baseXY:[e.width(),e.height()]},zIndex:2e3},a.dialogOpts||{})).render(),g=new l(_.extend({element:$(".fs-contact-tabs",f.element),triggers:$(".ui-tab-item",f.element),panels:$(".ui-tab-panel",f.element),activeIndex:0,triggerType:"click",withTabEffect:!1},a.tabOpts||{})).render();this.opts=a,this.dialog=f,this.tab=g,B.ins.push(this),this.init()};_.extend(B.prototype,{init:function(){var a=this,b=this.opts,c=b.data;_.each(c,function(b,c){a.updateTab(b,c)}),this.bindEvents()},updateData:function(a){var b=this;_.each(a,function(a,c){b.updateTab(a,c)})},updateTab:function(a,b){var c=a.title,d=a.type,e=a.list,f=(this.dialog,this.tab),g=f.get("triggers").eq(b),h=f.get("panels").eq(b);g.html('<a href="javascript:;">'+c+"</a>"),h.attr("emptype",d),this.doTabPanel(h,e)},doTabPanel:function(a,b){var c,d,e=$(a),c=$(".fs-contact-letter-nav",e),f=$(".fs-contact-list",e),g="",h=this.groupByLetter(b),i=_.sortBy(_.keys(h),function(a){return a});for(c.html('<ul class="list-0"></ul><ul class="list-1"></ul>'),d=65;77>=d;d++)g+="<li>"+String.fromCharCode(d)+"</li>";for($(".list-0",c).html(g),g="",d=78;90>=d;d++)g+="<li>"+String.fromCharCode(d)+"</li>";$(".list-1",c).html(g),c=$("li",c),g="",_.each(i,function(a){var b=h[a],d=b.length,e="";g+='<li><div class="index-box fn-clear"><div class="index-keyword">'+a+'</div><div class="item-length">'+d+'项</div></div><ul class="fs-contact-view">',_.each(b,function(a){e+='<li class="fs-contact-item" itemid="'+a.id+'">'+a.name+"</li>"}),g+=e+"</ul></li>",c.each(function(){var b=$(this),c=b.text();c==a&&b.addClass("fs-contact-letter-selected")})}),f.html(g),this.updateSummary()},show:function(a){var b=$(this.opts.trigger);this.dialog.set("align",{selfXY:["right",0],baseElement:b,baseXY:[b.width(),b.height()]}),this.dialog.show(),a!==!1&&this.trigger("show")},hide:function(a){this.dialog.hide(),a!==!1&&this.trigger("hide")},groupByLetter:function(a){var b=[];return b=_.groupBy(a,function(a){return a.spell.slice(0,1).toUpperCase()})},updateSummary:function(){var a=this.tab,b=this.dialog,c=b.element,d=$(".fs-contact-item",a.get("panels").eq(a.get("activeIndex"))),e=d.filter(".fs-contact-item-selected"),f=$(".fs-contact-summary",c);e.length>0?f.html("已选中"+e.length+"/"+d.length):f.html("共有"+d.length+"位同事")},select:function(a,b,c){var d,e=this.opts,f=this.tab,g=f.element,h=f.get("panels"),i={};a=[].concat(a),"all"==b?(d=$(".fs-contact-item",g),h.each(function(){var a=$(this),b=a.attr("emptype");i[b]=[]})):(d=$(".fs-contact-item",$('[emptype="'+b+'"]',g)),i[h.filter('[emptype="'+b+'"]').attr("emptype")]=[]),"all"==a[0]?(d.addClass("fs-contact-item-selected"),d.each(function(){var a=$(this),b=a.closest(".ui-tab-panel"),c=a.attr("itemid"),d=b.attr("emptype");i[d].push({name:a.text(),id:c})})):(c&&d.removeClass("fs-contact-item-selected"),_.each(a,function(a){var b=d.filter('[itemid="'+a+'"]');b.addClass("fs-contact-item-selected"),b.each(function(){var a=$(this),b=a.closest(".ui-tab-panel"),c=a.attr("itemid"),d=b.attr("emptype");i[d].push({name:a.text(),id:c})})})),e.singleCked&&this.hide(),this.trigger("select",i)},unselect:function(a,b){var c,d=this.tab,e=d.element,f=d.get("panels"),g={};a=[].concat(a),"all"==b?(c=$(".fs-contact-item",e),f.each(function(){var a=$(this),b=a.attr("emptype");g[b]=[]})):(c=$(".fs-contact-item",$('[emptype="'+b+'"]',e)),g[f.filter('[emptype="'+b+'"]').attr("emptype")]=[]),"all"==a[0]?(c.removeClass("fs-contact-item-selected"),c.each(function(){var a=$(this),b=a.closest(".ui-tab-panel"),c=a.attr("itemid"),d=b.attr("emptype");g[d].push({name:a.text(),id:c})})):_.each(a,function(a){var b=c.filter('[itemid="'+a+'"]');b.removeClass("fs-contact-item-selected"),b.each(function(){var a=$(this),b=a.closest(".ui-tab-panel"),c=a.attr("itemid"),d=b.attr("emptype");g[d].push({name:a.text(),id:c})})}),this.trigger("unselect",g)},bindEvents:function(){var a=this,b=this.tab,c=b.element,d=this.dialog,e=d.element,g=this.opts;c.on("click",".fs-contact-item",function(){var b=$(this),c=b.closest(".ui-tab-panel"),d=b.attr("itemid"),e=c.attr("emptype");b.hasClass("fs-contact-item-selected")?a.unselect(d,e):(g.singleCked&&a.unselect("all","all"),a.select(d,e)),a.updateSummary()}),b.on("switched",function(){a.updateSummary()
}),e.click(function(a){a.stopPropagation()}),e.on("click",".fs-contact-close-btn",function(){a.hide()}),c.on("click",".fs-contact-letter-selected",function(){var a,b=$(this),c=b.text(),d=b.closest(".ui-tab-panel").find(".fs-contact-list-wrapper"),e=$(".fs-contact-list",d);$("li",e).each(function(){var b=$(this),d=$(".index-keyword",b);return d.text()==c?(a=b,!1):void 0}),a&&d.scrollTop(a.position().top)}),$(g.trigger).click(function(b){_.each(_.filter(B.ins,function(b){return b!==a}),function(a){a.hide()}),a.show(),b.stopPropagation(),b.preventDefault()}),f.regGlobalClick(this.dialog.element,function(){a.dialog.element.is(":visible")&&a.hide()})},destroy:function(){var a=this,b=this.opts;this.dialog.destroy(),this.tab.destroy(),this.off(),$(b.trigger).unbind("click"),B.ins=_.filter(B.ins,function(b){return b!==a})}}),B.ins=[],i.mixTo(B);var C=function(a){a=_.extend({element:null,data:null,title:"",autoCompleteTitle:"",acTpl:"",singleCked:!1,defaultSelectedData:[]},a||{});var b,c=$(a.element),d=this,e="",g=u.filter(".publish-ac");0==a.acTpl.length?(g=u.filter(".publish-ac"),$(".fs-publish-ac-title",g).html(a.autoCompleteTitle),e=g.html()):e=a.acTpl,$(".fs-publish-ac-title",g).html(a.autoCompleteTitle),this.opts=a,this.element=c,b=this.getAcData(),c.length>0&&(c.each(function(){var c,g,h,i,j=$(this);j.html('<div class="fs-contact-bar fn-clear"><div class="fs-contact-bar-content fn-clear"><ul class="fs-contact-bar-list"></ul><div class="input-wrapper"><span class="input-tip"><i class="prefix">+</i>'+a.title+'</span><input class="input-field" type="text" /></div></div><em class="show-select-panel-h">&nbsp;</em></div>'),g=new n({trigger:$(".input-field",j),template:e,delay:0,submitOnEnter:!1,dataSource:b.slice(0),zIndex:2e3,initDataSource:a.acInitData,className:"fs-contact-bar-ac"}).render(),h=g.get("filter"),i=h.func,h.func=function(a,b){var c=d.getSelectedData(j),e=[],f=i.apply(this,[a,b,{key:"name"}]),g=i.apply(this,[a,b.toLowerCase(),{key:"spell"}]);return _.each(g,function(a){_.find(f,function(b){return b.id==a.id})||e.push(a)}),e=e.concat(f),_.each(c,function(a,b){_.each(a,function(a){e=_.reject(e,function(c){return c.type==b&&c.id==a?!0:void 0})})}),e},g.set("filter",h),g.on("itemSelect",function(b){a.singleCked&&d.removeAllItem(j),d.addItem(b,j),d.switchInputState(j,"hide")}),c=new B({trigger:$(".show-select-panel-h",j),data:a.data,singleCked:a.singleCked}),c.on("show",function(){var b=d.getSelectedData(j);c.unselect("all","all"),_.each(b,function(a,b){c.select(a,b)}),a.singleCked&&c.show(!1)}),c.on("select",function(a){_.each(a,function(a,b){_.each(a,function(a){d.addItem({type:b,id:a.id,name:a.name},j)})})}),c.on("unselect",function(a){_.each(a,function(a,b){_.each(a,function(a){d.removeItem({type:b,id:a.id,name:a.name},j)})})}),j.on("click",".fs-contact-bar-content",function(a){d.switchInputState(j,"show"),c.hide(),a.stopPropagation()}).on("click",".fs-contact-bar-list",function(a){a.stopPropagation()}),$(".input-field",j).keydown(function(a){var b=$(this),c=$(".fs-contact-bar-list",j),e=$(".fs-contact-bar-item",c).slice(-1),f=_.str.trim(b.val());0==f.length&&e.length>0&&8==a.keyCode&&d.removeItem({id:e.attr("itemid"),type:e.attr("emptype")},j)}),f.regGlobalClick(j,function(){d.switchInputState(j,"hide")}),j.on("click",".fs-contact-bar-list .remove-h",function(){var a=$(this),b=a.closest(".fs-contact-bar-item"),c=b.attr("itemid"),e=b.attr("emptype");d.removeItem({id:c,type:e},j)}),a.defaultSelectedData.length>0&&_.each(a.defaultSelectedData,function(a){var b=d.getItemData(a.id,a.type);d.addItem(b,j)}),j.data("ins",{ac:g,selectPanel:c})}),this.on("add",function(b,c){a.acInitData&&d.updateAcState(c,a.acInitData)}),this.on("remove",function(b,c){a.acInitData&&d.updateAcState(c,a.acInitData)}))};i.mixTo(C),C.prototype.getAcData=function(){var a,b=this.opts,c=b.data,d=[];return _.each(c,function(b){a=b.type,_.each(b.list,function(b){d.push({name:b.name,id:b.id,spell:b.spell.toLowerCase(),type:a})})}),d},C.prototype.setAcInitData=function(a,b){var c=this.getEl(b),d=c.data("ins").ac;d.set("initDataSource",a)},C.prototype.addItem=function(a,b){var c,d=this.getEl(b),e=$(".fs-contact-bar-list",d),f=$('[itemid="'+a.id+'"]',e).filter('[emptype="'+a.type+'"]'),g="";0==f.length&&("g"==a.type&&(g=" fs-cbi-dept"),999999==parseInt(a.id)&&(g=" fs-cbi-allcomp"),c='<li class="fs-contact-bar-item'+g+'" itemid="'+a.id+'" emptype="'+a.type+'"><span class="item-name">'+a.name+'</span><span class="remove-h">×</span></li>',$(c).appendTo(e),this.trigger("add",a,b))},C.prototype.removeItem=function(a,b){var c=this.getEl(b),d=$(".fs-contact-bar-list",c),e=$('[itemid="'+a.id+'"]',d).filter('[emptype="'+a.type+'"]');e.remove(),this.trigger("remove",a,b)},C.prototype.removeAllItem=function(a){var b=this,c=this.getEl(a),d=$(".fs-contact-bar-list",c),e=$(".fs-contact-bar-item",d);e.each(function(){var a=$(this);b.removeItem({id:a.attr("itemid"),type:a.attr("emptype")},c)})},C.prototype.switchInputState=function(a,b){var c,d,e,f;b?c=this.getEl(a):(b=a,c=this.getEl()),d=$(".input-wrapper",c),e=$(".input-tip",d),f=$(".input-field",d);var g=c.data("ins");b=b||"show","show"==b?(e.hide(),f.show().get(0).focus(),this.trigger("inputshow")):"hide"==b&&(e.show(),f.val("").hide(),g.ac.hide(),this.trigger("inputhide"))},C.prototype.getSelectedData=function(a){var b,c={},d=this.getEl(a);return b=$(".fs-contact-bar-item",d),b.length>0&&b.each(function(){var a=$(this),b=a.attr("emptype"),d=a.attr("itemid");c[b]||(c[b]=[]),c[b].push(d)}),c},C.prototype.getItemData=function(a,b){var c=this.getAcData();return _.find(c,function(c){return c.id==a&&c.type==b?!0:void 0})},C.prototype.updateAcState=function(a,b){var c=this.getEl(a),d=c.data("ins").ac,e=this.getSelectedData(c),g=[];_.each(b,function(a,b){g[b]={parseData:a.parseData,createHtml:a.createHtml,eqFields:a.eqFields},g[b].store=f.deepClone(a.store)}),_.each(e,function(a,b){_.each(a,function(a){_.each(g,function(c){var d=c.parseData,e=c.store;c.store=_.filter(e,function(c){var e=d(c)[0];return"mix"==c.type?!0:e.id==a&&e.type==b?!1:!0})})})}),d.set("initDataSource",g)},C.prototype.getEl=function(a){return a?$(a):this.element.eq(0)},C.prototype.destroy=function(){this.element.each(function(){var a=$(this),b=a.data("ins");b.ac.destroy(),b.selectPanel.destroy()}),this.off(),this.element.removeData(),this.element.empty(),this.element=null};var D=q.extend({attrs:{showTodayBtn:!1,align:{getter:function(){var a=this.get("trigger");return a?{selfXY:[0,0],baseElement:a,baseXY:[13,13]}:{selfXY:[0,0],baseXY:[0,0]}}}}}),E=function(a){a=_.extend({element:null,placeholder:"请选择日期",formatStr:"YYYY-MM-DD"},a||{}),this.element=$(a.element),this.opts=a,this.init()};E.prototype.init=function(){var a,b,c,d=this,e=this.element,f=this.opts,g=[],i=f.formatStr;e.html('<input type="text" class="fs-publish-dateselect-input" readonly="readonly" placeholder="'+f.placeholder+'" />'),a=$(".fs-publish-dateselect-input",e),p(a),b=h(),c=b.format(i),g[0]={value:c,text:"今天"},b=h().add("days",1),c=b.format(i),g[1]={value:c,text:"明天"},b=h().startOf("week").add("days",5),c=b.format(i),g[2]={value:c,text:"本周五"},b=h().startOf("week").add("days",8),c=b.format(i),g[3]={value:c,text:"下周一"};var j=new o({trigger:a,className:"fs-publish-dateselect",template:'<div class="{{classPrefix}}"><div class="fs-publish-dateselect-title">请选择日期</div><div class="fs-publish-dateselect-calendar"></div><ul class="{{classPrefix}}-content" data-role="content">{{#each select}}<li data-role="item" class="{{../classPrefix}}-item" data-value="{{value}}" data-defaultSelected="{{defaultSelected}}" data-selected="{{selected}}"><a href="javascript:;" title="{{{text}}}">{{{text}}}</a></li>{{/each}}</ul></div>',model:g,zIndex:2e3,autoWidth:!1}).render(),k=j.element,l=$(".fs-publish-dateselect-calendar",k),m=new D({trigger:l,zIndex:2e3});m.on("selectDate",function(b){var c=b.format(i);a.val(c),d.trigger("change",c)}),j.on("change",function(b){var c=b.data("value");a.val(c),d.trigger("change",c)}),j.after("show",function(){m.show()}),j.after("hide",function(){m.hide()}),this.calendar=m,this.selector=j},E.prototype.getValue=function(a){var b=this.opts,c=b.formatStr,d=this.element,e=$(".fs-publish-dateselect-input",d),f=_.str.trim(e.val()),g=h(f,c);return a?g:_.str.trim(g?g.format("YYYY-MM-DD"):"")},E.prototype.setValue=function(a){var b=h(a),c=this.calendar;c.setFocus(b),c.trigger("selectDate",b)},E.prototype.clear=function(){var a=this.element,b=$(".fs-publish-dateselect-input",a);return this.selector.select(-1),b.val("")},i.mixTo(E);var F=function(a){a=_.extend({element:null,placeholder:"请选择时间"},a||{}),this.element=$(a.element),this.opts=a,this.init()};F.prototype.init=function(){var a,b=this,c=this.element,d=this.opts,e=[],f=0,g=h("20130423080000","YYYYMMDDhhmmss"),i=g;for(c.html('<input type="text" class="fs-publish-timeselect-input" readonly="readonly" placeholder="'+d.placeholder+'" />'),a=$(".fs-publish-timeselect-input",c),p(a),f=0;48>f;f++)e.push({value:i.format("HH:mm"),text:i.format("HH:mm")}),i=g.add("minutes",30);this.selector=new o({trigger:a,model:e,zIndex:2e3,autoWidth:!1,className:"fs-publish-timeselect",template:'<div class="{{classPrefix}}"><div class="fs-publish-timeselect-title">请选择时间</div><ul class="{{classPrefix}}-content" data-role="content">{{#each select}}<li data-role="item" class="{{../classPrefix}}-item" data-value="{{value}}" data-defaultSelected="{{defaultSelected}}" data-selected="{{selected}}"><a href="javascript:;" title="{{{text}}}">{{{text}}}</a></li>{{/each}}</ul></div>'}).render().on("change",function(c){var d=c.data("value");a.val(d),b.trigger("change",d)})},F.prototype.getValue=function(){var a=this.element,b=$(".fs-publish-timeselect-input",a);return _.str.trim(b.val())},F.prototype.setValue=function(a){var b=this.selector;b.select(a)},F.prototype.clear=function(){var a=this.element,b=$(".fs-publish-timeselect-input",a);return this.selector.select(-1),b.val("")},i.mixTo(F);var G=function(){},H=k.extend({attrs:{content:u.filter(".receipt-dialog-tpl").html(),className:"fs-publish-receipt",inputSelector:null,rangeSb:null,submitCb:d.EMPTY_FN,cancelCb:d.EMPTY_FN},events:{"click .f-sub:enabled":"_submit","click .f-cancel":"_cancel","click .content-at-h.state-active":"_clickContentAt","click .send-range-h.state-active":"_clickSendRange","click .ui-dialog-close":"_cancel"},_renderCpt:function(){var a=this,b=this.element,c=$(".sb-range",b),d=new C({element:c,data:[{title:"同事",type:"p",list:v.p},{title:"部门",type:"g",list:v.g}],title:"选择同事",autoCompleteTitle:"请输入同事的名称或拼音"});d.on("add",function(){a.updateSubmitState()}),d.on("remove",function(){a.updateSubmitState()}),this.sb=d},render:function(){var a=H.superclass.render.apply(this,arguments);return this._renderCpt(),a},show:function(){var a=H.superclass.show.apply(this,arguments);return this._setShortcutData(),a},hide:function(){var a=H.superclass.hide.apply(this,arguments);return this._clear(),a},updateSubmitState:function(){var a=this.element,b=$(".f-sub",a),c=this.sb,d=c.getSelectedData();_.isEmpty(d)?b.addClass("button-state-disabled").prop("disabled",!0):b.removeClass("button-state-disabled").prop("disabled",!1)},_setShortcutData:function(){var a=this.element,b=$(".content-at-h",a),c=$(".send-range-h",a),d=$(this.get("inputSelector")),e=this.get("rangeSb"),g=f.getAtFromInput(d),h=e.getSelectedData(),i=[],j=[];_.each(g,function(a,b){i[b]=f.getContactDataByName(a,"p")}),_.each(h.p,function(a){j.push(f.getContactDataById(a,"p"))}),_.each(h.g,function(a){j.push(f.getContactDataById(a,"g"))}),this.shortcutData={atData:i,rangeData:j},i.length>0?(b.addClass("state-active"),$(".num",b).text(i.length)):(b.removeClass("state-active"),$(".num",b).text(0)),j.length>0?(c.addClass("state-active"),$(".num",c).text(j.length)):(c.removeClass("state-active"),$(".num",c).text(0))},_clickContentAt:function(){var a=this.shortcutData,b=a.atData,c=this.sb;_.each(b,function(a){c.addItem(a)})},_clickSendRange:function(){var a=this.shortcutData,b=a.rangeData,c=this.sb;_.each(b,function(a){c.addItem(a)})},_clear:function(){var a=this.element,b=$(".content-at-h",a),c=$(".send-range-h",a),d=$(".is-sms-send",a),e=this.sb;e.removeAllItem(),this.shortcutData=null,b.removeClass("state-active"),$(".num",b).text("0"),c.removeClass("state-active"),$(".num",c).text("0"),d.prop("checked",!1)},_submit:function(){var a=this.get("submitCb"),b=this.sb,c=b.getSelectedData();a&&a.call(this,c)},_cancel:function(){var a=this.get("cancelCb");a&&a.call(this),this.hide()},destroy:function(){var a;return this.sb&&this.sb.destroy(),this.shortcutData=null,a=H.superclass.destroy.apply(this,arguments)}}),I=k.extend({attrs:{content:_.template(u.filter(".my-history-plan-tpl").html())({blankImgSrc:d.BLANK_IMG}),className:"my-history-plan",width:1e3,height:507,inputSelector:{today:null,tomorrow:null,xdth:null}},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel"},setup:function(){var a;return a=I.superclass.setup.apply(this,arguments),this.currentPublishDate=h(new Date),a},_renderCpt:function(){var a=this.element,b=$(".switch-l",a),c=$(".user-name",a),d=$(".user-avatar",a),e=$(".media",a),g=$(".publish-input",a),h=new B({trigger:b,data:[{title:"同事",type:"p",list:v.p}],singleCked:!0});h.on("select",function(a){var b=a.p,e=b[0];c.text(e.name),d.attr("src",f.getDfLink(e.id,e.name,!1,"jpg")),h.unselect(e.id,"p")});var i=new y({element:e,action:["at","topic"],actionOpts:{at:{inputSelector:g},topic:{inputSelector:g}}}),j=new w({element:g});this.sp=h,this.media=i,this.atInput=j},render:function(){var a;return a=I.superclass.render.apply(this,arguments),this._renderCpt(),a},_submit:function(){},_cancel:function(){this.hide()},show:function(){var a;return a=I.superclass.show.apply(this,arguments),this._resetState(),a},_resetState:function(){var a=this.sp;a.select(v.u.id,"p"),this._updateNavDate(),this._updateEditContent()},_updateNavDate:function(){var a=this.element,b=$(".show-area",a),c=this.currentPublishDate;b.text(c.format("MM月DD日（dddd）"))},_updateEditContent:function(){var a=this.element,b=$(".today-input",a),c=$(".tomorrow-input",a),d=$(".xdth-input",a),e=this.get("inputSelector");b.val($(e.today).val()).trigger("autosize.resize"),c.val($(e.tomorrow).val()).trigger("autosize.resize"),d.val($(e.xdth).val()).trigger("autosize.resize")},destroy:function(){var a;return this.sp&&this.sp.destroy(),this.sp=null,this.media&&this.media.destroy(),this.media=null,this.atInput&&this.atInput.destroy(),this.atInput=null,a=I.superclass.destroy.apply(this,arguments)}});_.extend(b,{progressBar:A,atInput:w,selectPanel:B,selectBar:C,mediaMaker:y,inputAutoHeight:G,dateSelect:E,timeSelect:F,Receipt:H,MyHistoryPlan:I}),b.atInput=w});