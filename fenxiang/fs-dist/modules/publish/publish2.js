/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/publish/publish",["util","detector","json","moment","events","overlay","dialog","uilibs/tabs","filter","autocomplete","select","placeholder","calendar","swfupload","fsupload"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.store,e.event;var f=a("util"),g=a("detector"),h=a("json"),i=a("moment"),j=a("events"),k=a("overlay"),l=a("dialog"),m=a("uilibs/tabs"),n=a("filter"),o=a("autocomplete"),p=a("select"),q=a("placeholder"),r=a("calendar"),s=a("swfupload"),t=a("fsupload"),u=a("modules/publish/publish.html");a("modules/publish/publish.css");var v=$(u);d.BASE_PATH+"/Files/Temp";var w=function(a){var b;a=_.extend({element:null,data:f.getContactData().p},a||{}),b=$(a.element),this.element=b,f.asyncOrder(["stylelibs/jquery.atwho.css","jslibs/jquery.atwho.min.js","jslibs/jquery.atwho.custom.js","jslibs/jquery.autosize.js"],function(){var c=n.stringMatch;b.atwho("@",{data:a.data,callbacks:{filter:function(a,b){var d,e,g=[];if(0==_.str.trim(a).length){var h=f.getPersonalConfig("lastAtEmployees");_.each(h,function(a){var b=f.getContactDataById(a.dataID,"p");g.push(b)})}else d=c.apply(this,[b,a,{key:"name"}]),e=c.apply(this,[b,a.toLowerCase(),{key:"spell"}]),_.each(e,function(a){_.find(d,function(b){return b.id==a.id})||g.push(a)}),g=g.concat(d);return g},matcher:function(a,b){var c,d,e;return e=new RegExp(a+"([\\S]*)$","gi"),c=e.exec(b),d=null,c&&(d=c[2]?c[2]:c[1]),d}}}).addClass("fs-publish-input"),g.browser.ie&&b.keyup(function(){var a=b.data("atwho"),c=a.rect(),d=$(window).height();c.bottom>d&&$(window).scrollTop(c.bottom-d+120)}),b.addClass("autosize-animated").autosize()})};_.extend(w.prototype,{destroy:function(){this.element.trigger("autosize.destroy").removeClass("autosize-animated")}});var x=function(a){var b=this;a=_.extend({element:null,action:["imgUpload","attachUpload","vote","at"],actionOpts:{}},a||{}),this.opts=a,this.element=$(a.element),this.init(),this.allUploaded=!0,_.each(a.action,function(a){b[a].call(b)})};_.extend(x.prototype,{init:function(){var a,b,c=this,d=this.element,e=this.opts;d.html('<div class="fs-publish-action-btns"></div><div class="fs-publish-action-panels"></div>'),a=$(".fs-publish-action-btns",d),b=$(".fs-publish-action-panels",d),_.each(e.action,function(d){var e=d.toLowerCase(),f=$('<a href="#" class="fs-publish-'+e+'-btn fs-publish-media-btn"></a>'),g=$('<div class="fs-publish-media-panel-wrapper"></div>'),h=$('<span class="close-btn">×</span>'),i=$('<div class="fs-publish-'+e+'-panel fs-publish-media-panel"></div>');f.appendTo(a),h.appendTo(g),i.appendTo(g),g.appendTo(b),f.bind("showpanel",function(){g.show()}),h.click(function(){c[d+"Clear"](),g.hide(),c.trigger("closeaction",d)})}),(-1!=_.indexOf(e.action,"imgUpload")||-1!=_.indexOf(e.action,"attachUpload"))&&(this.on("uploadstart",function(a,b,c,d){this.trigger("uploadprogress",a,b,c,d)}),this.on("uploadprogress",function(a,b,d,e){var f=c[d+"Upload"],g=f.uploadFiles||[],h=_.find(g,function(c){return c.id==a.id?(_.extend(c,a,{uploadedSize:b}),!0):void 0});h||g.push(_.extend(a,{uploadedSize:b})),f.uploadFiles=g,c.updateUploadInfo(f,e)}),this.on("uploadsuccess",function(a,b,d){var e=c[d+"Upload"],f=e.uploadFiles||[],g=_.find(f,function(c){return c.id==a.id?(_.extend(c,a,{pathName:h.parse(b).value}),!0):void 0});g||f.push(_.extend(a,{pathName:h.parse(b).value})),e.uploadFiles=f}),this.on("alluploadcomplete",function(){}),this.on("typeuploadcomplete",function(a){var b=!0;a.uploaded=!0,_.find([c.imgUpload,c.attachUpload],function(a){return a&&a.uploaded===!1?(b=!1,!0):void 0}),b&&(c.allUploaded=!0,c.trigger("alluploadcomplete"))}))},getUploadItem:function(a,b){var c=$(b),d=a.name,e=$('[filename="'+d+'"]',c);return 0==e.length&&(e=$('<div class="fs-publish-upload-item" filename="'+d+'" fileid="'+a.id+'"></div>'),e.html('<div class="fs-publish-upload-item-inner fn-clear"><div class="thumb"></div><div class="summary"></div></div><div class="fs-publish-upload-pbar"></div>'),e.appendTo(c)),e},renderUploadItem:function(a,b,c,e){var g=$(c),b=h.parse(b),i=this.getUploadItem(a,g),j=$(".fs-publish-upload-item-inner",i),k=$(".thumb",j),l=$(".summary",j);"img"==e?k.html('<div class="thumb-img"><img src="'+d.BASE_PATH+"/"+b.value+'" alt="'+a.name+'" /></div>'):k.html('<div class="thumb-attach"><img src="'+d.ASSETS_PATH+'/images/clear.gif" alt="'+a.name+'" class="icon-file icon-file-'+f.getFileType(a)+'" /></div>'),l.html('<p class="file-name">'+a.name+'</p><p class="file-remove-wrapper"><a href="#" class="file-remove-l">取消</a></p>')},renderUploadError:function(a,b,c){var e=$(c),f=this.getUploadItem(a,e),g=$(".fs-publish-upload-item-inner",f),h=$(".thumb",g),i=$(".summary",g);h.html('<img src="'+d.ASSETS_PATH+'/images/error.png" alt="'+a.name+'" />'),i.html('<p class="file-error">上传失败('+b+')，请取消后重试</p><p class="file-remove-wrapper"><a href="#" class="file-remove-l">取消</a></p>')},getUploadStatus:function(a){for(var b,c=a.uploader,d=[],e=0,f=a.uploadFiles,g=0,h=0;b=c.getFile(e);)_.find(f,function(c){return c.id==b.id?(d.push(_.extend({uploadType:a.type},c,b)),!0):void 0}),e++;return _.each(d,function(a){a.filestatus,h+=a.size,_.find(f,function(b){return b.id==a.id?(g+=b.uploadedSize,!0):void 0})}),{files:d,uploadedSize:g,totalSize:h}},updateUploadInfo:function(a,b){var c=$(b),d=this.getUploadStatus(a),e=d.files,g=(d.uploadedSize,d.totalSize);c.html("共添加了"+e.length+"个文件，总大小"+f.getFileSize(g)+'&nbsp;&nbsp;<a href="#" class="file-remove-all-l" title="全部取消">全部取消</a>')},getAllUploadStatus:function(){var a=this,b=this.imgUpload,c=this.attachUpload,d=0,e=0,f=[];return _.each([b,c],function(b){var c=a.getUploadStatus(b);d+=c.uploadedSize,e+=c.totalSize,f=f.concat(c.files)}),{files:f,uploadedSize:d,totalSize:e}},getUploadValue:function(){var a=this.getAllUploadStatus();return a.files},removeUploadFile:function(a,b){var c=a.uploadFiles;c=_.filter(c,function(a){return a.id!=b}),a.uploadFiles=c},uploadValid:function(a,b){var c=!0,d=a.uploadFiles;return _.find(d,function(a){return a.name==b.name?(c=!1,f.alert("有同名文件存在"),!0):void 0}),c},uploadInit:function(a){var b,c,e=this,f=this.element,g=$(".fs-publish-"+a+"upload-btn",f),h=$(".fs-publish-"+a+"upload-panel",f),i="fs-publish-upload-"+x.uploadCount;g.html('<span id="'+i+'"></span>'),h.html('<div class="fs-publish-upload-list"></div><div class="fs-publish-upload-info color-333333"></div>'),b=$(".fs-publish-upload-list",h),c=$(".fs-publish-upload-info",h),b.addClass("fn-clear"),"img"==a?g.attr("title","添加图片（多张）"):g.attr("title","添加附件（多个）"),g.click(function(a){a.preventDefault()}),x.uploadCount++;var j=new t({upload_url:d.API_PATH+"/uploadfile_html/fileUpload",file_types:"img"==a?"*.jpg;*.gif;*.jpeg;*.png":"*.*",file_types_description:"img"==a?"图片格式":"所有格式",button_placeholder_id:i,button_image_url:d.BASE_PATH+"/content/fs/modules/publish/images/icon-upload-"+a+".png",button_width:18,button_height:"img"==a?14:15,fileDialogComplete:function(a,b){try{b>0&&this.startUpload()}catch(c){this.debug(c)}},upload_start_handler:function(d){var f,i;return e.uploadValid(j,d)?(f=e.getUploadItem(d,b),i=$(".fs-publish-upload-pbar",f),i.css({top:"50px",left:"14px",width:"100px"}),new y({element:i}),e.trigger("uploadstart",d,0,a,c),h.is(":hidden")&&g.trigger("showpanel"),e.allUploaded=!1,j.uploaded=!1,void 0):!1},upload_progress_handler:function(d,f){var g=Math.ceil(100*(f/d.size))+"%",h=e.getUploadItem(d,b),i=$(".fs-publish-upload-pbar",h),j=i.data("progressBar");j.setProgress(g),e.trigger("uploadprogress",d,f,a,c)},upload_success_handler:function(c,d){var f=this.getStats(),g=e.getUploadItem(c,b),h=$(".fs-publish-upload-pbar",g);h.hide(),e.renderUploadItem(c,d,b,a),f.files_queued>0&&this.startUpload(),e.trigger("uploadsuccess",c,d,a)},upload_error_handler:function(a,c){var d=this.getStats();c==s.UPLOAD_ERROR.FILE_VALIDATION_FAILED?this.cancelUpload(a.id,!1):e.renderUploadError(a,c,b),d.files_queued>0&&this.startUpload()},upload_complete_handler:function(){var a=this.getStats();0==a.files_queued&&e.trigger("typeuploadcomplete",j)}});j.type=a,j.uploaded=!0,this[a+"Upload"]=j,h.on("click",".file-remove-l",function(a){var d=$(this),f=d.closest(".fs-publish-upload-item"),g=f.attr("fileid");j.uploader.cancelUpload(g),f.remove(),e.removeUploadFile(j,g),e.updateUploadInfo(j,c),0==$(".fs-publish-upload-item",b).length&&$(".close-btn",h.closest(".fs-publish-media-panel-wrapper")).click(),a.preventDefault()}).on("click",".file-remove-all-l",function(a){$(".file-remove-l",h).click(),a.preventDefault()})},imgUpload:function(){this.uploadInit("img")},imgUploadClear:function(){var a=this.element,b=$(".fs-publish-imgupload-panel",a),c=$(".fs-publish-upload-list",b),d=$(".fs-publish-upload-info",b);c.empty(),d.empty(),this.imgUpload.uploadFiles=[]},attachUpload:function(){this.uploadInit("attach")},attachUploadClear:function(){var a=this.element,b=$(".fs-publish-attachupload-panel",a),c=$(".fs-publish-upload-list",b),d=$(".fs-publish-upload-info",b);c.empty(),d.empty(),this.attachUpload.uploadFiles=[]},vote:function(){var a,b=this.opts,c=b.actionOpts,e=c.vote||{},g=e.contactData,h=this.element,i=$(".fs-publish-vote-btn",h),j=$(".fs-publish-vote-panel",h),k=v.filter(".vote-wrapper").html();j.html(k),i.html('<img src="'+d.BLANK_IMG+'" alt="vote" />'),a=$(".vote",j),i.attr("title","添加投票"),f.placeholder($("[placeholder]",a));var l=$(".custom-range",a),m=new A({element:l,data:[{title:"同事",type:"p",list:g}],singleCked:!1,title:"选择投票后可见人",autoCompleteTitle:"请输入姓名或拼音"});l.data("sb",m);var n,o,p=$(".deadline-ticks",a),q=$(".dealine-date-time",a),r=$(".date-wrapper",q),s=$(".time-wrapper",q);n=new C({element:r,placeholder:"请选择日期"}),o=new D({element:s,placeholder:"请选择时间"}),n.on("change",function(){""==o.getValue()&&o.selector.select(0)}),q.data("ds",n),q.data("ts",o);var t=$(".add-vote-option-l",a),u=$(".option-wrapper",a),w=$(".option-tpl",a),x=_.template(w.html());t.click(function(a){var b,c=$(".option-item",u).length+1;b=x({index:c}),$(b).appendTo(u),a.preventDefault()}),u.on("click",".remove-l",function(){var a=$(this),b=a.closest(".option-item");b.remove(),$(".option-index",u).each(function(a){$(this).text(a+1+"、")}),$(".vote-option",u).change()}),p.change(function(){var a=$(this).val();"0"==a?q.show():q.hide()}).change(),$(".result-view-type",a).click(function(){var b=$(this),c=$(".custom-range",a);"3"==b.val()?c.show():c.hide()}).eq(0).click(),u.on("change",".vote-option",function(){var b=$(".vote-option",u),c=$(".vote-count",a),d=c.val(),e=0;b.each(function(){_.str.trim($(this).val()).length>0&&e++}),1>e&&(e=1);for(var f="",g=1;e>=g;g++)f+=1==g?'<option value="1">单选</option>':'<option value="'+g+'">最多选'+g+"个项目</option>";c.html(f).val(d)}),i.click(function(a){$(this).trigger("showpanel"),a.preventDefault()})},voteClear:function(){var a=this.voteGetValue();a.employeeIDs.element.removeAllItem(),a.title.element.val(""),a.voteOptions.element.each(function(){var a=$(this),b=a.closest(".option-item");$(".remove-l",b).length>0?b.remove():a.val("")}).change(),a.voteCount.element.val("1"),a.deadlineTicks.element.val("1").change(),a.isAnoymouse.element.prop("checked",!1)},voteIsValid:function(){var a=!0,b=this.voteGetValue(),c=b.voteOptions,d=c.value;return 0==b.title.value.length?(f.alert("投票标题不能为空"),a=!1):b.title.value.length>25?(f.alert("投票标题不能超过25个字符"),a=!1):d.length<2?(f.alert("至少两个投票选项"),a=!1):0==b.deadlineTicks.value.length?(f.alert("请设置自定义截止时间"),a=!1):"3"==b.resultViewType.value?(0==b.employeeIDs.value.length&&(f.alert("请选择自定义范围"),a=!1),a):a},voteGetValue:function(){var a,b,c,d={},e=this.element,f=$(".fs-publish-vote-panel",e),g=$(".vote",f),h=$(".vote-title",g),j=$(".vote-option",g),k=$(".vote-count",g),l=$(".deadline-ticks",g),m=$(".dealine-date-time",g),n=$(".is-anoymouse",g),o=$(".result-view-type",g),p=$(".custom-range",g),q=p.data("sb"),r=q.getSelectedData(),s=[],t=m.data("ds"),u=m.data("ts"),v=i();return d.timeType={element:l,value:l.val()},d.title={element:h,value:_.str.trim(h.val())},d.deadlineTicks={element:m,value:l.val()},c=parseInt(d.timeType.value),0!=c?d.deadlineTicks.value=3>=c?v.add("weeks",c).unix():v.add("months",1).unix():(a=t.getValue(),b=u.getValue(),d.deadlineTicks.value=a.length>0?i(a+" "+b,"YYYYMMDD HH:mm").unix():""),d.isAnoymouse={element:n,value:n.prop("checked")},d.resultViewType={element:o,value:o.filter(":checked").val()},d.employeeIDs={element:q,value:r.p||[]},j.each(function(){var a=_.str.trim($(this).val());a.length>0&&s.push(a)}),d.voteOptions={element:j,value:s},d.voteCount={element:k,value:k.val()},d},at:function(){var a=this.element,b=$(".fs-publish-at-btn",a);$(".fs-publish-at-panel",a);var c=this.opts,e=c.actionOpts,g=e.at||{},h=$(g.inputSelector);b.html('<img src="'+d.BLANK_IMG+'" alt="vote" />'),b.attr("title","添加提到");var i=new z(_.extend({trigger:b,singleCked:!0,data:this.atGetDefaultSpData()},g.spOpts||{}));i.on("select",function(a){_.each(a,function(a){f.appendInput(h.get(0),"@"+a[0].name+" ")}),i.unselect("all","all"),i.hide()}),this.atSelectPanel=i},atClear:function(){},atGetDefaultSpData:function(){var a,b=[],c=f.getContactData().p,d=f.getPersonalConfig("lastAtEmployees");return _.each(d,function(a,c){var d=f.getContactDataById(a.dataID,"p");b[c]=_.extend({},d)}),a=[{title:"常用联系人",type:"p",list:b},{title:"同事",type:"p",list:c}]},atUpdateSpData:function(){var a=this.opts,b=a.actionOpts,c=b.at||{},d=$(c.inputSelector),e=f.getPersonalConfig("lastAtEmployees")||[];d.each(function(){var a=f.getAtFromInput(this);_.each(a,function(a){var b=f.getContactDataByName(a,"p");_.find(e,function(a){return a.dataID==b.id})||e.push({dataID:b.id,name:b.name,isCircle:!1})})}),f.setPersonalConfig("lastAtEmployees",e),this.atSelectPanel.updateData(this.atGetDefaultSpData())},isActive:function(a){var b=this.element,c=$(".fs-publish-"+a+"-panel",b);return c.is(":visible")?!0:!1},disableAction:function(a){var b=a.toLowerCase(),c=this.element,d=$(".fs-publish-"+b+"-btn",c);("imgUpload"==a||"attachUpload"==a)&&this[a].uploader.setButtonDisabled(!0),d.addClass("fs-publish-"+b+"-disabled")},enableAction:function(a){var b=a.toLowerCase(),c=this.element,d=$(".fs-publish-"+b+"-btn",c);("imgUpload"==a||"attachUpload"==a)&&this[a].uploader.setButtonDisabled(!1),d.removeClass("fs-publish-"+b+"-disabled")},resetAll:function(){var a=this,b=this.element,c=this.opts;_.each(c.action,function(b){a[b+"Clear"]()}),$(".fs-publish-media-panel-wrapper",b).hide()},send:function(a,b){var c,d=this,e=this.sendDialog,g=this.sendPbar,h=b?$(b):$(document),i=function(){e.hide(),g.setProgress(0),g.element.hide(),c.empty()};e||(e=new k({height:"100px",className:"fs-publish-allupload-dialog",template:'<div><div class="fs-publish-allupload-pbar"></div><div class="fs-publish-send-info"></div></div>'}).render(),g=new y({element:$(".fs-publish-allupload-pbar",e.element)}),g.element.hide(),this.sendDialog=e,this.sendPbar=g),c=$(".fs-publish-send-info",e.element),e.set("width",h.outerWidth()),e.set("height",h.outerHeight()),e.set("align",{selfXY:[0,0],baseElement:h,baseXY:[0,0]}),this.atSelectPanel&&this.atUpdateSpData(),this.allUploaded?(c.html("正在提交请稍后..."),a(i)):(this.one("uploadprogress",function(){var a=d.getAllUploadStatus(),b=(a.files,a.uploadedSize),e=a.totalSize,h=Math.ceil(100*(b/e))+"%";g.element.is(":hidden")&&g.element.show(),g.setProgress(h),c.html("已上传"+f.getFileSize(b)+"/"+f.getFileSize(e))}),this.one("alluploadcomplete",function(){e.hide(),a(i),c.html("正在提交请稍后..."),g.element.hide()})),e.show()},destroy:function(){this.imgUpload&&(this.imgUpload.destroy(),this.imgUpload=null),this.attachUpload&&(this.attachUpload.destroy(),this.attachUpload=null),this.atSelectPanel&&(this.atSelectPanel.destroy(),this.atSelectPanel=null),this.off(),this.element.empty()}}),x.uploadCount=0,j.mixTo(x);var y=function(a){a=_.extend({element:null},a||{});var b=$(a.element);this.element=b,this.opts=a,b.data("progressBar",this),this.init()};y.prototype.init=function(){var a=this.element;a.html('<div class="fs-progress-indicator"></div><div class="fs-progress-text"></div>'),a.addClass("fs-progressbar")},y.prototype.setProgress=function(a){var b=this.element,c=$(".fs-progress-indicator",b),d=$(".fs-progress-text",b);c.css({width:a}),d.text(a)},y.prototype.reset=function(){this.setProgress("0%")};var z=function(a){a=_.extend({trigger:null,singleCked:!1,data:[{title:"标题 A",type:"a",list:[{name:"测试",id:"test",spell:"test"},{name:"测试a",id:"test2",spell:"aest"},{name:"测试b-1",id:"test3",spell:"best"},{name:"测试b-2",id:"test4",spell:"best"}]},{title:"标题 B",type:"b",list:[{name:"测试A",id:"test1",spell:"aest"}]},{title:"标题 B",type:"c",list:[{name:"测试b",id:"test1",spell:"best"}]}]},a||{});var b='<div class="fs-contact-letter-nav fn-clear"></div><div class="fs-contact-list-wrapper"><ul class="fs-contact-list"></ul></div>',c="",d="";_.each(a.data,function(){c+='<li class="ui-tab-item" data-role="trigger"></li>',d+='<div data-role="panel" class="ui-tab-panel fn-clear">'+b+"</div>"});var e=$(a.trigger),f=new l(_.extend({hasMask:!1,width:280,height:415,className:"fs-contact-dialog",content:'<div class="fs-contact-content"><div class="fs-contact-tabs ui-tab"><ul class="ui-switchable-nav ui-tab-items" data-role="nav">'+c+'</ul><div class="ui-switchable-content">'+d+"</div></div>"+'<div class="fs-contact-bbar fn-clear"><div class="fs-contact-summary">共有<span class="num">0</span>位同事</div><div class="fs-contact-action"><button class="fs-contact-close-btn">关闭</button></div></div>'+"</div>",align:{selfXY:["right",0],baseElement:e,baseXY:[e.width(),e.height()]},zIndex:2e3},a.dialogOpts||{})).render(),g=new m(_.extend({element:$(".fs-contact-tabs",f.element),triggers:$(".ui-tab-item",f.element),panels:$(".ui-tab-panel",f.element),activeIndex:0,triggerType:"click",withTabEffect:!1},a.tabOpts||{})).render();this.opts=a,this.dialog=f,this.tab=g,z.ins.push(this),this.init()};_.extend(z.prototype,{init:function(){var a=this,b=this.opts,c=b.data;_.each(c,function(b,c){a.updateTab(b,c)}),this.bindEvents()},updateData:function(a){var b=this;_.each(a,function(a,c){b.updateTab(a,c)})},updateTab:function(a,b){var c=a.title,d=a.type,e=a.list,f=(this.dialog,this.tab),g=f.get("triggers").eq(b),h=f.get("panels").eq(b);g.html('<a href="javascript:;">'+c+"</a>"),h.attr("emptype",d),this.doTabPanel(h,e)},doTabPanel:function(a,b){var c,d,e=$(a),c=$(".fs-contact-letter-nav",e),f=$(".fs-contact-list",e),g="",h=this.groupByLetter(b),i=_.sortBy(_.keys(h),function(a){return a});for(c.html('<ul class="list-0"></ul><ul class="list-1"></ul>'),d=65;77>=d;d++)g+="<li>"+String.fromCharCode(d)+"</li>";for($(".list-0",c).html(g),g="",d=78;90>=d;d++)g+="<li>"+String.fromCharCode(d)+"</li>";$(".list-1",c).html(g),c=$("li",c),g="",_.each(i,function(a){var b=h[a],d=b.length,e="";g+='<li><div class="index-box fn-clear"><div class="index-keyword">'+a+'</div><div class="item-length">'+d+'项</div></div><ul class="fs-contact-view">',_.each(b,function(a){e+='<li class="fs-contact-item" itemid="'+a.id+'">'+a.name+"</li>"}),g+=e+"</ul></li>",c.each(function(){var b=$(this),c=b.text();c==a&&b.addClass("fs-contact-letter-selected")})}),f.html(g),this.updateSummary()},show:function(a){var b=$(this.opts.trigger);this.dialog.set("align",{selfXY:["right",0],baseElement:b,baseXY:[b.width(),b.height()]}),this.dialog.show(),a!==!1&&this.trigger("show")},hide:function(a){this.dialog.hide(),a!==!1&&this.trigger("hide")},groupByLetter:function(a){var b=[];return b=_.groupBy(a,function(a){return a.spell.slice(0,1).toUpperCase()})},updateSummary:function(){var a=this.tab,b=this.dialog,c=b.element,d=$(".fs-contact-item",a.get("panels").eq(a.get("activeIndex"))),e=d.filter(".fs-contact-item-selected"),f=$(".fs-contact-summary",c);e.length>0?f.html("已选中"+e.length+"/"+d.length):f.html("共有"+d.length+"位同事")},select:function(a,b,c){var d,e=this.opts,f=this.tab,g=f.element,h=f.get("panels"),i={};a=[].concat(a),"all"==b?(d=$(".fs-contact-item",g),h.each(function(){var a=$(this),b=a.attr("emptype");i[b]=[]})):(d=$(".fs-contact-item",$('[emptype="'+b+'"]',g)),i[h.filter('[emptype="'+b+'"]').attr("emptype")]=[]),"all"==a[0]?(d.addClass("fs-contact-item-selected"),d.each(function(){var a=$(this),b=a.closest(".ui-tab-panel"),c=a.attr("itemid"),d=b.attr("emptype");i[d].push({name:a.text(),id:c})})):(c&&d.removeClass("fs-contact-item-selected"),_.each(a,function(a){var b=d.filter('[itemid="'+a+'"]');b.addClass("fs-contact-item-selected"),b.each(function(){var a=$(this),b=a.closest(".ui-tab-panel"),c=a.attr("itemid"),d=b.attr("emptype");i[d].push({name:a.text(),id:c})})})),e.singleCked&&this.hide(),this.trigger("select",i)},unselect:function(a,b){var c,d=this.tab,e=d.element,f=d.get("panels"),g={};a=[].concat(a),"all"==b?(c=$(".fs-contact-item",e),f.each(function(){var a=$(this),b=a.attr("emptype");g[b]=[]})):(c=$(".fs-contact-item",$('[emptype="'+b+'"]',e)),g[f.filter('[emptype="'+b+'"]').attr("emptype")]=[]),"all"==a[0]?(c.removeClass("fs-contact-item-selected"),c.each(function(){var a=$(this),b=a.closest(".ui-tab-panel"),c=a.attr("itemid"),d=b.attr("emptype");g[d].push({name:a.text(),id:c})})):_.each(a,function(a){var b=c.filter('[itemid="'+a+'"]');b.removeClass("fs-contact-item-selected"),b.each(function(){var a=$(this),b=a.closest(".ui-tab-panel"),c=a.attr("itemid"),d=b.attr("emptype");g[d].push({name:a.text(),id:c})})}),this.trigger("unselect",g)},bindEvents:function(){var a=this,b=this.tab,c=b.element,d=this.dialog,e=d.element,g=this.opts;c.on("click",".fs-contact-item",function(){var b=$(this),c=b.closest(".ui-tab-panel"),d=b.attr("itemid"),e=c.attr("emptype");b.hasClass("fs-contact-item-selected")?a.unselect(d,e):(g.singleCked&&a.unselect("all","all"),a.select(d,e)),a.updateSummary()}),b.on("switched",function(){a.updateSummary()}),e.click(function(a){a.stopPropagation()}),e.on("click",".fs-contact-close-btn",function(){a.hide()}),c.on("click",".fs-contact-letter-selected",function(){var a,b=$(this),c=b.text(),d=b.closest(".ui-tab-panel").find(".fs-contact-list-wrapper"),e=$(".fs-contact-list",d);$("li",e).each(function(){var b=$(this),d=$(".index-keyword",b);return d.text()==c?(a=b,!1):void 0}),a&&d.scrollTop(a.position().top)}),$(g.trigger).click(function(b){_.each(_.filter(z.ins,function(b){return b!==a}),function(a){a.hide()}),a.show(),b.stopPropagation(),b.preventDefault()}),f.regGlobalClick(this.dialog.element,function(){a.hide()})},destroy:function(){var a=this,b=this.opts;this.dialog.destroy(),this.tab.destroy(),this.off(),$(b.trigger).unbind("click"),z.ins=_.filter(z.ins,function(b){return b!==a})}}),z.ins=[],j.mixTo(z);var A=function(a){a=_.extend({element:null,data:null,title:"",autoCompleteTitle:"",acTpl:"",singleCked:!1,defaultSelectedData:[]},a||{});var b,c=$(a.element),d=this,e="",g=v.filter(".publish-ac");0==a.acTpl.length?(g=v.filter(".publish-ac"),$(".fs-publish-ac-title",g).html(a.autoCompleteTitle),e=g.html()):e=a.acTpl,$(".fs-publish-ac-title",g).html(a.autoCompleteTitle),this.opts=a,this.element=c,b=this.getAcData(),c.length>0&&(c.each(function(){var c,g,h,i,j=$(this);j.html('<div class="fs-contact-bar fn-clear"><div class="fs-contact-bar-content fn-clear"><ul class="fs-contact-bar-list"></ul><div class="input-wrapper"><span class="input-tip"><i class="prefix">+</i>'+a.title+'</span><input class="input-field" type="text" /></div></div><em class="show-select-panel-h">&nbsp;</em></div>'),g=new o({trigger:$(".input-field",j),template:e,delay:0,submitOnEnter:!1,dataSource:b.slice(0),zIndex:2e3,initDataSource:a.acInitData,className:"fs-contact-bar-ac"}).render(),h=g.get("filter"),i=h.func,h.func=function(a,b){var c=d.getSelectedData(j),e=[],f=i.apply(this,[a,b,{key:"name"}]),g=i.apply(this,[a,b.toLowerCase(),{key:"spell"}]);return _.each(g,function(a){_.find(f,function(b){return b.id==a.id})||e.push(a)}),e=e.concat(f),_.each(c,function(a,b){_.each(a,function(a){e=_.reject(e,function(c){return c.type==b&&c.id==a?!0:void 0})})}),e},g.set("filter",h),g.on("itemSelect",function(b){a.singleCked&&d.removeAllItem(j),d.addItem(b,j),d.switchInputState(j,"hide")}),c=new z({trigger:$(".show-select-panel-h",j),data:a.data,singleCked:a.singleCked}),c.on("show",function(){var b=d.getSelectedData(j);_.each(b,function(a,b){c.select(a,b,!0)}),a.singleCked&&c.show(!1)}),c.on("select",function(a){_.each(a,function(a,b){_.each(a,function(a){d.addItem({type:b,id:a.id,name:a.name},j)})})}),c.on("unselect",function(a){_.each(a,function(a,b){_.each(a,function(a){d.removeItem({type:b,id:a.id,name:a.name},j)})})}),j.on("click",".fs-contact-bar-content",function(a){d.switchInputState(j,"show"),a.stopPropagation()}).on("click",".fs-contact-bar-list",function(a){a.stopPropagation()}),$(".input-field",j).keydown(function(a){var b=$(this),c=$(".fs-contact-bar-list",j),e=$(".fs-contact-bar-item",c).slice(-1),f=_.str.trim(b.val());0==f.length&&e.length>0&&8==a.keyCode&&d.removeItem({id:e.attr("itemid"),type:e.attr("emptype")},j)}),f.regGlobalClick(j,function(){d.switchInputState(j,"hide")}),j.on("click",".fs-contact-bar-list .remove-h",function(){var a=$(this),b=a.closest(".fs-contact-bar-item"),c=b.attr("itemid"),e=b.attr("emptype");d.removeItem({id:c,type:e},j)}),a.defaultSelectedData.length>0&&_.each(a.defaultSelectedData,function(a){var b=d.getItemData(a.id,a.type);d.addItem(b,j)}),j.data("ins",{ac:g,selectPanel:c})}),this.on("add",function(b,c){a.acInitData&&d.updateAcState(c,a.acInitData)}),this.on("remove",function(b,c){a.acInitData&&d.updateAcState(c,a.acInitData)}))};j.mixTo(A),A.prototype.getAcData=function(){var a,b=this.opts,c=b.data,d=[];return _.each(c,function(b){a=b.type,_.each(b.list,function(b){d.push({name:b.name,id:b.id,spell:b.spell.toLowerCase(),type:a})})}),d},A.prototype.setAcInitData=function(a,b){var c=this.getEl(b),d=c.data("ins").ac;d.set("initDataSource",a)},A.prototype.addItem=function(a,b){var c,d=this.getEl(b),e=$(".fs-contact-bar-list",d),f=$('[itemid="'+a.id+'"]',e).filter('[emptype="'+a.type+'"]'),g="";0==f.length&&("g"==a.type&&(g=" fs-cbi-dept"),999999==parseInt(a.id)&&(g=" fs-cbi-allcomp"),c='<li class="fs-contact-bar-item'+g+'" itemid="'+a.id+'" emptype="'+a.type+'"><span class="item-name">'+a.name+'</span><span class="remove-h">×</span></li>',$(c).appendTo(e),this.trigger("add",a,b))},A.prototype.removeItem=function(a,b){var c=this.getEl(b),d=$(".fs-contact-bar-list",c),e=$('[itemid="'+a.id+'"]',d).filter('[emptype="'+a.type+'"]');e.remove(),this.trigger("remove",a,b)},A.prototype.removeAllItem=function(a){var b=this,c=this.getEl(a),d=$(".fs-contact-bar-list",c),e=$(".fs-contact-bar-item",d);e.each(function(){var a=$(this);b.removeItem({id:a.attr("itemid"),type:a.attr("emptype")},c)})},A.prototype.switchInputState=function(a,b){var c=this.getEl(a),d=$(".input-wrapper",c),e=$(".input-tip",d),f=$(".input-field",d),g=c.data("ins");b=b||"show","show"==b?(e.hide(),f.show().get(0).focus(),this.trigger("inputshow")):"hide"==b&&(e.show(),f.val("").hide(),g.ac.hide(),this.trigger("inputhide"))},A.prototype.getSelectedData=function(a){var b,c={},d=this.getEl(a);return b=$(".fs-contact-bar-item",d),b.length>0&&b.each(function(){var a=$(this),b=a.attr("emptype"),d=a.attr("itemid");c[b]||(c[b]=[]),c[b].push(d)}),c},A.prototype.getItemData=function(a,b){var c=this.getAcData();return _.find(c,function(c){return c.id==a&&c.type==b?!0:void 0})},A.prototype.updateAcState=function(a,b){var c=this.getEl(a),d=c.data("ins").ac,e=this.getSelectedData(c),g=[];_.each(b,function(a,b){g[b]={parseData:a.parseData,createHtml:a.createHtml,eqFields:a.eqFields},g[b].store=f.deepClone(a.store)}),_.each(e,function(a,b){_.each(a,function(a){_.each(g,function(c){var d=c.parseData,e=c.store;c.store=_.filter(e,function(c){var e=d(c)[0];return"mix"==c.type?!0:e.id==a&&e.type==b?!1:!0})})})}),d.set("initDataSource",g)},A.prototype.getEl=function(a){return a?$(a):this.element.eq(0)},A.prototype.destroy=function(){this.element.each(function(){var a=$(this),b=a.data("ins");b.ac.destroy(),b.selectPanel.destroy()}),this.off(),this.element.removeData(),this.element.empty(),this.element=null};var B=r.extend({attrs:{showTodayBtn:!1,align:{getter:function(){var a=this.get("trigger");return a?{selfXY:[0,0],baseElement:a,baseXY:[13,13]}:{selfXY:[0,0],baseXY:[0,0]}}}}}),C=function(a){a=_.extend({element:null,placeholder:"请选择日期",formatStr:"YYYY-MM-DD"},a||{}),this.element=$(a.element),this.opts=a,this.init()};C.prototype.init=function(){var a,b,c,d=this,e=this.element,f=this.opts,g=[],h=f.formatStr;e.html('<input type="text" class="fs-publish-dateselect-input" readonly="readonly" placeholder="'+f.placeholder+'" />'),a=$(".fs-publish-dateselect-input",e),q(a),b=i(),c=b.format(h),g[0]={value:c,text:"今天"},b=i().add("days",1),c=b.format(h),g[1]={value:c,text:"明天"},b=i().startOf("week").add("days",5),c=b.format(h),g[2]={value:c,text:"本周五"},b=i().startOf("week").add("days",8),c=b.format(h),g[3]={value:c,text:"下周一"};var j=new p({trigger:a,className:"fs-publish-dateselect",template:'<div class="{{classPrefix}}"><div class="fs-publish-dateselect-title">请选择日期</div><div class="fs-publish-dateselect-calendar"></div><ul class="{{classPrefix}}-content" data-role="content">{{#each select}}<li data-role="item" class="{{../classPrefix}}-item" data-value="{{value}}" data-defaultSelected="{{defaultSelected}}" data-selected="{{selected}}"><a href="javascript:;" title="{{{text}}}">{{{text}}}</a></li>{{/each}}</ul></div>',model:g,zIndex:2e3,autoWidth:!1}).render(),k=j.element,l=$(".fs-publish-dateselect-calendar",k),m=new B({trigger:l,zIndex:2e3});m.on("selectDate",function(b){var c=b.format(h);a.val(c),d.trigger("change",c)}),j.on("change",function(b){var c=b.data("value");a.val(c),d.trigger("change",c)}),j.after("show",function(){m.show()}),j.after("hide",function(){m.hide()}),this.calendar=m,this.selector=j},C.prototype.getValue=function(a){var b=this.opts,c=b.formatStr,d=this.element,e=$(".fs-publish-dateselect-input",d),f=_.str.trim(e.val()),g=i(f,c);return a?g:_.str.trim(g?g.format("YYYY-MM-DD"):"")},C.prototype.setValue=function(a){var b=i(a),c=this.calendar;c.setFocus(b),c.trigger("selectDate",b)},C.prototype.clear=function(){var a=this.element,b=$(".fs-publish-dateselect-input",a);return this.selector.select(-1),b.val("")},j.mixTo(C);var D=function(a){a=_.extend({element:null,placeholder:"请选择时间"},a||{}),this.element=$(a.element),this.opts=a,this.init()};D.prototype.init=function(){var a,b=this,c=this.element,d=this.opts,e=[],f=0,g=i("20130423080000","YYYYMMDDhhmmss"),h=g;for(c.html('<input type="text" class="fs-publish-timeselect-input" readonly="readonly" placeholder="'+d.placeholder+'" />'),a=$(".fs-publish-timeselect-input",c),q(a),f=0;48>f;f++)e.push({value:h.format("HH:mm"),text:h.format("HH:mm")}),h=g.add("minutes",30);this.selector=new p({trigger:a,model:e,zIndex:2e3,autoWidth:!1,className:"fs-publish-timeselect",template:'<div class="{{classPrefix}}"><div class="fs-publish-timeselect-title">请选择时间</div><ul class="{{classPrefix}}-content" data-role="content">{{#each select}}<li data-role="item" class="{{../classPrefix}}-item" data-value="{{value}}" data-defaultSelected="{{defaultSelected}}" data-selected="{{selected}}"><a href="javascript:;" title="{{{text}}}">{{{text}}}</a></li>{{/each}}</ul></div>'}).render().on("change",function(c){var d=c.data("value");a.val(d),b.trigger("change",d)})},D.prototype.getValue=function(){var a=this.element,b=$(".fs-publish-timeselect-input",a);return _.str.trim(b.val())},D.prototype.setValue=function(a){var b=this.selector;b.select(a)},D.prototype.clear=function(){var a=this.element,b=$(".fs-publish-timeselect-input",a);return this.selector.select(-1),b.val("")},j.mixTo(D);var E=function(){};_.extend(b,{progressBar:y,atInput:w,selectPanel:z,selectBar:A,mediaMaker:x,inputAutoHeight:E,dateSelect:C,timeSelect:D}),b.atInput=w});