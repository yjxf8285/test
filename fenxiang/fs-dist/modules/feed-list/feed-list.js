/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/feed-list/feed-list",["util","modules/feed-list/feed-list-c","modules/feed-list/feed-list-v","modules/fs-lazyload/fs-lazyload","uilibs/pagination","moment","spin"],function(a,b,c){var d=window,e=d.FS,f=e.tpl,g=f.event,h=a("util"),i=a("modules/feed-list/feed-list-c"),j=a("modules/feed-list/feed-list-v"),k=a("modules/fs-lazyload/fs-lazyload"),l=a("uilibs/pagination"),m=a("moment");a("spin");var n=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:45,totalSize:-1,visiblePageNums:7},itemReadyCb:e.EMPTY_FN,itemDeleteCb:e.EMPTY_FN,itemReceiptCb:e.EMPTY_FN,itemWorktodoCb:e.EMPTY_FN,feedRemindClickCb:void 0,withFeedRemind:!1,withLazyload:!1,withArchive:!1,withFollowTime:!1,withAvatar:!0,withActionBtn:!0,reloadAfterReply:!1,scheduleStyle:"1",noticeStyle:"1",detailStyle:"1",loadSize:15,listPath:"/Feed/GetFeeds",defaultRequestData:{},listXhrBeforeSend:e.EMPTY_FN,searchOpts:{inputSelector:null,btnSelector:null},listEmptyText:"暂无记录",searchEmptyText:"未找到相关的记录",beforeListParse:function(a){return a},listSuccessCb:e.EMPTY_FN},a||{}),this.opts=a,this.element=$(a.element),this._initPagination(),this.items=[],this.list=new i.listC,this.pagination=null,this.lazyload=null,this.feedRemindTid=null,this.lastMaxId=0,this.tempRequestData={},this.listXhr=null,this.init()};_.extend(n.prototype,{_initPagination:function(){var a=this.opts;a.pagSelector===!1?(this.pagEl=$('<div class="feed-list-pagination"></div>').appendTo(this.element),this.pagEl.hide(),a.pagOpts.pageSize=1e4):this.pagEl=$(a.pagSelector)},init:function(){var a,b,c=this,d=this.opts,e=this.element,f=j.itemV,g=this.list,h=!0,i=1;e.html('<div class="feed-list-inner"></div>'),a=$(".feed-list-inner",e),b=g.parse,g.parse=function(a){var c=d.beforeListParse.call(this,a);return c!==!1?b.call(this,c):void 0},g.on("add",function(b,e,g){var h,i=g.at;h=new f({model:b,withArchive:d.withArchive,withFollowTime:d.withFollowTime,withAvatar:d.withAvatar,withActionBtn:d.withActionBtn,replyWithMedia:!0,replyListOpts:{listPath:"/Feed/GetFeedReplysByFeedID",withPagination:!1},reloadAfterReply:d.reloadAfterReply,scheduleStyle:d.scheduleStyle,noticeStyle:d.noticeStyle,detailStyle:d.detailStyle,deleteCb:function(a){return a.success&&c._updatelistStatus(a),d.itemDeleteCb.apply(this,arguments)},worktodoCb:d.itemWorktodoCb,receiptCb:function(a){var b,c=$("#global-remind"),e=0;return a.success&&(b=$(".receipt-item",c),e=parseInt($(".remind-counts",b).text()),e>1?$(".remind-counts",b).text(e-1):($(".remind-counts",b).text(0),b.remove()),0==$(".remind-item",c).length&&c.hide()),d.itemReceiptCb.apply(this,arguments)},delegateOtherCb:function(a){a.success&&c.unshiftFromFeedId(a.value.value1)}}).render(),0==i?h.$el.prependTo(a):h.$el.appendTo(a),c.items.push(h),d.itemReadyCb.call(h)}),this.pagination=new l(_.extend({element:this.pagEl},d.pagOpts)),this.pagination.on("page",function(){h=!0,c.empty(),d.withLazyload?(c.loadStart(),c.pagination.hide()):c.plainLoad()}),i=parseInt(this.pagination.get("pageSize")/d.loadSize),this.lazyload=new k({triggerSize:20,executeHandler:function(a,b){var d=c.pagination.get("activePageNumber"),f=(d-1)*i+a+1,g={pageNumber:f};e.is(":visible")&&(h?g.sinceID=0:c.pagination.hide(),c.fetch(g,b),h=!1)},circleCount:i}),this.lazyload.on("stop",function(){c.pagination.show()}),this.pagination.render(),d.withFeedRemind&&this._initFeedRemind(),d.searchOpts&&d.searchOpts.inputSelector&&this._searchBarInit(),this._initListEmptyTip()},_searchBarInit:function(){var a,b,c,d=this,e=this.opts,f=e.searchOpts,g=this.element,h=$(f.inputSelector),i=$(f.btnSelector),j=h.data("isInit");j||(b=$('<span class="empty-h">&#10005;</span>'),c=$('<span class="list-search-input-wrapper"></span>'),h.wrap(c),c=h.closest(".list-search-input-wrapper"),b.hide().appendTo(c),h.keydown(function(a){13==a.keyCode&&i.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(b.show(),h.addClass("with-input-value")):(b.hide(),h.removeClass("with-input-value"))}),b.click(function(){h.val(""),h.removeClass("with-input-value"),b.hide()}),h.data("isInit",!0)),a=$('<div class="list-search-bar fn-clear"></div>'),a.html('<span class="result-info fn-left">共搜索到<span class="num color-red">0</span>条信息</span><a class="back-l fn-right" href="#" title="返回查看全部"><< 返回查看全部</a>'),a.hide().prependTo(g),a.on("click",".back-l",function(b){var c=$(".list-empty-tip",g),e=$(".empty-h",h.closest(".list-search-input-wrapper"));h.val(""),h.removeClass("with-input-value"),e.hide(),a.hide(),c.hide(),d.reload({keyword:""}),b.preventDefault()}),this.searchBarEl=a},_searchBarDestroy:function(){var a,b,c=this.opts,d=c.searchOpts;this.searchBarEl&&(a=$(d.inputSelector),b=a.closest(".list-search-input-wrapper"),a.insertAfter(b),b.remove(),a.val("").unbind(),a.data("isInit",!1),this.searchBarEl.remove(),this.searchBarEl=null)},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".num",d);return a.keyword.length>0&&b.success?(e.text(b.value.totalCount),d.show(),void 0):(d.hide(),void 0)},resetSearch:function(){var a=this.opts,b=a.searchOpts,c=$(b.inputSelector),d=c.closest(".list-search-input-wrapper"),e=$(".empty-h",d);e.click().hide(),this.searchBarEl&&this.searchBarEl.hide()},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+e.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.appendTo(a)},_updatelistStatus:function(a,b){var c=this.opts,d=c.listEmptyText,e=c.searchEmptyText,f=this.element,g=$(".fs-feed-item",f),h=$(".list-empty-tip",f),i=b&&b.keyword&&b.keyword.length>0?e:d;$(".empty-text",h).text(i),0==g.length?h.show():h.hide()},_hideEmptyTip:function(){var a=this.element,b=$(".list-empty-tip",a);b.hide()},_initFeedRemind:function(){var a=this,b=this.opts,c=this.element,d=$(".feed-remind",c);0==d.length&&(d=$('<div class="feed-remind">有<span class="num">0</span>条新信息，点击查看</div>'),d.prependTo(c)),d.on("click",function(){a.resetSearch(),b.feedRemindClickCb?b.feedRemindClickCb.call(a):a.reload(),d.hide()}),g.on("globalremind",function(b){var e;b.success&&c.is(":visible")&&(e=b.value.newFeedCount,e>0?($(".num",d).text(e),d.show()):d.hide(),_.each(a.items,function(a){var c=a.model.get("originData"),d=c.createTime;$(".f-date",a.$el).text(h.getDateSummaryDesc(m.unix(d),m.unix(b.serviceTime),1))}))})},hideFeedRemind:function(){var a=this.element,b=$(".feed-remind",a);b.hide()},fetch:function(a,b){var c=this,d=this.opts,e=this.list,f=this.pagination,g=e.lastOriginData||{},h=g.value||{};a=_.extend({pageSize:d.loadSize,pageNumber:1,sinceID:h.sinceID||0,maxID:this.lastMaxId},a||{}),1==a.pageNumber&&(a.maxID=0),d.withLazyload||(a.maxID=0,a.sinceID=0),a=_.isFunction(d.defaultRequestData)?_.extend(d.defaultRequestData(),a):_.extend(d.defaultRequestData,a),a=_.extend(a,this.tempRequestData),this.tempRequestData={},this.showLoading(),this.listXhr&&this.listXhr.abort(),this.listXhr=this.list.fetch({url:d.listPath,data:a,beforeSend:d.listXhrBeforeSend,success:function(e,g,h){var i;g=d.beforeListParse.call(this,g),g.success&&(i=g.value,f.setTotalSize(i.totalCount),c.list.lastOriginData=g,i.maxID>0&&(c.lastMaxId=i.maxID),b(!0),i.items&&0!=i.items.length||c.loadKill(),c._updateSearchBarState(h.data,g),c._updatelistStatus(g,a),d.listSuccessCb.call(this,g,a)),c.hideLoading()}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".feed-list-loading",b);0==c.length&&(c=$('<div class="feed-list-loading list-loading"></div>'),c.appendTo(b),c.html('<span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".feed-list-loading",a);b.hide()},plainLoad:function(){var a=this.opts,b=a.pagOpts,c=this.pagination,d={};_.extend(d,{pageSize:b.pageSize,pageNumber:c.get("activePageNumber")}),this.fetch(d,e.EMPTY_FN)},loadStart:function(){this.lazyload.kill(),this.lazyload.start(!0)},loadKill:function(){this.lazyload.kill()},load:function(a){this._hideEmptyTip(),this.pagination.reset(),this.hideFeedRemind(),this.tempRequestData=a,this.pagination.jump(1)},reload:function(a){this.list.lastOriginData=null,this.load(a)},unshift:function(a){var b=this.list,c=b.parse(a)[0];b.unshift(c),this._updatelistStatus()},unshiftFromFeedId:function(a){var b=this;h.api({type:"get",data:{feedID:a},url:"/Feed/GetFeedByFeedID",success:function(a){a.success&&b.unshift(a)}})},push:function(a){var b=this.list,c=b.parse(a)[0];b.push(c)},empty:function(){var a=this.items,b=$(".feed-list-inner",this.element);_.each(a,function(a){a.destroy&&a.destroy()}),this.items=[],b.empty()},hideItemSlideTip:function(){$(".show-slide-up-tip-warp").hide()},destroy:function(){this.pagination.destroy(),this.lazyload.destroy(),this.listXhr=null,this._searchBarDestroy(),this.loading&&this.loading.stop(),this.empty(),this.list.lastOriginData=null,this.list=null,this.pagination=null,this.lazyload=null,this.lastMaxId=0,this.tempRequestData={},this.element.off(),this.element.empty(),this.element=null}}),h.tplRouterReg("#stream/showfeed/=/:id-:value"),c.exports=n});