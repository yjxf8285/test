/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/feed-list/preview-feed-v",["util","moment","dialog","modules/publish/publish","modules/feed-list/feed-list.css","modules/feed-list/feed-list-m","modules/feed-list/feed-list-c","modules/feed-list/feed-list.html","modules/feed-list/feed-list-helper"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.store,e.event;var f=a("util"),g=a("moment"),h=(a("dialog"),a("modules/publish/publish")),i=(a("modules/feed-list/feed-list.css"),a("modules/feed-list/feed-list-m")),j=a("modules/feed-list/feed-list-c"),e=a("modules/feed-list/feed-list.html"),k=a("modules/feed-list/feed-list-helper");k.feedContentFormat;var l=(i.itemM,j.listC),m=$(e),n=h.atInput,o=h.mediaMaker,p=f.getContactData(),q=p.u,r=k.feedContentFormat_,s=function(a){var b=a.val(),c=!0;return""==b&&(f.showInputError(a),c=!1),c},t=Backbone.View.extend({tagName:"div",template:_.template(m.filter(".preview-feed").html()),className:"list-item fn-clear",events:{"click .feed-content-visible-h":"fcVisibleH","click .feed-reply-content-visible-h":"fRcVisibleH","click .aj-replyinput":"replyinput","click .aj-replytext":"replytext","click .aj-replysubmit":"replysubmit","click .aj-replysubmit-sub":"replysubmitsub","click .reply-audio-open-btn":"audioBtn","click .reply-audio-close-btn":"audioCloseBtn","click .fs-switch-tpl-l":"_clickSwitchTplLink"},audioCloseBtn:function(a){var b=$(a.currentTarget),c=b.closest(".list-item"),d=$(".audio-btn",c),e=$(".audio-warp",c);e.hide(),d.show(),this.audioPlayer&&this.audioPlayer.stop()},audioBtn:function(a){var b=$(a.currentTarget),c=b.closest(".audio-el"),d=$(".audio-warp",c),e=this.model,f=e.get("attachPath"),g=e.get("originData");b.hide(),d.show(),this.audioPlayer||(this.audioPlayer=new AudioPlayer({element:$(".audio-box",d),audioSrc:f,length:g.audio.attachSize}),this.compStore.push(this.audioPlayer)),this.audioPlayer.play()},fRcVisibleH:function(a){var b=$(a.currentTarget),c=b.closest(".item-detail");$(".feed-summary-text",c);var d=$(".feed-content-lefthtml",c),e=$(".feed-content-ellipsis",c),f=b.attr("feedwordnum");d.is(":visible")?(e.show(),d.hide(),b.text("展开正文，（共"+f+"个字）")):(e.hide(),d.show(),b.text("收起正文")),a.preventDefault()},fcVisibleH:function(a){var b=this.model,c=b.get("feedFormatContent"),d=c.leftHtml,e=$(a.currentTarget),f=e.closest(".content"),g=$(".feed-summary-text",f),h=$(".feed-left-text",f),i=$(".feed-content-ellipsis",f),j=$(".feed-content-visible-h",f);0==h.length?(h=$('<span class="feed-left-text">'+d+"</span>"),h.insertAfter(g),i.hide(),j.text("收起正文")):h.is(":visible")?(h.hide(),j.text("展开正文，（共"+c.feedWordNum+"个字）"),i.show()):(h.show(),j.text("收起正文"),i.hide()),a.preventDefault()},replyEls:function(a){var b=$(a.currentTarget),c=b.closest(".list-item"),d=$(".preview-reply",c),e=$(".item-face",c).attr("feedid"),f=$(".preview-reply-bbar",c),g=$(".feed-reply",c),h=d.val();return{replyinputEl:d,replybbarEl:f,feedreplyEl:g,replyContent:h,feedId:e}},replysubmitsub:function(a){var b=$(a.currentTarget),c=this.replyEls(a),d=b.closest(".item-detail"),e=d.attr("feedid"),f=d.attr("employeeid"),g=$(".aj-senderName",d),h=g.attr("name"),i="回复@"+h+"：";c.replyinputEl.focus().val(i).trigger("autosize.resize"),c.replybbarEl.show(),this.replyEls.replyToReplyID=e,this.replyEls.replyToEmployeeID=f,c.replyinputEl.attr("placeholder","")},replyinput:function(a){var b=this.replyEls(a);b.replybbarEl.show(),b.replyinputEl.focus()},replytext:function(a){var b=this.replyEls(a);b.replybbarEl.is(":visible")||b.replybbarEl.show()},replysubmit:function(a){var b=this,c=this.replyEls(a),d=$(a.currentTarget),e=this.$el,g=$(".aj-replytext .num",e),h=$(".aj-replyinput",e),i=_.str.trim(h.val()),j=new RegExp("^s*$");j.test(i)&&h.val(""),s(h)&&(i.length>2e3?f.alert("请控制输入在2000字内"):f.api({url:"/Feed/SendFeedReply",type:"post",data:{feedID:c.feedId,replyContent:i,replyToReplyID:this.replyEls.replyToReplyID||0,replyToEmployeeID:this.replyEls.replyToEmployeeID||0,fileInfos:[],isSendSms:!1},dataType:"json",success:function(a){a.success&&(c.replybbarEl.hide(),c.replyinputEl.val("").trigger("autosize.resize"),b.getReplyContent(c.feedId),g.text(parseInt(g.text())+1))}},{submitSelector:d}))},getReplyContent:function(a){var b=this;f.api({url:"/Feed/GetFeedReplysByFeedID",type:"get",data:{feedID:a,pageSize:10,pageNumber:1},success:function(a){var c=a.value,d=b.$el,e=$(".feed-reply",d),h=$(".item-face",d).attr("feedid"),i=0,j=0,k="",l="",m="",n="",o="",p="",s="",t=c.totalCount,u=t-10,v="";v=u>0?'<div class="fs-reply-list-summary mt10" style="display: block;">后面还有<span class="num">'+u+'</span>条回复，<a title="" href="#stream/showfeed/=/id-'+h+'/pn-2" class="jump-to-detail-l fs-switch-tpl-l">点击查看 &gt;&gt;</a></div>':"",_.each(c.items,function(b){i=b.feedReplyID,k=b.sender.name,j=b.sender.employeeID,n=b.sender.profileImage,l=f.getDateSummaryDesc(g.unix(b.createTime),g.unix(a.serviceTime),1),k=j==q.employeeID?"我":b.sender.name;var d=r(300,b),e="",h="",t=d.leftHtml;switch(m=d.summaryHtml,t.length>0&&(h='<span class="feed-content-lefthtml hide">'+t+'</span><span class="feed-content-ellipsis">&#8230;</span>',e='<br/><br/><a href="javascript:;" class="feed-reply-content-visible-h" feedwordnum="'+d.feedWordNum+'"> 展开正文，（共'+d.feedWordNum+"个字）</a>"),1!=b.source&&(o="，来自"+b.sourceDescription),c.feedType){case 1:s="";break;case 2:s=f.getPlanOperationType(b.operationType)?"，"+f.getPlanOperationType(b.operationType):"";break;case 3:s=f.getWorkOperationTypeName(b.operationType)?"，"+f.getWorkOperationTypeName(b.operationType):"";break;case 4:s=f.getApproveOperationTypeName(b.operationType)?"，"+f.getApproveOperationTypeName(b.operationType):"";break;default:s=""}var u="",v="";p+='<div class="fs-reply-list-wrapper fn-clear"> <div class="fs-reply-list"> <div class="reply-item fs-list-item"> <div class="item-face"> <a href="#profile/=/empid-'+j+'"> <img src="'+f.getAvatarLink(n,"3")+'" alt=""></a> </div> <div class="item-detail" feedid="'+i+'" employeeid="'+j+'"> <div class="item-info"> <div> <a href="#profile/=/empid-'+j+'" class="aj-senderName" name="'+b.sender.name+'">'+k+'</a>：<span class="feed-summary-text">'+m+"</span>"+h+"("+l+s+o+")"+e+'</div>  <div class="audio-el" >'+u+v+'</div></div> <div class="item-func fn-clear myreply preview-feed"> <div class="handle"> <a href="javascript:void(0);" class="aj-replysubmit-sub">回复</a> </div> </div> </div> </div> </div> </div>'}),a.success&&e.html(p+v)}})},updateModel:function(a){var b=this,c=this.model;this.$el,f.api({url:"/Feed/GetFeedByFeedID",type:"get",data:{feedID:c.get("feedID")},success:function(c){var d=new l;c.success&&(b.model.set(d.parse(c)[0],{"silent ":!1}),b.render(),a&&a.call(b,c))}})},initialize:function(){var a=this.model,b=a.get("feedID");this.compStore=[],this.listenTo(this.model,"change ",this.render),this.getReplyContent(b)},render:function(){var a=this.model;return a.get("originData"),this.$el.addClass("fs-feed-item"),this.$el.html(this.template(this.model.toJSON())),this},renderCpt:function(){var a,b;a=$(".preview-reply",this.$el),b=$(".media",this.$el),this.atInput=new n({element:a}),this.media=new o({element:b,action:["at"],actionOpts:{at:{inputSelector:a}}})},destroy:function(){this.$el.removeData(),_.each(this.compStore,function(a){a.destroy&&a.destroy()}),this.compStore=[],this.atInput&&this.atInput.destroy&&this.atInput.destroy(),this.atInput=null,this.media&&this.media.destroy(),this.media=null,this.remove()}});b.itemV=t});