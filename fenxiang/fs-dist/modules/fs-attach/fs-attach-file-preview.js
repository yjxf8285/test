/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-attach/fs-attach-file-preview",["$","overlay","position","moment","util","./fs-attach.html","./fs-attach.css"],function(a,b,c){var d=window,e=d.FS;e.tpl;var f=a("$"),g=a("overlay"),h=(a("position"),a("moment"),a("util")),i=a("./fs-attach.html"),j=(a("./fs-attach.css"),(f.browser||0).msie&&6==f.browser.version),k=f(document.body),l=(f("html"),f(document),f(window)),m=f(i).filter(".fs-attach-file-reader-tpl"),n=g.extend({attrs:{width:j?l.width():"100%",height:j?l.height():"100%",className:"fs-attach-file-reader",opacity:1,backgroundColor:"#000",style:{position:j?"absolute":"fixed",top:0,left:0},align:{baseElement:j?k:void 0},zIndex:1001,directOpenPath:"/DF/Get",fileInfoPath:"/Doc/Preview",readPath:"/Doc/Page",fileId:0,fileName:"",filePath:"",pageWidth:780,pageHeight:0,pageCount:0},events:{"click .file-reader-tbar .close-l":"_clickCloseLink","click .pagination-wrapper .nav-l":"_clickNavLeft","click .pagination-wrapper .nav-r":"_clickNavRight"},show:function(){return j&&(this.set("width",l.width()),this.set("height",l.height()),this.element.css({top:l.scrollTop(),left:l.scrollLeft()})),n.superclass.show.call(this)},hide:function(){var a;return this._clear(),a=n.superclass.hide.call(this)},setup:function(){var a=this;return this._createEl(),this.before("show",function(){h.setFullScreen(!0)}),this.after("show",function(){a.adjustPosSize()}),this.after("hide",function(){h.setFullScreen(!1)}),this.element.on("click",function(){}),this.after("_setPosition",function(){this.adjustPosSize(),j&&(this.element.css({top:l.scrollTop(),left:l.scrollLeft()}),this.set("width",l.width()),this.set("height",l.height()))}),j&&l.scroll(function(){var b=a.element;b.is(":visible")&&b.css({top:l.scrollTop(),left:l.scrollLeft()})}),this._lazyloadTid=null,this._regEvents(),n.superclass.setup.call(this)},_regEvents:function(){var a=this,b=this.element,c=f(".page-list-wrapper",b);c.bind("scroll",function(b){clearTimeout(a._lazyloadTid),a._lazyloadTid=setTimeout(function(){a._lazyLoadPageImg(),a._updateShowPageNumber(b)},400)})},_unRegEvents:function(){var a=this.element,b=f(".page-list-wrapper",a);b.unbind("scroll")},_createEl:function(){var a=this.element,b=_.template(m.html()),c={};_.extend(c,{blankImgSrc:e.BLANK_IMG}),a.html(b(c))},adjustPosSize:function(){var a=this.element,b=f(".file-reader-tbar",a),c=f(".page-list-wrapper",a),d=l.height();c.height(d-b.outerHeight()-5)},_clickNavLeft:function(a){var b=this.element,c=f(".page-list-wrapper",b),d=this.getActiveNumberByScroll(),e=this.get("pageHeight");d>1&&(d--,c.scrollTop((d-1)*(e+12))),a.preventDefault()},_clickNavRight:function(a){var b=this.element,c=f(".page-list-wrapper",b),d=this.getActiveNumberByScroll(),e=this.get("pageCount"),g=this.get("pageHeight");e>d&&(d++,c.scrollTop((d-1)*(g+12))),a.preventDefault()},_updateShowPageNumber:function(){var a,b=this.element,c=f(".page-list-wrapper",b),d=f(".page-list",b),e=f(".current-page-num",b),g=c.scrollTop(),h=c.height(),i=this.get("pageHeight"),j=this.get("pageCount");a=Math.floor((g+h/2)/i)+1,g+h-d.height()>10&&(a=j),e.val(a)},getActiveNumberByScroll:function(){var a=this.element,b=f(".page-list-wrapper",a),c=b.scrollTop(),d=this.get("pageHeight"),e=Math.floor(c/(d+12))+1;return e},_lazyLoadPageImg:function(){var a,b=this.element,c=f(".page-list-wrapper",b),d=f(".page-item",c),g=this.get("filePath"),h=this.get("pageWidth"),i=this.get("readPath");i=e.API_PATH+i;var j=c.scrollTop(),k=c.height(),l=this.get("pageHeight");a=d.filter(function(){return!f(this).data("rendered")}),a.each(function(){var a=f(this),b=f(".page-box",a),c=d.index(a),e=c*(l+12);j+k>e&&e+k>j&&(b.attr("src",i+"?path="+g+"&pageIndex="+c+"&width="+h+"&maxContentLength=0"),a.data("rendered",!0))})},_clickCloseLink:function(a){this.hide(),a.preventDefault()},_onRenderFilePath:function(a){var b=this,c=this.element,g=f(".download-l",c),i=f(".page-list-wrapper",c),j=f(".file-reader-tbar .file-reader-content",c),k=f(".preview-unit",c),l=f(".total-page-num",c),m=this.get("fileInfoPath"),n=b.get("fileName"),o=this.get("filePath"),p=this.get("directOpenPath");a.length>0&&(this.show(),h.api({url:m,data:{path:a},type:"get",cache:!0,success:function(c){var f,m=0;c.success&&(f=c.value,1==f.previewFormat||2==f.previewFormat?(b.previewFormat=f.previewFormat,m=f.pageCount,l.text(m),b.set("pageCount",m),b._setPageSize(function(){b._renderPageItem(),i.removeClass("overflow-hidden").scrollTop(0),j.width(b.get("pageWidth")),b._lazyLoadPageImg(),b._updateShowPageNumber()}),g.attr("href",h.getDfLink(a,n,!0)),1==f.previewFormat?k.text("页"):2==f.previewFormat&&k.text("Sheet")):3==f.previewFormat&&(b.hide(),d.open(e.API_PATH+p+"/"+o,"_blank")))}},{}))},_onRenderFileName:function(a){var b=this.element,c=f(".file-name",b);c.text(a)},_renderPageItem:function(){var a=this.get("pageCount"),b=this.get("pageWidth"),c=this.get("pageHeight"),d=this.element,g=f(".page-list",d),h="",i=this.previewFormat;if(1==i)for(var j=0;a>j;j++)h+='<div class="page-item" style="width:'+b+'px"><img src="'+e.BLANK_IMG+'" alt="'+(j+1)+'" class="page-img page-box" width="'+b+'" height="'+c+'" /></div>';else if(2==i)for(var j=0;a>j;j++)h+='<div class="page-item" style="width:'+b+'px"><iframe class="page-box" src="'+e.BLANK_PAGE+'" scrolling="no" frameborder="0" class="page-html" width="'+b+'" height="'+c+'" /></div>';g.html(h)},_setPageSize:function(a){var b=this,c=this.get("filePath"),d=this.get("pageWidth"),g=this.get("readPath"),h=this.previewFormat;g=e.API_PATH+g;var i,j,k=g+"?path="+c+"&pageIndex=0&width="+d+"&maxContentLength=0";1==h?(i=new Image,i.onload=function(){b.set("pageHeight",this.height),b.set("pageWidth",this.width),a.call(b),i.onload=null,i=null},i.src=k):2==h&&(j=f("<iframe/>"),j.load(function(){var c=this.contentWindow,d=f(c.document.body),e=f("table",d);b.set("pageHeight",parseInt(e.height()+10)),b.set("pageWidth",parseInt(e.width()+10)),a.call(b),j.unbind("load"),j.remove()}),j.addClass("fn-hide-abs").attr("src",k).appendTo("body"))},_clear:function(){var a=this.element,b=f(".download-l",a),c=f(".preview-unit",a),d=f(".total-page-num",a),e=f(".page-list-wrapper",a),g=f(".page-list",a),h=f(".file-reader-tbar .file-reader-content",a);e.addClass("overflow-hidden"),g.scrollTop(0).empty(),h.width(780),this.set("fileId",0),this.set("fileName",""),this.set("filePath",""),this.set("pageWidth",780),this.set("pageHeight",0),this.set("pageCount",0),d.text(0),g.empty(),b.attr("href","#"),c.text("")},readFile:function(a){var b,c,g=this.get("fileInfoPath"),i=this.get("directOpenPath");return a.bindLinkSelector&&(c=f(a.bindLinkSelector)),this.rendered||this.render(),b=h.getFileExtText(a.fileName),"xls"==b||"xlsx"==b?(d.open(e.BASE_PATH+g+"/"+a.filePath+"?name="+encodeURIComponent(a.fileName)+"&_x=0","_blank"),void 0):"img"==h.getUploadType(a.fileName)||"txt"==b||"csv"==b?(c?c.attr("href",e.API_PATH+i+"/"+a.filePath):d.open(e.API_PATH+i+"/"+a.filePath,"_blank"),void 0):(this.set("fileId",a.fileId),this.set("fileName",a.fileName),this.set("filePath",a.filePath),void 0)},destroy:function(){var a;return this._unRegEvents(),this.element.empty(),clearTimeout(this._lazyloadTid),this._lazyloadTid=null,a=n.superclass.destroy.apply(this,arguments)}});c.exports={FileReader:n}});