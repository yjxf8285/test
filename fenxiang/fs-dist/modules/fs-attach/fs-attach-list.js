/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-attach/fs-attach-list",["util","./fs-attach-preview","preview","moment","./fs-attach.css","widget","modules/feed-list/feed-list-c","modules/feed-list/feed-list-m","modules/feed-list/preview-feed-v","uilibs/pagination","spin","dialog","modules/publish/publish","./fs-attach.html","./fs-attach.css"],function(a,b,c){var d=window,e=d.FS;e.tpl;var f=a("util"),g=a("./fs-attach-preview"),h=a("uilibs/pagination"),i=(a("spin"),a("moment")),j=(a("dialog"),a("modules/publish/publish")),k=a("./fs-attach.html");a("./fs-attach.css");var l=$(k),m=(new g).render(),n=j.showFeedPwdValid,o=f.getContactData(),p=o.u,q=Backbone.Model.extend({}),r=Backbone.Collection.extend({model:q,url:"/attach/getAttachFilesOfIReceive",sync:function(a,b,c){var d=c.data||{};c.data=_.extend({attachType:3,feedType:0,keyword:"",pageSize:10,pageNumber:1},d),Backbone.sync("read",b,c)},parse:function(a){var b,c=[];return a.success&&(b=a.value.items,_.each(b,function(b,d){var g=b.employee,h=b.attachs[0],j=g?g.name:"";g&&g.employeeID==p.id&&(j="我"),c[d]={feedId:b.dataID?b.dataID:h.dataID,blankImgSrc:e.BLANK_IMG,fileType:f.getFileType({name:h.attachName}),attachs:b.attachs,attachName:h.attachName,attachSize:h.attachSize,attachTitle:h.attachName+"("+f.getFileSize(h.attachSize)+")",attachSummary:'<span class="employee-name">'+j+"</span>上传于"+f.getDateSummaryDesc(i.unix(b.createTime),i.unix(a.serviceTime),1),attachPath:h.attachPath,createTime:b.createTime,attachId:b.attachID,employeeName:j,isEncrypted:b.isEncrypted,encryptTitle:b.encryptTitle||"",serverTime:a.serverTime,canPreview:h.canPreview}})),c}}),s=Backbone.View.extend({tagName:"div",template:_.template(l.filter(".fs-attach-item-tpl").html()),className:"fs-attach-item",events:{"click .fs-attach-item-desc":"showPreview","click .lockapv-open":"showLockOpen"},showPreview:function(){var a=this.model,b=a.get("attachs");m.preview({type:"attach",data:[{previewPath:e.BLANK_IMG,originPath:a.get("attachPath"),thumbPath:e.BLANK_IMG,createTime:a.get("createTime"),fileName:a.get("attachName"),fileSize:a.get("attachSize"),fileId:a.get("attachId"),employeeName:a.get("employeeName"),serverTime:a.get("serverTime"),canPreview:a.get("canPreview")}],refId:a.get("feedId"),belongToType:f.getAttachSourceName(b[0].source)})},showLockOpen:function(a){var b=this.$el,c=$(".fs-attach-item-lockapv",b),d=this.model;n(function(a){a.success&&c.hide()},function(){},{feedID:d.get("feedId")}),a.preventDefault()},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),t=Backbone.Model.extend({}),u=Backbone.Collection.extend({model:t,url:"#",sync:function(a,b,c){var d=c.data||{};c.data=_.extend({attachType:3,feedType:0,keyword:"",pageSize:10,pageNumber:1},d),Backbone.sync("read",b,c)},parse:function(a){var b,c=[];return a.success&&(b=a.value.items,_.each(b,function(b,d){var g=b.employee,h=b.attachs[0],j=g?g.name:"";g&&g.employeeID==p.id&&(j="我"),c[d]={feedId:b.dataID?b.dataID:h.dataID,blankImgSrc:e.BLANK_IMG,fileType:f.getFileType({name:h.attachName}),attachs:b.attachs,attachName:h.attachName,attachSize:h.attachSize,attachTitle:f.getFileNamePath(h.attachName)+".mp3"+"("+h.attachSize+"秒)",attachSummary:'<span class="employee-name">'+j+"</span>上传于"+f.getDateSummaryDesc(i.unix(b.createTime),i.unix(a.serviceTime),1),attachPath:h.attachPath,createTime:b.createTime,attachId:b.attachID,employeeName:j,isEncrypted:b.isEncrypted,encryptTitle:b.encryptTitle||"",serverTime:a.serverTime}})),c}}),v=Backbone.View.extend({tagName:"div",template:_.template(l.filter(".fs-audio-item-tpl").html()),className:"fs-audio-item",events:{"click .fs-audio-item-desc":"showPreview","click .lockapv-open":"showLockOpen"},showPreview:function(){var a=this.model,b=a.get("attachs");m.preview({type:"audio",data:[{previewPath:e.BLANK_IMG,originPath:a.get("attachPath"),thumbPath:e.BLANK_IMG,createTime:a.get("createTime"),fileName:a.get("attachName"),fileSize:a.get("attachSize"),fileId:a.get("attachId"),employeeName:a.get("employeeName")}],refId:a.get("feedId"),belongToType:f.getAttachSourceName(b[0].source)})},showLockOpen:function(a){var b=this.$el,c=$(".fs-audio-item-lockapv",b),d=this.model;n(function(a){a.success&&c.hide()},function(){},{feedID:d.get("feedId")}),a.preventDefault()},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),w=Backbone.Model.extend({}),x=Backbone.Collection.extend({model:w,url:"/attach/getImgImgFilesOfIReceive",sync:function(a,b,c){var d=c.data||{};c.data=_.extend({feedType:0,keyword:"",pageSize:10,pageNumber:1},d),Backbone.sync("read",b,c)},parse:function(a){var b,c=[];return a.success&&(b=a.value.items,_.each(b,function(b,d){var e,g,h=b.employee,j=b.attachs,k="",l=h?h.name:"";h&&h.employeeID==p.id&&(l="我"),e=_.find(j,function(a){return"jpg"==a.fileIcon}),j.length>1?(g='<span class="employee-name">'+l+"</span>上传于"+f.getDateSummaryDesc(i.unix(b.createTime),i.unix(a.serviceTime),1)+"，图集（共"+j.length+"张）",k="fpt-group"):g='<span class="employee-name">'+l+"</span>上传于"+f.getDateSummaryDesc(i.unix(b.createTime),i.unix(a.serviceTime),1),c[d]={feedId:b.dataID?b.dataID:e.dataID,attachs:j,thumbSrc:f.getDfLink(e.attachPath+"3","",!1,"jpg"),imgSummary:g,imgWrapperCls:k,attachPath:e.attachPath,attachName:e.attachName,attachSize:e.attachSize,createTime:e.createTime,attachId:e.attachID,employeeName:e.employeeName||"",isEncrypted:b.isEncrypted,encryptTitle:b.encryptTitle||""}})),c}}),y=Backbone.View.extend({tagName:"div",template:_.template(l.filter(".fs-img-item-tpl").html()),className:"fs-img-item",events:{"click .fs-img-item-thumb":"showPreview","click .lockapv-open":"showLockOpen"},showPreview:function(){var a=this.model,b=a.get("attachs"),c=[];_.each(b,function(b,d){c[d]={previewPath:b.attachPath+"2",originPath:b.attachPath+"1",thumbPath:b.attachPath+"3",createTime:b.createTime,fileName:b.attachName,fileSize:b.attachSize,fileId:b.attachID,employeeName:a.get("employeeName")}}),m.preview({type:"img",data:c,refId:a.get("feedId"),belongToType:f.getAttachSourceName(b[0].source)})},showLockOpen:function(a){var b=this.$el,c=$(".fs-img-item-lockapv",b),d=this.model;n(function(a){a.success&&c.hide()},function(){},{feedID:d.get("feedId")}),a.preventDefault()},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),z=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:45,totalSize:-1,visiblePageNums:7},attachType:"attach",listPath:"/attach/getAttachFilesOfIReceive",defaultRequestData:{},searchOpts:{inputSelector:null,btnSelector:null},listEmptyText:"暂无记录",showSenderName:!0},a||{}),this.opts=a,this.element=$(a.element),this.pagEl=$(a.pagSelector),this.pagination=null,this.tempRequestData={},this.init()};_.extend(z.prototype,{init:function(){var a,b,c,d,e=this,f=this.opts,g=this.element,i=f.attachType;"attach"==i?(c=r,d=s):"img"==i?(c=x,d=y):"audio"==i&&(c=u,d=v),g.addClass("fs-"+i+"-list").html('<div class="fs-'+i+'-list-inner fn-clear"></div>'),b=$(".fs-"+i+"-list-inner",g),a=new c,a.on("add",function(a){var c;c=new d({model:a}).render(),f.showSenderName?$(".employee-name",c.$el).show():$(".employee-name",c.$el).hide(),c.$el.data("itemV",c).appendTo(b)}),this.list=a,this.pagination=new h(_.extend({element:this.pagEl},f.pagOpts)),this.pagination.on("page",function(){e.empty(),e.fetch()}),this.pagination.render(),f.searchOpts&&f.searchOpts.inputSelector&&this._searchBarInit(),this._initListEmptyTip()},_searchBarInit:function(){var a,b=this,c=this.opts,d=c.searchOpts,e=this.element,f=$(d.inputSelector),g=$(d.btnSelector);a=$('<div class="list-search-bar fn-clear"></div>'),a.html('<span class="result-info fn-left">共搜索到<span class="num color-red">0</span>条信息</span><a class="back-l fn-right" href="#" title="返回查看全部"><< 返回查看全部</a>'),a.hide().prependTo(e);var h=$('<span class="empty-h">&#10005;</span>'),i=$('<span class="list-search-input-wrapper"></span>');f.wrap(i),i=f.closest(".list-search-input-wrapper"),h.hide().appendTo(i),f.keydown(function(a){13==a.keyCode&&g.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(h.show(),f.addClass("with-input-value")):(h.hide(),f.removeClass("with-input-value"))}),h.click(function(){f.val(""),f.removeClass("with-input-value"),h.hide()}),a.on("click",".back-l",function(c){var d=$(".list-empty-tip",e);b.reload({keyword:""}),f.val(""),f.removeClass("with-input-value"),h.hide(),d.hide(),a.hide(),c.preventDefault()}),this.searchBarEl=a},_searchBarDestroy:function(){var a,b,c=this.opts,d=c.searchOpts;this.searchBarEl&&(a=$(d.inputSelector),b=a.closest(".list-search-input-wrapper"),a.insertAfter(b),b.remove(),a.val("").unbind(),this.searchBarEl.remove(),this.searchBarEl=null)},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".num",d);return a.keyword.length>0&&b.success?(e.text(b.value.totalCount),d.show(),void 0):(d.hide(),void 0)},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+e.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.appendTo(a)},_updatelistStatus:function(a){var b,c=this.element,d=$(".list-empty-tip",c);a.success&&(b=a.value.totalCount,0==b?d.show():d.hide())},fetch:function(){var a=this,b=this.opts,c=(this.list,this.pagination),d=_.extend({pageSize:c.get("pageSize"),pageNumber:c.get("activePageNumber")});d=_.isFunction(b.defaultRequestData)?_.extend(b.defaultRequestData(),d):_.extend(b.defaultRequestData,d),d=_.extend(d,this.tempRequestData),this.tempRequestData={},this.showLoading(),this.list.fetch({url:b.listPath,data:d,success:function(b,d,e){var f;d.success&&(f=d.value,c.setTotalSize(f.totalCount),a._updateSearchBarState(e.data,d),a._updatelistStatus(d),a.hideLoading())}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a){this.tempRequestData=a,this.pagination.jump(1)},reload:function(a){this.load(a)},empty:function(){var a=this.opts,b=a.attachType,c=$(".fs-"+b+"-list-inner",this.element),d=$(".fs-"+b+"-item",c);d.each(function(){var a=$(this),b=a.data("itemV");b.remove(),a.removeData()}),c.empty()},destroy:function(){this._searchBarDestroy(),this.list=null,this.pagination.destroy(),this.loading&&this.loading.stop(),this.empty(),this.pagination=null,this.tempRequestData={},this.element=null}}),c.exports=z});