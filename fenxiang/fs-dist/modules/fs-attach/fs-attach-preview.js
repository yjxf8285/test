/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("modules/fs-attach/fs-attach-preview",["preview","moment","./fs-attach.css","util","widget","modules/feed-list/feed-list-c","modules/feed-list/feed-list-m","modules/feed-list/preview-feed-v"],function(a,b,c){var d=window,e=d.FS,f=e.tpl,g=(f.store,f.event),h=a("preview"),i=(a("moment"),a("./fs-attach.css"),a("util")),j=a("widget"),k=h.extend({attrs:{zIndex:1e3,belongToType:"feed",refId:""},setup:function(){var a=k.superclass.setup.apply(this,arguments);return this.previewInfoCpt=[],a},render:function(){var a=k.superclass.render.apply(this,arguments);return a},hide:function(){var a=this,b=this.element,c=$(".preview-reply",b);_.str.trim(c.val()).length>0?i.confirm("已输入回复内容，关闭后要清空内容，是否确定要关闭？","提示",function(){k.superclass.hide.apply(a,arguments)}):k.superclass.hide.apply(this,arguments)},_renderPreviewInfo:function(){var a=this.element,b=$(".ui-preview-info",a),c=$(".ui-preview-panel",a),d=this.get("belongToType"),e=c.css("margin-right");b.addClass("ui-preview-info-attach"),"feed"==d?(c.css({"margin-right":e}),b.show(),this._renderFeedPreviewInfo()):(c.css({"margin-right":"0px"}),b.hide())},_resetPreviewInfo:function(){var a=this.element,b=$(".ui-preview-info",a);_.each(this.previewInfoCpt,function(a){a.destroy&&a.destroy()}),this.previewInfoCpt=[],b.empty()},_renderFeedPreviewInfo:function(){var b=this,c=this.element,d=$(".ui-preview-info",c),e=this.get("refId"),f=a("modules/feed-list/feed-list-c"),g=a("modules/feed-list/feed-list-m"),h=a("modules/feed-list/preview-feed-v"),j=f.listC,k=g.itemM,l=h.itemV,m=new j;i.api({url:"/feed/getFeedByFeedID",data:{feedID:e},type:"get",success:function(a){var c,e,f;a.success&&(c=m.parse(a),e=new l({model:new k(c[0]),replyListOpts:{listPath:"/Feed/GetFeedReplysByFeedID",withPagination:!1},replyWithMedia:!1}).render(),f=e.$el,f.appendTo(d),e.renderCpt(),b.previewInfoCpt.push(e))}})},preview:function(a){var b=a.data,c=a.refId,d=a.belongToType,e=a.type;this._resetPreviewInfo(),this.set("data",b),this.set("refId",c),this.set("belongToType",d),this.set("type",e),this.set("activeIndex",0),this._renderPreviewInfo(),this.show()},_getFileLink:function(){var a=this.get("belongToType");return"notice"==a?i.getDfGlobalLink.apply(this,Array.prototype.slice.call(arguments,0)):i.getDfLink.apply(this,arguments)},destroy:function(){var a;return this._resetPreviewInfo(),a=k.superclass.destroy.apply(this,arguments)}});g.on("switch",function(){$(".ui-preview").each(function(){j.query(this).hide()})}),c.exports=k});