/**
 * 纷享资源脚本
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
(function(){!function(a){return"function"==typeof define&&define.amd?define(["jquery"],a):a(window.jQuery)}(function(a){var b,c,d,e,f,g;return f=function(){function b(a){this.$inputor=a}return b.prototype.css_attr=["overflowY","height","width","paddingTop","paddingLeft","paddingRight","paddingBottom","marginTop","marginLeft","marginRight","marginBottom","fontFamily","borderStyle","borderWidth","wordWrap","fontSize","lineHeight","overflowX","text-align"],b.prototype.copy_inputor_css=function(){var b,c=this;return b={position:"absolute",left:-9999,top:0,zIndex:-2e4,"white-space":"pre-wrap"},a.each(this.css_attr,function(a,d){return b[d]=c.$inputor.css(d)}),b},b.prototype.create=function(b){return this.$mirror=a("<div></div>"),this.$mirror.css(this.copy_inputor_css()),this.$mirror.html(b),this.$inputor.after(this.$mirror),this},b.prototype.get_flag_rect=function(){var a,b,c;return a=this.$mirror.find("span#flag"),b=a.position(),c={left:b.left,top:b.top,bottom:a.height()+b.top},this.$mirror.remove(),c},b}(),e={DOWN:40,UP:38,ESC:27,TAB:9,ENTER:13},c={data_refactor:function(b){return a.isArray(b)?a.map(b,function(b){return a.isPlainObject(b)||(b={name:b}),b}):b},matcher:function(a,b){var c,d,e;return e=new RegExp(a+"([A-Za-z0-9_+-]*)$|"+a+"([^\\x00-\\xff]*)$","gi"),c=e.exec(b),d=null,c&&(d=c[2]?c[2]:c[1]),d},filter:function(b,c,d){return a.map(c,function(c){var e;return e=a.isPlainObject(c)?c[d]:c,e.toLowerCase().indexOf(b)>=0?c:void 0})},remote_filter:function(b,c,d){return a.ajax(c,{data:b,success:function(a){return d(a)}})},sorter:function(a,b,c){var d,e,f,g,h;if(!a)return b.sort(function(a,b){return a[c].toLowerCase()>b[c].toLowerCase()?1:-1});for(e=[],g=0,h=b.length;h>g;g++)d=b[g],f=d[c],d.order=f.toLowerCase().indexOf(a),e.push(d);return e.sort(function(a,b){return a.order-b.order})},tpl_eval:function(a,b){var c;try{return c=a.replace(/\$\{([^\}]*)\}/g,function(a,c){return b[c]})}catch(d){return""}},highlighter:function(a,b){return b?a.replace(new RegExp(">\\s*(\\w*)("+b.replace("+","\\+")+")(\\w*)\\s*<","ig"),function(a,b,c,d){return"> "+b+"<strong>"+c+"</strong>"+d+" <"}):a},selector:function(a){return a.length>0?this.replace_str(a.data("value")||""):void 0}},b=function(){function b(b){this.settings={},this.common_settings={},this.pos=0,this.flags=null,this.current_flag=null,this.query=null,this.$inputor=a(b),this.mirror=new f(this.$inputor),this.common_settings=a.extend({},a.fn.atwho["default"]),this.view=new g(this,this.$el),this.listen()}return b.prototype.listen=function(){var a=this;return this.$inputor.on("keyup.atwho",function(b){return a.on_keyup(b)}).on("keydown.atwho",function(b){return a.on_keydown(b)}).on("scroll.atwho",function(){return a.view.hide()}).on("blur.atwho",function(){return a.view.hide(a.get_opt("display_timeout"))})},b.prototype.reg=function(b,c){var d,e;return d={},d=a.isPlainObject(b)?this.common_settings=a.extend({},this.common_settings,b):this.settings[b]=this.settings[b]?a.extend({},this.settings[b],c):a.extend({},c),e=d.data,d.data=this.callbacks("data_refactor").call(this,e),this},b.prototype.trigger=function(a,b){return b||(b=[]),b.push(this),this.$inputor.trigger(""+a+".atwho",b)},b.prototype.data=function(a){return a?this.$inputor.data("atwho-data",a):this.$inputor.data("atwho-data")},b.prototype.callbacks=function(a){var b;return(b=this.get_opt("callbacks",{})[a])||(b=this.common_settings.callbacks[a]),b},b.prototype.get_opt=function(a,b){var c;try{return this.current_flag&&(c=this.settings[this.current_flag][a]),void 0===c&&(c=this.common_settings[a]),c=void 0===c?b:c}catch(d){return c=void 0===b?null:b}},b.prototype.rect=function(){var b,c,d,e,f,g,h,i,j,k;return b=this.$inputor,document.selection?(c=document.selection.createRange(),j=c.boundingLeft+b.scrollLeft(),k=c.boundingTop+a(window).scrollTop()+b.scrollTop(),e=k+c.boundingHeight,{top:k-2,left:j-2,bottom:e-2}):(f=function(a){return a.replace(/</g,"&lt").replace(/>/g,"&gt").replace(/`/g,"&#96").replace(/"/g,"&quot").replace(/\r\n|\r|\n/g,"<br />")},i=b.val().slice(0,this.pos-1),g="<span>"+f(i)+"</span>",g+="<span id='flag'>?</span>",h=b.offset(),d=this.mirror.create(g).get_flag_rect(),j=h.left+d.left-b.scrollLeft(),k=h.top-b.scrollTop(),e=k+d.bottom,k+=d.top,{top:k,left:j,bottom:e+2})},b.prototype.catch_query=function(){var b,c,d,e,f,g,h=this;return c=this.$inputor.val(),b=FS.util.getCursorPosition(this.$inputor.get(0)).start,g=c.slice(0,b),e=null,a.each(this.settings,function(a){return h.current_flag=a,e=h.callbacks("matcher").call(h,a,g),null!=e?!1:void 0}),"string"==typeof e?(f=b-e.length,d=f+e.length,this.pos=f,e={text:e.toLowerCase(),head_pos:f,end_pos:d},this.trigger("matched",[this.current_flag,e.text])):this.view.hide(),this.query=e},b.prototype.replace_str=function(a){var b,c,d,e,f,g=this.get_opt("insertSeparator",!0),h="";return b=this.$inputor,d=b.val(),c=this.get_opt("display_flag")?0:this.current_flag.length,e=d.slice(0,(this.query.head_pos||0)-c),g&&(h=" "),f=""+e+a+h+d.slice(this.query.end_pos||0),b.val(f),b.caretPos(e.length+a.length+1),b.change()},b.prototype.on_keyup=function(b){switch(b.keyCode){case e.ESC:b.preventDefault(),this.view.hide();break;case e.DOWN:case e.UP:a.noop();break;default:this.look_up()}return b.stopPropagation()},b.prototype.on_keydown=function(b){if(this.view.visible()){switch(b.keyCode){case e.ESC:b.preventDefault(),this.view.hide();break;case e.UP:b.preventDefault(),this.view.prev();break;case e.DOWN:b.preventDefault(),this.view.next();break;case e.TAB:case e.ENTER:if(!this.view.visible())return;b.preventDefault(),this.view.choose();break;default:a.noop()}return b.stopPropagation()}},b.prototype.render_view=function(a){var b;return b=this.get_opt("search_key"),a=this.callbacks("sorter").call(this,this.query.text,a,b),a=a.splice(0,this.get_opt("limit")),this.data(a),this.view.render(a)},b.prototype.remote_call=function(b,c){var d,e;return d={q:c.text,limit:this.get_opt("limit")},e=function(a){return this.render_view(a)},e=a.proxy(e,this),this.callbacks("remote_filter").call(this,d,b,e)},b.prototype.look_up=function(){var b,c,d;return(c=this.catch_query())?(b=this.get_opt("data"),d=this.get_opt("search_key"),"string"==typeof b?this.remote_call(b,c):(b=this.callbacks("filter").call(this,c.text,b,d))?this.render_view(b):this.view.hide(),a.noop()):!1},b}(),g=function(){function b(b){this.controller=b,this.id=this.controller.get_opt("view_id","at-view"),this.timeout_id=null,this.$el=a("#"+this.id),this.create_view()}return b.prototype.create_view=function(){var b,c,d=this;if(!this.exist())return c="<div id='"+this.id+"' class='at-view'><ul id='"+this.id+"-ul'></ul></div>",a("body").append(c),this.$el=a("#"+this.id),b=this.$el.find("ul"),b.on("mouseenter.view","li",function(c){return b.find(".cur").removeClass("cur"),a(c.currentTarget).addClass("cur")}).on("click",function(a){return a.stopPropagation(),a.preventDefault(),d.$el.data("_view").choose()})},b.prototype.exist=function(){return a("#"+this.id).length>0},b.prototype.visible=function(){return this.$el.is(":visible")},b.prototype.choose=function(){var a;return a=this.$el.find(".cur"),this.controller.callbacks("selector").call(this.controller,a),this.controller.trigger("choose",[a]),this.hide()},b.prototype.reposition=function(){var b,c;return c=this.controller.rect(),c.bottom+this.$el.height()-a(window).scrollTop()>a(window).height()&&(c.bottom=c.top-this.$el.height()),b={left:c.left,top:c.bottom},this.$el.offset(b),this.controller.trigger("reposition",[b])},b.prototype.next=function(){var b,c;return b=this.$el.find(".cur").removeClass("cur"),c=b.next(),c.length||(c=a(this.$el.find("li")[0])),c.addClass("cur")},b.prototype.prev=function(){var a,b;return a=this.$el.find(".cur").removeClass("cur"),b=a.prev(),b.length||(b=this.$el.find("li").last()),b.addClass("cur")},b.prototype.show=function(){return this.visible()||this.$el.show(),this.reposition()},b.prototype.hide=function(a){var b,c=this;return isNaN(a)?this.visible()?this.$el.hide():void 0:(b=function(){return c.hide()},clearTimeout(this.timeout_id),this.timeout_id=setTimeout(b,a))},b.prototype.clear=function(){return this.$el.find("ul").empty()},b.prototype.render=function(b){var c,e,f=this;return a.isArray(b)?b.length<=0?(this.hide(),!0):(this.clear(),this.$el.data("_view",this),c=this.$el.find("ul"),e=this.controller.get_opt("tpl",d),a.each(b,function(b,d){var g,h;return h=f.controller.callbacks("tpl_eval").call(f.controller,e,d),g=a(f.controller.callbacks("highlighter").call(f.controller,h,f.controller.query.text)),g.data("info",d),c.append(g)}),this.show(),c.find("li:eq(0)").addClass("cur")):!1},b}(),d="<li data-value='${name}'>${name}</li>",a.fn.atwho=function(c,d){return this.filter("textarea, input").each(function(){var e,f;return e=a(this),f=e.data("atwho"),f||e.data("atwho",f=new b(this)),f.reg(c,d)})},a.fn.atwho.Controller=b,a.fn.atwho.View=g,a.fn.atwho.Mirror=f,a.fn.atwho["default"]={data:null,search_key:"name",callbacks:c,limit:10,display_flag:!0,display_timeout:300,tpl:d}})}).call(this),function(){!function(a){return"object"==typeof exports?a(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"]):a(window.jQuery)}(function(a){var b,c;return b=function(a){var b,c,d,e,f,g,h,i;return document.selection?(g=document.selection.createRange(),f=0,g&&g.parentElement()===a&&(e=a.value.replace(/\r\n/g,"\n"),d=e.length,i=a.createTextRange(),i.moveToBookmark(g.getBookmark()),c=a.createTextRange(),c.collapse(!1),i.compareEndPoints("StartToEnd",c)>-1?h=b=d:(h=-i.moveStart("character",-d),b=-i.moveEnd("character",-d)))):h=a.selectionStart,h},c=function(a,b){var c;return document.selection?(c=a.createTextRange(),c.move("character",b),c.select()):a.setSelectionRange(b,b)},a.fn.caretPos=function(a){var d;return d=this[0],d.focus(),a?c(d,a):b(d)}})}.call(this);