define("uilibs/preview",["$","overlay","position","moment","util","swfobject","uilibs/audio-player","modules/fs-attach/fs-attach-file-preview"],function(a,b,c){var d=a("$"),e=a("overlay"),f=a("position"),g=a("moment"),h=a("util"),i=a("swfobject"),j=a("uilibs/audio-player"),k=a("modules/fs-attach/fs-attach-file-preview"),l=(d.browser||0).msie&&6==d.browser.version,m=d(document.body),n=(d("html"),d(document),d(window)),o=k.FileReader,p=0,q=0,r=0,s=new o,t=e.extend({attrs:{width:l?n.width():"100%",height:l?n.height():"100%",className:"ui-preview fs-float-win",opacity:1,backgroundColor:"#000",style:{position:l?"absolute":"fixed",top:0,left:0},align:{baseElement:l?m:void 0},type:"img",data:[],activeIndex:-1,zIndex:100},events:{"click .ui-preview-close-btn":"_clickCloseBtn","click .ui-preview-img-panel .ui-preview-nav-item":"previewImg","click .ui-preview-img-panel .ui-preview-img-tools .rotate-l":"rotateLeft","click .ui-preview-img-panel .ui-preview-img-tools .rotate-r":"rotateRight","click .ui-preview-img-panel .ui-preview-img-tools .view-origin":"viewOrigin","click .ui-preview-img-panel .ui-preview-img-tools .download-origin":"downloadOrigin","click .ui-preview-switch-l,.ui-preview-switch-r":"switchItem","click .ui-preview-img-panel .ui-preview-img":"clickPreviewImg","click .ui-preview-attach-wrapper .attach-preview-l":"clickPreviewAttach","click .ui-preview-audio-wrapper .audio-player-wrapper":"clickAudioPlayer"},show:function(){return l&&(this.set("width",n.width()),this.set("height",n.height()),this.element.css({top:n.scrollTop(),left:n.scrollLeft()})),t.superclass.show.call(this)},hide:function(){return this.audioPlayer&&this.audioPlayer.stop(),t.superclass.hide.call(this)},_clickCloseBtn:function(a){this.hide(),a.preventDefault(),a.stopPropagation()},previewImg:function(a){var b=this.element,c=d(".ui-preview-nav-item",b),e=d(a.currentTarget),f=c.index(e);this.set("activeIndex",f),a.stopPropagation()},switchItem:function(a){var b=this.element,c=d(".ui-preview-nav-item",b),e=d(a.currentTarget),f=c.length,g=this.get("activeIndex");e.hasClass("ui-preview-switch-r")?g==f-1?g=0:g++:0==g?g=f-1:g--,this.set("activeIndex",g),a.stopPropagation()},clickPreviewImg:function(a){var b=this.element,c=d(".ui-preview-switch-r",b),e=this.get("activeIndex"),f=this.get("data");e+1==f.length?this.set("activeIndex",0):c.click(),a.stopPropagation()},clickPreviewAttach:function(a){var b=this.get("activeIndex"),c=this.get("data"),d=c[b];s.readFile({fileId:d.fileId,fileName:d.fileName,filePath:d.originPath}),a.preventDefault(),a.stopPropagation()},rotateLeft:function(b){var c=this.element,e=d(".ui-preview-box",c),f=d(".ui-preview-img",e);a.async("jslibs/jquery-rotate-2.2.js",function(){p-=90,f.rotate(p)}),b.stopPropagation()},rotateRight:function(b){var c=this.element,e=d(".ui-preview-box",c),f=d(".ui-preview-img",e);a.async("jslibs/jquery-rotate-2.2.js",function(){p+=90,f.rotate(p)}),b.stopPropagation()},viewOrigin:function(a){a.stopPropagation()},downloadOrigin:function(a){a.stopPropagation()},clickAudioPlayer:function(a){a.stopPropagation()},setup:function(){var a=this;return this._imgSizeStore=[],this._createEl(),this.before("show",function(){h.setFullScreen(!0)}),this.after("show",function(){a._adjustPanel()}),this.after("hide",function(){a._resetPanel(),h.setFullScreen(!1)}),this.element.on("click",function(b){a.hide(),b.stopPropagation()}),this.after("_setPosition",function(){this._adjustPanel(),l&&(this.element.css({top:n.scrollTop(),left:n.scrollLeft()}),this.set("width",n.width()),this.set("height",n.height()))}),l&&n.scroll(function(){var b=a.element;b.is(":visible")&&b.css({top:n.scrollTop(),left:n.scrollLeft()})}),t.superclass.setup.call(this)},_createEl:function(){var a=this.element,b=this.get("type");a.html('<span class="ui-preview-close-btn">&#10005;</span><div class="ui-preview-info"></div><div class="ui-preview-panel ui-preview-'+b+'-panel"><div class="ui-preview-panel-inner"><div class="ui-preview-port"><div class="ui-preview-switch-l"><a href="javascript:;">&#139;</a></div><div class="ui-preview-switch-r"><a href="javascript:;">&#155;</a></div><div class="ui-preview-box"></div></div><div class="ui-preview-action-panel"></div></div></div>'),"img"==b?this._createImgEl():"attach"==b?this._createAttachEl():"audio"==b&&this._createAudio(),this._createNavEl(),d(".ui-preview-nav-item",a).length>1?(d(".ui-preview-switch-l,.ui-preview-switch-r",a).show(),d(".ui-preview-action-panel",a).show()):(d(".ui-preview-switch-l,.ui-preview-switch-r",a).hide(),d(".ui-preview-action-panel",a).hide(),d(".batch-download-origin",a).hide()),d(".ui-preview-info",a).click(function(a){a.stopPropagation()})},_createAttachEl:function(){var a=this.element,b=d(".ui-preview-box",a);b.html('<div class="ui-preview-attach-wrapper fn-clear"><div class="ui-preview-attach-icon"><img src="'+FS.BLANK_IMG+'" alt="loading" class="icon-file" /></div><div class="ui-preview-attach-content"><h3 class="ui-preview-attach-name"></h3><p class="ui-preview-attach-size"></p><p class="ui-preview-attach-create-time"></p><p class="ui-preview-attach-actions"></p></div></div>')},_createImgEl:function(){var a=this.element,b=d(".ui-preview-box",a),c=this.get("data"),e=[],f=[];_.each(c,function(a){e.push(a.originPath+".jpg"),f.push(encodeURIComponent(a.fileName))}),e=e.join("|"),f=f.join("|"),b.html('<div class="ui-preview-img-wrapper"><img src="'+FS.BLANK_IMG+'" alt="loading" class="ui-preview-img" /></div><div class="ui-preview-img-tools"><span class="rotate-l">&#8630;向左旋转</span>&nbsp;&nbsp;&nbsp;<span class="rotate-r">&#8631;向右旋转</span>&nbsp;&nbsp;&nbsp;<a class="view-origin" href="#" target="_blank">查看原图</a>&nbsp;&nbsp;&nbsp;<a class="download-origin" href="#" target="_blank">下载原图</a>&nbsp;&nbsp;&nbsp;<a class="batch-download-origin" href="'+FS.API_PATH+"/df/GetBatchFiles?ids="+e+"&names="+f+'" target="_blank">打包下载</a></div>')},_createAudio:function(){var a=this.element,b=d(".ui-preview-box",a);b.html('<div class="ui-preview-audio-wrapper"><div class="audio-player-wrapper" id="preview-audio-player-'+r+'"></div><div class="audio-info"><p class="ui-preview-attach-name"></p><p class="audio-duration">时长：<span class="duration-value">0秒</span></p><p class="upload-info"></p></div></div>'),r++},_createNavEl:function(){var a=this,b=this.element,c=d(".ui-preview-action-panel",b),e=d('<div class="ui-preview-nav-indicator"></div>'),f=d('<div class="ui-preview-nav-wrapper"></div>'),g="",h=this.get("data"),i=this.get("type");"img"==i?(c.show(),_.each(h,function(b){g+='<li class="ui-preview-nav-item" originpath="'+b.originPath+'" thumbpath="'+b.thumbPath+'" previewpath="'+b.previewPath+'"><div class="img-center-wrapper"><img src="'+a._getFileLink(b.thumbPath,b.fileName,!1,"jpg")+'" alt="loading" width="50" /></div></li>'})):(c.hide(),_.each(h,function(){g+='<li class="ui-preview-nav-item"><div class="img-center-wrapper"><img src="'+FS.BLANK_IMG+'" alt="loading" /></div></li>'})),f.html('<ul class="ui-preview-nav-list fn-clear">'+g+'</ul><div class="ui-preview-thumb-box"></div>'),e.appendTo(c),f.appendTo(c)},_adjustPanel:function(){var a=this.get("type");_.str.trim(this.element.text()).length>0&&(this._setPortHeight(),this._setInfoHeight(),this._setSwitchPosition(),this._setNavPosition(),"img"==a?(this._adjustImgPanel(),this._adjustImg()):"attach"==a?this._adjustAttachPanel():"audio"==a&&this._adjustAudioPanel())},_adjustAudioPanel:function(){var a=this.element,b=d(".ui-preview-box",a),c=d(".ui-preview-audio-wrapper",b);f.center(c,b)},_adjustAttachPanel:function(){var a=this.element,b=d(".ui-preview-box",a),c=d(".ui-preview-attach-wrapper",b);f.center(c,b)},_adjustImgPanel:function(){this._setImgBoxSize(),this._setImgBoxPosition()},_setImgBoxSize:function(){var a=this.element,b=d(".ui-preview-box",a),c=d(".ui-preview-img-wrapper",b),e=b.height(),f=b.width();c.height(1*e-50).css({"line-height":1*e-50+"px"}),c.width(1*f)},_setImgBoxPosition:function(){var a=this.element,b=d(".ui-preview-box",a);d(".ui-preview-img-wrapper",b)},_getPreviewImgSize:function(a){var b=this._imgSizeStore,c=null;return _.some(b,function(b){return b.src==a?(c=b.size,!0):void 0}),c},_isInPreviewImgStore:function(a){var b=this._imgSizeStore;return _.some(b,function(b){return b.src==a})},_adjustImg:function(){var a=this.element,b=d(".ui-preview-box",a),c=d(".ui-preview-img-wrapper",b),e=d(".ui-preview-img",c),f=e.data("size"),g=this._getPreviewImgSize(e.attr("src")),h={};f&&(f.width/f.height>=g.width/g.height?f.width>g.width?(h.width=g.width,h.height=f.height*g.width/f.width):(h.width=f.width,h.height=f.height):f.height>g.height?(h.height=g.height,h.width=f.width*g.height/f.height):(h.width=f.width,h.height=f.height),e.width(h.width),e.height(h.height))},_setSwitchPosition:function(){var a=this.element,b=d(".ui-preview-port",a),c=d(".ui-preview-switch-l",a),e=d(".ui-preview-switch-r",a);f.pin({element:c,x:0,y:45},{element:b,x:0,y:"50%"}),f.pin({element:e,x:45,y:45},{element:b,x:"100%",y:"50%"})},_setNavPosition:function(a){var b=this.element,c=d(".ui-preview-nav-wrapper",b),e=d(".ui-preview-nav-list",b),g=d(".ui-preview-thumb-box",b),h=a?f.pinWithAnimate:f.pin;h({element:e,x:d(".ui-preview-nav-item",e).outerWidth(!0)/2+q,y:0},{element:c,x:"50%",y:0}),f.pin({element:g,x:"50%",y:0},{element:c,x:"50%",y:0})},_setNavListWidth:function(){var a=this.element,b=d(".ui-preview-nav-list",a),c=d(".ui-preview-nav-item",a),e=0;c.each(function(){e+=d(this).outerWidth(!0)}),b.width(e)},_setPortHeight:function(){var a=this.element,b=d(".ui-preview-port",a),c=d(".ui-preview-action-panel",a),e=a.height(),f=c.outerHeight(!0);b.height(e-f)},_setInfoHeight:function(){var a=this.element,b=d(".ui-preview-info",a);b.height(a.height()-80)},_onRenderActiveIndex:function(a){var b,c,e,f,i,k,l,m,n,o,r,s,t,u,v,w,x,y,z=this,A=this.element,B=d(".ui-preview-nav-indicator",A),C=d(".ui-preview-nav-item",A),D=C.eq(a),E=d(".ui-preview-box",A),F=this.get("data"),G=F[a],H=this.get("type");C.removeClass("state-active"),D.addClass("state-active"),G&&(b=G.serverTime?g.unix(G.serverTime):g(),"img"==H?(e=d(".ui-preview-img-wrapper",E),f=d(".ui-preview-img",E),r=d('<img class="ui-preview-img" />'),u=D.attr("previewpath"),v=D.attr("originpath"),w=0,a>-1&&(p=0,w=C.eq(0).outerWidth(!0),q=w*a,e.html('<img src="'+FS.ASSETS_PATH+"/"+"images/loading.gif"+'" /><span style="inline-block;"> </span>'),y=this._getFileLink(u,G.fileName,!1,"jpg"),this._isInPreviewImgStore(y)?(e.html('<img src="'+y+'" alt="loaded" class="ui-preview-img" /><span style="inline-block;"> </span>'),z._adjustImg()):r.load(function(){var a=d(this),b=a.get(0),c=b.width,f=b.height,g=a.attr("src");e.empty(),e.html('<img src="'+g+'" alt="loaded" class="ui-preview-img" /><span style="inline-block;"> </span>'),z._imgSizeStore.push({src:g,size:{width:c,height:f}}),z._adjustImg(),r.unbind("load").remove(),r=null}).attr("src",y).addClass("fn-hide-abs").appendTo("body"),A.is(":visible")&&this._setNavPosition(!0),B.html("第&nbsp;"+(a+1)+"&nbsp;个（共&nbsp;"+C.length+"&nbsp;个）"),d(".view-origin",E).attr("href",this._getFileLink(v,G.fileName,!1,"jpg")),d(".download-origin",E).attr("href",this._getFileLink(v,G.fileName,!0,"jpg")))):"attach"==H?(i=d(".ui-preview-attach-wrapper",E),l=d(".ui-preview-attach-icon img",i),n=d(".ui-preview-attach-name",i),m=d(".ui-preview-attach-size",i),k=d(".ui-preview-attach-create-time",i),o=d(".ui-preview-attach-actions",i),l.addClass("icon-file-"+h.getFileType({name:G.fileName})),n.text(G.fileName),m.text(h.getFileSize(G.fileSize)),k.text((G.employeeName||"")+"上传于"+h.getDateSummaryDesc(g.unix(G.createTime),b,1)),c='<a href="'+this._getFileLink(G.originPath,G.fileName,!0)+'" target="_blank">下载</a>',G.canPreview&&(c+='&nbsp;&nbsp;&nbsp;<a href="#" title="预览" class="attach-preview-l">预览</a>'),o.html(c)):"audio"==H&&(s=d(".ui-preview-audio-wrapper",E),t=d(".audio-player-wrapper",s),x=h.getFileNamePath(G.originPath)+".mp3",x=this._getFileLink(x,G.fileName,!1),this.audioPlayer||(this.audioPlayer=new j({element:t,audioSrc:x,length:G.fileSize})),this.audioPlayer.play(),d(".ui-preview-attach-name",s).text(h.getFileNamePath(G.fileName)+".mp3"),d(".duration-value",s).text(G.fileSize+"秒"),d(".upload-info",s).text((G.employeeName||"")+"上传于"+h.getDateSummaryDesc(g.unix(G.createTime),b,1))))},_getFileLink:function(){return this.get("type"),h.getDfLink.apply(this,arguments)},_resetPanel:function(){this.set("activeIndex",-1)},_onRenderData:function(a){this._clear(),a.length>0?(this._createEl(),this._adjustPanel()):this.element.empty()},_onRenderType:function(){this._clear(),this._createEl(),this._adjustPanel()},_onRenderBackgroundColor:function(a){this.element.css("backgroundColor",a)},_onRenderOpacity:function(a){this.element.css("opacity",a)},_clear:function(){this.audioPlayer&&this.audioPlayer.destroy(),this.audioPlayer=null},destroy:function(){var a;return this._imgSizeStore=null,this.audioFlashRendered&&i.removeSWF("preview-audio-player-"+r),this.element.empty(),a=t.superclass.destroy.apply(this,arguments)}});c.exports=t});