/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("tpls/circles/atcircle/atcircle",["util","moment","modules/feed-list/feed-list","tpls/stream/stream-common"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=e.event,g=a("util"),h=(a("moment"),a("modules/feed-list/feed-list")),i=a("tpls/stream/stream-common"),j=g.getContactData(),k=i.InviteColleague;b.init=function(){var a,c,d,e=b.tplEl,i=b.tplName,l=$(".search-inp",e),m=$(".search-btn",e),n=$(".circles-nav-list",e),o="",p=$(".feed-list",e),q=$(".feed-list-pagination",e),r=$(".plan-status-type",e),s=$(".info-type-wrapper",e),t=j.p,u=j.u,v=[],w=g.getTplQueryParams(),x=$(".right-img-wrap",e),y=$(".right-htitle-wrap",e),z=w?parseInt(w.cid):0,A=function(a){a=a||"send",$(".status-wrapper",r).each(function(){var a=$(this);$("a",a).removeClass("depw-tabs-aon").eq(0).addClass("depw-tabs-aon")}),"send"==a?($(".plan-wrapper,.approve-wrapper,.work-wrapper",r).hide(),$(".include-file-wrap",r).show(),$(".plan-status-wrap",r).show()):"received"==a&&($(".plan-wrapper,.approve-wrapper,.work-wrapper,.include-file-wrap",r).hide(),$(".plan-status-wrap",r).show())};$(".tpl-c .depw-title",e).text(g.getContactDataById(z,"g").name);var B=j.g;B=_.filter(B,function(a){return"999999"!=a.id}),_.each(B,function(a){a&&(o+='<li class="circle-nav-item fni-dep-con"><a class="circle-l tpl-nav-lb tpl-nav-lbq" href="#circles/atcircle/=/cid-'+a.id+'" title="">'+a.name+"</a></li>")}),n.html(o),g.regTplNav($(".circle-nav-item a",n)),d=new h({element:p,pagSelector:q,pagOpts:{pageSize:45,visiblePageNums:7},loadSize:15,withFeedRemind:!1,withLazyload:!0,listPath:"/feed/getFeedsFromCircleSend",defaultRequestData:function(){var a=$(".subtype-wrapper",r).filter(":visible"),b=g.getTplQueryParams();return{circleID:b?b.cid:0,subType:$(".depw-tabs-aon",a).attr("subtype")||0,feedAttachType:$(".include-file-wrap .depw-tabs-aon",e).attr("attachtype"),feedType:$(".plan-status-wrap .depw-tabs-aon",e).attr("feedtype"),keyword:_.str.trim(l.val())}},searchOpts:{inputSelector:l,btnSelector:m}}),d.load(),r.on("click",".plan-status",function(a){var b=$(this);b.hasClass("plan-status")&&($(".subtype-wrapper",r).hide(),b.is("[feedname]")&&$("."+b.attr("feedname")+"-wrapper").show()),a.preventDefault()}).on("click",".depw-tabs-a",function(){var a=$(this),b=a.closest(".status-wrapper"),c=a.attr("infotype");$(".depw-tabs-a",b).removeClass("depw-tabs-aon"),a.addClass("depw-tabs-aon"),"send"==c?d.opts.listPath="/feed/getFeedsFromCircleSend":"received"==c&&(d.opts.listPath="/feed/getFeeds"),d.reload()}),s.on("click","a",function(a){var b=$(this),c=b.attr("infotype"),e=s.next(".plan-status-type").find(".status-wrapper");e.find("a"),A(c),"send"==c?(e.filter(".include-file-wrap").show(),d.opts.listPath="/feed/getFeedsFromCircleSend"):(e.filter(".include-file-wrap").hide(),d.opts.listPath="/feed/getFeeds"),$("a",s).removeClass("depw-menu-aon"),b.addClass("depw-menu-aon"),d.reload(),a.preventDefault()}),m.click(function(a){d.reload(),a.preventDefault()}),t=_.reject(t,function(a){return a.id==u.id}),"999999"==z?v=t:_.each(t,function(a){var b=a.groupIDs;_.contains(b,z)&&v.push(a)}),a=g.getContactDataById(z,"g"),c=a.name||u.allCompanyDefaultString,y.html('<span class="circle-name">'+c+"（"+v.length+"）"+'</span><span class="rt-apv right-yq-apv fn-hide"><a href="javascript:;" class="invite-apv fna-blue">邀请同事</a></span>'),v=v.slice(0,35),o="",_.each(v,function(a){o+='<a href="#profile/=/empid-'+a.id+'" title="'+a.name+'"><img src="'+a.profileImage+'" /></a>'}),x.html(o),u.isAdmin?$(".right-yq-apv",y).show():$(".right-yq-apv",y).hide(),new k({trigger:$(".invite-apv",y)}).render(),"999999"!=z&&$(".view-all-employee-l",e).attr("href","#circles/allcolleague/=/id-"+z+"/name-"+encodeURIComponent(c)),f.one("beforeremove",function(a){a==i&&(d.destroy(),d=null)})}});