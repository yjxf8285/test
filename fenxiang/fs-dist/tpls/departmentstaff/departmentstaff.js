/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("tpls/departmentstaff/departmentstaff",["util","json","dialog","events","modules/fs-qx/fs-qx-helper","uilibs/pagination"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=(e.store,e.event),g=a("util"),h=a("json"),i=a("dialog"),j=a("events"),k=a("modules/fs-qx/fs-qx-helper"),l=a("uilibs/pagination"),m=k.LetterGroupList,n=k.JoinDialog,o=k.Uploader,p=i.extend({attrs:{content:'<div class="ui-dialog-title">添加部门</div><div class="ui-dialog-body"><div class="field-container"><div class="f-field fn-clear"><div class="ff-label fn-left">上级部门：</div><div class="ff-value fn-left"><input type="text" class="parent-department-field fs-validate-field textfield" readonly="readonly" /></div></div><div class="department-field-wrapper f-field fn-clear"><div class="ff-label fn-left"><span class="f-field-star">*</span>&nbsp;名称：</div><div class="ff-value fn-left"><input maxlength="25" type="text" class="department-name-field fs-validate-field textfield auto-focus" emptytip="请输入名称" inputtip="请填写部门名称" /></div></div></div><div class="ui-dialog-bbar fn-clear"><div class="bbar-inner fn-right"><button class="f-sub button-submit">确定</button>&nbsp;&nbsp;<button class="f-cancel button-cancel">取消</button></div></div></div>',className:"department-tree-create-department department-tree-dialog fs-validate",width:458,data:null,successCb:d.EMPTY_FN},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel"},render:function(){var a=p.superclass.render.apply(this,arguments);return a},isValid:function(){var a=!0,b=this.getRequestData();return 0==b.name.length?!1:a},getRequestData:function(){var a={},b=this.get("data"),c=this.element,d=$(".department-name-field",c);return a.name=_.str.trim(d.val()),a.parentID=b.id,a.description="",a},clear:function(){var a=this.element,b=$(".parent-department-field",a),c=$(".department-name-field",a);b.val(""),c.val(""),$(".fs-validate-empty-tip,.fs-validate-input-tip",a).hide(),$(".field-state-input,.field-state-empty",a).removeClass("field-state-input field-state-empty")},_submit:function(a){var b,c=this,d=this.get("successCb"),e=(this.element,$(a.currentTarget)),b=this.getRequestData();this.isValid()&&g.api({type:"post",data:b,url:"/Management/CreateCircle",success:function(a){d&&d.call(c,a,b)}},{submitSelector:e}),a.preventDefault()},setData:function(a){var b=this.element,c=$(".parent-department-field",b);c.val(a.name),this.set("data",a)},hide:function(){var a=p.superclass.hide.apply(this,arguments);return this.clear(),a},_cancel:function(a){this.hide(),a.preventDefault()}}),q=i.extend({attrs:{content:'<div class="ui-dialog-title">重命名</div><div class="ui-dialog-body"><div class="field-container"><div class="department-field-wrapper f-field fn-clear"><div class="ff-label fn-left"><span class="f-field-star">*</span>&nbsp;名称：</div><div class="ff-value fn-left"><input maxlength="25" type="text" class="department-name-field fs-validate-field textfield auto-focus" emptytip="请输入名称" inputtip="请填写部门名称" /></div></div></div><div class="ui-dialog-bbar fn-clear"><div class="bbar-inner fn-right"><button class="f-sub button-submit">确定</button>&nbsp;&nbsp;<button class="f-cancel button-cancel">取消</button></div></div></div>',className:"department-tree-rename-department department-tree-dialog fs-validate",width:458,data:null,successCb:d.EMPTY_FN},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel"},render:function(){var a=q.superclass.render.apply(this,arguments);return a},isValid:function(){var a=!0,b=this.getRequestData();return 0==b.name.length?!1:a},getRequestData:function(){var a={},b=this.get("data"),c=this.element,d=$(".department-name-field",c);return a.name=_.str.trim(d.val()),a.circleID=b.id,a.description="",a},clear:function(){var a=this.element,b=$(".parent-department-field",a),c=$(".department-name-field",a);b.val(""),c.val(""),$(".fs-validate-empty-tip,.fs-validate-input-tip",a).hide(),$(".field-state-input,.field-state-empty",a).removeClass("field-state-input field-state-empty")},_submit:function(a){var b,c=this,d=this.get("successCb"),e=(this.element,$(a.currentTarget)),b=this.getRequestData();this.isValid()&&g.api({type:"post",data:b,url:"/Management/ModifyCircle",success:function(a){d&&d.call(c,a,b)}},{submitSelector:e}),a.preventDefault()},setData:function(a){var b=this.element,c=$(".department-name-field",b);c.val(a.name),this.set("data",a)},hide:function(){var a=q.superclass.hide.apply(this,arguments);return this.clear(),a},_cancel:function(a){this.hide(),a.preventDefault()}}),r=i.extend({attrs:{content:'<div class="ui-dialog-title">移动部门</div><div class="ui-dialog-body"><div class="department-group"></div></div><div class="ui-dialog-bbar fn-clear"><div class="bbar-inner fn-right"><button class="f-sub button-submit">保存修改</button>&nbsp;&nbsp;<button class="f-cancel button-cancel">取消</button></div></div></div>',className:"department-tree-move-department department-tree-dialog",width:400,listData:null,data:null,successCb:d.EMPTY_FN},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel"},render:function(){var a=r.superclass.render.apply(this,arguments);return this._renderCpt(),a},_renderCpt:function(){var a=this.element,b=this.get("listData"),c=new m({element:$(".department-group",a),data:b,cls:"",singleSelect:!0,clickUnselect:!1});this._departmentGroup=c},clear:function(){},_submit:function(a){var b=this,c=this.get("successCb"),d=this.get("data"),e=(this.element,$(a.currentTarget)),f=this._departmentGroup,h=f.getSelectedItemData()[0],i={circleID:d.id,parentID:h.id};g.confirm("是否将该部门移动到部门"+h.name+"下","提示",function(){g.api({type:"post",data:i,url:"/Management/CircleMove",success:function(a){c&&c.call(b,a,i)}},{submitSelector:e})},{onCancel:function(){}}),a.preventDefault()},getItemData:function(a){return this._departmentGroup.getItemDataById(a)},setListData:function(a){this.rendered||this.render(),this._departmentGroup.setData(a)},setData:function(a){var b=this.element,c=$(".ui-dialog-title",b),d=this.getItemData(a.parentID);c.text("移动部门 "+a.name+" 到 "+d.name),this._departmentGroup.selectItem(d.id,!0),this.set("data",a)},hide:function(){var a=r.superclass.hide.apply(this,arguments);return this.clear(),a},_cancel:function(a){this.hide(),a.preventDefault()},destroy:function(){var a;return this._departmentGroup&&this._departmentGroup.destroy(),a=r.superclass.destroy.apply(this,arguments)}}),s=i.extend({attrs:{content:'<div class="ui-dialog-title">重置密码</div><div class="ui-dialog-body"><div class="field-container"><div class="account-field-wrapper f-field fn-clear"><div class="ff-label fn-left">帐号：</div><div class="ff-value fn-left"><input type="text" class="account-field fs-validate-field textfield" inputtip="用户帐号" readonly="readonly" /></div></div><div class="name-field-wrapper f-field fn-clear"><div class="ff-label fn-left">姓名：</div><div class="ff-value fn-left"><input type="text" class="name-field fs-validate-field textfield" inputtip="用户姓名" readonly="readonly" /></div></div><div class="pwd-field-wrapper f-field fn-clear"><div class="ff-label fn-left">密码：</div><div class="ff-value fn-left"><input type="password" class="pwd-field fs-validate-field textfield auto-focus" inputtip="请输入密码" emptytip="请输入初始密码" /></div></div></div><div class="ui-dialog-bbar fn-clear"><div class="bbar-inner fn-right"><button class="f-sub button-submit">保存修改</button>&nbsp;&nbsp;<button class="f-cancel button-cancel">取消</button></div></div></div>',className:"department-tree-reset-pwd department-tree-dialog fs-validate",width:500,data:null,successCb:d.EMPTY_FN},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel"},render:function(){var a=s.superclass.render.apply(this,arguments);return a},clear:function(){var a=this.element,b=$(".name-field",a),c=$(".account-field",a),d=$(".pwd-field",a);b.val(""),c.val(""),d.val("")},isValid:function(){var a=!0,b=this.getRequestData();return 0==b.newPassword.length?!1:a},getRequestData:function(){var a={},b=this.get("data"),c=this.element,d=$(".pwd-field",c);return a.newPassword=_.str.trim(d.val()),a.employeeID=b.employeeId,a},_submit:function(a){var b=this,c=$(a.currentTarget),d=this.get("successCb"),e=this.getRequestData();this.isValid()&&g.api({type:"post",data:e,url:"/Management/ChangeEmployeePassword",success:function(a){d&&d.call(b,a,e)}},{submitSelector:c}),a.preventDefault()},setData:function(a){var b=this.element,c=$(".name-field",b),d=$(".account-field",b);c.val(a.name),d.val(a.account),this.set("data",a)},hide:function(){var a=s.superclass.hide.apply(this,arguments);return this.clear(),a},_cancel:function(a){this.hide(),a.preventDefault()},destroy:function(){var a;return a=s.superclass.destroy.apply(this,arguments)}}),t=function(a){a=_.extend({element:null,dataPath:"/Management/GetAllCircleInfos"},a||{}),this.element=$(a.element),this.opts=a,this.init()};_.extend(t.prototype,{init:function(){this._prepareData(function(a){this._renderRootNode(a)}),this._prepareContextMenu(),this._initCpt(),this._bindEvents()},_initCpt:function(){var a=this;this._createDepDialog=new p({successCb:function(b,c){b.success&&(a.appendNode(c.parentID,_.extend({children:[]},b.value)),a._createDepDialog.hide())}}),this._renameDepDialog=new q({successCb:function(b,c){b.success&&(a.renameNode(c.circleID,b.value),a._renameDepDialog.hide())}}),this._moveDepDialog=new r({successCb:function(b,c){b.success&&(a.moveNode(a.getNode(c.circleID),c.parentID,"last"),a._moveDepDialog.hide())}})},_bindEvents:function(){var a=this,b=this.element;b.on("click",".state-collapse",function(b){var c=$(b.currentTarget),d=c.closest(".department-node-item");a.expandNode(d)}).on("click",".state-expand",function(b){var c=$(b.currentTarget),d=c.closest(".department-node-item");a.collapseNode(d)}).on("click",".node-info a",function(b){var c=$(b.currentTarget),d=c.closest(".department-node-item");a.selectNode(d),$(b.target).is(".action-h")||a._contextMenu.hide(),b.stopPropagation()}).on("mousedown",".node-info a",function(b){var c=$(b.currentTarget),d=c.closest(".department-node-item");return 3==b.which?(a.selectNode(d),a._updateAndShowCm(d),document.oncontextmenu=function(){return document.oncontextmenu=null,!1},!1):void 0}).on("click",".node-info .action-h",function(b){var c=$(b.currentTarget),d=c.closest(".department-node-item");a._updateAndShowCm(d)})},reload:function(a){this._prepareData(function(b){this._renderRootNode(b),a&&a.call(this,b)})},_prepareData:function(a){var b=this,c=this.opts,d=c.dataPath,e=function(a){var b=function(c){var d=[];return _.each(a,function(a){a.parentID===c&&(a.children=b(a.id),d.push(a))}),d=_.sortBy(d,function(a){return a.circleOrder})};return b(0)};g.api({url:d,type:"get",success:function(c){var d,f,h;c.success&&(d=c.value,f=g.deepClone(d),f.push({id:0,name:"全公司",spell:"#"}),b._lastOriginData=f,h=e(d),a.call(b,h))}})},_prepareContextMenu:function(){var a=this,b=$("#department-context-menu");0==b.length&&(b=$('<div class="department-context-menu fn-hide"></div>'),b.appendTo("body"),g.regGlobalClick(b,function(){b.hide()}),b.on("click",".action-item",function(b){var c=$(b.currentTarget),d=c.attr("actionname");a["_cm_"+d](b),b.preventDefault()})),this._contextMenu=b},selectNode:function(a,b){var c=this.element,d=$(a),e=$(".node-info",d).eq(0);$(".state-active",c).removeClass("state-active"),e.addClass("state-active"),b||this.trigger("nodeselect",d.data("nodeData"))},expandNode:function(a){var b=$(a),c=$(".visible-h",b).eq(0),d=b.children(".children-node-wrapper");0==d.length&&this._renderChildrenNode(b),d.show(),c.addClass("state-expand").removeClass("state-collapse"),this.trigger("nodeexpand",b.data("nodeData"))},collapseNode:function(a){var b=$(a),c=$(".visible-h",b).eq(0),d=b.children(".children-node-wrapper");d.hide(),c.addClass("state-collapse").removeClass("state-expand"),this.trigger("nodecollapse",b.data("nodeData"))},_cm_expand:function(){this.expandNode(this.getActiveNode())},_cm_collapse:function(){this.collapseNode(this.getActiveNode())},_cm_createChild:function(){this.createDepartment()},createDepartment:function(){var a=this._createDepDialog;a.show(),a.setData(this.getActiveNodeData())},_cm_delete:function(){var a=this,b=this.getActiveNodeData();g.confirm("是否确定删除该部门？已经发布了信息的部门不能删除","提示",function(){g.api({url:"/Management/DeleteCircle",type:"post",data:{circleID:b.id},success:function(c){c.success&&a.deleteNode(b.id)}})},{onCancel:function(){}})},_cm_rename:function(){var a=this._renameDepDialog;a.show(),a.setData(this.getActiveNodeData())},_cm_stop:function(){var a=this,b=this.getActiveNodeData(),c=b.id;g.confirm("是否确定要停用该部门？停用后员工不能再在该部门内发布信息，但是仍可以浏览该部门内之前发布的内容。","停用部门",function(){g.api({url:"/Management/SetCircleStatus",type:"post",data:{circleID:c,isStop:!0},success:function(b){b.success&&(a.updateNodeState(a.getNode(c),!0),a.moveNode(a.getNode(c),0,"last"),a.updateChildrenNodeState(a.getNode(c),!0))}})},{onCancel:function(){}})},_cm_active:function(){var a,b=this,c=this.element,d=$(".root-node",c),e=$(".children-node-wrapper",d).eq(0),f=$(".state-disabled",e).eq(0).closest(".department-node-item"),h=this.getActiveNodeData(),i=h.id;a=0==f.length?e.children().length-1:f.index(),g.confirm("是否确定要启用该部门？","启用部门",function(){g.api({url:"/Management/SetCircleStatus",type:"post",data:{circleID:i,isStop:!1},success:function(c){c.success&&(b.updateNodeState(b.getNode(i),!1),b.moveNode(b.getNode(i),0,a),b.updateChildrenNodeState(b.getNode(i),!1))}})},{onCancel:function(){}})},_cm_moveUp:function(){var a=this,b=this.getActiveNodeData(),c=b.id,d=a.getNode(c),e=this.getNodePosition(d);g.api({url:"/Management/SetCircleOrder",type:"post",data:{circleID:c,isUp:!0},success:function(b){b.success&&a.moveNode(d,e-1)}})},_cm_moveDown:function(){var a=this,b=this.getActiveNodeData(),c=b.id,d=a.getNode(c),e=this.getNodePosition(d);g.api({url:"/Management/SetCircleOrder",type:"post",data:{circleID:c,isUp:!1},success:function(b){b.success&&a.moveNode(d,e+2)}})},_getSelfAndChildrenData:function(a){var b=this.getAllNodeData(),c=[],d=function(a){_.each(b,function(b){b.parentID==a&&(c.push(b),d(b.id))})};return d(a),c},_cm_modifyParent:function(){var a=this._moveDepDialog,b=this.getAllNodeData(),c=this.getActiveNodeData(),d=[],e=this._getSelfAndChildrenData(c.id);_.each(b,function(a){_.some(e,function(b){return b.id==a.id})||d.push(a)}),d=_.reject(d,function(a){return a.id==c.id}),a.show(),a.setListData(d),a.setData(this.getActiveNodeData())},_renderRootNode:function(a){var b=this.element,c=$('<ul class="department-node-list"></ul>'),e=$('<li class="department-node-item root-node" nodeid="0"><div class="node-info state-active"><img src="'+d.BLANK_IMG+'" class="visible-h state-expand" alt="" /><a href="javascript:;"><span class="node-text">全公司</span><img src="'+d.BLANK_IMG+'" class="action-h" alt="" /></a></div></li>');e.data("nodeData",{id:0,name:"全公司",spell:"#",children:a}),b.empty(),e.appendTo(c),c.appendTo(b),this._renderChildrenNode(e),this.trigger("nodeselect",{id:0,name:"全公司"})},_renderChildrenNode:function(a){var b=this,c=$(a),d=$(".children-node-wrapper",c),e=c.data("nodeData"),f=e.children;0==d.length&&(d=$('<div class="children-node-wrapper"></div>'),d.appendTo(c)),_.each(f,function(a){b._createNode(a).appendTo(d)})},_createNode:function(a){var b="",c='<img src="'+d.BLANK_IMG+'" class="icon-node" alt="" />';a.children.length>0&&(c='<img src="'+d.BLANK_IMG+'" class="visible-h state-collapse" alt="" />'),a.isStop&&(b="state-disabled");var e=$('<li class="department-node-item" nodeid="'+a.id+'"><div class="node-info '+b+'">'+c+'<a href="javascript:;" title="'+a.name+'"><span class="node-text">'+a.name+'</span><img src="'+d.BLANK_IMG+'" class="action-h" alt="" /></a></div></li>');return e.data("nodeData",a)},_updateAndShowCm:function(a){var b=$(a),c=$(".node-info a",b).eq(0),d=$(".visible-h",b).eq(0),e=b.data("nodeData"),f=c.offset(),g=this._contextMenu,h=[],i="";e.isStop?(h.push([{actionName:"rename",text:"重命名"}]),h.push([{actionName:"active",text:"启用"},{actionName:"delete",text:"删除"}])):(e.children.length>0&&(d.hasClass("state-collapse")?h.push([{actionName:"expand",text:"展开"}]):h.push([{actionName:"collapse",text:"收起"}])),0==e.id?h.push([{actionName:"createChild",text:"新建下级"}]):(h.push([{actionName:"createChild",text:"新建下级"},{actionName:"modifyParent",text:"修改上级"},{actionName:"rename",text:"重命名"}]),h.push([{actionName:"stop",text:"停用"},{actionName:"delete",text:"删除"}]),h.push([{actionName:"moveUp",text:"上移"},{actionName:"moveDown",text:"下移"}]))),_.each(h,function(a){i+='<ul class="action-box">',_.each(a,function(b,c){var d="";c==a.length-1&&(d="last-action-item"),i+='<li class="action-item" actionname="'+b.actionName+'"><a href="javascript:;" title="'+b.text+'"><span class="'+d+'">'+b.text+"</span></a></li>"}),i+="</ul>"}),g.html(i),g.css({top:f.top+c.outerHeight()-9,left:f.left+c.outerWidth()-11}),g.show()},_updateNodeView:function(a){var b=$(a),c=b.children(".node-info"),d=$("img.icon-node,img.visible-h",c),e=b.children(".children-node-wrapper"),f=e.children();f.length>0?(d.addClass("visible-h"),e.is(":visible")?d.addClass("state-expand"):d.addClass("state-collapse")):d.removeClass("visible-h state-expand state-collapse").addClass("icon-node")},getActiveNode:function(){return $(".state-active",this.element).closest(".department-node-item")},getActiveNodeData:function(){return this.getActiveNode().data("nodeData")},getNode:function(a){var b=this.element,c=$('[nodeid="'+a+'"]',b);return c},getNodeData:function(a){return this.getNode(a).data("nodeData")},setNodeData:function(a,b){var c=this.element,d=$('[nodeid="'+a+'"]',c);d.data("nodeData",_.extend(d.data("nodeData"),b||{}))},appendNode:function(a,b){var c,d=this.element,e=$('[nodeid="'+a+'"]',d),f=e.data("nodeData");this.expandNode(e),c=$(".children-node-wrapper",e).eq(0),this._createNode(b).appendTo(c),f.children.push(b),this._updateNodeView(e)},moveNode:function(a,b,c){var d,e,f,g,h,i,j=this.element,k=$(a),l=k.data("nodeData");return d=k.parent().parent(),_.isUndefined(c)&&(c=b,b=l.parentID),e=$('[nodeid="'+b+'"]',j),this.expandNode(e),f=$(".children-node-wrapper",e).eq(0),g=f.children(),l.parentID=b,h=e.data("nodeData"),i=d.data("nodeData"),0==g.length?(k.appendTo(f),i.children=_.reject(i.children,function(a){return a.id==l.id}),h.children.push(l),this._updateNodeView(e),this._updateNodeView(d),void 0):(i.children=_.reject(i.children,function(a){return a.id==l.id}),_.isNumber(c)?0>=c?(k.prependTo(f),h.children.unshift(l)):(c>=g.length&&(c=g.length),k[0]!==g.eq(c-1)[0]&&(k.insertAfter(g.eq(c-1)),h.children.splice(c,0,l))):"first"==c?(k.prependTo(f),h.children.unshift(l)):"last"==c&&k[0]!==g.last()[0]&&(k.insertAfter(g.last()),h.children.push(l)),this._updateNodeView(e),this._updateNodeView(d),void 0)},deleteNode:function(a){var b=this.element,c=$('[nodeid="'+a+'"]',b),d=this.getParentNode(c),e=d.data("nodeData"),f=c.data("nodeData");e.children=_.reject(e.children,function(b){return b.id==a}),c.remove(),this._updateNodeView(d),this.trigger("nodedelete",f)},renameNode:function(a,b){var c=this.element,d=$('[nodeid="'+a+'"]',c),e=$(".node-info",d).eq(0),f=$(".node-text",e),g=d.data("nodeData");d.data("nodeData",_.extend(g,b)),$("a",e).attr("title",b.name),f.text(b.name)},getParentNode:function(a){var b=$(a);return b.parent().parent(".department-node-item")},getNodePosition:function(a){var b=$(a);return b.index()},updateChildrenNodeState:function(a,b){var c=$(a),d=$(".department-node-item",c);b?d.each(function(){var a=$(this),b=a.data("nodeData");b.isStop=!0,$(".node-info",a).eq(0).addClass("state-disabled")}):d.each(function(){var a=$(this),b=a.data("nodeData");b.isStop=!1,$(".node-info",a).eq(0).removeClass("state-disabled")})},updateNodeState:function(a,b){var c=$(a),d=c.data("nodeData");d.isStop=b,b?$(".node-info",c).eq(0).addClass("state-disabled"):$(".node-info",c).eq(0).removeClass("state-disabled")},getAllNodeData:function(){var a=this.element,b=$(".department-node-item",a),c=[];return b.each(function(){var a=$(this).data("nodeData"),b=g.deepClone(a);delete b.children,c.push(b)}),c},destroy:function(){}}),j.mixTo(t);var u=function(a){a=_.extend({element:null,itemTpl:'<tr class="{{trCls}}"><td class="ck-box first-td"><input class="ck" type="checkbox" /></td><td><img src="'+d.BLANK_IMG+'" class="icon-sex icon-sex-{{sex}}" /><a class="employee-name" href="javascript:;">{{name}}</a></td>'+'<td class="account"><a class="account" href="javascript:;" title="{{account}}">{{account}}</a></td>'+'<td><a class="post" href="javascript:;">{{post}}</a></td>'+'<td class="last-td"><a class="mobile" href="javascript:;">{{mobile}}</a></td>'+"</tr>",listPath:"/Management/GetAllEmployees",formatData:function(a){return _.extend({trCls:a.isStop?"state-disabled":"",sex:a.gender.toLowerCase()},a)}},a||{}),this.element=$(a.element),this.opts=a,this._lastRequestData=null,this._lastListData=null,this.init()};_.extend(u.prototype,{init:function(){this._renderSelf(),this._bindEvents()},_bindEvents:function(){var a=this,b=this.element;b.on("mouseenter","tr",function(){$(this).addClass("state-hover")}).on("mouseleave","tr",function(){$(this).removeClass("state-hover")}).on("click","tr",function(b){var c=$(b.currentTarget),d=$(b.target),e=$(".ck",c);d.is(".ck")||e.prop("checked",!e.prop("checked")).change(),a.trigger("rowclick",b)})},_renderSelf:function(){var a=this.element;a.html('<table class="departmentstaff-employee-list" cellpadding="0" cellspacing="0"><tbody></tbody></table>')},_renderList:function(a){var b=this.opts,c=b.itemTpl,d=b.formatData,e=this.element,f=$("tbody",e),g="";_.each(a,function(a){g+=_.template(c)(d(a))}),0==g.length&&(g+='<tr class="empty-tip"><td>该筛选条件没有找到员工，请更换筛选条件。</td></tr>'),f.html(g)},_showFetchLoading:function(){var a=this.element,b=$("tbody",a);b.html('<tr class="loading-tip"><td><img src="'+d.BLANK_IMG+'" alt="loading" class="icon-loading" />&nbsp;正在加载中，请稍后。</td></tr>')},_fetch:function(a){var b=this,c=this.opts,d=c.listPath;this._showFetchLoading(),g.api({url:d,data:a,type:"get",success:function(c){c.success&&(b._renderList(c.value.items),b.trigger("fetch",c,a),b._lastRequestData=a,b._lastListData=c.value.items)}},{abortLast:!0})},setOpts:function(a){_.extend(this.opts,a||{})},getItemDataFromSelector:function(a){var b=$(a).index();return this._lastListData[b]},getAllSelectData:function(){var a=this,b=[],c=this.element,d=$(".ck",c).filter(":checked");return d.each(function(){var c=$(this).closest("tr");b.push(a.getItemDataFromSelector(c))}),b},getListData:function(){return this._lastListData},load:function(a){this._fetch(a)},reload:function(){this.load(this._lastRequestData)},empty:function(){var a=this.element,b=$("tbody",a);b.empty()},destroy:function(){this._lastRequestData=null,this._lastListData=null}}),j.mixTo(u),b.init=function(){var a,c,i=b.tplEl,j=b.tplName,k=$(".department-tree",i),m=$(".employee-main",i),p=$(".department-title",m),q=$(".employee-num",m),r=$(".employee-list-wrapper",m),v=$(".filter-list",m),w=$(".search-box",m),x=$(".sort-list",m),y=$(".all-ck",m),z=$(".employee-list-action",m),A=$(".modify-employee-btn",m),B=$(".pagination-box",i),y=$(".all-ck",m),C=$(".employee-detail",i),D=$(".detail-tbar",C),E=$(".employee-edit",i),F=$(".detail-tbar",E),G=$(".employee-add",i),H=$(".detail-tbar",G),I=$(".add-employee-btn",m),J=$(".department-nav .add-circle-btn",i),K=$(".batch-import-btn",m),L=$(".batch-import",i),M=$(".upload-field",L),N=$(".import-btn",L),O=$(".export-employee-btn",i),P=20,Q=d.getAppStore("globalData"),R=new t({element:k}),S=new u({element:r}),T=new n({className:"fs-qx-join-dialog modify-employee-dialog",unjoinLabel:"部门外员工",joinLabel:"部门内员工",unit:"项",inputPlaceholder:"输入关键词，快速筛选员工",unjoinEmptyTip:"没有未选员工",unjoinSearchEmptyTip:"没有筛选条件为{{keyword}}的员工",joinEmptyTip:"没有已选员工",joinSearchEmptyTip:"没有筛选条件为{{keyword}}的员工",successCb:function(){var b=this.joinList.getDataState(),c=b.lost||[],d=b.add||[];g.api({url:"/Management/ModifyCircleEmployees",type:"post",data:{circleID:a.id,addEmployeeIDs:_.map(d,function(a){return a.id}),deleteEmployeeIDs:_.map(c,function(a){return a.id})},success:function(a){a.success&&(S.reload(),T.hide())}})}}).render(),U=new n({className:"fs-qx-join-dialog modify-circle-dialog",unjoinLabel:"其它部门",joinLabel:"所属部门",unit:"项",bbarUnit:"部门",inputPlaceholder:"输入关键词，快速筛选部门",unjoinEmptyTip:"没有未选部门",unjoinSearchEmptyTip:"没有筛选条件为{{keyword}}的部门",joinEmptyTip:"没有已选部门",joinSearchEmptyTip:"没有筛选条件为{{keyword}}的部门"}).render(),V=new s({successCb:function(a){a.success&&this.hide()}}),W=[];B.each(function(){var a=new l({element:this,pageSize:P});a.on("page",function(b){_.each(W,function(c){c!==a&&c.set("activePageNumber",b)}),S.load(db())}),a.render(),W.push(a)});var X=function(){A.hide(),p.empty(),q.empty(),$(".filter-item",v).removeClass("state-active").eq(0).addClass("state-active"),$(".search-field",w).val(""),x.val(0),y.prop("checked",!1),$(".action-btn",z).addClass("button-state-disabled"),$(".stop-btn,.start-btn",z).show(),x.show(),O.show(),S.setOpts({itemTpl:'<tr class="{{trCls}}"><td class="ck-box first-td"><input class="ck" type="checkbox" /></td><td><img src="'+d.BLANK_IMG+'" class="icon-sex icon-sex-{{sex}}" /><a class="employee-name" href="javascript:;">{{name}}</a></td>'+'<td class="account"><a class="account" href="javascript:;" title="{{account}}">{{account}}</a></td>'+'<td><a class="post" href="javascript:;">{{post}}</a></td>'+'<td class="last-td"><a class="mobile" href="javascript:;">{{mobile}}</a></td>'+"</tr>",listPath:"/Management/GetAllEmployees",formatData:function(a){return _.extend({trCls:a.isStop?"state-disabled":"",sex:a.gender.toLowerCase()},a)}}),S.empty(),cb("reset")},Y=function(a){var b=[],c=a.allItems,d=a.currentIDs;return _.each(d,function(a){var d;d=_.find(c,function(b){return b.value==a}),d&&b.push({id:d.value,name:d.value2,spell:d.value3})}),b},Z=function(a,b){var c,d,e=[],f=a.circleItems,g=a.allItems,h=a.currentIDs,i=[];return 0!=b?(c=_.find(f,function(a){return a.value==b}),d=c.value2):0==b&&(d=_.map(g,function(a){return a.value})),_.each(d,function(a){_.contains(h,a)||i.push(a)}),_.each(i,function(a){var b;b=_.find(g,function(b){return b.value==a}),b&&e.push({id:b.value,name:b.value2,spell:b.value3})}),e},ab=function(a){var b=[],c=a.allItems,d=a.currentIDs;return _.each(d,function(a){var d,e;d=_.find(c,function(b){return b.value==a}),d&&(e=d.value2,d.value1&&(e='<span style="color:#999999;">'+d.value2+"&nbsp;&nbsp;已停用</span>"),b.push({id:d.value,name:e,spell:d.value3}))}),b},bb=function(a){var b=[],c=a.allItems,d=a.currentIDs;return _.each(c,function(a){var c;_.contains(d,a.value)||(c=a.value2,a.value1&&(c='<span style="color:#999999;">'+a.value2+"&nbsp;&nbsp;已停用</span>"),b.push({id:a.value,name:c,spell:a.value3}))}),b},cb=function(a){var b=Array.prototype.slice.call(arguments,1);_.each(W,function(c){c[a](b)})},db=function(){var b={},c=$(".state-active",v);return b.type=c.attr("filtertype"),b.isStop=0,"0"==b.type?(b.isStop=0,b.type=1):"1"==b.type&&(b.isStop=1),b.circleID=a.id,b.keyword=_.str.trim($(".search-field",w).val()),b.isFirstChar=!1,b.pageSize=P,b.pageNumber=W[0].get("activePageNumber")||1,b.orderType=x.val(),b},eb=function(a){var b=$(".employee-name",C),c=$(".nick-name",C),d=$(".mobile",C),e=$(".account",C),f=$(".email",C),h=$(".post",C),i=$(".sex",C),j=$(".circle-list-wrapper",C),k=$(".avatar-wrapper",C),l="",m="";"F"==a.gender?l="女":"M"==a.gender&&(l="男"),b.text(a.fullName),c.text(a.name),d.text(a.mobile),e.text(a.account),f.text(a.email),h.text(a.post),i.text(l),_.each(a.circles,function(a){m+='<li class="circle-item fn-left">'+a.value1+"</li>"}),j.html('<ul class="circle-list fn-clear">'+m+"</ul>"),a.isAdmin?$(".admin-control-btn",D).removeClass("set-admin-btn").addClass("cancel-admin-btn").text("取消管理员"):$(".admin-control-btn",D).removeClass("cancel-admin-btn").addClass("set-admin-btn").text("设置管理员"),a.isStop?($(".valid-control-btn",D).removeClass("set-stop-btn").addClass("set-start-btn").text("启用"),$(".change-pwd-btn,.belong-department-btn,.admin-control-btn",D).hide(),$(".delete-btn",D).show()):($(".valid-control-btn",D).removeClass("set-start-btn").addClass("set-stop-btn").text("停用"),$(".change-pwd-btn,.belong-department-btn,.admin-control-btn",D).show(),$(".delete-btn",D).hide()),k.html('<img src="'+g.getAvatarLink(a.profileImage,1)+'" alt="" />'),C.data("employeeId",a.employeeID),C.data("employeeData",a),U.setTitle("修改"+a.name+"所属的部门"),U.set("successCb",function(a){var b=this.joinList.getDataState(),c=b.lost||[],d=b.add||[];g.api({url:"/Management/ModifyEmployeeCircles",type:"post",data:{employeeID:C.data("employeeId"),addCircleIDs:_.map(d,function(a){return a.id}),deleteCircleIDs:_.map(c,function(a){return a.id})},success:function(b){var c="";b.success&&(_.each(a,function(a){c+='<li class="circle-item fn-left">'+a.name+"</li>"}),j.html('<ul class="circle-list fn-clear">'+c+"</ul>"),U.hide())}})})},fb=function(b){var c=$(".employee-detail-title",E),d=$(".detail-info-wrapper .employee-name",E),e=$(".nick-name",E),f=$(".mobile",E),g=$(".account",E),h=$(".email",E),i=$(".post",E),j=$(".sex",E),k=$(".circle-list-wrapper",E),l="";c.text("添加员工到“"+a.name+"”"),d.val(b.fullName),e.val(b.name),f.val(b.mobile),g.val(b.account),h.val(b.email),i.val(b.post),j.filter('[value="'+b.gender+'"]').prop("checked",!0),_.each(b.circles,function(a){l+='<li class="circle-item fn-left" circleid="'+a.value+'">'+a.value1+'<span class="close-l">×</span></li>'}),k.html('<ul class="circle-list fn-clear">'+l+"</ul>"),E.data("employeeId",b.employeeID),E.data("employeeData",b),U.setTitle("修改"+b.name+"所属的部门"),U.set("successCb",function(a){var b="";_.each(a,function(a){b+='<li class="circle-item fn-left" circleid="'+a.id+'">'+a.name+'<span class="close-l">×</span></li>'}),k.html('<ul class="circle-list fn-clear">'+b+"</ul>"),U.hide()})},gb=function(){var b=$(".employee-detail-title",G),c=$(".circle-list-wrapper",G),d="";b.text("添加员工到“"+a.name+"”"),U.setTitle("选择部门"),a.id>0&&(d+='<li class="circle-item fn-left" circleid="'+a.id+'">'+a.name+'<span class="close-l">×</span></li>',c.html('<ul class="circle-list fn-clear">'+d+"</ul>")),U.set("successCb",function(a){var b="";_.each(a,function(a){b+='<li class="circle-item fn-left" circleid="'+a.id+'">'+a.name+'<span class="close-l">×</span></li>'}),c.html('<ul class="circle-list fn-clear">'+b+"</ul>"),U.hide()})},hb=function(a,b){_.isUndefined(a)||g.api({url:"/Management/GetEmployeeByID",type:"get",data:{employeeId:a},success:function(a){b&&b.call(this,a)}})},ib=function(a,b){g.api({url:"/Management/GetAllCirclesOfEmployeeID",type:"get",data:{employeeID:a},success:function(a){a.success&&(U.setInitData({joinData:ab(a.value),unjoinData:bb(a.value)}),U.show()),b&&b.call(this,a)}})},jb=function(){var a=kb();return 0==a.fullName.length?(g.alert("请输入姓名"),!1):0==a.name.length?(g.alert("请输入昵称"),!1):11==a.mobile.length&&/^\d{11}$/.test(a.mobile)?0!=a.account.length&&/^[a-zA-Z\d][\w\.@]{1,49}$/.test(a.account)?a.email.length>0&&!/^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]+$/.test(a.email)?(g.alert("请输入正确的邮箱地址"),!1):!0:(g.alert("请输入正确的账号信息"),!1):(g.alert("手机号应为11位的数字"),!1)},kb=function(){var a={},b=E.data("employeeData"),c=($(".employee-detail-title",E),$(".detail-info-wrapper .employee-name",E)),d=$(".nick-name",E),e=$(".mobile",E),f=$(".account",E),g=$(".email",E),h=$(".post",E),i=$(".sex",E),j=$(".circle-list-wrapper",E);return a.employeeID=E.data("employeeId"),a.account=_.str.trim(f.val()),a.fullName=_.str.trim(c.val()),a.name=_.str.trim(d.val()),a.department="",a.post=_.str.trim(h.val()),a.gender=i.filter(":checked").val(),a.role=b.role,a.mobile=_.str.trim(e.val()),a.email=_.str.trim(g.val()),a.circleIDs=[],$(".circle-item",j).each(function(){var b=$(this).attr("circleid");a.circleIDs.push(b)}),a},lb=function(){var a=mb();return 0==a.fullName.length?(g.alert("请输入姓名"),!1):0==a.name.length?(g.alert("请输入昵称"),!1):11==a.mobile.length&&/^\d{11}$/.test(a.mobile)?0!=a.account.length&&/^[a-zA-Z\d][\w\.@]{1,49}$/.test(a.account)?0==a.password.length?(g.alert("请输入初始密码"),!1):a.email.length>0&&!/^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]+$/.test(a.email)?(g.alert("请输入正确的邮箱地址"),!1):!0:(g.alert("请输入正确的账号信息"),!1):(g.alert("手机号应为11位的数字"),!1)},mb=function(){var a={},b=($(".employee-detail-title",G),$(".detail-info-wrapper .employee-name",G)),c=$(".nick-name",G),d=$(".mobile",G),e=$(".account",G),f=$(".email",G),g=$(".post",G),h=$(".sex",G),i=$(".pwd",G),j=$(".circle-list-wrapper",G);
return a.account=_.str.trim(e.val()),a.fullName=_.str.trim(b.val()),a.name=_.str.trim(c.val()),a.department="",a.post=_.str.trim(g.val()),a.gender=h.filter(":checked").val(),a.role=4,a.mobile=_.str.trim(d.val()),a.email=_.str.trim(f.val()),a.password=_.str.trim(i.val()),a.circleIDs=[],$(".circle-item",j).each(function(){var b=$(this).attr("circleid");a.circleIDs.push(b)}),a},nb=function(){$('input[type="text"]',G).val(""),$(".sex",G).prop("checked",!1).eq(0).prop("checked",!0),$(".fs-validate-empty-tip,.fs-validate-input-tip",G).hide(),$(".field-state-empty,.field-state-input",G).removeClass("field-state-empty field-state-input"),$(".circle-list-wrapper",G).empty()},ob=function(){$('input[type="text"]',E).val(""),$(".sex",E).prop("checked",!1).eq(0).prop("checked",!0),$(".fs-validate-empty-tip,.fs-validate-input-tip",E).hide(),$(".field-state-empty,.field-state-input",E).removeClass("field-state-empty field-state-input"),$(".circle-list-wrapper",E).empty()},pb=function(){$(".value-item",C).empty(),$(".circle-list-wrapper",C).empty(),$(".avatar-wrapper",C).empty()},qb=function(a,b){b=b||"detail","detail"==b&&(hb(a,function(a){var b;a.success&&(b=a.value,eb(b),sb())}),pb(),E.hide(),C.show())},rb=function(){var a=!1;$(".ck",S.element).each(function(){return $(this).prop("checked")?(a=!0,!1):void 0}),a?$(".action-btn",z).removeClass("button-state-disabled"):$(".action-btn",z).addClass("button-state-disabled")},sb=function(){var a,b=$(".tpl-c .tpl-inner",i),c=$(".tpl-l .tpl-inner",i).height();b.css({height:"auto"}),a=b.height(),c>a&&b.height(c)};v.on("click",".filter-item",function(b){var c,e=$(b.currentTarget),f=$(".root-node",R.element);$(".state-active",v).removeClass("state-active"),e.addClass("state-active"),cb("reset"),c=db(),"-1"==c.type?($(".stop-btn,.start-btn",z).hide(),x.hide(),S.setOpts({itemTpl:'<tr class="edit-disabled"><td class="ck-box first-td"><input class="ck" type="checkbox" /></td><td><a class="flag-name" href="javascript:;">{{flagName}}</a></td><td><a class="flag-value" href="javascript:;">{{flagValue}}</a></td></tr>',listPath:"/Management/GetInviteEmployees",formatData:function(a){return _.extend({flagName:1==a.value1?"手机":"邮箱",flagValue:a.value},a)}}),R.selectNode(f,!0),a=f.data("nodeData"),$(".department-title",i).text(a.name).attr("title",a.name),A.hide(),O.hide(),c=db(),S.load(c)):($(".stop-btn,.start-btn",z).show(),x.show(),S.setOpts({itemTpl:'<tr class="{{trCls}}"><td class="ck-box first-td"><input class="ck" type="checkbox" /></td><td><img src="'+d.BLANK_IMG+'" class="icon-sex icon-sex-{{sex}}" /><a class="employee-name" href="javascript:;">{{name}}</a></td>'+'<td class="account"><a class="account" href="javascript:;" title="{{account}}">{{account}}</a></td>'+'<td><a class="post" href="javascript:;">{{post}}</a></td>'+'<td class="last-td"><a class="mobile" href="javascript:;">{{mobile}}</a></td>'+"</tr>",listPath:"/Management/GetAllEmployees",formatData:function(a){return _.extend({trCls:a.isStop?"state-disabled":"",sex:a.gender.toLowerCase()},a)}}),("1"==c.type||"2"==c.type||"3"==c.type)&&(R.selectNode(f,!0),a=f.data("nodeData"),$(".department-title",i).text(a.name).attr("title",a.name),A.hide()),"0"==c.type||"1"==c.type?O.show():O.hide(),c=db(),S.load(c)),b.preventDefault()}),x.on("change",function(){cb("reset"),S.load(db())}),y.on("change",function(){var a=y.prop("checked");a?$(".ck",S.element).prop("checked",!0):$(".ck",S.element).prop("checked",!1),rb()}),S.element.on("change",".ck",function(){var a=$(".ck",S.element),b=!0;a.each(function(){return $(this).prop("checked")?void 0:b=!1}),y.prop("checked",b),rb()}),S.on("rowclick",function(a){var b,c=$(a.currentTarget);!c.hasClass("edit-disabled")&&$(a.target).is("a")&&(pb(),m.hide(),C.show(),b=S.getItemDataFromSelector(c),hb(b.employeeID,function(a){var b;a.success&&(b=a.value,eb(b),sb())}))}),T.after("show",function(){var b=this.element,d=$(".unjoin-wrapper",b),e=$(".box-body",d),f=$(".department-select",e);0==f.length&&(f=$('<select class="department-select"></select>'),f.prependTo(e),f.on("change",function(){T.setInitData({joinData:Y(c),unjoinData:Z(c,f.val())})})),g.api({url:"/Management/GetAllEmployeesOfCircle",type:"get",data:{circleID:a.id},success:function(a){var b,d="";a.success&&(b=a.value,c=b,_.each(b.circleItems,function(a){d+='<option value="'+a.value+'">'+a.value1+"</option>"}),f.html('<option value="0">全部</option>'+d).change())}})}),J.click(function(){R.createDepartment()}),R.on("nodeselect",function(b){X(),0!=b.id&&A.show(),p.text(b.name).attr("title",b.name),T.setTitle("修改"+b.name+"成员"),a=b,E.hide(),G.hide(),C.hide(),L.hide(),m.show(),S.load(db())}).on("nodeexpand",function(){sb()}).on("nodecollapse",function(){sb()}).on("nodedelete",function(){R.selectNode($(".root-node",R.element))}),S.on("fetch",function(a){var b;a.success&&(b=a.value,q.text(b.totalCount),y.prop("checked",!1),$(".action-btn",z).addClass("button-state-disabled"),cb("setTotalSize",b.totalCount),sb())}),D.on("click","button",function(a){var b=$(a.currentTarget),c=C.data("employeeData");if(b.hasClass("return-back-btn"))m.show(),C.hide(),S.load(db()),sb();else if(b.hasClass("edit-btn")){if(ob(),C.hide(),E.show(),sb(),_.isUndefined(c.employeeID))return;g.api({url:"/Management/GetEmployeeByID",type:"get",data:{employeeId:c.employeeID},success:function(a){var b;a.success&&(b=a.value,fb(b))}})}else if(b.hasClass("belong-department-btn"))ib(C.data("employeeId"));else if(b.hasClass("change-pwd-btn"))V.show(),V.setData({employeeId:c.employeeID,name:c.name,account:c.account});else if(b.hasClass("valid-control-btn")){var d,e;b.hasClass("set-stop-btn")?(d="您确定要停用用户："+c.name+"？",e=!0):b.hasClass("set-start-btn")&&(d="您确定要启用用户"+c.name+"？",e=!1),g.confirm(d,"提示",function(){g.api({type:"post",data:{employeeIDs:[c.employeeID],isStop:e},url:"/Management/BatchSetEmployeeStatus",success:function(a){a.success&&qb(c.employeeID,"detail")}})},{onCancel:function(){}})}else if(b.hasClass("admin-control-btn")){var d,f;b.hasClass("set-admin-btn")?(d="您确定要设置"+c.name+"为管理员吗？",f=!0):b.hasClass("cancel-admin-btn")&&(d="您确定要取消"+c.name+"的管理员权限吗？",f=!1),g.confirm(d,"提示",function(){g.api({type:"post",data:{employeeId:c.employeeID,isAdmin:f},url:"/Management/SetEmployeeIsAdmin",success:function(a){a.success&&qb(c.employeeID,"detail")}})},{onCancel:function(){}})}else b.hasClass("delete-btn")&&g.confirm("您确定要删除用户："+c.name+"？","提示",function(){g.api({type:"post",data:{employeeIDs:[c.employeeID]},url:"/Management/BatchDeleteEmployee",success:function(a){a.success&&(E.hide(),m.show(),S.load(db()))}})},{onCancel:function(){}})}),F.on("click",".return-back-btn",function(){qb(E.data("employeeId"),"detail")}),E.on("click",".change-circle-btn",function(){ib(E.data("employeeId"))}).on("click",".circle-item .close-l",function(a){$(a.currentTarget).closest(".circle-item").remove()}).on("click",".f-sub",function(a){jb()&&g.api({url:"/Management/ModifyEmployee",type:"post",data:kb(),success:function(a){a.success&&(g.showSucessTip("修改成功"),qb(E.data("employeeId"),"detail"))}},{submitSelector:$(a.currentTarget)})}).on("click",".f-cancel",function(){qb(E.data("employeeId"),"detail")}),I.on("click",function(){nb(),m.hide(),G.show(),gb(),sb()}),H.on("click",".return-back-btn",function(){m.show(),G.hide(),S.load(db()),sb()}),G.on("click",".change-circle-btn",function(){ib(0)}).on("click",".circle-item .close-l",function(a){$(a.currentTarget).closest(".circle-item").remove()}).on("click",".f-sub",function(a){lb()&&g.api({url:"/Management/CreateEmployee",type:"post",data:mb(),success:function(a){a.success&&(g.showSucessTip("添加成功"),m.show(),G.hide(),S.load(db()))}},{submitSelector:$(a.currentTarget)})}).on("click",".f-cancel",function(){m.show(),G.hide(),S.load(db())}).on("blur",".employee-name",function(a){var b=$(a.currentTarget),c=$(".nick-name",G),d=_.str.trim(b.val());d.length>0&&0==_.str.trim(c.val()).length&&c.val(d)}).on("blur",".mobile",function(a){var b=$(a.currentTarget),c=$(".account",G),d=_.str.trim(b.val());/^\d{11}$/.test(d)&&0==_.str.trim(c.val()).length&&c.val(d)}),z.on("click",".action-btn",function(a){var b,c=$(a.currentTarget),d=$(".state-active",v),e=d.attr("filtertype"),f=S.getAllSelectData(),h=_.map(f,function(a){return a.employeeID}),i=!0;if(c.hasClass("button-state-disabled"))return!1;if(c.hasClass("stop-btn")){if(_.some(f,function(a){return a.isStop?(i=!1,!0):void 0}),!i)return g.alert("没有被停用的用户可以停用，请选择"),!1;g.confirm("您确认要停用"+h.length+"个用户吗？","提示",function(){g.api({type:"post",data:{employeeIDs:h,isStop:!0},url:"/Management/BatchSetEmployeeStatus",success:function(a){a.success&&S.load(db())}})},{onCancel:function(){}})}else if(c.hasClass("start-btn")){if(_.some(f,function(a){return a.isStop?void 0:(i=!1,!0)}),!i)return g.alert("只有停用的用户才可以启用，请选择"),!1;g.confirm("您确认要启用"+h.length+"个用户吗？","提示",function(){g.api({type:"post",data:{employeeIDs:h,isStop:!1},url:"/Management/BatchSetEmployeeStatus",success:function(a){a.success&&S.load(db())}})},{onCancel:function(){}})}else c.hasClass("delete-btn")&&("-1"==e?(b=_.map(f,function(a){return a.value}),g.confirm("是否要删除选中的"+b.length+"个邀请，删除后收到邀请的员工将不能加入到企业/团队中","提示",function(){g.api({type:"post",data:{accounts:b.join("|")},url:"/Management/DeleteInviteEmployees",success:function(a){a.success&&(g.showSucessTip("删除成功"),S.load(db()))}})},{onCancel:function(){}})):g.confirm("您确认要删除"+h.length+"个用户吗？","提示",function(){g.api({type:"post",data:{employeeIDs:h},url:"/Management/BatchDeleteEmployee",success:function(a){a.success&&(g.showSucessTip("删除成功"),S.load(db()))}})},{onCancel:function(){}}))}),w.on("click",".icon-search",function(){cb("reset"),S.load(db())}).on("keydown",".search-field",function(a){13==a.keyCode&&(cb("reset"),S.load(db()),a.preventDefault())}),K.click(function(){L.show(),m.hide(),sb()}),L.on("click",".return-back-btn",function(){m.show(),L.hide(),S.load(db()),sb()}),$(".batch-import-tpl-l",i).on("click",function(a){g.confirm("是否要保存 员工导入模板","提示",function(){window.open(d.API_PATH+"/ManagementDF/GetEmployeeExcelTemplate?r="+new Date/1)},{onCancel:function(){}}),a.preventDefault()});var tb;new o({element:M,h5Opts:{multiple:!1,accept:"*/*"},flashOpts:{file_types:"*.*",file_types_description:"所有文件",button_width:52,button_height:27},h5UploadPath:"/Management/uploadFile",flashUploadPath:"/Management/UploadFileByForm",onSelect:function(a){$(".file-path-field",L).val(a.name),this.startUpload()},onSuccess:function(a,b){var c=h.parse(b);c.success&&(tb=c.value.filePath,N.removeClass("button-state-disabled"))},onComplete:function(){this.removeAllFile()}}),N.click(function(a){var b=$(a.currentTarget);b.hasClass("button-state-disabled")||g.api({type:"post",data:{path:tb,isSendSMS:$(".is-send-sms",L).prop("checked")},url:"/Management/ImportEmployees",success:function(a){var b;a.success&&(b=a.value,0==b.importEmployeePropertys.length?(g.showSucessTip("导入成功"),e.navRouter.navigate("",{trigger:!0}),e.navRouter.navigate("#departmentstaff",{trigger:!0})):(g.setTplStore("departmentstaff",{importData:b}),e.navRouter.navigate("circles/importemployeeseditor",{trigger:!0})))},complete:function(){tb="",N.addClass("button-state-disabled"),$(".file-path-field",L).val("")}})}),A.click(function(){T.show()}),O.click(function(){var a=S.getListData();a&&a.length>0?window.open(d.API_PATH+"/Management/GetAllEmployeesExcel?"+$.param(db())):g.alert("您选择的筛选条件中无员工数据")});var ub,vb,wb=location.search;wb&&(ub=wb.slice(1).split("&"),vb={},_.each(ub,function(a){var b=a.split("=");vb[b[0]]=b[1]}),"yes"==vb.showcircleguide&&g.showGuideTip(J,{leftTopIncrement:-5,rightTopIncrement:-5,rightLeftIncrement:-5,imageName:"admin-create-circle.png",imagePosition:{top:"-20px",left:"20px"},renderCb:function(a,b,c,d){var e=$('<div class="fs-guide-shadow-link"></div>'),f=$('<div class="fs-guide-shadow-link"></div>'),g=function(){b.remove(),c.remove()};e.css({width:"26px",height:"26px",position:"absolute",top:"9px",left:"203px",cursor:"pointer"}).appendTo(a),f.css({width:"122px",height:"32px",position:"absolute",top:"102px",left:"74px",cursor:"pointer"}).appendTo(a),e.click(function(){g()}),f.click(function(){g()}),d.one("click",function(){g()})}}));var xb=!0,yb=function(){var a=g.getTplQueryParams(),b=a?a.create:"";"circle"==b?R.createDepartment():"employee"==b&&(nb(),m.hide(),G.show(),gb())},zb=function(){var b=$(".root-node",R.element),c=g.getTplQueryParams(),e=c?c.filterid:0;$(".filter-item",v).removeClass("state-active"),$(".filter-item",v).eq(parseInt(e)).addClass("state-active"),"-1"==e?($(".stop-btn,.start-btn",z).hide(),x.hide(),S.setOpts({itemTpl:'<tr class="edit-disabled"><td class="ck-box first-td"><input class="ck" type="checkbox" /></td><td><a class="flag-name" href="javascript:;">{{flagName}}</a></td><td><a class="flag-value" href="javascript:;">{{flagValue}}</a></td></tr>',listPath:"/Management/GetInviteEmployees",formatData:function(a){return _.extend({flagName:1==a.value1?"手机":"邮箱",flagValue:a.value},a)}}),b.length>0&&(R.selectNode(b,!0),a=b.data("nodeData"),$(".department-title",i).text(a.name).attr("title",a.name),A.hide())):($(".stop-btn,.start-btn",z).show(),x.show(),S.setOpts({itemTpl:'<tr class="{{trCls}}"><td class="ck-box first-td"><input class="ck" type="checkbox" /></td><td><img src="'+d.BLANK_IMG+'" class="icon-sex icon-sex-{{sex}}" /><a class="employee-name" href="javascript:;">{{name}}</a></td>'+'<td class="account"><a class="account" href="javascript:;" title="{{account}}">{{account}}</a></td>'+'<td><a class="post" href="javascript:;">{{post}}</a></td>'+'<td class="last-td"><a class="mobile" href="javascript:;">{{mobile}}</a></td>'+"</tr>",listPath:"/Management/GetAllEmployees",formatData:function(a){return _.extend({trCls:a.isStop?"state-disabled":"",sex:a.gender.toLowerCase()},a)}}),b.length>0&&(("1"==e||"2"==e||"3"==e)&&(R.selectNode(b,!0),a=b.data("nodeData"),$(".department-title",i).text(a.name).attr("title",a.name),A.hide()),"0"==e||"1"==e?O.show():O.hide()))},Ab=function(){var a=g.getTplQueryParams(),b=a?a.enter:"";"import"==b&&(L.show(),m.hide())};Ab(),f.on("switched",function(b,c){var d;b==j&&(d=g.getTplStore("entinfomgt","enterpriseName")||Q.allCompanyDefaultString||"全公司",xb?(R.one("nodeselect",function(){zb(),yb(),$(".root-node",R.element).children(".node-info").find(".node-text").text(d),R.setNodeData(0,{name:d}),0==a.id&&$(".department-title",c).text(d).attr("title",d),S.load(db())}),xb=!1):(E.hide(),G.hide(),C.hide(),L.hide(),m.show(),R.reload(function(){zb(),S.load(db()),yb(),Ab(),$(".root-node",R.element).children(".node-info").find(".node-text").text(d),R.setNodeData(0,{name:d}),0==a.id&&$(".department-title",c).text(d).attr("title",d)})))})}});