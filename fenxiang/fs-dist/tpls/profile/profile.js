/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("tpls/profile/profile",["util","moment","tabs","dialog","modules/feed-list/feed-list","modules/fs-reply/fs-reply-list","modules/fs-attach/fs-attach-list","modules/fs-plan-calendar/fs-plan-calendar","modules/fs-qx/fs-qx"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=e.event,g=a("util"),h=a("moment"),i=a("tabs"),j=a("dialog"),k=a("modules/feed-list/feed-list"),l=a("modules/fs-reply/fs-reply-list").replyList,m=a("modules/fs-attach/fs-attach-list"),n=a("modules/fs-plan-calendar/fs-plan-calendar"),o=n.FsPlanCalendar,p=n.ExportPlanDialog,q=a("modules/fs-qx/fs-qx.js");$(".pamrk-apv-tpl");var r=j.extend({attrs:{width:"580px",className:"pamrk-apv-dialog",list:null,content:'<div class="ui-dialog-title"></div><div class="ui-dialog-text"><div class="pamrk-list-wrap"><table class="pamrk-list-table" cellspacing="1"><tr><th>员工</th><th>响应时间(分钟)</th><th>排名</th><th>趋势</th></tr><tbody class="pamrk-item-wrap"></tbody></table></div><div class="pamrk-btn-wrap marg20"><button class="f-cancel button-grey f-cancel" data-role="cancel">关闭</button></div></div>'},events:{"click .f-cancel":"_cancel"},renderTable:function(a,b){var c=this.element,e=$(".pamrk-item-wrap",c),f="";$(".ui-dialog-title",c).html(a),b.value.rankings.length>0&&_.each(b.value.rankings,function(a){var b=(a.employeeID,a.employee,a.employee.name),c=g.getAvatarLink(a.employee.profileImage,3),e=a.averageMinutes,h=a.ranking,i=a.trend;a.totalCount;var j="";j=i>0?"<img src="+d.ASSETS_PATH+"/images/arrowup.png />":0>i?"<img src="+d.ASSETS_PATH+"/images/arrowdown.png />":"-",f+='<tr><td style="text-align:left;padding-left:5px;"><img class="pamrk_tdimg_head" src="'+c+'" width="25" height="25" />'+b+"</td><td>"+e+"分钟</td><td>"+h+"</td><td>"+j+"</td></tr>"}),e.html(f)},show:function(){var a=r.superclass.show.apply(this,arguments);return a},hide:function(){var a=r.superclass.hide.apply(this,arguments);return this._clear(),a},_clear:function(){var a=this.element;$(".ui-dialog-title",a).html("");var b=$(".pamrk-item-wrap",a);b.empty()},_cancel:function(){var a=this.element;$(".ui-dialog-title",a).html("");var b=$(".pamrk-item-wrap",a);b.empty(),this.hide()}}),s=new r,t=function(){this.tplEl=b.tplEl,this.tplName=b.tplName,this.init()};_.extend(t.prototype,{init:function(){this.contactDataInit(),this.centerTopInit(),this.leftSideBarInit(),this.rightSideBarInit(),this.profileTabsInit(),this.otherInit()},destroy:function(){this.contactDestroy(),this.centerTopDestroy(),this.leftSideBarDestroy(),this.rightSideBarDestroy(),this.profileTabsDestroy(),this.feedDestroy(),this.replyDestroy(),this.attachDestroy(),this.tjDestroy(),this.otherDestroy()},contactDataInit:function(){this.contactData=g.getContactData()},contactDestroy:function(){this.contactData=null},centerTopInit:function(){var a,b=this.tplEl,c=$(".tpl-c",b),d=$(".edit-user-profile-l",c),e=$(".chat-l",c),f=g.getTplQueryParams(),h=f?f.empid:0,i=this.contactData,j=i.u;0==h||j.id==h?(d.show(),e.hide()):(a=g.getContactDataById(h,"p"),d.hide(),a?(e.show(),e.click(function(b){var c,d,e=q.chatPanel,f=g.getTplQueryParams(),h=f?f.empid:0;0!=h&&(c=[h,j.id],d={name:a.name,profileImage:a.profileImagePath,participantIds:c},e.addOrUpdateSession({employeeIds:c,sessionType:"pair",data:d},!0),e.switchPanelStatus("shown",!0)),b.preventDefault(),b.stopPropagation()})):e.hide())},centerTopDestroy:function(){},profileTabsInit:function(){var a=this,b=this.tplEl,c=$(".profile-tabs",b),d=new i({element:c,triggers:$(".ui-tab-item",c).removeClass("ui-tab-item-current"),panels:$(".ui-tab-panel",c).hide(),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click",withTabEffect:!1}).render();d.on("switched",function(c){var e=d.get("panels").eq(c),f=e.attr("action"),g=$(".tpl-c",b),h=$(".tpl-r",b);e.data("rendered")||(a[f+"Init"]&&a[f+"Init"](),e.data("rendered",!0)),"attach"==f||"tj"==f?(g.css({width:"80%"}),h.hide(),a.planCalendar.hide()):(g.css({width:"60%"}),h.show(),a.planCalendar.show(),a.planCalendar.refreshPlanDate())}),d.trigger("switched",0,-1),this.profileTabs=d},profileTabsDestroy:function(){this.profileTabs.get("panels").removeData(),this.profileTabs.destroy(),this.profileTabs=null},feedInit:function(){var a=this,b=this.tplEl,c=(this.tplName,$(".profile-tabs",b)),d=$(".feed-panel",c),e=$(".filter",d),f=$(".feed-type",d),h=$(".sub-type",d),i=$(".attach",d),j=$(".search-inp",d),l=$(".search-btn",d),m=$(".feed-list",d),n=$(".feed-list-pagination",d),o=this.contactData,p=o.u,q=new k({element:m,pagSelector:n,pagOpts:{pageSize:20,visiblePageNums:7},loadSize:15,listPath:"/feed/getFeedsOfOneEmployeeSend",defaultRequestData:function(){var a=g.getTplQueryParams(),b=a?a.empid:p.id,c=$(".state-active",f).attr("val"),d=$(".filter-field",h).filter(":visible").find(".state-active").attr("val")||0,e=$(".state-active",i).attr("val");return{employeeID:b,feedAttachType:e,subType:d,feedType:c,keyword:_.str.trim(j.val())}},searchOpts:{inputSelector:j,btnSelector:l},listEmptyText:"没有获取到信息",listSuccessCb:function(b){var c,d;b.success&&(c=b.value,d=c.fullEmployee,a.renderEmployeeInfo(d))}});q.load(),e.on("click",".feed-type .filter-value",function(a){var b=$(this),c=b.attr("subtypename"),d=$("."+c+"-type",h);$(".filter-field",h).hide(),d.length>0&&d.show(),a.preventDefault()}).on("click",".filter-value",function(a){var b=$(this),c=b.closest(".filter-value-wrapper");$(".filter-value",c).removeClass("state-active"),b.addClass("state-active"),q.reload(),a.preventDefault()}),l.click(function(a){q.reload(),a.preventDefault()}),this.feedList=q},feedDestroy:function(){var a=this.tplEl,b=$(".profile-tabs",a),c=$(".feed-panel",b),d=$(".filter",c),e=$(".search-btn",c);this.feedList&&(this.feedList.destroy(),this.feedList=null),d.off(),e.unbind(),$(".sub-type .filter-field",d).hide().removeClass("state-active").eq(0).addClass("state-active"),$(".feed-type .filter-value",d).removeClass("state-active").eq(0).addClass("state-active"),$(".attach .filter-value",d).removeClass("state-active").eq(0).addClass("state-active")},replyInit:function(){var a=this.tplEl,b=$(".profile-tabs",a),c=$(".reply-panel",b),d=$(".filter",c),e=$(".feed-type",c),f=$(".attach",c),h=$(".search-inp",c),i=$(".search-btn",c),j=$(".reply-list",c),k=$(".reply-list-pagination",c),m=this.contactData,n=m.u,o=new l({element:j,pagSelector:k,pagOpts:{pageSize:45,totalSize:0,visiblePageNums:7},hideReplyBtn:!1,listPath:"/feed/getFeedReplysOfOneEmployee",defaultRequestData:function(){var a=g.getTplQueryParams(),b=a?a.empid:n.id,c=$(".state-active",e).attr("val"),d=$(".state-active",f).attr("val");return{employeeID:b,feedAttachType:d,feedType:c,keyword:_.str.trim(h.val())}},searchOpts:{inputSelector:h,btnSelector:i},replyCb:function(a){a.success&&o.reload()}});o.load(),d.on("click",".filter-value",function(a){var b=$(this),c=b.closest(".filter-value-wrapper");$(".filter-value",c).removeClass("state-active"),b.addClass("state-active"),o.reload(),a.preventDefault()}),i.click(function(a){o.reload(),a.preventDefault()}),this.replyList=o},replyDestroy:function(){var a=this.tplEl,b=$(".profile-tabs",a),c=$(".reply-panel",b),d=$(".filter",c),e=$(".search-btn",c);this.replyList&&(this.replyList.destroy(),this.replyList=null),d.off(),e.unbind(),$(".feed-type .filter-value",d).removeClass("state-active").eq(0).addClass("state-active"),$(".attach .filter-value",d).removeClass("state-active").eq(0).addClass("state-active")},attachInit:function(){var a=this.tplEl,b=$(".profile-tabs",a),c=$(".attach-panel",b),d=$(".filter",c),e=$(".attach",c),f=($(".search-inp",c),$(".search-btn",c)),h=$(".attach-list-wrapper",c),i=$(".attach-list",c),j=$(".attach-list-pagination",c),k=$(".img-list-wrapper",c),l=$(".img-list",c),n=$(".img-list-pagination",c),o=$(".audio-list-wrapper",c),p=$(".audio-list",c),q=$(".audio-list-pagination",c),r=this.contactData,s=r.u,t=function(){var a=$(".state-active",e).attr("val");"2"==a?(h.hide(),o.hide(),k.show(),v.reload()):"3"==a?(k.hide(),o.hide(),h.show(),u.reload()):"1"==a&&(k.hide(),h.hide(),o.show(),w.reload())},u=new m({element:i,pagSelector:j,pagOpts:{pageSize:15,visiblePageNums:7},attachType:"attach",listPath:"/attach/getAttachFilesOfOneEmployeeSend",loadSize:15,defaultRequestData:function(){var a=g.getTplQueryParams(),b=a?a.empid:s.id,c=$(".state-active",e).attr("val"),d=$(".search-inp",h);return{employeeID:b,attachType:c,keyword:_.str.trim(d.val())}},searchOpts:{inputSelector:$(".search-inp",h),btnSelector:$(".search-btn",h)},showSenderName:!1}),v=new m({element:l,pagSelector:n,pagOpts:{pageSize:12,visiblePageNums:7},attachType:"img",listPath:"/attach/getAttachFilesOfOneEmployeeSend",loadSize:15,defaultRequestData:function(){var a=g.getTplQueryParams(),b=a?a.empid:s.id,c=$(".state-active",e).attr("val"),d=$(".search-inp",k);return{employeeID:b,attachType:c,keyword:_.str.trim(d.val())}},searchOpts:{inputSelector:$(".search-inp",k),btnSelector:$(".search-btn",k)},showSenderName:!1}),w=new m({element:p,pagSelector:q,pagOpts:{pageSize:15,visiblePageNums:7},attachType:"audio",listPath:"/attach/getAttachFilesOfOneEmployeeSend",loadSize:15,defaultRequestData:function(){var a=g.getTplQueryParams(),b=a?a.empid:s.id,c=$(".state-active",e).attr("val"),d=$(".search-inp",o);return{employeeID:b,attachType:c,keyword:_.str.trim(d.val())}},searchOpts:{inputSelector:$(".search-inp",o),btnSelector:$(".search-btn",o)},showSenderName:!1});v.load(),f.click(function(a){t(),a.preventDefault()}),d.on("click",".filter-value",function(a){var b=$(this),c=b.closest(".filter-value-wrapper");b.attr("val"),$(".filter-value",c).removeClass("state-active"),b.addClass("state-active"),t(),a.preventDefault()}),this.attachList=u,this.imgList=v,this.audioList=w},attachDestroy:function(){var a=this.tplEl,b=$(".profile-tabs",a),c=$(".attach-panel",b),d=$(".filter",c),e=$(".search-btn",c);this.attachList&&(this.attachList.destroy(),this.attachList=null),this.imgList&&(this.imgList.destroy(),this.imgList=null),this.audioList&&(this.audioList.destroy(),this.audioList=null),e.unbind(),d.off(),$(".attach .filter-value",d).removeClass("state-active").eq(0).addClass("state-active")},renderEmployeeInfo:function(a){var b=this.tplEl,c=$(".userinfo-panel",b),d=$(".cen-user-info-wrap",c),e=$(".cen-user-info-tpl",c),f=_.template(e.html()),g=a.gender,h=a.department,i=a.post,j=a.qq,k=a.msn,l=a.email,m=a.tel,n=a.mobile,o=a.description;g="M"==g?"男":"女";var p=f({gender:g,department:h,post:i,qq:j,msn:k,email:l,tel:m,mobile:n,description:o});d.html(p),$(".tpl-c .employee-mobile",b).html(n),""!=i&&""!=h?$(".tpl-c .circle-job",b).html(i+"-"+h):$(".tpl-c .circle-job",b).html(i+h)},userinfoInit:function(){},userinfoDestroy:function(){},tjInit:function(){for(var a=this.tplEl,b=$(".tj-panel",a),c=$(".year-select",b),d=this.contactData,e=d.u,f=g.getTplQueryParams(),i=f?f.empid:e.id,j=$(".tjp-person-wrap",a),k=$(".tjp-person-list-tpl",a),l=_.template(k.html()),m=$(".tjp-manage-wrap",a),n=$(".tjp-manage-list-tpl",a),o=_.template(n.html()),p=h(new Date).year(),q="",r=p-2,t=p;t>r;r++)q+='<option value="'+r+'">'+r+"年</option>";q+='<option value="'+p+'" selected="selected">'+p+"年</option>",q+='<option value="'+(p+1)+'">'+(p+1)+"年</option>",c.html(q),c.change(function(){g.api({url:"/statistic/getMonthStatisticInfoByEmployeeID",data:{employeeID:i,year:c.val()},type:"get",success:function(c){var d;if(c.success){var e,f="",g="";if(d=c.value,e=d.items,e.length>0?b.find(".list-empty-tip").hide():b.find(".list-empty-tip").show(),e.reverse(),e.length>0){var h=0,i=0,k=0,n=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0;_.each(e,function(a){var b=a.month+"月",c=a.shareTotalCount,d=a.planTotalCount,e=a.planCommentCount,j=a.planTotalNumber,m=a.workTotalNumber,A=a.workCompleteTotalCount,B=a.workTimeoverCompleteTotalCount,C=a.planAverageMinutes,D=a.workAverageMinutes,E=a.approveAverageMinutes,F=a.approveTotalCount,G=a.workCommentCount,H=a.approveAverageMinuteRanking,I=a.planAverageMinuteRanking,J=a.workAverageMinuteRanking,K=0,L=0;K=0!=d?parseInt(j)/parseInt(d):0,L=0!=A?parseInt(m)/parseInt(A):0;var M;.5>K?M="star0":1>K?M="star0.5":1.5>K?M="star1":2>K?M="star1.5":2.5>K?M="star2":3>K?M="star2.5":3.5>K?M="star3":4>K?M="star3.5":4.5>K?M="star4":5>K?M="star4.5":5.5>K&&(M="star5");var N;.5>L?N="star0":1>L?N="star0.5":1.5>L?N="star1":2>L?N="star1.5":2.5>L?N="star2":3>L?N="star2.5":3.5>L?N="star3":4>L?N="star3.5":4.5>L?N="star4":5>L?N="star4.5":5.5>L&&(N="star5"),0==c&&(c="-"),0==d&&(d="-"),0==A&&(A="-"),0==B&&(B="-"),f+=l({month:b,shareTotalCount:c,planTotalCount:d,planStarImgName:M,workStarImgName:N,planTotalCount:d,workCompleteTotalCount:A,workTimeoverCompleteTotalCount:B}),"-"==c&&(c=0),"-"==d&&(d=0),"-"==A&&(A=0),"-"==B&&(B=0),h+=parseInt(c),i+=parseInt(d),k+=parseInt(j),n+=parseInt(K),r+=L,p+=parseInt(m),q+=parseInt(G),s+=parseInt(A),t+=parseInt(B),0!=F?E/=F:E=0,0!=e?C/=e:C=0,0!=G?D/=G:D=0,C=0==C?"-":parseInt(C)+"分钟",D=0==D?"-":parseInt(D)+"分钟",E=0==E?"-":parseInt(E)+"分钟",g+=o({month:b,planAverageMinutes:C,workAverageMinutes:D,approveAverageMinutes:E,planAverageMinuteRanking:I,workAverageMinuteRanking:J,approveAverageMinuteRanking:H}),u+=parseInt(C),v+=parseInt(D),w+=parseInt(E),x+=parseInt(I),y+=parseInt(J),z+=parseInt(H)}),j.empty(),m.empty(),j.append(f),m.append(g),0==h&&(h="-"),0==i&&(i="-"),$("#shareTcount").html(h),$("#planTcount").html(i),"-"==h&&(h=0),"-"==i&&(i=0);var A,B=(u/e.length,x/e.length),C=(v/e.length,y/e.length),D=(w/e.length,z/e.length);A=0!=i?k/i:0;var E;.5>A?E="star0":1>A?E="star0.5":1.5>A?E="star1":2>A?E="star1.5":2.5>A?E="star2":3>A?E="star2.5":3.5>A?E="star3":4>A?E="star3.5":4.5>A?E="star4":5>A?E="star4.5":5.5>A&&(E="star5"),$("#plansrathtml").html('<img src="../../html/fs/assets/images/rating/'+E+'.png" />');var F;F=0!=q?p/q:0;var G;.5>F?G="star0":1>F?G="star0.5":1.5>F?G="star1":2>F?G="star1.5":2.5>F?G="star2":3>F?G="star2.5":3.5>F?G="star3":4>F?G="star3.5":4.5>F?G="star4":5>F?G="star4.5":5.5>F&&(G="star5"),0==s&&(s="-"),0==t&&(t="-"),$("#worksrathtml").html('<img src="../../html/fs/assets/images/rating/'+G+'.png" />'),$("#workCompleteTCount").html(s),$("#workTimeoverCompleteTCount").html(t),$("#planAmTCount").html("-"),$("#workAmTCount").html("-"),$("#approveAmTCount").html("-"),$("#planAMRkTCount").html(parseInt(B)),$("#workAMRkTCount").html(parseInt(C)),$("#approveAMRkTCount").html(parseInt(D))}else $("#worksrathtml").empty(),$("#workCompleteTCount").empty(),$("#workTimeoverCompleteTCount").empty(),$("#planAmTCount").empty(),$("#workAmTCount").empty(),$("#approveAmTCount").empty("-"),$("#planAMRkTCount").empty(),$("#workAMRkTCount").empty(),$("#approveAMRkTCount").empty(),j.empty(),m.empty(),$(".person-eff .total-summary tr span",a).empty()}}})}).change();var u=$(".person-eff",a);u.on("click",".pamrk-adialog",function(){var b=$(this),c=b.attr("type"),d=$(".year-select",a).val(),e=parseInt(b.attr("month")),f="";f=1==c?"日志":2==c?"指令":"审批";var h=d+"年"+e+"月"+f+"点评响应时间排名";g.api({type:"get",data:{rankingType:c,year:d,month:e},url:"/Statistic/GetYearMonthStatisticByRanking",success:function(a){s.show(),s.renderTable(h,a,c)}})})},tjDestroy:function(){var a=this.tplEl,b=$(".tj-panel",a),c=$(".year-select",b);c.unbind("change")},leftSideBarInit:function(){var a=this,b=this.tplEl,c=$(".tpl-l",b),d=$(".head-img-wrap",b),e=$(".nodisturb",c),f=$(".sms-alert",c),h=this.contactData,i=h.u,j=g.getTplQueryParams(),k=j?j.empid:i.id,l=$(".puser-left-info-wrap",b),m=$(".puser-left-info-tpl",b),n=_.template(m.html());g.api({type:"get",data:{employeeID:k},url:"/statistic/getStatisticInfoByEmployeeID",success:function(h){var i,j,k,m,o="";if(h.success){i=h.value,j=i.smsNotDisturb,k=i.feedPlanRemaidObject,m=i.employee,d.html('<img class="fn-left" src="'+g.getAvatarLink(m.profileImage,1)+'" />');var p=i.statistic,q=p.shareTotalCount,r=p.planTotalNumber,s=p.planTotalCount,t=p.planCommentCount,u=p.planAverageMinutes,v=p.workCompleteTotalCount,w=p.workTimeoverCompleteTotalCount,x=p.workTotalNumber,y=p.workCommentCount,z=p.workAverageMinutes,A=p.approveTotalCount,B=p.approveAverageMinutes;0!=A?B/=A:B=0,0!=t?u/=t:u=0,0!=y?z/=y:z=0;var C,D,E;C=0!=v?100*parseFloat(v-w)/v:0,D=0!=s?1*r/s:0,E=0!=v?1*x/v:0;var F;.5>D?F="star0":1>D?F="star0.5":1.5>D?F="star1":2>D?F="star1.5":2.5>D?F="star2":3>D?F="star2.5":3.5>D?F="star3":4>D?F="star3.5":4.5>D?F="star4":5>D?F="star4.5":5.5>D&&(F="star5");var G;.5>E?G="star0":1>E?G="star0.5":1.5>E?G="star1":2>E?G="star1.5":2.5>E?G="star2":3>E?G="star2.5":3.5>E?G="star3":4>E?G="star3.5":4.5>E?G="star4":5>E?G="star4.5":5.5>E&&(G="star5"),u=0==u?"-":parseInt(u)+"分钟",z=0==z?"-":parseInt(z)+"分钟",B=0==B?"-":parseInt(B)+"分钟",o=n({shareTotalCount:q,planStarImgName:F,planAverageMinutes:u,workCompletePrencet:C.toFixed(2),workStarImgName:G,workAverageMinutes:z,approveAverageMinutes:B}),l.html(o),$(".show-tj-detail-l",c).click(function(b){a.profileTabs.switchTo(4),b.preventDefault()}),j.length>0?(j=j.split(","),e.html('免打扰 <strong class="color-blue">'+j[0]+":00~"+j[1]+":00</strong>")):e.html("未设置免打扰"),k&&k.weekShow?f.html('日志短信提醒时间<br/><strong class="color-blue">'+k.weekShow+'</strong><br/><strong class="color-blue">'+k.monthShow+"</strong>"):f.html("还没有设置短信提醒"),$(".tpl-c .working-state",b).html(i.employee.workingState),$(".tpl-c .employee-name",b).html(i.employee.name)}}})},leftSideBarDestroy:function(){},rightSideBarInit:function(){var a=this.tplEl,b=$(".plan-calendar",a),c=$(".r-map-count",a),d=$(".r-map-sign-wrap",a),e=$(".export-plan-l",a),f=this.contactData,h=f.u,i=new o({trigger:b,listDefaultRequest:function(){var a=g.getTplQueryParams(),b=a?a.empid:h.id;return{employeeID:b}},refreshDefaultRequest:function(){var a=g.getTplQueryParams(),b=a?a.empid:h.id;return{employeeID:b}},refreshCb:function(a){var b,e=g.getTplQueryParams(),f=e?e.empid:h.id;a.success&&(b=a.value,c.text(b.totalLocationCount),b.totalLocationCount>0?d.addClass("map-flag").html('<a href="#profile/profilelocations/=/id-'+f+'" title="">&nbsp;</a>'):d.removeClass("map-flag").text("没有签到信息 "))}});i.refreshPlanDate(),this.planCalendar=i;var j=g.getTplQueryParams(),k=j?j.empid:h.id;this.exportPlan=new p({trigger:e,employeeId:k})},rightSideBarDestroy:function(){this.planCalendar&&this.planCalendar.destroy(),this.exportPlan&&this.exportPlan.destroy()},otherInit:function(){},otherDestroy:function(){}}),b.init=function(){var a,c=(b.tplEl,b.tplName);a=new t;var d=function(){a.destroy()};f.one("beforeremove",function(a){a==c&&d()})}});