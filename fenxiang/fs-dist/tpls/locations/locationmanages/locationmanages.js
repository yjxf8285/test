/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("tpls/locations/locationmanages/locationmanages",["util","modules/fs-qx/fs-qx-helper","modules/publish/publish-helper","moment","tpls/approve/approve-common"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=e.event,g=a("util"),h=a("modules/fs-qx/fs-qx-helper"),i=a("modules/publish/publish-helper"),j=(a("moment"),a("tpls/approve/approve-common")),k=h.JoinDialog,l=i.DateSelect,m=j.AllApproveValid;b.init=function(){var a=b.tplEl,c=b.tplName,e=$(".locations-tpl-left",a).html(),h=g.getContactData(),i=h.u,j=i.inVipService,n=$(".tpl-l .tpl-inner",a),h=g.getContactData(),o=h.u;o.functionPermissions;var p={},q=_.template(e);_.extend(p,{userName:o.name,profileImage:o.profileImage}),n.html(q(p)),g.regTplNav($(".tpl-nav-lb",n),"depw-menu-aon");var r=function(a){a=$.extend({element:$("body")},a||{}),this.opts=a,this.element=a.element,this.init()};$.extend(r.prototype,{init:function(){this.inVipServiceFn(),this.bindEvents(),this.renderCircleDialog(),this.renderEmployeesDialog(),this.setDateSelect()},inVipServiceFn:function(){var a=this.element,b=$(".j-submit-btn",a),c=$(".total-download-time",a);j?$(".readme-list",a).remove():(b.addClass("button-state-disabled"),g.api({url:"/file/GetDownLoadLimit",type:"get",dataType:"json",data:{bussinessType:1},beforeSend:function(){},success:function(a){if(a.success){var d=a.value.value,e=a.value.value1,f=d-e;c.text(d),f>0?(b.text("生成报表（余"+f+"次）"),b.data("value",f),b.removeClass("button-state-disabled")):b.text("生成报表（余0次）")}}}))},setDateSelect:function(){var a=new l({element:$(".j-starttime-warp"),placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）"}),b=new l({element:$(".j-endtime-warp"),placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）"});this.starttimeDs=a,this.endtimeDs=b},bindEvents:function(){var a=this.element,b=this;a.on("click",".j-submit-btn",function(a){var c=$(a.currentTarget);c.is(".button-state-disabled")||(0==b.circleJoinData.length&&0==b.employeesJoinData.length?g.alert("部门或者员工至少选择一个"):(b.inVipServiceFn(),b.getLocationResultExcel()))}),a.on("click",".locationmanages-downbtn",function(b){var c=$(b.currentTarget),d=$(".j-submit-btn",a),e=d.data("value");d.text("生成报表（余"+(e-1)+"次）"),1==e&&d.addClass("button-state-disabled"),c.hide()}),a.on("click",".j-select-circle",function(){b.getAllCircleInfos()}),a.on("click",".j-select-employee",function(){b.getAllShortEmployees()}),a.on("click",".j-circle-warp .j-select-clear",function(){var a=$(this).closest(".rwarp").find(".circle-warp");b.circleJoinData=[],a.hide(),$(this).hide()}),a.on("click",".j-employees-warp .j-select-clear",function(){var a=$(this).closest(".rwarp").find(".circle-warp");b.employeesJoinData=[],a.hide(),$(this).hide()}),a.on("click",".circle-warp b",function(){var a=$(this).closest("dd"),c=$(this).closest(".circle-warp"),d=$(this).closest(".rwarp").find(".j-select-clear"),e=a.data("id"),f=a.data("type");"c"==f?b.circleJoinData=g.excludeDataByKey(e,"id",b.circleJoinData):b.employeesJoinData=g.excludeDataByKey(e,"id",b.employeesJoinData),a.remove(),""==c.html()&&(c.hide(),d.hide())})},getAllShortEmployees:function(){var a=this;g.api({url:"/Employee/GetAllShortEmployees",type:"get",dataType:"json",data:{},success:function(b){var c=b.value;b.success&&(_.each(c,function(a){a.id=a.employeeID}),a.allEmployeesData=c,a.modifyEmployeesDialog())}})},getAllCircleInfos:function(){var a=this;g.api({url:"/Employee/GetAllCircleInfos",type:"get",dataType:"json",data:{},success:function(b){b.success&&(a.allCircleData=b.value,a.modifyCircleDialog())}})},renderEmployeesDialog:function(){this.employeesDialog=new k({unjoinLabel:"未选员工",joinLabel:"已选员工",unit:"项",bbarUnit:"个员工",inputPlaceholder:"输入关键词，快速筛选员工",unjoinEmptyTip:"没有未选员工",unjoinSearchEmptyTip:"没有筛选条件为{{keyword}}的员工",joinEmptyTip:"没有已选员工",joinSearchEmptyTip:"没有筛选条件为{{keyword}}的员工"}).render(),this.employeesDialog.setTitle("选择员工"),this.employeesJoinData=[]},renderCircleDialog:function(){this.circleDialog=new k({unjoinLabel:"未选部门",joinLabel:"已选部门",unit:"项",bbarUnit:"部门",inputPlaceholder:"输入关键词，快速筛选部门",unjoinEmptyTip:"没有未选部门",unjoinSearchEmptyTip:"没有筛选条件为{{keyword}}的部门",joinEmptyTip:"没有已选部门",joinSearchEmptyTip:"没有筛选条件为{{keyword}}的部门"}).render(),this.circleDialog.setTitle("选择部门"),this.circleJoinData=[]},modifyEmployeesDialog:function(){var a=this,b=this.employeesDialog,c=a.employeesJoinData,d=[];_.each(c,function(a){d.push(a.id)});var e=g.excludeDataByKey(d,"id",a.allEmployeesData);b.setInitData({joinData:c,unjoinData:e}),b.show(),b.set("successCb",function(b){a.employeesJoinData=b,this.hide(),a.showEmployeesDom()})},modifyCircleDialog:function(){var a=this,b=this.circleDialog,c=a.circleJoinData,d=[];_.each(c,function(a){d.push(a.id)});var e=g.excludeDataByKey(d,"id",a.allCircleData);e=_.reject(e,function(a){return a.isStop}),b.setInitData({joinData:c,unjoinData:e}),b.show(),b.set("successCb",function(c){a.circleJoinData=c,b.hide(),a.showCircleDom()})},showEmployeesDom:function(){var a=this.element,b=$(".j-employees-warp",a),c=$(".circle-warp",b),d=$(".j-select-clear",b),e=this.employeesJoinData,f="";$.each(e,function(a,b){f+='<dd data-id="'+b.id+'" data-type="p">'+b.name+"<b> ×</b></dd>"}),c.html(f).show(),d.show()},showCircleDom:function(){var a=this.element,b=$(".j-circle-warp",a),c=$(".circle-warp",b),d=$(".j-select-clear",b),e=this.circleJoinData,f="";$.each(e,function(a,b){f+='<dd data-id="'+b.id+'" data-type="c">'+b.name+"<b> ×</b></dd>"}),c.html(f).show(),d.show()},isValid:function(){var a=this.starttimeDs,b=this.endtimeDs,c=a.getValue(!0),d=b.getValue(!0);return c?d?c.unix()>d.unix()?(g.alert("请选择发送的结束时间大于开始时间"),!1):!0:(g.showInputError($("input",b.element)),!1):(g.showInputError($("input",a.element)),!1)},getLocationResultExcel:function(){var a=this.element,b=$(".locationmanages-downbtn",a),c=$(".j-locationmanages-checkbox",a),e=c.prop("checked"),f="",h="",i=/,$/gi,j=this.starttimeDs,k=this.endtimeDs,l=j.getValue(!0),m=k.getValue(!0);l=l?l.unix():0,m=m?m.add("days",1).subtract("seconds",1).unix():0,$.each(this.circleJoinData,function(a,b){f+=""+b.id+","}),$.each(this.employeesJoinData,function(a,b){h+=""+b.id+","}),this.isValid()&&g.api({url:"/Location/GetLocationResultExcel",type:"get",dataType:"json",data:{circleIDs:f.replace(i,""),employeeIDs:h.replace(i,""),startTime:l,endTime:m,isExportContent:e},beforeSend:function(){b.show().addClass("loading").html("正在生成报表，请稍后...")},success:function(a){a.success?b.attr("href",d.API_PATH+"/df/gettemp1?id="+a.value+"&name=定位统计报表.xls&bussinessType=1").removeClass("loading").html("生成完毕，点击下载报表"):b.hide()}},{modal:$(".j-submit-btn",a)})},destroy:function(){}}),new r({element:a});var s=new m({defaultRequestData:function(){return{functionNo:7}},successCb:function(a){a.success}});f.one("switched",function(a){a==c&&s.show()})}});