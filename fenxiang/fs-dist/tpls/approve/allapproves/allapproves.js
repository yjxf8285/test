/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("tpls/approve/allapproves/allapproves",["util","dialog","modules/feed-list/feed-list","modules/publish/publish","../approve-common","moment","../approve-common.css","../approve-common.html"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=(e.store,e.event),g=a("util"),h=(a("dialog"),a("modules/feed-list/feed-list")),i=a("modules/publish/publish"),j=a("../approve-common"),k=i.dateSelect,l=i.selectBar,m=i.SearchInput,n=j.AllApproveValid,o=j.MonthWorkDialog,p=j.CompDialog,q=g.getContactData();b.init=function(){var a=b.tplEl,c=b.tplName,d=$(".feed-list",a),i=$(".search-bar",a),r=$(".feed-list-pagination",a),s=$(".tpl-filter",a),t=$(".approve-type",s),u=$(".query",s),v=$(".send-field",s),w=$(".start-date",v),x=$(".end-date",v),y=$(".approve-field",s),z=$(".start-date",y),A=$(".end-date",y),B=$(".range-sb",s),C=$(".sys-no",s),D=$(".f-sub",s),E=$(".export-month-l",a),F=$(".export-approve-l",a);j.init(a,c);var G=new k({element:w,placeholder:"选择日期"}),H=new k({element:x,placeholder:"选择日期"}),I=new k({element:z,placeholder:"选择日期"}),J=new k({element:A,placeholder:"选择日期"}),K=new l({element:B,data:[{title:"同事",type:"p",list:q.p},{title:"部门",type:"g",list:q.g}],title:"请选择同事范围",acInitData:g.getPublishRange(),autoCompleteTitle:"请输入姓名或拼音"}),L=new m({element:u});s.on("click",".clear-h",function(a){var b=$(this),c=b.closest(".f-field");c.hasClass("send-field")&&(G.clear(),H.clear()),c.hasClass("approve-field")&&(I.clear(),J.clear()),c.hasClass("sys-no-field")&&C.val(""),a.preventDefault()}).on("click",".approve-type",function(a){t.removeClass("depw-tabs-aon"),$(this).addClass("depw-tabs-aon"),a.preventDefault()}),D.click(function(){M()&&(Q.pagination.reset(),Q.reload())}),i.on("click",".return-back-l",function(a){P(),i.hide(),Q.reload(),a.preventDefault()});var M=function(){var a=_.str.trim(C.val());return a.length>0&&isNaN(parseInt(a))?(g.alert("请输入合法的系统编号"),!1):!0},N=function(){var a=t.filter(".depw-tabs-aon").attr("approvetype"),b=K.getSelectedData(),c=G.getValue(!0),d=H.getValue(!0),e=I.getValue(!0),f=J.getValue(!0),h=g.getTplQueryParams(),i=h?h.atype:0;return i=parseInt(i),1==i&&(a=2),{feedId:parseInt(_.str.trim(C.val()))||0,approveType:a,circleIds:(b.g||[]).join(","),employeeIds:(b.p||[]).join(","),sendApprovalBeginTime:c?c.unix():0,sendApprovalEndTime:d?d.add("days",1).subtract("seconds",1).unix():0,replyApprovalBeginTime:e?e.unix():0,replyApprovalEndTime:f?f.add("days",1).subtract("seconds",1).unix():0,keyword:L.getValue()}},O=function(a){return 0==a.circleIds.length&&0==a.employeeIds.length&&0==a.sendApprovalBeginTime&&0==a.sendApprovalEndTime&&0==a.replyApprovalBeginTime&&0==a.replyApprovalEndTime&&0==a.keyword.length?!1:!0},P=function(){K.removeAllItem(),t.removeClass("depw-tabs-aon").eq(0).addClass("depw-tabs-aon"),L.clear(),$(".clear-h",s).click(),Q.empty(),Q.pagination.hide()},Q=new h({element:d,pagSelector:r,pagOpts:{pageSize:20,visiblePageNums:7},listPath:"/FeedApprove/GetApprovalsForApproveManagement",defaultRequestData:function(){return N()},listSuccessCb:function(a,b){var c;a.success&&(c=a.value.totalCount,$(".result-num",i).text(c),O(b)?i.show():i.hide())},listEmptyText:"没有审批"}),R=!0,S=new n({successCb:function(a){a.success&&(R?(Q.load(),R=!1):Q.reload())}}),T=new o;E.click(function(a){T.show(),a.preventDefault()});var U=new p;F.click(function(a){U.show(),a.preventDefault()}),f.on("switched",function(a,b){if(a==c){var d,f=g.getTplQueryParams(),h=f?f.atype:0;h=parseInt(h),0==h?($(".staffing-title",b).hide(),$(".finance-title",b).show(),$(".approve-type-field",b).show(),$(".export-approve-field",b).show(),S.set("defaultRequestData",function(){return{functionNo:3}})):1==h&&($(".staffing-title",b).show(),$(".finance-title",b).hide(),$(".approve-type-field",b).hide(),$(".export-approve-field",b).hide(),S.set("defaultRequestData",function(){return{functionNo:4}})),d=q.u.functionPermissions,_.some(d,function(a){return 3==a.value})?e.navRouter.navigate("#approve/allapproves/=/atype-0",{trigger:!0}):_.some(d,function(a){return 4==a.value})?e.navRouter.navigate("#approve/allapproves/=/atype-1",{trigger:!0}):e.navRouter.navigate("#stream",{trigger:!0}),S.show()}else P()})}});