/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("tpls/employeemgtformarketing/employeemgtformarketing",["util","dialog","events","uilibs/pagination"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=(e.store,e.event),g=a("util"),h=a("dialog"),i=a("events"),j=a("uilibs/pagination"),k=h.extend({attrs:{content:'<div class="ui-dialog-title">重置密码</div><div class="ui-dialog-body"><div class="field-container"><div class="account-field-wrapper f-field fn-clear"><div class="ff-label fn-left">帐号：</div><div class="ff-value fn-left"><input type="text" class="account-field fs-validate-field textfield" inputtip="用户帐号" readonly="readonly" /></div></div><div class="name-field-wrapper f-field fn-clear"><div class="ff-label fn-left">姓名：</div><div class="ff-value fn-left"><input type="text" class="name-field fs-validate-field textfield" inputtip="用户姓名" readonly="readonly" /></div></div><div class="pwd-field-wrapper f-field fn-clear"><div class="ff-label fn-left">密码：</div><div class="ff-value fn-left"><input type="password" class="pwd-field fs-validate-field textfield auto-focus" inputtip="请输入密码" emptytip="请输入初始密码" /></div></div></div><div class="ui-dialog-bbar fn-clear"><div class="bbar-inner fn-right"><button class="f-sub button-submit">保存修改</button>&nbsp;&nbsp;<button class="f-cancel button-cancel">取消</button></div></div></div>',className:"department-tree-reset-pwd department-tree-dialog fs-validate",width:500,data:null,successCb:d.EMPTY_FN},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel"},render:function(){var a=k.superclass.render.apply(this,arguments);return a},clear:function(){var a=this.element,b=$(".name-field",a),c=$(".account-field",a),d=$(".pwd-field",a);b.val(""),c.val(""),d.val("")},isValid:function(){var a=!0,b=this.getRequestData();return 0==b.newPassword.length?!1:a},getRequestData:function(){var a={},b=this.get("data"),c=this.element,d=$(".pwd-field",c);return a.newPassword=_.str.trim(d.val()),a.employeeID=b.employeeId,a},_submit:function(a){var b=this,c=$(a.currentTarget),d=this.get("successCb"),e=this.getRequestData();this.isValid()&&g.api({type:"post",data:e,url:"/Management/ChangeEmployeePassword",success:function(a){d&&d.call(b,a,e)}},{submitSelector:c}),a.preventDefault()},setData:function(a){var b=this.element,c=$(".name-field",b),d=$(".account-field",b);c.val(a.name),d.val(a.account),this.set("data",a)},hide:function(){var a=k.superclass.hide.apply(this,arguments);return this.clear(),a},_cancel:function(a){this.hide(),a.preventDefault()},destroy:function(){var a;return a=k.superclass.destroy.apply(this,arguments)}}),l=function(a){a=_.extend({element:null,itemTpl:'<tr class="{{trCls}}"><td class="ck-box first-td"><input class="ck" type="checkbox" /></td><td><img src="'+d.BLANK_IMG+'" class="icon-sex icon-sex-{{sex}}" /><a class="employee-name" href="javascript:;">{{name}}</a></td>'+'<td><a class="account" href="javascript:;">{{account}}</a></td>'+'<td><a class="mobile" href="javascript:;">{{mobile}}</a></td>'+'<td class="last-td"><a class="edit-l action-l" href="javascript:;">编辑</a>&nbsp;&nbsp;<a class="{{validCls}} valid-control-l action-l" href="javascript:;">{{validText}}</a>&nbsp;&nbsp;<a class="change-pwd-l action-l" href="javascript:;">重置密码</a></td>'+"</tr>",listPath:"/Management/GetEmployees",formatData:function(a){return _.extend({trCls:a.isStop?"state-disabled":"",sex:a.gender?a.gender.toLowerCase():"m",validCls:a.isStop?"set-start-l":"set-stop-l",validText:a.isStop?"启用":"停用"},a)}},a||{}),this.element=$(a.element),this.opts=a,this._lastRequestData=null,this._lastListData=null,this.init()};_.extend(l.prototype,{init:function(){this._renderSelf(),this._bindEvents()},_bindEvents:function(){var a=this,b=this.element;b.on("mouseenter","tr",function(){$(this).addClass("state-hover")}).on("mouseleave","tr",function(){$(this).removeClass("state-hover")}).on("click","tr",function(b){var c=$(b.currentTarget),d=$(b.target),e=$(".ck",c);d.is(".ck")||e.prop("checked",!e.prop("checked")).change(),a.trigger("rowclick",b)})},_renderSelf:function(){var a=this.element;a.html('<table class="employeemgtformarketing-employee-list" cellpadding="0" cellspacing="0"><tbody></tbody></table>')},_renderList:function(a){var b=this.opts,c=b.itemTpl,d=b.formatData,e=this.element,f=$("tbody",e),g="";_.each(a,function(a){g+=_.template(c)(d(a))}),0==g.length&&(g+='<tr class="empty-tip"><td>该筛选条件没有找到员工，请更换筛选条件。</td></tr>'),f.html(g)},_fetch:function(a){var b=this,c=this.opts,d=c.listPath;g.api({url:d,data:a,type:"get",success:function(c){c.success&&(b._renderList(c.value.items),b.trigger("fetch",c,a),b._lastRequestData=a,b._lastListData=c.value.items)}})},setOpts:function(a){_.extend(this.opts,a||{})},getItemDataFromSelector:function(a){var b=$(a).index();return this._lastListData[b]},getAllSelectData:function(){var a=this,b=[],c=this.element,d=$(".ck",c).filter(":checked");return d.each(function(){var c=$(this).closest("tr");b.push(a.getItemDataFromSelector(c))}),b},load:function(a){this._fetch(a)},reload:function(){this.load(this._lastRequestData)},empty:function(){var a=this.element,b=$("tbody",a);b.empty()},destroy:function(){this._lastRequestData=null,this._lastListData=null}}),i.mixTo(l),b.init=function(){var a=b.tplEl,c=b.tplName,d=$(".employee-main",a),e=$(".employee-num",d),h=$(".employee-list-wrapper",d),i=$(".filter-list",d),m=$(".first-char-wrapper",d),n=$(".search-box",d),o=$(".pagination-box",a),p=$(".all-ck",d),q=$(".employee-list-action",d),r=$(".employee-edit",a),s=($(".detail-tbar",r),$(".employee-add",a)),t=($(".detail-tbar",s),$(".add-employee-btn",d)),u=20,v=function(){var a={},b=$(".state-active",i),c=$(".state-active",m),d=$(".search-field",n),e=c.attr("filtervalue"),f=b.attr("filtertype"),g=_.str.trim(d.val());return a.selectAll=0==g.length?!0:!1,a.keyword=g,"0"==e?a.isFirstChar=!1:(a.keyword=e,a.isFirstChar=!0,a.selectAll=!1),a.isStop="0"==f?!1:!0,a.pageSize=u,a.pageNumber=1,a},w=function(a){var b=Array.prototype.slice.call(arguments,1);_.each(G,function(c){c[a](b)})},x=function(){var a=!1;$(".ck",F.element).each(function(){return $(this).prop("checked")?(a=!0,!1):void 0}),a?$(".action-btn",q).removeClass("button-state-disabled"):$(".action-btn",q).addClass("button-state-disabled")},y=function(){var a=z();return 0==a.fullName.length||0==a.mobile.length||0==a.account.length||0==a.password.length?!1:!0},z=function(){var a={},b=($(".employee-detail-title",s),$(".detail-info-wrapper .employee-name",s)),c=$(".mobile",s),d=$(".account",s),e=$(".pwd",s);return a.account=_.str.trim(d.val()),a.fullName=_.str.trim(b.val()),a.role=0,a.mobile=_.str.trim(c.val()),a.password=_.str.trim(e.val()),a},A=function(){$('input[type="text"]',s).val(""),$(".sex",s).prop("checked",!1).eq(0).prop("checked",!0),$(".fs-validate-empty-tip,.fs-validate-input-tip",s).hide(),$(".field-state-empty,.field-state-input",s).removeClass("field-state-empty field-state-input")},B=function(){var a=C();return 0==a.fullName.length||0==a.mobile.length||0==a.account.length?!1:!0},C=function(){var a={},b=r.data("employeeData"),c=($(".employee-detail-title",r),$(".detail-info-wrapper .employee-name",r)),d=$(".mobile",r),e=$(".account",r);return a.employeeID=b.employeeID,a.account=_.str.trim(e.val()),a.fullName=_.str.trim(c.val()),a.name=_.str.trim(c.val()),a.department="",a.post=b.post,a.role=b.role,a.mobile=_.str.trim(d.val()),a.gender=b.gender,a},D=function(){$('input[type="text"]',r).val(""),$(".sex",r).prop("checked",!1).eq(0).prop("checked",!0),$(".fs-validate-empty-tip,.fs-validate-input-tip",r).hide(),$(".field-state-empty,.field-state-input",r).removeClass("field-state-empty field-state-input")},E=function(a){var b=$(".detail-info-wrapper .employee-name",r),c=$(".mobile",r),d=$(".account",r);b.val(a.name),c.val(a.mobile),d.val(a.account)},F=new l({element:h}),G=[];o.each(function(){var a=new j({element:this,pageSize:u});a.on("page",function(b){_.each(G,function(c){c!==a&&c.set("activePageNumber",b)}),F.load(_.extend(v(),{pageNumber:b}))}),a.render(),G.push(a)});var H=new k({successCb:function(a){a.success&&this.hide()}});F.on("fetch",function(a){var b;a.success&&(b=a.value,e.text(b.totalCount),p.prop("checked",!1),$(".action-btn",q).addClass("button-state-disabled"),w("setTotalSize",b.totalCount))}),i.on("click",".filter-item",function(a){var b,c=$(a.currentTarget);$(".state-active",i).removeClass("state-active"),c.addClass("state-active"),b=v(),F.load(b),a.preventDefault()}),m.on("click",".first-char-field",function(a){var b=$(a.currentTarget);$(".first-char-field",m).removeClass("state-active"),b.addClass("state-active"),F.load(v()),a.preventDefault()}),p.on("change",function(){var a=p.prop("checked");a?$(".ck",F.element).prop("checked",!0):$(".ck",F.element).prop("checked",!1),x()}),F.element.on("change",".ck",function(){var a=$(".ck",F.element),b=!0;a.each(function(){return $(this).prop("checked")?void 0:b=!1}),p.prop("checked",b),x()}),t.on("click",function(a){A(),s.show(),d.hide(),a.preventDefault()}),s.on("click",".return-back-btn",function(){s.hide(),d.show(),F.load(v())}).on("click",".f-sub",function(a){y()&&g.api({url:"/Management/CreateEmployeeForMarketing",type:"post",data:z(),success:function(a){a.success&&(g.showSucessTip("添加成功"),d.show(),s.hide(),F.load(v()))}},{submitSelector:$(a.currentTarget)})}).on("click",".f-cancel",function(){s.hide(),d.show(),F.load(v())}),F.element.on("click",".edit-l",function(a){var b=$(a.currentTarget),c=b.closest("tr"),e=F.getItemDataFromSelector(c);D(),r.show(),d.hide(),g.api({url:"/Management/GetEmployeeByID",type:"get",data:{employeeId:e.employeeID},success:function(a){var b;a.success&&(b=a.value,E(b))}}),r.data("employeeData",e),a.preventDefault()}).on("click",".change-pwd-l",function(a){var b=$(a.currentTarget),c=b.closest("tr"),d=F.getItemDataFromSelector(c);H.show(),H.setData({employeeId:d.employeeID,name:d.name,account:d.account}),a.preventDefault()}).on("click",".set-stop-l",function(a){var b=$(a.currentTarget),c=b.closest("tr"),d=F.getItemDataFromSelector(c);g.confirm("是否确定要停用该帐号？该操作后可以在“已停用的帐号”中重新启用","提示",function(){g.api({type:"post",data:{employeeId:d.employeeID,isStop:!0},url:"/Management/SetEmployeeStatus",success:function(a){a.success&&F.load(v())}})},{onCancel:function(){}}),a.preventDefault()}).on("click",".set-start-l",function(a){var b=$(a.currentTarget),c=b.closest("tr"),d=F.getItemDataFromSelector(c);g.confirm("是否确定要启用该帐号？","提示",function(){g.api({type:"post",data:{employeeId:d.employeeID,isStop:!1},url:"/Management/SetEmployeeStatus",success:function(a){a.success&&F.load(v())}})},{onCancel:function(){}}),a.preventDefault()}),q.on("click",".action-btn",function(a){var b=$(a.currentTarget),c=F.getAllSelectData(),d=_.map(c,function(a){return a.employeeID}),e=!0;if(b.hasClass("button-state-disabled"))return!1;if(b.hasClass("stop-btn")){if(_.some(c,function(a){return a.isStop?(e=!1,!0):void 0}),!e)return g.alert("没有被停用的用户可以停用，请选择"),!1;g.confirm("您确认要停用"+d.length+"个用户吗？","提示",function(){g.api({type:"post",data:{employeeIDs:d,isStop:!0},url:"/Management/BatchSetEmployeeStatus",success:function(a){a.success&&F.load(v())}})},{onCancel:function(){}})}else if(b.hasClass("start-btn")){if(_.some(c,function(a){return a.isStop?void 0:(e=!1,!0)}),!e)return g.alert("只有停用的用户才可以启用，请选择"),!1;g.confirm("您确认要启用"+d.length+"个用户吗？","提示",function(){g.api({type:"post",data:{employeeIDs:d,isStop:!1},url:"/Management/BatchSetEmployeeStatus",success:function(a){a.success&&F.load(v())}})},{onCancel:function(){}})}else b.hasClass("delete-btn")&&g.confirm("您确认要删除"+d.length+"个用户吗？","提示",function(){g.api({type:"post",data:{employeeIDs:d},url:"/Management/BatchDeleteEmployee",success:function(a){a.success&&F.load(v())}})},{onCancel:function(){}})}),r.on("click",".return-back-btn",function(){r.hide(),d.show(),F.load(v())}).on("click",".f-sub",function(a){B()&&g.api({url:"/Management/ModifyEmployee",type:"post",data:C(),success:function(a){a.success&&(g.showSucessTip("修改成功"),d.show(),s.hide(),F.load(v()))}},{submitSelector:$(a.currentTarget)})}).on("click",".f-cancel",function(){r.hide(),d.show(),F.load(v())}),n.on("click",".icon-search",function(){F.load(v())}).on("keyup",".search-field",function(a){13==a.keyCode&&F.load(v())}),f.on("switched",function(a){var b=g.getTplQueryParams(),e=b?b.create:"";a==c&&("employee"==e?(A(),d.hide(),s.show()):(d.show(),s.hide(),F.load(v())),document.title="员工管理")})}});