/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("tpls/search/search-common",["util","filter","moment","./search-common.html","autocomplete","events"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.event;var f=a("util"),g=a("filter"),h=a("moment"),i=a("./search-common.html"),j=$(i),k=a("autocomplete"),l=a("events"),m=j.filter(".search-sender-ac"),n=g.stringMatch,o=g.startsWith;f.tplRouterReg("#search"),f.tplRouterReg("#search/=/:key-:value"),f.tplRouterReg("#search/images"),f.tplRouterReg("#search/images/=/:key-:value"),f.tplRouterReg("#search/attachs"),f.tplRouterReg("#search/attachs/=/:key-:value"),f.tplRouterReg("#search/audios"),f.tplRouterReg("#search/audios/=/:key-:value"),f.tplRouterReg("#search/colleagues"),f.tplRouterReg("#search/colleagues/=/:key-:value"),f.tplRouterReg("#search/shortmessage"),f.tplRouterReg("#search/shortmessage/=/:key-:value"),b.init=function(a,b){function c(){var a,c=d(),h=e(),i=(r.filter(".depw-menu-aon"),t.filter(".depw-menu-aon")),j=_.extend({senderID:c},h);"search"==b&&_.extend(j,g()),_.isUndefined(c)||_.isUndefined(h.startTime)||_.isUndefined(h.endTime)||(K.trigger("search",j),a="0"==c?"所有人":c==L.id?"我":f.getContactDataById(c,"p").name,I.text("筛选条件："+a+"发出的，"+i.text()))}function d(){var a=r.filter(".depw-menu-aon");return a.data("sendid")}function e(){var a=t.filter(".depw-menu-aon");return{dateTimeType:a.data("dateTimeType"),startTime:a.data("startTime"),endTime:a.data("endTime")}}function g(){var a=$(".depw-menu-aon",C);return{feedAttachType:a.attr("feedattachtype")}}var i,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=$(".tpl-l .tpl-inner",a),E=$(".tpl-c .tpl-inner",a),F=$(".search-btn-s",E),G=$(".search-inp-s",E),H=$(".search-remind",E),I=$(".tip-info",H);f.getTplQueryParams();var J=f.getContactData(),K=new l,L=J.u,M=J.p,N={},O=_.template(j.filter(".search-tpl-left").html());_.extend(N,{userName:L.name,profileImage:L.profileImage}),D.html(O(N)),i=$(".all-employee",D),p=$(".my-send",D),q=$(".custom-employee",D),r=$(".filter-employee a",D),s=$(".custom-send-person",D),t=$(".filter-date a",D),v=$(".custom-data-range",D),w=$(".latest-one-week",D),x=$(".latest-one-month",D),y=$(".latest-three-month",D),z=$(".latest-half-year",D),A=$(".latest-one-year",D),u=$(".custom-date",D),B=$(".date-search-btn",D),C=$(".search-include-nav-list",D);var P=function(){r.removeClass("depw-menu-aon"),r.filter(".all-employee").addClass("depw-menu-aon"),$(".reselect-btn",D).click(),$(".custom-send-person",D).hide(),t.removeClass("depw-menu-aon"),t.filter(".latest-one-week").addClass("depw-menu-aon"),$(".custom-data-range .csp-input",D).val(""),$(".custom-data-range",D).hide(),$("a",C).removeClass("depw-menu-aon").eq(0).addClass("depw-menu-aon")},Q=$(".query-employee",D),R=new k({className:"custom-sender-search-ac",trigger:Q,template:m.html(),delay:0,submitOnEnter:!1,zIndex:100,dataSource:M}).render(),S=R.get("filter");S.func=function(a,b){var c,d,e=[];return c=n.apply(this,[a,b,{key:"name"}]),d=o.apply(this,[a,b.toLowerCase(),{key:"spell"}]),_.each(d,function(a){_.find(c,function(b){return b.id==a.id})||e.push(a)}),e=e.concat(c)},R.set("filter",S),R.on("itemSelect",function(a){Q.text(a.name).prop("disabled",!0),q.data("sendid",a.id),U.prop("disabled",!1),T.prop("disabled",!1)});var T=$(".employee-search-btn",D),U=$(".reselect-btn",D);U.click(function(){Q.val("").prop("disabled",!1).get(0).focus(),q.data("sendid",0),U.prop("disabled",!0),T.prop("disabled",!0)}),T.click(function(){c(),H.show()}),i.data("sendid",0),p.data("sendid",L.id),r.click(function(a){var b=$(this);r.removeClass("depw-menu-aon"),b.addClass("depw-menu-aon"),b.hasClass("custom-employee")?s.show():(q.data("sendid",0),s.hide(),c(),H.show()),a.preventDefault()});var V=h(),W=V.unix();return w.data({dateTimeType:1,startTime:V.subtract("weeks",1).unix(),endTime:W}),x.data({dateTimeType:2,startTime:V.subtract("months",1).unix(),endTime:W}),y.data({dateTimeType:3,startTime:V.subtract("months",3).unix(),endTime:W}),z.data({dateTimeType:4,startTime:V.subtract("years",.5).unix(),endTime:W}),A.data({dateTimeType:5,startTime:V.subtract("years",1).unix(),endTime:W}),u.data({dateTimeType:6}),t.click(function(a){var b=$(this);t.removeClass("depw-menu-aon"),b.addClass("depw-menu-aon"),b.hasClass("custom-date")?v.show():(v.hide(),c(),H.show()),a.preventDefault()}),B.click(function(){var a,b,d=$(".start-date",D),e=$(".end-date",D),g=_.str.trim(d.val()),i=_.str.trim(e.val());g.length>0&&i.length>0?/^((?:19|20)\d\d)-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])$/.test(g)&&/^((?:19|20)\d\d)-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])$/.test(i)?(a=h(g,"YYYY-MM-DD"),b=h(i,"YYYY-MM-DD"),u.data({startTime:a.unix(),endTime:b.unix()}),c(),H.show()):f.alert("请输入有效的时间格式"):f.alert("自定义时间不能为空")}),C.on("click","a",function(a){var b=$(this);$("a",C).removeClass("depw-menu-aon"),b.addClass("depw-menu-aon"),c(),H.show(),a.preventDefault()}),F.click(function(){c()}),H.on("click",".sr-close",function(a){H.hide(),P(),c(),a.preventDefault()}),G.keyup(function(a){var b=_.str.trim(G.val());$(".tpl-nav-l",D).each(function(){var a=$(this),c=a.data("originhref");c||(c=a.attr("href"),a.data("originhref",c)),b.length>0?a.attr("href",c+"/=/key-"+b):a.attr("href",c)}),13==a.keyCode&&(c(),H.show())}).on("mouseenter",function(){$(this).addClass("state-mouse-over")}).on("mouseleave",function(){$(this).removeClass("state-mouse-over")}),K}});