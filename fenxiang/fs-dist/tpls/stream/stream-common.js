/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("tpls/stream/stream-common",["util","dialog","./stream-common.html"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.event;var f=a("util"),g=a("dialog"),h=a("./stream-common.html"),i=$(h),j=i.filter(".invite-apv-tpl"),k='手机或邮箱：<input type="text" class="invite-inp" /><span class="invite-inp-cerror" style="display:none;">格式错误</span>',l=g.extend({attrs:{width:"500px",className:"invite-apv-dialog",list:null,content:j.html()},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel","click .invite-amore-add":"_addField","focus .invite-inp":"_inputFocus","blur .invite-inp":"_inputBlur"},_addField:function(){var a=this.element,b=$(".invite-item",a);b.last().after("<div class='invite-item'>"+k+"</div>")},_inputFocus:function(a){var b=this.element,c=$(a.target),d=$(".invite-inp",b);d.removeClass("invite-inp-on"),c.addClass("invite-inp-on"),c.removeClass("invite-inp-onerror"),c.next().hide()},_inputBlur:function(a){var b=this.element,c=$(a.target),d=$(".invite-inp",b);d.removeClass("invite-inp-on");var e=/^(13[0-9]|15[0-9]|18[0-9])|14[7]\d{8}$/,f=/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/,g=_.str.trim(c.val());g.length>0&&(e.test(g)||f.test(g)||(c.addClass("invite-inp-onerror"),c.next().show()))},show:function(){var a=l.superclass.show.apply(this,arguments);return a},hide:function(){var a=l.superclass.hide.apply(this,arguments);return this._clear(),a},getRequestData:function(){var a=this.element,b=$(".invite-inp",a),c=[];return b.each(function(){var a=$(this),b=_.str.trim(a.val());b.length>0&&c.push({mobileOrEMail:b})}),c},isValid:function(){var a=this.element,b=!0,c=$(".invite-inp",a),d=/^(13[0-9]|15[0-9]|18[0-9])|14[7]\d{8}$/,e=/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/;c.val();var g=this.getRequestData();return 0==g.length?(f.alert("请输入需要邀请的员工的手机或邮箱。"),!1):(c.each(function(){var a=_.str.trim($(this).val());return a.length>0&&!d.test(a)&&!e.test(a)?(f.alert("手机或邮箱格式不正确。"),b=!1,!1):void 0}),b)},_clear:function(){var a=this.element,b=$(".invite-inp",a),c=$(".invite-item",a);b.removeClass("invite-inp-onerror"),b.next().hide(),b.val(""),c.slice(3).remove()},_submit:function(a){var b=this,c=$(a.target),d=this.getRequestData();this.isValid()&&d.length>0&&f.confirm("本次邀请"+d.length+"个用户","提示",function(){f.api({data:d,url:"/GlobalInfo/InviteEmployees",success:function(a){a.success&&b.hide()}},{submitSelector:c})},{onCancel:function(){return!1},messageType:"",width:380})},_cancel:function(){this.hide()}});b.InviteColleague=l;var m=!0,n=!0;b.init=function(a){var b=$(".tpl-l .tpl-inner",a),c=f.getContactData(),g=c.u,h=g.groupIDs,j=c.g,k=c.p,l={},o=[],p=_.template(i.filter(".stream-tpl-left").html());_.extend(l,{userName:g.name,profileImage:g.profileImage}),_.each(h,function(a){var b=_.find(j,function(b){return b.id==a});b&&o.push({groupName:b.name,groupID:b.id,cTitle:encodeURIComponent(b.name)})}),l.groups=o,l.allCompanyDefaultString=g.allCompanyDefaultString,b.html(p(l)),g.isAdmin&&!g.isDemoAccount&&0==o.length&&k.length>=5&&m&&f.showGuideTip($(".group-list",b),{leftLeftIncrement:0,rightLeftIncrement:-14,imageName:"stream-menu.png",imagePosition:{top:"-90px",left:"20px"},renderCb:function(a,b,c,e){var f=$('<div class="fs-guide-shadow-link"></div>'),h=$('<div class="fs-guide-shadow-link"></div>'),i=function(){b.remove(),c.remove(),$(".fs-guide-group-bracket").remove(),m=!1,$(".fs-guide-send-receipt-bracket").css("visibility","visible")};$(".fs-guide-send-receipt-bracket,.fs-guide-history-plan-bracket").css("visibility","hidden"),b.addClass("fs-guide-group-bracket"),c.addClass("fs-guide-group-bracket"),f.css({width:"26px",height:"26px",position:"absolute",top:"8px",left:"240px",cursor:"pointer"}).appendTo(a),h.css({width:"158px",height:"32px",position:"absolute",top:"124px",left:"83px",cursor:"pointer"}).appendTo(a),f.click(function(){i()}),h.click(function(){window.open(d.BASE_PATH+"/h/home/admin?enterprise="+g.enterpriseAccount+"&account="+g.account+"&showcircleguide=yes")}),e.click(function(){i()})}}),!g.isDemoAccount&&0==g.profileImagePath.length&&n&&f.showGuideTip($(".head-img-wrap",b),{leftLeftIncrement:0,rightLeftIncrement:-14,imageName:"avatar.png",imagePosition:{top:"-34px",left:"20px"},renderCb:function(a,b,c){var d=$('<div class="fs-guide-shadow-link"></div>'),f=$('<div class="fs-guide-shadow-link"></div>'),g=function(){b.remove(),c.remove(),$(".fs-guide-avatar-bracket").remove(),n=!1,$(".fs-guide-group-bracket").css("visibility","visible")};b.addClass("fs-guide-avatar-bracket"),c.addClass("fs-guide-avatar-bracket"),$(".fs-guide-group-bracket,.fs-guide-send-receipt-bracket,.fs-guide-history-plan-bracket").css("visibility","hidden"),d.css({width:"26px",height:"26px",position:"absolute",top:"16px",left:"200px",cursor:"pointer"}).appendTo(a),f.css({width:"140px",height:"32px",position:"absolute",top:"115px",left:"68px",cursor:"pointer"}).appendTo(a),d.click(function(){g()}),f.click(function(){e.navRouter.navigate("#settings/avatarsetting",{trigger:!0}),g()})}});var q=$(".group-list",b),r=$(".fni-dep-con",q),s=$(".left-deplist-tpl",b),t=$(".deplist-control",s);r.length>5?(r.hide(),r.slice(0,5).show(),s.show(),s.click(function(){"展开"==t.html()?(r.show(),t.html("收起")):(r.slice(5,r.length).hide(),t.html("展开"))})):(r.show(),s.hide());var u=$(".online-status-wrap",b),v=$(".online-status-drop",u),w=$(".online-status-text",u),x=$(".online-status-list",u);f.placeholder(w),u.on("mouseenter",function(){u.addClass("online-status-border")}).on("mouseleave",function(){x.is(":hidden")&&u.removeClass("online-status-border")}),v.on("click",function(a){x.toggle(),a.stopPropagation()}),x.find("a").click(function(){var a=$(this).html();w.val(a),w.attr("title",a),x.hide(),w.blur()}),f.regGlobalClick(x);var y=g.workingState||"忙碌中，请勿打扰";w.val(y).attr("title",y).blur(function(){var a=$(this).val();a!=y&&(f.api({type:"post",data:{workingState:a},url:"/Account/UpdateWorkingState",success:function(a){a.success}}),y=a,""==w.val()?w.attr("title","请输入工作状态"):w.attr("title",y))}),f.regTplNav($(".tpl-nav-lb",b)),f.tplRouterReg("#department/=/:cid-:value/:ctitle-:value"),f.tplRouterReg($(".tpl-nav-lb",b))}});