/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("tpls/stream/archivetag/archivetag",["tabs","util","modules/feed-list/feed-list","../stream-common","dialog","../stream-common.html"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=e.event,g=a("tabs"),h=a("util"),i=a("modules/feed-list/feed-list"),j=a("../stream-common");b.init=function(){var a,c=b.tplEl,d=b.tplName,e=$(".feed-tabs",c),k=$(".search-inp",c),l=$(".search-btn",c),m=$(".tag-filter-result",c),n=$(".right-archive-list-wrap",c),o=$(".tag-item-tpl",c),p=_.template(o.html()),q=function(a){var b=$(a),c=b.data("feedList");c&&c.loadKill()},r=function(a){0==a.get("activeIndex")?a.trigger("switched",0,-1):a.switchTo(0)},s=null;j.init(c,d),a=new g({element:e,triggers:$(".ui-tab-item",e),panels:$(".ui-tab-panel",e),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click"}).render(),a.on("switched",function(a){var b=this.get("panels").eq(a),c=$(".feed-list",b),d=$(".feed-list-pagination",b),e=b.data("feedList"),f=b.attr("feedtype");e?e.reload():(e=new i({element:c,pagSelector:d,pagOpts:{pageSize:45,visiblePageNums:7},withArchive:!0,loadSize:15,listPath:"/feedarchive/GetFeedsByArchiveTagID",defaultRequestData:function(){var a=$(".state-active",n).attr("tagid");return{feedArchiveTagID:a||0,feedType:f,keyword:_.str.trim(k.val())}},beforeListParse:function(a){return a},searchOpts:{inputSelector:k,btnSelector:l},listEmptyText:"还没有本类归档内容"}),e.load(),b.data("feedList",e)),s=e}).on("switch",function(a,b){q(this.get("panels").eq(b))}),l.click(function(a){s.reload(),a.preventDefault()});var t=function(){var b=a.get("panels");b.each(function(){var a=$(this),b=a.data("feedList");b&&b.destroy(),a.removeData()})};f.one("beforeremove",function(a){a==d&&t()}),r(a),h.api({type:"get",data:{},url:"/feedarchive/getMyFeedArchiveTags",success:function(a){var b="";if(a.success){var c=a.value;_.each(c,function(a){var c=a.tagName,d=a.count,e=a.feedArchiveTagID;b+=p({tagName:c,tagId:e,count:d})}),n.html(b)}}});var u=function(a,b){var c=$(b),d=$(".tag-edit-panel",c),e=$(".tag-show-panel",c);switch(a=a||"show"){case"show":d.hide(),e.show();break;case"edit":d.show(),e.hide(),$(".right-archive-text",d).val($(".tag-name",e).text())}};n.on("mouseenter",".right-archive-item",function(){var a=$(this),b=$(".right-archive-control",a);b.show()}).on("mouseleave",".right-archive-item",function(){var a=$(this),b=$(".right-archive-control",a);b.hide()}).on("click",".right-ac-edit",function(a){var b=$(this),c=b.closest(".right-archive-item"),d=$(".tag-edit-panel",c),e=$(".tag-show-panel",c);u("edit",c),$(".right-archive-text",d).val($(".tag-name",e).text()),a.preventDefault()}).on("click",".rarchive-btn-save",function(){var b=$(this),c=b.closest(".right-archive-item"),d=c.attr("tagid"),e=$(".tag-edit-panel",c),f=$(".tag-show-panel",c),g=$(".tag-name",f),i=_.str.trim($(".right-archive-text",e).val());h.api({url:"/feedarchive/modifyFeedArchiveTagName",data:{tagName:i,feedArchiveTagID:d},dataType:"json",success:function(b){b.success&&(g.text(i),u("show",c),r(a))}})}).on("click",".right-ac-del",function(){var a=$(this),b=a.closest(".right-archive-item"),c=b.attr("tagid");h.confirm("如果归档没有标签标识，归档也将被一起删除","你确定要删除这个标签吗？",function(){h.api({url:"/feedarchive/deleteFeedArchiveTag",data:{feedArchiveTagID:c},type:"post",success:function(a){a.success&&(b.remove(),s.reload())}})},{onCancel:function(){return!1},messageType:"question",width:380})}).on("click",".rarchive-btn-cancel",function(){var a=$(this),b=a.closest(".right-archive-item");u("show",b)}).on("click",".tag-name",function(b){var c=$(this),d=c.closest(".right-archive-item"),e=$(".right-archive-item",n);e.removeClass("state-active"),d.addClass("state-active"),$(".tag-name",m).text(c.text()),m.show(),r(a),b.preventDefault()}),e.on("click",".archive-remind .ar-tip",function(){var a=_.str.trim($(this).text());$(".tag-name",n).each(function(){var b=$(this);return _.str.trim(b.text())==a?(b.click(),!1):void 0})}),m.on("click",".to-back-all-l",function(b){$(".right-archive-item",n).removeClass("state-active"),$(".tag-name",m).text(""),m.hide(),r(a),b.preventDefault()})}});