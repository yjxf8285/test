/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("tpls/stream/showtopic/showtopic",["util","modules/fs-topic/fs-topic","../stream-common","dialog","../stream-common.html","../stream","moment","json","events","uilibs/tabs","modules/publish/publish","modules/fs-schedule/fs-schedule","validator","store","modules/feed-list/feed-list","modules/fs-announcement/fs-announcement","modules/fs-worktodo/fs-worktodo"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=e.event,g=a("util"),h=a("modules/fs-topic/fs-topic"),i=a("../stream-common"),j=a("../stream"),k=j.Stream,l=h.TopicEditDialog,m=h.TopicDescDialog,n=g.getContactData(),o=n.u;b.init=function(){var a,c=b.tplEl,d=b.tplName,e=$(".topic-num",c),h=$(".topic-name",c),j=$(".follow-btn",c),n=$(".cancel-follow",c),p=$(".cancel-follow-l",c),q=$(".publish-input",c),r=$(".ksfw .selectbar",c),s=$(".topic-type-r",c),t=$(".topic-desc",c),u=$(".topic-setting-l",c),v=$(".topic-desc-edit-l",c),w=$(".publish-tip",c),x=new l({successCb:function(a,b){var c,d,e=[];a.success&&(c=b.circleIDs,d=b.isOpen?"1":"0","1"==d?(_.each(c,function(a){e.push(g.getContactDataById(a,"g").name)}),s.html("范围性话题，范围："+e.join("，"))):s.html("普通话题"))}}).render(),y=new m({successCb:function(a,b){a.success&&t.html(b.description)}}).render(),z=new k({tplEl:c,tplName:d,autoInit:!1,feedListPath:"/Topic/GetFeedsByTopicID",refreshAfterPublish:!1,applyFeedlistRd:function(a){var b=g.getTplQueryParams(),c=b?b.id:0,d=b?b.name:"";return c?(a.opts.listPath="/Topic/GetFeedsByTopicID",{topicID:c}):d.length>0?(a.opts.listPath="/Topic/GetFeedsByTopicName",{topicName:d}):void 0},beforeFeedListParse:function(b){var c,d,f,g=[],i=[],k=r.data("sb");return b.success&&(c=b.value,d=c.topic,d&&(1==d.isOpen?(f=d.circles,d.isPublic?(g.push("全公司"),k.addItem({type:"g",name:"全公司",id:"999999"}),i.push({type:"g",name:"全公司",id:"999999"})):_.each(f,function(a){g.push(a.name)}),g="范围性话题，范围："+g.join("，"),_.each(f,function(a){var b={type:"g",name:a.name,id:a.id};k.addItem(b),i.push(b)})):g="普通话题",s.html(g),t.html(d.description||""),y.set("topicId",d.topicID),y.set("defaultDesc",d.description||""),x.set("defaultSbData",i),x.set("topicType",d.isOpen?"1":"0"),x.set("topicId",d.topicID),a=i,h.text(d.name),q.val("#"+d.name+"#").trigger("autosize.resize"),e.text(d.count),d.isFollow?(j.hide(),n.show()):(j.show(),n.hide()),z.topicData=d)),{success:b.success,isAuthorized:b.isAuthorized,statusCode:b.statusCode,serviceTime:b.serviceTime,value:b.value?b.value.feeds||b.value:void 0}},publishCb:function(a,b){var c=r.data("sb"),d=z.topicData,e=b.circleIDs;q.val("#"+d.name+"#"),_.each(e,function(a){var b=g.getContactDataById(a,"g"),d={type:"g",name:b.name,id:b.id};c.addItem(d)})},feedlistConfig:{withFeedRemind:!1,listEmptyText:"该话题下没有您可见的信息",withLazyload:!1}}),A=function(){var a=r.data("sb");q.val(""),t.html(""),y.set("defaultDesc",""),a.removeAllItem(),x.set("defaultSbData",[])};j.click(function(){var a=g.getTplQueryParams(),b=a?a.id:0;b||(b=z.topicData.topicID),g.api({type:"post",data:{flag:!0,id:parseInt(b)},url:"/Topic/FollowTopic",success:function(a){a.success&&(j.hide(),n.show())}})}),p.click(function(a){var b=g.getTplQueryParams(),c=b?b.id:0;c||(c=z.topicData.topicID),g.api({type:"post",data:{flag:!1,id:parseInt(c)},url:"/Topic/FollowTopic",success:function(a){a.success&&(j.show(),n.hide())}}),a.preventDefault()}),_.some(o.functionPermissions,function(a){return 2==a.value})?(u.show(),v.show()):(u.hide(),v.hide()),c.on("click",".topic-setting-l",function(b){var c=z.topicData;x.show(),c&&!x._hasChanged&&(x.sb.removeAllItem(),c.isPublic&&x.sb.addItem({type:"g",id:"999999",name:"全公司"}),_.each(a,function(a){x.sb.addItem(a)}),x.set("topicType",c.isOpen?"1":"0"),x.set("topicId",c.topicID)),b.preventDefault()}).on("click",".topic-desc-edit-l",function(a){var b=z.topicData;y.show(),b&&$(".topic-desc-input",y.element).val(t.text()).trigger("autosize.resize"),a.preventDefault()}),q.keyup(function(){var a=_.str.trim($(this).val());/#[^\n]+?#/g.test(a)?w.slideDown(200):w.slideUp(200)}),z.dataInit(),z.atInputInit(),z.shareInit(),z.feedInit(),i.init(c,d),f.on("switched",function(a,b){a==d?$('[href="#stream/mytopics"]',b).addClass("depw-menu-aon"):A()});var B=$(".right-fixedtopics-wrap",c),C=$(".right-followtopics-wrap",c),D=$(".right-newtopics-wrap",c),E=$(".right-mosttopics-wrap",c),F=function(){g.api({type:"get",data:{},url:"/Topic/GetTopicList",success:function(a){if(a.success){var b;b=a.value.fixedTopics,b.length>5&&(b=b.slice(0,5)),b.length<1?$(".fixedtopics-wrapper").hide():$(".fixedtopics-wrapper").show(),B.empty(),_.each(b,function(a){var b,c=a.topicID;b="<li><a href='#stream/showtopic/=/id-"+c+"' class='fna-blue'>#"+a.name+"#</a><span class='rfl-li-apv color-999999'>"+a.count+"</span></li>",B.append(b)});var c;c=a.value.followTopics,c.length>5&&(c=c.slice(0,5)),c.length<1?$(".followtopics-wrapper").hide():$(".followtopics-wrapper").show(),C.empty(),_.each(c,function(a){var b,c=a.topicID;b="<li><a href='#stream/showtopic/=/id-"+c+"' class='fna-blue'>#"+a.name+"#</a><span class='rfl-li-apv color-999999'>"+a.count+"</span></li>",C.append(b)});var d;d=a.value.newTopics,d.length>5&&(d=d.slice(0,5)),d.length<1?$(".newtopics-wrapper").hide():$(".newtopics-wrapper").show(),D.empty(),_.each(d,function(a){var b,c=a.topicID;b="<li><a href='#stream/showtopic/=/id-"+c+"' class='fna-blue'>#"+a.name+"#</a><span class='rfl-li-apv color-999999'>"+a.count+"</span></li>",D.append(b)});var e;e=a.value.mostTopics,e.length>5&&(e=e.slice(0,5)),e.length<1?$(".mosttopics-wrapper").hide():$(".mosttopics-wrapper").show(),E.empty(),_.each(e,function(a){var b=a.topicID;rightMostTopicsHtml="<li><a href='#stream/showtopic/=/id-"+b+"' class='fna-blue'>#"+a.name+"#</a><span class='rfl-li-apv color-999999'>"+a.count+"</span></li>",E.append(rightMostTopicsHtml)})}}})};F()}});