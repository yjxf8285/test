/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("tpls/stream/stream",["util","moment","json","events","uilibs/tabs","dialog","modules/publish/publish","modules/fs-schedule/fs-schedule","validator","store","./stream-common","./stream-common.html","modules/feed-list/feed-list","modules/fs-announcement/fs-announcement","modules/fs-worktodo/fs-worktodo"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=a("util"),g=a("moment"),h=a("json"),i=a("events"),j=a("uilibs/tabs"),k=(a("dialog"),a("modules/publish/publish.js")),l=a("modules/fs-schedule/fs-schedule"),m=a("validator"),n=a("store"),o=a("./stream-common"),p=a("modules/feed-list/feed-list"),q=a("modules/fs-announcement/fs-announcement"),r=a("modules/fs-worktodo/fs-worktodo"),s=k.atInput,t=k.mediaMaker,u=k.selectBar,v=k.dateSelect,w=k.timeSelect,x=k.Receipt,y=k.MyHistoryPlan,z=q.NewNoticeDialog,A=q.NoticeBanner,B=r.NewWorktodoDialog,C=o.InviteColleague,D=function(a){a=_.extend({tplEl:null,tplName:"",autoInit:!0,feedListPath:"/Feed/GetFeeds",applyFeedlistRd:{},beforeFeedListParse:function(a){return a},feedListSuccessCb:d.EMPTY_FN,feedlistConfig:{}},a||{}),this.opts=a,this.tplEl=a.tplEl||b.tplEl,this.tplName=a.tplName||b.tplName,a.autoInit&&this.init()};_.extend(D.prototype,{init:function(){this.dataInit(),this.publishInit(),this.feedInit(),this.rightSideBarInit(),this.otherInit()},dataInit:function(){var a=f.getContactData();this.contactPersonData=a.p,this.contactGroupData=a.g,this.currentUserData=a.u},atInputInit:function(){var a=this,b=$(".publish-wrapper",this.tplEl),c=$(".publish-input",b);new s({element:c}),c.keydown(function(a){27==a.keyCode&&a.preventDefault()}),e.event.on("switched",function(b){b==a.tplName&&c.trigger("autosize.resize")})},publishInit:function(){var a,b=this,c=$(".publish-wrapper",this.tplEl),d=$(".publish-input",c),e=$(".media-share",c),g=f.getEnterpriseConfig(107,!0)||{};this.atInputInit(),a=new t({element:e,action:["h5imgupload","h5attachupload","vote","at","topic"],actionOpts:{vote:{contactData:this.contactPersonData},at:{inputSelector:d},topic:{inputSelector:d},h5imgupload:{flashFallback:!0},h5attachupload:{flashFallback:!0}}});var h=new j({element:c,triggers:$(".fs-publish-nav",c),panels:$(".fs-publish-panel",c),activeTriggerClass:"ui-tab-item-current",activeIndex:0,triggerType:"click",withTabEffect:!0,triggerBgTop:"5px",triggerBgCls:"publish-tab-trigger-wrapper"}).render();$(".media",h.get("panels")).data("media",a),c.on("click",".panel-visible-h",function(){var a=$(this),c=a.closest(".fs-publish-panel"),d=$(".fs-publish-form",c),e=$(".form-thumb",c);d.hide(),e.show(),a.hide(),b.trigger("publishhide",c)}).on("click",".ui-tab-item-current a",function(a){var b=h.get("panels").eq(h.get("activeIndex")),c=$(".form-thumb",b);c.click(),a.preventDefault()}).on("click",".form-thumb",function(){var a=$(this),c=a.closest(".fs-publish-panel"),d=$(".fs-publish-form",c),e=$(".panel-visible-h",c);d.show(),$(".publish-input",d).get(0).focus(),a.hide(),e.show(),b.trigger("publishshow",c)}),h.on("switched",function(c,d){var i=h.get("panels").eq(c),j=h.get("panels").eq(d),k=$(".publish-input",i),l=$(".publish-input",j).last(),m=$(".form-thumb",i),n=i.attr("feedname"),o=$(".media",i),p=l.val();i.data("rendered")||(b[n+"Init"]&&b[n+"Init"](),i.data("rendered",!0)),m.is(":visible")&&m.click(),0==$(".media-share",o).length&&e.appendTo(o),"share"==i.attr("feedname")?a.showAction("vote"):a.hideAction("vote"),p.length>0?k.last().val(p).keyup().change():k.last().val("").keyup().change(),k.trigger("autosize.resize"),k.last().get(0).focus(),$(".fs-guide-send-receipt-bracket,.fs-guide-history-plan-bracket").remove(),"share"==n?!b.currentUserData.isDemoAccount&&g.IsShowReceiptTip&&0==$(".fs-guide-bracket").length&&f.showGuideTip($(".sms-wrapper",i),{leftLeftIncrement:0,rightLeftIncrement:0,imageName:"receiption.png",imagePosition:{top:"-94px",left:"20px"},renderCb:function(a,b,c,d){var e=$('<div class="fs-guide-shadow-link"></div>'),h=$('<div class="fs-guide-shadow-link"></div>'),i=function(){g.IsShowReceiptTip=!1,f.setEnterpriseConfig(107,g,!0),f.updateEnterpriseConfig(107),b.remove(),c.remove(),$(".fs-guide-history-plan-bracket").css("visibility","visible")};b.addClass("fs-guide-send-receipt-bracket"),c.addClass("fs-guide-send-receipt-bracket"),$(".fs-guide-history-plan-bracket").css("visibility","hidden"),e.css({width:"26px",height:"26px",position:"absolute",top:"9px",left:"236px",cursor:"pointer"}).appendTo(a),h.css({width:"140px",height:"32px",position:"absolute",top:"124px",left:"88px",cursor:"pointer"}).appendTo(a),e.click(function(){i()}),h.click(function(){i()}),d.one("click",function(){i()})}}):"plan"==n&&(b.currentUserData.isDemoAccount||g.IsSkipPlan||f.showGuideTip($(".show-history-plan-l",i),{leftTopIncrement:-5,rightTopIncrement:-5,rightLeftIncrement:-5,imageName:"history-plan.png",imagePosition:{top:"-160px",left:"-225px"},imagePlace:"left",renderCb:function(a,b,c,d){var e=$('<div class="fs-guide-shadow-link"></div>'),h=function(){g.IsSkipPlan=!0,f.setEnterpriseConfig(107,g,!0),f.updateEnterpriseConfig(107),b.remove(),c.remove()};b.addClass("fs-guide-history-plan-bracket"),c.addClass("fs-guide-history-plan-bracket"),e.css({width:"26px",height:"26px",position:"absolute",top:"4px",right:"24px",cursor:"pointer"}).appendTo(a),e.click(function(){h()}),d.one("click",function(){h()})}}))});var i,k;n.enabled&&(k=d,k.keyup(function(){var a=$(this),c=_.str.trim(a.val()),d=a.attr("name"),e=_.extend(n.get("lastInputFeedInfo")||{},{employeeId:b.currentUserData.id});e[d]=c,n.set("lastInputFeedInfo",e)}),i=n.get("lastInputFeedInfo"),i&&i.employeeId==this.currentUserData.id?(k.filter('[name="content"]').val(i.content).keyup().change(),k.filter('[name="report"]').val(i.report).keyup().change(),k.filter('[name="plan"]').val(i.plan).keyup().change()):n.set("lastInputFeedInfo",null)),h.trigger("switched",0,-1),this.publishTabs=h},getAtContent:function(a){return f.getAtFromInput(a)},groupAtContent:function(a,b){var c=this,d=[],e=[],f=[],g=[],h=$(a);return h.each(function(){d=d.concat(c.getAtContent(this))}),d.length>0&&(e=_.filter(d,function(a){return c.isExistContactData(a)?!0:(f.push(a),!1)}),_.each(e,function(a){c.isIncludeInRange(a,b)||g.push(a)})),g=_.map(g,function(a){var b,d="g";return b=c.getContactDataByName(a,"g"),b||(b=c.getContactDataByName(a,"p"),d="p"),_.extend({type:d},b)}),{noExist:f,noInclude:g,validAtContent:e}},isExistContactData:function(a){var b,c=this.contactPersonData,d=this.contactGroupData;return b=_.find(c,function(b){return b.name==a?!0:void 0}),b||(b=_.find(d,function(b){return b.name==a?!0:void 0})),!!b},getContactDataById:function(a,b){var c="g"==b?this.contactGroupData:this.contactPersonData;return _.find(c,function(b){return b.id==a})},getContactDataByName:function(a,b){var c="g"==b?this.contactGroupData:this.contactPersonData;return _.find(c,function(b){return b.name==a})},isIncludeInRange:function(a,b){var c,d,e=this,f=(this.contactPersonData,this.contactGroupData),g=b.getSelectedData(),h=g.p||[],i=g.g||[],j=!1;return d=_.find(f,function(b){return b.name==a?!0:void 0}),d?_.find(i,function(b){return c=e.getContactDataById(b,"g"),c.name==a?j=!0:void 0}):(_.find(h,function(b){return c=e.getContactDataById(b,"p"),c.name==a?j=!0:void 0}),j||_.find(i,function(b){return c=e.getContactDataById(b,"g"),c&&_.contains(e.getContactDataByName(a,"p").groupIDs,c.id)?j=!0:void 0})),j},getPublishDefaultUser:function(a){return f.getPublishDefaultUser(a)},getPublishRange:function(a){return f.getPublishRange(a)},planInit:function(){var a,b,d=this,e=$(".publish-wrapper",this.tplEl),g=$(".fs-publish-plan",e),h=$(".publish-input",g),i=$(".publish-topic-tip",g),k=$(".send-sms",g),l=$(".publish-extend",g),n=$(".show-history-plan-l",g),o=function(){var a=b.get("activeIndex"),c=b.get("panels").eq(a),d=$(".selectbar",c).data("sb");return d},p=function(){var c,d={},e=b.get("activeIndex"),f=b.get("panels").eq(e),h=o(),i=h.getSelectedData(),j=$(".ksfw .selectbar",g).data("sb"),k=j.getSelectedData();return _.each(["report","plan","content"],function(a){var b=$('[name="'+a+'"]',g);d[a]=_.str.trim(b.val())}),d.planType=f.attr("logtype"),d.leaderID=i.p?i.p[0]:"",d.circleIDs=k.g||[],d.employeeIDs=k.p||[],d.leaderID.length>0&&d.employeeIDs.push(d.leaderID),d.fileInfos=[],c=a.getUploadValue(),_.each(c,function(a){"img"==a.uploadType?d.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&d.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),d.isSendSms=$('[name="sendSms"]',g).prop("checked"),d},q=function(){var a=!0,b=p(),c=o();return 0==b.leaderID.length&&(a=!1,$(".input-tip",c.element).click()),h.each(function(){var b=$(this),c=_.str.trim(b.val()),d=b.attr("name");return"report"==d&&c.length>2e3?(f.alert("工作总结不能超过2000字，目前已超出<em>"+(c.length-2e3)+"</em>个字"),a=!1,!1):"plan"==d&&c.length>2e3?(f.alert("工作计划不能超过2000字，目前已超出<em>"+(c.length-2e3)+"</em>个字"),a=!1,!1):"content"==d&&c.length>1e4?(f.alert("心得体会不能超过10000字，目前已超出<em>"+(c.length-1e4)+"</em>个字"),a=!1,!1):void 0}),a},r=function(){h.val("").height(50).change(),a.resetAll(),$(".ksfw .selectbar",g).each(function(){$(this).data("sb").removeAllItem()}),k.prop("checked",!1),i.hide()},s=function(){var a=$(".ksfw .selectbar",g).data("sb");return d.groupAtContent(h,a)},t=function(){var a=p(),b=a.leaderID,c=f.getContactDataById(b,"p"),d=a.employeeIDs,e=a.circleIDs,g=e.join(",")+"|"+d.join(","),h="",i=f.getPersonalConfig("planLeaders")||[],j=f.getPersonalConfig("planEmployees")||[],k=f.getPersonalConfig("planRanges")||[];return i=_.filter(i,function(a){return a.dataID!=b}),i.unshift({dataID:b,isCircle:!1,name:c.name}),i.length>5&&i.pop(),_.each(d,function(a){var b=f.getContactDataById(a,"p");j=_.filter(j,function(b){return b.dataID!=a}),j.unshift({dataID:a,isCircle:!1,name:b.name}),j.length>5&&j.pop()}),e.length+d.length>1&&(k=_.filter(k,function(a){return a.dataIDs!=g}),_.each(e,function(a){var b=f.getContactDataById(a,"g");h+=b.name+"，"}),_.each(d,function(a){var b=f.getContactDataById(a,"p");h+=b.name+"，"}),h.length>0&&(h=h.slice(0,-1)),k.unshift({dataIDs:g,names:h}),k.length>5&&k.pop()),{planLeaders:i,planEmployees:j,planRanges:k}},v=function(){$(".selectbar",l).each(function(){var a=$(this).data("sb");a.opts.acInitData=d.getPublishDefaultUser("planLeaders")}),$(".ksfw .selectbar",g).each(function(){var a=$(this).data("sb");a.opts.acInitData=d.getPublishRange("plan")})},w=new y({inputSelector:{today:h.eq(0),tomorrow:h.eq(1),xdth:h.eq(2)}});n.click(function(a){w.show(),a.preventDefault()}),a=$(".media",g).data("media"),h.keyup(function(){var a=$(this),b=_.str.trim(a.val());a.attr("name"),/#[^\n]+?#/g.test(b)?i.slideDown(200,function(){$(c).trigger("resize")}):i.slideUp(200,function(){$(c).trigger("resize")})}),b=new j({element:l,triggers:$(".publish-extend-nav",l),panels:$(".publish-extend-panel",l),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click",triggerBgTop:"0"}).render(),b.on("switch",function(a){var c=b.get("panels").eq(a),d=c.attr("logtypetext").split(","),e=$(".publish-input-wrapper label",g).slice(0,2);e.each(function(a){var b=$(this),c=$(".logtype-text",b);c.text(d[a])}),w.set("planType",a+1)}).on("switched",function(a,c){var d,e,g=b.get("panels").eq(a),h=b.get("panels").eq(c),i=$(".selectbar",g).data("sb"),j=$(".selectbar",h).data("sb"),k=j.getSelectedData();i.removeAllItem(),k.p&&(d=k.p[0],e={id:d,name:f.getContactDataById(d,"p").name,type:"p"},i.addItem(e))}),$(".selectbar",l).each(function(){var a=d.getPublishDefaultUser("planLeaders"),b=a[0].store,c=b[0],e=[];c&&(e=[{id:c.id,name:c.value,type:"p"}]);var g=f.deepClone(d.contactPersonData);g=_.filter(g,function(a){return a.id!=d.currentUserData.id});var h=new u({element:this,data:[{title:"同事",type:"p",list:g}],title:"选择日志点评人",singleCked:!0,acInitData:d.getPublishDefaultUser("planLeaders"),defaultSelectedData:e,autoCompleteTitle:"请输入姓名或拼音"});$(this).data("sb",h)}),$(".ksfw .selectbar",g).each(function(){var a=new u({element:this,data:[{title:"同事",type:"p",list:d.contactPersonData},{title:"部门",type:"g",list:d.contactGroupData,unitSuffix:"个部门"}],acInitData:d.getPublishRange("plan"),title:"选择抄送范围&#8230;",autoCompleteTitle:"请输入部门或同事的名称或拼音"});$(this).data("sb",a),a.on("inputshow",function(){a.setAcInitData(d.getPublishRange("plan"))})});var x=new m({element:$(".fs-publish-log-form",g),autoSubmit:!1,checkOnSubmit:!0,onFormValidated:function(a,b){a&&_.each(b,function(a){var b=a[2];b.hasClass("publish-input")&&d.publishErrorHl(b.closest(".publish-input-wrapper"))})}});x.addItem({element:h,required:!0,display:"请输入内容"}),h.change(function(){var a=!0,b=x.query(h);h.each(function(){var b=$(this),c=_.str.trim(b.val());return c.length>0?(a=!1,!1):void 0}),b.set("required",a)}),this.on("publishhide",function(a){"plan"==a.attr("feedname")&&r()}),this.regValidator({validator:x,media:a,isValid:q,clear:r,sendPath:"/FeedPlan/SendFeedPlan",getRequestData:p,groupAt:s,getPersonalConfig:t,updateSbAcInitData:v})},approveInit:function(){var a,b,c=this,d=$(".publish-wrapper",this.tplEl),e=$(".fs-publish-approve",d),i=$(".publish-input",e),k=$(".publish-topic-tip",e),l=$(".send-sms",e),n=$(".publish-extend",e),o=$(".leave",e),p=$(".baoxiao",e),q=$(".leave-row-tpl",e).html(),r=$(".baoxiao-row-tpl",e).html(),s=$(".baoxiao-summary",e),t=$(".upper-text",s),x=$(".num-text",s),y=$(".total-time-span",e),z=0,A=3,B=3,C=function(a){var b,c,d,e,f,g,h,i,j=$(a||q);return j.appendTo(o),f=$(".start-date-wrapper",j),b=new v({element:f,placeholder:"选择日期"}),h=$(".end-date-wrapper",j),d=new v({element:h,placeholder:"选择日期"}),g=$(".start-time-wrapper",j),c=new w({element:g,placeholder:"选择时间"}),i=$(".end-time-wrapper",j),e=new w({element:i,placeholder:"选择时间"}),b.on("change",function(){""==c.getValue()&&c.selector.select(0)}),d.on("change",function(){""==e.getValue()&&e.selector.select(0)}),$(".cate",o).unbind("change"),$(".cate",j).change(function(){C()}),j},D=function(a){var b=$(a||r);return b.appendTo(p),$("input",p).unbind("change"),$("input",b).change(function(){D()}),b},E=function(){var a=b.get("activeIndex"),c=b.get("panels").eq(a),d=$(".selectbar",c).data("sb");return d},F=function(){var c,d={},f=b.get("activeIndex"),i=b.get("panels").eq(f),j=$(".selectbar",i).data("sb"),k=j.getSelectedData(),l=$(".ksfw .selectbar",e).data("sb"),m=l.getSelectedData();return d.content=_.str.trim($('[name="content"]',e).val()),d.approveType=i.attr("approvetype"),d.currentApproverID=k.p?k.p[0]:"",d.circleIDs=m.g||[],d.employeeIDs=m.p||[],d.currentApproverID.length>0&&d.employeeIDs.push(d.currentApproverID),d.approveDetail=[],"2"==d.approveType&&$("tbody tr",o).each(function(){var a=$(this),b=$(".start-date-wrapper input",a).val(),c=$(".start-time-wrapper input",a).val(),e=$(".end-date-wrapper input",a).val(),f=$(".end-time-wrapper input",a).val();d.approveDetail.push({reasonType:parseInt($(".cate",a).val()),reasonTypeDesc:$(".cate option:selected",a).text(),startDate:b,stopDate:e,startTime:c,stopTime:f,beginTime:b?g(b+" "+c,"YYYYMMDD HH:mm").unix():0,endTime:e?g(e+" "+f,"YYYYMMDD HH:mm").unix():0,hours:parseFloat(_.str.trim($(".time-span-edit",a).val()))})}),"3"==d.approveType&&$("tbody tr",p).each(function(){var a=$(this);d.approveDetail.push({title:_.str.trim($(".cate",a).val()),amount:parseFloat(_.str.trim($(".amount",a).val())),remark:_.str.trim($(".mark",a).val())})}),d.approveDetail=_.reject(d.approveDetail,function(a){var b=!0;return _.find(a,function(a){return a?(b=!1,!0):void 0}),b}),d.approveDetail=h.stringify(d.approveDetail),d.fileInfos=[],c=a.getUploadValue(),_.each(c,function(a){"img"==a.uploadType?d.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&d.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),d.isSendSms=$('[name="sendSms"]',e).prop("checked"),d},G=function(){var a=!0,b=F(),c=b.approveType,d=h.parse(b.approveDetail),e=E();return 0==b.currentApproverID.length?(a=!1,$(".input-tip",e.element).click(),!1):b.content.length>2e3?(f.alert("发布内容不能超过2000字，目前已超出<em>"+(b.content.length-2e3)+"</em>个字"),a=!1,!1):("2"==c&&(a=!_.find(d,function(a){return a.reasonType?0==a.beginTime?(f.alert("请假开始时间不能为空"),!0):0==a.endTime?(f.alert("请假结束时间不能为空"),!0):g.unix(a.beginTime).isAfter(g.unix(a.endTime))?(f.alert("结束时间需大于开始时间"),!0):g.unix(a.beginTime).isSame(g.unix(a.endTime))?(f.alert("结束时间需大于开始时间"),!0):a.hours?isNaN(a.hours)?(f.alert("请输入有效的请假时间"),!0):void 0:(f.alert("请输入请假时间，以小时计算"),!0):(f.alert("请假事项不能为空"),!0)})),"3"==c&&(a=!_.find(d,function(a){return a.title?a.amount?isNaN(a.amount)?(f.alert("请输入有效的报销金额"),!0):void 0:(f.alert("请输入报销金额"),!0):(f.alert("报销项名称不能为空"),!0)})),a)},H=function(){for(z=0;A>z;z++)C()},I=function(){for(z=0;B>z;z++)D()},J=function(){i.val("").height(50),a.resetAll(),$("tbody",o).empty(),$("tbody",p).empty(),$(".num",y).text("0"),t.text(""),x.text(""),H(),I(),$(".ksfw .selectbar",e).each(function(){$(this).data("sb").removeAllItem()}),l.prop("checked",!1),k.hide()},K=function(){var a=$(".ksfw .selectbar",e).data("sb");return c.groupAtContent(i,a)},L=function(){var a=F(),b=a.currentApproverID,c=f.getContactDataById(b,"p"),d=a.employeeIDs,e=a.circleIDs,g=e.join(",")+"|"+d.join(","),h="",i=f.getPersonalConfig("approveApprovers")||[],j=f.getPersonalConfig("approveEmployees")||[],k=f.getPersonalConfig("approveRanges")||[];return i=_.filter(i,function(a){return a.dataID!=b}),i.unshift({dataID:b,isCircle:!1,name:c.name}),i.length>5&&i.pop(),_.each(d,function(a){var b=f.getContactDataById(a,"p");j=_.filter(j,function(b){return b.dataID!=a}),j.unshift({dataID:a,isCircle:!1,name:b.name}),j.length>5&&j.pop()}),e.length+d.length>1&&(k=_.filter(k,function(a){return a.dataIDs!=g}),_.each(e,function(a){var b=f.getContactDataById(a,"g");h+=b.name+"，"}),_.each(d,function(a){var b=f.getContactDataById(a,"p");h+=b.name+"，"}),h.length>0&&(h=h.slice(0,-1)),k.unshift({dataIDs:g,names:h}),k.length>5&&k.pop()),{approveApprovers:i,approveEmployees:j,approveRanges:k}},M=function(){$(".selectbar",n).each(function(){var a=$(this).data("sb");a.opts.acInitData=c.getPublishDefaultUser("approveApprovers")}),$(".ksfw .selectbar",e).each(function(){var a=$(this).data("sb");a.opts.acInitData=c.getPublishRange("approve")})};H(),I(),o.on("change","input.time-span-edit",function(){var a=$("input.time-span-edit",o),b=0;a.each(function(){var a=$(this),c=_.str.trim(a.val());c.length>0&&(c=parseFloat(c),isNaN(c)?a.val("0"):(c=parseFloat(c.toFixed(1)),b+=c,a.val(c)))}),$(".num",y).text(b.toFixed(1))}),p.on("change","input.amount",function(){var a=$("input.amount",p),b=0;a.each(function(){var a=$(this),c=_.str.trim(a.val());c.length>0&&(c=parseFloat(c),isNaN(c)?a.val("非有效数字"):(c=parseFloat(c.toFixed(2)),b+=c,a.val(c.toFixed(2))))}),b=parseFloat(b.toFixed(2)),t.text(f.digitUppercase(b)),x.text(b.toFixed(2))}),a=$(".media",e).data("media"),i.keyup(function(){$(this);var a=_.str.trim($(this).val());/#[^\n]+?#/g.test(a)?k.slideDown(200):k.slideUp(200)}),e.on("keydown",".baoxiao-wrapper input,.leave-wrapper input",function(a){13==a.keyCode&&(a.preventDefault(),a.stopPropagation())}),b=new j({element:n,triggers:$(".publish-extend-nav",n),panels:$(".publish-extend-panel",n),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click",triggerBgTop:"0"}).render(),b.on("switched",function(a,c){var d,e,g=b.get("panels").eq(a),h=b.get("panels").eq(c),i=$(".selectbar",g).data("sb"),j=$(".selectbar",h).data("sb"),k=j.getSelectedData();i.removeAllItem(),k.p&&(d=k.p[0],e={id:d,name:f.getContactDataById(d,"p").name,type:"p"},i.addItem(e))}),$(".selectbar",n).each(function(){var a=c.getPublishDefaultUser("approveApprovers"),b=a[0].store,d=b[0],e=[];d&&(e=[{id:d.id,name:d.value,type:"p"}]);var g=f.deepClone(c.contactPersonData);g=_.filter(g,function(a){return a.id!=c.currentUserData.id});var h=new u({element:this,data:[{title:"同事",type:"p",list:g}],singleCked:!0,acInitData:a,defaultSelectedData:e,title:"选择审批人",autoCompleteTitle:"请输入姓名或拼音"});$(this).data("sb",h)}),$(".ksfw .selectbar",e).each(function(){var a=new u({element:this,data:[{title:"同事",type:"p",list:c.contactPersonData},{title:"部门",type:"g",list:c.contactGroupData,unitSuffix:"个部门"}],acInitData:c.getPublishRange("approve"),title:"选择抄送范围&#8230;",autoCompleteTitle:"请输入部门或同事的名称或拼音"});$(this).data("sb",a)});var N=new m({element:$(".fs-publish-approve-form",e),autoSubmit:!1,checkOnSubmit:!0,onFormValidated:function(a,b){a&&_.each(b,function(a){var b=a[2];b.hasClass("publish-input")&&c.publishErrorHl(b.closest(".publish-input-wrapper"))})}});N.addItem({element:$('[name="content"]',e),required:!0,errormessageRequired:""}),this.on("publishhide",function(a){"approve"==a.attr("feedname")&&J()}),this.regValidator({validator:N,media:a,isValid:G,clear:J,sendPath:"/FeedApprove/SendFeedApprove",getRequestData:F,groupAt:K,getPersonalConfig:L,updateSbAcInitData:M})},workInit:function(){var a,b,c,d=this,e=$(".publish-wrapper",this.tplEl),h=$(".fs-publish-work",e),i=$(".publish-input",h),j=$(".publish-topic-tip",h),k=$(".send-sms",h),l=$(".publish-extend",h),n=$(".sms-warn-counts",h),o=$(".sms-warn-list",h),p=$(".sms-warn-tpl",h).html(),q=$(".task-complete-datetime",h),r=$(".date-select-wrapper",q),s=$(".time-select-wrapper",q);b=new v({element:r,placeholder:"请选择日期",formatStr:"YYYY年MM月DD日（dddd）"}),c=new w({element:s,placeholder:"请选择时间"}),b.on("change",function(){""==c.getValue()&&""!=b.getValue()&&c.selector.select(0)});var t=function(a,b){var c,d,e,f,g,h;return a=a||{counts:0},b=b||p,h=_.template(b),c=$(h(a)),c.appendTo(o),d=$(".date-select-wrapper",c),e=$(".time-select-wrapper",c),f=new v({element:d,placeholder:"请选择日期",formatStr:"YYYY年MM月DD日（dddd）"}),g=new w({element:e,placeholder:"请选择时间"}),c.data("dateSelect",f),c.data("timeSelect",g),f.on("change",function(){""==g.getValue()&&""!=f.getValue()&&g.selector.select(0)}),c},x=function(){var e,f={},i=$(".selectbar",l).data("sb"),j=i.getSelectedData(),k=$(".sms-warn-list .sms-warn",h),m=$(".ksfw .selectbar",h).data("sb"),o=m.getSelectedData(),p=b.getValue(),q=c.getValue();return f.content=_.str.trim($('[name="content"]',h).val()),f.assignerID=d.currentUserData.id,f.executerID=j.p||[],f.deadline=p.length>0?g(p+" "+q,"YYYYMMDD HH:mm").unix():"",f.smsRemindType=parseInt($(":checked",n).val())+1,f.smsRemindTimes=[],k.each(function(){var a=$(this),b=a.data("dateSelect"),c=a.data("timeSelect"),d=b.getValue(),e=c.getValue();d.length>0&&f.smsRemindTimes.push({value:f.smsRemindTimes.length+1,value1:g(d+" "+e,"YYYYMMDD HH:mm").unix()})}),f.circleIDs=o.g||[],f.employeeIDs=o.p||[],f.employeeIDs=f.employeeIDs.concat(f.executerID),f.fileInfos=[],e=a.getUploadValue(),_.each(e,function(a){"img"==a.uploadType?f.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&f.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),f.isSendSms=$('[name="sendSms"]',h).prop("checked"),f},y=function(){var a,b=!0,c=x(),e=$(".selectbar",l).data("sb");return 0==c.executerID.length&&(b=!1,$(".input-wrapper",e.element).click()),c.content.length>2e3?(f.alert("发布内容不能超过2000字，目前已超出<em>"+(c.content.length-2e3)+"</em>个字"),b=!1,!1):(0==c.deadline.length&&(b=!1,a=$(".date-select-wrapper input",q),0==_.str.trim(a.val()).length&&d.publishErrorHl(a),a=$(".time-select-wrapper input",q),0==_.str.trim(a.val()).length&&d.publishErrorHl(a)),$(".sms-warn-datetime",o).filter(":visible").each(function(){var a=$(".date-select-wrapper input",this);0==_.str.trim(a.val()).length&&(d.publishErrorHl($(".date-select-wrapper input",this)),b=!1)}),b)},z=function(){i.val("").height(50),a.resetAll(),b.clear(),c.clear(),$("input",n).eq(0).click(),$(".ksfw .selectbar",h).each(function(){$(this).data("sb").removeAllItem()}),k.prop("checked",!1),j.hide()},A=function(){var a=$(".ksfw .selectbar",h).data("sb");return d.groupAtContent(i,a)},B=function(){var a=x(),b=a.executerID,c=a.employeeIDs,d=a.circleIDs,e=d.join(",")+"|"+c.join(","),g="",h=f.getPersonalConfig("workExecuters")||[],i=f.getPersonalConfig("workEmployees")||[],j=f.getPersonalConfig("workRanges")||[];return _.each(b,function(a){h=_.filter(h,function(b){return b.dataID!=a})}),_.each(b,function(a){var b=f.getContactDataById(a,"p");h.unshift({dataID:a,isCircle:!1,name:b.name})}),h.length>5&&h.pop(),_.each(c,function(a){var b=f.getContactDataById(a,"p");i=_.filter(i,function(b){return b.dataID!=a}),i.unshift({dataID:a,isCircle:!1,name:b.name}),i.length>5&&i.pop()}),d.length+c.length>1&&(j=_.filter(j,function(a){return a.dataIDs!=e}),_.each(d,function(a){var b=f.getContactDataById(a,"g");g+=b.name+"，"}),_.each(c,function(a){var b=f.getContactDataById(a,"p");g+=b.name+"，"}),g.length>0&&(g=g.slice(0,-1)),j.unshift({dataIDs:e,names:g}),j.length>5&&j.pop()),{workExecuters:h,workEmployees:i,workRanges:j}},C=function(){$(".selectbar",l).each(function(){var a=$(this).data("sb");a.opts.acInitData=d.getPublishDefaultUser("workExecuters")}),$(".ksfw .selectbar",h).each(function(){var a=$(this).data("sb");a.opts.acInitData=d.getPublishRange("work")})};a=$(".media",h).data("media"),i.keyup(function(){$(this);var a=_.str.trim($(this).val());/#[^\n]+?#/g.test(a)?j.slideDown(200):j.slideUp(200)}),$(".selectbar",l).each(function(){var a=d.getPublishDefaultUser("workExecuters"),b=a[0].store,c=b[0],e=[];c&&(e=[{id:c.id,name:c.value,type:"p"}]);var g=f.deepClone(d.contactPersonData);g=_.filter(g,function(a){return a.id!=d.currentUserData.id});var h=new u({element:this,data:[{title:"同事",type:"p",list:g}],singleCked:!1,title:"选择指令执行人",acInitData:a,defaultSelectedData:e,autoCompleteTitle:"请输入姓名或拼音"});$(this).data("sb",h)}),n.on("click","input",function(){var a=$(this),b=0,c=parseInt(a.val()),d=$(".sms-warn",o),e=d.length;if(e>=c)d.slice(c).remove();else for(b=0;c-e>b;b++)t({counts:f.changeToChineseNum(b+1+e)})}),$(".ksfw .selectbar",h).each(function(){var a=new u({element:this,data:[{title:"同事",type:"p",list:d.contactPersonData},{title:"部门",type:"g",list:d.contactGroupData,unitSuffix:"个部门"}],title:"选择抄送范围&#8230;",acInitData:d.getPublishRange("work"),autoCompleteTitle:"请输入部门或同事的名称或拼音"});$(this).data("sb",a)});var D=new m({element:$(".fs-publish-work-form",h),autoSubmit:!1,checkOnSubmit:!0,onFormValidated:function(a,b){a&&_.each(b,function(a){var b=a[2];b.hasClass("publish-input")&&d.publishErrorHl(b.closest(".publish-input-wrapper"))})}});D.addItem({element:$('[name="content"]',h),required:!0,errormessageRequired:""}),this.on("publishhide",function(a){"work"==a.attr("feedname")&&z()}),this.regValidator({validator:D,media:a,isValid:y,clear:z,sendPath:"/FeedWork/BatchSendFeedWork",getRequestData:x,groupAt:A,getPersonalConfig:B,updateSbAcInitData:C})},shareInit:function(){var a,b,d=this,e=$(".publish-wrapper",this.tplEl),g=$(".fs-publish-share",e),h=$(".publish-input",g),i=$(".is-send-sms",g),j=$(".is-receipt",g),k=$(".receipt-tip",g),l=$(".send-sms-g",e),n=$(".send-sms-p",e),o=$(".publish-topic-tip",g),p=function(){var b,c,d={},e=$(".ksfw .selectbar",g).data("sb"),h=e.getSelectedData(),k=l.val(),m=n.val(),o=[],p={};return d.content=_.str.trim($('[name="content"]',g).val()),d.circleIDs=h.g||[],d.employeeIDs=h.p||[],d.isSendReceipt=j.prop("checked"),d.smsCircleIDs=k?k.split(","):[],d.smsEmployeeIDs=m?m.split(","):[],d.fileInfos=[],b=a.getUploadValue(),_.each(b,function(a){"img"==a.uploadType?d.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&d.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),d.isSendSms="1"==i.val()?!0:!1,d.fileInfos.length>0&&0==d.content.length&&(o=f.getAttachTypeName(d.fileInfos),o.length>0&&(d.content=o.length>2?"分享"+o.join("、"):o.length>1?"分享"+o.join("和"):"分享"+o[0])),a.isActive("vote")?(c=a.voteGetValue(),_.each(c,function(a,b){p[b]=a.value}),_.extend(d,{vote:p}),_.extend(d,{voteOptions:p.voteOptions})):d.vote=null,d},q=function(){var b=!0,c=p(),e=$(".ksfw .selectbar",g).data("sb"),i=s(),j=i.noExist,k=i.noInclude;return 0==c.content.length?(d.publishErrorHl(h.closest(".publish-input-wrapper")),!1):c.content.length>1e4?(f.alert("发布内容不能超过10000字，目前已超出<em>"+(c.content.length-1e4)+"</em>个字"),b=!1,!1):0==c.circleIDs.length&&0==c.employeeIDs.length?k.length>0?b=!0:j.length>0?(f.confirm("您通过@提到当中 "+j.join("，")+" 不是员工姓名或部门的名称，是否继续？","提示",function(a){$(".input-wrapper",e.element).click(),a.stopPropagation()},{onCancel:function(){}}),b=!1):($(".input-wrapper",e.element).click(),b=!1):(b=!0,a.isActive("vote")?b=a.voteIsValid():b)},r=function(){h.val("").height(50),a.resetAll(),$(".ksfw .selectbar",g).each(function(){$(this).data("sb").removeAllItem()}),i.val("0"),z(),j.prop("checked",!1),z(),o.hide()},s=function(){var a=$(".ksfw .selectbar",g).data("sb");return d.groupAtContent(h,a)},v=function(){var a=p(),b=a.employeeIDs,c=a.circleIDs,d=c.join(",")+"|"+b.join(","),e="",g=f.getPersonalConfig("shareEmployees")||[],h=f.getPersonalConfig("shareRanges")||[];return _.each(b,function(a){var b=f.getContactDataById(a,"p");g=_.filter(g,function(b){return b.dataID!=a}),g.unshift({dataID:a,isCircle:!1,name:b.name}),g.length>5&&g.pop()}),c.length+b.length>1&&(h=_.filter(h,function(a){return a.dataIDs!=d}),_.each(c,function(a){var b=f.getContactDataById(a,"g");e+=b.name+"，"}),_.each(b,function(a){var b=f.getContactDataById(a,"p");e+=b.name+"，"}),e.length>0&&(e=e.slice(0,-1)),h.unshift({dataIDs:d,names:e}),h.length>5&&h.pop()),{shareEmployees:g,shareRanges:h}},w=function(){var a=$(".ksfw .selectbar",g).data("sb");a.opts.acInitData=d.getPublishRange("share")},y=function(a){var c,d,e=[];_.isEmpty(a)?k.text("").hide():(c=a.g||[],d=a.p||[],c.length>0&&e.push(c.length+"个部门"),d.length>0&&e.push(d.length+"个人"),l.val(c.join(",")),n.val(d.join(",")),i.val($(".is-sms-send",b.element).prop("checked")?"1":"0"),k.text("已选择"+e.join("，")).show())},z=function(){l.val(""),n.val(""),i.val("0"),k.empty().hide()};h.keyup(function(){var a=$(this),b=_.str.trim(a.val());/#[^\n]+?#/g.test(b)?o.slideDown(200,function(){$(c).trigger("resize")}):o.slideUp(200,function(){$(c).trigger("resize")})}),a=$(".media",g).data("media"),a||(a=new t({element:$(".media",g),action:["h5imgupload","h5attachupload","vote","at","topic"],actionOpts:{vote:{contactData:this.contactPersonData},at:{inputSelector:h},topic:{inputSelector:h},h5imgupload:{flashFallback:!0},h5attachupload:{flashFallback:!0}}})),$(".ksfw .selectbar",g).each(function(){var a=new u({element:this,data:[{title:"同事",type:"p",list:d.contactPersonData},{title:"部门",type:"g",list:d.contactGroupData,unitSuffix:"个部门"}],title:"选择发送范围&#8230;",acInitData:d.getPublishRange("share"),autoCompleteTitle:"请输入部门或同事的名称或拼音"});$(this).data("sb",a)}),b=new x({inputSelector:h,rangeSb:$(".ksfw .selectbar",g).data("sb"),submitCb:function(a){y(a),this.hide()},cancelCb:function(){j.prop("checked",!1),z()}}),j.click(function(){var a=j.prop("checked");a?b.show():z()});var A=new m({element:$(".fs-publish-share-form",g),autoSubmit:!1,checkOnSubmit:!0,onFormValidated:function(a,b){a&&_.each(b,function(a){var b=a[2];b.hasClass("publish-input")&&d.publishErrorHl(b.closest(".publish-input-wrapper"))})}});A.addItem({element:$('[name="content"]',g),required:!1,errormessageRequired:""}),this.on("publishhide",function(a){"share"==a.attr("feedname")&&r()}),this.regValidator({validator:A,media:a,isValid:q,clear:r,sendPath:"/Feed/SendFeed",getRequestData:p,groupAt:s,getPersonalConfig:v,updateSbAcInitData:w,feedType:"share"})},feedInit:function(){var a,b=this,c=this.opts,d=$(".feed-list",this.tplEl),g=$(".search-inp",d),h=$(".search-btn",d),i=$(".feed-tabs",d),k=function(a){var b=$(a),c=b.data("feedList");c&&c.loadKill(),c&&c.empty()},l=function(a){0==a.get("activeIndex")?a.trigger("switched",0,-1):a.switchTo(0)},m=function(a){a.success&&"stream"==b.tplName&&b.createRightSbContent()};this.currentFeedList=null,a=new j({element:i,triggers:$(".feed-main-item",i),panels:$(".feed-main-panel",i),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click"}).render(),a.on("switched",function(d){var e,i,n,o,q,r,s=this.get("panels").eq(d),t=$(".feed-list",s),u=$(".feed-list-pagination",s),v=s.attr("feedtype"),w=s.attr("feedname");"0"==v||"1"==v?(n=s.data("feedList"),o=s.attr("subtype"),"0"==v?r="您所属的部门中还没有人发言，您来发布第一个分享吧~":"1"==v&&(q=function(){l(a)
},r=1==o?"您所属的部门中还没有人发布过公告":"您所属的部门中还没有人发布过分享"),n?n.reload():(n=new p(_.extend({element:t,pagSelector:u,pagOpts:{pageSize:45,visiblePageNums:7},loadSize:15,withFeedRemind:!0,withLazyload:!0,listPath:c.feedListPath,beforeListParse:c.beforeFeedListParse,listEmptyText:r,listSuccessCb:function(){var a=parseInt(f.getTplStore("stream","maxFeedId")||0);n.lastMaxId>a&&f.setTplStore("stream",{maxFeedId:n.lastMaxId}),c.feedListSuccessCb&&c.feedListSuccessCb.apply(this,arguments)},defaultRequestData:function(){var a=c.applyFeedlistRd;return _.isFunction(a)&&(a=a(n)),_.extend({circleID:0,subType:o?o:0,feedType:v,keyword:_.str.trim(g.val())},a)},searchOpts:{inputSelector:g,btnSelector:h},feedRemindClickCb:q,itemWorktodoCb:m},c.feedlistConfig)),n.load(),s.data("feedList",n)),b.currentFeedList=n):(e=$(".feed-sub-list",s),i=e.data("subTabs"),e.data("rendered")?l(i):(i=new j({element:e,triggers:$(".feed-"+w+"-item",e),panels:$(".feed-"+w+"-panel",e),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click",withTabEffect:!1}).render().on("switched",function(d){var e,f=this.get("panels").eq(d),i=$(".feed-list",f),j=$(".feed-list-pagination",f),k=f.attr("subtype"),n=f.data("feedList");n?n.reload():("2"==v?e="您所属的部门中还没有人发布过日志":"3"==v?e="您所属的部门中还没有人发布过指令":"4"==v&&(e="您所属的部门中还没有人发布过审批"),n=new p(_.extend({element:i,pagSelector:j,pagOpts:{pageSize:45,visiblePageNums:7},loadSize:15,withFeedRemind:!0,withLazyload:!0,listPath:c.feedListPath,beforeListParse:c.beforeFeedListParse,listSuccessCb:c.feedListSuccessCb,listEmptyText:e,defaultRequestData:function(){var a=c.applyFeedlistRd;return _.isFunction(a)&&(a=a(n)),_.extend({circleID:0,subType:k,feedType:v,keyword:_.str.trim(g.val())},a)},searchOpts:{inputSelector:g,btnSelector:h},feedRemindClickCb:function(){l(a)},itemWorktodoCb:m},c.feedlistConfig)),n.load(),f.data("feedList",n)),b.currentFeedList=n}).on("switch",function(a,b){k(this.get("panels").eq(b))}),i.trigger("switched",0,-1),e.data("rendered",!0),e.data("subTabs",i)))}).on("switch",function(a,b){k(this.get("panels").eq(b))}),l(a);var n=!0;e.event.on("switched",function(c){c==b.tplName?(n||(b.createRightSbContent&&b.createRightSbContent(),l(a)),n=!1):b.currentFeedList&&b.currentFeedList.lazyload.stop()}),h.click(function(){b.currentFeedList.pagination.reset(),b.currentFeedList.reload()}),this.feedListTabs=a},addFeedToMain:function(a){var b=this.currentFeedList;a=[].concat(a),_.each(a,function(a){b.unshiftFromFeedId(a)}),$(".feed-demo-wrapper",b.element).remove()},rightSideBarInit:function(){var a=this,b=this.tplEl,d=f.getContactData(),e=d.u,h=f.getEnterpriseConfig(107,!0)||{},i=$(".home-right-content",b),j=$(".right-img-wrap",b),k=$(".right-htitle-wrap",b),m=$(".todolist-wrapper",b),n=$(".right-todolist-wrap",m),o=$(".right-votes-wrap",b),p=$(".right-fixedtopics-wrap",b),q=$(".right-newtopics-wrap",b),r=$(".fs-schedule-holder",b),s=$(".add-schedule-l",b),t=new l({trigger:r,scheduleDeleteCb:function(b,c){var d,e,f,g=a.currentFeedList,h=g.element;b.success&&(e=b.value,f=c.feedID,d=$('[feedid="'+f+'"]',h).closest(".list-item"),d.length>0&&d.slideUp(600))}});s.click(function(a){t.showAddDialog(new Date),a.preventDefault()}),$(c).scroll(function(){$(c).resize().unbind("scroll",arguments.callee)});var u=function(a){var b=[];_.each(a,function(a){b.push({startDate:new Date(1e3*a.startTime),creatorId:a.creatorID})}),t.set("scheduleDate",b)},v=t.getCurrentMonthRange(),w=function(a,b){a=a||"show";var c=$(b),d=$(".worktodo-icopenoff",c),e=$(".worktodo-item-control",c),f=$(".worktodo-item",c);"show"==a?(f.show(),d.html("收起"),e.removeClass("worktodo-item-open"),e.addClass("worktodo-item-off"),c.data("status","show")):(f.hide().slice(0,10).show(),d.html("展开"),e.removeClass("worktodo-item-off"),e.addClass("worktodo-item-open"),c.data("status","hide"))},x=$(".worktodo-item-control",b);x.on("click",function(){var a=$(".worktodo-icopenoff",m),b=a.html();"展开"==b?w("show",m):w("hide",m)});var y=function(){f.api({type:"get",data:{circleID:"0",startTimeTicks:g(v.startDate).unix(),endTimeTicks:g(v.endDate).unix()},url:"/globalInfo/getShortcutInfo",success:function(a){var b,c=d.p;if(a.success){b=a.value.inCircleEmployeeIDs||[],b.length>14&&(b=b.slice(0,14)),j.empty(),_.each(b,function(a){var b=_.find(c,function(b){return b.id==a});if(b){var d=b.name,e=b.id,f=b.profileImage,g="<a href='#profile/=/empid-"+e+"' title='"+d+"'><img src='"+f+"' width='24' height='24' /></a>";j.append(g)}});var g;g=a.value.thisCircle,k.html("全部同事("+g.memberCount+')<span class="rt-apv right-yq-apv fn-hide"><a href="javascript:;" class="invite-apv fna-blue">邀请同事</a></span>'),d.u.isAdmin?($(".right-yq-apv",k).show(),!e.isDemoAccount&&h.IsShowInviteEmployeeTask&&f.showGuideTip($(".invite-apv",k),{leftTopIncrement:-5,rightTopIncrement:-5,rightLeftIncrement:-5,imageName:"invite-task.png",imagePosition:{top:"-100px",left:"-280px"},imagePlace:"left",renderCb:function(a,b,c,d){var e=$('<div class="fs-guide-shadow-link"></div>'),g=$('<div class="fs-guide-shadow-link"></div>');$(".fs-guide-group-bracket,.fs-guide-avatar-bracket,.fs-guide-send-receipt-bracket,.fs-guide-history-plan-bracket").css("visibility","hidden");var i=function(){h.IsShowInviteEmployeeTask=!1,f.setEnterpriseConfig(107,h,!0),f.updateEnterpriseConfig(107),b.remove(),c.remove(),$(".fs-guide-avatar-bracket").css("visibility","visible")};e.css({width:"26px",height:"26px",position:"absolute",top:"7px",left:"197px",cursor:"pointer"}).appendTo(a),g.css({width:"122px",height:"32px",position:"absolute",top:"129px",left:"46px",cursor:"pointer"}).appendTo(a),e.click(function(){i()}),g.click(function(){i()}),d.one("click",function(){i()})}})):$(".right-yq-apv",k).hide(),new C({trigger:$(".invite-apv",k)}).render();var l;if(l=a.value.toDoList,$(".todolist-count").text(l.length),l.length>0){n.empty(),_.each(l,function(a){var b,c,d="",f=a.creatorID,g=a.creatorName,h=a.isImportant;c=h?"color-red":"",d=f==e.id?a.title:'<span class="color-blue">'+g+"：</span>"+a.title,b="<li class='worktodo-item' worktodoid='"+a.workToDoListID+"'><input type='checkbox' class='is-complete' /><a href='#worktodo/tododetail/=/id-"+a.workToDoListID+"' class='tpl-nav-l "+c+"' title='"+a.title+"'>"+d+"</a></li>",n.append(b)});var r=$(".worktodo-icnumber",x);l.length>10?($(".worktodo-item",n).slice(0,10).show(),x.show(),r.html(l.length-10),m.data("status","hide"),w("hide",m)):($(".worktodo-item",n).show(),x.hide())}else n.html("<li class='color-999999'>无待办事项</li>");n.find(">li>input[type=checkbox]").click(function(){1==$(this).prop("checked")?$(this).next().css("text-decoration","line-through"):$(this).next().css("text-decoration","none")});var s;s=a.value.fixedTopics,s.length<1?$(".fixedtopics-wrapper").hide():$(".fixedtopics-wrapper").show(),p.empty(),_.each(s,function(a){var b,c=a.topicID;b="<li><a href='#stream/showtopic/=/id-"+c+"' class='tpl-nav-l fna-blue'>#"+a.name+"#</a><span class='rfl-li-apv color-999999'>"+a.count+"</span></li>",p.append(b)});var t;t=a.value.newTopics,t.length<1?$(".newtopics-wrapper").hide():$(".newtopics-wrapper").show(),q.empty(),_.each(t,function(a){var b,c=a.topicID;b="<li><a href='#stream/showtopic/=/id-"+c+"' class='tpl-nav-l fna-blue'>#"+a.name+"#</a><span class='rfl-li-apv color-999999'>"+a.count+"</span></li>",q.append(b)});var v;v=a.value.votes,v.length>10&&(v=v.slice(0,10)),v.length<1?$(".right-votes-title-wrap").hide():$(".right-votes-title-wrap").show(),o.empty(),_.each(v,function(a){var b,c=a.feedID;b="<li class='hr-vote'><a href='#stream/showfeed/=/id-"+c+"/showvotedetail-1' class='fna-blue'>"+a.title+"</a></li><li class='padL25 color-999999'>已有"+a.voteEmpCount+"人参与</li>",o.append(b)}),u(a.value.scheduleDates),f.tplRouterReg($(".tpl-nav-l",i))}}})};y(),f.tplRouterReg("#stream/showfeed/=/:id-:value"),f.tplRouterReg("#stream/showfeed/=/:id-:value/:pn-:value"),f.tplRouterReg("#stream/showfeed/=/:id-:value/:showvotedetail-:value"),this.createRightSbContent=y,function(){var a=$(".right-todolist-wrap",b),c=$(".add-worktodo-l",b),d=function(a,b,c,d){f.api({type:"post",data:{workToDoListID:b,isCompleted:a},url:"/worktodolist/setIsCompleted",success:function(a){a.success&&c.call(this,a)}},{mask:d})};new B({trigger:c,successCb:function(){y(),this.hide()}}),a.on("change",".is-complete",function(a){var b=$(a.currentTarget),c=b.closest(".worktodo-item"),e=$(".is-complete",c),f=c.attr("worktodoid");e.prop("checked")?d(!0,f,function(){c.addClass("worktodo-state-undone")},b):d(!1,f,function(){c.removeClass("worktodo-sstate-undone")},b)}).on("mouseenter",".worktodo-item",function(a){var b=$(a.currentTarget),c=b.find(".is-complete");c.prop("checked")?c.attr("title","点击设置为未完成"):c.attr("title","点击设置为已完成")}),f.tplRouterReg("#worktodo/tododetail/=/:id-:value")}(),_.some(e.functionPermissions,function(a){return 1==a.value})?($(".right-notice-wrap",b).show(),new z({trigger:$(".add-notice-l",b),successCb:function(b,c){var d;b.success&&(a.addFeedToMain(b.value),d=c.title,a.noticeBanner&&a.noticeBanner.addItem('公告：<time class="color-999999">'+g.unix(b.serviceTime).format("MM-DD")+"</time> "+d+'（<a href="#stream/showfeed/=/id-'+b.value+'" class="fna-blue">详情</a>）',0),this.hide())}})):$(".right-notice-wrap",b).hide()},otherInit:function(){var a=this,b=this.tplEl;f.api({type:"get",data:{},url:"/FeedAnnounce/GetAnnouncesOfIsShow",success:function(c){if(c.success){var d=c.value,e=[];d.length<1?$(".main-announcement",b).hide():(_.each(d,function(a,b){var c=a.isShowTime,d=a.title,f=a.feedID;e[b]='公告：<time class="color-999999">'+g.unix(c).format("MM-DD")+"</time> "+d+'（<a href="#stream/showfeed/=/id-'+f+'" class="fna-blue">详情</a>）'}),a.noticeBanner=new A({element:$(".main-announcement",b),data:e}))}}}),e.event.on("switched",function(b){b==a.tplName&&a.noticeBanner&&a.reRenderNoticeBanner()})},reRenderNoticeBanner:function(){var a=this.noticeBanner,b=this.tplEl;f.api({type:"get",data:{},url:"/FeedAnnounce/GetAnnouncesOfIsShow",success:function(c){if(c.success){var d=c.value,e=[];d.length<1?$(".main-announcement",b).hide():(_.each(d,function(a,b){var c=a.isShowTime,d=a.title,f=a.feedID;e[b]='公告：<time class="color-999999">'+g.unix(c).format("MM-DD")+"</time> "+d+'（<a href="#stream/showfeed/=/id-'+f+'" class="fna-blue">详情</a>）'}),a.updateData(e))}}})},publishErrorHl:function(a){var b=$(a);f.showInputError(b)},regValidator:function(a){var b=this,c=this.opts,d=c.publishCb,e=c.refreshAfterPublish,g=a.validator,h=a.media,i=a.sendPath,j=a.isValid,k=a.clear,l=a.getRequestData,m=a.groupAt,o=a.getPersonalConfig,p=a.updateSbAcInitData,q=a.feedType,r=g.element,s=$(".panel-visible-h",r.closest(".fs-publish-panel"));g.on("formValidated",function(a){if(!a&&j()){var c=m(),g=c.noExist,t=c.noInclude,u=c.validAtContent,v=l(),w=function(){h.send(function(a){var c;v=_.extend(v,{fileInfos:l().fileInfos}),"share"==q&&0==v.circleIDs.length&&1==v.employeeIDs.length&&(c=f.getContactDataById(v.employeeIDs[0],"p"),c.id!=b.currentUserData.id&&(_.contains(u,c.name)||(v.content=v.content+"\n"+"@"+c.name)));var g=o();_.each(g,function(a,b){f.setPersonalConfig(b,a)}),p&&p(),f.updatePersonalConfig(),f.api({url:i,type:"post",data:v,success:function(c){c.success&&(c.value&&(e?b.currentFeedList&&b.currentFeedList.reload():b.addFeedToMain(c.value)),k(),s.click(),n.set("lastInputFeedInfo",null),d&&d.call(b,c,v)),a()}},{submitSelector:$('[type="submit"]',r)})},r.closest(".publish-wrapper"))},x=function(){var a,b=[],c=[],d=[],e=[];return _.some(v.circleIDs,function(a){return"999999"==a})?(w(),void 0):(t.length>0?(_.each(t,function(a){"p"==a.type?_.some(d,function(b){return b.id==a.id})||d.push(a):_.some(e,function(b){return b.id==a.id})||e.push(a)}),d.length>0&&(b.push(d.length+"人"),c=c.concat(_.map(d,function(a){return a.name}))),e.length>0&&(b.push(e.length+"部门"),c=c.concat(_.map(e,function(a){return a.name}))),b.length>0?(b="（共"+b.join("，")+"）",c=c.join("、")):(b="",c=""),a="您通过@提到当中 "+c+b+"不在您选择的范围中，是否要将这些人和部门包含在发布的范围当中",f.confirm(a,"提示",function(){v.employeeIDs=v.employeeIDs.concat(_.map(d,function(a){return a.id})),v.circleIDs=v.circleIDs.concat(_.map(e,function(a){return a.id})),w()},{onCancel:function(){}})):w(),void 0)},y=function(){g.length>0?f.confirm("您通过@提到当中 "+g.join(",")+"不是员工姓名或部门的名称，是否继续？","提示",function(){x()},{onCancel:function(){}}):_.some(v.circleIDs,function(a){return"999999"==a})?w():x()};-1!=v.content.search("附件")&&0==v.fileInfos.length?f.confirm("您在正文的文字中提到了“附件”，但是您却没有添加任何附件。是否确定发布不含附件的信息？","提示",function(){y()}):y()}})}}),i.mixTo(D),b.init=function(){var a,c=b.tplEl,e=b.tplName;o.init(c,e),a=new D({feedListSuccessCb:function(b,c){var e,f,g=c.feedType,h=c.keyword,i=a.currentFeedList,j="";if(b.success&&0==b.value.items.length&&0==h.length){if(e=$(".feed-list-inner",i.element),f=$(".list-empty-tip",i.element),$(".list-item",e).length>0)return;if(e.data("hideDemo"))return;0==g?_.each(["share","share-2","plan","work"],function(a){j+='<li class="feed-demo-item"><img src="'+d.ASSETS_PATH+"/images/feed-demo/"+a+'.png" alt="" /></li>'}):1==g?j+='<li class="feed-demo-item"><img src="'+d.ASSETS_PATH+'/images/feed-demo/share.png" alt="" /></li>':2==g?j+='<li class="feed-demo-item"><img src="'+d.ASSETS_PATH+'/images/feed-demo/plan.png" alt="" /></li>':3==g?j+='<li class="feed-demo-item"><img src="'+d.ASSETS_PATH+'/images/feed-demo/work.png" alt="" /></li>':4==g&&(j+='<li class="feed-demo-item"><img src="'+d.ASSETS_PATH+'/images/feed-demo/share-2.png" alt="" /></li>'),j='<ul class="feed-demo-list">'+j+"</ul>",j='<div class="demo-readme"><p>欢迎您加入纷享平台！以下为<span class="state-hl">模拟信息</span>，便于您初次了解主要功能，阅读后可选择关闭，您也可以在帮助中心重新点击查看。</p><span class="close-l"></span></div>'+j,j+='<div class="demo-bbar"><a class="close-l" href="javascrip:;">关闭</a></div>',e.html('<div class="feed-demo-wrapper">'+j+"</div>"),f.hide(),$(".close-l",e).click(function(a){f.show(),e.empty().data("hideDemo",!0),a.preventDefault()})}}})},b.Stream=D});