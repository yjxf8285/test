/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-09-02
 */
define("tpls/funcpermission/funcpermission",["modules/fs-qx/fs-qx-helper","util"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.store,e.event;var f=a("modules/fs-qx/fs-qx-helper"),g=f.JoinDialog,h=a("util");b.init=function(){var a=b.tplEl;b.tplName;var c=d.getAppStore("globalData"),e=$("#flag-system-admin",a),f=$(".flag-name-list",e),i=$(".fna-count",e),j=$("#flag-notice-admin",a),k=$(".flag-name-list",j),l=$(".fna-count",j),m=$("#flag-topic-admin",a),n=$(".flag-name-list",m),o=$(".fta-count",m),p=$("#flag-financial-admin",a),q=$(".flag-name-list",p),r=$(".ffa-count",p),s=$("#flag-personnel-admin",a),t=$(".flag-name-list",s),u=$(".fpa-count",s),v=$("#flag-work-admin",a),w=$(".flag-name-list",v),x=$(".fca-count",v),y=$("#flag-plan-admin",a),z=$(".flag-name-list",y),A=$(".fca-count",y),B=$("#flag-location-admin",a),C=$(".flag-name-list",B),D=$(".fca-count",B),E=$("#flag-customer-admin",a),F=$(".flag-name-list",E),G=$(".fca-count",E),H=$("#flag-marketing-admin",a),I=$(".flag-name-list",H),J=$(".fma-count",H),K=function(b){b=$.extend({element:a},b||{}),this.opts=b,this.element=b.element,this.init()};$.extend(K.prototype,{init:function(){this.fetch(),this.renderEmployeesDialog(),this.getAllShortEmployees(),this.bindEvents()},getAllShortEmployees:function(){var a=this;h.api({url:"/Management/GetAllShortEmployees",type:"get",dataType:"json",data:{},success:function(b){var c=b.value;b.success&&(_.each(c,function(a){a.id=a.employeeID}),a.allEmployeesData=c)}})},bindEvents:function(){var b=this,c=this.element,d=$(".tpl-c",a).find(".tpl-inner"),e=$(".flag-cenm-wrap",d);c.on("click",".flag-left-list li a",function(){var b=$(this),c=b.attr("section");c&&($(".flag-left-list li a",a).removeClass("fl-item-on"),b.addClass("fl-item-on"),e.hide(),e.filter("#flag-"+c+"-admin").show())}),c.on("click",".j-modifypermissions-btn",function(){var a=$(this);h.api({type:"get",data:{},url:"/Management/GetAllFunctionPermissions",success:function(c){if(c.success){var d=c.value.permissions[0]||[];if(i.html(d.length),_.each(d,function(a){a.id=a.employeeID}),d.length>0){var e="";_.each(d,function(a){var b=a.name;e+="<li>"+b+"</li>"}),f.html(e)}else f.html("无数据！");var g=c.value.permissions[1]||[];if(l.html(g.length),_.each(g,function(a){a.id=a.employeeID}),g.length>0){var e="";_.each(g,function(a){var b=a.name;e+="<li>"+b+"</li>"}),k.html(e)}else k.html("无数据！");var h=c.value.permissions[2]||[];if(_.each(h,function(a){a.id=a.employeeID}),o.html(h.length),h.length>0){var j="";_.each(h,function(a){var b=a.name;j+="<li>"+b+"</li>"}),n.html(j)}else n.html("无数据！");var m=c.value.permissions[3]||[];if(_.each(m,function(a){a.id=a.employeeID}),r.html(m.length),m.length>0){var p="";_.each(m,function(a){var b=a.name;p+="<li>"+b+"</li>"}),q.html(p)}else q.html("无数据！");var s=c.value.permissions[4]||[];if(_.each(s,function(a){a.id=a.employeeID}),u.html(s.length),s.length>0){var v="";_.each(s,function(a){var b=a.name;v+="<li>"+b+"</li>"}),t.html(v)}else t.html("无数据！");var y=c.value.permissions[5]||[];if(_.each(y,function(a){a.id=a.employeeID}),x.html(y.length),y.length>0){var v="";_.each(y,function(a){var b=a.name;v+="<li>"+b+"</li>"}),w.html(v)}else w.html("无数据！");var B=c.value.permissions[6]||[];if(_.each(B,function(a){a.id=a.employeeID}),A.html(B.length),B.length>0){var v="";_.each(B,function(a){var b=a.name;v+="<li>"+b+"</li>"}),z.html(v)}else z.html("无数据！");var E=c.value.permissions[7]||[];if(_.each(E,function(a){a.id=a.employeeID}),D.html(E.length),E.length>0){var v="";_.each(E,function(a){var b=a.name;v+="<li>"+b+"</li>"}),C.html(v)}else C.html("无数据！");var H=c.value.permissions[31]||[];if(_.each(H,function(a){a.id=a.employeeID}),G.html(H.length),H.length>0){var K="";_.each(H,function(a){var b=a.name;K+="<li>"+b+"</li>"}),F.html(K)}else F.html("无数据！");var L=c.value.permissions[21]||[];if(_.each(L,function(a){a.id=a.employeeID}),J.html(L.length),L.length>0){var M="";_.each(L,function(a){var b=a.name;M+="<li>"+b+"</li>"}),I.html(M)}else I.html("无数据！");b.permissionsDataSystem=d,b.permissionsData=g,b.permissionsDataTopic=h,b.permissionsDataFinancial=m,b.permissionsDataPersonnel=s,b.permissionsDataWork=y,b.permissionsDataPlan=B,b.permissionsDataLocation=E,b.permissionsDataCustomer=H,b.permissionsDataMarketing=L,b.setDialogType(a),b.employeesDialog.show()}}})})},setDialogType:function(a){var b=this.employeesDialog;a.is(".j-system")&&(this.setInitData(0,this.permissionsDataSystem),b.setTitle("修改系统管理员权限人")),a.is(".j-data")&&(this.setInitData(1,this.permissionsData),b.setTitle("修改公告管理员权限人")),a.is(".j-top")&&(this.setInitData(2,this.permissionsDataTopic),b.setTitle("修改话题管理员权限人")),a.is(".j-financial")&&(this.setInitData(3,this.permissionsDataFinancial),b.setTitle("修改财务审批管理员权限人")),a.is(".j-personnel")&&(this.setInitData(4,this.permissionsDataPersonnel),b.setTitle("修改人事审批管理员权限人")),a.is(".j-work")&&(this.setInitData(5,this.permissionsDataWork),b.setTitle("修改指令管理员权限人")),a.is(".j-plan")&&(this.setInitData(6,this.permissionsDataPlan),b.setTitle("修改日志管理员权限人")),a.is(".j-location")&&(this.setInitData(7,this.permissionsDataLocation),b.setTitle("修改定位管理员权限人")),a.is(".j-customer")&&(this.setInitData(31,this.permissionsDataCustomer),b.setTitle("修改客户管理员权限人")),a.is(".j-market")&&(this.setInitData(21,this.permissionsDataMarketing),b.setTitle("修改促销宝管理员权限人"))},setInitData:function(a,b){var c=this.employeesDialog,d=this,e=[];_.each(b,function(a){e.push(a.id)});var f=h.excludeDataByKey(e,"id",d.allEmployeesData);c.setInitData({joinData:b,unjoinData:f}),c.set("successCb",function(){var b=this.joinList.getDataState(),c=b.lost,e=b.add,f=[],g=[],h={};_.each(e,function(a){g.push(a.employeeID)}),_.each(c,function(a){f.push(a.employeeID)}),h={functionNo:a,addEmployeeIDs:g,deleteEmployeeIDs:f},d.modifyFunctionNoEmployees(h)})},renderEmployeesDialog:function(){this.employeesDialog=new g({unjoinLabel:"未选员工",joinLabel:"已选员工",unit:"项",bbarUnit:"人",inputPlaceholder:"输入关键词，快速筛选员工",unjoinEmptyTip:"没有未选员工",unjoinSearchEmptyTip:"没有筛选条件为{{keyword}}的员工",joinEmptyTip:"没有已选员工",joinSearchEmptyTip:"没有筛选条件为{{keyword}}的员工"}).render()},modifyFunctionNoEmployees:function(a){var b=this,c=this.employeesDialog;h.api({url:"/Management/ModifyFunctionNoEmployees",type:"post",dataType:"json",data:a,beforeSend:function(){},success:function(a){a.success&&(c.hide(),b.fetch())}},{submitSelector:$(".f-sub",c.element)})},fetch:function(){var a=this;h.api({type:"get",data:{},url:"/Management/GetAllFunctionPermissions",success:function(b){if(b.success){var c=b.value.permissions[0]||[];if(i.html(c.length),_.each(c,function(a){a.id=a.employeeID}),c.length>0){var d="";_.each(c,function(a){var b=a.name;d+="<li>"+b+"</li>"}),f.html(d)}else f.html('<span class="funcpermission-list-empty-tip">未分配系统管理员。</span>');var e=b.value.permissions[1]||[];if(l.html(e.length),_.each(e,function(a){a.id=a.employeeID}),e.length>0){var d="";_.each(e,function(a){var b=a.name;d+="<li>"+b+"</li>"}),k.html(d)}else k.html('<span class="funcpermission-list-empty-tip">未分配公告管理员。</span>');var g=b.value.permissions[2]||[];if(_.each(g,function(a){a.id=a.employeeID}),o.html(g.length),g.length>0){var h="";_.each(g,function(a){var b=a.name;h+="<li>"+b+"</li>"}),n.html(h)}else n.html('<span class="funcpermission-list-empty-tip">未分配话题管理员。</span>');var j=b.value.permissions[3]||[];if(_.each(j,function(a){a.id=a.employeeID}),r.html(j.length),j.length>0){var m="";_.each(j,function(a){var b=a.name;m+="<li>"+b+"</li>"}),q.html(m)}else q.html('<span class="funcpermission-list-empty-tip">未分配财务审批管理员。</span>');var p=b.value.permissions[4]||[];if(_.each(p,function(a){a.id=a.employeeID}),u.html(p.length),p.length>0){var s="";_.each(p,function(a){var b=a.name;s+="<li>"+b+"</li>"}),t.html(s)}else t.html('<span class="funcpermission-list-empty-tip">未分配人事审批管理员。</span>');var v=b.value.permissions[5]||[];if(_.each(v,function(a){a.id=a.employeeID}),x.html(v.length),v.length>0){var s="";_.each(v,function(a){var b=a.name;s+="<li>"+b+"</li>"}),w.html(s)}else w.html('<span class="funcpermission-list-empty-tip">未分配指令管理员。</span>');var y=b.value.permissions[6]||[];if(_.each(y,function(a){a.id=a.employeeID}),A.html(y.length),y.length>0){var s="";_.each(y,function(a){var b=a.name;s+="<li>"+b+"</li>"}),z.html(s)}else z.html('<span class="funcpermission-list-empty-tip">未分配日志管理员。</span>');var B=b.value.permissions[7]||[];if(_.each(B,function(a){a.id=a.employeeID}),D.html(B.length),B.length>0){var s="";_.each(B,function(a){var b=a.name;s+="<li>"+b+"</li>"}),C.html(s)}else C.html('<span class="funcpermission-list-empty-tip">未分配定位管理员。</span>');var E=b.value.permissions[31]||[];if(_.each(E,function(a){a.id=a.employeeID}),G.html(E.length),E.length>0){var H="";_.each(E,function(a){var b=a.name;H+="<li>"+b+"</li>"}),F.html(H)}else F.html('<span class="funcpermission-list-empty-tip">未分配客户管理员。</span>');var K=b.value.permissions[21]||[];if(_.each(K,function(a){a.id=a.employeeID}),J.html(K.length),K.length>0){var L="";_.each(K,function(a){var b=a.name;L+="<li>"+b+"</li>"}),I.html(L)}else I.html('<span class="funcpermission-list-empty-tip">未分配促销宝管理员。</span>');a.permissionsDataSystem=c,a.permissionsData=e,a.permissionsDataTopic=g,a.permissionsDataFinancial=j,a.permissionsDataPersonnel=p,a.permissionsDataWork=v,a.permissionsDataPlan=y,a.permissionsDataLocation=B,a.permissionsDataCustomer=E,a.permissionsDataMarketing=K}}})},destroy:function(){}}),new K,2==c.model?($(".tpl-l .flag-left-list li",a).hide(),$(".left-item-marketing",a).show().click()):1==c.model&&$(".left-item-marketing",a).hide()}});