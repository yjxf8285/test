/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-chart/mainchart",["raphael","uilibs/chart/linechart","uilibs/chart/funnelchart_a","uilibs/chart/funnelchart_b","uilibs/chart/bubblechart","modules/crm-chart/crm-chart.css","util"],function(a,b){var c=window;c.FS;var d=a("raphael"),e=a("uilibs/chart/linechart"),f=a("uilibs/chart/funnelchart_a"),g=a("uilibs/chart/funnelchart_b"),h=a("uilibs/chart/bubblechart");a("modules/crm-chart/crm-chart.css");var i=a("util"),j=function(){this._init_.apply(this,arguments)};j.extend=function(a,b){var c,d=this;c=a&&_.has(a,"constructor")?a.constructor:function(){return d.apply(this,arguments)},_.extend(c,d,b);var e=function(){this.constructor=c};return e.prototype=d.prototype,c.prototype=new e,a&&_.extend(c.prototype,a),c.__super__=d.prototype,c},j.prototype={transMonth:function(a){var b=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],c=a[0].monthNo-1,d=a.length,e=c+d;return b.slice(c,e)},getXaxis:function(a){var b=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],c=0,d=120;switch(a){case 1:break;case 2:b=b.slice(0,6),d=60;break;case 3:b=b.slice(6,12),c=60;break;case 4:b=b.slice(0,3),d=30;break;case 5:b=b.slice(3,6),c=30,d=60;break;case 6:b=b.slice(6,9),c=60,d=90;break;case 7:b=b.slice(9,12),c=90,d=120}return{label:b,start:c,end:d}},maxY:function(a){var b=_.max(a,function(a){return a.salesTargetAmount}),c=_.max(a,function(a){return a.winAmount});return _.max([b.salesTargetAmount,c.winAmount])},transMax:function(a){return a=a>1e3?100*Math.ceil(1.1*a/100):a>100?10*Math.ceil(1.1*a/10):Math.ceil(1.1*a)},destory:function(){this.chart.destory(),this.element.empty()},colorlist:["#1ED2DC","#0BA6DA","#277EBF","#5153AA","#A434A6","#DC50AA","#EE5582","#F03C3C","#F3674C","#FF963C"],getColor:function(a,b){var c=this.colorlist,d=c.length,e="#ffffff";switch(a){case 0:e=c[0];break;case b-1:e=c[d-1];break;default:var f=Math.floor(d/(b-1)),g=a*f;g>d-1&&(g=d-1),e=c[g]}return e},apipath:"",beforeLoading:function(){this.element.parent().addClass("crm-chart-list-loadingcard")},unLoading:function(){this.element.parent().removeClass("crm-chart-list-loadingcard")},ASYNC:!1,TIMEOUT:200,send:function(a){var a=_.extend({async:this.ASYNC,timeout:this.TIMEOUT},a);i.api(a,{loadingType:1})}};var k=j.extend({_init_:function(a,b){this.element=$(a),this.chart=new e({element:a}),this._resizeState_=!1,this.attr={path:this.apipath+"/SalesStatistic/GetSalesTargetChartOfEmployee"},this.update(b)},trans:function(a){var b=this.transMonth(a),c=this.transMax(this.maxY(a)),e=[],f=[],g=[],h=0,i=0;_.each(a,function(a){var b,c,d=a.salesTargetAmount,j=a.winAmount;h+=d,i+=j,j>=d?(b=j,c=0):(b=0,c=j),e.push(d),f.push(b),g.push(c)});var j;j=h?Math.round(100*(i/h)):0,h=d.fn.transNumber(h),i=d.fn.transNumber(i);var k={xAxis:b,yAxis:{max:c,linenum:4},title:"全年已完成￥"+i+"("+j+"%)"+"，目标￥"+h,template:"{{num}}月已完成￥{{Raphael.fn.transNumber(dataa||datac)}} ({{ datab ? Math.round((dataa||datac)/datab*100):0 }}%) ,  目标￥{{Raphael.fn.transNumber(datab)}}",width:680,height:340,topgutter:60,bottomgutter:90,series:[{name:"已完成已达标",mark:"dataa",type:"cube",data:f,color:"#77cc77",width:28},{name:"已完成未达标",mark:"datac",type:"cube",data:g,color:"red",width:28},{name:"目标",mark:"datab",type:"line",data:e,color:"#1b9dde"}]};return k},update:function(a){var b=this;$(window);var c=this.attr.path;this.beforeLoading(),b.send({type:"GET",url:c,data:a,success:function(a){b.unLoading();var c=b.trans(a.value.salesTargetChartItems);c.width=b.element.width(),b.info=JSON.parse(JSON.stringify(c)),b.destory(),b.chart.render(c)}})},_resize:function(){var a=this;a._time&&clearTimeout(a._time),a._time=setTimeout(function(){var b=JSON.parse(JSON.stringify(a.info));b.width=a.element.width(),a.chart.destory(),a.chart.render(b)},100)}}),l=j.extend({_init_:function(a,b){this.element=$(a),this.chart=new f({element:a}),this.attr={path:this.apipath+"/SalesStatistic/GetSalesFunnelDataOfEmployee",template:'<div class="crm-chart-b-text"><div class="crm-chart-b-text-first"><p> <b>最大成交金额</b><span>￥ {{max}}</span> </p></div> <div><p><b>预测总金额</b><span>￥ {{forecast}}</span></p></div><div><p><b>目标金额</b><span>￥ {{goal}}</span></p></div></div>'},this.template=_.template(this.attr.template),this._resizeState_=!1,this.update(b)},trans:function(a){for(var b,c,d,e=this,f=[],g=0,h=0;h<a.length;h++)a[h].name.length>8&&(a[h].name=a[h].name.slice(0,7)+"..."),b=a[h].name+"("+a[h].winRate+"%)",c=a[h].amount,d=e.getColor(h,a.length),g+=c,f.push([b,c,d]);var i={width:450,height:267,toppadding:0,bottompadding:0,rightpadding:300,title:"Sales funnel",series:{name:"Unique users",label:function(a){return"￥"+a},data:f},max:g};return i},update:function(a){var b=this;$(window);var c=this.attr.path;this.beforeLoading(),b.send({type:"GET",url:c,data:a,success:function(a){b.unLoading();var c=b.trans(a.value.pipelineColumns);c.width=b.element.width(),b.info=JSON.parse(JSON.stringify(c)),b.destory(),b.chart.render(c);var d={goal:b.chart.paper.transNum(a.value.salesTargetAmount,2),max:b.chart.paper.transNum(c.max,2),forecast:b.chart.paper.transNum(a.value.salesForecastAmount,2)};b.element.append(b.template(d))}})},_resize:function(){var a=this;a._time&&clearTimeout(a._time),a._time=setTimeout(function(){a._frame()},100)},_frame:function(){var a=JSON.parse(JSON.stringify(this.info));a.width=this.element.width(),a.series.label=function(a){return"￥"+a},this.chart.destory(),this.chart.render(a)}}),m=j.extend({_init_:function(a,b){this.element=$(a),this.chart=new f({element:a}),this.attr={template:'<div class="crm-chart-b-text"><div class="crm-chart-b-text-first"><p> <b>最大成交金额</b><span>￥ {{max}}</span> </p></div> <div><p><b>预测总金额</b><span>￥ {{forecast}}</span></p></div><div><p><b>目标金额</b><span>￥ {{goal}}</span></p></div></div>'},this.template=_.template(this.attr.template),this._resizeState_=!1,this.update(b)},trans:function(a){for(var b,c,a=a[a.length-1],d=a.pipelineColumns,e=[],f=["#1ed2dc","#277ebf","#a434a6","#ee5582","#f3674c","#ff963c"],g=0,h=0;h<d.length;h++)d[h].name.length>8&&(d[h].name=d[h].name.slice(0,7)+"..."),b=d[h].name+"("+d[h].winRate+"%)",c=d[h].amount,g+=c,e.push([b,c,f[h]]);g+=a.winAmount,e.push(["赢单(100%)",a.winAmount,"#ff963b"]);var i={width:450,height:267,toppadding:0,bottompadding:0,rightpadding:300,title:"Sales funnel",series:{name:"Unique users",label:function(a){return"￥"+a},data:e},max:g};return i},update:function(a){var b=this;$(window);var c=a.value.salesForecastDataRows,d=b.trans(c);d.width=b.element.width(),b.info=JSON.parse(JSON.stringify(d)),b.destory(),b.chart.render(d);var e=c[c.length-1],f={goal:b.chart.paper.transNum(e.targetAmount,2),max:b.chart.paper.transNum(d.max,2),forecast:b.chart.paper.transNum(e.salesForecastAmount,2)};b.element.append(b.template(f))},_resize:function(){var a=this;a._time&&clearTimeout(a._time),a._time=setTimeout(function(){a._frame()},100)},_frame:function(){var a=JSON.parse(JSON.stringify(this.info));a.width=this.element.width(),a.series.label=function(a){return"￥"+a},this.chart.destory(),this.chart.render(a)}}),n=j.extend({_init_:function(a,b){this.element=$(a),this.chart=new h({element:a}),this.attr={path:this.apipath+"/SalesStatistic/GetSalesOppNotWinChartOfEmployee"},this._resizeState_=!1,this.update(b)},trans:function(a,b,c){var d=this;b=parseInt(b);for(var e,f={width:525,height:270,topgutter:30,bottomgutter:30,rightgutter:0,tip:"{{name}}:共{{num}}单,合计￥{{amount}}",xAxis:this.getXaxis(b),yAxis:{max:100,linenum:2,label:function(a){return a+"%"}}},g=[],h=0;h<a.length;h++)e=a[h].SalesStage.salesStageNo,g[e]||(g[e]={type:"num"},g[e].name=a[h].SalesStage.name+"("+a[h].SalesStage.winRate+"%)",g[e].data=[],g[e].color=d.getColor(e-1,c)),g[e].data.push([10*a[h].monthNo-5,a[h].SalesStage.winRate,parseFloat(a[h].amount)]);for(var i=1;i<g.length;i++)g[i]&&(g[i].data=d._transArray(g[i].data));return f.series=g,f},_transArray:function(a){for(var b=[],c=0;c<a.length;c++)if(!a[c].mark){a[c][3]={amount:a[c][2]},a[c][2]=1;for(var d=c+1;d<a.length;d++)a[c][0]==a[d][0]&&1!=a[d].mark&&(a[c][2]+=1,a[c][3].amount=a[c][3].amount+a[d][2],a[d].mark=!0);a[c][3].amount=Raphael.fn.transNum(a[c][3].amount,2),b.push(a[c]),a[c].mark=!0}return b},update:function(a){var b=this;$(window);var c=this.attr.path;this.beforeLoading(),b.send({type:"GET",url:c,data:a,success:function(c){b.unLoading(),b.destory();var d=b.trans(c.value.salesOpportunitys,a.salesForecastTimeRange,c.value.salesStages.length);b.chart.render(d)}})},_resize:function(){}}),o=j.extend({_init_:function(a,b){this.element=$(a),this.chart=new h({element:a}),this.attr={path:this.apipath+"/SalesStatistic/GetSalesOppNotWinChartOfEmployee"},this._resizeState_=!1,this.update(b)},trans:function(a,b,c){var d=this;b=parseInt(b);for(var e,f={width:525,height:270,topgutter:30,bottomgutter:30,rightgutter:0,tip:"{{mark}}\n预计成交日期 {{date}}\n预计成交金额 {{amount}}",xAxis:this.getXaxis(b),yAxis:{max:d.getMaxy(a),linenum:5}},g=[],h=0;h<a.length;h++){e=a[h].SalesStage.salesStageNo,g[e]||(g[e]={type:"normal"},g[e].name=a[h].SalesStage.name,g[e].data=[],g[e].color=d.getColor(e-1,c));var i=d.getXmonth(a[h].expectedDealTime),j=d.getDatestr(a[h].expectedDealTime);g[e].data.push([i,parseInt(a[h].amount),6,{mark:a[h].name,date:j,amount:Raphael.fn.transNum(a[h].amount,2)}])}return f.series=g,f},getMaxy:function(a){var b=_.max(a,function(a){return a.amount}).amount;return this.transMax(b)},getDatestr:function(a){a=1e3*a;var b=new Date(a),c=b.getFullYear(),d=b.getMonth()+1,e=b.getDate();return 10>d&&(d="0"+d),10>e&&(e="0"+e),c+"-"+d+"-"+e},getXmonth:function(a){a=1e3*a;var b=new Date(a),c=b.getMonth(),d=b.getDate();return 10*c+10*(d/31)},update:function(a){var b=this;$(window);var c=this.attr.path;this.beforeLoading(),b.send({type:"GET",url:c,data:a,success:function(c){b.unLoading(),b.destory();var d=b.trans(c.value.salesOpportunitys,a.salesForecastTimeRange,c.value.salesStages.length);b.chart.render(d)}})},_resize:function(){}}),p=j.extend({_init_:function(a,b){this.element=$(a),this.chart=new e({element:a}),this._resizeState_=!1,this.attr={path:this.apipath+"/SalesStatistic/GetContractPaymentChartOfRecord"},this.update(b)},trans:function(a){var b=[],c=0,d=0;_.each(a,function(a){var e=Math.round(a.value1);b.push(e),d+=e,e>c&&(c=e)}),c=this.transMax(c);var e={xAxis:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],yAxis:{max:c,linenum:5},title:"全年已回款￥"+Raphael.fn.transNumber(d),template:"{{num}}月已回款￥ {{Raphael.fn.transNumber(payment)}}",width:680,height:270,topgutter:50,bottomgutter:30,legend:!1,series:[{name:"回款金额",mark:"payment",type:"cube",data:b,color:"#77abdd"}]};return e},update:function(a){var b=this;$(window);var c=this.attr.path;this.beforeLoading(),b.send({type:"GET",url:c,data:a,success:function(a){b.unLoading();var c=b.trans(a.value.PaymentItems);c.width=b.element.width(),b.info=JSON.parse(JSON.stringify(c)),b.destory(),b.chart.render(c)}})},_resize:function(){}}),q=j.extend({_init_:function(a,b){this.element=$(a),this.chart=new e({element:a}),this._resizeState_=!1,this.attr={path:this.apipath+"/SalesStatistic/GetPaymentInfoChartOfContract"},this.update(b)},trans:function(a){var b=this,a=JSON.parse(JSON.stringify(a)),c=[],d=0,e=0;_.each(a,function(a){if(a.contractPaymentItems.length){var f=b._sum(a.contractPaymentItems);c.push(f),d+=f[0],e+=f[1]}else c.push([0,0])});var f=_.max(c,function(a){return a[0]})[0],g=_.max(c,function(a){return a[1]})[1],h=f>g?f:g;h=this.transMax(h);var i={xAxis:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],yAxis:{max:h,linenum:5},title:"全年合同签约金额￥"+Raphael.fn.transNumber(d)+",已回款￥"+Raphael.fn.transNumber(e),template:"{{num}}月合同签约金额￥ {{Raphael.fn.transNumber(paymentscale[0])}},  已回款￥ {{Raphael.fn.transNumber(paymentscale[1])}}",width:680,height:270,topgutter:50,bottomgutter:30,legend:!1,series:[{name:"合同金额,回款比例",mark:"paymentscale",type:"dbcube",data:c,color:"#bbbbbb",lcolor:"#ff6600"}]};return i},_sum:function(a){var b=0,c=0;return _.each(a,function(a){b+=a.contractAmount,c+=a.paymentAmount}),b=Math.round(b),c=Math.round(c),[b,c]},update:function(a){var b=this;$(window);var c=this.attr.path;this.beforeLoading(),b.send({type:"GET",url:c,data:a,success:function(a){b.unLoading();var c=b.trans(a.value.paymentChartItems);c.width=b.element.width(),b.info=JSON.parse(JSON.stringify(c)),b.destory(),b.chart.render(c)}})}}),r=j.extend({_init_:function(a,b){this.element=$(a),this.chart=new e({element:a}),this._resizeState_=!1,this.attr={path:this.apipath+"/SalesStatistic/GetWinOrderChartOfEmployee"},this.update(b)},trans:function(a){var b=[],c=0,d=0;_.each(a,function(a){var e=Math.round(a.winOrderCount);b.push(e),e>c&&(c=e),d+=e}),c=this.transMax(c);var e={xAxis:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],yAxis:{max:c,linenum:5},title:"全年已成交"+d+"单",template:"{{num}}月已成交{{Raphael.fn.transNumber(winamount)}}单",width:680,height:250,topgutter:30,bottomgutter:30,legend:!1,series:[{name:"赢单数量",mark:"winamount",type:"cube",data:b,color:"#77abdd"}]};return e},update:function(a){var b=this;$(window);var c=this.attr.path;this.beforeLoading(),b.send({type:"GET",url:c,data:a,success:function(a){b.unLoading();var c=b.trans(a.value.winOrderChartItems);c.width=b.element.width(),b.info=JSON.parse(JSON.stringify(c)),b.destory(),b.chart.render(c)}})},_resize:function(){}}),s=j.extend({_init_:function(a,b){this.element=$(a),this.chart=new e({element:a}),this._resizeState_=!1,this.attr={path:this.apipath+"/SalesStatistic/GetFCustomerContactNumChartOfEmployee"},this.update(b)},trans:function(a){var b=[],c=[],d=0,e=0,f=0;_.each(a,function(a){var g=Math.round(a.fCustomersCount),h=Math.round(a.contactsCount);b.push(g),c.push(h),e+=g,f+=h,g>h&&(h=g),h>d&&(d=h)}),d=this.transMax(d);var g={xAxis:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],yAxis:{max:d,linenum:5},title:"全年新增客户"+e+"个，新增联系人"+f+"个",template:"{{num}}月新增客户{{customer}}，新增联系人{{linkman}}",width:680,height:290,topgutter:30,bottomgutter:70,series:[{name:"客户",mark:"customer",type:"line",data:b,color:"#3597bc"},{name:"联系人",mark:"linkman",type:"line",data:c,color:"#f99945"}]};return g},update:function(a){var b=this;$(window);var c=this.attr.path;this.beforeLoading(),b.send({type:"GET",url:c,data:a,success:function(a){b.unLoading();var c=b.trans(a.value.fCustomerContactNumChartItems);c.width=b.element.width(),b.info=JSON.parse(JSON.stringify(c)),b.destory(),b.chart.render(c)}})},_resize:function(){}}),t=j.extend({_init_:function(a,b){this.element=$(a),this.attr={path:this.apipath+"/SalesStage/GetAllSalesStages"},this.update(b)},update:function(a){var b=this,c=this.attr.path;i.api({type:"GET",url:c,success:function(c){b.clear();var d=b._trans(c.value.salesStages);d.width=336,a=b.getStage(a),b.chart=new g({element:b.element[0],info:d},a)}},{loadingType:1})},_trans:function(a){for(var b=this,c=[],d=this.map=[],e=[],f=0;f<a.length;f++)1==a[f].inUse&&"输单"!=a[f].name&&e.push(a[f]);for(var g=0;g<e.length;g++)e[g].name.length>5&&(e[g].name=e[g].name.slice(0,4)+"..."),c.push([e[g].name+"("+e[g].winRate+"%)",b.getColor(g,e.length)]),d[e[g].salesStageNo]=g;var h={width:340,toppadding:0,bottompadding:0,rightpadding:175,title:"销售阶段",series:{name:"Salesstage",data:c}};return h},changeStage:function(a){a=this.getStage(a),this.chart.activeStage(a)},getStage:function(a){return a=parseInt(a),this.map[a]},clear:function(){this.element.empty()}});b.Typea=k,b.Typeb=l,b.Typeba=m,b.Typec=n,b.Typed=o,b.Typee=p,b.Typef=q,b.Typeg=r,b.Typeh=s,b.Salesstage=t});