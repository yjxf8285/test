/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-salesclue-edit/crm-salesclue-edit",["modules/crm-salesclue-edit/crm-salesclue-edit.html","dialog","util","modules/publish/publish-helper","moment"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-salesclue-edit/crm-salesclue-edit.html"),h=a("dialog"),i=a("util"),j=a("modules/publish/publish-helper");a("moment");var k=h.extend({attrs:{width:760,content:$(g).filter(".dialog-salesclue-template").html(),closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",className:"dialog-crm",salesclueData:void 0,salesclueID:void 0,marketingEventID:void 0},events:{"click .dialog-button-submit":"submit","click .dialog-button-cancel":"hide"},render:function(){var a=k.superclass.render.apply(this,arguments);return this.setupDoms(),this.setupComponent(),a},hide:function(){var a=k.superclass.hide.apply(this,arguments);return this.reset(),a},reset:function(){$(".dialog-input-text",this.element).val(""),$(".area-auto-height",this.element).val("").removeAttr("style"),i.mnSetter($(".salesclue-gender-radio",this.element),""),$(".mn-select-box",this.element).each(function(){i.mnReset($(this))})},show:function(){var a,b=this,c=this.get("salesclueID")?this.get("salesclueID"):void 0;return c?i.api({url:"/SalesClue/GetSalesClueByID",type:"get",dataType:"json",async:!1,data:{salesClueID:c},success:function(c){c.success&&c.value&&c.value.salesClues&&c.value.salesClues.length>0&&(a=k.superclass.show.apply(b,arguments),b.set("salesclueData",c.value.salesClues[0]),b.fillFormData())}},{submitSelector:""}):a=k.superclass.show.apply(this,arguments),a},submit:function(a){var b=this,c=this.get("salesclueData")?this.get("salesclueData"):void 0,d=this.get("salesclueID")?this.get("salesclueID"):void 0,e=this.get("marketingEventID")?this.get("marketingEventID"):0,f=$(a.currentTarget),g=this.element,h=$(".salesclue-name",g).val(),j=$(".salesclue-company",g).val(),k=i.mnGetter($(".salesclue-gender-radio",g)),l=$(".salesclue-post",g).val(),m=$(".salesclue-tel",g).val(),n=$(".salesclue-mobile",g).val(),o=$(".salesclue-email",g).val(),p=$(".salesclue-weibo",g).val(),q=$(".salesclue-weChat",g).val(),r=$(".salesclue-qq",g).val(),s=$(".salesclue-province",g).val(),t=$(".salesclue-address",g).val(),u=$(".salesclue-postCode",g).val(),v=$(".salesclue-description",g).val(),w=[],x=$(".salesclue-tags-list-warp > li",g);x.each(function(){var a=$(".f-business-tag-id",$(this)).data("fbusinesstagid"),b=$(".mn-select-box",$(this)),c=i.mnGetter(b)||0;w.push(a+","+c)}),c?i.api({url:"/SalesClue/UpdateSalesClue",type:"post",dataType:"json",errorMsgTitle:"修改线索发生错误，原因：",data:{salesclueID:d,name:h,company:j,gender:k,post:l,tel:m,mobile:n,email:o,weibo:p,weChat:q,qq:r,province:s,address:t,postCode:u,description:v,listTagOptionID:w},success:function(a){a.success&&(b.hide(),i.remind(2,"保存成功"),b.v&&b.v.refresh&&b.v.refresh(),b.trigger("success"))}},{submitSelector:f}):i.api({url:"/SalesClue/AddSalesClue",type:"post",dataType:"json",data:{marketingEventID:e,name:h,company:j,gender:k,post:l,tel:m,mobile:n,email:o,weibo:p,weChat:q,qq:r,province:s,address:t,postCode:u,description:v,listTagOptionID:w},success:function(a){a.success&&(b.hide(),i.remind(2,"添加成功"),b.v&&b.v.refresh&&b.v.refresh(),b.trigger("success"))}},{submitSelector:f})},setupDoms:function(){var a=this.element;this.conTextareaEl=$(".area-auto-height",a)},setupComponent:function(){var a=this.element,b=$(".salesclue-tags-list-warp",a);j.AdjustTextAreaSize({element:this.conTextareaEl});var c=i.getTagsByType(i.CONSTANT.TAG_TYPE.SALES_CLUE);_.each(c,function(a){var c=a.name,d=a.options,e="",f="";d.length>0?_.each(d,function(a){var b=a.isDefault;b?(f=a.name,e+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'" data-selected="'+b+'">'+a.name+"</li></ul>"):e+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'">'+a.name+"</li></ul>"}):e='<ul class="mn-select-list"><li class="mn-select-item" data-value="0"></li></ul>',b.append('<li class="fn-clear"> <div class="selects-tit inputs-tit f-business-tag-id" data-fbusinesstagid="'+a.fBusinessTagID+'"> '+c+' </div> <div class="selects-warp"> <span select-cls="" class="mn-select-box "><span class="mn-select-title-wrapper select-for-dialog"><span class="mn-select-title ">'+f+'</span><span class="title-icon"></span></span>'+e+"</span> </div> </li>")})},fillFormData:function(){var a=this.get("salesclueData")&&this.get("salesclueData"),b=this.element;a&&($(".salesclue-name",b).val(a.name),$(".salesclue-company",b).val(a.company),i.mnGetter($(".salesclue-gender-radio",b),a.gender),$(".salesclue-post",b).val(a.post),$(".salesclue-tel",b).val(a.tel),$(".salesclue-mobile",b).val(a.mobile),$(".salesclue-email",b).val(a.email),$(".salesclue-weibo",b).val(a.weibo),$(".salesclue-weChat",b).val(a.weChat),$(".salesclue-qq",b).val(a.qq),$(".salesclue-province",b).val(a.province),$(".salesclue-address",b).val(a.address),$(".salesclue-postCode",b).val(a.postCode),$(".salesclue-description",b).val(a.description),a.gender&&i.mnSetter($(".salesclue-gender-radio",b),a.gender),_.map(a.fBusinessTagRelations,function(a){a.fBusinessTagOptionID&&i.mnSetter($("[data-fbusinesstagid="+a.fBusinessTagID+"]",b).next().children(".mn-select-box"),a.fBusinessTagOptionID)}),$(".area-auto-height",b).trigger("autosize.resize"))}});c.exports=k});