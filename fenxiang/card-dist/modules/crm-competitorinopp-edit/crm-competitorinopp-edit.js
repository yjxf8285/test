/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-competitorinopp-edit/crm-competitorinopp-edit",["modules/crm-competitorinopp-edit/crm-competitorinopp-edit.html","dialog","util","modules/publish/publish-helper","uilibs/currency-input","moment"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-competitorinopp-edit/crm-competitorinopp-edit.html"),h=a("dialog"),i=a("util"),j=a("modules/publish/publish-helper"),k=a("uilibs/currency-input");a("moment");var l=h.extend({attrs:{width:760,content:$(g).filter(".dialog-competitorinopp-template").html(),closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",className:"dialog-crm",oppCompetitorRelations:void 0,salesOpportunityID:void 0,competitorID:void 0},events:{"click .dialog-button-submit":"submit","click .dialog-button-back":"_back","click .dialog-button-close":"hide","click .dialog-button-edit":"_showEditWrapper","click .dialog-button-cancel":"_showViewWrapper","click .left-list li":"_switchNav"},_back:function(){$(".base-info",this.element).trigger("click")},_showEditWrapper:function(){var a=this;this.set("flag","edit"),this.viewWrapper.hide(),this.sourceinfoWrapper.hide(),this.editWrapper.show(),this.editBtn.hide(),this.submitBtn.show(),this.cancelBtn.show(),this.closeBtn.attr("disabled",!0).css("opacity",".5"),$(".source-info").css({opacity:".5",cursor:"default"}),setTimeout(function(){$(".area-auto-height",a.element).trigger("autosize.resize")},1)},_showViewWrapper:function(){this.set("flag","view"),this.viewWrapper.show(),this.sourceinfoWrapper.hide(),this.editWrapper.hide(),this.editBtn.show(),this.backBtn.hide(),this.submitBtn.hide(),this.cancelBtn.hide(),this.backBtn.hide(),this.closeBtn.show().css("opacity","1").removeAttr("disabled"),$(".source-info").css({opacity:"1",cursor:"pointer"})},_showSourceInfoWrapper:function(){var a=this;this.viewWrapper.hide(),this.editWrapper.hide(),this.editBtn.hide(),this.closeBtn.hide(),this.backBtn.show(),this.sourceinfoWrapper.show();var b=this.get("oppCompetitorRelations")||void 0;this.get("competitorData"),b.competitorID&&i.api({url:"/Competitor/GetCompetitorByID",type:"get",dataType:"json",data:{competitorID:b.competitorID},success:function(b){b.success&&b.value&&b.value.competitors&&b.value.competitors.length>0&&(a.set("competitorData",b.value.competitors[0]),a.fillSourceInfoFormData())}},{submitSelector:""})},_switchNav:function(a){var b=$(a.target),c=this.get("flag")||"view";this.get("oppCompetitorRelations")||void 0,this.element,"view"==c&&(b.parent().children().addClass("unselected"),b.removeClass("unselected"),b.hasClass("source-info")?this._showSourceInfoWrapper():b.hasClass("base-info")&&this._showViewWrapper()),b.hasClass("base-info")&&this._showViewWrapper()},render:function(){var a=l.superclass.render.apply(this,arguments),b=this.element;return this.editBtn=$(".dialog-button-edit",b),this.closeBtn=$(".dialog-button-close",b),this.submitBtn=$(".dialog-button-submit",b),this.cancelBtn=$(".dialog-button-cancel",b),this.backBtn=$(".dialog-button-back",b),this.viewWrapper=$(".competitor-view-wrapper",b),this.sourceinfoWrapper=$(".competitor-sourceinfo-wrapper",b),this.editWrapper=$(".competitor-edit-wrapper",b),this.setupComponent(),a},hide:function(){var a=l.superclass.hide.apply(this,arguments);return this.reset(),a},reset:function(){var a=this.element,b=a.find(".competitor-edit-wrapper"),c=a.find(".competitor-view-wrapper"),d=a.find(".competitor-sourceinfo-wrapper");$(".div-view-text",c).html(""),$(".div-view-text",d).html(""),this.currencyInput.reset(),$(".area-auto-height",b).val("").removeAttr("style"),i.mnReset($(".winRate",b)),$(".base-info",a).click()},show:function(a){var b=this;this.element;var c=l.superclass.show.apply(this,arguments);a.salesOpportunityID&&this.set("salesOpportunityID",a.salesOpportunityID),a.competitorID&&this.set("competitorID",a.competitorID),a.flag&&this.set("flag",a.flag);var d=this.get("competitorID")||void 0,e=this.get("salesOpportunityID")||void 0,f=this.get("flag")||"view";return"edit"==f?this._showEditWrapper():"view"==f&&this._showViewWrapper(),d&&e&&i.api({url:"/SalesOpportunity/GetOppCompetitorRelationsByID",type:"get",dataType:"json",data:{salesOpportunityID:e,competitorID:d},success:function(a){a.success&&a.value&&a.value.oppCompetitorRelations&&a.value.oppCompetitorRelations.length>0&&(b.set("oppCompetitorRelations",a.value.oppCompetitorRelations[0]),b.fillFormData())}},{submitSelector:""}),c},submit:function(a){var b=this,c=this.element.find(".competitor-edit-wrapper"),d=this.get("oppCompetitorRelations")?this.get("oppCompetitorRelations"):void 0,e=this.get("salesOpportunityID")?this.get("salesOpportunityID"):void 0,f=this.get("competitorID")||void 0,g=$(a.currentTarget),h=$(".productDescription",c).val()||"",j=$(".advantage",c).val()||"",k=$(".disadvantage",c).val()||"",l=$(".strategies",c).val()||"",m=i.mnGetter($(".winRate",c))||10,n=this.currencyInput.val();return-1==n?(i.alert("请填写正确报阶"),void 0):(d&&i.api({url:"/SalesOpportunity/UpdateOppCompetitorRelation",type:"post",dataType:"json",data:{salesOpportunityID:e,competitorID:f,productDescription:h,advantage:j,disadvantage:k,strategies:l,winRate:m,price:n},success:function(a){a.success&&(b.hide(),i.remind(2,"保存成功"),b.v&&b.v.refresh&&b.v.refresh(),b.trigger("success"))}},{submitSelector:g}),void 0)},setupComponent:function(){var a=this.element;j.AdjustTextAreaSize({element:$(".area-auto-height",a)}),this.currencyInput=new k({element:$(".price",a.find(".competitor-edit-wrapper"))});for(var b=[],c=1,d=10;d>=c;c++)b.push({value:10*c+"",text:10*c+""});i.mnSelect($(".winRate",a.find(".competitor-edit-wrapper")),"syncModel",b)},fillFormData:function(){var a=this.get("oppCompetitorRelations")||void 0,b=this.element,c=b.find(".competitor-edit-wrapper"),d=b.find(".competitor-view-wrapper");a&&($(".name",d).text(a.name),$(".price",d).text(a.price),$(".winRate",d).text(a.winRate),$(".advantage",d).text(a.advantage),$(".disadvantage",d).text(a.disadvantage),$(".productDescription",d).text(a.productDescription),$(".strategies",d).text(a.strategies),$(".name",c).val(a.name),this.currencyInput.setValue(a.price),i.mnSetter($(".winRate",c),a.winRate),$(".advantage",c).val(a.advantage),$(".disadvantage",c).val(a.disadvantage),$(".productDescription",c).val(a.productDescription),$(".strategies",c).val(a.strategies),setTimeout(function(){$(".area-auto-height",c).trigger("autosize.resize")},1))},fillSourceInfoFormData:function(){var a=this.get("competitorData")||void 0,b=this.element.find(".competitor-sourceinfo-wrapper");if(a){$(".name",b).text(a.name),$(".competitorScaleTagOptionName",b).text(a.competitorScaleTagOptionName),$(".competitivenessTagOptionName",b).text(a.competitivenessTagOptionName),$(".advantage",b).text(a.advantage),$(".disadvantage",b).text(a.disadvantage),$(".productLineTagOptionName",b).text(a.productLineTagOptionName),$(".strategies",b).text(a.strategies),$(".salesSituation",b).text(a.salesSituation),$(".marketingSituation",b).text(a.marketingSituation),$(".contactInfo",b).text(a.contactInfo),$(".description",b).text(a.description);var c=$(".competitor-source-info-tag",b).empty();_.map(a.fBusinessTagRelations,function(a){var b=$('<li class="fn-clear"><div class="inputs-tit"></div><div class="input-warp"><input readonly class="dialog-input-text description" placeholder=""/></div></li>');b.find(".inputs-tit").html(a.fBusinessTagName),b.find(".dialog-input-text").html(a.fBusinessTagOptionName),c.append(b)})}}});c.exports=l});