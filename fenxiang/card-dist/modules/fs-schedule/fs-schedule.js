/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/fs-schedule/fs-schedule",["modules/publish/publish","dialog","mask","cardcalendar","modules/fs-reply/fs-reply","modules/fs-schedule/fs-schedule.html","modules/feed-list/feed-list","util","moment"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.event;var g=a("modules/publish/publish"),h=a("dialog"),i=(a("mask"),a("cardcalendar")),j=(a("modules/fs-reply/fs-reply"),a("modules/fs-schedule/fs-schedule.html")),k=a("modules/feed-list/feed-list"),l=a("util"),m=a("moment"),n=$(j),o=g.selectBar,p=g.mediaMaker,q=g.dateSelect,r=g.timeSelect,s=g.atInput,t="YYYY-MM-DD",u="YYYY年MM月DD日",v=l.getContactData(),w=v.u,x=new h({content:'<ul class="fs-schedule-range-list"></ul>',className:"fs-schedule-range-dialog",zIndex:1002,closeTpl:"",hasMask:!1,width:60,height:100});l.regGlobalClick(x.element,function(){x.element.is(":visible")&&x.hide()});var y=h.extend({attrs:{width:"540px",className:"fs-schedule-custom-alert-dialog",content:n.filter(".fs-schedule-custom-alert-tpl").html(),zIndex:1003},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel"},_renderCpt:function(){var a=this.element,b=$(".range-selectbar",a),c=new o({element:b,data:[{title:"部门",type:"g",list:v.g,unitSuffix:"个部门"},{title:"同事",type:"p",list:v.p}],title:"选择可视范围",autoCompleteTitle:"请输入部门或同事的名称或拼音"});this.sb=c},render:function(){var a=y.superclass.render.apply(this,arguments);return this._renderCpt(),a},show:function(){var a=y.superclass.show.apply(this,arguments);return a},hide:function(){var a=y.superclass.hide.apply(this,arguments);return this._clear(),a},_submit:function(){},_cancel:function(){this.hide()},destroy:function(){var a;return this.sb&&this.sb.destroy(),a=y.superclass.destroy.apply(this,arguments)}}),z=i.extend({attrs:{inputSelect:!1,className:"fs-schedule",scheduleDate:[],activeScheduleDate:"",scheduleDeleteCb:e.EMPTY_FN},events:{"click .card-calendar-date-panel .date-body td":"_showSchedule"},setup:function(){var a=this,b=z.superclass.setup.call(this);return this.addDialog=new h({content:n.filter(".fs-schedule-add-dialog").html(),className:"fs-schedule-add-dialog",zIndex:1001,width:572}),this.addDialog.after("hide",function(){a.clearAddDialog()}),this.manageDialog=new h({content:n.filter(".fs-schedule-manage-dialog").html(),className:"fs-schedule-manage-dialog",width:625,height:534}),this.customAlertDialog=new y,this.scheduleList=null,this.deleteStore=[this.addDialog,this.manageDialog],this._regEvents(),b},_onChangeCurrentDate:function(){var a=z.superclass._onChangeCurrentDate.apply(this,arguments),b=this.get("panelState");return"date"==b&&this.refreshScheduleDate(),a},_onChangePanelState:function(a){var b=z.superclass._onChangePanelState.apply(this,arguments);return"date"==a&&this.refreshScheduleDate(),b},_showSchedule:function(a){var b=$(a.currentTarget),c=b.data("date"),d=m(c,t);this.set("activeScheduleDate",c),b.hasClass("stamp-blue")||b.hasClass("stamp-red")?this.showManageDialog(d):this.showAddDialog()},showAddDialog:function(a){var b,c,d,e,f=this.addDialog,g=f.element,h=this.get("activeScheduleDate");e=a?m(a):m(h,t),f.rendered||this._renderAddDialog(),b=g.data("comp"),c=b.ds,d=b.ts,c.setValue(e),d.setValue(2),this.scheduleList&&this.scheduleList.hideItemSlideTip(),f.show()},clearAddDialog:function(){var a=this.addDialog,b=a.element,c=$(".is-sms",b),d=$(".sms-alert",b),e=$(".schedule-input",b),f=b.data("comp"),g=f.sb,h=f.ds,i=f.ts,j=f.media;g.removeAllItem(),g.addItem(w),h.clear(),i.clear(),d.val("1"),e.val("").trigger("autosize.resize"),j.resetAll(),c.prop("checked",!1)},hideAddDialog:function(){this.addDialog.hide()},showManageDialog:function(a){this.manageDialog.rendered||this._renderManageDialog(),$(".fs-schedule-manage-title",this.manageDialog.element).text(m(a).format(u)+"的日程"),this.manageDialog.show(),this.fetchScheduleList()},hideManageDialog:function(){this.manageDialog.hide(),this.scheduleList.empty(),this.refreshScheduleDate()},isPublishValid:function(){var a=this.getPublishRequestData(),b=this.addDialog,c=b.element,d=($(".is-sms",c),$(".sms-alert",c),$(".schedule-input",c)),e=c.data("comp"),f=e.sb,g=e.ds,h=e.ts,i=!0;return 0==a.scheduleContent.length&&(l.showInputError(d.closest(".schedule-input-wrapper")),i=!1),a.scheduleContent.length>2e3&&(l.alert("内容不超过2000字"),i=!1),0==a.circleIDs.length&&0==a.employeeIDs.length&&($(".input-wrapper",f.element).click(),i=!1),a.dateBlank&&(l.showInputError($("input",g.element)),i=!1),a.timeBlank&&(l.showInputError($("input",h.element)),i=!1),i},getPublishRequestData:function(){var a,b={},c=this.addDialog,d=c.element,e=$(".is-sms",d),f=$(".sms-alert",d),g=$(".schedule-input",d),h=d.data("comp"),i=h.sb,j=i.getSelectedData(),k=h.media,l=h.ds,n=l.getValue(),o=h.ts,p=o.getValue(),q=e.prop("checked"),r=f.val(),s=_.str.trim(g.val());return b.circleIDs=j.g||[],b.employeeIDs=j.p||[],a=k.getUploadValue(),b.fileInfos=[],_.each(a,function(a){"img"==a.uploadType?b.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&b.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),n.length>0&&p.length>0?b.startTimeTicks=m(n+" "+p,"YYYY-MM-DD HH:mm:ss").unix():(b.startTimeTicks="",n.length<=0&&(b.dateBlank=!0),p.length<=0&&(b.timeBlank=!0)),b.isImmediatelySendSms=q,b.smsRemindType=r,b.scheduleContent=s,b},getPersonalConfig:function(){var a=this.getPublishRequestData(),b=a.employeeIDs,c=a.circleIDs,d=c.join(",")+"|"+b.join(","),e="",f=l.getPersonalConfig("scheduleEmployees")||[],g=l.getPersonalConfig("scheduleRanges")||[];return _.each(b,function(a){var b=l.getContactDataById(a,"p");f=_.filter(f,function(b){return b.dataID!=a}),f.unshift({dataID:a,isCircle:!1,name:b.name}),f.length>5&&f.pop()}),c.length+b.length>1&&(g=_.filter(g,function(a){return a.dataIDs!=d}),_.each(c,function(a){var b=l.getContactDataById(a,"g");e+=b.name+","}),_.each(b,function(a){var b=l.getContactDataById(a,"p");e+=b.name+","}),e.length>0&&(e=e.slice(0,-1)),g.unshift({dataIDs:d,names:e}),g.length>5&&g.pop()),{scheduleEmployees:f,scheduleRanges:g}},publish:function(){var a,b=this,c=this.addDialog,d=c.element,e=$(".f-sub",d),f=this.manageDialog,g=f.element,h=d.data("comp"),i=h.media,j=this.getPersonalConfig();this.isPublishValid()&&(_.each(j,function(a,b){l.setPersonalConfig(b,a)}),l.updatePersonalConfig(),i.send(function(c,d){a=b.getPublishRequestData(),a.contactIDs=i.getContactIDs(),a.customerIDs=i.getCustomerIDs();var f=i.getCustomerConfig()||[],h=i.getContactsConfig()||[];l.setCustomerConfig(f),l.setContactsConfig(h),l.api({url:"/Schedule/SendSchedule",type:"post",data:a,alertmsgcb:function(){d&&$(d).hide()},success:function(a){a.success&&(b.hideAddDialog(),g.is(":visible")?b.fetchScheduleList():b.refreshScheduleDate())},complete:function(){c()}},{submitSelector:e})},d))},_regEvents:function(){var a=this,b=this.addDialog,c=b.element,d=this.manageDialog,e=d.element;c.on("click",'[type="reset"]',function(){a.hideAddDialog()}),c.on("click",'[type="submit"]',function(b){b.stopPropagation(),a.publish(),b.preventDefault()}),c.on("click",".custom-alert",function(b){var c=$(this);c.prop("checked")&&a.customAlertDialog.show(),b.preventDefault()}),e.on("click",".create-btn",function(){a.showAddDialog()}).on("click",".close-btn,.ui-dialog-close",function(){a.hideManageDialog()}),f.event.on("addremindsuccess",function(){a.refreshScheduleDate()})},_renderAddDialog:function(){var a,b,c,d,e,f,g,h,i,j;this.addDialog.render(),a=this.addDialog.element,b=$(".schedule-range",a),c=$(".start-date-wrapper",a),d=$(".start-time-wrapper",a),e=$(".media",a),f=new o({element:b,data:[{title:"部门",type:"g",list:v.g,unitSuffix:"个部门"},{title:"同事",type:"p",list:v.p}],defaultSelectedData:[{id:w.id,type:"p"}],title:"选择同事或部门",autoCompleteTitle:"选择同事或部门",acInitData:l.getPublishRange("schedule")}),f.on("inputshow",function(){f.setAcInitData(l.getPublishRange("schedule"))}),g=new q({element:c,formatStr:"YYYY年MM月DD日（dddd）"}),h=new r({element:d,timeDivision:15}),g.on("change",function(){g.getValue()&&""==h.getValue()&&h.selector.select(0)}),i=new p({element:e,action:["h5imgupload","h5attachupload","customer","contacts"]}),j=new s({element:$(".schedule-input",a)}),a.data("comp",{sb:f,ds:g,ts:h,media:i,atInput:j}),this.deleteStore=this.deleteStore.concat([f,g,h,i])},_renderManageDialog:function(){this.manageDialog.render(),this._initScheduleList()},_initScheduleList:function(){var a=this,b=this.get("scheduleDeleteCb"),c=$(".fs-schedule-manage-list",this.manageDialog.element);this.scheduleList=new k({element:c,pagSelector:!1,withLazyload:!1,scheduleStyle:3,listPath:"/schedule/getInfosByCurrentEmpID",itemDeleteCb:function(c,d){a.refreshScheduleDate(),b.call(a,c,d)},listEmptyText:"今日未添加日程",defaultRequestData:function(){var b=a.get("activeScheduleDate");return{startTime:m(b,t).unix()}}}),f.event.on("addremindsuccess",function(){a.scheduleList&&a.scheduleList.reload()})},getCurrentMonthRange:function(){var a,b,c=$(".card-calendar-date-panel",this.element),d=$(".date-body td",c);return a=m(d.first().data("date"),t),b=m(d.last().data("date"),t),{startDate:a,endDate:b}},_renderScheduleDate:function(){var a=this,b=this.get("scheduleDate");this.getCurrentMonthRange(),this.removeStamp("red"),this.removeStamp("blue"),_.each(b,function(b){b.creatorId==w.id?a.setStamp("red",m(b.startDate)):a.setStamp("blue",m(b.startDate))}),this.updateDateView()},_onRenderScheduleDate:function(){this._renderScheduleDate()},refreshScheduleDate:function(){var a=this,b=this.getCurrentMonthRange();l.api({url:"/Schedule/GetScheduleInfos",data:{startTime:b.startDate.unix(),endTime:b.endDate.unix()},type:"get",success:function(b){var c,d=[];b.success&&(c=b.value,_.each(c,function(a){d.push({startDate:new Date(1e3*a.startTime),creatorId:a.creatorID})}),a.set("scheduleDate",d))}})},_onRenderActiveScheduleDate:function(){},fetchScheduleList:function(){this.get("activeScheduleDate"),this.scheduleList.reload()},destroy:function(){var a;return this.addDialog.element&&this.addDialog.element.removeData(),_.each(this.deleteStore,function(a){a.destroy&&a.destroy()}),this.scheduleList&&this.scheduleList.destroy(),this.deleteStore=[],a=z.superclass.destroy.call(this)}});c.exports=z});