/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-follow-up/crm-follow-up",["widget","modules/crm-follow-up/crm-follow-up.html","util","modules/crm-select-colleague/crm-select-colleague"],function(a,b,c){var d=window;d.FS;var e=a("widget"),f=a("modules/crm-follow-up/crm-follow-up.html"),g=a("util"),h=a("modules/crm-select-colleague/crm-select-colleague"),i=e.extend({attrs:{element:null,title:"联合跟进人",items:[],addApi:"/FCustomer/AddFCustomerCombineSalers",deleteApi:"",parameter:{customerID:0,employeeIDs:""},typeName:"客户",name:"联合跟进人",selectColleague:null},events:{"click .crm-follow-up-add":"_showDialog","click .crm-follow-up-image":"_delete"},setup:function(){var a=i.superclass.render.apply(this,arguments);return this._init(),a},reload:function(a){this.set("items",a),this._generateHtml()},replace:function(a,b){if(!(0>=a)&&b){var c=this.get("items");c=_.filter(c,function(b){return b.employeeID!=a});var d=_.find(c,function(a){return a.employeeID==b.employeeID}),e=$("[data-value="+a+"]",this.element);d?e.parent().remove():(c.push(b),this.set("items",c),e.attr("src",g.getAvatarLink(b.profileImage,"2")),e.attr("data-value",b.employeeID),e.attr("data-name",b.name),e.attr("data-profileImage",b.profileImage),e.parent().attr("title",b.name)),this.set("ownerID",b.employeeID)}},_showDialog:function(){var a=this.get("selectColleague"),b=a.get("condition");b.exceptEmployeeIDs=this._getExceptEmployeeIDs(),a.set("condition",b),a.show()},_init:function(){this.element.html(f),$(".crm-follow-up-info",this.element).text(this.get("typeName")+"的查看权限为"+this.get("name")+"及全部上级"),$(".crm-follow-up-title",this.element).text(this.get("title")),this._initColleague(),this._generateHtml()},_initColleague:function(){var a=this,b=new h({isMultiSelect:!0,hasWorkLeaveBtn:!1,title:a.get("addWinTitle")||"选择联合跟进人",defaultCondition:{queryType:0,isFirstChar:!1,keyword:"",circleID:-1,exceptEmployeeIDs:this._getExceptEmployeeIDs,isStop:!1,pageSize:20,pageNumber:1}});b.on("selected",function(b){if(b&&!(b.length<1)){var c=a.get("parameter"),d=[];_.each(b,function(a){d.push(a.employeeID)}),c.employeeIDs=d,g.api({url:a.get("addApi"),type:"post",dataType:"json",data:c,success:function(c){if(c.success){var d=a.get("items");d=d.concat(b),a.set("items",d),a._generateHtml()}}})}}),this.set("selectColleague",b)},_getExceptEmployeeIDs:function(){var a=[],b=this.get("items");return _.each(b,function(b){a.push(b.employeeID)}),a.join(",")},_generateHtml:function(){var a=this.get("items"),b="";_.each(a,function(a){b+="<div class = 'crm-follow-up-image-container fn-left' title = '"+a.name+"'>",b+="<img src ='"+g.getAvatarLink(a.profileImage,"2")+"' class = 'crm-follow-up-image' data-value = '"+a.employeeID+"' data-name ='"+a.name+"' data-profileImage = '"+a.profileImage+"' /></div>"}),b+="<div class = 'crm-follow-up-add fn-left' title ='"+(this.get("btnAddTitle")||"添加联合跟进人")+"'>+</div>",$(".crm-follow-up-content",this.element).html(b)},_delete:function(a){var b=this,c=$(a.currentTarget),d=c.attr("data-name"),e=c.attr("data-value"),f=b.get("ownerID");f==e?g.confirm(d+"是当前"+(b.get("typeName")||"客户")+"的负责人，是否要变更负责人？","变更"+b.get("typeName")+"负责人",function(){b.get("selectColleagueS").show()}):g.confirm(d+"是当前"+(b.get("typeName")||"客户")+"的"+(b.get("name")||"联合跟进人")+"，是否将其删除？",b.get("name")||"联合跟进人",function(){var a=b.get("parameter");a.employeeID=e,g.api({url:b.get("deleteApi"),type:"post",dataType:"json",data:a,success:function(a){if(a.success){var d=b.get("items");d=_.filter(d,function(a){return a.employeeID!=e}),b.set("items",d),c.parent().remove()}}})})},destroy:function(){var a=i.superclass.render.apply(this,arguments);return a}});c.exports=i});