/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-businesstags/crm-businesstags",["modules/crm-businesstags/crm-businesstags.html","dialog","util","uilibs/search-box","modules/publish/publish-helper"],function(a,b,c){var d=a("modules/crm-businesstags/crm-businesstags.html"),e=a("dialog"),f=a("util"),g=a("uilibs/search-box"),h=a("modules/publish/publish-helper"),i=Backbone.View.extend({warpEl:null,tagName:"div",className:"businesstags-list",url:null,data:null,template:_.template($(d).filter(".businesstags-template").html()),events:{"click .createtags-btn":"_createNewTags","click .tag-item":"_modifyTags","click .tag-delbtn":"_delTags","keyup .tags-search-input":"_searchTagsByKeyUp","click .backtoall-btn":"_backToAll","click .tags-search-btn":"_searchTags"},initialize:function(){this.render(),this.createNewTagsDialog=new j,this.createNewTagsDialog.itemV=this,this.modifyTagsDialog=new k,this.modifyTagsDialog.itemV=this},render:function(){var a=this.$el,b=this.template,c={tagsLength:0,keyWord:"",tagTitle:"客户标签",value:{tags:[]}};return a.html(b(c)),this.options.warpEl.html(a),this},destroy:function(){this.remove()},load:function(){var a=this,b=this.$el;f.api({url:this.options.url,type:"get",dataType:"json",data:this.options.data,success:function(c){c.success&&(b.html(a.template(a.formatData(c))),a.tagType=a.options.data.tagType,a.setupDoms())}})},refresh:function(a){a&&_.extend(this.options.data,a),this.load()},formatData:function(a){var b={},c="";switch(_.extend(b,a||{}),parseFloat(this.options.data.tagType)){case 1:c="客户";break;case 2:c="联系人";break;case 3:c="销售记录";break;case 4:c="销售机会";break;case 5:c="产品";break;case 6:c="竞争对手";break;case 7:c="合同";break;case 8:c="市场活动";break;case 9:c="销售线索";break;default:c="客户"}return b.tagTitle=c,b.keyWord=this.options.data.keyword,b.tagsLength=a.value.tags.length||0,b},setupDoms:function(){var a=this.$el,b=this;this.elEl=a,this.searchInputEl=$(".tags-search-input",a),this.searchInputEl.val(this.options.data.keyword);var c=$(".search-warp",a),d=new g({element:c,placeholder:"搜索标签"});d.on("search",function(a){b.queryValue=a;var c={tagType:b.tagType,keyword:a},d=a.length||0,e=200;d>e?f.alert("关键词长度不能大于"+e+"字,请修改",function(){}):b.refresh(c)}),c.find(".ui-search-field").val(this.options.data.keyword)},setupComponent:function(){},_createNewTags:function(){this.createNewTagsDialog.show()},_modifyTags:function(a){var b=this,c=$(a.currentTarget),d=c.closest(".tag-item"),e=d.data("id");f.api({url:"/FBusinessTag/GetBusinessTagByID",type:"get",dataType:"json",data:{tagID:e},success:function(a){a.success&&(b.modifyTagsDialog.oData=a,b.modifyTagsDialog.show())}})},_delTags:function(a){var b=this,c=$(a.currentTarget),d=c.closest(".tag-item"),e=d.data("id"),g=d.data("name");return f.confirm("确定要删除该标签“"+g+"”吗？","",function(){f.api({url:"/FBusinessTag/DeleteBusinessTag",type:"post",dataType:"json",data:{tagID:e},success:function(a){a.success&&b.refresh()}})}),!1},_backToAll:function(){var a={tagType:this.tagType,keyword:""};this.refresh(a)}}),j=e.extend({attrs:{width:600,closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",content:$(d).filter(".dialog-createnewtags-template").html(),className:"dialog-createnewtags",webDisk:null},events:{"click .crm-button-submit":"submit","click .crm-button-cancel":"hide"},render:function(){var a=j.superclass.render.apply(this,arguments);return this.setupDoms(),this.setupComponent(),a},hide:function(){var a=j.superclass.hide.apply(this,arguments);return this.clear(),a},show:function(){var a=j.superclass.show.apply(this,arguments);return this.conTextareaEl.height("180px"),a},clear:function(){this.titInputEl.val(""),this.conTextareaEl.val("")},submit:function(){var a=this,b=this.titInputEl.val(),c=this.itemV.options.data.tagType,d=this.conTextareaEl.val(),e=d.split("\n");if($.trim(b).length<=0)return f.alert("请填写标签名称",function(){a.titInputEl.focus()}),!1;var g=[],h=_.every(e,function(a){return g.push(a),a.length<=20});return h?(f.api({url:"/FBusinessTag/AddBusinessTag",type:"post",dataType:"json",data:{name:b,type:c,tagOptions:g},success:function(b){b.success&&(a.hide(),a.itemV.refresh())}},{submitSelector:$(".crm-button-submit",this.elEl)}),void 0):(f.alert("每项最多可输入20个字符！",function(){a.conTextareaEl.focus()}),!1)},setupDoms:function(){var a=this.element;this.elEl=a,this.titInputEl=$(".tit-input",a),this.conTextareaEl=$(".con-textarea",a)},setupComponent:function(){h.AdjustTextAreaSize({element:this.conTextareaEl})}}),k=e.extend({attrs:{width:600,closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",content:$(d).filter(".dialog-modifytags-template").html(),className:"dialog-modifytags"},events:{"click .crm-button-submit":"submit","click .modifytitname-btn":"_modifyTagTitName","click .set-def-potion-btn":"_setDefPotion","click .add-potion-btn":"_addTagOption","click .save-potion-btn":"_modifyTagOption","click .del-potion-btn":"_delTagOption","click .crm-button-cancel":"hide"},render:function(){var a=k.superclass.render.apply(this,arguments);return this.setupDoms(),this.setupComponent(),a},hide:function(){var a=k.superclass.hide.apply(this,arguments);return this.clear(),a},show:function(){var a=k.superclass.show.apply(this,arguments),b=this.oData.value,c=b.isSystemTag,d=b.options,e="",g="",h=[{text:"不设置",value:0}],i={text:"不设置",value:0},j=$(".tit-input",this.element);return c?(j.prop("disabled",!0),this.modifytitnameBtnWarpEl.html("系统标签"),h=[]):(j.prop("disabled",!1),this.modifytitnameBtnWarpEl.html('<button class="crm-button-blue modifytitname-btn small-btn">保存</button>')),this.titInputEl.val(b.name),_.each(d,function(a){var b=a.isDefault,c=a.name,d=a.fBusinessTagOptionID;h.push({text:c,value:d}),g+='<li class="mn-select-item" data-value="'+c+'" data-selected="'+b+'">'+c+"</li>",e+='<div class="c"><input type="text" placeholder="" value="'+c+'" class="crm-textfield potion-tit-input" data-optionid="'+d+'" /> <button class="crm-button-blue save-potion-btn small-btn">保存</button> <button class="crm-button-gray del-potion-btn small-btn">删除</button></div>',b&&(i={text:c,value:d})}),f.mnSelect(this.mnSelectEl,"syncModel",h),f.mnSetter(this.mnSelectEl,i.value),this.mnSlTitleWarpEl.html(i.text||"不设置"),this.cWarpEl.html(e),a},clear:function(){this.titInputEl.val(""),this.addTagPotionInputEl.val(""),this.conTextareaEl.val(""),f.mnReset(this.mnSelectEl)},submit:function(){var a=this,b=this.titInputEl.val(),c=this.itemV.options.data.tagType,d=this.conTextareaEl.val(),e=d.split("\n"),g=!1;_.each(e,function(a){a.length>=20&&(g=!0)}),g?f.alert("每行一个选项，选项最多20个字"):f.api({url:"/FBusinessTag/AddBusinessTag",type:"post",dataType:"json",data:{name:b,type:c,tagOptions:d.split("\n")},success:function(b){b.success&&(a.hide(),a.itemV.refresh())}},{submitSelector:$(".crm-button-submit",this.elEl)})},_modifyTagTitName:function(a){var b=this,c=this.oData.value,d=this.titInputEl.val(),e=c.type,g=$(a.currentTarget);f.api({url:"/FBusinessTag/ModifyBusinessTag",type:"post",dataType:"json",data:{name:d,tagType:e,tagID:c.fBusinessTagID},success:function(a){a.success&&(f.alert("保存成功"),b.itemV.refresh())}},{submitSelector:g})},_setDefPotion:function(a){var b=this,c=this.oData.value;this.titInputEl.val(),c.type;var d=$(a.currentTarget),e=$(".mn-select-box",this.element);f.mnGetter(e),f.api({url:"/FBusinessTag/SetBusinessTagOptionIsDefault",type:"post",dataType:"json",data:{tagOptionID:f.mnGetter(b.mnSelectEl),tagID:c.fBusinessTagID},success:function(a){a.success&&(f.alert("设置成功"),b.itemV.refresh())}},{submitSelector:d})},_addTagOption:function(a){var b=this,c=this.oData.value,d=this.addTagPotionInputEl.val();c.type;var e=$(a.currentTarget);f.api({url:"/FBusinessTag/AddBusinessTagOption",type:"post",dataType:"json",data:{name:d,tagID:c.fBusinessTagID},success:function(a){if(a.success){var c='<div class="c"><input type="text" placeholder="" value="'+d+'" class="crm-textfield potion-tit-input"  data-optionid="'+a.value+'" /> <button class="crm-button-blue save-potion-btn small-btn">保存</button> <button class="crm-button-gray del-potion-btn small-btn">删除</button></div>';b.cWarpEl.append(c),f.mnSelect(b.mnSelectEl,"addOption",{text:d,value:a.value});var e=b.oData.value,g=e.isSystemTag;$(".ui-select-item",$(".crm-setting-tageditselect")).each(function(a,b){if(g){var c=$(".c-warp .c").eq(a).find(".potion-tit-input").val();$.trim(c).length>0&&$(b).html(c)}else if(a>0){var c=$(".c-warp .c").eq(a-1).find(".potion-tit-input").val();$.trim(c).length>0&&$(b).html(c)}}),b.addTagPotionInputEl.val(""),b.itemV.refresh()}}},{submitSelector:e})},_modifyTagOption:function(a){var b=this,c=this.oData.value;c.type;var d=$(a.currentTarget),e=d.closest(".c"),g=$(".potion-tit-input",e).val(),h=$(".potion-tit-input",e).data("optionid");f.api({url:"/FBusinessTag/ModifyBusinessTagOption",type:"post",dataType:"json",data:{name:g,tagOptionID:h,tagID:c.fBusinessTagID},success:function(a){if(a.success){var c=$(".ui-select-item[data-value="+h+"]",$(".crm-setting-tageditselect"));c.hasClass("ui-select-selected")&&$(".mn-select-title",b.mnSelectEl).html(g),c.html(g),f.alert("保存成功"),b.itemV.refresh()}}},{submitSelector:d})},_delTagOption:function(a){var b=this,c=this.oData.value;c.type;var d=$(a.currentTarget),e=d.closest(".c"),g=e.index();$(".potion-tit-input",e).val();var h=$(".potion-tit-input",e).data("optionid");f.confirm("确定要删除该选项吗？删除后无法恢复","",function(){f.api({url:"/FBusinessTag/DeleteBusinessTagOption",type:"post",dataType:"json",data:{tagOptionID:h,tagID:c.fBusinessTagID},success:function(a){if(a.success){e.remove();var c=b.oData.value,d=c.isSystemTag;if(d){if(f.mnSelect(b.mnSelectEl,"removeOption",g),f.mnGetter(b.mnSelectEl)==h){var i=$(".ui-select-item",$(".crm-setting-tageditselect")).eq(0);i.addClass("ui-select-selected"),$(".mn-select-title",b.mnSelectEl).html(i.html()),f.mnSetter(b.mnSelectEl,i.data("value"))}}else f.mnSelect(b.mnSelectEl,"removeOption",g+1),f.mnSetter(b.mnSelectEl,0);b.itemV.refresh()}}},{submitSelector:d})})},setupDoms:function(){var a=this.element;this.elEl=a,this.titInputEl=$(".tit-input",a),this.addTagPotionInputEl=$(".add-tag-potion-input",a),this.conTextareaEl=$(".con-textarea",a),this.modifytitnameBtnWarpEl=$(".modifytitname-btn-warp",a),this.mnSlWarpEl=$(".set-default-mn-warp",a),this.mnSlTitleWarpEl=$(".potion-mn-select-list-title",a),this.mnSelectEl=$(".mn-select-box",a),this.cWarpEl=$(".c-warp",a)},setupComponent:function(){}});c.exports=i});