/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-attachment-simple/crm-attachment-simple",["widget","modules/crm-attachment-simple/crm-attachment-simple.html","modules/fs-attach/fs-attach-file-preview","util","modules/fs-qx/fs-qx-helper","modules/crm-file-dialog/crm-file-dialog","nprogress"],function(a,b,c){var d=window,e=d.FS,f=a("widget"),g=a("modules/crm-attachment-simple/crm-attachment-simple.html"),h=a("modules/fs-attach/fs-attach-file-preview"),i=h.FileReader,j=new i,k=a("util"),l=a("modules/fs-qx/fs-qx-helper"),m=a("modules/crm-file-dialog/crm-file-dialog"),n=l.Uploader,o=a("nprogress"),p=f.extend({attrs:{element:null,items:[],condition:{},attachUploader:null,fileDialog:null,tagStr:"",suportH5:!0,flashFiles:[],contactData:k.getContactData(!0),returnValues:[]},events:{"click .crm-attachment-simple-all":"_toAll","click .crm-attachment-simple-title-upload":"_upload","click .crm-attachment-simple-upload":"_upload","click .crm-attachment-simple-preview":"_preview"},setup:function(){var a=p.superclass.render.apply(this,arguments);return this._init(),a},render:function(){var a=p.superclass.render.apply(this,arguments);return a},reload:function(){this._getData()},reset:function(a){if(a){var b={fbrType:4,dataID:0,attachType:0,tagName:"",pageSize:10,pageNumber:1};a=_.extend(b,a),this.set("condition",a)}this.reload(a)},_toAll:function(){this.trigger("toAll",this.get("items"))},_upload:function(){var a=$(".crm-attachment-simple-file-input",this.element);"undefined"!=typeof Worker?a.click():k.alert("当前浏览器不能满足html5版的上传功能，请尝试其他浏览器")},_preview:function(a){var b=$(a.currentTarget);b&&j.readFile({fileId:b.attr("data-attachID"),fileName:b.attr("data-attachName"),filePath:b.attr("data-attachPath")})},_empty:function(){"undefined"==typeof Worker?($(".crm-attachment-simple-title-upload",this.element).show(),$(".crm-attachment-simple-content",this.element).html($(".crm-attachment-simple-result-empty-flash",g).clone()),$(".crm-attachment-simple-result-empty-flash",this.element).show()):($(".crm-attachment-simple-title-upload",this.element).hide(),$(".crm-attachment-simple-content",this.element).html($(".crm-attachment-simple-result-empty",g).clone())),$(".crm-attachment-simple-footer",this.element).hide(),$(".crm-attachment-simple-content",this.element).css({"border-bottom":"1px #d8d8d8 solid"})},_full:function(){$(".crm-attachment-simple-title-upload",this.element).show(),$(".crm-attachment-simple-content",this.element).css({"border-bottom":"0px #d8d8d8 solid"}),$(".crm-attachment-simple-footer",this.element).show(),this._generateHtml()},_init:function(){this.element.html(g),"undefined"==typeof Worker&&this.set("suportH5",!1),this._getData(),this._initUploader(),this._initFileDialog(),this._initEvents()},_initUploader:function(){var a=this,b=new n({element:$(".crm-attachment-simple-file-input",this.element),h5Opts:{multiple:!0,accept:"*/*",filter:function(b){return a.uploadFilter(b,"attach")}},flashOpts:{file_types:"*.*",file_types_description:"所有文件"},onSuccess:function(b,c){var d=a.get("returnValues"),e=JSON.parse(c).value;if(a.get("suportH5"))d.push({value:3,value1:e.filePath,value2:b.size,value3:b.name});else{var f=a.get("attachUploader"),g=a.get("fileDialog"),h=g.get("status"),i=a.get("flashFiles"),i=_.filter(i,function(a){return a.id!=b.id});d.push({value:3,value1:e.filePath,value2:b.size,value3:b.name}),f.removeFile(b.id,!1),i.length>0&&f.startUpload(),a.set("flashFiles",i),a.set("attachUploader",f),"show"!=h&&g.show(),g.add(b,e.filePath)}a.set("returnValues",d)},onProgress:function(){},onFailure:function(){k.alert("上传失败，请重试！"),a.get("attachUploader").removeAllFile(),o.done()},onSelect:function(b){if(a.get("suportH5")){var c=a.get("fileDialog"),d=c.get("status");"show"!=d&&c.show(),c.add(b)}else{var e=a.uploadFilter([b],"attach"),f=a.get("flashFiles");_.each(e,function(b){0==f.length&&a.get("attachUploader").startUpload(),f.push(b)}),a.set("flashFiles",f)}},onComplete:function(){a.get("suportH5")&&(o.done(),a._postData(),a.get("attachUploader").removeAllFile())}});this.set("attachUploader",b)},uploadFilter:function(a,b){a=[].concat(a);var c,d=[],e=[],f=this.get("contactData").u.uploadFileSizeLimit,g=this.get("attachUploader");return e=g.core.fileFilter,_.each(a,function(a){a.size<1024*1024*f&&a.size>0&&(_.find(e,function(b){return b.name==a.name})||("img"==b&&"jpg"==k.getFileType(a)&&d.push(a),"attach"==b&&d.push(a)))}),d.length<a.length&&("img"==b?c="选择的文件类型必须为jpg、gif、jpeg或png，大小不能超过"+f+"MB且文件名不能相同，内容不能为空。本次添加了"+d.length+"个文件。":"attach"==b&&(c="选择的文件大小不能超过"+f+"MB且文件名不能相同，内容不能为空。本次添加了"+d.length+"个文件。"),k.alert(c)),d},_initFileDialog:function(){var a=this.get("condition"),b=new m({fbrType:a.fbrType,dataID:a.dataID});this.set("fileDialog",b)},_initEvents:function(){var a=this.get("fileDialog"),b=this;a.on("fileSelect",function(){var a=$(".crm-attachment-simple-file-input",b.element);b.get("suportH5")?a.click():k.alert("当前浏览器不能满足html5版的上传功能，请尝试其他浏览器")}),a.on("delete",function(a,c){if(!b.get("suportH5")){var d=b.get("returnValues");c&&(d=_.filter(d,function(a){return a.value1!=c}),b.set("returnValues",d))}b.get("attachUploader").removeFile(a)}),a.on("submit",function(a){b.get("suportH5")?(b.set("tagStr",a),b.get("attachUploader").startUpload(),o.start()):(b.set("tagStr",a),b._postData())}),a.on("cancel",function(){b.get("suportH5")||b.set("returnValues",[]),b.get("attachUploader").removeAllFile()})},_postData:function(){var a=this,b=this.get("tagStr"),c=this.get("returnValues"),d=this.get("condition"),e={tagNames:b,fileInfos:c,fbrType:d.fbrType,dataID:d.dataID};k.api({url:"/CrmAttach/AddCrmAttachs",type:"post",dataType:"json",data:e,success:function(b){return b.success?(a.set("returnValues",[]),a.reload(),o.done(),k.remind(2,"上传成功"),a.trigger("uploaded"),void 0):(k.remind(2,"上传失败，请重新上传"),o.done(),void 0)}})},_getData:function(){var a=this,b=this.get("condition"),c={fbrType:0,dataID:0,attachType:0,tagName:"",pageSize:6,pageNumber:1};b=_.extend(c,b),this.set("condition",b),k.api({url:"/CrmAttach/GetCrmAttachFiles",type:"get",dataType:"json",data:b,success:function(b){if(b.success){a.set("items",b.value.feedAttachEntitys);var c=a.get("items");c&&c.length>0?a._full():a._empty()}}})},_generateHtml:function(){var a=this.get("items"),b="<table class = 'crm-attachment-simple-table'>";!a||a.length<1||(_.each(a,function(a){b+="<tr><td class = 'crm-attachment-simple-image-td'><img src='"+e.BLANK_IMG+"' alt='icon' class='crm-attachment-simple-image fs-attach-"+k.getFileType({name:a.attachName},!0)+"-small-icon file-icon'/></td>",b+="<td class = 'crm-attachment-simple-name-td'><div title='"+a.attachName+"' class = 'crm-attachment-simple-name-div fn-text-overflow'>"+a.attachName+"</div></td>",b+="<td class = 'crm-attachment-simple-download-td'><a href = '"+k.getDfLink(a.attachPath,a.attachName,!0)+"' title = '"+a.attachName+"' target ='_blank'>下载</a></td>";var c="";a.canPreview||(c="fn-hide"),b+="<td class = 'crm-attachment-simple-show-td'><a data-attachID = '"+a.attachID+"' data-attachName = '"+a.attachName+"' data-attachPath = '"+a.attachPath+"' class = 'crm-attachment-simple-preview "+c+"'>预览</a></td></tr>"}),b+="</table>",$(".crm-attachment-simple-content",this.element).html(b))},destroy:function(){var a=p.superclass.render.apply(this,arguments);return a}});c.exports=p});