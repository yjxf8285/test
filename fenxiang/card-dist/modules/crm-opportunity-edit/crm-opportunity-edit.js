/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-opportunity-edit/crm-opportunity-edit",["modules/crm-opportunity-edit/crm-opportunity-edit.html","dialog","util","modules/publish/publish-helper","uilibs/currency-input","moment","modules/crm-select-customer/crm-select-customer"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-opportunity-edit/crm-opportunity-edit.html"),h=a("dialog"),i=a("util"),j=a("modules/publish/publish-helper"),k=a("uilibs/currency-input");a("moment");var l=j.DateSelect,m=a("modules/crm-select-customer/crm-select-customer"),n=h.extend({attrs:{width:760,content:$(g).filter(".dialog-opportunity-template").html(),className:"dialog-crm",closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",oppData:void 0,salesOpportunityID:void 0,customerID:void 0,customerName:void 0},events:{"click .dialog-button-submit":"submit","click .dialog-button-cancel":"hide","click .opp-customer-name-btn":"selectCustomer"},render:function(){var a=this,b=a.element,c=n.superclass.render.apply(this,arguments);return this.setupDoms(),this.setupComponent(),this.selectCustomerDialog=new m({title:"选择客户",url:"/FCustomer/GetFCustomers/",defaultCondition:{employeeID:i.getCurrentEmp().employeeID,isFirstChar:!1,listTagOptionID:"",sortType:2,queryType:2,keyword:"",pageSize:12,pageNumber:1}}),this.selectCustomerDialog.on("selected",function(a){$(".opp-customer-name",b).val(a.name).attr("data-id",a.customerID),$(".opp-customer-name",b).trigger("autosize.resize")}),setTimeout(function(){$(".opp-customer-name",b).trigger("autosize.resize")},1),c},hide:function(){this.selectCustomerDialog.hide();var a=n.superclass.hide.apply(this,arguments);return this.reset(),a},reset:function(){var a=this.element,b=e.getAppStore("contactData").salesStagesInUse,c=[];_.map(b,function(a){c.push({value:a.salesStageNo,text:a.name})}),i.enableCrmBtn($(".opp-customer-name-btn",a)),$(".sales-stages-in-use",a).parents("li").show(),$(".area-auto-height",a).val("").removeAttr("style"),$(".opp-customer-name",a).removeAttr("data-id").removeAttr("style"),$(".mn-select-box",a).each(function(){i.mnReset($(this))}),i.mnReset($(".sales-stages-in-use",a)),i.mnSetter($(".sales-stages-in-use",a),c[0].value),this.starttimeDs.setValue((new Date).getTime()),this.expectedDealTimeDs.clear(),this.currencyInput.reset(),$(".dialog-input-text",this.element).val(""),_.map(this.defineDateFieldArray,function(a){a.dateObj.clear()})},show:function(a){var b,c=this;a&&a.salesOpportunityID&&this.set("salesOpportunityID",a.salesOpportunityID),a&&a.customerName&&a.customerID&&(this.set("customerName",a.customerName),this.set("customerID",a.customerID));var d=this.get("salesOpportunityID")||void 0,e=this.get("customerName")||"",f=this.get("customerID")||0;return e&&f&&($(".opp-customer-name",this.element).val(e).attr("data-id",f).removeAttr("style"),i.disableCrmBtn($(".opp-customer-name-btn",this.element)),setTimeout(function(){$(".opp-customer-name",this.element).removeAttr("style").trigger("autosize.resize")},1)),d?($(".sales-stages-in-use",this.element).parents("li").hide(),i.disableCrmBtn($(".opp-customer-name-btn",this.element)),i.api({url:"/SalesOpportunity/GetSalesOpportunityByID",type:"get",dataType:"json",async:!1,data:{salesOpportunityID:d},success:function(a){a.success&&(b=n.superclass.show.apply(c,arguments),c.set("oppData",a),c.fillFormData())}},{submitSelector:""})):b=n.superclass.show.apply(this,arguments),b},submit:function(a){var b,c=this,d=this.get("oppData")?this.get("oppData").value.salesOpportunitys[0]:void 0,e=this.get("salesOpportunityID")?this.get("salesOpportunityID"):void 0,f=$(a.currentTarget),g=this.element,h=$(".opp-name",g).val(),j=$(".opp-customer-name",g).attr("data-id")||0,k=i.mnGetter($(".sales-stages-in-use",g))||1,l=this.currencyInput.val(),m=this.starttimeDs.getValue(!0)&&this.starttimeDs.getValue(!0)._d&&this.starttimeDs.getValue(!0)._d.getTime()/1e3||-1,n=this.expectedDealTimeDs.getValue(!0)&&this.expectedDealTimeDs.getValue(!0)._d&&this.expectedDealTimeDs.getValue(!0)._d.getTime()/1e3||-1,o=$(".opp-demands",g).val()||"",p=$(".opp-description",g).val()||"",q=[],r=$(".opportunity-tags-list-warp > li",g);if(r.each(function(){var a=$(".f-business-tag-id",$(this)).data("fbusinesstagid"),b=$(".mn-select-box",$(this)),c=i.mnGetter(b)||0;q.push(a+","+c)}),""==h)return i.alert("请填写机会名称"),void 0;if(0==j)return i.alert("请选择客户"),void 0;if(-1==l)return i.alert("请正确填写预计销售金额"),void 0;if(0==l)return i.alert("预计销售金额必须大于0"),void 0;if(-1==m)return i.alert("请填写发现时间"),void 0;if(-1==n)return i.alert("请填写预计成交日期"),void 0;var s=$(".opportunity-define-fields-list-warp",g),t=[];s.find(".f-user-define-field-num").each(function(){t.push($(this).attr("data-fieldname")+","+($(this).next().find("input").val()||0))}),s.find(".f-user-define-field-text").each(function(){t.push($(this).attr("data-fieldname")+","+($(this).next().find("textarea").val()||""))}),_.map(this.defineDateFieldArray,function(a){t.push(a.fieldName+","+a.dateObj.getTime())}),d?i.api({url:"/SalesOpportunity/UpdateSalesOpportunity",type:"post",dataType:"json",errorMsgTitle:"修改机会发生错误，原因：",data:{salesOpportunityID:parseInt(e),name:h,expectedSalesAmount:l,foundTime:m,expectedDealTime:n,demands:o,description:p,listTagOptionID:q,dataList:t},success:function(a){a.success&&(c.hide(),i.remind(2,"保存成功"),c.v&&c.v.refresh&&c.v.refresh(),c.trigger("success"))}},{submitSelector:f}):i.api({url:"/SalesOpportunity/AddSalesOpportunity",type:"post",dataType:"json",data:{name:h,customerID:j,salesStageNo:k,expectedSalesAmount:l,foundTime:m,expectedDealTime:n,demands:o,description:p,listTagOptionID:q,dataList:t,isOutReport:b},success:function(a){a.success&&(c.hide(),i.remind(2,"添加成功"),c.v&&c.v.refresh&&c.v.refresh(),c.trigger("success"))}},{submitSelector:f})},delSelect:function(a){var b=$(a.target).parent().parent();1==b.parent().children().length||b.remove()},addSelect:function(a){var b=$(a.target),c=b.parent().parent();if(0==c.next().length){b.next().show();var d;d=b.hasClass("contact-address")?$(g).filter(".dialog-contacts-address"):$(g).filter(".dialog-contacts-contact-way"),c.parent().append(d),i.mnSelect(d.find(".mn-select-box"),"syncModel",i.getContactsWays()),j.AdjustTextAreaSize({element:d.find(".area-auto-height")})}},setupDoms:function(){var a=this.element;this.autoHeightTextarea=$(".area-auto-height",a)},setupComponent:function(){var a=this.get("salesOpportunityID")?this.get("salesOpportunityID"):void 0,b=this.get("customerName")||void 0,c=this.get("customerID")||void 0,d=this.element;a&&(i.disableCrmBtn($(".opp-customer-name-btn",d)),$(".sales-stages-in-use",this.element).parents("li").hide()),c&&(i.disableCrmBtn($(".opp-customer-name-btn",d)),$(".opp-customer-name",d).attr("data-id",c).val(b));var f=$(".opportunity-tags-list-warp",d),g=$(".found-time",d),h=$(".expected-deal-time",d);this.starttimeDs=new l({element:g,placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）",isCRM:!0}),this.expectedDealTimeDs=new l({element:h,placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）",isCRM:!0}),this.starttimeDs.setValue((new Date).getTime()),this.currencyInput=new k({element:$(".expected-sales-amount",d)});var m=e.getAppStore("contactData").salesStagesInUse,n=[];_.map(m,function(a){n.push({value:a.salesStageNo,text:a.name})}),i.mnSelect($(".sales-stages-in-use",d),"syncModel",n),i.mnSetter($(".sales-stages-in-use",d),n[0].value);var o=i.getTagsByType(i.CONSTANT.TAG_TYPE.SALES_OPP);_.each(o,function(a){var b=a.name,c=a.options,d="",e="";c.length>0?_.each(c,function(a){var b=a.isDefault;b?(e=a.name,d+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'" data-selected="'+b+'">'+a.name+"</li></ul>"):d+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'">'+a.name+"</li></ul>"}):d='<ul class="mn-select-list"><li class="mn-select-item" data-value="0"></li></ul>',f.append('<li class="fn-clear"> <div class="selects-tit inputs-tit f-business-tag-id" data-fbusinesstagid="'+a.fBusinessTagID+'"> '+b+' </div> <div class="selects-warp"> <span select-cls="" class="mn-select-box "><span class="mn-select-title-wrapper select-for-dialog"><span class="mn-select-title ">'+e+'</span><span class="title-icon"></span></span>'+d+"</span> </div> </li>")});var p=i.getUserDefineFieldByType(3);this.defineDateFieldArray=[];var q=$(".opportunity-define-fields-list-warp",d);p&&p.length>0&&q.show(),this.defineDateFieldArray=i.generateDefineField(q,p,l),j.AdjustTextAreaSize({element:$(".area-auto-height",d)}),$(".area-auto-height",d).trigger("autosize.resize"),$(".opp-customer-name",d).removeAttr("style").trigger("autosize.resize")},fillFormData:function(){this.get("salesOpportunityID")||void 0;var a=this.get("oppData")?this.get("oppData").value.salesOpportunitys[0]:void 0,b=this.element,c=this;if(a){$(".opp-name",b).val(a.name),$(".opp-customer-name",b).val(a.customerName).attr("data-id",a.customerID),i.mnSetter($(".sales-stages-in-use",b),a.salesStageNo),this.currencyInput.setValue(a.expectedSalesAmount),this.starttimeDs.setValue(1e3*a.foundTime),this.expectedDealTimeDs.setValue(1e3*a.expectedDealTime),$(".opp-demands",b).val(a.demands),$(".opp-description",b).val(a.description),_.map(a.fBusinessTagRelations,function(a){a.fBusinessTagOptionID&&i.mnSetter($("[data-fbusinesstagid="+a.fBusinessTagID+"]",b).next().children(".mn-select-box"),a.fBusinessTagOptionID)}),a.userDefineFieldDataList&&a.userDefineFieldDataList.dateList&&_.map(a.userDefineFieldDataList.dateList,function(a){var b=_.find(c.defineDateFieldArray,function(b){return b.fieldName==a.fieldName});a.value>0&&b.dateObj.setValue(1e3*a.value)});var d=$(".opportunity-define-fields-list-warp",b);a.userDefineFieldDataList&&a.userDefineFieldDataList.numList&&_.map(a.userDefineFieldDataList.numList,function(a){d.find("div[data-fieldname='"+a.fieldName+"']").next().find("input").val(a.value)}),a.userDefineFieldDataList&&a.userDefineFieldDataList.textList&&_.map(a.userDefineFieldDataList.textList,function(a){d.find("div[data-fieldname='"+a.fieldName+"']").next().find("textarea").val(a.value)}),$(".opp-customer-name",b).removeAttr("style").trigger("autosize.resize"),$(".area-auto-height",b).trigger("autosize.resize")}},selectCustomer:function(){this.selectCustomerDialog.show()}});c.exports=n});