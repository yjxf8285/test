/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-contact-view/crm-contact-view",["modules/crm-contact-view/crm-contact-view.html","dialog","util","modules/publish/publish-helper","datatable","moment","uilibs/search-box","uilibs/pagination2"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-contact-view/crm-contact-view.html"),h=a("dialog"),i=a("util");a("modules/publish/publish-helper"),a("datatable"),a("moment"),a("uilibs/search-box"),a("uilibs/pagination2");var j=h.extend({attrs:{width:760,content:$(g).filter(".dialog-contact-template").html(),className:"dialog-crm",closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",contactData:void 0,customerID:void 0,customerName:void 0,address:void 0,webSite:void 0,isShareContact:!1,shareContactMessageID:void 0},events:{"click .dialog-button-submit":"submit","click .dialog-button-cancel":"hide","click .select-del":"delSelect","click .share-create-contact":"copyContact","keyup .crm-contacts-contact-way":"addSelect","keyup .contact-address":"addSelect"},copyContact:function(){var a=this;i.api({url:"/Contact/CopyContact",type:"post",dataType:"json",data:{shareContactMessageID:this.get("shareContactMessageID")},success:function(b){b.success&&(a.v&&a.v.refresh(),a.trigger("success"),a.hide())}},{submitSelector:""})},render:function(){var a=j.superclass.render.apply(this,arguments);return a},hide:function(){var a=j.superclass.hide.apply(this,arguments);return this.reset(),a},reset:function(){var a=this.element;$(".share-create-contact",a).hide(),$(".name",a).text(""),$(".view-text",a).text(""),$(".long-view-text",a).text(""),$(".crm-contact-ways-ul",a).html("").css("display","none"),$(".crm-contact-address-ul",a).html("").css("display","none"),$(".contact-tags-list-ul",a).html("")},show:function(a){var b=j.superclass.show.apply(this,arguments);this.set("isCleared",!1),a&&a.contactID&&this.set("contactID",a.contactID),a&&a.shareContactMessageID&&this.set("shareContactMessageID",a.shareContactMessageID),a&&a.isShareContact&&(this.set("isShareContact",a.isShareContact),$(".share-create-contact",this.element).show());var c=this.get("contactID")?this.get("contactID"):void 0,d=this;return c&&i.api({url:"/Contact/GetContactByID",type:"get",dataType:"json",data:{contactID:c},success:function(a){a.success&&(d.set("contactData",a),d.fillFormData())}},{submitSelector:""}),b},submit:function(a){var b=this,c=this.get("contactData")?this.get("contactData").value:void 0,d=this.get("contactID")?this.get("contactID"):void 0,e=this.get("customerID")||0,f=$(a.currentTarget),g=this.element,h=$(".contact-name",g).val(),j=$(".contact-post",g).val(),k=$(".contact-department",g).val(),l=$(".contact-company",g).val(),m=$(".contact-website",g).val(),n="",o="",p=$(".contact-interest",g).val(),q=[],r=[];listTagOptionID=[],remark=$(".contact-remark",g).val(),n=i.mnGetter($(".mn-radio-box"),g);var s=i.mnGetter($(".crm-birth-year",g))||-1,t=i.mnGetter($(".crm-birth-month",g))||0,u=i.mnGetter($(".crm-birth-day",g))||0;o=""+(s>0?s:"0000")+(10>t?"0"+t:t)+(10>u?"0"+u:u);var v=[];$(".crm-contact-ways-select",g).each(function(){v.push(i.mnGetter($(this))||1)});var w=0;$(".crm-contacts-contact-way",g).each(function(){var a=$(this).val();a&&q.push((v[w]<10?"0"+v[w]:v[w])+a),w++}),$(".contact-address",g).each(function(){$(this).val()&&r.push($(this).val())});var x=$(".contact-tags-list-warp > li",g);x.each(function(){var a=$(".f-business-tag-id",$(this)).data("fbusinesstagid"),b=$(".mn-select-box",$(this)),c=i.mnGetter(b)||0;listTagOptionID.push(a+","+c)}),c?i.api({url:"/Contact/UpdateContact",type:"post",dataType:"json",data:{contactID:parseInt(d),name:h,post:j,department:k,company:l,website:m,gender:n,birthday:o,interest:p,listContactWay:q,address:r.join(","),listTagOptionID:listTagOptionID,remark:remark,source:1},success:function(a){a.success&&(b.hide(),i.remind(2,"保存成功"),b.v&&b.v.refresh())}},{submitSelector:f}):i.api({url:"/Contact/AddContact",type:"post",dataType:"json",data:{customerID:e,name:h,post:j,department:k,company:l,website:m,gender:n,birthday:o,interest:p,listContactWay:q,address:r.join(","),listTagOptionID:listTagOptionID,remark:remark,source:1},success:function(a){a.success&&(b.hide(),i.remind(2,"添加成功"),b.v&&b.v.refresh())}},{submitSelector:f})},fillFormData:function(){var a=this.element,b=this.get("contactData")&&this.get("contactData").value;$(".name",a).text(b.name),$(".post",a).text(b.post),$(".department",a).text(b.department),$(".company",a).text(b.company),$(".website",a).text(b.webSite),$(".interest",a).text(b.interest),$(".remark",a).text(b.remark),b.gender&&("M"==b.gender?$(".gender",a).text("男"):"F"==b.gender&&$(".gender",a).text("女"));var c=$(".crm-contact-address-ul",a);if(b.addressObject&&b.addressObject.length>0){c.show();for(var d=0,e=b.addressObject.length;e>d;d++){var f=$(g).filter(".dialog-contacts-addr");f.find(".inputs-tit").text("地址"),f.find(".long-view-text").text(b.addressObject[d]),c.append(f)}}var h=$(".crm-contact-ways-ul",a);if(b.contactWayObject&&b.contactWayObject.length>0){h.show();for(var d=0,e=b.contactWayObject.length;e>d;d++){var f=$(g).filter(".dialog-contacts-addr");f.find(".inputs-tit").text(b.contactWayObject[d].typeDesc),f.find(".long-view-text").text(b.contactWayObject[d].content),h.append(f)}}var j=$(".contact-tags-list-ul",a);if(b.fBusinessTagRelations&&b.fBusinessTagRelations.length>0){j.show();for(var d=0,e=b.fBusinessTagRelations.length;e>d;d++){var f=$(g).filter(".dialog-contacts-addr");f.find(".inputs-tit").text(b.fBusinessTagRelations[d].fBusinessTagName),f.find(".long-view-text").text(b.fBusinessTagRelations[d].fBusinessTagOptionName),j.append(f)}}var k="";b.yearOfBirth&&(k+=b.yearOfBirth+"年"),b.monthOfBirth&&(k+=b.monthOfBirth+"月"),b.dayOfBirth&&(k+=b.dayOfBirth+"日"),$(".birthday",a).text(k),b.picturePath?$(".profile",a).attr("src",i.getAvatarLink(b.picturePath,"2")):$(".profile",a).attr("src",i.getAvatarLink())}});c.exports=j});