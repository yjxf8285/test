/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-paymentrecord-edit/crm-paymentrecord-edit",["modules/crm-paymentrecord-edit/crm-paymentrecord-edit.html","dialog","util","modules/publish/publish-helper","uilibs/currency-input","moment","modules/crm-select-colleague/crm-select-colleague"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-paymentrecord-edit/crm-paymentrecord-edit.html"),h=a("dialog"),i=a("util"),j=a("modules/publish/publish-helper"),k=j.DateSelect,l=a("uilibs/currency-input");a("moment");var m=a("modules/crm-select-colleague/crm-select-colleague"),n=h.extend({attrs:{width:760,content:$(g).filter(".dialog-paymentrecord-template").html(),className:"dialog-crm",closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",contractID:void 0,contractTitle:void 0,amount:void 0,paymentTime:void 0,paymentTimes:void 0,ownerID:void 0,ownerName:void 0,payTimes:[],contractPaymentRecordID:void 0},events:{"click .dialog-button-submit":"submit","click .dialog-button-cancel":"hide","click .paymentrecord-isBilling-checkbox-item":"_isBilling","click .ownerID-btn":"selectOwner"},render:function(){var a=this.element,b=n.superclass.render.apply(this,arguments);return this.setupDoms(),this.setupComponent(),this.selectOwnerDialog=new m({isMultiSelect:!1,hasWorkLeaveBtn:!1,title:"选择同事"}),this.selectOwnerDialog.on("selected",function(b){$(".ownerID",a).val(b.name).attr("data-id",b.employeeID)}),b},hide:function(){var a=n.superclass.hide.apply(this,arguments);return this.reset(),a},reset:function(){var a=this.element;i.mnSetter($(".paymentType",a),1),i.mnSetter($(".paymentTimes",a),1),i.mnSetter($(".isBilling",a),[!1]),this.amount.reset(),$(".area-auto-height",a).val("").height(100),this.paymentTime.clear(),this.set("contractPaymentRecordID",""),this.set("contractPaymentTimes",""),$(".contract-title",a).val(""),$(".ownerID",a).val(this.get("ownerName")).attr("data-id",this.get("ownerID")),$(".paymentTimes",a).show().prev().hide()},show:function(a){var b=this,c=this.element,d=n.superclass.show.apply(this,arguments);a&&(a.contractPaymentRecordID&&this.set("contractPaymentRecordID",a.contractPaymentRecordID),a.contractTitle&&$(".contract-title",c).val(a.contractTitle),a.ownerID&&a.ownerName&&$(".ownerID",c).val(a.ownerName).attr("data-id",a.ownerID),a.paymentTime&&this.paymentTime.setValue(1e3*a.paymentTime),a.amount&&this.amount.setValue(a.amount),a.contractPaymentPlanID?($(".paymentTimes",c).hide().prev().val(a.paymentTimes+"期").show(),this.set("contractPaymentTimes",a.paymentTimes)):($(".paymentTimes",c).show().prev().hide(),i.mnSetter($(".paymentTimes",c),a.paymentTimes)));var e=this.get("contractPaymentRecordID")||void 0;return e&&($(".paymentTimes",c).hide().prev().show(),i.api({url:"/Contract/GetContractPaymentRecordByID",type:"get",dataType:"json",data:{contractPaymentRecordID:e},success:function(a){a.success&&(b.set("contractPaymentRecord",a),b.fillFormData())}},{submitSelector:""})),d},submit:function(a){var b=this,c=this.get("contractPaymentRecord")?this.get("contractPaymentRecord").value:void 0,d=this.get("contractPaymentRecordID")?this.get("contractPaymentRecordID"):void 0,e=this.get("contractID")||0,f=this.get("ownerID")||0,g=$(a.currentTarget),h=this.element,j=this.amount.val(),k=this.paymentTime.getTime(),l=i.mnGetter($(".paymentTimes",h))||1,m=$(".description",h).val(),n=i.mnGetter($(".paymentType",h))||1,o=i.mnGetter($(".isBilling",h)).length>0?!0:!1,f=$(".ownerID",h).attr("data-id");return-1==j?(i.alert("请填写正确金额"),void 0):0==j?(i.alert("金额必须大于0"),void 0):0==k?(i.alert("请填写实际回款日期"),void 0):(c?i.api({url:"/Contract/UpdateContractPaymentRecord",type:"post",dataType:"json",data:{contractPaymentRecordID:d,contractID:e,ownerID:f,amount:j,paymentTime:k,paymentType:n,isBilling:o,description:m},success:function(a){a.success&&(b.hide(),i.remind(2,"保存成功"),b.trigger("success"))}},{submitSelector:g}):i.api({url:"/Contract/AddContractPaymentRecord",type:"post",dataType:"json",data:{contractID:e,ownerID:f,amount:j,paymentTime:k,paymentTimes:this.get("contractPaymentTimes")||l,paymentType:n,isBilling:o,description:m},success:function(a){a.success&&(b.hide(),i.remind(2,"添加成功"),b.trigger("success"))}},{submitSelector:g}),void 0)},setupDoms:function(){var a=this.element;this.conTextareaEl=$(".area-auto-height",a)},setupComponent:function(){this.get("contractID")||void 0;var a=this.get("amount")||0,b=this.get("paymentTime")||0;this.get("paymentTimes")||1;var c=this.get("ownerID")||void 0,d=this.get("ownerName")||void 0,e=this.element;$(".ownerID",e).val(d).attr("data-id",c),i.mnSelect($(".paymentType",e),"syncModel",i.getPayWays()),this.paymentTime=new k({element:$(".paymentTime",e),placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）",isCRM:!0}),b&&this.paymentTime.setValue(1e3*b),this.amount=new l({element:$(".amount",e)}),a&&this.amount.setValue(a);for(var f=[],g=1,h=13;h>g;g++)f.push({value:g,text:g+"期"});i.mnSelect($(".paymentTimes",e),"syncModel",f),j.AdjustTextAreaSize({element:this.conTextareaEl})},fillFormData:function(){this.get("contractPaymentRecordID")?this.get("contractPaymentRecordID"):void 0;var a=this.get("contractPaymentRecord")?this.get("contractPaymentRecord").value:void 0,b=this.element;a&&(this.set("contractID",a.contractID),this.amount.setValue(a.amount),this.paymentTime.setValue(1e3*a.paymentTime),i.mnSetter($(".paymentTimes",b),a.paymentTimes),$(".paymentTimes",b).prev().val(a.paymentTimes+"期"),$(".description",b).val(a.description),$(".ownerID",b).attr("data-id",a.ownerID).val(a.owner&&a.owner.name),i.mnSetter($(".paymentType",b),a.paymentType),a.isBilling?i.mnSetter($(".isBilling",b),[!0]):i.mnSetter($(".isBilling",b),[!1]),$(".area-auto-height",b).trigger("autosize.resize"))},_isBilling:function(a){$(a.target).hasClass("mn-selected")?$(a.target).next().next().hide():$(a.target).next().next().show()},selectOwner:function(){this.selectOwnerDialog.show()}});c.exports=n});