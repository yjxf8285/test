/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-marketing-edit/crm-marketing-edit",["modules/crm-marketing-edit/crm-marketing-edit.html","dialog","util","modules/publish/publish-helper","uilibs/currency-input","datatable","moment","uilibs/search-box","uilibs/pagination2","modules/crm-select-customer/crm-select-customer"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-marketing-edit/crm-marketing-edit.html"),h=a("dialog"),i=a("util"),j=a("modules/publish/publish-helper"),k=a("uilibs/currency-input");a("datatable"),a("moment"),a("uilibs/search-box"),a("uilibs/pagination2");var l=j.DateSelect;a("modules/crm-select-customer/crm-select-customer");var m=h.extend({attrs:{width:760,content:$(g).filter(".dialog-marketing-template").html(),className:"dialog-crm",closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",marketingEventData:void 0,marketingEventID:void 0},events:{"click .dialog-button-submit":"submit","click .dialog-button-cancel":"hide"},render:function(){var a=this;a.element;var b=m.superclass.render.apply(this,arguments);return this.setupDoms(),this.setupComponent(),b},hide:function(){var a=m.superclass.hide.apply(this,arguments);return this.reset(),a},reset:function(){$(".area-auto-height",this.element).val("").removeAttr("style"),$(".dialog-input-text",this.element).val(""),this.beginDate.clear(),this.endDate.clear(),$(".mn-select-box",this.element).each(function(){i.mnReset($(this))}),this.expectedCost.reset(),this.actualCost.reset(),this.expectedIncome.reset(),this.actualIncome.reset()},show:function(){var a,b=this,c=this.get("marketingEventID")?this.get("marketingEventID"):void 0;return this.fillTags(),c?i.api({url:"/MarketingEvent/GetMarketingEventByID",type:"get",dataType:"json",async:!1,data:{marketingEventID:c},success:function(c){c.success&&c.value&&c.value.marketingEvents&&c.value.marketingEvents.length>0&&(a=m.superclass.show.apply(b,arguments),b.set("marketingEventData",c.value.marketingEvents[0]),b.fillFormData())}},{submitSelector:""}):a=m.superclass.show.apply(this,arguments),a},submit:function(a){var b=this,c=this.get("marketingEventData")?this.get("marketingEventData"):void 0,d=this.get("marketingEventID")?this.get("marketingEventID"):void 0,e=$(a.currentTarget),f=this.element,g=$(".marketing-name",f).val(),h=this.beginDate.getTime(),j=this.endDate.getTime(),k=this.expectedCost.val(),l=this.actualCost.val(),m=this.expectedIncome.val(),n=this.actualIncome.val(),o=$(".marketing-location",f).val(),p=$(".marketing-marketingPlan",f).val(),q=$(".marketing-executionDescription",f).val(),r=$(".marketing-summary",f).val(),s=$(".marketing-effect",f).val(),t=$(".marketing-description",f).val(),u=[];if(!g)return i.alert("活动名称不能为空！"),void 0;if(!h)return i.alert("开始日期不能为空！"),void 0;if(!j)return i.alert("结束日期不能为空！"),void 0;var v=$(".marketing-tags-list-warp > li",f);v.each(function(){var a=$(".f-business-tag-id",$(this)).data("fbusinesstagid"),b=$(".mn-select-box",$(this)),c=i.mnGetter(b)||0;u.push(a+","+c)}),c?i.api({url:"/MarketingEvent/UpdateMarketingEvent",type:"post",dataType:"json",errorMsgTitle:"修改市场发生错误，原因：",data:{marketingEventID:d,name:g,beginDate:h,endDate:j,expectedCost:k,actualCost:l,expectedIncome:m,actualIncome:n,location:o,marketingPlan:p,executionDescription:q,summary:r,effect:s,description:t,listTagOptionID:u},success:function(a){a.success&&(b.hide(),i.remind(2,"保存成功"),b.v&&b.v.refresh&&b.v.refresh(),b.trigger("success"))}},{submitSelector:e}):i.api({url:"/MarketingEvent/AddMarketingEvent",type:"post",dataType:"json",errorMsgTitle:"添加市场发生错误，原因：",data:{name:g,beginDate:h,endDate:j,expectedCost:k,actualCost:l,expectedIncome:m,actualIncome:n,location:o,marketingPlan:p,executionDescription:q,summary:r,effect:s,description:t,listTagOptionID:u},success:function(a){a.success&&(b.hide(),i.remind(2,"添加成功"),b.v&&b.v.refresh&&b.v.refresh(),b.trigger("success"))}},{submitSelector:e})},setupDoms:function(){var a=this.element;this.conTextareaEl=$(".area-auto-height",a)},setupComponent:function(){var a=this.get("marketingEventID")?this.get("marketingEventID"):void 0,b=this.element;a&&$(".select-customer-btn",b).attr({disabled:!0,opacity:.5}),$(".expected-deal-time",b),this.beginDate=new l({element:$(".marketing-beginDate",b),placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）",isCRM:!0}),this.endDate=new l({element:$(".marketing-endDate",b),placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）",isCRM:!0}),this.expectedCost=new k({element:$(".marketing-expectedCost",b)}),this.actualCost=new k({element:$(".marketing-actualCost",b)}),this.expectedIncome=new k({element:$(".marketing-expectedIncome",b)}),this.actualIncome=new k({element:$(".marketing-actualIncome",b)}),j.AdjustTextAreaSize({element:this.conTextareaEl}),this.fillTags()},fillTags:function(){var a=$(".marketing-tags-list-warp",this.$el),b=i.getTagsByType(i.CONSTANT.TAG_TYPE.MARKETING),c=[];_.each(b,function(a){var b=a.name,d=a.options,e="",f="";d.length>0?_.each(d,function(a){var b=a.isDefault;b?(f=a.name,e+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'" data-selected="'+b+'">'+a.name+"</li></ul>"):e+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'">'+a.name+"</li></ul>"}):e='<ul class="mn-select-list"><li class="mn-select-item" data-value="0"></li></ul>',c.push('<li class="fn-clear"> <div class="selects-tit inputs-tit f-business-tag-id" data-fbusinesstagid="'+a.fBusinessTagID+'"> '+b+' </div> <div class="selects-warp"> <span select-cls="" class="mn-select-box "><span class="mn-select-title-wrapper select-for-dialog"><span class="mn-select-title ">'+f+'</span><span class="title-icon"></span></span>'+e+"</span> </div> </li>")}),a.html(c.join(""))},fillFormData:function(){this.get("marketingEventID")?this.get("marketingEventID"):void 0;var a=this.get("marketingEventData")?this.get("marketingEventData"):void 0,b=this.element;a&&($(".marketing-name",b).val(a.name),this.beginDate.setValue(1e3*a.beginDate),this.endDate.setValue(1e3*a.endDate),this.expectedCost.setValue(a.expectedCost),this.actualCost.setValue(a.actualCost),this.expectedIncome.setValue(a.expectedIncome),this.actualIncome.setValue(a.actualIncome),$(".marketing-location",b).val(a.location),$(".marketing-marketingPlan",b).val(a.marketingPlan),$(".marketing-executionDescription",b).val(a.executionDescription),$(".marketing-summary",b).val(a.summary),$(".marketing-effect",b).val(a.effect),$(".marketing-description",b).val(a.description),_.map(a.fBusinessTagRelations,function(a){a.fBusinessTagOptionID&&i.mnSetter($("[data-fbusinesstagid="+a.fBusinessTagID+"]",b).next().children(".mn-select-box"),a.fBusinessTagOptionID)}),$(".area-auto-height",b).trigger("autosize.resize"))}});c.exports=m});