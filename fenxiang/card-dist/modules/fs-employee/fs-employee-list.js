/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/fs-employee/fs-employee-list",["util","uilibs/pagination","spin","moment","./fs-employee.html","./fs-employee.css"],function(a,b,c){var d=window,e=d.FS;e.tpl;var f=a("util"),g=a("uilibs/pagination"),h=(a("spin"),a("moment"),a("./fs-employee.html"));a("./fs-employee.css");var i=$(h),j=Backbone.Model.extend({}),k=Backbone.Collection.extend({model:j,sync:function(a,b,c){var d=c.data||{};c.data=_.extend({keyword:"",pageSize:10,pageNumber:1},d),Backbone.sync("read",b,c)},parse:function(a){a.value.items;var b;return a.success?(b=f.deepClone(a.value.items),_.each(b,function(a){a.profileImage=f.getAvatarLink(a.profileImage,1),a.gender=a.gender.toLowerCase(),a.mobile=a.mobile,a.department=a.department,a.post=a.post,a.isStop=a.isStop})):b=[],b}}),l=Backbone.View.extend({tagName:"li",template:_.template(i.filter(".fs-employee-item-tpl").html()),className:"fs-employee-item",initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),m=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:18,visiblePageNums:7},listPath:"",defaultRequestData:{},searchOpts:{inputSelector:null,btnSelector:null},listCb:e.EMPTY_FN,listEmptyText:"暂无记录"},a||{}),this.opts=a,this.element=$(a.element),this.pagEl=$(a.pagSelector),this.pagination=null,this.tempRequestData={},this.listXhr=null,this.init()};_.extend(m.prototype,{init:function(){var a,b,c=this,d=this.opts,e=this.element;e.addClass("fs-employee-list").html('<div class="fs-employee-list-inner"></div>'),b=$(".fs-employee-list-inner",e),a=new k,a.on("add",function(a){var c;c=new l({model:a}).render(),c.$el.data("itemV",c).appendTo(b)}),this.list=a,this.pagination=new g(_.extend({element:this.pagEl},d.pagOpts)),this.pagination.on("page",function(){c.empty(),c.fetch()}),this.pagination.render(),d.searchOpts&&d.searchOpts.inputSelector&&this._searchBarInit(),this._initListEmptyTip()},_searchBarInit:function(){var a,b=this,c=this.opts,d=c.searchOpts,e=this.element,f=$(d.inputSelector),g=$(d.btnSelector);a=$('<div class="list-search-bar fn-clear"></div>'),a.html('<span class="result-info fn-left">共搜索到<span class="num color-red">0</span>条信息</span><a class="back-l fn-right" href="#" title="返回查看全部"><< 返回查看全部</a>'),a.hide().prependTo(e);var h=$('<span class="empty-h">&#10005;</span>'),i=$('<span class="list-search-input-wrapper"></span>');f.wrap(i),i=f.closest(".list-search-input-wrapper"),h.hide().appendTo(i),f.keydown(function(a){13==a.keyCode&&g.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(h.show(),f.addClass("with-input-value")):(h.hide(),f.removeClass("with-input-value"))}),h.click(function(){f.val(""),f.removeClass("with-input-value"),h.hide()}),a.on("click",".back-l",function(c){var d=$(".list-empty-tip",e);b.reload({keyword:""}),f.val(""),f.removeClass("with-input-value"),h.hide(),a.hide(),d.hide(),c.preventDefault()})},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".num",d);return!a.isFirstChar&&a.keyword.length>0&&b.success?(e.text(b.value.totalCount),d.show(),void 0):(d.hide(),void 0)},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+e.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.appendTo(a)},_updatelistStatus:function(a){var b,c=this.element,d=$(".list-empty-tip",c);a.success&&(b=a.value.totalCount,0==b?d.show():d.hide())},fetch:function(){var a=this,b=this.opts,c=(this.list,this.pagination),d=_.extend({pageSize:c.get("pageSize"),pageNumber:c.get("activePageNumber")});d=_.isFunction(b.defaultRequestData)?_.extend(b.defaultRequestData(),d):_.extend(b.defaultRequestData,d),d=_.extend(d,this.tempRequestData),this.tempRequestData={},this.showLoading(),this.listXhr&&this.listXhr.abort(),this.listXhr=this.list.fetch({url:b.listPath,data:d,success:function(e,f){var g;f.success&&(g=f.value,c.setTotalSize(g.totalCount),a._updateSearchBarState(d,f),a._updatelistStatus(f),b.listCb.call(a,f),a.hideLoading())}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a){this.tempRequestData=a,this.pagination.jump(1)},reload:function(a){this.load(a)},empty:function(){var a=$(".fs-employee-list-inner",this.element),b=$(".fs-employee-item",a);b.each(function(){var a=$(this),b=a.data("itemV");b.remove(),a.removeData()}),a.empty()},destroy:function(){this.list=null,this.pagination.destroy(),this.listXhr=null,this.loading&&this.loading.stop(),this.empty(),this.pagination=null,this.tempRequestData={},this.element=null}}),c.exports=m});