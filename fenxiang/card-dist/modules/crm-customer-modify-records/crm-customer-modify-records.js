/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-customer-modify-records/crm-customer-modify-records",["widget","modules/crm-customer-modify-records/crm-customer-modify-records.html","util","moment"],function(a,b,c){var d=window;d.FS,a("widget");var e=a("modules/crm-customer-modify-records/crm-customer-modify-records.html"),f=a("util"),g=a("moment"),h=Backbone.View.extend({records:[],params:null,template:_.template($(e).filter(".crm-modifyrecords-tpl").html()),refresh:function(a,b,c){!this.params&&(this.params=this.options),b&&(this.params.snapShotTitle=b),c&&(this.params.customerID=c),this.loadData(a)},bindEvents:function(){var a=this,b=this.$el.find(".mn-select-box");this.$el.find(".btn-left").bind("click",function(b){a.left(b)}),this.$el.find(".btn-right").bind("click",function(b){a.right(b)}),this.$el.find(".btn-back").bind("click",function(){a.back(a.params.customerID,f.mnGetter(b))}),f.mnEvent(b,"change",function(b){var c=a.getRecordIdx(b);a.refresh(b,a.records[c].title)})},back:function(a,b){var c=this;f.api({url:"/"+c.params.restoreUrl,type:"post",dataType:"json",data:{customerID:a,snapShotID:b},success:function(){f.remind(1,"恢复成功"),c.trigger("success")}})},left:function(a){var b=$(a.target),c=this.$el.find(".mn-select-box");if(!b.hasClass("btn-disabled")){var d=f.mnGetter(c),e=this.getRecordIdx(d);e>0&&f.mnSetter(c,this.records[e-1].snapshotID),1==e&&b.addClass("btn-disabled"),this.$el.find(".btn-right").removeClass("btn-disabled")}},right:function(a){var b=$(a.target),c=this.$el.find(".mn-select-box");if(!b.hasClass("btn-disabled")){var d=f.mnGetter(c),e=this.getRecordIdx(d);e<this.records.length-1&&f.mnSetter(c,this.records[e+1].snapshotID),e==this.records.length-2&&b.addClass("btn-disabled"),this.$el.find(".btn-left").removeClass("btn-disabled")}},getRecordIdx:function(a){a+="";for(var b=-1,c=0,d=this.records.length;d>c;c++)if(a==this.records[c].snapshotID+""){b=c;break}return b},loadData:function(a){var b=this,c=b.params.customerID,d=b.params.recordsUrl,e=b.params.snapshotsUrl;f.api({dataType:"json",type:"get",url:d,data:{customerID:c},beforeSend:function(){f.showGlobalLoading(1)},success:function(d){return!d.success||d.value.snapshots.length<1?(f.hideGlobalLoading(1),void 0):(b.formatRecords(d.value,a),f.api({dataType:"json",type:"get",url:e,data:{customerID:c,snapshotID:a||d.value.snapshots[0].snapshotID},success:function(a){if(f.hideGlobalLoading(1),a.success){var c=b.formatContent(a.value);b.render({records:b.records,main:c.main,desc:c.desc,snapShotTitle:b.params.snapShotTitle||b.records[0].title})}}}),void 0)}})},formatRecords:function(a,b){for(var c=a.snapshots,d=[],e=0,f=c.length;f>e;e++)d.push({title:[c[e].employee.name,"在",g.unix(c[e].snapshotTime).format("YYYY-MM-DD HH:mm"),"创建记录"].join(""),snapshotID:c[e].snapshotID,selected:b&&b==c[e].snapshotID?1:""});b||(d[0].selected=1),this.records=d},formatContent:function(a){var b=a.firstSnapshot,c=a.secondSnapshot;c.customerID||(c.name="",c.webSite="",c.address="",c.introduction="",c.fullName="");var d=[],e=[];return d.push({name:"",state:b.fullName!=c.fullName&&c.fullName?"change":"",value0:c.fullName,value1:b.fullName}),d.push({name:"简称",state:b.name!=c.name&&c.name?"change":"",value0:c.name,value1:b.name}),d.push({name:"地址",state:c.address!=b.address&&c.address?"change":"",value0:c.address||"无",value1:b.address}),d.push({name:"网址",state:c.webSite!=b.webSite&&c.webSite?"change":"",value0:c.webSite||"无",value1:b.webSite}),e.push({name:"简介",state:c.introduction!=b.introduction?"change":"",value0:c.introduction,value1:b.introduction}),{main:d,desc:e}},render:function(a){var b=this.$el,c=this.template;b.html(c(a)),this.options.wrapEl.html(b);var d=$(".content-desc",b);return d.css("height",d.find(".old").height()+d.find(".new").height()),this.bindEvents(),this}});c.exports=h});