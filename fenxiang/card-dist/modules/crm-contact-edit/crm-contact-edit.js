/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-contact-edit/crm-contact-edit",["modules/crm-contact-edit/crm-contact-edit.html","dialog","util","modules/publish/publish-helper","datatable","moment","uilibs/search-box","uilibs/pagination2"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-contact-edit/crm-contact-edit.html"),h=a("dialog"),i=a("util"),j=a("modules/publish/publish-helper");a("datatable"),a("moment"),a("uilibs/search-box"),a("uilibs/pagination2");var k=j.DateSelect,l=h.extend({attrs:{width:760,content:$(g).filter(".dialog-contact-template").html(),className:"dialog-crm",closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",contactData:void 0,customerID:void 0,customerName:void 0,address:void 0,webSite:void 0},events:{"click .dialog-button-submit":"submit","click .dialog-button-cancel":"hide","click .select-del":"delSelect","keyup .crm-contacts-contact-way":"addSelect","keyup .contact-address":"addSelect"},render:function(){var a=this,b=l.superclass.render.apply(this,arguments);return this.setupDoms(),this.setupComponent(),setTimeout(function(){$(".area-auto-height",a.element).trigger("autosize.resize")},1),b},hide:function(){var a=l.superclass.hide.apply(this,arguments);return this.reset(),a},reset:function(){var a=this.element;this.set("address",""),this.set("webSite",""),$(".area-auto-height",a).val("").removeAttr("style"),$(".dialog-input-text",a).val(""),$(".mn-select-box",a).each(function(){i.mnReset($(this))}),$(".contact-company",a).removeAttr("readonly").val("").removeAttr("data-id"),i.mnSetter($(".contact-gender-radio",a),""),i.mnSetter($(".crm-birth-year",a),""),i.mnSetter($(".crm-birth-month",a),""),i.mnSetter($(".crm-birth-day",a),"");var b=$(".crm-contact-address-ul",a),c=$(g).filter(".dialog-contacts-address");b.html("").append(c);var d=$(".crm-contact-ways-ul",a),e=$(g).filter(".dialog-contacts-contact-way");d.html("").append(e),i.mnSelect(e.find(".mn-select-box"),"syncModel",i.getContactsWays()),$(".dialog-input-text",this.element).val(""),_.map(this.defineDateFieldArray,function(a){a.dateObj.clear()}),$(".contact-tags-list-warp",a).html(""),this.set("contactData",null)},show:function(a){var b=l.superclass.show.apply(this,arguments);a&&a.contactID&&this.set("contactID",a.contactID);var c=this.get("contactID")?this.get("contactID"):void 0,d=this;a&&a.customerID&&a.customerName&&(this.set("customerID",a.customerID),this.set("customerName",a.customerName)),this.get("customerID");var e=this.get("customerName");if(e){var f=$(".contact-company",this.element);f.attr("data-id",a.customerID).val(a.customerName).attr("readonly",!0).css("color","#cdcdcd")}if(a&&a.address){this.set("address",a.address);var h=$(".crm-contact-address-ul",this.element),j=h.find("li");j.find(".contact-address").val(a.address),j.find(".select-del").show(),j=$(g).filter(".dialog-contacts-address"),h.append(j)}return a&&a.webSite&&(this.set("webSite",a.webSite),$(".contact-website",this.element).val(a.customerName)),$(".area-auto-height",d.element).trigger("autosize.resize"),c?i.api({url:"/Contact/GetContactByID",type:"get",dataType:"json",data:{contactID:c},success:function(a){a.success&&(d.set("contactData",a),d.setupTags(),d.fillFormData())}},{submitSelector:""}):d.setupTags(),b},submit:function(a){var b=this,c=this.get("contactData")?this.get("contactData").value:void 0,d=this.get("contactID")?this.get("contactID"):void 0,e=this.get("customerID")||0,f=$(a.currentTarget),g=this.element,h=$(".contact-name",g).val(),j=$(".contact-post",g).val(),k=$(".contact-department",g).val(),l=$(".contact-company",g).val(),m=$(".contact-website",g).val(),n="",o="",p=$(".contact-interest",g).val(),q=[],r=[],s=[],t=$(".contact-remark",g).val();n=i.mnGetter($(".contact-gender-radio",g));var u=i.mnGetter($(".crm-birth-year",g))||0,v=i.mnGetter($(".crm-birth-month",g))||0,w=i.mnGetter($(".crm-birth-day",g))||0;4!==(u+"").length&&(u=0),o=""+(u>0?u:"0000")+(10>v?"0"+v:v)+(10>w?"0"+w:w);var x=[];$(".crm-contact-ways-select",g).each(function(){x.push(i.mnGetter($(this))||1)});var y=0;$(".crm-contacts-contact-way",g).each(function(){var a=$(this).val();a&&q.push((x[y]<10?"0"+x[y]:x[y])+a),y++}),$(".contact-address",g).each(function(){$(this).val()&&r.push($(this).val())});var z=$(".contact-tags-list-warp > li",g);z.each(function(){var a=$(".f-business-tag-id",$(this)).data("fbusinesstagid"),b=$(".mn-select-box",$(this)),c=i.mnGetter(b)||0;s.push(a+","+c)});var A=$(".contact-define-fields-list-warp",g),B=[];if(A.find(".f-user-define-field-num").each(function(){B.push($(this).attr("data-fieldname")+","+$(this).next().find("input").val()||0)}),A.find(".f-user-define-field-text").each(function(){B.push($(this).attr("data-fieldname")+","+($(this).next().find("textarea").val()||""))}),_.map(this.defineDateFieldArray,function(a){B.push(a.fieldName+","+a.dateObj.getTime())}),c)i.api({url:"/Contact/UpdateContact",type:"post",dataType:"json",errorMsgTitle:"修改联系人发生错误，原因：",data:{contactID:parseInt(d),name:h,post:j,department:k,company:l,website:m,gender:n,birthday:o,interest:p,listContactWay:q,address:r.join(","),listTagOptionID:s,dataList:B,remark:t,source:1},success:function(a){a.success&&(b.hide(),i.remind(2,"保存成功"),b.v&&b.v.refresh&&b.v.refresh(),b.trigger("success"),b.trigger("updateSuccess"))}},{submitSelector:f});else{if(""==$.trim(h))return i.alert("请填写姓名"),void 0;i.api({url:"/Contact/AddContact",type:"post",dataType:"json",errorMsgTitle:"添加联系人发生错误，原因：",data:{customerID:e,name:h,post:j,department:k,company:l,website:m,gender:n,birthday:o,interest:p,listContactWay:q,address:r.join(","),listTagOptionID:s,dataList:B,remark:t,source:1},success:function(a){a.success&&(b.hide(),i.remind(2,"添加成功"),b.v&&b.v.refresh&&b.v.refresh(),b.trigger("success"))}},{submitSelector:f})}},delSelect:function(a){var b=$(a.target).parent().parent();1==b.parent().children().length||b.remove()},addSelect:function(a){var b=$(a.target),c=b.parent().parent();if(0==c.next().length){b.next().show();var d;d=b.hasClass("contact-address")?$(g).filter(".dialog-contacts-address"):$(g).filter(".dialog-contacts-contact-way"),c.parent().append(d),i.mnSelect(d.find(".mn-select-box"),"syncModel",i.getContactsWays()),j.AdjustTextAreaSize({element:d.find(".area-auto-height")})}},setupDoms:function(){var a=this.element;this.autoHeightTextarea=$(".area-auto-height",a)},setupComponent:function(){this.get("contactData")&&this.get("contactData").value;var a=this.get("customerName"),b=this.element;$(".contact-tags-list-warp",b),a&&$(".contact-company",b).val(a).attr("readOnly",!0).css("color","#cdcdcd"),this.setupBirthComponent();var c=$(".crm-contact-ways-select",b),d=i.getContactsWays();i.mnSelect(c,"syncModel",d);var e=i.getUserDefineFieldByType(2);this.defineDateFieldArray=[];var f=$(".contact-define-fields-list-warp",b);e&&e.length>0&&f.show(),this.defineDateFieldArray=i.generateDefineField(f,e,k),j.AdjustTextAreaSize({element:$(".area-auto-height",b)}),$(".area-auto-height",b).trigger("autosize.resize")},setupTags:function(){var a=this.get("contactData")&&this.get("contactData").value,b=this.element,c=$(".contact-tags-list-warp",b),d=i.getCrmData(),e=d.fBusinessTags,f=[];_.each(e,function(a){a.type===i.CONSTANT.TAG_TYPE.CONTACTS&&f.push(a)}),_.each(f,function(b){var d,e,f,g=b.name,h=b.options,i="",j="";if(a&&(d=_.find(a.fBusinessTagRelations,function(a){return b.fBusinessTagID==a.fBusinessTagID}),e=d&&d.fBusinessTagOptionID,f=d&&d.fBusinessTagOptionName),h.length>0){var k=_.find(h,function(a){return a.fBusinessTagOptionID==e});_.each(h,function(a){var b=a.isDefault;k&&a.fBusinessTagOptionID==e?(j=f,i+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+e+'" data-selected="'+!0+'">'+f+"</li></ul>"):b?(j=a.name,i+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'" data-selected="'+b+'">'+a.name+"</li></ul>"):i+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'">'+a.name+"</li></ul>"})}else i='<ul class="mn-select-list"><li class="mn-select-item" data-value="0"></li></ul>';c.append('<li class="fn-clear"> <div class="inputs-tit f-business-tag-id" data-fbusinesstagid="'+b.fBusinessTagID+'"> '+g+' </div> <div class="selects-warp"> <span select-cls="" class="mn-select-box "><span class="mn-select-title-wrapper select-for-dialog"><span class="mn-select-title ">'+j+'</span><span class="title-icon"></span></span>'+i+"</span> </div> </li>")})},setupBirthComponent:function(){for(var a=this.element,b=$(".crm-birth-year",a),c=(new Date).getFullYear(),d=[{value:"",text:""}],e=0;100>e;e++)d.push({value:c,text:c+"年"}),c-=1;i.mnSelect(b,"syncModel",d),i.mnEvent(b,"change",function(a){var b=a,c=i.mnGetter(f);if(c)var d=new Date(new Date(b,c)-86400).getDate();for(var e=[{value:"",text:""}],g=1;d>=g;g++)e.push({value:g,text:(10>g?"0"+g:g)+"日"});i.mnSelect(j,"syncModel",e)});var f=$(".crm-birth-month",a);(new Date).getFullYear();for(var g=[{value:"",text:""}],h=1;13>h;h++)g.push({value:h,text:(10>h?"0"+h:h)+"月"});i.mnSelect(f,"syncModel",g),i.mnEvent(f,"change",function(a){var c=i.mnGetter(b)||0,d=a;if(c)var e=new Date(new Date(c,d)-86400).getDate();else var e=2==a?29:4==a||6==a||9==a||11==a?30:31;for(var f=[{value:"",text:""}],g=1;e>=g;g++)f.push({value:g,text:(10>g?"0"+g:g)+"日"});i.mnSelect(j,"syncModel",f)});for(var j=$(".crm-birth-day",a),k=[{value:"",text:""}],l=1;32>l;l++)k.push({value:l,text:(10>l?"0"+l:l)+"日"});i.mnSelect(j,"syncModel",k)},fillFormData:function(){var a=this.element,b=this,c=this.get("contactData")&&this.get("contactData").value;if($(".contact-name",a).val(c.name),$(".contact-post",a).val(c.post),$(".contact-department",a).val(c.department),$(".contact-company",a).val(c.company),$(".contact-website",a).val(c.webSite),$(".contact-interest",a).val(c.interest),$(".contact-remark",a).val(c.remark),c.gender&&i.mnSetter($(".contact-gender-radio",a),c.gender),c.yearOfBirth&&i.mnSetter($(".crm-birth-year",a),c.yearOfBirth),c.monthOfBirth&&i.mnSetter($(".crm-birth-month",a),c.monthOfBirth),c.dayOfBirth&&i.mnSetter($(".crm-birth-day",a),c.dayOfBirth),c.contactWayObject&&c.contactWayObject.length>0)for(var d=$(".crm-contact-ways-ul",a),e=d.find("li"),f=0,h=c.contactWayObject.length;h>f;f++)e.find(".crm-contacts-contact-way").val(c.contactWayObject[f].content),e.find(".select-del").show(),i.mnSetter(e.find(".mn-select-box"),c.contactWayObject[f].type),e=$(g).filter(".dialog-contacts-contact-way"),d.append(e),i.mnSelect(e.find(".mn-select-box"),"syncModel",i.getContactsWays());if(c.addressObject&&c.addressObject.length>0)for(var d=$(".crm-contact-address-ul",a),e=d.find("li"),f=0,h=c.addressObject.length;h>f;f++)e.find(".contact-address").val(c.addressObject[f]),e.find(".select-del").show(),e=$(g).filter(".dialog-contacts-address"),d.append(e),j.AdjustTextAreaSize({element:e.find(".area-auto-height")});_.map(c.fBusinessTagRelations,function(b){b.fBusinessTagOptionID&&i.mnSetter($("[data-fbusinesstagid="+b.fBusinessTagID+"]",a).next().children(".mn-select-box"),b.fBusinessTagOptionID)}),c.userDefineFieldDataList&&c.userDefineFieldDataList.dateList&&_.map(c.userDefineFieldDataList.dateList,function(a){var c=_.find(b.defineDateFieldArray,function(b){return b.fieldName==a.fieldName});a.value>0&&c.dateObj.setValue(1e3*a.value)});var k=$(".contact-define-fields-list-warp",a);c.userDefineFieldDataList&&c.userDefineFieldDataList.numList&&_.map(c.userDefineFieldDataList.numList,function(a){k.find("div[data-fieldname='"+a.fieldName+"']").next().find("input").val(a.value)}),c.userDefineFieldDataList&&c.userDefineFieldDataList.textList&&_.map(c.userDefineFieldDataList.textList,function(a){k.find("div[data-fieldname='"+a.fieldName+"']").next().find("textarea").val(a.value)}),$(".area-auto-height",a).trigger("autosize.resize")}});c.exports=l});