/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-paymentplan-edit/crm-paymentplan-edit",["modules/crm-paymentplan-edit/crm-paymentplan-edit.html","dialog","util","modules/publish/publish-helper","uilibs/currency-input","moment","modules/crm-select-customer/crm-select-customer","modules/crm-select-colleague/crm-select-colleague","modules/crm-select-opp/crm-select-opp"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-paymentplan-edit/crm-paymentplan-edit.html"),h=a("dialog"),i=a("util"),j=a("modules/publish/publish-helper"),k=j.DateSelect,l=a("uilibs/currency-input");a("moment"),a("modules/crm-select-customer/crm-select-customer");var m=a("modules/crm-select-colleague/crm-select-colleague");a("modules/crm-select-opp/crm-select-opp");var n=h.extend({attrs:{width:760,content:$(g).filter(".dialog-paymentplan-template").html(),className:"dialog-crm",closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",contractID:void 0,contractTitle:void 0,contractPaymentPlan:void 0,contractPaymentPlanID:void 0,ownerID:void 0,ownerName:void 0,payTimes:[]},events:{"click .dialog-button-submit":"submit","click .dialog-button-cancel":"hide","click .contract-discount-checkbox-item":"_switchDiscount","click .paymentplan-ownerID-btn":"selectOwner"},render:function(){var a=this.element,b=n.superclass.render.apply(this,arguments);return this.setupDoms(),this.setupComponent(),this.selectOwnerDialog=new m({isMultiSelect:!1,hasWorkLeaveBtn:!1,title:"选择同事"}),this.selectOwnerDialog.on("selected",function(b){$(".paymentplan-ownerID",a).val(b.name).attr("data-id",b.employeeID)}),b},hide:function(){var a=n.superclass.hide.apply(this,arguments);return this.reset(),a},reset:function(){var a=this.element;$(".paymentplan-description",a).val("").css("height",100),i.mnSetter($(".paymentplan-paymentTimes",this.element),1),this.expectedTime.clear(),this.amount.reset(),this.set("contractPaymentPlanID",""),$(".paymentplan-ownerID",a).val(this.get("ownerName")).attr("data-id",this.get("ownerID"))},show:function(a){var b=this,c=this.element,d=n.superclass.show.apply(this,arguments);a&&(a.contractPaymentPlanID&&this.set("contractPaymentPlanID",a.contractPaymentPlanID),a.contractTitle&&$(".contract-title",c).val(a.contractTitle),a.ownerID&&a.ownerName&&$(".paymentplan-ownerID",c).val(a.ownerName).attr("data-id",a.ownerID));var e=this.get("contractPaymentPlanID")?this.get("contractPaymentPlanID"):void 0;return e&&i.api({url:"/Contract/GetContractPaymentPlanByID",type:"get",dataType:"json",data:{contractPaymentPlanID:e},success:function(a){a.success&&(b.set("contractPaymentPlan",a),b.fillFormData())}},{submitSelector:""}),d},submit:function(a){var b=this,c=this.get("contractPaymentPlan")?this.get("contractPaymentPlan").value.contractPaymentPlan:void 0,d=this.get("contractPaymentPlanID")?this.get("contractPaymentPlanID"):void 0,e=this.get("contractID")||0,f=this.get("ownerID")||0,g=$(a.currentTarget),h=this.element,j=this.amount.val(),k=this.expectedTime.getTime(),l=i.mnGetter($(".paymentplan-paymentTimes",h))||1,m=$(".paymentplan-description",h).val(),f=$(".paymentplan-ownerID",h).attr("data-id");return-1==j?(i.alert("请填写正确金额"),void 0):0==j?(i.alert("金额必须大于0"),void 0):0==k?(i.alert("请填写计划回款日期"),void 0):(c?i.api({url:"/Contract/UpdateContractPaymentPlan",type:"post",dataType:"json",data:{contractPaymentPlanID:d,ownerID:f,amount:j,expectedTime:k,description:m},success:function(a){a.success&&(b.hide(),i.remind(2,"保存成功"),b.trigger("success"))}},{submitSelector:g}):i.api({url:"/Contract/AddContractPaymentPlan",type:"post",dataType:"json",data:{contractID:e,ownerID:f,amount:j,expectedTime:k,paymentTimes:l,description:m},success:function(a){a.success&&(b.hide(),i.remind(2,"添加成功"),b.trigger("success"))}},{submitSelector:g}),void 0)},setupDoms:function(){var a=this.element;this.conTextareaEl=$(".area-auto-height",a)},setupComponent:function(){this.get("contractPaymentPlan")||void 0;var a=this.get("contractTitle")||"",b=this.get("ownerID")||"",c=this.get("ownerName")||"",d=this.element;$(".contract-title",d).val(a),$(".paymentplan-ownerID",d).val(c).attr("data-id",b),this.expectedTime=new k({element:$(".paymentplan-expectedTime",d),placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）",isCRM:!0}),this.amount=new l({element:$(".paymentplan-amount",d)});for(var e=[],f=1,g=13;g>f;f++)e.push({value:f,text:f+"期"});i.mnSelect($(".paymentplan-paymentTimes",d),"syncModel",e),j.AdjustTextAreaSize({element:this.conTextareaEl})},fillFormData:function(){this.get("contractPaymentPlanID")?this.get("contractPaymentPlanID"):void 0;var a=this.get("contractPaymentPlan")?this.get("contractPaymentPlan").value.contractPaymentPlan:void 0,b=this.element;a&&($(".paymentplan-paymentTimes",b).hide().prev().val(a.paymentTimes+"期").show(),this.amount.setValue(a.amount),this.expectedTime.setValue(1e3*a.expectedTime),i.mnSetter($(".paymentplan-paymentTimes",b),a.paymentTimes),$(".paymentplan-description",b).val(a.description),$(".paymentplan-ownerID",b).attr("data-id",a.ownerID).val(a.owner&&a.owner.name),$(".area-auto-height",b).trigger("autosize.resize"))},_switchDiscount:function(a){$(a.target).hasClass("mn-selected")?$(a.target).next().next().hide():$(a.target).next().next().show()},selectOwner:function(){this.selectOwnerDialog.show()}});c.exports=n});