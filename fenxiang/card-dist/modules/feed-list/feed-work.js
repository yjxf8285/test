/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/feed-list/feed-work",["util","uilibs/pagination","moment","./feed-list.html"],function(a,b,c){var d=window;d.FS;var e=a("util"),f=a("uilibs/pagination"),g=a("moment"),h=a("./feed-list.html"),i=$(h);_.template(i.filter(".fs-worktodo-item-wrapper").html());var j=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:45,totalSize:0,visiblePageNums:7},defaultRequestData:{}},a||{}),this.opts=a,this.element=$(a.element),this.pagEl=$(a.pagSelector),this.pagination=null,this.init()};_.extend(j.prototype,{init:function(){var a=this,b=this.opts,c=this.element;this.list,c.addClass("work-reply-list-send").html('<div class="work-reply-list-tbar"></div><div class="work-reply-list-inner"></div>'),this._initTbar(),this.pagination=new f(_.extend({element:this.pagEl},b.pagOpts)),this.pagination.on("page",function(){a.empty(),a.fetch()}),this.pagination.render(),this._regEvents()},_initTbar:function(){var a=this.element,b=$(".work-reply-list-tbar",a);b.html('<label>确认结果：</label><button class="undone-l" type="button">未完成继续执行</button><button class="done-l" type="button">已完成点评结果</button>')},_regEvents:function(){this.element},_createItem:function(a){var b,c,d=this.element,e=$(".fs-worktodo-list-inner",d);return b=replyItemCompiled({title:a.title,createTime:g.unix(a.createTime).startOf("hour").fromNow()}),c=$(b),c.data("store",a).appendTo(e),a.feed&&this._createFeedV(c),c},prependNewTask:function(a){var b=this,c=this.element,d=$(".fs-worktodo-list-inner",c);this.showLoading(),e.api({type:"get",data:{workToDoListID:a},url:"/worktodolist/getWorkToDoListByID",success:function(a){var c;a.success&&(c=a.value,_.each(c,function(a){var c=b._createItem(a);c.prependTo(d)}),b.pagination.setTotalSize(b.pagination.get("totalSize")+1),b.hideLoading())}})},fetch:function(){var a=this,b={},c=this.opts,d=this.pagination,f=this.element,g=$(".fs-worktodo-list-inner",f);b=_.extend({pageSize:d.get("pageSize"),pageNumber:d.get("activePageNumber")},b||{}),b=_.isFunction(c.defaultRequestData)?_.extend(c.defaultRequestData(),b):_.extend(c.defaultRequestData,b),this.showLoading(),e.api({type:"get",data:_.extend({isImportant:"0",isCompleted:"0",keyword:"",pageSize:d.get("pageSize"),pageNumber:d.get("activePageNumber")},b),url:"/worktodolist/getWorkToDoLists",success:function(b){var c;b.success&&(c=b.value.items,_.each(c,function(b){var c=a._createItem(b);c.appendTo(g)}),a.pagination.setTotalSize(a.pagination.get("totalSize")+1),a.hideLoading())}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);a||(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"></span><span class="loading-text">正在加载，请稍后&#8230;</span>'),a=new Spin({color:"#0082CB",length:5,width:2,radius:3,top:5}).spin($(".icon-loading",c).get(0)),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(){this.pagination.jump(1)},reload:function(){this.load()},removeItemEl:function(a){var b=$(a),c=b.data("feedV");c&&c.destroy&&c.destroy(),b.removeData(),b.remove()},empty:function(){var a=$(".fs-worktodo-list-inner",this.element),b=$(".fs-worktodo-item",a);b.each(function(){var a=$(this),b=a.data("feedV");b&&b.destroy&&b.destroy(),a.removeData()}),a.empty()},destroy:function(){this.pagination.destroy(),this.loading&&this.loading.stop(),this.empty(),this.pagination=null,this.element=null}}),c.exports={workReplyListSend:j}});