/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/feed-list/feed-list-c",["util","modules/feed-list/fl-util","moment","modules/feed-list/feed-list-m","./feed-list-helper"],function(a,b){function c(a){var b={};b=_.extend(b,r.common(a));var c=parseInt(a.feedType);switch(c){case 101:case 1001:case 1:b=_.extend(b,r.share(a,b));break;case 2001:b=_.extend(b,r.share(a,b));break;case 2002:b=_.extend(b,r.share(a,b));break;case 2:b=_.extend(b,r.plan(a,b));break;case 3:b=_.extend(b,r.work(a,b));break;case 4:b=_.extend(b,r.approve(a,b))}return b.originData=a,b.feedType=c,b}var d=window,e=d.FS,f=e.tpl;f.store,f.event;var g=a("util"),h=a("modules/feed-list/fl-util"),i=a("moment"),j=a("modules/feed-list/feed-list-m"),k=a("./feed-list-helper"),l=k.feedContentFormat,m=k.picturesFormat,n=k.filesFormat,o=g.getContactData(),p=o.u,q=k.feedContentFormat_,r={common:function(a){var b={};b.meProfileImage=p.profileImage,b.rootPath=e.API_PATH,b.isWhat=a.isWhat||"",b.feedContent=a.feedContent,b.fiveStar=a.fiveStar||"",b.leaderinfo=a.leaderinfo||"",b.replyContent=a.replyContent||"",b.feedID=a.feedID||"",b.employeeID=a.sender.employeeID||"",b.textcur=a.textcur||"",b.textbtn=a.textbtn||"",b.feedPic=a.feedPic||"",b.feedFiles=a.feedFiles||"",b.pictures=a.pictures||"",b.sourceDescription=a.sourceDescription||"",b.archive=a.archive||"",b.serviceTime=a.serviceTime||"",b.announcement=a.announcement||null,b.voteItem=a.voteItem||null,b.schedule=a.schedule||null,b.isHide="",b.morePendingW="",b.onencrypted="",b.isencryptedTit="";var c=a.isEncrypted;c&&(b.onencrypted="onencrypted",b.isencryptedTit=a.encryptTitle,b.isHide="hide");var d,f=a.like.likeCount,h=a.isAlreadyLike,j="",o="取消赞",r="islike cur",s='(<span class="likecountnum">'+f+"</span>)",t=a.like.likeEmployees,u="",v="",w="",x="";t&&(_.each(t,function(a){var b=a.name,c=g.getAvatarLink(a.profileImage,"2"),d=a.employeeID;v+='<a href="#profile/=/empid-'+d+'" class="js-empids" title="'+b+'"><img alt="'+b+'" src="'+c+'"></a>'}),t.length>5?(w='<a href="#stream/showfeed/=/id-'+b.feedID+'/open-like" title="更多" class="islike-more"></a>',d=200):(w='<a href="#stream/showfeed/=/id-'+b.feedID+'/open-like" title="更多" class="islike-more hide"></a>',d=40*t.length)),h||(o="赞",r="islike",s="",u=""),u='<div class="islike-tip" style="display:none;width: '+d+'px"><div class="toparrow"> <em>◆</em> <span>◆</span> </div>'+v+w+"</div>",f>0?(s='(<span class="likecountnum">'+f+"</span>)",x=""):(u="",x="hide"),j='<div class="fl-fn-btn '+r+'"><span class="islike-btn aj-feed-fn-com-btn" title="'+o+'"><b></b><a href="javascript:void(0);" class="likecount '+x+'">'+s+'</a><i class="S_txt3">|</i></span>'+u+"</div>",b.islike=j;var y=0,z='<div class="fl-fn-btn '+r+'"><span class="islike-btn aj-feed-fn-com-btn islikelist-btn" title="'+o+'"><b></b><a href="javascript:void(0);" class="likecount '+x+'">'+s+'</a><i class="S_txt3">|</i></span></div>';y&&(b.islike=z),b.listprofileImage=g.getAvatarLink(a.sender.profileImage,"2");var A='<div class="img-new"></div>';b.newico=a.isUnRead?A:"";var B=a.followTime,C="";B?(B=i.unix(B).format("YYYY年MMMDD日 HH:mm"),C='<div class="followtimeinfo">关注于：'+B+"</div>",b.oftimetext=C):b.oftimetext="";var D=g.getFeedTypeName(a.feedType);2==a.feedType&&(D=g.getPlanTypeName(a.plan.planType)),b.feedTypeDescription=D,b.feedRangeDescription=a.feedRangeDescription?'<span>-</span> <span class="group"> <a href="javascript:void(0);" title="'+a.feedRangeTip+'"> '+a.feedRangeDescription+"</a> </span>":'<span>-</span> <span class="group"> <a href="javascript:void(0);" title="'+a.feedRangeTip+'"> 数据错误 </a> </span>',b.sendername='<a class="employee-name" href="#profile/=/empid-'+a.sender.employeeID+'">'+a.sender.name+"</a>",b.senderNameNoLink=a.sender.name,_.extend(b,m(a.pictures||[]));var E=function(){var c=a.feedNDFiles,d="",f="",h='<a class="networklink-btn" href="#entnetworkdisk">进入网盘</a>';c.length>0?(_.each(c,function(a){var b=a.isPreview;f=b?'<a href="#" class="attach-preview-l v">预览</a>':"",d+='<dl attachid="'+a.ndFileID+'"><dt><img src="'+e.ASSETS_PATH+"/images/file/"+g.getFileType({name:a.attachName},!0)+'.png" alt=""></dt><dd><p>'+a.attachName+"("+g.getFileSize(a.attachSize)+')</p><p><a href="'+g.getDfLink(a.attachPath,a.attachName,!0)+'" class="d" title="'+a.name+'" target="_blank">下载</a> '+f+"</p></dd></dl>"}),b.feedFiles='<div class="feed-files feed-attach fn-clear netdiskfile">'+d+h+"</div>"):_.extend(b,n(a.files||[]))};E(),b.archiveData=b.archive,b.archive=k.renderArchiveBar(b.archive,a);var F=a.createTime,G=g.getDateSummaryDesc(i.unix(F),i.unix(a.serviceTime),1);b.createTimeNoLink=G,b.createTime='<a href="#stream/showfeed/=/id-'+b.feedID+'" class="f-date"> '+G+"</a>",b.nolinkcreateTime=G;var H=l(a.feedContent,a);b.feedText=H,b.pendfeedText=H,b.feedFormatContent=q(300,a);var I=a.replyCount;I=0==I?"":'(<span class="num">'+I+"</span>)";var J='<a href="javascript:void(0);" class="aj-delete aj-feed-fn-com-btn">删除</a>',K='<a href="javascript:void(0);" class="aj-unplaceonfile aj-feed-fn-com-btn">取消归档</a>',L='<a href="javascript:void(0);" class="aj-unattention follow-action-h aj-feed-fn-com-btn">取消关注</a>',M='<div class="fl-fn-btn"><i class="S_txt3">|</i> <a href="javascript:void(0);" class="aj-pending aj-feed-fn-com-btn">待办</a></div>',N='<div class="fl-fn-btn"><i class="S_txt3">|</i> <a href="javascript:void(0);" class="aj-Reply aj-feed-fn-com-btn"> 回复'+I+"</a></div>",O='<div class="fl-fn-btn"><a href="javascript:void(0);" class="aj-Reply aj-feed-fn-com-btn rc">同事回复'+I+"</a></div>";b.fnReplyPre='<div class="fl-fn-btn"><a href="javascript:void(0);" class="aj-replytext aj-feed-fn-com-btn fl-common-up-arrow"> 回复'+I+"</a></div>",b.fnDeleteW="",b.fnUnplaceonfileW="",b.fnApprovalW="",b.fnPendingW=M,b.fnCommentonW="",b.fnCcW="",b.fnModifyapprovalW="",b.fnWorkingReW="",b.fnWorkSendW="",b.fnReplyW=N,b.fnReplyRcW=O,p.id==b.employeeID&&a.canDelete&&(b.fnDeleteW=J),b.fnUnattentionW=a.isFollowed?L:'<a href="javascript:void(0);" class="aj-attention follow-action-h aj-feed-fn-com-btn">关注</a>',b.fnUnplaceonfileW=a.isArchived?K:'<a class="aj-placeonfile aj-feed-fn-com-btn" href="javascript:;">归档</a>',b.feedLocationStr="";var P,Q=a.feedLocation,R="",S="",T="",U="",V="",W="",X="",Y="",Z="";return Q&&(P=Q.isTokenChenged,T=Q.country,U=Q.province,V=Q.city,W=Q.district,X=Q.street,Y=Q.streetNumber,S=T+U+V+W+X+Y,P&&(Z='<img src="'+e.ASSETS_PATH+'/images/location_istokenchenged.png" class="istokenchenged-ico" title="该用户本次签到所用设备与上次不同"> '),R='<div class="feed-location"><span class="feed-location-text fn-left">'+S+'</span><span class="feed-location-fn"><a href="#" class="feed-location-fn-map">显示地图</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript: void(0);" class="aj-feed-fn-com-btn feed-location-fn-equipment">查看设备</a>'+Z+'</span><img src="http://maps.googleapis.com/maps/api/staticmap?language=zh-CN&size=546x100&zoom=13&markers=color:red%7C'+Q.latitude+","+Q.longitude+'&sensor=false&key=AIzaSyCVmXMoRwu4GCJzrH2KnAz-6pgOBuV2Rdc" width="546" height="100" class="googlemap-jpg"/></div>',b.feedLocationStr=R,b.feedLocation=Q),b},share:function(a){var b,c={},d=a.announcement,f="";c.deletegg="",d?(f=d.title,b=d.isShow,c.isShowText=b?"不显示":"显示",_.some(p.functionPermissions,function(a){return 1==a.value})&&d.canDelete&&(c.deletegg='<a class="aj-delete" href="javascript:void(0);">删除</a><i class="S_txt3">|</i>',c.fnDeleteW='<a href="javascript:void(0);" class="aj-delete">删除</a>'),c.announcetit=f):c.announcetit="";var h=a.voteItem,j="",k="";h?(k=h.voteEmpCount,c.votecount=k,j=e.API_PATH+"/df/GetVoteResultExcel?feedID="+a.feedID,c.votedownurl=j):(c.votecount="",c.votedownurl=""),c.schedule=a.schedule;var l,m,n,o,q,r,s,t=a.schedule,u=a.sender.employeeID,v=g.getContactData().u.id,w="",x=a.serviceTime;t?(t.relateEmployees&&(m=t.relateEmployees,n=m.length,_.each(m,function(b){var c=(b.employeeID,b.name);b.profileImage,w+=c+"，",q=a.feedRangeDescription}),w=w.substr(0,w.length-1),w="",c.feedRangeDescription='<span>-</span> <span class="schedulesgroup"> <a href="javascript:void(0);" title="'+w+'"> '+q+" </a> </span>"),r=i.unix(t.startTime).format("YYYY"),s=i.unix(x).format("YYYY"),l=r==s?i.unix(t.startTime).format("MMMDD日 (dddd) HH:mm"):i.unix(t.startTime).format("YYYY年MMMDD日 (dddd) HH:mm"),o=g.getSmsRemindTypeName(t.smsRemindType),u==v?(c.voteico="voteico.gif",c.voteSenderInfo=""):(c.voteico="voteico_blue.gif",c.voteSenderInfo='<div class="from">该日程由<a href="#profile/=/empid-'+a.sender.employeeID+'">'+a.sender.name+"</a>为您创建。</div>"),c.startTime=l,c.smsRemindTypeText=o):c.startTime="错误了";var y=a.smsRemaindCount;a.readCount,c.smsRemaind=0==y?"":' <a href="#" class="msmremaindcount alertlistbtn">短信提醒'+y+"人</a>";var z=a.receipt,A=0,B=0,C=0,D=!1,E="",F="";return c.receiptfn="",c.receiptRemaind="",z&&(A=z.requireReceiptCount,B=z.receiptedCount,C=z.myReceiptStatus,D=z.isSendSms,1===C?c.receiptfn='<a href="javascript:;" class="receiptbtn aj-receipt-fn">立即回执</a>':2==C&&(c.receiptfn='<a href="javascript:;" class="receiptbtn disable">已回执</a>'),D&&(E="已发短信，"),F=a.pictures&&a.pictures.length>0||a.files&&a.files.length>0||a.voteItem?"no-top-line":"",c.receiptRemaind=' <div class="receiptfnwarp '+F+'"><a href="#" class="receiptalertlist alertlistbtn">需'+A+"人回执，"+E+"已回执"+B+"人</a></div>",c.receiptedCount=B),c},plan:function(a){var b,c={},d=l(a.feedContent,a),e=l(a.plan.reportContent,a),f=l(a.plan.planContent,a),g="",h="",i=a.replyCount;i=0==i?"":'(<span class="num">'+i+"</span>)";var j='<div class="fl-fn-btn"><i class="S_txt3">|</i> <a href="javascript:void(0);" class="aj-commenton">点评'+i+"</a></div>";switch(c.feedID=a.feedID,a.plan.planType){case 0:h="planType为0";break;case 1:h='<p class="work-tit">今日工作总结</p><p>'+e+'</p><p>&nbsp;</p><p class="work-tit">明日工作计划</p><p>'+f+'</p><p>&nbsp;</p><p class="work-tit">工作心得体会</p><p>'+d+"</p>";break;case 2:h='<p class="work-tit">本周工作总结</p><p>'+e+'</p><p>&nbsp;</p><p class="work-tit">本周工作计划</p><p>'+f+'</p><p>&nbsp;</p><p class="work-tit">工作心得体会</p><p>'+d+"</p>";break;case 3:h='<p class="work-tit">本月工作总结</p><p>'+e+'</p><p>&nbsp;</p><p class="work-tit">本月工作计划</p><p>'+f+'</p><p>&nbsp;</p><p class="work-tit">工作心得体会</p><p>'+d+"</p>"}c.pendfeedText=d+" "+e+" "+f,c.feedText=h,a.plan.isComment?(c.leaderinfo="",c.isWhat='<span>-</span><span class="con"><a href="javascript:void(0);">已点评</a></span>'):(a.plan.leader?(g=a.plan.leader.name||"",b=a.plan.leader.employeeID,g='<a class="employee-name" href="#profile/=/empid-'+b+'">'+g+"</a>",c.leaderinfo='<div class="plan-leader">该日志由'+g+"点评。</div>"):c.leaderinfo="",c.isWhat='<span>-</span><span class="con"><a href="javascript:void(0);">未点评</a></span>',c.replyContent="");var k=a.plan.rate,m="";if(k>0){switch(k){case 1:m="一分：严重批评";break;case 2:m="二分：不合格";break;case 3:m="三分：符合要求";break;case 4:m="四分：超过预期";break;case 5:m="五分：非常满意"}c.fiveStar='<div class="five-star num'+k+'" title="'+m+'"></div>'}else c.fiveStar="";a.plan.canComment?(c.fnCommentonW=j,c.fnReplyW=""):c.fnCommentonW="",c.planType=a.plan.planType;var n=a.replies;return c.repliesBtn=n.length>0?'<a href="javascript:;" class="replies-btn aj-feed-fn-com-btn fl-common-up-arrow">关键回复('+n.length+")</a>":"",c},work:function(a){var b,c,d={};d.feedID=a.feedID,d.canCancel=a.canCancel;var e=a.work.rate;d.fiveStar=e>0?'<div class="five-star num'+e+'"></div>':"";var f="不提醒";switch(a.work.smsRemindType){case 1:f="";break;case 2:f="短信提醒一次";break;case 3:f="短信提醒两次";break;case 4:f="短信提醒三次"}var h="第一次短信提醒："+i.unix(a.work.smsRemindTime1).format("MMMDD日 HH:mm")+"&#10;";b=a.work.smsRemindTime2?"第二次短信提醒："+i.unix(a.work.smsRemindTime2).format("MMMDD日 HH:mm")+"&#10;":"",c=a.work.smsRemindTime3?"第三次短信提醒："+i.unix(a.work.smsRemindTime3).format("MMMDD日 HH:mm"):"";var j=h+b+c,k=g.getWorkStatusName(a.work.status);a.work.isComment&&(k="已点评"),d.isWhat=a.work.smsRemindType>1?'<span>-</span><span class="con"><a href="javascript:void(0);">'+k+'</a></span><span>-</span><span class="con"><a href="javascript:void(0);" title="'+j+'">'+f+"</a></span>":'<span>-</span><span class="con"><a href="javascript:void(0);">'+k+"</a></span>";var l=g.getDateSummaryDesc(i.unix(a.work.deadline),i.unix(a.serviceTime),2),m=g.getDateSummaryDesc(i.unix(a.work.endTime),i.unix(a.serviceTime),2),n="",o=a.work.executer.name,p=g.getContactData().u.id,q=a.work.executer.employeeID;switch(o='<a class="employee-name" href="#profile/=/empid-'+q+'">'+o+"</a>",d.executer=p==q?"1":"0",a.work.status){case 1:n=a.work.deadline<a.serviceTime?"应于"+l+'前完成，<span class="highlight">该指令已超时。</span>':"应于"+l+"前完成，该指令正在执行。";break;case 2:n="该指令已于"+m+"完成。";break;case 3:n="已于"+m+"取消。"}d.leaderinfo='<div class="plan-leader">该指令由'+o+"执行，"+n+"</div>";var r=a.replies;return d.repliesBtn=r.length>0?'<a href="javascript:;" class="replies-btn aj-feed-fn-com-btn fl-common-up-arrow">关键回复('+r.length+")</a>":"",a.work.canCancel&&(d.fnDeleteW='<a href="javascript:void(0);" class="aj-delete">取消</a>'),d},approve:function(a){if(a.approve){var b={},c=a.replyCount||"";b.feedID=a.feedID,b.canCancel=a.canCancel,s=g.getContactData().u.id;var d='<div class="fl-fn-btn"><i class="S_txt3">|</i> <a href="javascript:void(0);" class="aj-approbtn aj-feed-fn-com-btn">批复</a></div>',f='<div class="fl-fn-btn"><i class="S_txt3">|</i> <a href="javascript:void(0);" class="aj-cc aj-feed-fn-com-btn">抄送</a></div>',j='<div class="fl-fn-btn"><i class="S_txt3">|</i> <a href="javascript:void(0);" class="aj-pending aj-feed-fn-com-btn">待办</a></div>',k='<div class="fl-fn-btn"><i class="S_txt3">|</i><a href="javascript:void(0);" class="aj-modifyapproval aj-feed-fn-com-btn">修改审批人</a></div>',m='<a href="javascript:void(0);" class="aj-pending aj-feed-fn-com-btn">待办</a>',n=g.getApproveStatusName(a.approve.status);if(d=c>0?'<div class="fl-fn-btn"><i class="S_txt3">|</i> <a href="javascript:void(0);" class="aj-approbtn aj-feed-fn-com-btn" data-replycount="'+c+'">批复('+c+")</a></div>":'<div class="fl-fn-btn"><i class="S_txt3">|</i> <a href="javascript:void(0);" class="aj-approbtn aj-feed-fn-com-btn" data-replycount="0">批复</a></div>',a.approve&&p.id==a.approve.senderID&&a.approve.canCancel&&(b.fnDeleteW='<a href="javascript:void(0);" class="aj-delete aj-feed-fn-com-btn">取消</a>'),b.isWhat='<span>-</span><span class="con"><a href="javascript:void(0);">'+n+"</a></span>",1==a.approve.status){var o=a.approve.currentApprover.name||"",r=a.approve.currentApprover.employeeID||"",s=g.getContactData().u.id;o='<a class="employee-name" href="#profile/=/empid-'+r+'">'+o+"</a>",b.leaderinfo='<div class="plan-leader">已提交，待<a href="#">'+o+"</a>审批。</div>"}s==r?(b.approver="1",o="我"):b.approver="0";var t="",u="",v="",w="",x="",y="",z="",A=[];_.each(a.replies,function(b,c){var d=g.getDateSummaryDesc(i.unix(b.createTime),i.unix(a.serviceTime),1),f=q(300,b),j="",k="",m="",n="",p=l(b.replyContent,a);y=f.summaryHtml,A.push(f),f.leftHtml.length>0&&(k='<span class="feed-content-ellipsis">&#8230;</span>',j='<br/><br/><a href="javascript:;" class="feed-topreply-content-visible-h" data-index="'+c+'"> 展开正文（共'+f.feedWordNum+"个字）</a>"),function(){switch(b.operationType){case 1:v="同意",x='<img src="'+e.ASSETS_PATH+'/images/agree.gif" alt="" class="approve-isagree">';break;case 2:v="不同意",x='<img src="'+e.ASSETS_PATH+'/images/unagree.gif" alt="" class="approve-isagree">';break;case 3:v="设置为已取消",x=""}}(),function(){z=1==b.source?"":"，来自"+g.getSourceNameFromCode(b.source),b.sender?(r=b.sender.employeeID,o=s==r?"我":b.sender.name,w=b.sender.profileImage,m=b.sender.name,o='<a href="#profile/=/empid-'+r+'"> '+o+"</a>"):(o="",r="",w="")}(),n=h.delStrLink(p),t+='<dl class="comment-list fn-clear isappr"><dt>'+x+'<a class="master-reply-face-l" href="#profile/=/empid-'+r+'"><img src = "'+g.getAvatarLink(w,"3")+'" / ></a></dt><dd>'+o+'：<span class="feed-topreply-summary-text">'+y+"</span>"+k+" ("+d+"，"+v+z+")"+j+"</dd></dl>",u+='<dl class="comment-list fn-clear isappr-print"><dt>'+x+'</dt><dd><span class="print-approvername">'+m+"</span>："+n+" ("+d+"，"+v+z+")</dd></dl>"}),b.feedFormatContents=A,""==t?(b.replyContent="",b.printReplyContent=""):(b.replyContent='<div class="reply-content"><div class="RC-arrow"><em class="S_line1_c">◆</em><span>◆</span></div><div class="RC-tit">以下为审批人的批复意见</div><div class="RC-feed">'+t+"</div></div>",b.printReplyContent='<div class="reply-content"><div class="RC-arrow"><em class="S_line1_c">◆</em><span>◆</span></div><div class="RC-feed">'+u+"</div></div>"),b.fnCcW="",b.fnModifyapprovalW="",b.fnApprovalW="",b.fnPendingW=j,b.morePendingW="",a.approve.canApprove&&(b.fnApprovalW=d,b.fnReplyW=""),a.approve.canAddAtEmployees&&(b.fnCcW=f,b.fnPendingW="",b.morePendingW=m),a.approve.canChangeApprover&&(b.fnModifyapprovalW=k,b.fnPendingW="",0==a.approve.currentApproverID&&(b.fnModifyapprovalW='<div class="fl-fn-btn"><i class="S_txt3">|</i><a href="javascript:void(0);" class="aj-modifyapproval aj-feed-fn-com-btn">转审批人</a></div>')),function(){b.printSendername='<span class="print-sendername">'+a.sender.name+"</span>"||"",b.printPictures="",b.printFiles="",b.printText="",_.each(a.feedContent,function(a){b.printText+=a.text}),b.printText=b.printText.replace(/[\n|\r]/g,"<br/>"),_.each(a.pictures,function(a){b.printPictures+='<div class="print-img-item"><span class="print-img-warp"><img src="'+e.API_PATH+"/df/get?id="+a.attachPath+'1.jpg" class="print-pictures"/><img src="'+e.ASSETS_PATH+'/images/print-del-pic-ico.gif" title="不打印该图" class="print-del-pic-ico aj-feed-fn-com-btn" /></span></div>'});var c=1;_.each(a.files,function(a){b.printFiles+='<div class="print-feedfile">附件'+c+"："+a.attachName+" ("+g.getFileSize(a.attachSize)+")</div>",c++}),b.printCTime=i.unix(a.createTime).format("YYYY年MMMDD日 HH:mm")}();var B=a.replies;return b.repliesBtn=B.length>0?'<a href="javascript:;" class="replies-btn aj-feed-fn-com-btn fl-common-up-arrow">关键回复('+B.length+")</a>":"",b}}},s=Backbone.Collection.extend({model:j.itemM,url:"/Feed/GetFeeds",sync:function(a,b,c){var d=c.data||{};return c.data=_.extend({circleID:0,subType:0,feedType:0,keyword:"",pageSize:30,pageNumber:2},d),Backbone.sync("read",b,_.extend(c,{apiCb:function(){}}))},parse:function(a){var b,d=[];return a.success&&(b=a.value.items,_.each(b,function(b,e){b.serviceTime=a.serviceTime,d[e]=c(b)})),d}});b.listC=s});