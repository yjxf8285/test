/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/feed-list/feed-fns",["modules/feed-list/feed-list.html","util","modules/publish/publish","moment"],function(a,b,c){var d=a("modules/feed-list/feed-list.html"),e=a("util"),f=a("modules/publish/publish"),g=a("moment"),h=f.mediaMaker,i=f.atInput,j=f.selectBar,k=f.timeSelect,l=f.dateSelect,m=e.getContactData(),n=m.u,o=Backbone.View.extend({tagName:"div",model:null,feedReply:null,itemV:null,className:"feed-list-approve list-repeat",template:_.template($(d).filter(".approve-template").html()),events:{"click .aj-appr-com":"appCom","click .aj-appr-yes":"appYes","click .aj-appr-no":"appNo","click .aj-appr-re":"appRe","click .f-submit":"submit","click .f-cancel":"cancel","click .update-btn":"updateM"},updateM:function(){this.model.collection.fetch(this.setoData())},initialize:function(){this.render(),this.setupDoms(),this.url="/FeedApprove/ApproverSendFeedReply",this.feedReply=this.options.feedReply,this.itemV=this.options.itemV,this.operationtype=1},formatData:function(a){var b={};return _.extend(b,a),b.profileImage=n.profileImage||"",b},render:function(){var a=this.$el,b=this.template,c=this.model.toJSON().originData;return a.html(b(this.formatData(c))),this},setupComponent:function(){var a=this.$el,b=$(".input-text",a),c=$(".apper",a),d=$(".ccer",a),f=$(".media",a),g=this.model.toJSON().originData,k=e.getPublishDefaultUser("approveApprovers"),l=n.employeeID,o=e.excludeContactData([l,g.sender.employeeID],"p");if(this.originData=g,!this.appersb){var p=new j({element:c,data:[{title:"同事",type:"p",list:o}],singleCked:!0,title:"选择下一个审批人（一个）",acInitData:e.getPublishDefaultUser("approveApprovers"),autoCompleteTitle:"请输入姓名或拼音"});k[0].store=_.reject(k[0].store,function(a){return a.id==g.employeeID}),p.setAcInitData(k),this.appersb=p}if(!this.ccersb){var q=new j({element:d,data:[{title:"同事",type:"p",list:o},{title:"部门",type:"g",list:m.g}],singleCked:!1,title:"添加抄送人或部门",autoCompleteTitle:"请输入姓名或拼音"});this.ccersb=q}if(!this.media){var r=new h({element:f,action:["h5imgupload","h5attachupload","at"],actionOpts:{at:{inputSelector:b,spOpts:{data:[{title:"同事",type:"p",list:m.p},{title:"部门",type:"g",list:m.g}]}}}});this.media=r}if(!this.atInput){var s=new i({element:b,withAt:!0});this.atInput=s}},setupDoms:function(){var a=this.$el;this.elEl=a,this.approveBdEl=$(".approve-bd",a),this.apperEl=$(".apper",a),this.ccerEl=$(".ccer",a),this.inputTextEl=$(".input-text",a),this.mediaEl=$(".media",a),this.submitBtn=$(".f-submit",a),this.allapperBtn=$(".approve-hd button",a)},appCom:function(a){$(a.currentTarget),this.allapperBtn.attr("disabled","disabled"),this.allapperBtn.addClass("button-state-disabled"),this.setupComponent(),this.approveBdEl.show()},appYes:function(){this.appersb.getSelectedData().p||"",this.approveBdEl.show(),this.apperEl.show(),this.ccerEl.show(),this.mediaEl.hide(),this.inputTextEl.val("同意。"),this.url="/FeedApprove/ApproverSendFeedReply",this.operationtype=1,this.submitBtn.removeClass("re")},appNo:function(){this.approveBdEl.show(),this.ccerEl.show(),this.apperEl.hide(),this.mediaEl.hide(),this.appersb.removeAllItem(),this.inputTextEl.val("不同意。"),this.url="/FeedApprove/ApproverSendFeedReply",this.operationtype=2,this.submitBtn.removeClass("re")},appRe:function(){this.approveBdEl.show(),this.apperEl.hide(),this.ccerEl.hide(),this.mediaEl.show(),this.appersb.removeAllItem(),this.ccersb.removeAllItem(),this.inputTextEl.val("").trigger("autosize.resize"),this.url="/FeedApprove/ApproverOnlySendFeedReply",this.submitBtn.addClass("re")},setoData:function(){var a=this.element,b=$(".is-sendms",a),c=b.is(":checked"),d=this.inputTextEl.val(),f=this.model.get("feedID"),g=this.appersb.getSelectedData(),h=g.p||[],i=this.ccersb.getSelectedData(),j=i.p||[],k=i.g||[],l="",m={};_.each(j,function(a){l+="@"+e.getContactDataById(a,"p").name+" "}),_.each(k,function(a){l+="@"+e.getContactDataById(a,"g").name+" "}),l&&(d+=l),h=Number(h[0])||null;var n=this.media.getUploadValue();return m.fileInfos=[],_.each(n,function(a){"img"==a.uploadType?m.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&m.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),_.extend(m,{feedID:f,replyContent:d,approverID:h,operationType:this.operationtype,employeeIDs:j,isSendSms:c,replyToEmployeeID:0,replyToReplyID:0}),m},addRangeAlert:function(a){a=_.extend({inputSelector:null,feedID:0,replyContent:"",sendCore:FS.EMPTY_FN,sendModalSelector:null},a||{});var b=e.getAtFromInput($(a.inputSelector)),c=$(a.sendModalSelector);b.length>0&&a.feedID?e.api({url:"/Feed/SendFeedReplyAtEmpCheck",data:{feedID:a.feedID,replyContent:a.replyContent},success:function(b){var d,f=!1,g="回复中提到的员工：";b.success&&(d=b.value,f=!d.value,f?(g+=d.value1+"不在信息的原始范围中，是否要添加？添加后他们将能看到信息的原文和所有该信息的回复。",e.confirm(g,"添加范围提示",function(){a.sendCore()},{onCancel:function(){c.hide()}})):a.sendCore())}}):a.sendCore()},fetch:function(){var a=this.$el,b=this,c=b.setoData();this.media.send(function(a,d){b.url=c.approverID?"/FeedApprove/AgreeToNextApprover":"/FeedApprove/ApproverSendFeedReply",b.addRangeAlert({inputSelector:b.inputTextEl,feedID:c.feedID,replyContent:c.replyContent,sendCore:function(){e.api({url:b.url,type:"post",data:c,dataType:"json",success:function(c){c.success&&(b.feedReply.refreshList(),b.itemV.updateModel()),a()},error:function(){a(),e.alert("系统繁忙，请稍后重试。")}},{submitSelector:b.submitBtn})},sendModalSelector:d})},a)},replyfetch:function(){var a,b=this.$el,c=this,d=this.itemV.$el;$(".aj-approbtn",d),this.media.send(function(b,d){a=c.setoData(),c.feedReply.replyWithData(a,{mediaSendCb:b,sendClearCb:function(){c.cancel(),c.media.resetAll()},mediaSendModal:d,subBtnSelector:c.submitBtn})},b)},submit:function(a){var b=$(a.currentTarget);this.isEmpty(this.inputTextEl)&&(b.is(".re")?this.replyfetch(this.setoData()):this.fetch(this.setoData()))},cancel:function(){this.allapperBtn.removeAttr("disabled"),this.allapperBtn.removeClass("button-state-disabled"),this.approveBdEl.hide(),this.inputTextEl.val("").trigger("autosize.resize")},isEmpty:function(a){var b=a.val(),c=!0;return b=$.trim(b),""==b&&(e.showInputError(a),c=!1),b.length>2e3&&(e.alert("发送内容不超过2000字，目前已超出<em>"+(b.length-2e3)+"</em>个字"),c=!1),c},destroy:function(){this.remove()}}),p=Backbone.View.extend({tagName:"div",feedReply:null,className:"feed-list-command list-repeat",template:_.template($(d).filter(".command-template").html()),events:{"click .topbtn":"allBtn","click .normal-btn":"normalBtn","click .complete-btn":"completeBtn","click .undone-btn":"undoneBtn","click .cancel-btn":"cancelBtn","click .done-btn":"doneBtn","click .f-submit":"submit","click .f-cancel":"cancel","click .update-btn":"updateM"},updateM:function(){this.model.collection.fetch(this.setoData())},initialize:function(){this.render(),this.feedReply=this.options.feedReply,this.originData=this.model.toJSON().originData,this.itemV=this.options.itemV,this.setupDoms(),this.setComStatus(),this.operationtype=1,this.commandBdEl.hide()},setupComponent:function(){var a=this.$el,b=$(".input-text",a);$(".ccer",a);var c=$(".media",a),d=$(".media2",a),f=this.model.toJSON().originData;e.getPublishDefaultUser("approveApprovers");var g=n.employeeID,o=e.excludeContactData([g,f.sender.employeeID],"p");this.originData=f;var p={id:f.work.executer.employeeID,name:f.work.executer.name,type:"p"};if(!this.worktosb){var q=new j({element:this.worktoEl,data:[{title:"同事",type:"p",list:o}],title:"选择指令执行人（一个）",acInitData:e.getPublishDefaultUser("workExecuters"),singleCked:!0,autoCompleteTitle:"请输入姓名或拼音"});q.addItem(p),this.worktosb=q}if(!this.ccersb){var r=new j({element:this.ccerEl,data:[{title:"同事",type:"p",list:m.p}],title:"添加抄送人",singleCked:!1,acInitData:e.getPublishRange("work",!0),autoCompleteTitle:"请输入同事的姓名或拼音"});this.ccersb=r}if(!this.setotherSelectData){var s=new l({element:this.sDEl,placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）"});s.on("change",function(){""==t.getValue()&&t.selector.select(0)}),this.setotherSelectData=s}if(!this.setotherSelectTime){var t=new k({element:this.sTEl,placeholder:"选择时间"});this.setotherSelectTime=t}if(!this.media){var u=new h({element:c,action:["h5imgupload","h5attachupload","at"],actionOpts:{at:{inputSelector:b,spOpts:{data:[{title:"同事",type:"p",list:m.p},{title:"部门",type:"g",list:m.g}]}}}});this.media=u}if(!this.media2){var v=new h({element:d,action:["at","topic"],actionOpts:{at:{inputSelector:b,spOpts:{data:[{title:"同事",type:"p",list:m.p},{title:"部门",type:"g",list:m.g}]}},topic:{inputSelector:b}}});this.media2=v}this.atInput||(this.atInput=new i({element:b,withAt:!0}))},setupDoms:function(){var a=this.$el,b=this.itemV.$el;this.itemEl=b,this.replaySectionEl=$(".replay-section",b),this.commandHdEl=$(".command-hd",a),this.commandBdEl=$(".command-bd",a),this.swrHdEl=$(".swr-action-tbar",a),this.rwrHdEl=$(".rwr-action-tbar",a),this.ccerEl=$(".ccer",a),this.raterEl=$(".rater",a),this.worktoEl=$(".workto-sb",a),this.sDEl=$(".setother-selectdata",a),this.sTEl=$(".setother-selecttime",a),this.inputTextEl=$(".input-text",a),this.setotherEl=$(".setother-wrapper",a),this.mediaEl=$(".media",a),this.media2El=$(".media2",a),this.mwarpEl=$(".m-warp",a),this.submitBtn=$(".f-submit",a),this.allapperBtn=$(".command-hd button",a)},setComStatus:function(){$(".detail-islike-list-warp",this.itemV.$el).hide(),$(".islike-btn",this.itemV.$el).removeClass("fl-common-up-arrow"),this.swrHdEl.hide(),this.rwrHdEl.hide();var a=this.feedReply.getReplyState();"plain"!=a?this.feedReply.set("showMainInput",!1):this.feedReply.set("showMainInput",!0),this.originData.work.assignerID==n.id&&this.originData.work.canComment&&(this.swrHdEl.show(),this.feedReply.set("showMainInput",!1),this.replaySectionEl.show(),this.replaySectionEl.find(".list-repeat").show()),this.originData.work.executerID==n.id&&this.originData.work.canSubmit&&(this.rwrHdEl.show(),this.feedReply.set("showMainInput",!1),this.replaySectionEl.show(),this.replaySectionEl.find(".list-repeat").show())},formatData:function(a){var b={};return _.extend(b,a),b.profileImage=n.profileImage||"",b},setoData:function(){var a=this.element,b=$(".is-sendms",a),c=b.is(":checked"),d=this.inputTextEl.val(),f=this.raterEl.find(".rate").val(),h=this.model.get("feedID"),i=this.ccersb.getSelectedData(),j=this.worktosb.getSelectedData();j.p||[];var k=i.g||[],l=i.p||[],m="",n={};_.each(l,function(a){m+="@"+e.getContactDataById(a,"p").name+" "}),m&&(d+=m);var o=this.media.getUploadValue();n.fileInfos=[],_.each(o,function(a){"img"==a.uploadType?n.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&n.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})});var p,q=this.setotherSelectData.getValue(),r=this.setotherSelectTime.getValue();return p=q.length>0?g(q+" "+r,"YYYYMMDD HH:mm").unix():"",_.extend(n,{feedID:h,replyContent:d,feedContent:d,operationType:this.operationtype,circleIDs:k,employeeIDs:l,executerID:parseInt(j.p)||[],isSendSms:c,smsRemindTimes:[{},{},{}],smsRemindType:1,deadline:p,assignerID:this.originData.sender.employeeID||null,replyToEmployeeID:0,rate:f,replyToReplyID:0}),n},addRangeAlert:function(a){a=_.extend({inputSelector:null,feedID:0,replyContent:"",sendCore:FS.EMPTY_FN,sendModalSelector:null},a||{});var b=e.getAtFromInput($(a.inputSelector)),c=$(a.sendModalSelector);b.length>0&&a.feedID?e.api({url:"/Feed/SendFeedReplyAtEmpCheck",data:{feedID:a.feedID,replyContent:a.replyContent},success:function(b){var d,f=!1,g="回复中提到的员工：";b.success&&(d=b.value,f=!d.value,f?(g+=d.value1+"不在信息的原始范围中，是否要添加？添加后他们将能看到信息的原文和所有该信息的回复。",e.confirm(g,"添加范围提示",function(){a.sendCore()},{onCancel:function(){c.hide()}})):a.sendCore())}}):a.sendCore()},fetch:function(){var a,b,c=this.$el,d=this,f=this.itemV.$el;$(".plan-leader",f),this.submitBtn.is(".changeother")?(a=d.setoData(),a.fileInfos=null,e.api({url:d.url,type:"post",data:{feedID:a.feedID,replyContent:"取消该指令",feedContent:a.feedContent,circleIDs:a.circleIDs,employeeIDs:a.employeeIDs,assignerID:a.assignerID,executerID:a.executerID,deadline:a.deadline,smsRemindType:a.smsRemindType,smsRemindTimes:a.smsRemindTimes,isSendSms:!1},dataType:"json",success:function(b){if(b.success){d.itemV.updateModel();var c=d.itemV.options;c.delegateOtherCb&&c.delegateOtherCb.call(d.itemV,b,a)}}},{submitSelector:d.submitBtn})):this.media.send(function(c,f){a=d.setoData(),a.replyContent||(a.replyContent=$("option:selected",d.raterEl).text()),d.addRangeAlert({inputSelector:d.inputTextEl,feedID:a.feedID,replyContent:a.replyContent,sendCore:function(){e.api({url:d.url,type:"post",data:a,dataType:"json",success:function(a){a.success&&(d.feedReply.refreshList(),d.submitBtn.is(".noupdate")?(b=d.itemV.model.get("leaderinfo"),d.inputTextEl.val("").height("40px"),d.itemEl.find(".con").text("执行中"),d._getOneFeed(),d.allapperBtn.removeAttr("disabled"),d.allapperBtn.removeClass("button-state-disabled")):d.itemV.updateModel()),c()},error:function(){c(),e.alert("系统繁忙，请稍后重试。")}},{submitSelector:d.submitBtn})},sendModalSelector:f})},c)},_getOneFeed:function(a){var b=this,c=this.itemV.model,d=this.$el,f=this.itemV.$el,h=$(".plan-leader",f);e.api({url:"/Feed/GetFeedByFeedID",type:"get",data:{feedID:c.get("feedID")},success:function(c){if(c.success){var d=c.value.items[0],f=0,i=e.getDateSummaryDesc(g.unix(d.work.deadline),g.unix(d.serviceTime),2),j=e.getDateSummaryDesc(g.unix(d.work.endTime),g.unix(d.serviceTime),2),k="",l=d.work.executer.name,m=e.getContactData().u.id,n=d.work.executer.employeeID;switch(l='<a class="employee-name" href="#profile/=/empid-'+n+'">'+l+"</a>",f=m==n?"1":"0",d.work.status){case 1:k=d.work.deadline<c.serviceTime?"应于"+i+'前完成，<span class="highlight">该指令已超时。</span>':"应于"+i+"前完成，该指令正在执行。";break;case 2:k="该指令已于"+j+"完成。";break;case 3:k="已于"+j+"取消。"}var o='<div class="plan-leader">该指令由'+l+"执行，"+k+"</div>";h.html($(o).html()),a&&a.call(b,c)}}},{mask:d,maskCls:"fs-feed-mask"})},replyfetch:function(){var a,b=this.$el,c=this;this.media.send(function(b,d){a=c.setoData(),c.feedReply.replyWithData(a,{mediaSendCb:b,sendClearCb:function(){c.cancel(),c.media.resetAll()},mediaSendModal:d,subBtnSelector:c.submitBtn})},b)},allBtn:function(a){$(a.currentTarget),this.setupComponent(),this.cancel(),this.submitBtn.removeClass("noupdate"),this.submitBtn.removeClass("finish"),this.submitBtn.removeClass("changeother"),this.allapperBtn.attr("disabled","disabled"),this.allapperBtn.addClass("button-state-disabled")},normalBtn:function(){this.commandBdEl.show(),this.ccerEl.hide(),this.raterEl.hide(),this.setotherEl.hide(),this.mwarpEl.hide(),this.submitBtn.addClass("re"),this.inputTextEl.attr("placeholder","添加回复...")},completeBtn:function(){this.commandBdEl.show(),this.ccerEl.hide(),this.raterEl.hide(),this.setotherEl.hide(),this.mwarpEl.hide(),this.url="/FeedWork/ExecuterSendFeedWorkReply",this.operationtype=1,this.inputTextEl.attr("placeholder","汇报结果...")},undoneBtn:function(){this.commandBdEl.show(),this.ccerEl.hide(),this.raterEl.hide(),this.mediaEl.hide(),this.mwarpEl.hide(),this.setotherEl.hide(),this.url="/FeedWork/AssignerSendFeedWorkReply",this.operationtype=2,this.submitBtn.addClass("noupdate"),this.inputTextEl.attr("placeholder","添加回复...")},cancelBtn:function(){this.commandBdEl.show(),this.setotherEl.show(),this.mediaEl.hide(),this.mwarpEl.show(),this.ccerEl.show(),this.raterEl.hide(),this.url="/FeedWork/ChangeOtherSendFeedWork",this.operationtype=null,this.submitBtn.addClass("changeother"),this.inputTextEl.attr("placeholder","添加回复...")},doneBtn:function(){this.commandBdEl.show(),this.mediaEl.hide(),this.mwarpEl.hide(),this.ccerEl.show(),this.raterEl.show(),this.setotherEl.hide(),this.url="/FeedWork/AssignerSendFeedWorkReply",this.operationtype=4,this.submitBtn.addClass("finish"),this.inputTextEl.attr("placeholder","点评结果...")},submit:function(a){var b=$(a.currentTarget);b.is(".re")?this.isEmpty(this.inputTextEl)&&this.replyfetch():b.is(".finish")?this.fetch(this.setoData()):this.isEmpty(this.inputTextEl)&&this.fetch(this.setoData())},isEmpty:function(a){var b=a.val(),c=!0;return b=$.trim(b),""==b&&(e.showInputError(a),c=!1),b.length>2e3&&(e.alert("发送内容不超过2000字，目前已超出<em>"+(b.length-2e3)+"</em>个字"),c=!1),this.operationtype||this.setoData().deadline||(e.showInputError($("input",this.sDEl)),c=!1),c},destroy:function(){this.remove()},cancel:function(){this.commandBdEl.hide(),this.inputTextEl.val("").trigger("autosize.resize"),this.submitBtn.removeClass("re"),this.ccersb.removeAllItem(),this.raterEl.find(".rate").val(3),this.allapperBtn.removeAttr("disabled"),this.allapperBtn.removeClass("button-state-disabled")},render:function(){var a=this.$el,b=this.template,c=this.model.toJSON().originData;return a.html(b(this.formatData(c))),this}});c.exports={ApproveV:o,CommandV:p}});