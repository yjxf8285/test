/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/feed-list/preview-feed-v",["util","moment","dialog","modules/publish/publish","modules/feed-list/feed-list-m","modules/feed-list/feed-list-c","modules/feed-list/feed-list.html","modules/feed-list/feed-list-helper"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.store,e.event;var f=a("util"),g=a("moment"),h=(a("dialog"),a("modules/publish/publish")),i=a("modules/feed-list/feed-list-m"),j=a("modules/feed-list/feed-list-c"),k=a("modules/feed-list/feed-list.html"),l=a("modules/feed-list/feed-list-helper");l.feedContentFormat;var m=(i.itemM,j.listC),n=$(k),o=h.atInput;h.mediaMaker;var p=f.getContactData(),q=p.u,r=l.feedContentFormat_,s=function(a){var b=a.val(),c=!0;return""==b&&(f.showInputError(a),c=!1),c},t=Backbone.View.extend({tagName:"div",template:_.template(n.filter(".preview-feed").html()),className:"list-item fn-clear",events:{"click .feed-content-visible-h":"fcVisibleH","click .feed-reply-content-visible-h":"fRcVisibleH","click .replyfn-item .t":"replyinput","click .f-cancel":"cancel","click .f-submit":"replysubmit","click .aj-replysubmit-sub":"replysubmitsub","click .reply-audio-open-btn":"audioBtn","click .reply-audio-close-btn":"audioCloseBtn","click .fs-switch-tpl-l":"_clickSwitchTplLink"},fRcVisibleH:function(a){var b=$(a.currentTarget),c=b.closest(".item-detail");$(".feed-summary-text",c);var d=$(".feed-content-lefthtml",c),e=$(".feed-content-ellipsis",c),f=b.attr("feedwordnum");d.is(":visible")?(e.show(),d.hide(),b.text("展开正文（共"+f+"个字）")):(e.hide(),d.show(),b.text("收起正文")),a.preventDefault()},fcVisibleH:function(a){var b=this.model,c=b.get("feedFormatContent"),d=c.leftHtml,e=$(a.currentTarget),f=e.closest(".content"),g=$(".feed-summary-text",f),h=$(".feed-left-text",f),i=$(".feed-content-ellipsis",f),j=$(".feed-content-visible-h",f);0==h.length?(h=$('<span class="feed-left-text">'+d+"</span>"),h.insertAfter(g),i.hide(),j.text("收起正文")):h.is(":visible")?(h.hide(),j.text("展开正文（共"+c.feedWordNum+"个字）"),i.show()):(h.show(),j.text("收起正文"),i.hide()),a.preventDefault()},replyEls:function(a){var b=$(a.currentTarget),c=b.closest(".list-item"),d=$(".input-text",c),e=$(".item-face",c).attr("feedid"),f=$(".preview-reply-bbar",c),g=$(".feed-reply",c),h=d.val();return{replyinputEl:d,replybbarEl:f,feedreplyEl:g,replyContent:h,feedId:e}},replysubmitsub:function(a){var b=this.$el,c=$(a.currentTarget),d=this.replyEls(a),e=c.closest(".item-detail"),f=e.attr("feedid"),g=e.attr("employeeid"),h=$(".aj-senderName",e),i=h.attr("name"),j="回复@"+i+"：",k=$(".replyfn-item .b",b),l=$(".replyfn-item .t",b);l.hide(),k.show(),d.replyinputEl.focus().val(j).trigger("autosize.resize"),d.replybbarEl.show(),this.replyEls.replyToReplyID=f,this.replyEls.replyToEmployeeID=g,d.replyinputEl.attr("placeholder","")},replyinput:function(){var a=this.$el,b=$(".replyfn-item .b",a),c=$(".replyfn-item .t",a);c.hide(),b.show()},cancel:function(a){var b=this.$el,c=this.replyEls(a),d=$(".replyfn-item .b",b),e=$(".replyfn-item .t",b);d.hide(),e.show(),c.replyinputEl.val("")},replytext:function(a){var b=this.replyEls(a);b.replybbarEl.is(":visible")||b.replybbarEl.show()},replysubmit:function(a){var b=this,c=this.replyEls(a),d=$(a.currentTarget),e=this.$el,g=$(".aj-replytext .num",e),h=c.replyinputEl,i=_.str.trim(h.val()),j=new RegExp("^\\s*$");j.test(i)&&h.val(""),s(h)&&(i.length>2e3?f.alert("请控制输入在2000字内"):f.api({url:"/Feed/SendFeedReply",type:"post",data:{feedID:c.feedId,replyContent:i,replyToReplyID:this.replyEls.replyToReplyID||0,replyToEmployeeID:this.replyEls.replyToEmployeeID||0,fileInfos:[],isSendSms:!1},dataType:"json",success:function(a){a.success&&(c.replybbarEl.hide(),c.replyinputEl.val("").trigger("autosize.resize"),b.getReplyContent(c.feedId),g.text(parseInt(g.text())+1))}},{submitSelector:d}))},getReplyContent:function(a){var b=this;f.api({url:"/Feed/GetFeedReplysByFeedID",type:"get",data:{feedID:a,lastFeedReplyID:0,maxID:0,pageSize:10,pageNumber:1},success:function(a){var c=a.value,d=c.items,e=b.$el,h=$(".feed-reply-listwarp",e),i=$(".item-face",e).attr("feedid"),j=$(".replyfn-item .b",e),k=$(".replyfn-item .t",e),l=0,m=0,n="",o="",p="",s="",t="",u="",v="",w=c.totalCount,x=w-10,y="";0==d.length&&(k.hide(),j.show()),y=x>0?'<div class="fs-reply-list-summary see-more-btn" style="display: block;">后面还有<span class="num">'+x+'</span>条回复，<a title="" href="#stream/showfeed/=/id-'+i+'/pn-2" class="jump-to-detail-l fs-switch-tpl-l">点击查看 &gt;&gt;</a></div>':"",_.each(d,function(b){l=b.feedReplyID,n=b.sender.name,m=b.sender.employeeID,s=b.sender.profileImage,o=f.getDateSummaryDesc(g.unix(b.createTime),g.unix(a.serviceTime),1),n=m==q.employeeID?"我":b.sender.name;var d=r(300,b),e="",h="",i=d.leftHtml;switch(p=d.summaryHtml,i.length>0&&(h='<span class="feed-content-lefthtml hide">'+i+'</span><span class="feed-content-ellipsis">&#8230;</span>',e='<br/><br/><a href="javascript:;" class="feed-reply-content-visible-h" feedwordnum="'+d.feedWordNum+'"> 展开正文（共'+d.feedWordNum+"个字）</a>"),1!=b.source&&(t="，来自"+b.sourceDescription),c.feedType){case 1:v="";break;case 2:v=f.getPlanOperationType(b.operationType)?"，"+f.getPlanOperationType(b.operationType):"";break;case 3:v=f.getWorkOperationTypeName(b.operationType)?"，"+f.getWorkOperationTypeName(b.operationType):"";break;case 4:v=f.getApproveOperationTypeName(b.operationType)?"，"+f.getApproveOperationTypeName(b.operationType):"";break;default:v=""}u+='<div class="fs-reply-list-wrapper fn-clear preview-reply-list-item"><div class="reply-item fs-list-item"> <div class="item-face"> <a href="#profile/=/empid-'+m+'"> <img src="'+f.getAvatarLink(s,"3")+'" alt=""></a> </div> <div class="item-detail" feedid="'+l+'" employeeid="'+m+'"> <div class="item-info"> <div> <a href="#profile/=/empid-'+m+'" class="aj-senderName" name="'+b.sender.name+'">'+n+'</a>：<span class="feed-summary-text">'+p+"</span>"+h+"("+o+v+t+")"+e+'</div></div> <div class="item-func myreply preview-feed"> <div class="handle"> <a href="javascript:void(0);" class="aj-replysubmit-sub">回复</a> </div> </div> </div> </div></div>'}),a.success&&h.html(u+y)}})},updateModel:function(a){var b=this,c=this.model;this.$el,f.api({url:"/Feed/GetFeedByFeedID",type:"get",data:{feedID:c.get("feedID")},success:function(c){var d=new m;c.success&&(b.model.set(d.parse(c)[0],{"silent ":!1}),b.render(),a&&a.call(b,c))}})},initialize:function(){var a=this.model,b=a.get("feedID");this.compStore=[],this.listenTo(this.model,"change ",this.render),this.getReplyContent(b)},render:function(){var a=this.model;return a.get("originData"),this.$el.addClass("fs-feed-item"),this.$el.html(this.template(this.model.toJSON())),this},renderCpt:function(){var a,b;a=$(".input-text",this.$el),b=$(".media",this.$el),this.atInput=new o({element:a,withAt:!0})},destroy:function(){this.$el.removeData(),_.each(this.compStore,function(a){a.destroy&&a.destroy()}),this.compStore=[],this.atInput&&this.atInput.destroy&&this.atInput.destroy(),this.atInput=null,this.media&&this.media.destroy(),this.media=null,this.remove(),this.replyEls.replyToReplyID=0,this.replyEls.replyToEmployeeID=0}});b.itemV=t});