/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-detaillists/crm-detaillists",["modules/crm-detaillists/crm-detaillists.html","util","uilibs/pagination2"],function(a,b,c){var d=a("modules/crm-detaillists/crm-detaillists.html"),e=a("util"),f=a("uilibs/pagination2"),g=Backbone.View.extend({warpEl:null,tagName:"div",className:"",title:"",jDatas:"",thDatas:[],aoColumnsData:[],url:null,data:null,template:_.template($(d).filter(".crm-detaillists-tpl").html()),events:{"click .table-add-btn":"add","click .table-modify-btn":"modify","click tbody tr":"tr","click .table-del-btn":"del"},tr:function(a){var b=$(a.target).closest("tr"),c=this.oTable.fnGetData(b.get(0));return this.trigger("tr",c),!1},add:function(a){var b=$(a.target).closest("tr"),c=this.oTable.fnGetData(b.get(0));return this.trigger("add",c),!1},modify:function(a){var b=$(a.target).closest("tr"),c=this.oTable.fnGetData(b.get(0));return this.trigger("modify",c),!1},del:function(a){var b=$(a.target).closest("tr"),c=this.oTable.fnGetData(b.get(0));return this.trigger("del",c),!1},initialize:function(){var a=this;this.render();var b=$(".pagination-wrapper",this.$el);this.options.pagination?b.parent().show():b.parent().hide(),this.pagination=new f({element:b,pageSize:this.options.data.pageSize,totalSize:0,activePageNumber:1}),this.pagination.on("page",function(b){a.options.data.pageNumber=b,a.refresh()})},render:function(){var a=this.$el,b=this.template,c=this.options.rightTopBTnText||"添加",d=this.options.operationClass||"table-add-btn",e=this.options.operation||!1,f={title:this.options.title,rightTopBTnText:c,operationClass:d,thDatas:this.options.thDatas};return f.operation=e?"operation":"",a.html(b(f)),this.options.warpEl.html(a),this},load:function(){this.oTable?this.oTable.fnReloadAjax():this.setDataTabel()},refresh:function(a){a&&_.extend(this.options.data,a),this.load()},formatData:function(a){var b={};return _.extend(b,a||{}),b.title=this.options.title||"",b},setDataTabel:function(){var a=this,b=this.$el,c=$(".crm-table-bd .crm-datatable",b),d='， <a class="table-add-btn" href="javascript:;">'+(this.options.emptyBtnWords||"立即添加")+"</a>";this.options.hideAddBtn&&(d="");var f='<span class="empty-tip">'+this.options.emptyStr+d+"</span>";this.oTable=c.dataTable({sDom:"Rlfrtip",aoColumns:this.options.aoColumnsData,sAjaxSource:this.options.url,fnServerData:function(b,c,d,f){f.jqXHR=e.api({dataType:"json",type:"get",url:b,data:a.options.data,beforeSend:function(){e.showGlobalLoading(1)},success:function(b){e.hideGlobalLoading(1),a.responseData=b,d(a._formatTableData(b));var c=b.value.totalCount;b.success&&a.pagination.setTotalSize(c),a.trigger("loadSuccess")}})},bAutoWidth:!1,bFilter:!1,bPaginate:!1,bInfo:!1,oLanguage:{sEmptyTable:f}})},_formatTableData:function(a){var b=[],c=a.value,d=c[this.options.jDatas]||[];return 0==d.length?$(".baseinfo-hd .table-add-btn",this.$el).hide():$(".baseinfo-hd .table-add-btn",this.$el).show(),this.options.operation?$(".baseinfo-hd .table-operation-btn",this.$el).show():$(".baseinfo-hd .table-operation-btn",this.$el).hide(),_.each(d,function(a){b.push(_.extend({blank:""},a))}),{aaData:b}}});c.exports=g});