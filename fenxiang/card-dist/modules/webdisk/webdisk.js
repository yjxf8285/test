/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/webdisk/webdisk",["./webdisk.html","./webdisk.css","util","modules/publish/publish","uilibs/tabs","datatable","dialog","moment","h5uploader","flashuploader","json","modules/fs-attach/fs-attach-file-preview"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.event;var g=a("./webdisk.html");a("./webdisk.css");var h=a("util"),i=a("modules/publish/publish"),j=a("uilibs/tabs");a("datatable");var k=a("dialog"),l=a("moment"),m=a("h5uploader"),n=a("flashuploader"),o=a("json"),p=a("modules/fs-attach/fs-attach-file-preview"),q=i.atInput,r=i.selectBar,s=i.mediaMaker,t=i.progressBar,u=i.Receipt,v=p.FileReader,w=0,x=function(a){var b=a.val(),c=!0;return""==b&&(h.showInputError(a),c=!1),c},y=$(g),z=h.getContactData();$.fn.dataTableExt.oSort["file-group-sort-string-asc"]=function(a,b){var c=$(a),d=$(b),e=$(".flag-entity-type",c).text(),f=$(".flag-entity-type",d).text(),g=$(".field-value",c).text(),h=$(".field-value",d).text();return e>f?-1:f>e?1:h>g?-1:g>h?1:0},$.fn.dataTableExt.oSort["file-group-sort-string-desc"]=function(a,b){var c=$(a),d=$(b),e=$(".flag-entity-type",c).text(),f=$(".flag-entity-type",d).text(),g=$(".field-value",c).text(),h=$(".field-value",d).text();return e>f?-1:f>e?1:h>g?1:g>h?-1:0},$.fn.dataTableExt.oSort["file-group-sort-number-asc"]=function(a,b){var c=$(a),d=$(b),e=$(".flag-entity-type",c).text(),f=$(".flag-entity-type",d).text(),g=parseFloat($(".field-value",c).text()),h=parseFloat($(".field-value",d).text());return e>f?-1:f>e?1:h>g?-1:g>h?1:0},$.fn.dataTableExt.oSort["file-group-sort-number-desc"]=function(a,b){var c=$(a),d=$(b),e=$(".flag-entity-type",c).text(),f=$(".flag-entity-type",d).text(),g=parseFloat($(".field-value",c).text()),h=parseFloat($(".field-value",d).text());return e>f?-1:f>e?1:h>g?1:g>h?-1:0};var A=k.extend({attrs:{width:580,content:y.filter(".disk-fn-new-dialog-templet").html(),className:"common-style-richard disk-fn-new-dialog",webDisk:null},events:{"click .f-sub":"_submit","click .is-read-only-radio":"_isreadselect","focusout .fn-new-tit":"_fnNewTitfocusout","focusin .fn-new-tit":"_fnNewTitfocusin","click .f-cancel":"_cancel"},render:function(){var a=A.superclass.render.apply(this,arguments);return this._rangeSelectBar(),a},hide:function(){var a=A.superclass.hide.apply(this,arguments);return this._clear(),a},show:function(){var a=A.superclass.show.apply(this,arguments),b=this.element,c=this.get("webDisk"),d=$(".fn-new-tit",b),e=$(".fn-new-table",b),f=$(".ui-dialog-title",b),g=$(".f-sub",b),i=$(".is-read-only-radio",b),j=this.trData,k=c.rootDirectory,l=k.nDDirectoryID,m=this.rangeSelectSb;return f.text("新建文件夹信息"),j&&(f.text("修改文件夹信息"),g.text("修改文件夹"),d.val(j.name),j.isReadOnly?i.prop("checked",!1).eq(1).prop("checked",!0).trigger("click"):i.prop("checked",!1).eq(0).prop("checked",!0).trigger("click"),h.api({url:"/NetDisk/GetNDDirectoryPermissions",type:"post",dataType:"json",data:{directoryID:j.nDDirectoryID},success:function(a){var b,c=a.value.permissions||[],d={};a.success&&_.each(c,function(a){b=a.isCircle?"g":"p",_.extend(d,{id:a.dataID,name:a.name,type:b}),m.addItem(d)})}})),0!=l?($("tr",e).eq(1).hide(),$("tr",e).eq(2).hide()):($("tr",e).eq(1).show(),$("tr",e).eq(2).show()),a},_isreadselect:function(a){var b=$(a.currentTarget),c=this.element,d=$(".read-dir-info",c),e=b.val();"read_only"==e?d.text("说明：除创建人外的同事只能预览和下载文件"):d.text("说明：可见范围内的同事都可以上传和删除文件")},_fnNewTitfocusout:function(){var a=this.element,b=$(".fn-new-tit",a),c=$(".fn-new-tit-ps",a);""==b.val()&&(b.addClass("warn"),c.text("请输入文件夹名称").addClass("warn"))},_fnNewTitfocusin:function(){var a=this.element,b=$(".fn-new-tit",a),c=$(".fn-new-tit-ps",a);b.removeClass("warn"),c.text("文件夹名称，例如：销售部文档").removeClass("warn")},_rangeSelectBar:function(){var a=this.element,b=$(".selectbar",a),c=new r({element:b,data:[{title:"部门",type:"g",list:z.g},{title:"同事",type:"p",list:z.p}],singleCked:!1,acInitData:h.getPublishRange("share"),title:"选择文件夹同事可见范围",autoCompleteTitle:"请输入部门或同事姓名或拼音"});this.rangeSelectSb=c},_sendNewDirectory:function(){var a=this.rangeSelectSb,b=this.trData,c=this.element,d=$(".fn-new-tit",c),e=$(".is-read-only-radio:checked",c).val(),f="/NetDisk/CreateNDDirectory",g=a.getSelectedData(),i=g.p||[],j=g.g||[],k=!1,l=0;"read_only"==e&&(k=!0),b&&(l=b.nDDirectoryID,f="/NetDisk/ModifyNDDirectory");var m=this.get("webDisk"),n=m.thisDirectory,o=m.rootDirectory,p={directoryName:d.val(),isReadOnly:k,rootDirectoryID:o.nDDirectoryID,directoryID:l,parentID:n.nDDirectoryID,circleIDs:j,employeeIDs:i};h.api({url:f,type:"post",dataType:"json",data:p,success:function(a){a.success&&m.reload()}})},_clear:function(){var a=this.element,b=$(".fn-new-tit",a),c=$(".fn-new-tit-ps",a),d=$(".read-dir-info",a);this.rangeSelectSb.removeAllItem(),$(".f-sub",a).text("创建文件夹"),this.trData=null,$(".is-read-only-radio",a).prop("checked",!1).eq(0).prop("checked",!0),d.text("说明：可见范围内的同事都可以上传和删除文件"),b.val("").removeClass("warn"),c.text("文件夹名称，例如：销售部文档").removeClass("warn")},_submit:function(a){var b=this.element,c=this.get("webDisk"),d=c.rootDirectory,e=d.nDDirectoryID,f=$(".fn-new-tit",b),g=$(".fn-new-tit-ps",b);$(".input-field",b);var h=$(".selectbar .input-tip",b),i=this.rangeSelectSb.getSelectedData(),j=i.p||[],k=i.g||[];""==f.val()?(f.addClass("warn"),g.text("请输入文件夹名称").addClass("warn")):0==e&&0==j.length&&0==k.length?(h.trigger("click"),a.stopPropagation()):(this._sendNewDirectory(),this.hide())},_cancel:function(){this.hide()}}),B=k.extend({attrs:{width:580,content:y.filter(".disk-fn-upload-dialog-templet").html(),className:"common-style-richard disk-fn-upload-dialog",webDisk:null},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel","click .upload-file-list .remove-l":"_removeUploadItem","click .is-receipt":"_clickIsReceipt","click .upload-item":"_clickUploadItem"},_clickUploadItem:function(a){var b=this.element,c=$(a.currentTarget),d=$(".upload-file-list",b);$(".upload-item",b);var e=c.find("td:first"),f=c.find("td:last");$("tr.row_selected",d).removeClass("row_selected"),$("td.border-blue-l",d).removeClass("border-blue-l"),$("td.border-blue-r",d).removeClass("border-blue-r"),c.addClass("row_selected"),e.addClass("border-blue-l"),f.addClass("border-blue-r")},setup:function(){var a=B.superclass.setup.apply(this,arguments);return this.fileInfos=[],a},render:function(){var a=B.superclass.render.apply(this,arguments);return this._rangeSelectBar(),this._renderUploader(),this._renderPbar(),this._renderReceipt(),a},hide:function(){var a=B.superclass.hide.apply(this,arguments);return this._clear(),a},_renderReceipt:function(){var a=this,b=this.element,c=$(".is-receipt",b),d=new u({inputSelector:null,rangeSb:this.rangeSelectSb,submitCb:function(b){a._setReceiptRange(b),this.hide()},cancelCb:function(){c.prop("checked",!1),a._clearReceipt()},isShowTip:!1});this.receipt=d},_setReceiptRange:function(a){var b,c,d=this.element,e=$(".is-send-sms",d),f=$(".receipt-tip",d),g=$(".send-sms-g",d),h=$(".send-sms-p",d);_.isEmpty(a)?f.text("").hide():(b=a.g||[],c=a.p||[],g.val(b.join(",")),h.val(c.join(",")),e.val($(".is-sms-send",this.receipt.element).prop("checked")?"1":"0"),f.text("已选择"+b.length+"个部门，"+c.length+"个人").show())},_clearReceipt:function(){var a=this.element,b=$(".is-receipt",a),c=$(".is-send-sms",a),d=$(".receipt-tip",a),e=$(".send-sms-g",a),f=$(".send-sms-p",a);e.val(""),f.val(""),c.val("0"),d.empty().hide(),b.prop("checked",!1)},_renderPbar:function(){var a=this.element,b=$(".progress-wrapper",a),c=$(".progress-bar",b),d=new t({element:c});this.pbar=d},uploadFilter:function(a,b){a=[].concat(a);var c,d=[],e=z.u.uploadFileSizeLimit;return _.each(a,function(a){a.size<1024*1024*e&&a.size>0&&(b.length>0?_.find(b,function(b){return b.name==a.name})||d.push(a):d.push(a))}),d.length<a.length&&(c="所选择的文件单个大小必须大于0B且小于"+e+"MB，文件名必须含有后缀且不能重复选择。有"+(a.length-d.length)+"个文件没有添加。",h.alert(c)),d},_renderUploader:function(){var a,b=this,c=this.element,d=$(".f-sub",c),f=$(".select-file-btn",c),g=$(".upload-input",c),i=$(".upload-file-list",c),j=$(".empty-tip",c),k=z.u.uploadFileSizeLimit,l=new m({multiple:!0,accept:"*/*",fileInput:g.get(0),dragDrop:j.get(0),url:"/File/UploadFile",filter:function(a){return b.uploadFilter(a,l.getFiles())},onSelect:function(a){var b="";a.length<=0||(_.each(a,function(a){b+='<tr class="upload-item" fileid="'+a.id+'"><td class="file-name"><div  class="file-name-warp"><img src="'+e.BLANK_IMG+'" class="fs-attach-'+h.getFileType(a,!0)+'-small-icon upload-item-icon" />&nbsp;<span class="file-names">'+a.name+'</span></div></td><td class="file-ext">.'+h.getFileExtText(a.name)+'</td><td class="file-size">'+h.getFileSize(a.size)+'</td><td class="file-opera"><a href="#" class="remove-l">删除</a></td></tr>'}),$("tbody",i).append(b),j.hide(),d.removeClass("button-state-disabled"))},onDelete:function(){},onProgress:function(){},onTotalProgress:function(a,c){b.updateUploadProgress(a,c)},onSuccess:function(a,c){var d=o.parse(c);d.success&&b.fileInfos.push({value:3,value1:d.value.filePath,value2:a.size,value3:a.name})},onFailure:function(){},onComplete:function(){b._sendUploadFiles()}});l.isSupport()?c.on("click",".select-file-btn",function(){g.click()}):(a="web-disk-upload-"+w,w++,f.attr("id",a),l=new n({upload_url:e.API_PATH+"/File/UploadFileByForm",file_types:"*.*",file_types_description:"所有文件",button_placeholder_id:a,button_text:"",button_image_url:e.MODULE_PATH+"/webdisk/icon-flash-upload.png",button_width:74,button_height:25,file_queued_handler:function(a){var b;a.size<1024*1024*k&&a.size>0?(b='<tr class="upload-item" fileid="'+a.id+'"><td class="file-name"  width="235"><img src="'+e.BLANK_IMG+'" class="fs-attach-'+h.getFileType(a,!0)+'-small-icon upload-item-icon" />&nbsp;<span class="file-names">'+a.name+'</span></td><td class="file-ext"><span>'+h.getFileExtText(a.name)+'</span></td><td class="file-size"><span>'+h.getFileSize(a.size)+'</span></td><td class="file-opera"><a href="#" class="remove-l">删除</a></td></tr>',$("tbody",i).append(b),j.hide(),d.removeClass("button-state-disabled")):(this.cancelUpload(a.id,!1),h.alert("所选择的文件单个大小必须大于0B且小于"+k+"MB"))},file_dialog_complete_handler:function(){},upload_total_progress_handler:function(a,c){b.updateUploadProgress(a,c)},upload_error_handler:function(a){h.alert(a.name+"上传失败，请重试！")},upload_success_handler:function(a,c){var d=o.parse(c);d.success&&b.fileInfos.push({value:3,value1:d.value.filePath,value2:a.size,value3:a.name})},upload_all_complete_handler:function(){b._sendUploadFiles()}}),$(".filedragwarp",j).html("请选择文件上传")),this.uploader=l},updateUploadProgress:function(a,b){var c=this.element,d=$(".progress-wrapper",c),e=this.pbar,f=Math.ceil(100*(a/b))+"%";e.setProgress(f),parseInt(f)>0&&parseInt(f)<100?d.show():d.hide()},_rangeSelectBar:function(){var a=this.element,b=$(".selectbar",a),c=new r({element:b,data:[{title:"部门",type:"g",list:z.g,unitSuffix:"个部门"},{title:"同事",type:"p",list:z.p}],singleCked:!1,title:"选择提醒范围...",autoCompleteTitle:"请输入部门或同事姓名或拼音"});this.rangeSelectSb=c},_removeUploadItem:function(a){var b=this.element,c=$(".f-sub",b),d=$(a.target),e=d.closest(".upload-item"),f=e.attr("fileid"),g=this.uploader;g.removeFile(f,!1),e.remove(),0==$(".upload-item",b).length&&($(".empty-tip",b).show(),c.addClass("button-state-disabled")),a.preventDefault()},_clickIsReceipt:function(a){var b=this.receipt,c=$(a.target);c.prop("checked")?b.show():this._clearReceipt()},_sendUploadFiles:function(){var a=this.rangeSelectSb,b=this.get("webDisk"),c=this,d=this.element,e=$(".send-sms-g",d),f=$(".send-sms-p",d),g=a.getSelectedData(),i=b.thisDirectory,j=b.rootDirectory,k=e.val(),l=f.val(),m={rootDirectoryID:j.nDDirectoryID,parentID:i.nDDirectoryID,circleIDs:g.g||[],employeeIDs:g.p||[],fileInfos:this.fileInfos,smsCircleIDs:k?k.split(","):[],smsEmployeeIDs:l?l.split(","):[]};h.api({url:"/NetDisk/UploadFiles",type:"post",dataType:"json",data:m,success:function(a){a.success&&(c.hide(),b._reload())}})},_clear:function(){var a=this.element;this.fileInfos=[],this.uploader&&this.uploader.removeAllFile(),$(".upload-item",a).remove(),$(".empty-tip",a).show(),this.pbar&&this.updateUploadProgress(0,0),this._clearReceipt(),this.rangeSelectSb&&this.rangeSelectSb.removeAllItem()},_submit:function(){this.uploader.startUpload()},_cancel:function(){this.hide()},destroy:function(){var a;return this._clear(),this.uploader&&this.uploader.destroy(),this.pbar&&this.pbar.destroy(),a=B.superclass.destroy.apply(this,arguments)}}),C=k.extend({attrs:{width:380,content:y.filter(".disk-fn-del-dialog-templet").html(),className:"common-style-richard disk-fn-del-dialog",webDisk:null},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel"},render:function(){var a=C.superclass.render.apply(this,arguments);return a},hide:function(){var a=C.superclass.hide.apply(this,arguments);return this._clear(),a},_sendDel:function(){var a,b=this.get("webDisk"),c=b.oTable,d={},e=c.fnGetData(b.getSelectRow().get(0));e.isDir?(a="/NetDisk/DeleteNDDirectory",d.directoryID=e.nDDirectoryID):(a="/NetDisk/DeleteNDFile",d.fileID=e.nDFileID),h.api({url:a,type:"post",dataType:"json",data:d,success:function(a){a.success&&b.reload()}})},_clear:function(){},_submit:function(){this._sendDel(),this.hide()},_cancel:function(){this.hide()}}),D=k.extend({attrs:{width:600,content:y.filter(".disk-fn-sendco-dialog-templet").html(),className:"common-style-richard disk-fn-sendco-dialog"},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel","click .is-receipt":"_clickIsReceipt"},render:function(){var a=D.superclass.render.apply(this,arguments);return this._initAtInput(),this._renderMedia(),this._rangeSelectBar(),this._renderReceipt(),this.showToppicTip(),a},showToppicTip:function(){var a=this.element,b=$(".sendco-input",a),c=$(".publish-topic-tip",a);b.keyup(function(){var a=$(this),b=_.str.trim(a.val());a.attr("name"),/#[^\n]+?#/g.test(b)?c.slideDown(200,function(){}):c.slideUp(200,function(){})})},_renderReceipt:function(){var a=this,b=this.element,c=$(".is-receipt",b),d=new u({inputSelector:$(".sendco-input",b),rangeSb:this.rangeSelectSb,submitCb:function(b){a._setReceiptRange(b),this.hide()},cancelCb:function(){c.prop("checked",!1),a._clearReceipt()}});this.receipt=d},_setReceiptRange:function(a){var b,c,d=this.element,e=$(".is-send-sms",d),f=$(".receipt-tip",d),g=$(".send-sms-g",d),h=$(".send-sms-p",d);_.isEmpty(a)?f.text("").hide():(b=a.g||[],c=a.p||[],g.val(b.join(",")),h.val(c.join(",")),e.val($(".is-sms-send",this.receipt.element).prop("checked")?"1":"0"),f.text("已选择"+b.length+"个部门，"+c.length+"个人").show())},_clearReceipt:function(){var a=this.element,b=$(".is-receipt",a),c=$(".is-send-sms",a),d=$(".receipt-tip",a),e=$(".send-sms-g",a),f=$(".send-sms-p",a);e.val(""),f.val(""),c.val("0"),d.empty().hide(),b.prop("checked",!1)},_initAtInput:function(){var a=this.element,b=$(".sendco-input",a);new q({element:b})},_renderMedia:function(){var a=this.element,b=$(".sendco-input-media",a),c=$(".sendco-input",a);new s({element:b,action:["at","topic"],actionOpts:{at:{inputSelector:c},topic:{inputSelector:c}}})},_rangeSelectBar:function(){var a=this.element,b=$(".selectbar",a),c=new r({element:b,data:[{title:"部门",type:"g",list:z.g},{title:"同事",type:"p",list:z.p}],singleCked:!1,title:"选择发送范围",acInitData:h.getPublishRange("share"),autoCompleteTitle:"请输入部门或同事姓名或拼音"});this.rangeSelectSb=c},_sendShareNDFile:function(){var a=this.rangeSelectSb,b=this.trData,c=this.element,d=$(".sendco-input",c);$(".is-read-only-radio:checked",c).attr("id");var e=a.getSelectedData(),f=e.p||[],g=e.g||[],i=b.nDFileID,j=$(".is-send-sms",c),k=$(".is-receipt",c),l=$(".send-sms-g",c),m=$(".send-sms-p",c),n=l.val(),o=m.val(),p={fileID:i,feedContent:d.val(),circleIDs:g,employeeIDs:f,isSentReceipt:k.prop("checked"),isSentSms:"1"==j.val()?!0:!1,smsCircleIDs:n?n.split(","):[],smsEmployeeIDs:o?o.split(","):[]};h.api({url:"/NetDisk/SendShareNDFile",type:"post",dataType:"json",data:p,success:function(a){a.success}})},show:function(){var a=A.superclass.show.apply(this,arguments),b=this.element,c=$(".sendco-file-info-cont",b),d=this.trData,f=d.attachName,g=h.getFileSize(d.attachSize);return c.html('<img src="'+e.BLANK_IMG+'" alt="" class="fs-attach-'+h.getFileType({name:f},!0)+'-small-icon attachName-img">'+f+" ("+g+")"),a},hide:function(){var a=D.superclass.hide.apply(this,arguments);return this._clear(),a},_clickIsReceipt:function(a){var b=this.receipt,c=$(a.target);c.prop("checked")?b.show():this._clearReceipt()},_clear:function(){var a=this.element,b=$(".sendco-input",a),c=$(".publish-topic-tip",a),d=$(".is-important-co",a);d.prop("checked",!1),b.val(""),c.hide(),this.rangeSelectSb.removeAllItem(),this._clearReceipt()},_submit:function(a){var b=this.element,c=$(".sendco-input",b),d=$(".selectbar .input-tip",b),e=this.rangeSelectSb.getSelectedData(),f=e.p||[],g=e.g||[];x(c)&&(0==f.length&&0==g.length?(d.trigger("click"),a.stopPropagation()):(this._sendShareNDFile(),this._clear(),this.hide()))},_cancel:function(){this._clear(),this.hide()},destroy:function(){var a;return this.receipt&&this.receipt.destroy(),a=D.superclass.destroy.apply(this,arguments)}}),E=k.extend({attrs:{width:560,content:y.filter(".disk-fn-sendclient-dialog-templet").html(),className:"common-style-richard disk-fn-sendclient-dialog"},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel"},render:function(){var a=E.superclass.render.apply(this,arguments);return this._initAtInput(),this._renderMedia(),this._rangeSelectBarTwo(),a},_initAtInput:function(){var a=this.element,b=$(".sendco-input",a);new q({element:b})},_renderMedia:function(){var a=this.element,b=$(".sendco-input",a),c=$(".sendco-input-media",a);new s({element:c,action:["h5attachupload","at"],actionOpts:{at:{inputSelector:b}}})},_rangeSelectBar:function(){var a=this.element,b=$(".selectbar",a),c=new r({element:b,data:[{title:"部门",type:"g",list:z.g},{title:"同事",type:"p",list:z.p}],singleCked:!1,acInitData:h.getPublishRange("share"),title:"选择客户范围",autoCompleteTitle:"请输入部门或同事姓名或拼音"});this.rangeSelectSb=c},_rangeSelectBarTwo:function(){var a=this.element,b=$(".selectbar-two",a),c=new r({element:b,data:[{title:"部门",type:"g",list:z.g},{title:"同事",type:"p",list:z.p}],singleCked:!1,acInitData:h.getPublishRange("share"),title:"选择发送范围",autoCompleteTitle:"请输入部门或同事姓名或拼音"});this.rangeSelectSb=c},show:function(){var a=A.superclass.show.apply(this,arguments),b=this.element,c=$(".sendco-file-info-cont",b),d=this.trData,f=d.attachName,g=h.getFileSize(d.attachSize);return c.html('<img src="'+e.BLANK_IMG+'" alt="" class="fs-attach-'+h.getFileType({name:f},!0)+'-small-icon attachName-img"  class="info-cont-img">'+f+" ("+g+")"),a},hide:function(){var a=E.superclass.hide.apply(this,arguments);return this._clear(),a},_clear:function(){},_submit:function(){this.hide()},_cancel:function(){this.hide()}}),F=k.extend({attrs:{width:450,content:y.filter(".disk-fn-viewdetails-dialog-templet").html(),className:"common-style-richard disk-fn-viewdetails-dialog"},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel"},render:function(){var a=F.superclass.render.apply(this,arguments);return this._viewdetailsTabs(),a},_formatTableData:function(a){var b,c,d,e,f,g=a.value,i=$(".viewdetails-tabs",this.element),j=$(".filedownrecords-employee",i),k="",m="";a.success&&(g.length>0?(_.each(g,function(a){b=h.getDfLink(a.profileImage+"3","",!1,"jpg"),c=a.name,e=a.employeeID,d=l.unix(a.downloadTime).format("MMMDD日 hh:mm"),f=a.sourceDesc,m+='<tr><td><a href="#profile/=/empid-'+e+'"><img src="'+b+'" alt=""></a>&nbsp;&nbsp;<a href="javascript:;">'+c+"</a></td><td>"+d+"下载</td><td>通过"+f+"</td></tr>"}),k='<table class="filedownrecords-employee-table">'+m+"</table>",j.html(k)):j.html('<div class="noinfotip">没有文件的下载记录</div>'))},_getFileDownRecords:function(){var a=this,b=this.trData,c=b.nDFileID;h.api({url:"/NetDisk/GetNDFileDownRecords",type:"get",dataType:"json",data:{fileID:c},success:function(b){a._formatTableData(b)}})},_viewdetailsTabs:function(){var a=$(".viewdetails-tabs",this.element);new j({element:a,triggers:$(".ui-tab-item",a),panels:$(".ui-tab-panel",a),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click",triggerBgTop:"0"}).render()},show:function(){var a=A.superclass.show.apply(this,arguments);return this._getFileDownRecords(),a},hide:function(){var a=F.superclass.hide.apply(this,arguments);return this._clear(),a},_clear:function(){var a=$(".viewdetails-tabs",this.element),b=$(".filedownrecords-employee",a);b.empty()},_submit:function(){this.hide()},_cancel:function(){this.hide()}}),G=new v,H=function(a){a=_.extend({element:null,listPath:"default",searchPath:"#",defaultListRequestData:null,navLabel:'<a href="#entnetworkdisk" title="纷享网盘" class="current-disk-l">纷享网盘</a>',rootNode:{name:"",nDDirectoryID:0,isReadOnly:!1,parentID:0},contextActions:[],showEmpFileOnly:!0},a||{}),this.opts=a,this.element=$(a.element),this.rootDirectory=null,this.thisDirectory=null,this.navigationInfo=[],this.init()};_.extend(H.prototype,{init:function(){var a=this.element,b=this.opts,c=$(g).filter(".webdisktpl-warp").html();a.addClass("disk").html(c),$(".nav-label",a).html(b.navLabel),this.windowsOnResize(),this._rMenuRender(),this._initDialogs(),this._searchBarInit(),this._bindEvents(),h.regGlobalClick(this.rightMenu)},_initDialogs:function(){var a=new A({webDisk:this}),b=new B({webDisk:this}),c=new C({webDisk:this}),d=new D,e=new E,f=new F;this.diskFnNewDialog=a,this.diskFnUploadDialog=b,this.diskFnDelDialog=c,this.diskFnSendcoDialog=d,this.diskFnSendclientDialog=e,this.diskFnViewdetailsDialog=f},_bindEvents:function(){var a=this.element,b=this.rightMenu,c=this,e=this.opts,f=e.contextActions,g=$(".topmenu-fn-new",a),i=$(".topmenu-fn-upload",a),j=$(".topmenu-fn-del",a);a.on("click",".range-wrapper",function(a){var b=$(a.currentTarget),c=b.data("rootDirectoryPermissions"),d=[],e=[];return 0==c.length?d.push(999999):_.each(c,function(a){a.isCircle?d.push(a.dataID):e.push(a.dataID)}),h.showTip({baseElement:b,afterShow:function(a){var b=this.element;b.html("正在努力的请求数据中……"),h.api({url:"/Account/GetFeedRangeEmployeeInfos",type:"post",data:{circleIDs:d,employeeIDs:e},dataType:"json",success:function(c){if(c.success){var d=c.value,e=0,f="",g="",i="",j="";_.each(d,function(a){e=a.employeeID,f=a.name,g=h.getAvatarLink(a.profileImage,"2"),i+='<div class="share-group-items fn-clear"> <a href="#profile/=/empid-'+e+'" class="profileimage"><img src="'+g+'" alt="" ></a> <a href="#profile/=/empid-'+e+'" class="name">'+f+'</a> <span class="infotype">'+j+"</span> </div>"}),i='<div class="share-group-tpl"><div class="share-group-warp">'+i+'</div><div class="share-group-countman">共<span class="num">'+d.length+"</span>人</div> </div>",b.html(i),a()}}})}}),!1}),a.on("click",".current-disk-l",function(a){var b=$(a.target),d=b.attr("href");location.hash===d&&c.load({directoryID:e.rootNode.nDDirectoryID})}),a.on("mousedown",".dataTables_scrollBody",function(){c.isTbody=!0,$(this).get(0).oncontextmenu=function(a){c._showRMenu(a)}}),a.on("click",".disk-breadcrumbs .enable-click",function(a){var b=$(a.target),d=b.attr("dirid");c.load({directoryID:d}),a.preventDefault()}),a.on("click",".topmenu-fn-reload",function(){c._reload()}),a.on("click",".topmenu-fn-new",function(){c.diskFnNewDialog.WebDisk=c;var a=g.hasClass("disable");a||c.diskFnNewDialog.show()}),a.on("click",".topmenu-fn-upload",function(){var a=i.hasClass("disable");a||c.diskFnUploadDialog.show()}),a.on("click",".topmenu-fn-del",function(){var a=j.hasClass("disable");a||c.diskFnDelDialog.show()}),a.on("click",".table-fn-modif",function(a){var b=$(a.currentTarget),d=b.closest("tr"),e=c.oTable.fnGetData(d.get(0));c.diskFnNewDialog.trData=e,c.diskFnNewDialog.WebDisk=c,c.diskFnNewDialog.show()}),a.on("click",".topmenu-fn-goback",function(a){var b=$(a.target);b.hasClass("disable")||c.load({directoryID:c.thisDirectory.parentID},"",function(){c._stateAtemployee=!1}),a.preventDefault()}),a.on("click",".disktable tbody tr",function(){c.isTbody=!1;var a=c.oTable.fnGetData(this);if(!a)return!1;var b=a.canDelete;c.trHasCur($(this)),b?j.removeClass("disable"):j.addClass("disable"),c.trData=a}),a.on("dblclick",".disktable tbody tr",function(a){c.isTbody=!1;var b=c.oTable,d=b.fnGetData(this);return d?(d.isDir?c.load({directoryID:d.nDDirectoryID},"",function(a){var b=a.value.thisDiretory.canCreate;a.success&&(b?(g.removeClass("disable"),i.removeClass("disable")):(g.addClass("disable"),i.addClass("disable")))}):c._showRMenu(a),void 0):!1}),a.on("mousedown",".disktable tbody tr",function(){c.isTbody=!1;var a=c.oTable.fnGetData(this);if(!a)return!1;var b=a.canDelete;return c.trHasCur($(this)),b?j.removeClass("disable"):j.addClass("disable"),c.trData=a,$(this).get(0).oncontextmenu=function(a){c._showRMenu(a)},!1}),a.on("click",".table-fn-preview",function(a){var b=$(this),d=c.oTable.fnGetData(b.closest("tr").get(0));G.readFile({fileId:d.nDFileID,fileName:d.attachName,filePath:d.attachPath}),c._updateDownloadTime(),a.preventDefault()}).on("click",".table-fn-download",function(a){c._updateDownloadTime(),window.open($(a.currentTarget).attr("href")),a.preventDefault()}),a.on("click",".rightmenu-fn-viewdetails",function(){c.diskFnViewdetailsDialog.trData=c.trData,c.diskFnViewdetailsDialog.WebDisk=c,c.diskFnViewdetailsDialog.show()}),_.each(f,function(a){b.on("click",a.selector,function(d){var e=c.oTable.fnGetData(c.getSelectRow().get(0));a.handler&&a.handler.call(this,d,e),b.hide(),d.stopImmediatePropagation()})}),b.on("click",".rightmenu-fn-new",function(){c.diskFnNewDialog.WebDisk=c,c.diskFnNewDialog.show()}),b.on("click",".rightmenu-fn-upload",function(){c.diskFnUploadDialog.show()}),b.on("click",".rightmenu-fn-open",function(a){var b=c.oTable.fnGetData(c.getSelectRow().get(0));c.load({directoryID:b.nDDirectoryID}),a.preventDefault()}),b.on("click",".rightmenu-fn-modif",function(a){var b=c.getSelectRow();$(".table-fn-modif",b).click(),a.preventDefault()}),b.on("click",".rightmenu-fn-preview",function(a){var b=c.oTable.fnGetData(c.getSelectRow().get(0));G.readFile({fileId:b.nDFileID,fileName:b.attachName,filePath:b.attachPath}),c._updateDownloadTime(),a.preventDefault()}),b.on("click",".rightmenu-fn-download",function(){var a=c.oTable.fnGetData(c.getSelectRow().get(0));c._updateDownloadTime(),d.open(h.getDfLink(a.attachPath,a.attachName,!0))}),b.on("click",".rightmenu-fn-del",function(){c.diskFnDelDialog.show()}),b.on("click",".rightmenu-fn-sendco",function(){c.diskFnSendcoDialog.trData=c.trData,c.diskFnSendcoDialog.WebDisk=c,c.diskFnSendcoDialog.show()}),b.on("click",".rightmenu-fn-sendclient",function(){c.diskFnSendclientDialog.trData=c.trData,c.diskFnSendclientDialog.WebDisk=c,c.diskFnSendclientDialog.show()}),b.on("click",".rightmenu-fn-viewwho",function(b){var d=c.oTable.fnGetData(c.getSelectRow().get(0)),e=d.creator;c.load({employeeID:e.employeeID,keyword:"",pageSize:1e4,pageNumber:1},"/NetDisk/GetOneEmployeeSendFiles",function(b){var d=$(".disk-breadcrumbs",a);b.success&&d.html('&nbsp;/&nbsp;<span class="nav-item">'+e.name+"的上传文件</span>"),$(".topmenu-fn-new,.topmenu-fn-upload,.topmenu-fn-del",a).addClass("disable"),c._stateAtemployee=!0}),b.preventDefault()}),b.on("click",".rightmenu-fn-view-dir",function(a){var b=c.oTable.fnGetData(c.getSelectRow().get(0));c.load({directoryID:b.parentID},"",function(){c._stateAtemployee=!1}),a.preventDefault()}),b.on("click",".rightmenu-fn-viewdetails",function(){c.diskFnViewdetailsDialog.trData=c.trData,c.diskFnViewdetailsDialog.WebDisk=c,c.diskFnViewdetailsDialog.show()})},_formatTableData:function(a){var b=[],c=a.value,d=c.files,e=c.directorys;return _.each(e,function(a){b.push(_.extend({isDir:!0,downloadTimes:0,attachSize:0},a))}),_.each(d,function(a){b.push(_.extend({isDir:!1,name:a.attachName},a))}),{aaData:b}},_updateDownloadTime:function(){var a=this.getSelectRow(),b=$(".download-times",a),c=$(".counts",b),d=this.oTable.fnGetData(a.get(0));h.api({url:"/File/RecoreDownloadTime",data:{feedID:0,fileID:d.nDFileID},type:"get",success:function(a){a.success&&c.text(parseInt(c.text())+1)}})},dataTables:function(){var a=this.element,b=this,c=this.opts,f=c.listPath,g=$(".disktable",a),i=g.dataTable({sScrollY:"700px",bPaginate:!1,bInfo:!1,bAutoWidth:!1,aoColumnDefs:[{sType:"file-group-sort-string",aTargets:[1,4]},{sType:"file-group-sort-number",aTargets:[2,3,5]}],aoColumns:[{mData:"isDir",sWidth:"36px",bSortable:!1,mRender:function(a,b,c){var d="";return a&&c.isPublic&&(d='<img src="'+e.ASSETS_PATH+'/images/disk/disk_ispublic_ico.png" alt="" class="isPublic-img">'),c.isUnread&&(d='<img src="'+e.ASSETS_PATH+'/images/new.gif" alt="" class="new-img">'),d}},{sWidth:"340px",sClass:"file-name",mData:"isDir",mRender:function(a,b,c){var d,f,g=c.name,i='<a href="javascript:void(0);" class="attachName-a"><img src="'+e.BLANK_IMG+'" alt="" class="fs-attach-'+h.getFileType({name:g},!0)+'-small-icon attachName-img"><span class="attachName-text">'+g+"</span></a>";return a?(i=c.isReadOnly?'<a href="javascript:void(0);" class="attachName-a"><img src="'+e.ASSETS_PATH+'/images/disk/disk_root_lock_ico.png" alt="" class="attachName-img"><span class="attachName-text">'+g+"</span></a>":'<a href="javascript:void(0);" class="attachName-a"><img src="'+e.ASSETS_PATH+'/images/disk/disk_root_ico.png" alt="" class="attachName-img"><span class="attachName-text">'+g+"</span></a>",d=c.nDDirectoryID,f="dir"):(d=c.nDFileID,f="file"),'<span dataid="'+d+'" datatype="'+f+'">'+i+'<span class="flag-entity-type">'+(a?1:0)+'</span><span class="field-value">'+g+"</span></span>"}},{sWidth:"80px",mData:"downloadTimes",mRender:function(a,b,c){var d="";return!c.isDir&&a>=0&&(d='<a href="javascript:;" class="rightmenu-fn-viewdetails download-times"><span class="counts">'+a+"</span>次</a>"),"<span>"+d+'<span class="flag-entity-type">'+(c.isDir?1:0)+'</span><span class="field-value">'+a+"</span></span>"}},{sWidth:"80px",mData:"attachSize",mRender:function(a,b,c){var d="";return c.isDir||(d=h.getFileSize(a)),"<span>"+d+'<span class="flag-entity-type">'+(c.isDir?1:0)+'</span><span class="field-value">'+a+"</span></span>"}},{sWidth:"80px",mData:"creator",mRender:function(a,b,c){return'<span class="webdisk-createPerson">'+a.name+'<span class="flag-entity-type">'+(c.isDir?1:0)+'</span><span class="field-value">'+a.spell+"</span></span>"}},{sWidth:"150px",mData:"createTime",mRender:function(a,c,d){var e=h.getDateSummaryDesc(l.unix(a),l.unix(b._lastServiceTime),1);return'<span class="webdisk-createTime">'+e+'<span class="flag-entity-type">'+(d.isDir?1:0)+'</span><span class="field-value">'+a+"</span></span>"}},{mData:"isDir",bSortable:!1,mRender:function(a,b,c){var d="",e="",f="";return a?d=c.canModify?'<a href="javascript:void(0);" class="table-fn-modif">修改</a>':"":(c.canPreview&&(f='&nbsp;&nbsp;<a href="" class="table-fn-preview">预览</a>'),d='<a href="'+h.getDfLink(c.attachPath,c.attachName,!0)+'" class="table-fn-download">下载</a>'+f),e='<div class="operatingwarp">'+d+"</div> "}}],sAjaxSource:f,fnServerData:function(e,f,i,j){var k={directoryID:0},l=e;c.defaultListRequestData&&(_.isFunction(c.defaultListRequestData)?_.extend(k,c.defaultListRequestData()):_.extend(k,c.defaultListRequestData)),_.extend(k,b._tempListRequestData),b._tempListRequestData=null,b._listPath&&(l=b._listPath,this._listPath=""),b.showLoading(),$("tbody tr",g).css({visibility:"hidden"}),b.cancelSelectRow(),j.jqXHR=h.api({dataType:"json",type:"get",url:l,data:k,success:function(c){var f,h;if(c.success){h=c.value,f=b._formatTableData(c),l==e?(b.thisDirectory=h.thisDiretory,b.rootDirectory=h.rootDiretory,b.navigationInfo=h.navigationInfo,b.updateActionState(),b.updateNavInfo(),b.updateRangeInfo(h.rangeDescription,h.rootDirectoryPermissions),b.updateBbarInfo(h)):$(".topmenu-fn-goback",a).removeClass("disable");var j,m,n;b.rootDirectory&&(j=b.rootDirectory.canCreate,m=$(".topmenu-fn-new",a),n=$(".topmenu-fn-upload",a),j?(m.removeClass("disable"),n.removeClass("disable")):(m.addClass("disable"),n.addClass("disable"))),b._lastRequestData=k,b._lastListPath=l,b._lastServiceTime=c.serviceTime,i(f),b.hideLoading(),b._listCallback&&(b._listCallback.call(this,c,k),b._listCallback=null);var o=$(".empty-tip",g);k.keyword&&k.keyword.length>0?o.text("没有搜索到文件信息"):o.text("当前目录下没有文件夹和文件"),$(d).resize()
}}})},sDom:'<"top"i>rt<"bottom"flp><"clear">',oLanguage:{sEmptyTable:'<span class="empty-tip">当前目录下没有文件夹和文件</span>'}});i.fnDraw(),this.oTable=i},trHasCur:function(a){var b=$(".disktable",this.element),c=a.find("td:first"),d=a.find("td:last");$("tr.row_selected",b).removeClass("row_selected"),$("td.border-blue-l",b).removeClass("border-blue-l"),$("td.border-blue-r",b).removeClass("border-blue-r"),a.addClass("row_selected"),c.addClass("border-blue-l"),d.addClass("border-blue-r")},updateActionState:function(){var a=this.opts,b=this.thisDirectory||a.rootNode,c=this.element;b.isReadOnly?$(".topmenu-fn-new,.topmenu-fn-upload",c).addClass("disable"):$(".topmenu-fn-new,.topmenu-fn-upload",c).removeClass("disable"),$(".topmenu-fn-del",c).addClass("disable"),0!=b.nDDirectoryID?$(".topmenu-fn-goback",c).removeClass("disable"):$(".topmenu-fn-goback",c).addClass("disable")},updateNavInfo:function(){var a=this.opts,b=this.element,c=$(".disk-breadcrumbs",b),d=this.navigationInfo,e=this.thisDirectory||a.rootNode,f="";_.each(d,function(a){f+='&nbsp;/&nbsp;<span class="nav-item enable-click" dirid="'+a.value+'">'+a.value1+"</span>"}),e.name&&(f+='&nbsp;/&nbsp;<span class="nav-item">'+e.name+"</span>"),c.html(f)},updateRangeInfo:function(a,b){var c=this.element,d=$(".range-wrapper",c);a?(d.html(a).closest(".disk-tit-r").show(),d.data("rootDirectoryPermissions",b)):(d.closest(".disk-tit-r").hide(),d.removeData("rootDirectoryPermissions"))},updateBbarInfo:function(a){var b=this.element,c=$(".disk-status",b),d=$(".dir-num",c),e=$(".file-num",c),f=a.directorys,g=a.files;d.html(f?f.length:0),e.html(g?g.length:0)},getSelectRow:function(){var a=this.oTable;return $("tr.row_selected",a)},cancelSelectRow:function(a){var b,c=this.oTable;a?(b=$(a),b.removeClass("row_selected"),$("td.border-blue-l",b).removeClass("border-blue-l"),$("td.border-blue-r",b).removeClass("border-blue-r")):($("tr.row_selected",c).removeClass("row_selected"),$("td.border-blue-l",c).removeClass("border-blue-l"),$("td.border-blue-r",c).removeClass("border-blue-r"))},_rMenuRender:function(){var a=$(g).filter(".rightmenu-templet").html(),b=$(a);b.appendTo("body"),this.rightMenu=b},_rMenuRenderFormat:function(){var a=this.opts,b=this.rightMenu,c=$(".rightmenu-fn-new",b),d=$(".rightmenu-fn-upload",b),e=$(".rightmenu-fn-open",b),f=$(".rightmenu-fn-modif",b),g=$(".rightmenu-fn-del",b),h=$(".rightmenu-fn-download",b),i=$(".rightmenu-fn-preview",b),j=$(".rightmenu-fn-viewwho",b),k='<span class="x-line-after"></span>',l=$(".x-line-after",b),m=this.trData,n=m.isDir,o=m.creator.name,p=this.isTbody,q=$(".rightmenu-fn-view-dir",b);j.html('<i class="ico"></i>查看'+o+"的文件"),j.html('<i class="ico"></i>查看'+o+"的文件"),l.remove(),b.children().hide(),n?(b.children().hide(),e.show()):(b.children().show(),c.hide(),d.hide(),e.hide(),f.hide(),a.showEmpFileOnly?this._stateAtemployee?(q.show(),j.hide()):(q.hide(),j.show()):(q.show(),j.show())),m.canDelete?(g.show(),n||g.after(k)):g.hide(),m.canModify?f.show().after(k):f.hide(),m.canPreview?(h.show().after(k),i.show()):i.hide(),p&&(b.children().hide(),c.show(),d.show())},_showRMenu:function(a){this._rMenuRenderFormat();var b,c,e,f,g=this.rightMenu,h=g.height(),i=g.width(),j=$(d).height(),k=$(d).width()-15;return document.all?(b=document.documentElement.scrollLeft+window.event.clientX,c=document.documentElement.scrollTop+window.event.clientY):(b=a.pageX,c=a.pageY),e=c+h,f=b+i,c=e>j?c-h:c,b=f>k?b-i-15:b,g.css({top:c,left:b+10}).show(),document.all?window.event.returnValue=!1:a.preventDefault(),!1},windowsOnResize:function(){var a=this.element;$(d).resize(function(){var b,c,e,f=$(".dataTables_scrollBody",a),g=$(".disk-status",a);f.length>0&&(b=f.offset(),c=g.outerHeight(),e=$(d).height(),e>b.top+c?f.height(e-b.top-c):f.height(0))}).resize()},_searchBarInit:function(){var a=this,b=this.opts,c=this.element,d=$(".search-inp",c),e=$(".search-btn",c),f=$('<span class="empty-h">x</span>'),g=$('<span class="list-search-input-wrapper"></span>');d.wrap(g),g=d.closest(".list-search-input-wrapper"),f.hide().appendTo(g),d.keydown(function(a){13==a.keyCode&&e.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(f.show(),d.addClass("with-input-value")):(f.hide(),d.removeClass("with-input-value"))}),f.click(function(){d.val(""),d.removeClass("with-input-value"),f.hide()}),e.click(function(c){var e=a.thisDirectory||b.rootNode,f=_.str.trim(d.val());a.load({directoryID:e.nDDirectoryID,keyword:f.length>100?f.substring(0,100):f,pageSize:1e4,pageNumber:1},b.searchPath),c.preventDefault()})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo($(".dataTables_scrollBody",b)),c.html('<span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a,b,c){this._tempListRequestData=a||{},this._listPath=b||"",this._listCallback=c||e.EMPTY_FN,this.oTable?this.oTable.fnReloadAjax():this.dataTables()},reload:function(){this._reload()},_reload:function(){var a=this.thisDirectory,b=this._lastRequestData?this._lastRequestData:{directoryID:a?a.nDDirectoryID:0},c=this._lastListPath||"";this.load(b,c)},reset:function(){var a=this.element,b=$(".search-inp",a);b.val("").keyup(),this.load()},destroy:function(){this._tempListRequestData=null,this._listCallback=null,this.thisDirectory=null,this.rootDirectory=null,this.navigationInfo=null,this._lastRequestData=null,this._lastListPath=null,this.oTable&&this.oTable.fnDestroy(),this.rightMenu&&this.rightMenu.remove(),this.rightMenu=null}}),c.exports=H});