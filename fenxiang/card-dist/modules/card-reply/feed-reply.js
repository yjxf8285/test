/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/card-reply/feed-reply",["widget","util","./reply.html","modules/publish/publish","moment","modules/feed-list/feed-list-helper","modules/fs-attach/fs-attach-preview","modules/fs-attach/fs-attach-file-preview","uilibs/audio-player"],function(a,b,c){var d=window,e=d.FS;e.tpl;var f=a("widget"),g=a("util"),h=a("./reply.html"),i=a("modules/publish/publish"),j=a("moment"),k=a("modules/feed-list/feed-list-helper.js"),l=a("modules/fs-attach/fs-attach-preview"),m=a("modules/fs-attach/fs-attach-file-preview"),n=a("uilibs/audio-player"),o=$(h),p=o.filter(".feed-reply-tpl").html(),q=_.template(o.filter(".feed-reply-input-tpl").html()),r=_.template(o.filter(".feed-reply-item-tpl").html()),s=i.atInput,t=i.mediaMaker,u=k.feedContentFormat_,v=(new l).render(),w=m.FileReader,x=new w,y=g.getContactData(),z=y.u,A=f.extend({attrs:{feedData:{value:null,getter:function(a){return a?a:{feedID:0,feedType:1}}},className:"card-feed-reply",pageSize:10,showMainInput:!0,autoOpenMainInput:!1,title:"",replyState:"plain"},events:{"click .islike-btn":"sendIsLike","click .reply-islike-tip .ico_page_prev":"likeTipPagePrev","click .reply-islike-tip .ico_page_next":"likeTipPageNext","mouseenter .islike-btn":"enterIsLike","mouseleave .islike-btn":"leaveIsLike","mouseenter .fn-btn-warp .reply-islike-tip":"enterIsTipLike","mouseleave .fn-btn-warp .reply-islike-tip":"leaveIsTipLike","click .islike-tip-more-btn":"moreTip","click .input-box .input-box-hidden":"_clickBoxHidden","click .main-input .f-cancel":"_clickMainInputCancel","click .sub-input .f-cancel":"_clickSubInputCancel","click .reply-item .open-reply-btn":"_clickOpenReplyBtn","click .load-more-l":"_clickLoadMore","click .slide-up-l":"_clickSlideUp","click .input-box .f-sub":"_clickReplySubmit","click .employee-ranges":"_clickVisibleArrow","click .reply-content-visible-h":"_clickReplyVisible","click .reply-content-img .img-item":"_clickImgItem","click .reply-content-file .file-preview":"_clickFilePreview"},likeTipPagePrev:function(a){var b=$(a.currentTarget),c=b.closest(".fn-btn-warp").find(".reply-islike-tip"),d=$(".bottom-info",c),e=Number(d.attr("pagenumber"));b.is(".disable")||this.reloadLikeTipData(c,e-1)},likeTipPageNext:function(a){var b=$(a.currentTarget),c=b.closest(".fn-btn-warp").find(".reply-islike-tip"),d=$(".bottom-info",c),e=Number(d.attr("pagenumber"));b.is(".disable")||this.reloadLikeTipData(c,e+1)},reloadLikeTipData:function(a,b){var c=$(".list-warp",a),d=a.closest(".reply-item").data("feedreplyid"),e=$(".bottom-info",a);a.height(191),g.api({url:"/FeedExtend/GetFeedReplyLikersOfFeedID",type:"get",data:{feedReplyID:d,pageSize:32,pageNumber:b},dataType:"json",success:function(a){var d="";a.value.totalCount||0;var f=a.value.pageCount||0,h=a.value.likers;a.success&&(_.each(h,function(a){var b=a.name,c=g.getAvatarLink(a.profileImage,2),e=a.employeeID;d+='<a href="#profile/=/empid-'+e+'" title="'+b+'" class="js-empids"><img alt="'+b+'" src="'+c+'"></a>'}),c.html(d),e.attr("pagenumber",b),1>=b?$(".ico_page_prev",e).addClass("disable"):$(".ico_page_prev",e).removeClass("disable"),b>=f?$(".ico_page_next",e).addClass("disable"):$(".ico_page_next",e).removeClass("disable"))}})},enterIsTipLike:function(){clearTimeout(this.attrs.likeTimer)},leaveIsTipLike:function(a){$(a.currentTarget);var b=function(){$(".reply-islike-tip").hide()};this.attrs.likeTimer=setTimeout(b,0)},leaveIsLike:function(a){var b=$(a.currentTarget);b.closest(".reply-item");var c=function(){$(".reply-islike-tip").hide()};this.attrs.likeTimer=setTimeout(c,100)},enterIsLike:function(a){var b=$(a.currentTarget),c=b.closest(".fn-btn-warp"),d=$(".reply-islike-tip",c),e=$(".islike-tip-more-btn",c),f=$(".js-empids",c),g=$(".bottom-info",c),h=40;$(".reply-islike-tip").hide(),g.hide(),f.length>8?(f.show().eq(6).nextAll().hide(),h=320,e.show()):(e.hide(),f.show(),h=40*f.length),d.width(h).height("auto"),d.show(),clearTimeout(this.attrs.likeTimer)},sendIsLike:function(a){var b=$(a.currentTarget),c=this,d=this.element,e=b.closest(".reply-item"),f=b.closest(".fn-btn-warp").find(".reply-islike-tip"),h=d.closest(".fs-list-item").find(".item-face").attr("feedid"),i=b.closest(".reply-item").data("feedreplyid"),j=!0,k=b.is(".cur");k?(j=!1,b.removeClass("cur"),b.attr("title","赞")):(j=!0,b.addClass("cur"),b.attr("title","取消赞")),g.api({url:"/FeedExtend/SetFeedReplyLike",type:"post",data:{feedID:h,feedReplyID:i,isLike:j},dataType:"json",success:function(a){a.success&&c.renderIslikeList(e,f,h,1)}})},moreTip:function(a){var b=$(a.currentTarget),c=b.closest(".fn-btn-warp"),d=$(".reply-islike-tip",c),e=$(".islike-tip-more-btn",c),f=$(".bottom-info",c),g=$(".js-empids",c);d.width(320).height(191),g.show(),f.show(),e.hide()},renderIslikeList:function(a,b,c){var d=$(".fn-btn-warp",a),e=a.data("feedreplyid"),f=$(".reply-likecount",a);g.api({url:"/FeedExtend/GetFeedReplyLikersOfFeedID",type:"get",data:{feedReplyID:e,pageSize:32,pageNumber:1},dataType:"json",success:function(a){var e=a.value.totalCount||0,h=a.value.pageCount||0,i=a.value.likers,j=i.length,k="",l="";l=h>1?"":"disable";var m='<div class="bottom-info fn-clear fn-hide" pagenumber="1"><div class="l"><span class="count-number">'+e+'</span>个人赞过</div><div class="r"><em class="ico_page_prev disable"><</em>&nbsp;&nbsp;<em class="ico_page_next '+l+'">></em></div></div>',n="";if(a.success)if(j>0){var o;_.each(i,function(a){var b=a.name,c=g.getAvatarLink(a.profileImage,2),d=a.employeeID;n+='<a href="#profile/=/empid-'+d+'" title="'+b+'" class="js-empids"><img alt="'+b+'" src="'+c+'"></a>'}),f.html('<span class="likecountnum">('+a.value.totalCount+")</span>").show(),i.length>8?(k='<a href="javascript:;" title="更多" class="islike-tip-more-btn"></a>',o=320):(k='<a href="#stream/showfeed/=/id-'+c+'/open-like" title="更多" class="islike-more hide"></a>',o=40*i.length),d.children().is(".reply-islike-tip")?($(".reply-islike-tip",d).html('<div class="toparrow"> <em>◆</em> <span>◆</span> </div><span class="list-warp">'+n+"</span>"+k+m),$(".reply-islike-tip",d).width(o)):d.append('<div class="reply-islike-tip" pagenum="1" style="display:block;width: '+o+'px"><div class="toparrow"> <em>◆</em> <span>◆</span> </div><span class="list-warp">'+n+"</span>"+k+m+"</div>");var p=$(".reply-islike-tip .islike-tip-more-btn",d),q=$(".js-empids",d);q.length>8?(q.show().eq(6).nextAll().hide(),p.show()):(p.hide(),q.show()),b.show()}else f.html("").hide(),b.remove()}})},setup:function(){var a;return a=A.superclass.setup.apply(this,arguments),this.$el=this.element,this._pageNumber=0,this._totalCount=0,this._listPath="/Feed/GetFeedReplysByFeedID",this._replyState="plain",a},_setInputDefaultValue:function(a){var b,c=$(a),d=$(".reply-input",c),e=c.closest(".reply-item");d=$(".reply-input",c),e.length>0?(b=e.data("originData"),d.val("回复@"+b.sender.name+"：")):d.val(""),g.setCursorPositionEnd(d),d.trigger("autosize.resize")},_clickVisibleArrow:function(){var a=$(".employee-ranges",this.element),b=$(".visible-arrow",a);$(".employee-ranges-content",this.element),b.hasClass("visible-arrow-down")?(a.data("originHeight")||a.data("originHeight",a.height()),a.css("height","auto"),b.removeClass("visible-arrow-down").addClass("visible-arrow-up"),a.removeClass("employee-ranges-ellipsis"),a.height()-a.data("originHeight")<4&&a.height(19)):(a.css("height",a.data("originHeight")+"px"),b.removeClass("visible-arrow-up").addClass("visible-arrow-down"),a.addClass("employee-ranges-ellipsis"))},_clickBoxHidden:function(a){var b=$(a.currentTarget),c=b.closest(".input-box");this._hideAllInputBox(),this.switchInputState(c,"shown"),this._setInputDefaultValue(c)},_clickMainInputCancel:function(a){var b=$(a.currentTarget);this.switchInputState(b.closest(".input-box"),"hidden")},_clickSubInputCancel:function(a){var b=$(a.currentTarget);b.closest(".input-box").hide()},_clickOpenReplyBtn:function(a){var b=$(a.currentTarget),c=b.closest(".reply-item"),d=$(".reply-to-reply",c),e=$(".input-box",d);this._hideAllInputBox(),0==e.length?(this._renderInputBox(d,"sub"),e=$(".input-box",d),this.switchInputState(e,"shown"),this._setInputDefaultValue(e)):e.is(":visible")?e.hide():(e.show(),this.switchInputState(e,"shown"),this._setInputDefaultValue(e))},_clickLoadMore:function(){this.fetchList(null,!0)},_clickSlideUp:function(){var a=this,b=$(window);b.scrollTop(b.scrollTop()-a.element.height()),this.hide()},_clickReplySubmit:function(a){var b=$(a.currentTarget).closest(".input-box");this.reply(b),a.preventDefault()},_clickReplyVisible:function(a){var b=$(a.currentTarget),c=b.closest(".reply-item"),d=c.data("originData"),e=d.replyFormatContent,f=$(".reply-summary-text",c),g=$(".reply-left-text",c),h=$(".reply-content-visible-h",c),i=$(".reply-content-ellipsis",c);0==g.length?(g=$('<span class="reply-left-text">'+e.leftHtml+"</span>"),g.insertAfter(f),h.text("收起正文"),i.hide()):g.is(":visible")?(g.hide(),h.text("展开正文，（共"+e.feedWordNum+"个字）"),i.show()):(g.show(),h.text("收起正文"),i.hide()),a.preventDefault()},_clickImgItem:function(a){var b=$(a.currentTarget),c=b.closest(".reply-item"),d=b.attr("attachid"),e=c.data("originData"),f=e.pictures,g=[],h=-1;_.each(f,function(a,b){g[b]={source:2,refId:e.feedReplyID||0,previewPath:a.attachPath+"2",originPath:a.attachPath+"1",thumbPath:a.attachPath+"3",createTime:a.createTime,fileName:a.attachName,fileSize:a.attachSize},a.attachID==d&&(h=b)}),v.preview({type:"img",data:g,refId:e.feedReplyID,belongToType:"reply",activeIndex:h}),a.preventDefault()},_clickFilePreview:function(a){var b,c=$(a.currentTarget),d=c.closest(".file-item"),e=c.closest(".reply-item"),f=d.attr("attachid"),g=e.data("originData"),h=g.files;b=_.find(h,function(a){return a.attachID==f}),x.readFile({fileId:b.attachID,fileName:b.attachName,filePath:b.attachPath}),a.preventDefault()},_hideAllInputBox:function(){var a=this.element,b=$(".input-box",a);b.filter(":visible").each(function(){$(".f-actions .f-cancel",this).click()})},_initInputCpt:function(a){var b,c=$(a),d=$(".input-box-shown",c),e=$(".reply-input",d),f=$(".media",d),h=new s({element:e}),i=this.get("feedData").feedType;b=2003==i?new t({element:f,action:["h5imgupload","h5attachupload"]}):new t({element:f,action:["h5imgupload","h5attachupload","at"],actionOpts:{at:{inputSelector:e}}}),f.data("media",b),g.placeholder(e),e.keydown(function(a){27==a.keyCode&&a.preventDefault()}),e.data("atInput",h),f.data("media".media),c.data("isInit",!0)},_renderInputBox:function(a,b){var c=$(a);b=b||"main",c.html(q({loginUserAvatar:g.getAvatarLink(z.profileImagePath,3)})),$(".input-box",c).addClass(b+"-input"),"main"==b&&$(".input-box",c).addClass("main-input-with-pt")},_createReplyItem:function(a,b){var c,d,f,h,i,k,l,m,o=this.get("feedData"),p=u(300,{replyContent:a.replyContent}),q="",s=g.getSourceNameFromCode(a.source),t={blankImgSrc:e.BLANK_IMG,approveActionCls:"",replyStateDesc:"",employeeAvatar:g.getAvatarLink(a.sender.profileImage,3),employeeID:a.sender.employeeID,employeeName:a.sender.name,replyFormatContent:p,createTime:g.getDateSummaryDesc(j.unix(a.createTime),j.unix(b),1)};("纷享销客"==s||"未知"==s)&&(s=""),t.replySource=s,4==o.feedType?(1==a.operationType?t.approveActionCls="approve-agree-icon":2==a.operationType&&(t.approveActionCls="approve-disagree-icon"),t.replyStateDesc=g.getApproveOperationTypeName(a.operationType)):3==o.feedType?t.replyStateDesc=g.getWorkOperationTypeName(a.operationType):2==o.feedType&&(t.replyStateDesc=g.getPlanOperationType(a.operationType));var v=a.like.likeCount,w=a.isAlreadyLike,x="",y="取消赞",z="cur",A='(<span class="likecountnum">'+v+"</span>)",B=a.like.likeEmployees,C="";C=v>32?"":"disable";var D,E='<div class="bottom-info fn-clear fn-hide" pagenumber="1"><div class="l"><span class="count-number">'+a.like.likeCount+'</span>个人赞过</div><div class="r"><em class="ico_page_prev disable"><</em>&nbsp;&nbsp;<em class="ico_page_next '+C+'">></em></div></div>',F="",G="",H="",I="";if(B&&(_.some(B,function(a,b){var c=a.name,d=g.getAvatarLink(a.profileImage,"2"),e=a.employeeID;32>b&&(G+='<a href="#profile/=/empid-'+e+'" class="js-empids" title="'+c+'"><img alt="'+c+'" src="'+d+'"></a>')}),B.length>5?(H='<a href="javascript:;" title="更多" class="islike-tip-more-btn"></a>',D=200):(H='<a href="javascript:;" title="更多" class="islike-tip-more-btn hide"></a>',D=40*B.length)),w||(y="赞",z="",A="",F=""),F='<div class="reply-islike-tip" style="display:none;width: '+D+'px"><div class="toparrow"> <em>◆</em> <span>◆</span> </div><span class="list-warp">'+G+"</span>"+H+E+"</div>",v>0?(A='(<span class="likecountnum">'+v+"</span>)",I=""):(F="",A="",I="fn-hide"),x='<span title="'+y+'" class="islike-btn aj-reply-fn-com-btn '+z+'" title="'+y+'"><b></b> <a class="reply-likecount '+I+'" href="javascript:void(0);">'+A+'</a> </span> <i class="S_txt3">|</i>'+F,t.islike=x,t.feedReplyID=a.feedReplyID,c=$(r(t)).data("originData",_.extend(a,{replyFormatContent:p})),l=a.audio,l&&(d=$(".reply-content-audio",c),q='<div class="audio-player"></div>',d.html(q),m=new n({element:$(".audio-player",d),audioSrc:g.getDfLink(g.getFileNamePath(l.attachPath)+".mp3",l.attachName,!1),length:l.attachSize,themeStyle:4}),$(".player-icon").removeClass("mc-pause").addClass("mc-play"),c.data("audioPlayer",m)),i=a.pictures,i&&i.length>0&&(f=$(".reply-content-img",c),q='<ul class="img-list fn-clear">',_.each(i.slice(0,5),function(a){q+='<li class="img-item fn-left" attachid="'+a.attachID+'"><img src="'+g.getDfLink(a.attachPath+"3",a.attachName,!1,a.fileIcon)+'" alt="'+a.attachName+'" /></li>'}),i.length>6?q+='<li class="img-item img-more fn-left" attachid="'+i[5].attachID+'"><span class="more-tip">更多'+(i.length-5)+"张</span></li>":6==i.length&&(q+='<li class="img-item fn-left" attachid="'+i[5].attachID+'"><img src="'+g.getDfLink(i[5].attachPath+"3",i[5].attachName,!1,i[5].fileIcon)+'" alt="'+i[5].attachName+'" /></li>'),q+="</ul>",f.html(q)),k=a.files,k&&k.length>0){h=$(".reply-content-file",c),q='<ul class="file-list fn-clear">';var J=[];_.each(k,function(a){var b;try{b=decodeURIComponent(a.attachName)}catch(c){b=a.attachName}q+='<li class="file-item fn-left" attachid="'+a.attachID+'">'+'<div class="file-item-inner fn-clear">'+'<img src="'+e.BLANK_IMG+'" alt="icon" class="fs-attach-'+g.getFileType({name:a.attachName},!0)+'-icon file-icon fn-left" />'+'<div class="file-content fn-left"><div class="file-name">'+b+"（"+g.getFileSize(a.attachSize)+"）</div>"+'<div class="file-actions"><a href="'+g.getDfLink(a.attachPath,a.attachName,!0)+'" class="file-download" target="_blank">下载</a>',a.canPreview&&(q+='&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:;" class="file-preview">预览</a>'),q+="</div></div></div></li>",J.push(a.attachID)}),q+="</ul>",J.join("|");var K=e.API_PATH+"/df/GetBatchFiles1?dataID="+a.feedReplyID+"&source=2";k.length>1&&(q+='<a class="batch-download-l" href="'+K+'" target="_blank"><img src="'+e.BLANK_IMG+'" alt=""/></a>'),h.html(q)}return c},_renderList:function(a,b){var c=this,d=this.element,e=$(".main-input",d),f=$(".reply-list",d);a.length>0?f.show():f.hide(),_.each(a,function(a){c._createReplyItem(a,b).appendTo(f)}),0==a.length&&this.get("showMainInput")&&this.switchInputState($(".main-input",d),"shown"),a.length>0&&this.get("showMainInput")?e.removeClass("main-input-with-pt"):e.addClass("main-input-with-pt")},_renderSelf:function(){var a=this.element;a.html(p)},_updateReplyListStatus:function(a){var b=this.element,c=$(".reply-list",b),d=$(".reply-list-status-bar",b),e=this.get("pageSize"),f=this._pageNumber,g=f*e;g>=a?d.html('<a href="javascript:;" class="slide-up-l">全部收起</a>'):d.html('<span class="leave-tip">还有&nbsp;<span class="leave-num">'+(a-g)+'</span>&nbsp;条回复</span>&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:;" class="load-more-l">加载更多</a>'),a>0?(a>e?d.show():d.hide(),c.show()):(d.hide(),c.hide())},_updateReplyRanges:function(a,b){var c=this,d=this.get("feedData"),e=this.element,f=$(".employee-ranges",e),h=$(".employee-ranges-content",f),i=function(a){var b,c=a;b=c.length,b>0?(h.html("新增同事范围"+b+"人："+c.join("、")+"。"),f.show()):f.hide()};return"important"==this._replyState?(f.hide(),void 0):(a!==!1?b?i(b):g.api({url:"/Feed/GetAddAtEmpRanges",data:{feedID:d.feedID,isGetRangeData:!0},success:function(a){var b;a.success&&(b=a.value,i(b.addEmployees),c.trigger("addatrange",b))}}):f.hide(),void 0)},render:function(){var a,b,c=this.element,d=A.superclass.render.apply(this,arguments);return this._renderSelf(),this._renderInputBox($(".reply-header",c)),a=$(".main-input",c),this.get("showMainInput")?a.show():a.hide(),b=$(".reply-title",c),b.text(this.get("title")),this.get("title").length>0?b.show():b.hide(),this.rendered=!0,d},show:function(){var a=this.element;this.rendered||this.render(),this.get("showMainInput")&&this.get("autoOpenMainInput")&&this.switchInputState($(".main-input",a),"shown"),a.show(),this.trigger("show")},hide:function(a,b){var c=this,d=this.element,e=$(".employee-ranges",d),f=$(".employee-ranges-content",e);a?d.slideUp("normal",function(){b&&b.call(c,c.element)}):d.hide(),this.emptyList(),this.switchInputState($(".main-input",this.element),"hidden"),f.empty(),e.hide(),this.trigger("hide")},emptyList:function(){var a=this.element,b=$(".reply-list",a);$(".reply-item",b).each(function(){var a=$(this),b=$(".reply-to-reply",a),c=$(".input-box-shown",b),d=$(".reply-input",c),e=$(".media",c);d.length>0&&(d.data("atInput").destroy(),e.data("media").destroy(),d.removeData(),e.removeData()),a.data("audioPlayer")&&a.data("audioPlayer").destroy(),a.removeData()}),b.empty().hide(),this._pageNumber=0},switchInputState:function(a,b){var c=$(a),d=$(".input-box-shown",c),e=$(".input-box-hidden",c);$(".reply-body",this.element),b=b||"shown","shown"==b?(d.show(),e.hide(),c.data("isInit")||this._initInputCpt(c),$(".reply-input",d)[0].focus()):(d.hide(),e.show())},getInputState:function(a){var b=$(a),c=$(".input-box-shown",b);return c.is(":visible")?"shown":"hidden"},showLoading:function(){var a=this.element,b=$(".reply-loading",a);b.show()},hideLoading:function(){var a=this.element,b=$(".reply-loading",a);b.hide()},fetchList:function(a,b){var c,d=this,e=this._listPath,f=this.get("feedData"),h=this.get("pageSize"),i=this._pageNumber+1,j=this.element,k=$(".reply-list-status-bar",j),l=this.get("lastFeedReplyID")||0,m=this.get("maxID")||0;b||(l=0,m=0),this.showLoading(),a?(c=f.replies,this._pageNumber=i,this._renderList(c.slice((i-1)*h,h),f.serviceTime),this.hideLoading(),this._updateReplyListStatus(c.length),this._totalCount=c.length,this.trigger("replycount",d._totalCount,d._replyState)):g.api({url:e,type:"post",data:{feedID:f.feedID,lastFeedReplyID:l,maxID:m,pageNumber:i,pageSize:h},success:function(a){var b,c,e,f=a.value.items;a.success&&(f.length>0&&(c=_.last(f).feedReplyID),e=a.value.maxID||0,d.set("lastFeedReplyID",c),d.set("maxID",e),b=a.value,d._pageNumber=i,d._renderList(b.items,a.serviceTime),d._updateReplyListStatus(b.totalCount),d._updateReplyRanges(!0,b.addEmployees),d._totalCount=b.totalCount,d.trigger("replycount",d._totalCount,d._replyState))},complete:function(){d.hideLoading()}},{mask:k,abortLast:!0})},refreshList:function(){this.emptyList(),this.fetchList()},replyValid:function(a){var b=$(a),c=$(".reply-input",b),d=this.getReplyRequestData(a),e=!0;return 0==d.replyContent.length?(g.showInputError(c.parent()),e=!1):d.replyContent.length>2e3?(g.alert("发送内容不超过2000字，目前已超出<em>"+(d.replyContent.length-2e3)+"</em>个字"),e=!1):e},_getReplyRequestDataExt:function(){var a=this.get("feedData"),b={};return b=_.extend(b,{feedID:a.feedID,fbrType:a.fbrType,isSendSms:!1,feedType:a.feedType}),3==a.feedType?b=_.extend(b,{feedSenderID:a.employeeID,feedReceiverID:a.work.executerID}):4==a.feedType&&(b=_.extend(b,{feedSenderID:a.employeeID,feedReceiverID:a.approve.currentApproverID})),b},getReplyRequestData:function(a){var b,c,d=$(a),e=d.closest(".reply-item"),f=$(".reply-input",d),h=$(".media",d),i=h.data("media"),j={},k=(this.get("feedData"),[]);return j.replyContent=_.str.trim(f.val()),j.fileInfos=[],b=i.getUploadValue(),_.each(b,function(a){"img"==a.uploadType?j.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&j.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),j.fileInfos.length>0&&0==j.replyContent.length&&(k=g.getAttachTypeName(j.fileInfos),k.length>0&&(j.replyContent=k.length>2?"回复"+k.join("、"):k.length>1?"回复"+k.join("和"):"回复"+k[0])),e.length>0&&(c=e.data("originData"),j=_.extend(j,{replyToReplyID:c.feedReplyID,replyToEmployeeID:c.employeeID})),j=_.extend(j,this._getReplyRequestDataExt())},clearReply:function(a){var b=$(a),c=$(".input-box-shown",b),d=$(".media",c),e=d.data("media");this._setInputDefaultValue(a),e&&e.resetAll(),b.hasClass("main-input")?this.switchInputState(b,"hidden"):b.hasClass("sub-input")&&b.hide()},reply:function(a,b){var c,d,e,f,h=this,i=$(a),j=$(".reply-input",i),k=$(".f-sub",i);this.replyValid(a)&&(d=$(".media",i),e=d.data("media"),e.send(function(d,e){var i=function(){g.api({type:"post",data:c,url:"/Feed/Reply",success:function(b){b.success&&(h.clearReply(a),"plain"==h._replyState?(h.prependItem(b.value),h._updateReplyRanges()):"important"==h._replyState&&h.switchReplyState("plain"),h.trigger("reply",b,c)),d(),$(".fs-guide-shadow-link").click()},error:function(){d(),g.alert("系统繁忙，请稍后重试。")}},{submitSelector:k})};c=h.getReplyRequestData(a),c=_.extend(c,b||{}),f=g.getAtFromInput(j);var l=h.get("feedData").feedType;2003==l&&(f=""),f.length>0&&c.feedID?g.api({url:"/Feed/SendFeedReplyAtEmpCheck",data:{feedID:c.feedID,replyContent:c.replyContent},success:function(a){var b,c=!1,d="回复中提到的员工：";a.success&&(b=a.value,c=!b.value,c?(d+=b.value1+"不在信息的原始范围中，是否要添加？添加后他们将能看到信息的原文和所有该信息的回复。",g.confirm(d,"添加范围提示",function(){i()},{onCancel:function(){e.hide()}})):i())}}):i()},$(".box-r",i)))},replyWithData:function(a,b){var c,d=this;b=_.extend({mediaSendCb:e.EMPTY_FN,sendClearCb:e.EMPTY_FN,mediaSendModal:null,subBtnSelector:null},b||{});var f=function(){g.api({type:"post",data:a,url:"/Feed/Reply",success:function(c){c.success&&("plain"==d._replyState?(d.prependItem(c.value),d._updateReplyRanges(!0)):"important"==d._replyState&&d.switchReplyState("plain"),b.sendClearCb.call(this,c),d.trigger("reply",c,a)),b.mediaSendCb()},error:function(){b.mediaSendCb(),g.alert("系统繁忙，请稍后重试。")}},{submitSelector:b.subBtnSelector})};a=a||{},a=_.extend(a,this._getReplyRequestDataExt()),c=g.getAtFromContent(a.replyContent),c.length>0&&a.feedID?g.api({url:"/Feed/SendFeedReplyAtEmpCheck",data:{feedID:a.feedID,replyContent:a.replyContent},success:function(a){var c,d=!1,e="回复中提到的员工：";a.success&&(c=a.value,d=!c.value,d?(e+=c.value1+"不在信息的原始范围中，是否要添加？添加后他们将能看到信息的原文和所有该信息的回复。",g.confirm(e,"添加范围提示",function(){f()},{onCancel:function(){b.mediaSendModal&&$(b.mediaSendModal).hide()}})):f())}}):f()},prependItem:function(a){var b=this,c=this.get("feedData"),d={feedID:c.feedID,feedReplyID:a,feedType:c.feedType},e=this.element,f=$(".reply-list",e);g.api({type:"get",data:d,url:"/Feed/GetFeedReplyByID",success:function(a){var c;a.success&&(c=a.value.items,c.length>0&&f.is(":hidden")&&f.show(),_.each(c,function(c){b._createReplyItem(c,a.serviceTime).prependTo(f)}),b._totalCount=b._totalCount+c.length,b.trigger("replycount",b._totalCount,b._replyState))}})},switchReplyState:function(a,b){var c=this.get("feedData"),d=c.feedType,e=this.element,f=$(".reply-title",e);e.is(":hidden")&&this.show(),"important"==a?((2==d||3==d||4==d)&&(this._listPath="/Feed/GetFeedKeyReplysByFeedID",this.set("showMainInput",!1)),f.show(),this._updateReplyRanges(!1)):"plain"==a&&(this._listPath="/Feed/GetFeedReplysByFeedID",this.set("showMainInput",!0),this._updateReplyRanges(!0),f.hide()),this.emptyList(),this.fetchList(b),this._replyState=a,this.trigger("replystate",a)},getReplyState:function(){return this._replyState},_onChangeShowMainInput:function(a){var b=this.element,c=$(".main-input",b),d=$(".reply-list",b);a?c.show():c.hide(),a&&this.get("autoOpenMainInput")&&this.switchInputState($(".main-input",b),"shown"),a&&d.is(":visible")?c.removeClass("main-input-with-pt"):c.addClass("main-input-with-pt")},_onChangeTitle:function(a){var b=this.element,c=$(".reply-title",b);c.text(a),0==a.length?c.hide():c.show()},destroy:function(){var a,b=this.element,c=$(".main-input",b),d=$(".input-box-shown",c),e=$(".reply-input",d),f=$(".media",d);return f.data("media")&&f.data("media").destroy(),e.data("atInput")&&e.data("atInput").destroy(),this.emptyList(),b&&b.empty(),a=A.superclass.destroy.apply(this,arguments)}});c.exports=A});