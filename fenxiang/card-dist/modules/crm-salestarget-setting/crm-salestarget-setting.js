/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-salestarget-setting/crm-salestarget-setting",["dialog","util","modules/crm-salestarget-setting/crm-salestarget-setting.html","moment"],function(a,b,c){var d=a("dialog"),e=a("util"),f=a("modules/crm-salestarget-setting/crm-salestarget-setting.html"),g=a("moment"),h=e.getCrmData().currentEmp,i=d.extend({attrs:{element:null,width:925,content:f,closeTpl:"<div class = 'crm-ui-dialog-close crm-salestarget-setting-close'>×</div>",fiscalYear:2014,yearFrom:2013,result:{},month:{January:0,February:0,March:0,April:0,May:0,June:0,July:0,August:0,September:0,October:0,November:0,December:0},season:{FirstSeason:0,SecondSeason:0,ThirdSeason:0,FourthSeason:0},year:{FiscalYear:0,Year:0},isInit:!1},setup:function(){var a=i.superclass.setup.apply(this,arguments);return a},_init:function(){this._initYearSelect(),this._initEvent()},_initYearSelect:function(){for(var a=this.get("yearFrom"),b=g().year(),c=[],d=a;b+1>=d;d++)c.push({text:d+"年",value:d,selected:d==b});e.mnSelect($(".crm-salestarget-setting-select-list-year",this.element),"syncModel",c),this.set("fiscalYear",b)},_initEvent:function(){var a=this;e.mnEvent($(".crm-salestarget-setting-select-list-year",this.element),"change",function(b){a.set("fiscalYear",b),a._setYear(),a._getData()})},_setYear:function(){var a=this.get("fiscalYear");_.each($(".crm-salestarget-setting-year",this.element),function(b){$(b).text(a)})},_getData:function(){var a=this.get("fiscalYear"),b=this.get("employee"),c=this;e.api({url:"/SalesStatistic/GetSalesTargetOfLower/",type:"get",dataType:"json",data:{fiscalYear:a,employeeID:b.employeeID},success:function(a){if(a.success){var b=a.value.employeeSalesTarget;c.set("result",b),c._setValue(b)}}})},_saveData:function(){var a=this.get("fiscalYear"),b=this.get("employee"),c=this.get("year"),d=this.get("season"),f=this.get("month"),g=this,h={};c.FiscalYear=a,h=_.extend(h,c),h=_.extend(h,d),h=_.extend(h,f);for(var i in h){var j=$("."+i.toLowerCase(),this.element).val();if(j){if(!this._isValid(j))return e.alert("请正确填写金额"),void 0;h[i]=j}}h.employeeID=b.employeeID,e.api({url:"/SalesStatistic/SaveSalesTargetOfLower/",type:"post",dataType:"json",data:h,success:function(a){a.success&&(g.trigger("saved"),g.hide())}})},_setValue:function(a){for(var b in a)$("."+b,this.element)&&$("."+b,this.element).val(a[b])},_isValid:function(a){var b=/^(([1-9]\d{0,9})|0)(\.\d{1,2})?$/;return b.test(a)?!0:!1},_toMonth:function(){var a=$(".year",this.element).val();if(0!=a%12)return e.alert("年度目标不是12的整数倍，不能平均分配到每个月。"),void 0;var b=this.get("season"),c=this.get("month");for(var d in b)$("."+d.toLowerCase(),this.element).val(a/4);for(var d in c)$("."+d.toLowerCase(),this.element).val(a/12)},hide:function(){var a=i.superclass.hide.apply(this,arguments);return a},show:function(a){var b=i.superclass.show.apply(this,arguments);if(this.get("isInit")){var c=g().year();e.mnSetter($(".crm-salestarget-setting-select-list-year",this.element),c)}else this.set("isInit",!0),this._init();return $(".crm-salestarget-setting-who",this.element).html(a.employeeID==h.employeeID?"我":a.name),this.set("employee",a),this._setYear(),this._getData(),b},events:{"click .crm-salestarget-setting-button-ok":"_submit","click .crm-salestarget-setting-button-cancel":"_cancel","click .crm-salestarget-setting-to-month":"_toMonth"},_cancel:function(){this.hide()},_submit:function(){this._saveData()},destroy:function(){var a=i.superclass.destroy.apply(this,arguments);return a}});c.exports=i});