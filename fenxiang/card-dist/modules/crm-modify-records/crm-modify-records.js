/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-modify-records/crm-modify-records",["widget","modules/crm-modify-records/crm-modify-records.html","util","moment"],function(a,b,c){var d=window;d.FS,a("widget");var e=a("modules/crm-modify-records/crm-modify-records.html"),f=a("util"),g=a("moment"),h=Backbone.View.extend({records:[],params:null,template:_.template($(e).filter(".crm-modifyrecords-tpl").html()),refresh:function(a,b){!this.params&&(this.params=this.options),b&&(this.params.snapShotTitle=b),this.loadData(a)},bindEvents:function(){var a=this,b=this.$el.find(".mn-select-box");this.$el.find(".btn-left").bind("click",function(b){a.left(b)}),this.$el.find(".btn-right").bind("click",function(b){a.right(b)}),this.$el.find(".btn-back").bind("click",function(){a.back(a.params.contactId,f.mnGetter(b))}),f.mnEvent(b,"change",function(b){var c=a.getRecordIdx(b);a.refresh(b,a.records[c].title)})},back:function(a,b){var c=this;f.api({url:"/"+c.params.restoreUrl,type:"post",dataType:"json",data:{contactID:a,snapShotID:b},success:function(){f.remind(2,"恢复成功"),c.params.v.tab.select("tab-time-line"),c.params.v.refresh()}})},left:function(a){var b=$(a.target),c=this.$el.find(".mn-select-box");if(!b.hasClass("btn-disabled")){var d=f.mnGetter(c),e=this.getRecordIdx(d);e>0&&f.mnSetter(c,this.records[e-1].snapshotID),1==e&&b.addClass("btn-disabled"),this.$el.find(".btn-right").removeClass("btn-disabled")}},right:function(a){var b=$(a.target),c=this.$el.find(".mn-select-box");if(!b.hasClass("btn-disabled")){var d=f.mnGetter(c),e=this.getRecordIdx(d);e<this.records.length-1&&f.mnSetter(c,this.records[e+1].snapshotID),e==this.records.length-2&&b.addClass("btn-disabled"),this.$el.find(".btn-left").removeClass("btn-disabled")}},getRecordIdx:function(a){a+="";for(var b=-1,c=0,d=this.records.length;d>c;c++)if(a==this.records[c].snapshotID+""){b=c;break}return b},loadData:function(a){var b=this,c=b.params.contactId,d=b.params.recordsUrl,e=b.params.snapshotsUrl;f.api({dataType:"json",type:"get",url:d,data:{contactId:c},beforeSend:function(){f.showGlobalLoading(1)},success:function(d){return!d.success||d.value.snapshots.length<1?(f.hideGlobalLoading(1),void 0):(b.formatRecords(d.value,a),f.api({dataType:"json",type:"get",url:e,data:{contactId:c,snapshotID:a||d.value.snapshots[0].snapshotID},success:function(a){if(f.hideGlobalLoading(1),a.success){var c=b.formatContent(a.value);b.render({records:b.records,main:c.main,other:c.other,phone:c.phone,addr:c.addr,desc:c.desc,snapShotTitle:b.params.snapShotTitle||b.records[0].title})}}}),void 0)}})},formatRecords:function(a,b){for(var c=a.snapshots,d=[],e=0,f=c.length;f>e;e++)d.push({title:[c[e].employee.name,"在",g.unix(c[e].snapshotTime).format("YYYY-MM-DD HH:mm"),"创建记录"].join(""),snapshotID:c[e].snapshotID,selected:b&&b==c[e].snapshotID?1:""});b||(d[0].selected=1),this.records=d},formatContent:function(a){var b=a.firstSnapshot,c=a.secondSnapshot,d=!1;c.contactID||(c.name="无",c.post="无",c.department="无",c.company="无",c.webSite="无",c.gender="无",c.yearOfBirth="0000",c.monthOfBirth=c.dayOfBirth="00",c.interest="无",c.contactWayObject=[],c.addressObject=[],c.remark="无",d=!0);var e=[],f=[],g=[],h=[],i=[];e.push({name:"姓名",state:d?"":c.name==b.name?"":"change",value0:c.name,value1:b.name}),e.push({name:"职务",state:d?"":c.post==b.post?"":"change",value0:c.post||"无",value1:b.post}),e.push({name:"部门",state:d?"":c.department==b.department?"":"change",value0:c.department||"无",value1:b.department}),e.push({name:"公司",state:d?"":c.company==b.company?"":"change",value0:c.company||"无",value1:b.company}),e.push({name:"网址",state:d?"":c.webSite==b.webSite?"":"change",value0:c.webSite||"无",value1:b.webSite}),f.push({name:"性别",state:d?"":c.gender==b.gender?"":"change",value0:"M"==c.gender?"男":"F"==c.gender?"女":"无",value1:"M"==b.gender?"男":"F"==b.gender?"女":""}),f.push({name:"生日",state:d?"":c.yearOfBirth==b.yearOfBirth&&c.monthOfBirth==b.monthOfBirth&&c.dayOfBirth==b.dayOfBirth?"":"change",value0:[(c.yearOfBirth||"0000")+"年",(c.monthOfBirth||"00")+"月",(c.dayOfBirth||"00")+"日"].join(""),value1:[b.yearOfBirth?b.yearOfBirth+"年":"",b.monthOfBirth?b.monthOfBirth+"月":"",b.dayOfBirth?b.dayOfBirth+"日":""].join("")}),f.push({name:"爱好",state:d?"":c.interest==b.interest?"":"change",value0:c.interest||"无",value1:b.interest});for(var j=0,k=c.contactWayObject.length;k>j;j++){for(var l=c.contactWayObject[j],m=!1,n=0,o=b.contactWayObject.length;o>n;n++){var p=b.contactWayObject[n];if(p.type==l.type&&p.content==l.content){m=!0;break}}m||g.push({name:l.typeDesc,state:"del",value0:l.content,value1:""})}for(var j=0,k=b.contactWayObject.length;k>j;j++){for(var p=b.contactWayObject[j],m=!1,n=0,o=c.contactWayObject.length;o>n;n++){var l=c.contactWayObject[n];if(p.type==l.type&&p.content==l.content){m=!0;break}}g.push({name:p.typeDesc,state:m?"":"new",value0:"",value1:p.content})}for(var j=0,k=c.addressObject.length;k>j;j++){for(var l=c.addressObject[j],m=!1,n=0,o=b.addressObject.length;o>n;n++){var p=b.addressObject[n];if(p==l){m=!0;break}}m||h.push({name:"地址",state:"del",value0:l,value1:""})}for(var j=0,k=b.addressObject.length;k>j;j++){for(var p=b.addressObject[j],m=!1,n=0,o=c.addressObject.length;o>n;n++){var l=c.addressObject[n];if(p==l){m=!0;break}}h.push({name:"地址",state:m?"":"new",value0:"",value1:p})}return i.push({name:"备注",state:d?"":c.remark==b.remark?"":"change",value0:c.remark||"无",value1:b.remark}),{main:e,other:f,phone:g,addr:h,desc:i}},render:function(a){var b=this.$el,c=this.template;return b.html(c(a)),this.options.wrapEl.html(b),this.bindEvents(),this}});c.exports=h});