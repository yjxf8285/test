/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-salestarget-table/crm-salestarget-table",["util","widget","moment","modules/crm-salestarget-table/crm-salestarget-table.html","modules/crm-salestarget-opportunity/crm-salestarget-opportunity","modules/crm-salestarget-export/crm-salestarget-export","modules/crm-chart/mainchart"],function(a,b,c){var d=window,e=d.FS,f=e.tpl,g=a("util"),h=a("widget"),i=a("moment"),j=a("modules/crm-salestarget-table/crm-salestarget-table.html"),k=a("modules/crm-salestarget-opportunity/crm-salestarget-opportunity"),l=a("modules/crm-salestarget-export/crm-salestarget-export"),m=a("modules/crm-chart/mainchart"),n=h.extend({attrs:{element:null,condition:{fiscalYear:2014,salesForecastTimeRange:1,employeeID:2,containSubordinate:!0,isFirst:!0},yearFrom:2013,opportunity:null,chart:null,cellSelectApi:"/SalesStatistic/GetSalesOpportunitysOfSalesForecastCellSelect",rowSelectApi:"/SalesStatistic/GetSalesOpportunitysOfSalesForecastRowSelect",cell:{monthNo:0,cellType:0,salesStageNo:0},status:"row"},events:{"click .crm-salestarget-group-button-detail":"_showDetail","click .crm-salestarget-group-button-prediction":"_showPrediction","click .crm-salestarget-group-button-table":"_showTable","click .crm-salestarget-group-button-chart":"_showChart","mouseover .crm-salestarget-table-can-hover-cell":"_cellMouseover","mouseout .crm-salestarget-table-can-hover-cell":"_cellMouseout","click .crm-salestarget-table-row-select":"_rowSelect","click .crm-salestarget-table-cell-select":"_cellClick"},setup:function(){var a=n.superclass.render.apply(this,arguments);return this._init(),a},_init:function(){this.element.html(j),this._initYearSelect(),this._initThisYearSelect(),this._initExport(),this._initEvent(),this._initOpportunity(),this._getData()},_initExport:function(){this.salestargetExport=new l({type:1})},_initYearSelect:function(){var a=this.get("yearFrom"),b=i().year(),c=[],d=this.get("condition");d.fiscalYear=b;for(var e=a;b+1>=e;e++)c.push({text:e+"年",value:e,selected:e==b});g.mnSelect($(".crm-salestarget-select-list-year",this.element),"syncModel",c),this.set("condition",d)},_initThisYearSelect:function(){var a=this._quarter(),b=this.get("condition");b.salesForecastTimeRange=a+3;var c=[{text:"一季度",value:4,selected:1==a},{text:"二季度",value:5,selected:2==a},{text:"三季度",value:6,selected:3==a},{text:"四季度",value:7,selected:4==a},{text:"上半年",value:2,selected:!1},{text:"下半年",value:3,selected:!1},{text:"全年",value:1,selected:!1}];g.mnSelect($(".crm-salestarget-select-list-this-year",this.element),"syncModel",c),this.set("condition",b)},_quarter:function(){var a=i().month();return Math.floor(a/3+1)},_initEvent:function(){var a=this;g.mnEvent($(".crm-salestarget-select-list-year",this.element),"change",function(b){var c=a.get("condition");c.fiscalYear=b,this.set("condition",c),a.refresh()}),g.mnEvent($(".crm-salestarget-select-list-this-year",this.element),"change",function(b){var c=a.get("condition");c.salesForecastTimeRange=b,this.set("condition",c),a.refresh()}),f.event.on("dataUpdate",function(){})},showExport:function(){if(this.salestargetExport){var a=this.get("condition");this.salestargetExport.show({fiscalYear:a.fiscalYear,salesForecastTimeRange:a.salesForecastTimeRange,employeeID:a.employeeID,containSubordinate:a.containSubordinate})}},_initOpportunity:function(){var a=this,b=new k({element:$(".crm-salestarget-opportunity",this.opportunity)});b.on("dataUpdate",function(){a.refresh()}),this.set("opportunity",b)},_initChart:function(a){var b=new m.Typeba($(".crm-salestarget-table-chart",this.element),a);this.set("chart",b)},_getData:function(){var a=this.get("condition"),b=this;g.api({url:"/SalesStatistic/GetSalesForecastDataOfEmployee",type:"get",dataType:"json",data:a,success:function(c){c.success&&(a.isFirst=!1,b.set("condition",a),b._showData(c.value.salesForecastDataRows),b.get("chart")?b.get("chart").update(c):b._initChart(c))}})},_showData:function(a){if(a&&!(a.length<1)){var b=this,c="",d="",e="",f="<tr>",g=1028/(a[0].pipelineColumns.length+1)-40;_.each(a[0].pipelineColumns,function(a){f+="<th><div style = 'width:"+g+"px' title = '"+a.name+"("+a.winRate+"%)'>"+a.name+"("+a.winRate+"%)</div></th>"}),f+="<th>销售漏斗</th></tr>",$(".crm-salestarget-detail-table-head",this.element).html(f),_.each(a,function(a){var f="合计";a.isTotalRow||(f=a.monthNo+"月"),c+="<tr><td class = 'crm-salestarget-table-can-hover-cell crm-salestarget-table-row-select' data-month = '"+a.monthNo+"'>"+f+"</td></tr>",d+="<tr>",_.each(a.pipelineColumns,function(c){d+="<td class = 'crm-salestarget-table-can-hover-cell crm-salestarget-table-cell-select' data-month = '"+a.monthNo+"' data-cellType = 1 data-salesStageNo = "+c.salesStageNo+">"+b._toCurrencyStr(c.amount)+"</td>"}),d+="<td class = 'crm-salestarget-table-can-hover-cell crm-salestarget-table-cell-select' data-month = '"+a.monthNo+"' data-cellType =1 data-salesStageNo = 0>"+b._toCurrencyStr(a.pipelineAmount)+"</td></tr>",e+="<tr><td class = 'crm-salestarget-table-can-hover-cell crm-salestarget-table-cell-select' data-month = '"+a.monthNo+"' data-cellType =1 data-salesStageNo = 0>"+b._toCurrencyStr(a.pipelineAmount)+"</td>",e+="<td class = 'crm-salestarget-table-can-hover-cell crm-salestarget-table-cell-select' data-month = '"+a.monthNo+"' data-cellType =2 data-salesStageNo = 0>"+b._toCurrencyStr(a.winAmount)+"</td>",e+="<td class = 'crm-salestarget-table-can-hover-cell crm-salestarget-table-cell-select' data-month = '"+a.monthNo+"' data-cellType =3 data-salesStageNo = 0>"+b._toCurrencyStr(a.maybeWinAmount)+"</td>",e+="<td class = 'crm-salestarget-table-can-hover-cell crm-salestarget-table-cell-select' data-month = '"+a.monthNo+"' data-cellType =4 data-salesStageNo = 0>"+b._toCurrencyStr(a.salesForecastAmount)+"</td>",e+="<td class = 'crm-salestarget-table-cannot-hover-cell' data-month = '"+a.monthNo+"'>"+b._toCurrencyStr(a.targetAmount)+"</td></tr>"}),$(".crm-salestarget-month-table-body",this.element).html(c),$(".crm-salestarget-detail-table-body",this.element).html(d),$(".crm-salestarget-prediction-table-body",this.element).html(e),this._unselect();var h=this.get("cell");h.monthNo=0,h.cellType=0,h.salesStageNo=0,this._setSelect()}},_setSelect:function(){var a=this.get("cell"),b="";0==a.cellType&&0==a.salesStageNo?(_.each($("[data-month="+a.monthNo+"]",this.element),function(a){$(a).addClass("crm-salestarget-table-cell-selected")}),b=this.get("rowSelectApi")):($("[data-month="+a.monthNo+"][data-cellType="+a.cellType+"][data-salesStageNo="+a.salesStageNo+"]",this.element).addClass("crm-salestarget-table-cell-selected"),b=this.get("cellSelectApi")),this._opportunityRefresh(b)},_unselect:function(){var a=this.get("cell");_.each($("[data-month="+a.monthNo+"]",this.element),function(a){$(a).removeClass("crm-salestarget-table-cell-selected")})},_toCurrencyStr:function(a){return"¥"+_.str.numberFormat(parseFloat(parseFloat(a).toFixed(2)),2)},_showTable:function(){$(".crm-salestarget-group-button-table",this.element).addClass("crm-salestarget-group-button-selected"),$(".crm-salestarget-group-button-chart",this.element).removeClass("crm-salestarget-group-button-selected"),$(".crm-salestarget-table-chart",this.element).hide(),$(".crm-salestarget-table-explaination",this.element).show(),$(".crm-salestarget-table-info",this.element).show(),$(".crm-salestarget-group-button-detail",this.element).show(),$(".crm-salestarget-group-button-prediction",this.element).show()},_showChart:function(){$(".crm-salestarget-group-button-chart",this.element).addClass("crm-salestarget-group-button-selected"),$(".crm-salestarget-group-button-table",this.element).removeClass("crm-salestarget-group-button-selected"),$(".crm-salestarget-table-chart",this.element).show(),$(".crm-salestarget-table-explaination",this.element).hide(),$(".crm-salestarget-table-info",this.element).hide(),$(".crm-salestarget-group-button-detail",this.element).hide(),$(".crm-salestarget-group-button-prediction",this.element).hide(),this.get("chart")._frame()},_showDetail:function(){$(".crm-salestarget-group-button-detail",this.element).addClass("crm-salestarget-group-button-selected"),$(".crm-salestarget-group-button-prediction",this.element).removeClass("crm-salestarget-group-button-selected");var a=$(".crm-salestarget-prediction-table-container",this.element),b=$(".crm-salestarget-detail-table-container",this.element);a.animate({left:"0px"}),b.animate({left:"0px"})},_showPrediction:function(){$(".crm-salestarget-group-button-detail",this.element).removeClass("crm-salestarget-group-button-selected"),$(".crm-salestarget-group-button-prediction",this.element).addClass("crm-salestarget-group-button-selected");var a=$(".crm-salestarget-prediction-table-container",this.element),b=$(".crm-salestarget-detail-table-container",this.element);a.animate({left:"-1028px"}),b.animate({left:"-1028px"})},_cellMouseover:function(a){var b=$(a.currentTarget);b&&(b.hasClass("crm-salestarget-table-cell-selected")||b.addClass("crm-salestarget-table-cell-hover"))},_cellMouseout:function(a){var b=$(a.currentTarget);b&&b.removeClass("crm-salestarget-table-cell-hover")},_cellClick:function(a){var b=$(a.currentTarget);if(b){this._unselect();var c=this.get("cell");c.monthNo=b.attr("data-month"),c.cellType=b.attr("data-cellType"),c.salesStageNo=b.attr("data-salesStageNo"),this.set("cell",c),b.addClass("crm-salestarget-table-cell-selected"),this._opportunityRefresh(this.get("cellSelectApi"))}},_rowSelect:function(a){var b=$(a.currentTarget);if(b){this._unselect();var c=this.get("cell");c.monthNo=b.attr("data-month"),c.cellType=0,c.salesStageNo=0,this.set("cell",c),this._setSelect()}},_opportunityRefresh:function(a){var b=this.get("condition");b=_.extend(b,this.get("cell")),this.get("opportunity").refresh(a,b)},refresh:function(a){var b=this.get("condition");a&&(b=_.extend(b,a),this.set("condition",b)),this._getData()},destroy:function(){var a=n.superclass.render.apply(this,arguments);return a}});c.exports=n});