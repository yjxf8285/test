/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-productinopp-edit/crm-productinopp-edit",["modules/crm-productinopp-edit/crm-productinopp-edit.html","dialog","util","modules/publish/publish-helper","uilibs/currency-input","moment"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-productinopp-edit/crm-productinopp-edit.html"),h=a("dialog"),i=a("util"),j=a("modules/publish/publish-helper"),k=a("uilibs/currency-input");a("moment");var l=h.extend({attrs:{width:760,content:$(g).filter(".dialog-productinopp-template").html(),closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",className:"dialog-crm",oppProductRelations:void 0,oppProductRelationID:void 0},events:{"click .dialog-button-submit":"submit","click .dialog-button-back":"_back","click .dialog-button-close":"hide","click .dialog-button-edit":"_showEditWrapper","click .dialog-button-cancel":"_showViewWrapper","click .left-list li":"_switchNav"},_back:function(){$(".base-info",this.element).trigger("click")},_showEditWrapper:function(){this.set("flag","edit"),this.viewWrapper.hide(),this.sourceinfoWrapper.hide(),this.editWrapper.show(),this.editBtn.hide(),this.submitBtn.show(),this.cancelBtn.show(),this.closeBtn.attr("disabled",!0).css("opacity",".5"),$(".source-info").css({opacity:".5",cursor:"default"}),this.fillFormData()},_showViewWrapper:function(){var a=this;this.set("flag","view"),this.viewWrapper.show(),this.sourceinfoWrapper.hide(),this.editWrapper.hide(),this.editBtn.show(),this.backBtn.hide(),this.submitBtn.hide(),this.cancelBtn.hide(),this.backBtn.hide(),this.closeBtn.show().css("opacity","1").removeAttr("disabled"),$(".source-info").css({opacity:"1",cursor:"pointer"}),setTimeout(function(){$(".area-auto-height",a.element).trigger("autosize.resize")},1)},_showSourceInfoWrapper:function(){var a=this,b=this.get("oppProductRelations")||void 0;this.viewWrapper.hide(),this.editWrapper.hide(),this.editBtn.hide(),this.closeBtn.hide(),this.backBtn.show(),this.sourceinfoWrapper.show(),this.get("productData"),b.productID&&i.api({url:"/Product/GetProductByID",type:"get",dataType:"json",data:{productID:b.productID},success:function(b){b.success&&b.value&&b.value.products&&b.value.products.length>0&&(a.set("productData",b.value.products[0]),a.fillSourceInfoFormData())}},{submitSelector:""})},_switchNav:function(a){var b=$(a.target),c=this.get("flag")||"view";this.get("oppProductRelations")||void 0,this.element,"view"==c&&(b.parent().children().addClass("unselected"),b.removeClass("unselected"),b.hasClass("source-info")?this._showSourceInfoWrapper():b.hasClass("base-info")&&this._showViewWrapper()),b.hasClass("base-info")&&this._showViewWrapper()},render:function(){var a=l.superclass.render.apply(this,arguments),b=this.element;return this.backBtn=$(".dialog-button-back",b),this.editBtn=$(".dialog-button-edit",b),this.closeBtn=$(".dialog-button-close",b),this.submitBtn=$(".dialog-button-submit",b),this.cancelBtn=$(".dialog-button-cancel",b),this.viewWrapper=$(".product-view-wrapper",b),this.sourceinfoWrapper=$(".product-sourceinfo-wrapper",b),this.editWrapper=$(".product-edit-wrapper",b),this.setupDoms(),this.setupComponent(),a},hide:function(){var a=l.superclass.hide.apply(this,arguments);return this.reset(),a},show:function(a){var b=this;this.element;var c=l.superclass.show.apply(this,arguments);a.oppProductRelationID&&this.set("oppProductRelationID",a.oppProductRelationID),a.flag&&this.set("flag",a.flag);var d=this.get("oppProductRelationID")||void 0,e=this.get("flag")||"view";return"edit"==e?this._showEditWrapper():"view"==e&&this._showViewWrapper(),d&&i.api({url:"/SalesOpportunity/GetOppProductRelationsByID",type:"get",dataType:"json",data:{oppProductRelationID:d},success:function(a){a.success&&a.value&&a.value.oppProductRelations&&a.value.oppProductRelations.length>0&&(b.set("oppProductRelations",a.value.oppProductRelations[0]),b.fillFormData())}},{submitSelector:""}),c},reset:function(){$(".dialog-input-text",this.element).val(""),$(".unitAmount",this.element).val(""),$(".unit",this.element).val(""),$(".area-auto-height",this.element).val(""),this.currencyInput.reset(),$(".base-info",this.element).trigger("click"),$(".mn-select-box",this.element).each(function(){i.mnReset($(this))})},submit:function(a){var b=this,c=this.element.find(".product-edit-wrapper"),d=this.get("oppProductRelations")?this.get("oppProductRelations"):void 0,e=this.get("oppProductRelationID")?this.get("oppProductRelationID"):void 0,f=$(a.currentTarget),g=$(".productName",c).val()||"",h=this.currencyInput.val()||0,j=$(".unit",c).val()||"",k=$(".count",c).val()||0,l=$(".description",c).val()||"",m=parseFloat(k);return isNaN(m)?(i.alert("请填写正确单价"),void 0):k.split(".")[0].length>16?(i.alert("单价不能超过16位"),void 0):(k=parseFloat(m).toFixed(4),d&&i.api({url:"/SalesOpportunity/UpdateOppProductRelation",type:"post",dataType:"json",errorMsgTitle:"修改产品发生错误，原因：",data:{oppProductRelationID:e,productName:g,unitAmount:h,unit:j,count:k,description:l},success:function(a){a.success&&(b.hide(),i.remind(2,"保存成功"),b.v&&b.v.refresh&&b.v.refresh(),b.trigger("success"))}},{submitSelector:f}),void 0)},setupDoms:function(){var a=this.element;this.conTextareaEl=$(".area-auto-height",a)},setupComponent:function(){var a=this.element;j.AdjustTextAreaSize({element:this.conTextareaEl}),this.currencyInput=new k({element:$(".unitAmount",a.find(".product-edit-wrapper"))})},fillFormData:function(){var a=this.get("oppProductRelations")&&this.get("oppProductRelations"),b=this.element,c=this;a&&($(".productName",b).val(a.productName),$(".unitAmount",this.element.find(".product-view-wrapper")).text(a.unitAmount),this.currencyInput.setValue(a.unitAmount),$(".unit",b).val(a.unit),$(".count",b).val(a.count),$(".totalAmount",b).val(a.totalAmount),$(".description",b).val(a.description),setTimeout(function(){$(".area-auto-height",c.element).trigger("autosize.resize")},1))},fillSourceInfoFormData:function(){var a=this.get("productData")&&this.get("productData"),b=this.element.find(".product-sourceinfo-wrapper"),c=this;if(a){$(".productName",b).val(a.name),$(".unit",b).val(a.unit),$(".unitAmount",b).text(a.unitAmount),$(".description",b).text(a.description);var d=$(".product-source-info-tag",b).empty();_.map(a.fBusinessTagRelations,function(a){var b=$('<li class="fn-clear"><div class="inputs-tit"></div><div class="input-warp"><input readonly class="dialog-input-text description" placeholder=""/></div></li>');b.find(".inputs-tit").html(a.fBusinessTagName),b.find(".dialog-input-text").val(a.fBusinessTagOptionName),d.append(b)}),setTimeout(function(){$(".area-auto-height",c.element).trigger("autosize.resize")},1)}}});c.exports=l});