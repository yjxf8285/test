/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-userdefinefield/crm-userdefinefield",["modules/crm-userdefinefield/crm-userdefinefield.html","dialog","util","uilibs/search-box","modules/publish/publish-helper"],function(a,b,c){var d=a("modules/crm-userdefinefield/crm-userdefinefield.html"),e=a("dialog"),f=a("util"),g=a("uilibs/search-box");a("modules/publish/publish-helper");var h=Backbone.View.extend({warpEl:null,tagName:"div",className:"businesstags-list",url:null,data:null,template:_.template($(d).filter(".businesstags-template").html()),events:{"click .create-define-field-btn":"_create","click .tag-item":"_modify","click .tag-delbtn":"_delete","keyup .tags-search-input":"_searchTagsByKeyUp","click .backtoall-btn":"_backToAll","click .tags-search-btn":"_searchTags"},initialize:function(){var a=this.options.data.tagType;1==a||2==a||3==a||(this.options.data.tagType=1),this.render(),this.createDialog=new i({tagType:this.options.data.tagType}),this.createDialog.itemV=this,this.modifyDialog=new i({title:"编辑字段"}),this.modifyDialog.itemV=this},render:function(){var a=this.$el,b=this.template,c={tagsLength:0,keyWord:"",tagTitle:"客户自定义字段",value:{UserDefineFields:[]}};return a.html(b(c)),this.options.warpEl.html(a),this},destroy:function(){this.remove()},load:function(){var a=this,b=this.$el,c=_.extend({},this.options.data,{type:this.options.data.tagType});f.api({url:"/UserDefineField/GetUserDefineFieldData",type:"get",dataType:"json",data:c,success:function(c){if(c.success){b.html(a.template(a.formatData(c)));var d=a.options.data;d.textNum>9&&d.dateNum>4&&d.numNum>4?$(".user-define-field-ul",b).children().first().find(".create-define-field-btn").addClass("create-define-field-btn-disabled"):$(".user-define-field-ul",b).children().first().find(".create-define-field-btn").removeClass("create-define-field-btn-disabled");var e=$(".create-define-field-intro",b);10==d.textNum?e.find(".text").text(10-d.textNum).css("color","#ff0000"):e.find(".text").text(10-d.textNum),5==d.dateNum?e.find(".date").text(5-d.dateNum).css("color","#ff0000"):e.find(".date").text(5-d.dateNum),5==d.numNum?e.find(".num").text(5-d.numNum).css("color","#ff0000"):e.find(".num").text(5-d.numNum),a.tagType=a.options.data.tagType,a.setupDoms()}}})},refresh:function(a){a&&_.extend(this.options.data,a),this.load()},formatData:function(a){var b={},c="";switch(_.extend(b,a||{}),parseFloat(this.options.data.tagType)){case 1:c="客户";break;case 2:c="联系人";break;case 3:c="机会";break;default:c="客户"}b.tagTitle=c,b.keyWord=this.options.data.keyword,b.tagsLength=a.value.UserDefineFields.length||0;var d=0,e=0,f=0;return b.value.UserDefineFields=_.map(a.value.UserDefineFields,function(a){return 1==a.fieldType&&(a.fieldTypeName="文本",d+=1),2==a.fieldType&&(e+=1,a.fieldTypeName="日期"),3==a.fieldType&&(f+=1,a.fieldTypeName="数值"),a}),this.options.data.textNum=d,this.options.data.dateNum=e,this.options.data.numNum=f,b},setupDoms:function(){var a=this.$el,b=this;this.elEl=a,this.searchInputEl=$(".tags-search-input",a),this.searchInputEl.val(this.options.data.keyword);var c=$(".search-warp",a),d=new g({element:c,placeholder:"搜索字段"});d.on("search",function(a){b.queryValue=a;var c={tagType:b.tagType,keyword:a},d=a.length||0,e=200;d>e?f.alert("关键词长度不能大于"+e+"字,请修改",function(){}):b.refresh(c)}),c.find(".ui-search-field").val(this.options.data.keyword)},setupComponent:function(){},_create:function(a){if(!$(a.target).hasClass("create-define-field-btn-disabled")){var b=this.options.data;this.createDialog.show({textNum:b.textNum,dateNum:b.dateNum,numNum:b.numNum})}},_modify:function(a){var b=$(a.currentTarget),c=b.closest(".tag-item"),d=c.attr("data-id"),e=c.attr("data-typename"),f=c.find(".tag-name").text();this.modifyDialog.show({userDefineFieldID:d,fieldDescription:f,fieldTypeName:e})},_delete:function(a){var b=this,c=$(a.currentTarget),d=c.closest(".tag-item"),e=d.attr("data-id"),g=d.find(".tag-name").text();return f.confirm("确定要删除该字段吗“"+g+"”吗？","",function(){f.api({url:"/UserDefineField/DeleteUserDefineField",type:"post",dataType:"json",data:{userDefineFieldID:parseInt(e)},success:function(a){a.success&&b.refresh()}})}),!1},_backToAll:function(){var a={tagType:this.tagType,keyword:""};this.refresh(a)}}),i=e.extend({attrs:{width:600,closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",content:$(d).filter(".dialog-createnewtags-template").html(),className:"dialog-createnewtags",webDisk:null},events:{"click .crm-button-submit":"submit","click .crm-button-cancel":"hide"},render:function(){var a=i.superclass.render.apply(this,arguments);return this.get("title")&&$("h1",this.element).text(this.get("title")),this.setupComponent(),a},hide:function(){var a=i.superclass.hide.apply(this,arguments);return this.reset(),a},show:function(a){var b=i.superclass.show.apply(this,arguments),c=this.element;return a&&a.userDefineFieldID&&($(".view-wrapper",c).show(),$(".edit-wrapper",c).hide(),this.set("userDefineFieldID",a.userDefineFieldID),$(".fieldDescription",c).val(a.fieldDescription),$(".user-define-field-type-name",c).text(a.fieldTypeName)),b},reset:function(){var a=this.element;f.mnSetter($(".user-define-field-type",a),1),this.setupComponent(),this.set("userDefineFieldID",void 0),$(".view-wrapper",a).hide(),$(".edit-wrapper",a).show(),$(".fieldDescription",a).val("")},submit:function(){var a=this,b=this.get("tagType"),c=f.mnGetter($(".user-define-field-type",this.element))||1,d=$(".fieldDescription",this.element).val(),e=this.get("userDefineFieldID");e?f.api({url:"/UserDefineField/UpdateUserDefineField",type:"post",dataType:"json",errorMsgTitle:"添加自定义字段发生错误，原因：",data:{userDefineFieldID:e,fieldDescription:d},success:function(b){b.success&&(a.hide(),a.itemV.refresh())}},{submitSelector:""}):f.api({url:"/UserDefineField/AddUserDefineField",type:"post",dataType:"json",errorMsgTitle:"添加自定义字段发生错误，原因：",data:{type:b,fieldType:c,fieldDescription:d},success:function(b){b.success&&(a.hide(),a.itemV.refresh())}},{submitSelector:""})},setupComponent:function(){var a=this.element;f.mnSelect($(".user-define-field-type",a),"syncModel",[{value:1,text:"文本",selected:!0},{value:2,text:"日期"},{value:3,text:"数值"}])}});c.exports=h});