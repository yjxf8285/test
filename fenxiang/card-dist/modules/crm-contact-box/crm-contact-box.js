/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-contact-box/crm-contact-box",["widget","modules/crm-contact-box/crm-contact-box.html","util","modules/crm-select-contacts/crm-select-contacts","modules/crm-contact-view/crm-contact-view","modules/crm-contact-edit/crm-contact-edit","modules/crm-contact-operation/crm-contact-operation"],function(a,b,c){var d=window;d.FS;var e=a("widget"),f=a("modules/crm-contact-box/crm-contact-box.html"),g=a("util"),h=a("modules/crm-select-contacts/crm-select-contacts"),i=a("modules/crm-contact-view/crm-contact-view"),j=a("modules/crm-contact-edit/crm-contact-edit"),k=a("modules/crm-contact-operation/crm-contact-operation"),l=e.extend({attrs:{element:null,showTabContactNumEl:null,title:"联合跟进人",type:"operation",customerID:0,hasOperation:!0,items:[],combineApi:"/Contact/BatchCombineContactAndFCustomer",parameter:{customerID:0,contactIDs:[]},contactsDialog:null,newContactDialog:null},events:{"click .crm-contact-box-select":"_showSelectDialog","click .crm-contact-box-new":"_showNewDialog","click .crm-contact-box-modify":"_modify","click .crm-contact-box-image":"_detailoredit","click .crm-contact-box-name":"_detail"},setup:function(){var a=l.superclass.setup.apply(this,arguments);return this._init(),a},reload:function(a){a&&this.set("items",a),this._generateHtml()},remove:function(a){if(a){var b=_.filter(this.get("items"),function(b){return b.contactID!=a});this.set("items",b),this._generateHtml()}},add:function(a){if(a){var b=this.get("items");b.push(a),this.set("items",b),this._generateHtml()}},_showSelectDialog:function(){this.get("contactsDialog").show()},_showNewDialog:function(){this.trigger("onNew")},_init:function(){this.element.html(f),this._initContactsDialog(),this._initContactView(),this._initContactDialog(),"operation"==this.get("type")&&this._initOperation(),"modify"==this.get("type")&&this._initModifyDialog(),this._generateHtml()},_initContactsDialog:function(){var a=this,b=new h({title:"给客户选择联系人",defaultCondition:{employeeID:g.getCrmData().currentEmp.employeeID}});b.on("selected",function(b){if(!(b.length<1)){var c=a.get("parameter"),d=a.get("items"),e=[];_.each(b,function(a){e.push(a.contactID)}),c.contactIDs=e,g.api({url:a.get("combineApi"),type:"post",dataType:"json",data:c,success:function(c){c.success&&(d=d.concat(b),a.set("items",d),a._generateHtml())}})}}),this.set("contactsDialog",b)},_initModifyDialog:function(){var a=this,b=new h({title:"选择联系人",url:"/Contact/GetContactsByCustomerID/",type:"modify",defaultCondition:{customerID:this.get("customerID")}});b.on("selected",function(b){var c=a.get("parameter"),d=a.get("items"),e=[];_.each(b,function(a){e.push(a.contactID)}),c.contactIDs=e,g.api({url:"/SalesOpportunity/SetOppContacts",type:"post",dataType:"json",data:c,success:function(c){c.success&&(d=b,a.set("items",d),a._generateHtml(),a.trigger("modify",d))}})}),this.set("modifyDialog",b)},_initContactView:function(){var a=new i;this.set("contactView",a)},_initContactDialog:function(){var a=this,b=new j;b.on("updateSuccess",function(){a.trigger("updateSuccess")}),this.set("contactDialog",b)},_initOperation:function(){var a=this,b=new k({element:$(".crm-contact-box-operation",this.element)});b.on("new",function(){a._showNewDialog()}),b.on("select",function(){a._showSelectDialog()})},_generateHtml:function(){var a=this.get("items"),b="";_.each(a,function(a){b+="<div class = 'crm-contact-box-image-container fn-left fn-clear'>",b+="<img src ='"+g.getAvatarLink(a.profileImagePath,"2")+"' title = '"+a.name+"' class = 'crm-contact-box-image fn-left' data-value = '"+a.contactID+"' data-name ='"+a.name+"' data-post = '"+a.post+"' data-department = '"+a.department+"' />",b+="<div class = 'crm-contact-box-name fn-text-overflow fn-left fn-clear' data-value = '"+a.contactID+"' title = '"+a.name+"'>"+a.name+"</div>",b+=a.post&&a.department&&a.post.length+a.department.length>0?"<div class = 'crm-contact-box-department fn-text-overflow fn-left fn-clear' title = '"+a.post+"&nbsp;"+a.department+"'>"+a.post+"&nbsp;"+a.department+"</div></div>":"<div class = 'crm-contact-box-department fn-text-overflow fn-left fn-clear' >"+a.post+"&nbsp;"+a.department+"</div></div>"}),$(".crm-contact-box-content",this.element).html(b),this._showStatus()},_detailoredit:function(a){var b=$(a.currentTarget);this.get("canEdit")?this.get("contactDialog").show({contactID:b.attr("data-value")}):this.get("contactView").show({contactID:b.attr("data-value")})},_modify:function(){"modify"==this.get("type")&&this.get("modifyDialog").show(this.get("items"))},_showContactNum:function(a){var b=this,c=b.get("showTabContactNumEl"),d="";if(c){if(d=c.html(),"undefined"==typeof b.curContactsNum)return b.curContactsNum=a,a>0&&c.html(d.replace("联系人","联系人（"+a+"）")),void 0;0==a?c.html(d.replace("联系人（"+b.curContactsNum+"）","联系人")):b.curContactsNum>0?c.html(d.replace(b.curContactsNum,a)):c.html(d.replace("联系人","联系人（"+a+"）")),b.curContactsNum=a}},_showStatus:function(){var a=this.get("hasOperation"),b=this.get("items"),c=this.get("type");"modify"==c&&($(".crm-contact-box-info-modify",this.element).show(),$(".crm-contact-box-info-operation",this.element).hide(),b&&b.length?$(".crm-contact-box-modify",this.element).show():$(".crm-contact-box-modify",this.element).hide()),"operation"==c&&($(".crm-contact-box-info-modify",this.element).hide(),$(".crm-contact-box-info-operation",this.element).show()),b&&b.length>0?(this._showContactNum(b.length),$(".crm-contact-box-number",this.element).text(b.length),$(".crm-contact-box-number-container",this.element).show(),$(".crm-contact-box-content",this.element).show(),$(".crm-contact-box-info",this.element).hide()):(this._showContactNum(0),$(".crm-contact-box-number",this.element).text(""),$(".crm-contact-box-number-container",this.element).hide(),$(".crm-contact-box-content",this.element).hide(),$(".crm-contact-box-info",this.element).show(),a?($(".crm-contact-box-or",this.element).show(),$(".crm-contact-box-select",this.element).show()):($(".crm-contact-box-or",this.element).hide(),$(".crm-contact-box-select",this.element).hide())),a?($(".crm-contact-box-operation",this.element).show(),$(".crm-contact-operation-select-li",this.element).show(),$(".crm-contact-box-can-do",this.element).show()):($(".crm-contact-box-operation",this.element).show(),$(".crm-contact-operation-select-li",this.element).hide())},destroy:function(){this.get("contactsDialog")&&this.get("contactsDialog").destroy();var a=l.superclass.destroy.apply(this,arguments);return a}});c.exports=l});