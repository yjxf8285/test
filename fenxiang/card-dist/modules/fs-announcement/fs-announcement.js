/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/fs-announcement/fs-announcement",["util","dialog","./fs-announcement.html","modules/publish/publish"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.event;var f=a("util"),g=a("dialog"),h=a("./fs-announcement.html"),i=a("modules/publish/publish"),j=$(h),k=f.getContactData(),l=i.selectBar,m=i.atInput,n=i.mediaMaker,o=i.dateSelect,p=i.Receipt,q=function(a){a=_.extend({element:null,cls:"",data:[]},a||{}),this.opts=a,this.element=$(a.element),this.tid=null,this.init()};_.extend(q.prototype,{init:function(){this._renderEl(),this._bindEvents(),this._setCycle()},_renderEl:function(a){var b=this.element,c=this.opts,d=a||c.data,e='<ul class="fs-announcement-banner-list">',f='<ul class="nav-list fn-clear">';b.html('<div class="fs-announcement-banner '+c.cls+'"><div class="fs-announcement-banner-content"></div><div class="fs-announcement-banner-nav"></div><span class="close-h">×</span></div>'),_.each(d,function(a,b){var c="";0==b&&(c="state-active"),e+='<li class="fs-announcement-banner-item '+c+'">'+a+"</li>",f+='<li class="nav-item '+c+'" navindex="'+b+'">'+(b+1)+"</li>"}),e+="</ul>",f+="</ul>",$(".fs-announcement-banner-content",b).html(e),$(".fs-announcement-banner-nav",b).html(f)},_bindEvents:function(){var a=this,b=this.element;b.on("click",".close-h",function(){b.hide()}),b.on("click",".nav-item",function(){var c=$(".fs-announcement-banner-item",b).filter(":animated"),e=$(this),f=e.attr("navindex");c.length>0&&c.stop(!0,!0),clearInterval(a.tid),a._switchTo(f,d.EMPTY_FN,!1),a._setCycle()})},_setCycle:function(){var a,b=this,c=this.element,e=$(".nav-item",c),f=0;this.tid=setInterval(function(){a=e.filter(".state-active"),f=e.index(a)+1,f==e.length&&(f=0),b._switchTo(f,d.EMPTY_FN,!0)},5e3)},_switchTo:function(a,b,c){var d=this,e=this.element,f=$(".fs-announcement-banner-item",e),g=$(".nav-item",e),h=f.filter(".state-active"),i=g.filter(".state-active"),j=g.index(i),k=0;c&&(k=400),j!=a&&h.stop(!0,!0).fadeOut(k,function(){f.eq(a).addClass("state-active").show(),g.eq(a).addClass("state-active"),h.removeClass("state-active"),i.removeClass("state-active"),b&&b.call(d,a,j)})},addItem:function(a,b){var c=this.opts,d=c.data;_.isUndefined(b)&&(b=d.length-1),b>d.length-1&&(b=d.length-1),d=d.slice(0),d.splice(b,0,a),c.data=d,clearInterval(this.tid),this._renderEl(d),this._setCycle()},updateData:function(a){var b=this.opts;b.data=a,clearInterval(this.tid),this._renderEl(a),this._setCycle()},destroy:function(){clearInterval(this.tid),this.tid=null,this.element.off(),this.element.empty(),this.element=null}});var r=g.extend({attrs:{width:"580px",className:"fs-announcement-new-dialog",content:j.filter(".fs-announcement-new-dialog-tpl").html(),successCb:d.EMPTY_FN},events:{"click .f-announcement-sub":"_submit","click .f-announcement-cancel":"_cancel","change .announcement-sel-day":"_selectDate","click .is-announcement":"_clickIsReceipt"},_renderCpt:function(){var a=this,b=this.element,c=$(".range-selectbar",b),d=$(".announcement-content",b),e=$(".media",b),g=$(".announcement-free-time",b),h=$(".is-announcement",b),i=new l({element:c,data:[{title:"部门",type:"g",unitSuffix:"个部门",list:k.g},{title:"同事",type:"p",unitSuffix:"位同事",list:k.p}],title:"选择公示范围",defaultSelectedData:[{id:"999999",name:"全公司",type:"g"}],acInitData:f.getPublishRange(),autoCompleteTitle:"请输入部门或同事的名称或拼音"}),j=new m({element:d}),q=new n({element:e,action:["h5imgupload","h5attachupload","at"],actionOpts:{at:{inputSelector:d}}}),r=new o({element:g,placeholder:"选择日期"}),s=new p({inputSelector:d,rangeSb:i,submitCb:function(b){a.setReceiptRange(b),this.hide()},cancelCb:function(){h.prop("checked",!1),a.clearReceipt()}});this.sb=i,this.atInput=j,this.media=q,this.ds=r,this.receipt=s},setReceiptRange:function(a){var b,c,d=this.element,e=$(".receipt-tip",d),f=$(".send-sms-g",d),g=$(".send-sms-p",d),h=$(".is-send-sms",d),i=this.receipt;_.isEmpty(a)?e.text("").hide():(b=a.g||[],c=a.p||[],f.val(b.join(",")),g.val(c.join(",")),h.val($(".is-sms-send",i.element).prop("checked")?"1":"0"),e.text("已选择"+b.length+"个部门，"+c.length+"个人").show())},clearReceipt:function(){var a=this.element,b=$(".receipt-tip",a),c=$(".send-sms-g",a),d=$(".send-sms-p",a),e=$(".is-send-sms",a),f=$(".is-announcement",a);c.val(""),d.val(""),e.val("0"),b.empty().hide(),f.prop("checked",!1)},_clickIsReceipt:function(a){var b=this.receipt,c=$(a.target);c.prop("checked")?b.show():(b.hide(),this.clearReceipt())},render:function(){var a=r.superclass.render.apply(this,arguments);return this._renderCpt(),a},show:function(){var a=r.superclass.show.apply(this,arguments);return a},hide:function(){var a=r.superclass.hide.apply(this,arguments);return this._clear(),a},getRequestData:function(){var a,b=this.element,c=$(".announcement-title",b),d=$(".announcement-content",b),e=$(".is-announcement",b),f=$(".is-send-sms",b),g=$(".send-sms-g",b),h=$(".send-sms-p",b),i=$(".announcement-sel-day",b),j=this.media,k=this.sb,l=this.ds,m={},n=k.getSelectedData(),o=g.val(),p=h.val(),q=l.getValue(!0);return m.title=_.str.trim(c.val()),m.feedContent=_.str.trim(d.val()),m.isSendReceipt=e.prop("checked"),m.isSendSms=f.prop("checked"),m.smsCircleIDs=o?o.split(","):[],m.smsEmployeeIDs=p?p.split(","):[],m.showtimeDataType=i.val(),m.time=q?q.unix():0,m.fileInfos=[],a=j.getUploadValue(),_.each(a,function(a){"img"==a.uploadType?m.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&m.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),m.circleIDs=n.g||[],m.employeeIDs=n.p||[],m},isValid:function(){var a=this.element,b=$(".announcement-title",a),c=$(".content-input-wrapper",a),d=this.sb,e=this.getRequestData(),g=e.title;return 0==g.length?(f.showInputError(b),!1):0==e.feedContent.length?(f.showInputError(c),!1):0==e.circleIDs.length&&0==e.employeeIDs.length?($(".input-tip",d.element).click(),!1):!0},_clear:function(){var a=f.getContactData(),b=a.u,c=this.element,d=$(".announcement-title",c),e=$(".announcement-content",c),g=$(".announcement-sel-day",c);d.val(""),e.val("").trigger("autosize.resize"),this.sb.removeAllItem(),this.sb.addItem({id:999999,name:b.allCompanyDefaultString,type:"g"}),this.ds.clear(),this.media.resetAll(),g.val("2").change(),this.clearReceipt()},_selectDate:function(a){var b=this.element,c=$(a.target),d=$(".announcement-free-time",b);"12"==c.val()?d.show():d.hide()},_submit:function(a){var b,c=this,d=this.element,e=$(a.currentTarget),g=this.media;this.isValid()&&g.send(function(a){b=c.getRequestData(),f.api({data:b,url:"/FeedAnnounce/SendFeedAnnounce",success:function(d){d.success&&(c._clear(),c.get("successCb").apply(c,[d,b])),a()}},{submitSelector:e})},d),a.preventDefault(),a.stopPropagation()},_cancel:function(){this.hide()},destroy:function(){var a;return this.sb&&this.sb.destroy(),this.atInput&&this.atInput.destroy(),this.media&&this.media.destroy(),this.ds&&this.ds.destroy(),this.receipt&&this.receipt.destroy(),a=r.superclass.destroy.apply(this,arguments)}});_.extend(b,{NewNoticeDialog:r,NoticeBanner:q})});