/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-customer-list/crm-customer-list",["modules/crm-customer-list/crm-customer-list.html","modules/crm-select-filterbar/crm-select-filterbar","dialog","util","modules/publish/publish-helper","datatable","moment","uilibs/search-box","uilibs/pagination2","modules/crm-object-import/crm-object-import","modules/crm-customer-export/crm-customer-export","modules/crm-customer-add/crm-customer-add","modules/crm-select-contacts/crm-select-contacts","scrollbar"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-customer-list/crm-customer-list.html"),h=a("modules/crm-select-filterbar/crm-select-filterbar");a("dialog");var i=a("util");a("modules/publish/publish-helper"),a("datatable");var j=a("moment");a("uilibs/search-box");var k=a("uilibs/pagination2"),l=a("modules/crm-object-import/crm-object-import"),m=a("modules/crm-customer-export/crm-customer-export"),n=a("modules/crm-customer-add/crm-customer-add"),o=a("modules/crm-select-contacts/crm-select-contacts");a("scrollbar");var p,q=Backbone.View.extend({tagName:"div",className:"customer-list-module",template:_.template($(g).filter(".crm-customer-list-template").html()),options:{warpEl:null,url:"",hasButtons:!0,overwriteRowClick:!1,aoColumns:[{mData:"customerID",sWidth:"26px",sClass:"td-checkbox-warp",bSortable:!1,mRender:function(a){var b='<div class="mn-checkbox-box checkbox-for-comtable">&nbsp;&nbsp;<span data-value="'+a+'" class="mn-checkbox-item"></span> </div>';return b}},{mData:"followTime",sWidth:"24px",sClass:"customer-foolo",bSortable:!1,mRender:function(a){var b;return b=a>0?'<div class="customers-follow customers-following" title="取消关注"></div>':'<div class="customers-follow customers-nofollow" title="关注"></div>'}},{mData:"name",sWidth:"200px",sClass:"black-name crmtable-sort-name",bSortable:!0,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"fCustomerNo",sWidth:"50px",sClass:"black-name crmtable-sort-no",bSortable:!0,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"ownerName",sWidth:"50px",sClass:"black-name crmtable-sort-ownername",bSortable:!0,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"customerStateTagOptionName",sWidth:"100px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"lastUpdateTime",sWidth:"120px",sClass:"crmtable-sort-lastupdatetime",bSortable:!0,asSorting:["desc","asc"],mRender:function(a){var b='<span title="'+j.unix(a).format("YYYY-MM-DD HH:mm")+'">'+j.unix(a).format("YYYY-MM-DD HH:mm")+"</span>";return b}},{mData:"createTime",sWidth:"120px",sClass:"crmtable-sort-createtime",bSortable:!0,mRender:function(a){var b='<span title="'+j.unix(a).format("YYYY-MM-DD HH:mm")+'">'+j.unix(a).format("YYYY-MM-DD HH:mm")+"</span>";return b}},{mData:"createTime",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}],data:{employeeID:i.getCrmData().currentEmp.employeeID,keyword:"",isFirstChar:!1,listTagOptionID:"",sortType:1,queryType:2,pageSize:10,pageNumber:1},isLoadServerData:!1},events:{"click .crm-datatable th":"_crmTableSort","click .customers-follow":"_followSwitch","click .create-customer-btn":"_createCustomer","click .create-by-contracts-btn":"_createByContracts","click .delete-product-btn":"_deleteProduct","click .checkbox-selectall-btn":"_checkboxSelectall","click .customer-import":"_customerImport","click .customer-export":"_customerExport"},_crmTableSort:function(a){var b=this,c=$(a.target).css("cursor");"col-resize"!=c&&i.crmTableSortSet({element:$(".sort-select-list",this.$el),meEl:$(a.currentTarget),oThs:[{clasName:".crmtable-sort-name",sortType:[2,4]},{clasName:".crmtable-sort-no",sortType:[11,12]},{clasName:".crmtable-sort-ownername",sortType:[5,6]},{clasName:".crmtable-sort-lastupdatetime",sortType:[7,8]},{clasName:".crmtable-sort-createtime",sortType:[9,10]}],callback:function(a){b.refresh(a)}})},_customerImport:function(){this.importDialog.show()},_customerExport:function(){this.exportDialog.show()},_followSwitch:function(a){a.stopPropagation();var b=$(a.target),c=b.parents("tr").children().eq(0).find("span").attr("data-value");b.hasClass("customers-following")?i.api({url:"/FCustomer/CancelFCustomerFollow",type:"post",dataType:"json",data:{customerID:c},success:function(a){a.success&&b.removeClass("customers-following").addClass("customers-nofollow")}}):i.api({url:"/FCustomer/FCustomerFollow",type:"post",dataType:"json",data:{customerID:c},success:function(a){a.success&&b.removeClass("customers-nofollow").addClass("customers-following")}})},_createCustomer:function(){this.createDialog.show()},_createByContracts:function(){this.createByContactsDialog.show()},_getCustomerTagsDatas:function(){var a=i.getCrmData(),b=a.fBusinessTags,c=a.functionPermissions,d=a.isForbiddenCreateFCustomer,e=[],f=null,g=[{text:"不限",value:0}];_.each(b,function(a){a.type===i.CONSTANT.TAG_TYPE.CUSTOMER&&(a.isSystemTag?f=a:e.push(a),_.each(a.options,function(a){g.push({text:a.name,value:a.fBusinessTagOptionID})}))}),e.unshift(f),this.tags=e,this.TagsOptionForList=g,this.functionPermissions=c,this.isForbiddenCreateFCustomer=d},initialize:function(){var a=this.$el,b=this;this._getCustomerTagsDatas(),this.createDialog=new n,this.createDialog.v=this,this.createByContactsDialog=new o({title:"选择联系人创建客户",url:"/Contact/GetUserContacts/",defaultCondition:{employeeID:i.getCurrentEmp().employeeID,isFirstChar:!1,source:0,createCustomer:0,startDate:0,endDate:0,tagOptionIDsJson:"",sortType:1,keyword:"",isContainSubordinate:0,pageSize:12,pageNumber:1}}),this.createByContactsDialog.on("selected",function(a){var c=[];_.map(a,function(a){c.push(a.contactID)}),i.api({url:"/FCustomer/BatchAddFCustomerByContactID",type:"post",dataType:"json",data:{contactIDs:c},success:function(a){if(a.success){for(var c=[],d=a.value&&a.value.result||[],e=0,f=0,g=d.length;g>f;f++)d[f].value1?e++:c.push(d[f].value2);c.length?c.unshift("本次共成功创建客户"+e+"个,失败"+(d.length-e)+"个,失败原因:"):c.unshift("本次共成功创建客户"+e+"个,失败"+(d.length-e)+"个。"),i.alert(c.join("<br>")),b.refresh({listTagOptionID:"1,0",keyword:"",isFirstChar:!1,sortType:1,pageSize:10,pageNumber:1}),b.reSetMnselect()}}})}),this.createByContactsDialog.v=this,this.importDialog=new l({title:"我的客户导入",downloadApi:"GetMyFCustomerExcelTemplate",importApi:"/FCustomer/ImportMyFCustomer",downloadText:"我的客户导入模板"}),this.importDialog.on("uploaded",function(){b.refresh({listTagOptionID:"1,0",keyword:"",isFirstChar:!1,sortType:1,pageSize:10,pageNumber:1}),b.reSetMnselect()}),this.exportDialog=new m({title:"我的客户导出",exportApi:"/FCustomer/ExportMyFCustomersExcel"}),this.render();var c=this.options.hasButtons;c?$(".top-fn-btns",a).show():$(".top-fn-btns",a).hide(),this.setDataTabel(),this.options.isLoadServerData=!0},render:function(){var a=this.$el,b=this.template;return this.tags,a.html(b({value:{employees:{}}})),this.options.warpEl.html(a),this.showFnBtn(),this.setupComponent(),this},showFnBtn:function(){var a=$(".top-fn-btns",this.$el),b=!1,c=this.isForbiddenCreateFCustomer;_.each(this.functionPermissions,function(a){var c=a.value;31==c&&(b=!0)}),c?($(".create-customer-btn",this.$el).hide(),$(".create-by-contracts-btn",this.$el).hide(),$(".customer-import",this.$el).hide()):($(".create-customer-btn",this.$el).show(),$(".create-by-contracts-btn",this.$el).show(),$(".customer-import",this.$el).show()),b?a.show():a.hide()},setupComponent:function(){var a=this.$el,b=this,c=$(".pagination-wrapper",a),d=$(".customer-select-list",a),g=$(".sort-select-list",a);i.mnEvent(g,"change",function(a){i.mnSelect(g,"removeOption",2),$("th",b.oTable).removeClass("sorting_asc").removeClass("sorting_desc"),b.refresh({sortType:a})}),this.pagination=new k({element:c,pageSize:this.options.data.pageSize,totalSize:0,activePageNumber:1}),this.pagination.on("page",function(a){b.options.data.pageNumber=a,b.refresh()}),_.map(e.getAppStore("contactData").fBusinessTags,function(a){if(101==a.systemTagCode){p=a.fBusinessTagID;var c=[{value:0,text:"不限"}];_.map(a.options,function(a){c.push({text:a.name,value:a.fBusinessTagOptionID})}),i.mnEvent(d,"change",function(c){b.options.data.listTagOptionID=a.fBusinessTagID+","+c,b.refresh()}),b.selectEloptionsaaa=c}}),a.on("click",".crm-datatable tbody tr td",function(){if(!$(this).hasClass("td-checkbox-warp")){var c=$(this).closest("tr"),d=b.oTable.fnGetData(c.get(0)),e=d.customerID;if($(".crm-datatable tbody tr",a).removeClass("row_selected"),c.addClass("row_selected"),b.options.overwriteRowClick)return b.trigger("rowClick",e),void 0;var g=window.location.href.split("#")[1];g=g.split("/=/")[0];var h={id:e};h=_.extend({},i.getTplQueryParams2(),h),h.returnUrl=g+"/=/param-"+encodeURIComponent(JSON.stringify(h)),f.event.one("dataUpdate",function(){b.options.customerID=e,b.refresh()}),f.navRouter.navigate("#customers/showcustomer/=/param-"+encodeURIComponent(JSON.stringify(h)),{trigger:!0})}}),this.selectFilterbar||(this.selectFilterbar=new h({warpEl:$(".customer-select-toolbar",a),title:"客户 - 条件筛选",v:this,defLine:2,data:this.tags}))},refresh:function(a){a&&_.extend(this.options.data,a),this.oTable.fnReloadAjax()},reSetMnselect:function(){var a=this.$el,b=this,c=$(".customer-select-list",a);_.map(e.getAppStore("contactData").fBusinessTags,function(a){if(101==a.systemTagCode){p=a.fBusinessTagID;var d=[{value:0,text:"不限"}];_.map(a.options,function(a){d.push({text:a.name,value:a.fBusinessTagOptionID})}),i.mnEvent(c,"change",function(c){b.options.data.listTagOptionID=a.fBusinessTagID+","+c,b.refresh()}),b.selectEloptions=d}}),i.mnSelect(c,"syncModel",this.selectEloptions),i.mnSelect($(".sort-select-list",a),"syncModel",[{text:"发生变化的在最前面",value:0},{text:"按名称排序",value:2}]),this.pagination.jump(1,!0)},setDataTabel:function(){var a=this,b=this.$el,c=b.find(".crm-table-bd .crm-datatable");this.oTable=c.dataTable({sDom:"Rlfrtip",aoColumns:this.options.aoColumns,sAjaxSource:this.options.url,fnServerData:function(c,d,e,f){if(a.options.isLoadServerData){var g=a.options.data;f.jqXHR=i.api({dataType:"json",type:"get",url:c,data:g,beforeSend:function(){i.showGlobalLoading(1)},success:function(c){i.hideGlobalLoading(1);var d=c.value.totalCount;$(".customers-title-intro",b).children("span").text(d),a.customers=c.value.customers,e(a._formatTableData(c)),a.pagination.setTotalSize(d),a.options.customerID&&$("[data-value="+a.options.customerID+"]").closest("tr").addClass("row_selected"),$(".checkbox-for-comtable .mn-checkbox-item",a.$el).removeClass("mn-selected"),$("tbody tr",a.oTable).each(function(){var a=this;i.mnEvent($(this).find(".mn-checkbox-box"),"change",function(b){""==b?$(a).addClass("row_selected"):$(a).removeClass("row_selected")})}),d?($(".count-text").show(),$(".count-num").text(d)):$(".count-text").hide()}})}},bAutoWidth:!1,bFilter:!1,bPaginate:!1,bInfo:!1,bSort:!1,oLanguage:{sEmptyTable:'<span class="empty-tip">没有获取到客户</span>'}})},_formatTableData:function(a){var b=[],c=a.value,d=c.customers;return c.directorys,_.each(d,function(a){b.push(_.extend({isDir:!0,downloadTimes:0,attachSize:0},a))}),{aaData:b}},_checkboxSelectall:function(a){var b=$(a.currentTarget),c=this.$el.find(".crm-table-bd .crm-datatable tbody"),d=$(".checkbox-for-comtable",c),e=d.find(".mn-checkbox-item");b.is(".mn-selected")?(e.removeClass("mn-selected"),$("tbody tr",this.oTable).removeClass("row_selected")):(e.addClass("mn-selected"),$("tbody tr",this.oTable).addClass("row_selected"))},destroy:function(){this.remove()}});c.exports=q});