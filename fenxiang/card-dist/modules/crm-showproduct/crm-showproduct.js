/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-showproduct/crm-showproduct",["modules/crm-product-list/crm-product-list.html","dialog","util","modules/publish/publish-helper","uilibs/currency-input","datatable","moment","uilibs/search-box","uilibs/pagination2"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-product-list/crm-product-list.html"),h=a("dialog"),i=a("util"),j=a("modules/publish/publish-helper"),k=a("uilibs/currency-input");a("datatable");var l=a("moment"),m=a("uilibs/search-box"),n=a("uilibs/pagination2"),o=Backbone.View.extend({tagName:"div",className:"product-list-module",template:_.template($(g).filter(".crm-product-list-template").html()),options:{warpEl:null,url:"",data:{keyword:"",listTagOptionID:"407,0",sortType:0,pageSize:10,pageNumber:1}},events:{"click .crm-datatable th.product-name":"_thProductName","click .crm-datatable th.modif-time":"_thModifTime","click .create-product-btn":"_createProduct","click .delete-product-btn":"_deleteProduct","click .checkbox-selectall-btn":"_checkboxSelectall"},_thProductName:function(){$(".crm-table-list-hd .fn-right .mn-select-title",this.$el).text("按名称排序")},_thModifTime:function(){$(".crm-table-list-hd .fn-right .mn-select-title",this.$el).text("发生变化的在最前面")},_createProduct:function(){this.createNewProductDialog.show()},_deleteProduct:function(){var a=this,b=this.$el.find(".crm-table-bd .crm-datatable tbody"),c=$(".checkbox-for-comtable .mn-checkbox-item",b),d=[];c.each(function(){$(this).is(".mn-selected")&&d.push($(this).data("value"))}),d.length>0?i.confirm("你确定要删除选中的"+d.length+"个产品吗？","",function(){i.api({url:"/Product/DeleteProducts",type:"post",dataType:"json",data:{productIDs:d},success:function(b){if(b.success){var c=b.value.result,d="",e="",f=0,g=0;_.each(c,function(b){var c=b.value,d=b.value1,h=b.value2,i="";_.each(a.products,function(a){a.productID===c&&(i=a.name)}),d?f++:(e+=i+"删除失败，原因："+h+"</br>",g++)}),d+=e+"本次操作有"+f+"个成功，"+g+"个失败",i.alert(d,function(){$(".checkbox-selectall-btn .mn-checkbox-item").removeClass("mn-selected"),a.refresh()})}}})}):i.alert("请选择要删除的产品")},_getProductTagsDatas:function(){var a=i.getCrmData(),b=a.fBusinessTags,c=a.functionPermissions,d=[],e=[{text:"不限",value:0}];_.each(b,function(a){5===a.type&&(d.push(a),110===a.systemTagCode&&_.each(a.options,function(a){e.push({text:a.name,value:a.fBusinessTagOptionID})}))}),this.allProductTags=d,this.productLineTagsForList=e,this.functionPermissions=c},initialize:function(){this._getProductTagsDatas(),this.render()},render:function(){var a=this.$el,b=this.template;return a.html(b({value:{employees:{}}})),this.options.warpEl.html(a),this.showFnBtn(),this.setupComponent(),this.createNewProductDialog=new p,this.createNewProductDialog.v=this,this},showFnBtn:function(){var a=$(".top-fn-btns",this.$el),b=!1;_.each(this.functionPermissions,function(a){var c=a.value;31==c&&(b=!0)}),b?a.show():a.hide()},setupComponent:function(){var a=this.$el,b=this,c=$(".search-warp",a),d=$(".pagination-wrapper",a),e=$(".product-select-list",a),g=$(".sort-select-list",a),h=new m({element:c,placeholder:"搜索产品"});this.pagination=new n({element:d,pageSize:this.options.data.pageSize,totalSize:0,activePageNumber:1}),i.mnSelect(e,"syncModel",this.productLineTagsForList),i.mnSelect(g,"syncModel",[{text:"发生变化的在最前面",value:"0"},{text:"按名称排序",value:"2"}]),i.mnEvent(e,"change",function(a){b.options.data.listTagOptionID="407,"+a,b.refresh()}),i.mnEvent(g,"change",function(a){b.options.data.sortType=a,b.refresh()}),h.on("search",function(a){b.options.data.keyword=a,b.refresh()}),this.pagination.on("page",function(a){b.options.data.pageNumber=a,b.refresh()}),a.on("click",".crm-datatable tbody tr",function(){var a=$(this).index(),c=b.oTable.fnGetData(a),d=encodeURIComponent("/")+"products"+encodeURIComponent("/")+"product",e=c.productID,g=c.name;f.navRouter.navigate("#products/showproduct/=/id-"+e+"/name-"+g+"/returnUrl-"+d,{trigger:!0})})},load:function(){this.setDataTabel()},refresh:function(){this.oTable.fnReloadAjax()},setDataTabel:function(){var a=this,b=this.$el,c=b.find(".crm-table-bd .crm-datatable");this.oTable=c.dataTable({sDom:"Rlfrtip",aoColumns:[{mData:"productID",sWidth:"26px",bSortable:!1,mRender:function(a){var b='<div class="mn-checkbox-box checkbox-for-comtable">&nbsp;&nbsp;<span data-value="'+a+'" class="mn-checkbox-item"></span> </div>';return b}},{mData:"name",sWidth:"200px",sClass:"product-name",bSortable:!0,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"unit",sWidth:"76px",sClass:"product-unit",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"unitAmount",sWidth:"76px",sType:"numeric-comma",sClass:"product-unitAmount",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"productLineTagOptionName",sWidth:"76px",sClass:"",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"creator",sWidth:"76px",sClass:"",bSortable:!1,mRender:function(a){var b='<span title="'+a.name+'">'+a.name+"</span>";return b}},{mData:"lastEditTime",sWidth:"100px",sClass:"modif-time",bSortable:!0,mRender:function(a){var b='<span title="'+l.unix(a).format("YYYY-MM-DD HH:mm")+'">'+l.unix(a).format("YYYY-MM-DD HH:mm")+"</span>";return b}},{mData:"lastEditTime",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}],sAjaxSource:this.options.url,fnServerData:function(b,d,e,f){var g=a.options.data;f.jqXHR=$.ajax({dataType:"json",type:"get",url:"../"+b,data:g,beforeSend:function(){i.showGlobalLoading(1)},success:function(b){i.hideGlobalLoading(1);var d=b.value.totalCount;a.products=b.value.products,e(a._formatTableData(b)),a.pagination.setTotalSize(d),$("tbody tr",this.oTable).each(function(){var a=this;i.mnEvent($(this).find(".mn-checkbox-box"),"change",function(b){""==b?$(a).addClass("row_selected"):$(a).removeClass("row_selected")})}),$(".dataTables_empty",c).html('<span class="empty-tip">没有获取到标签为'+$(".ui-search-field").val()+"产品</span>")}})},bAutoWidth:!1,bFilter:!1,bPaginate:!1,bInfo:!1,oLanguage:{sEmptyTable:'<span class="empty-tip">没有获取到标签为'+$(".ui-search-field").val()+"产品</span>"}})},_formatTableData:function(a){var b=[],c=a.value,d=c.products;return c.directorys,_.each(d,function(a){b.push(_.extend({isDir:!0,downloadTimes:0,attachSize:0},a))}),{aaData:b}},_checkboxSelectall:function(a){var b=$(a.currentTarget),c=this.$el.find(".crm-table-bd .crm-datatable tbody"),d=$(".checkbox-for-comtable",c),e=d.find(".mn-checkbox-item");b.find(".mn-checkbox-item").is(".mn-selected")?(e.removeClass("mn-selected"),$("tbody tr",this.oTable).removeClass("row_selected")):(e.addClass("mn-selected"),$("tbody tr",this.oTable).addClass("row_selected"))},destroy:function(){this.remove()}}),p=h.extend({attrs:{width:760,content:$(g).filter(".dialog-createnewproducttags-template").html(),className:"dialog-createnewproductdialog"},events:{"click .button-submit":"submit","click .button-cancel":"hide"},render:function(){var a=p.superclass.render.apply(this,arguments);return this.setupDoms(),this.setupComponent(),a},hide:function(){var a=p.superclass.hide.apply(this,arguments);return this.clear(),a},show:function(){var a=p.superclass.show.apply(this,arguments);return a},clear:function(){$(".area-auto-height",this.element).val(""),$(".mn-select-box",this.element).each(function(){i.mnReset($(this))})},submit:function(a){var b=this,c=$(a.currentTarget),d=this.element,e=$(".product-name",d).val(),f=$(".product-unitamount",d).val()||0,g=$(".product-unit",d).val(),h=$(".product-description",d).val(),j=$(".product-tags-list-warp > li",d),k=[];j.each(function(){var a=$(".selects-tit",$(this)).data("fbusinesstagid"),b=$(".mn-select-box",$(this)),c=i.mnGetter(b)||0;k.push(a+","+c)}),i.api({url:"/Product/AddProduct",type:"post",dataType:"json",data:{name:e,unitAmount:f,unit:g,description:h,listTagOptionID:k},success:function(a){a.success&&(b.hide(),b.v.refresh())}},{submitSelector:c})},setupDoms:function(){var a=this.element;this.conTextareaEl=$(".area-auto-height",a)},setupComponent:function(){var a=this.element,b=$(".product-tags-list-warp",a),c=this.v.allProductTags;this.currencyInput=new k({element:$(".product-unitamount",a)}),j.AdjustTextAreaSize({element:this.conTextareaEl}),_.each(c,function(a){var c=a.name,d=a.options,e="",f="";d.length>0?_.each(d,function(a){var b=a.isDefault;b&&(f=a.name),e+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'" data-selected="'+b+'">'+a.name+"</li></ul>"}):e='<ul class="mn-select-list"><li class="mn-select-item" data-value="0"></li></ul>',b.append('<li class="fn-clear"> <div class="selects-tit" data-fbusinesstagid="'+a.fBusinessTagID+'"> '+c+' </div> <div class="selects-warp"> <span select-cls="product-tags-list-selects" class="mn-select-box "><span class="mn-select-title-wrapper select-for-dialog"><span class="mn-select-title ">'+f+'</span><span class="title-icon"></span></span>'+e+"</span> </div> </li>")})}});c.exports=o});