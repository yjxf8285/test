/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-leaderssetting/crm-leaderssetting",["modules/crm-leaderssetting/crm-leaderssetting.html","dialog","uilibs/search-box","uilibs/pagination2","uilibs/select2","util","modules/publish/publish-helper","modules/crm-select-colleague/crm-select-colleague"],function(a,b,c){var d=a("modules/crm-leaderssetting/crm-leaderssetting.html"),e=a("dialog"),f=a("uilibs/search-box"),g=a("uilibs/pagination2"),h=a("uilibs/select2"),i=a("util");a("modules/publish/publish-helper");var j=a("modules/crm-select-colleague/crm-select-colleague"),k=Backbone.View.extend({warpEl:null,tagName:"div",className:"leaders-setting-module fn-clear",options:{data:{isStop:0,keyword:"",isFirstChar:!1,pageSize:28,pageNumber:1}},template:_.template($(d).filter(".leaders-setting-list-template").html()),events:{"click .leaders-settings-keyword-btn li":"_keyWordForSearch","click .leaders-setting-list-item":"_getLeaderInfoOfOneEmployee"},initialize:function(){this.render(),this.renderTemplate=this.template,this.warpEl=this.options.warpEl,this.ModifyLeaderDialog=new l,this.ModifyLeaderDialog.itemV=this,this.isStop=0,this.pageSize=this.options.data.pageSize},render:function(){var a=this.$el,b=this.template;return a.html(b({value:{employees:{}}})),this.options.warpEl.html(a),this},destroy:function(){this.remove()},load:function(){var a=this,b=this.$el;i.api({url:this.options.url,type:"get",dataType:"json",data:this.options.data,success:function(c){c.success&&(a.originData=c,a.totalCount=c.value.totalCount,a.pageNumber=c.value.pageNumber,b.html(a.renderTemplate(a.formatData(c))),a.setupDoms(),a.modifyTplDoms())}},{loadingType:1})},refresh:function(a){a&&_.extend(this.options.data,a),this.load()},formatData:function(a){var b={};return _.extend(b,a||{}),_.each(a.value.employees,function(a){a.profileImage=i.getAvatarLink(a.profileImage,"1")}),a.value.employees=_.filter(a.value.employees,function(a){return a.name}),b.isFirstChar=this.options.data.isFirstChar,b.keyWord=this.options.data.keyword,b},setupDoms:function(){var a=this.$el;this.elEl=a},setupComponent:function(){},modifyTplDoms:function(){var a=this,b=this.$el,c=this.$el.closest(".leaders-settings-warp"),d=$(".search-warp",b),e=$(".select-warp",b),j=$(".pagination-wrapper",b),k=c.find(".leaders-settings-hd .tit-name"),l=c.find(".leaders-settings-hd .count");this.originData.value.employees.length;var m=this.totalCount,n=this.pageNumber;0===this.isStop?k.text("在职同事"):k.text("离职同事"),l.text("共"+m+"个");var o=new f({element:d,placeholder:"按名字搜索同事"});o.on("search",function(b){a.queryValue=b,{tagType:a.tagType,keyword:b};var c=b.length||0,d=200;c>d?i.alert("关键词长度不能大于"+d+"字,请修改",function(){}):a.refresh({isStop:a.isStop,keyword:b,pageNumber:1,isFirstChar:!1})});var p=new h({element:e,autoRender:!0,hasAll:!0,defaultOption:{value:a.isStop},options:[{value:0,text:"在职同事"},{value:1,text:"离职同事"}]});p.on("selected",function(b){a.isStop=b.value,a.refresh({isStop:a.isStop,pageNumber:1})});var q=new g({element:j,pageSize:this.pageSize,totalSize:m,activePageNumber:n});if(q.on("page",function(b){a.refresh({pageSize:a.pageSize,pageNumber:b})}),this.options.data.isFirstChar){var r=$(".leaders-settings-keyword-btn li",this.$el);r.removeClass("cur");for(var s=0,t=r.length;t>s;s++)$(r[s]).text()==this.options.data.keyword&&$(r[s]).addClass("cur")}else d.find(".ui-search-field").val(this.options.data.keyword)},_keyWordForSearch:function(a){var b=this,c=$(a.target),d=c.text().toString();"全部"===d&&(d=""),c.siblings().removeClass("cur"),c.addClass("cur"),this.refresh({isStop:b.isStop,keyword:d,pageNumber:1,isFirstChar:!0})},_getLeaderInfoOfOneEmployee:function(a){var b=this,c=$(a.currentTarget),d=c.closest(".leaders-setting-list-item"),e=d.data("employeeid"),f=d.data("employeename");i.api({url:"/Employee/GetLeaderInfoOfOneEmployee",type:"get",dataType:"json",data:{employeeID:e},success:function(a){a.success&&(b.ModifyLeaderDialog.oData=a,b.ModifyLeaderDialog.myName=f,b.ModifyLeaderDialog.myId=e,b.ModifyLeaderDialog.show())}})}}),l=e.extend({attrs:{width:886,closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",content:$(d).filter(".dialog-modifyleader-template").html(),className:"dialog-modifyleader"},events:{"click .close-btn":"_closeItem","click .set-leader-unset-btn":"_unsetLeader","click .set-leader-updatebtn":"_setLeaderUpdate","click .set-lower-updatebtn":"_setLowerUpdate","click .set-leader-modify-btn":"_selectColleagueLeader","click .select-colleague-lower-btn":"_selectColleagueLower","click .button-cancel":"hide"},render:function(){var a=l.superclass.render.apply(this,arguments);return this.setupDoms(),this.setupComponent(),a},hide:function(){var a=l.superclass.hide.apply(this,arguments);return this.clear(),a},show:function(){var a=l.superclass.show.apply(this,arguments),b=this.oData.value,c=b.lowers,d="",e="";return $(".my-name").text(this.myName),b.leader&&b.leader.employeeID>0?(d='<li data-employeename="'+b.leader.name+'" data-employeeid="'+b.leader.employeeID+'" class="leaders-setting-list-item"><span class="close-btn leader">×</span><div class="l"><img class="item-img" alt="" src="'+i.getAvatarLink(b.leader.profileImage,"2")+'"></div><div class="r item-con"><div class="item-names"><div class="item-employee-name">'+b.leader.name+"</div></div></div></li>",this.leaderListWarpEl.html(d),$(".set-leader-tip",this.element).show()):(this.leaderListWarpEl.html('<li data-employeename="" data-employeeid="0" class="leaders-setting-list-item add"><a class="tip set-leader-modify-btn" href="javascript:;"> 点击选择上级 </a></li>'),$(".set-leader-tip",this.element).hide()),c.length>0&&(_.each(c,function(a){e+='<li data-employeename="'+a.name+'" data-employeeid="'+a.employeeID+'" class="leaders-setting-list-item"><span class="close-btn">×</span><div class="l"><img class="item-img" alt="" src="'+i.getAvatarLink(a.profileImage,"2")+'"></div><div class="r item-con"><div class="item-names"><div class="item-employee-name">'+a.name+"</div></div></div></li>"}),this.lowerListWarpEl.html(e)),this.lowersCountEl.text(c.length+"人"),a},clear:function(){this.lowerListWarpEl.html(""),this.setLeaderUpdatebtnEl.addClass("button-state-disabled"),this.setLowerUpdatebtnEl.addClass("button-state-disabled")},_setLeaderUpdate:function(a){var b=$(a.currentTarget),c=this,d=b.closest(".r"),e=this.myId,f=d.find(".leaders-setting-list-item"),g=f.data("employeeid"),h=f.data("employeename"),j="";b.is(".button-state-disabled")||(j=0==g?"是否确定不设置上级？在销售团队中，一般是只有最高负责人不需要设置上级":"确定设置“"+h+"”为“"+this.myName+"”的直属上级吗？设置成功以后“"+h+"”将可以看到“"+this.myName+"”及所有下属的客户资料。",i.confirm(j,"",function(){i.api({url:"/Employee/SetLeaderInfo",type:"post",dataType:"json",data:{employeeID:e,leaderID:g},beforeSend:function(){},success:function(a){a.success&&(i.remind(1,"设置成功"),c.itemV.refresh())}},{submitSelector:b})}))},_setLowerUpdate:function(a){var b=this,c=$(a.currentTarget),d=this.myId,e=c.closest(".r"),f=e.find(".leaders-setting-list-item");f.data("employeeid");var g=[];f.each(function(){var a=$(this).data("employeeid");g.push(a)}),c.is(".button-state-disabled")||i.confirm("确定设置所列用户为“"+this.myName+"”的直属下属吗？设置成功以后“"+this.myName+"”将可以看到所有下属的客户资料。","",function(){i.api({url:"/Employee/SetlowerInfo",type:"post",dataType:"json",data:{employeeID:d,lowerIDs:g.join(",")},success:function(a){a.success&&(i.remind(1,"设置成功"),b.itemV.refresh())}},{submitSelector:c})})},_selectColleagueLeader:function(){var a=[],b=this.leaderListWarpEl.find(".leaders-setting-list-item",this.element).data("employeeid");a.push(b),a.push(this.myId),this.selectColleagueS.set("condition",{exceptEmployeeIDs:a.join(",")}),this.selectColleagueS.show({exceptEmployeeIDs:a.join(",")})},_selectColleagueLower:function(){var a=[],b=this.leaderListWarpEl.find(".leaders-setting-list-item",this.element).data("employeeid");a.push(b),a.push(this.myId),this.lowerListWarpEl.find(".leaders-setting-list-item").each(function(){var b=$(this).data("employeeid");a.push(b)}),this.selectColleagueM.set("condition",{exceptEmployeeIDs:a.join(",")}),this.selectColleagueM.show({exceptEmployeeIDs:a.join(",")})},_closeItem:function(a){var b=$(a.currentTarget),c=b.closest(".lower-list-warp"),d=c.find(".leaders-setting-list-item"),e=b.closest(".leaders-setting-list-item"),f=d.length-1;b.is(".leader")?(e.html('<a class="tip set-leader-modify-btn" href="javascript:;"> 点击选择上级 </a>').addClass("add").attr({"data-employeeid":0,"data-employeename":""}).data("employeeid",0).data("employeename",""),this.setLeaderUpdatebtnEl.removeClass("button-state-disabled")):(e.remove(),this.lowersCountEl.text(f+"人"),this.setLowerUpdatebtnEl.removeClass("button-state-disabled"))},_unsetLeader:function(a){var b=$(a.currentTarget),c=b.closest(".r").find(".leaders-setting-list-item");c.html('<a class="tip set-leader-modify-btn" href="javascript:;"> 点击选择上级 </a>').addClass("add").attr({"data-employeeid":0,"data-employeename":""}).data("employeeid",0).data("employeename",""),this.setLeaderUpdatebtnEl.removeClass("button-state-disabled")},setupDoms:function(){var a=this.element;this.elEl=a,this.leaderListWarpEl=$(".leader-list-warp",a),this.setLeaderUpdatebtnEl=$(".set-leader-updatebtn",a),this.setLowerUpdatebtnEl=$(".set-lower-updatebtn",a),this.lowerListWarpEl=$(".lower-list-warp",a),this.lowersCountEl=$(".lowers-count",a)},setupComponent:function(){var a=this;this.selectColleagueS=new j({isMultiSelect:!1,condition:{exceptEmployeeIDs:this.myId},title:"请选择上级"}),this.selectColleagueM=new j({isMultiSelect:!0,condition:{exceptEmployeeIDs:this.myId},title:"请选择下级"}),this.selectColleagueS.on("selected",function(b){var c='<li data-employeename="'+b.name+'" data-employeeid="'+b.employeeID+'" class="leaders-setting-list-item"><span class="close-btn leader">×</span><div class="l"><img class="item-img" alt="" src="'+i.getAvatarLink(b.profileImage,"2")+'"></div><div class="r item-con"><div class="item-names"><div class="item-employee-name">'+b.name+"</div></div></div></li>";a.leaderListWarpEl.html(c),a.setLeaderUpdatebtnEl.removeClass("button-state-disabled")}),this.selectColleagueM.on("selected",function(b){a.setLowerUpdatebtnEl.removeClass("button-state-disabled");var c="",d=b;_.each(d,function(a){c+='<li data-employeename="'+a.name+'" data-employeeid="'+a.employeeID+'" class="leaders-setting-list-item"><span class="close-btn">×</span><div class="l"><img class="item-img" alt="" src="'+i.getAvatarLink(a.profileImage,"2")+'"></div><div class="r item-con"><div class="item-names"><div class="item-employee-name">'+a.name+"</div></div></div></li>"}),a.lowerListWarpEl.append(c),a.lowersCountEl.text($(".leaders-setting-list-item",a.lowerListWarpEl).length+"人")})}});c.exports=k});