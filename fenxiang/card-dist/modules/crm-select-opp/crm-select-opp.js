/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-select-opp/crm-select-opp",["dialog","util","uilibs/pagination2","modules/crm-select-opp/crm-select-opp.html","moment","datatable"],function(a,b,c){var d=a("dialog"),e=a("util"),f=a("uilibs/pagination2"),g=a("modules/crm-select-opp/crm-select-opp.html"),h=a("moment");a("datatable");var i=d.extend({attrs:{title:"选择联机会",url:"/SalesOpportunity/GetSalesOpportunityList",content:g,isMultiSelect:!1,hasDeptTree:!1,hasWorkLeaveBtn:!1,closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",width:800,height:535,condition:{},defaultCondition:{customerID:0,employeeID:e.getCurrentEmp().employeeID,queryType:1,sortType:1,keyword:"",beginSalesAmount:-1,endSalesAmount:-1,dealDayType:0,beginDealTime:-1,endDealTime:-1,beginStageDays:-1,endStageDays:-1,salesStageNos:"",tagOptionIDsJson:"",isReview:-1,isOwner:-1,pageSize:10,pageNumber:1},needToRest:!1,result:[],isLoadServerData:!1},setup:function(){this.get("condition")&&this.get("condition").customerID&&(this.get("defaultCondition").customerID=this.get("condition").customerID);var a=i.superclass.setup.apply(this,arguments),b=_.extend({},this.get("defaultCondition"),this.get("condition"));return this.set("condition",b),a},render:function(){var a=i.superclass.render.apply(this,arguments);return this._initTable(),a},hide:function(){var a=i.superclass.hide.apply(this,arguments);return this.reset(),a},show:function(){var a=i.superclass.show.apply(this,arguments);try{this.refresh(),this.pagination.reset()}catch(b){}return a},reset:function(){$(".search-input",this.element).val(""),this.set("condition",this.get("defaultCondition")),this.pagination.jump(1,!0)},events:{"click .crm-datatable th":"_crmTableSort","click .crm-datatable tbody tr td":"_selectRow","click .search-button":"_btnSearch","keydown .search-input":"_inputSearch"},_crmTableSort:function(a){var b=this;e.crmTableSortSet({element:$(".sort-select-list",this.$el),meEl:$(a.currentTarget),selectData:[{text:"发生变化的在最前面",value:"0"},{text:"预计成交金额大的在前面",value:"3"},{text:"预计成交日期早的在前面",value:"4"},{text:"销售阶段晚的在最前面",value:"7"},{text:"表格列排序",value:"",selected:!0}],oThs:[{clasName:".crmtable-sort-name",sortType:[8,9]},{clasName:".crmtable-sort-expectedsalesamount",sortType:[3,2]},{clasName:".crmtable-sort-expecteddealtime",sortType:[4,5]},{clasName:".crmtable-sort-salesstage",sortType:[7,6]}],callback:function(a){b.refresh(a)}})},_formatTableData:function(a){var b=[],c=a.value,d=c.salesOpportunitys;return _.each(d,function(a){b.push(_.extend({isDir:!0,downloadTimes:0,attachSize:0},a))}),{aaData:b}},_btnSearch:function(){this._search()},_inputSearch:function(a){13==a.keyCode&&(this._search(),a.preventDefault())},_search:function(){this.get("condition").keyword=$(".search-input",this.element).val(),this.refresh()},_selectRow:function(a){var b=$(a.target).closest("tr"),c=this.oTable.fnGetData(b.get(0));this.trigger("selected",c),this.hide()},_initTable:function(){var a=$(".crm-opp-list-datatable",this.element),b=this;b.pagination=new f({element:$(".pagination-wrapper",b.element),pageSize:b.get("condition").pageSize,totalSize:0,activePageNumber:1}),b.pagination.on("page",function(a){var c=b.get("condition");c.pageNumber=a,b.set("condition",c),b.refresh()}),this.oTable=a.hasClass("dataTable")?a:a.dataTable({sDom:"Rlfrtip",aoColumns:[{mData:"name",sWidth:"150px",sClass:"black-name crmtable-sort-name",bSortable:!0,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"owner",sWidth:"60px",sClass:"",bSortable:!1,mRender:function(a){var b='<span title="'+a.name+'">'+a.name+"</span>";return b}},{mData:"customerName",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"typeTagOptionName",sWidth:"80px",sClass:"",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"expectedSalesAmount",sWidth:"100px",sClass:"crmtable-sort-expectedsalesamount",bSortable:!0,mRender:function(a){var b=_.str.numberFormat(parseFloat(a),2),c='<span title="'+b+'">'+b+"</span>";return c}},{mData:"expectedDealTime",sWidth:"100px",sClass:"crmtable-sort-expecteddealtime",bSortable:!0,mRender:function(a){var b='<span title="'+h.unix(a).format("YYYY年MM月DD日")+'">'+h.unix(a).format("YYYY年MM月DD日")+"</span>";return b}},{mData:"lastEditTime",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}],sAjaxSource:this.get("url"),fnServerData:function(a,c,d,f){if(b.get("isLoadServerData")){var g=b.get("condition");f.jqXHR=e.api({dataType:"json",type:"get",url:a,data:g,beforeSend:function(){e.showGlobalLoading(1)},success:function(a){var c=a.value.totalCount;e.hideGlobalLoading(1),b.responseData=a,b.salesOpportunitys=a.value.salesOpportunitys,d(b._formatTableData(a)),b.pagination.setTotalSize(c)}})}},bAutoWidth:!1,bFilter:!1,bPaginate:!1,bInfo:!1,oLanguage:{sEmptyTable:'<span class="empty-tip">没有获取到机会</span>'}})},refresh:function(a){a&&this.set("condition",_.extend({},this.get("condition"),a)),this.set("isLoadServerData",!0),this.oTable.fnReloadAjax()},_submit:function(){this.get("isMultiSelect")?this.trigger("selected",this.get("result")):this.trigger("selected",this.get("result")[0]),this.hide()},_cancel:function(){this.hide()},destroy:function(){var a;return a=f.superclass.destroy.apply(this,arguments),this.reset(),a}});c.exports=i});