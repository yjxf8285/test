/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-opportunity-salesclue-edit/crm-opportunity-salesclue-edit",["modules/crm-opportunity-salesclue-edit/crm-opportunity-salesclue-edit.html","dialog","util","modules/publish/publish-helper","uilibs/currency-input","datatable","moment","uilibs/search-box","uilibs/pagination2","modules/crm-select-customer/crm-select-customer"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-opportunity-salesclue-edit/crm-opportunity-salesclue-edit.html"),h=a("dialog"),i=a("util"),j=a("modules/publish/publish-helper"),k=a("uilibs/currency-input");a("datatable"),a("moment"),a("uilibs/search-box"),a("uilibs/pagination2");var l=j.DateSelect;a("modules/crm-select-customer/crm-select-customer");var m=h.extend({attrs:{width:760,content:$(g).filter(".dialog-opportunity-salesclue-template").html(),className:"dialog-crm",closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",salesClueID:void 0,customerName:void 0,contactName:void 0},events:{"click .dialog-button-submit":"submit","click .dialog-button-cancel":"hide","click .isCreateSalesOpportunity-item":"_switchCreateOpp","blur .fCustomerName":"_checkCustomerExits"},_checkCustomerExits:function(){var a=$(".fCustomerName",this.element).val()||(this.get("customerName")?this.get("customerName"):""),b=this;i.api({url:"/FCustomer/CheckCustomerNameExists",type:"get",dataType:"json",data:{name:a},success:function(a){var c="";a.success&&(a.value.value?a.value.value1?(c="客户已存在，并且您拥有使用该客户的权限",$(".customer-exits-flag-icon",b.element).removeClass("customer-exits-flag-icon-cuo").addClass("customer-exits-flag-icon-dui")):(c="客户已存在，您不能使用该客户",$(".customer-exits-flag-icon",b.element).removeClass("customer-exits-flag-icon-dui").addClass("customer-exits-flag-icon-cuo")):(c="客户不存在，系统将自动创建",$(".customer-exits-flag-icon",b.element).removeClass("customer-exits-flag-icon-cuo").addClass("customer-exits-flag-icon-dui")),$(".customer-exits-flag-text",b.element).text(c))}},{submitSelector:""})},_switchCreateOpp:function(a){$(a.target).hasClass("mn-selected")?$(".isCreateSalesOpportunity-content",this.element).hide():$(".isCreateSalesOpportunity-content",this.element).show()},render:function(){var a=this,b=a.element,c=m.superclass.render.apply(this,arguments);return this.setupDoms(),this.setupComponent(),i.mnEvent($(".sales-stages-in-use",b),"change",function(a){console.log(a)}),c},hide:function(){var a=m.superclass.hide.apply(this,arguments);return this.reset(),a},reset:function(){var a=this.element;$(".area-auto-height",a).val(""),$(".mn-select-box",a).each(function(){i.mnReset($(this))}),i.mnSetter($(".sales-stages-in-use",a),"1"),i.mnSetter($(".isCreateSalesOpportunity",a),[]),$(".isCreateSalesOpportunity-content",a).hide(),this.starttimeDs.setValue(new Date),this.expectedDealTimeDs.clear(),this.currencyInput.reset()},show:function(a){var b=m.superclass.show.apply(this,arguments),c=this.element;a&&a.customerName&&this.set("customerName",a.customerName),a&&a.contactName&&this.set("contactName",a.contactName);var d=this.get("customerName")||"",e=this.get("contactName")||"";return d&&$(".fCustomerName",c).val(d),e&&$(".contactName",c).val(e),this.autoHeightTextarea.trigger("autosize.resize"),this._checkCustomerExits(),b},submit:function(a){var b=this,c=this.get("salesClueID")?this.get("salesClueID"):0,d=this.get("customerName")?this.get("customerName"):"",f=this.get("contactName")?this.get("contactName"):"";this.get("salesOpportunityID")?this.get("salesOpportunityID"):void 0;var g=$(a.currentTarget),h=this.element;d=$(".fCustomerName",h).val();var j,k=$(".opp-name",h).val(),l=($(".opp-customer-name",h).attr("data-customer-id"),i.mnGetter($(".sales-stages-in-use",h))||e.getAppStore("contactData").salesStagesInUse[0].salesStageNo),m=this.currencyInput.val()||0,n=this.starttimeDs.getTime()||0,o=this.expectedDealTimeDs.getTime()||0,p=$(".opp-demands",h).val(),q=$(".opp-description",h).val(),r=[],s=!1,t=i.mnGetter($(".isCreateSalesOpportunity",h));s=t&&t.length>0?1==t[0]?!0:!1:!1;var u=$(".opportunity-tags-list-warp > li",h);u.each(function(){var a=$(".f-business-tag-id",$(this)).data("fbusinesstagid"),b=$(".mn-select-box",$(this)),c=i.mnGetter(b)||0;r.push(a+","+c)}),i.api({url:"/SalesClue/CreateFCustomerAndContactAndSalesOpportunity",type:"post",dataType:"json",data:{salesClueID:c,fCustomerName:d,contactName:f,isCreateSalesOpportunity:s,sopName:k,sopSalesStageNo:l,sopExpectedSalesAmount:m,sopFoundTime:n,sopExpectedDealTime:o,sopDemands:p,sopDescription:q,listTagOptionID:r,sopIsOutReport:j},success:function(a){a.success&&(b.hide(),i.remind(2,"添加成功"),b.v.refresh())}},{submitSelector:g})},setupDoms:function(){var a=this.element;this.autoHeightTextarea=$(".area-auto-height",a)},setupComponent:function(){this.get("salesClueID")?this.get("salesClueID"):0;var a=this.get("customerName")?this.get("customerName"):"",b=this.get("contactName")?this.get("contactName"):"",c=e.getAppStore("contactData").salesStagesInUse,d=this.element;a&&$(".fCustomerName",this.element).val(a),b&&$(".contactName",this.element).val(b);var f=$(".opportunity-tags-list-warp",d),g=$(".found-time",d),h=$(".expected-deal-time",d);this.starttimeDs=new l({element:g,placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）",isCRM:!0}),this.starttimeDs.setValue(new Date),this.expectedDealTimeDs=new l({element:h,placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）",isCRM:!0}),this.currencyInput=new k({element:$(".expected-sales-amount",d)});var m=[];_.map(c,function(a){m.push({value:a.salesStageNo,text:a.name})}),i.mnSelect($(".sales-stages-in-use",d),"syncModel",m);var n=i.getTagsByType(i.CONSTANT.TAG_TYPE.SALES_OPP);j.AdjustTextAreaSize({element:this.autoHeightTextarea}),_.each(n,function(a){var b=a.name,c=a.options,d="",e="";c.length>0?_.each(c,function(a){var b=a.isDefault;b?(e=a.name,d+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'" data-selected="'+b+'">'+a.name+"</li></ul>"):d+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'">'+a.name+"</li></ul>"}):d='<ul class="mn-select-list"><li class="mn-select-item" data-value="0"></li></ul>',f.append('<li class="fn-clear"> <div class="selects-tit inputs-tit f-business-tag-id" data-fbusinesstagid="'+a.fBusinessTagID+'"> '+b+' </div> <div class="selects-warp"> <span select-cls="" class="mn-select-box "><span class="mn-select-title-wrapper select-for-dialog"><span class="mn-select-title ">'+e+'</span><span class="title-icon"></span></span>'+d+"</span> </div> </li>")}),$(".area-auto-height",d).trigger("autosize.resize")},fillFormData:function(){this.get("salesOpportunityID")?this.get("salesOpportunityID"):void 0;var a=this.get("oppData")?this.get("oppData").value.salesOpportunitys[0]:void 0,b=this.element;a&&($(".opp-name",b).val(a.name),$(".opp-customer-name",b).val(a.name).attr("data-customer-id",a.customerID),i.mnSetter($(".sales-stages-in-use",b),a.salesStageNo),this.currencyInput.setValue(a.expectedSalesAmount),this.starttimeDs.setValue(a.foundTime),this.expectedDealTimeDs.setValue(a.expectedDealTime),$(".opp-demands",b).val(a.demands),$(".opp-description",b).val(a.description),_.map(a.fBusinessTagRelations,function(a){a.fBusinessTagOptionID&&i.mnSetter($("[data-fbusinesstagid="+a.fBusinessTagID+"]",b).next().children(".mn-select-box"),a.fBusinessTagOptionID)}))}});c.exports=m});