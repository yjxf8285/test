/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-contract-edit/crm-contract-edit",["modules/crm-contract-edit/crm-contract-edit.html","dialog","util","modules/publish/publish-helper","uilibs/currency-input","moment","modules/crm-select-customer/crm-select-customer","modules/crm-select-colleague/crm-select-colleague","modules/crm-select-opp/crm-select-opp"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-contract-edit/crm-contract-edit.html"),h=a("dialog"),i=a("util"),j=a("modules/publish/publish-helper"),k=j.DateSelect,l=a("uilibs/currency-input");a("moment");var m=a("modules/crm-select-customer/crm-select-customer"),n=a("modules/crm-select-colleague/crm-select-colleague"),o=a("modules/crm-select-opp/crm-select-opp"),p=h.extend({attrs:{width:760,content:$(g).filter(".dialog-contract-template").html(),className:"dialog-crm",closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",contractData:void 0,contractID:void 0},events:{"click .dialog-button-submit":"submit","click .dialog-button-cancel":"hide","click .contract-opp-name-btn":"selectOpp","click .contract-customer-name-btn":"selectCustomer","click .contract-ownerID-btn":"selectOwner","click .contract-signerID-btn":"selectSigner"},render:function(){var a=this.element,b=p.superclass.render.apply(this,arguments);this.setupDoms(),this.setupComponent();var c=this;return this.selectOppDialog=new o({condition:{employeeID:i.getCurrentEmp().employeeID,customerID:c.get("customerID")||0}}),this.selectOppDialog.on("selected",function(b){i.disableCrmBtn($(".contract-customer-name-btn",a)),$(".contract-opp-name",a).val(b.name).attr("data-id",b.salesOpportunityID).trigger("autosize.resize"),$(".contract-customer-name",a).val(b.customerName).attr("data-id",b.customerID),c.totalAmount.setValue(b.expectedSalesAmount)}),this.selectCustomerDialog=new m({title:"选择客户",url:"/FCustomer/GetFCustomers/",defaultCondition:{employeeID:i.getCurrentEmp().employeeID,isFirstChar:!1,listTagOptionID:"",sortType:2,queryType:2,keyword:"",pageSize:12,pageNumber:1}}),this.selectCustomerDialog.on("selected",function(b){$(".contract-customer-name",a).val(b.name).attr("data-id",b.customerID).trigger("autosize.resize")}),this.selectOwnerDialog=new n({isMultiSelect:!1,hasWorkLeaveBtn:!1,title:"选择同事"}),this.selectOwnerDialog.on("selected",function(b){$(".contract-ownerID",a).val(b.name).attr("data-id",b.employeeID).trigger("autosize.resize")}),this.selectSignerDialog=new n({isMultiSelect:!1,hasWorkLeaveBtn:!1,title:"选择同事"}),this.selectSignerDialog.on("selected",function(b){$(".contract-signerID",a).val(b.name).attr("data-id",b.employeeID).trigger("autosize.resize")}),b},hide:function(){try{this.selectOppDialog.hide(),this.selectCustomerDialog.hide(),this.selectOwnerDialog.hide(),this.selectSignerDialog.hide()}catch(a){}var b=p.superclass.hide.apply(this,arguments);return this.reset(),b},reset:function(){var a=this.element;i.enableCrmBtn($(".contract-opp-name-btn",a)),i.enableCrmBtn($(".contract-customer-name-btn",a)),i.enableCrmBtn($(".contract-ownerID-btn",a)),$(".dialog-input-text",a).val(""),$(".area-auto-height",a).val("").removeAttr("style"),$(".contract-opp-name",a).removeAttr("data-id").val(""),$(".contract-customer-name",a).removeAttr("data-id").val(""),$(".mn-select-box",a).each(function(){i.mnReset($(this))}),i.mnSetter($(".contract-discount",a),[!1]),$(".contract-discount",a).find("input").val(10),$(".contract-discount",a).find("input").parent().hide(),this.totalAmount.reset(),this.signDate.clear(),this.beginDate.clear(),this.endDate.clear();var b=i.getCurrentEmp();$(".contract-ownerID",a).val(b.name).attr("data-id",b.employeeID),$(".contract-signerID",a).val(b.name).attr("data-id",b.employeeID)},show:function(a){var b,c=this;a&&a.contractID&&this.set("contractID",a.contractID);var d=this.get("contractID")||void 0;return this.fillExitsData(),d?i.api({url:"/Contract/GetContractByID",type:"get",dataType:"json",errorMsgTitle:"获取合同发生错误。原因：",async:!1,data:{contractID:d},success:function(a){a.success&&(b=p.superclass.show.apply(c,arguments),c.set("contractData",a),c.fillFormData())}},{submitSelector:""}):b=p.superclass.show.apply(this,arguments),b},submit:function(a){var b=this,c=this.get("contractData")?this.get("contractData").value.hContractEntity[0]:void 0,d=this.get("contractID")||void 0,e=$(a.currentTarget),f=this.element,g=$(".contract-title",f).val(),h=$(".contract-opp-name",f).attr("data-id")||0,j=$(".contract-customer-name",f).attr("data-id")||0,k=this.totalAmount.val(),l=10,m=this.signDate.getTime(),n=this.beginDate.getTime(),o=this.endDate.getTime(),p=$(".contract-ownerID",f).attr("data-id")||0,q=$(".contract-signerID",f).attr("data-id")||0,r=$(".contract-customerSigner",f).val(),s=$(".contract-contractNO",f).val(),t=$(".contract-content",f).val(),u=$(".contract-productDescription",f).val(),v=$(".contract-description",f).val(),w=!1,x=!1,y=i.mnGetter($(".contract-paymentType",f))||1,z=[];if(""==g)return i.alert("标题不能为空"),void 0;if(0==j)return i.alert("请选择客户"),void 0;if(-1==k)return i.alert("请正确填写总金额"),void 0;var A=i.mnGetter($(".contract-discount",f));if(A&&A.length>0&&(l=$(".contract-discount",f).find("input").val()||10),0==m)return i.alert("请填写签约日期"),void 0;if(0==n)return i.alert("请填写开始日期"),void 0;if(0==o)return i.alert("请填写结束日期"),void 0;var B=$(".contract-tags-list-warp > li",f);B.each(function(){var a=$(".f-business-tag-id",$(this)).data("fbusinesstagid"),b=$(".mn-select-box",$(this)),c=i.mnGetter(b)||0;a&&z.push(a+","+c)}),c?i.api({url:"/Contract/UpdateContract",type:"post",dataType:"json",errorMsgTitle:"修改合同发生错误，原因：",data:{contractID:d,title:g,customerID:j,totalAmount:k,beginDate:n,endDate:o,paymentType:y,productDescription:u,customerSigner:r,signerID:q,signDate:m,contractNO:s,content:t,description:v,ownerID:p,discount:l,salesOpportunityID:h,listTagOptionID:z,isSalesStageWin:w,isSetExpectedDealTime:x},success:function(a){a.success&&(b.hide(),i.remind(2,"保存成功"),b.v&&b.v.refresh&&b.v.refresh(),b.trigger("success"))}},{submitSelector:e}):i.api({url:"/Contract/AddContract",type:"post",dataType:"json",errorMsgTitle:"添加合同发生错误，原因：",data:{title:g,customerID:j,totalAmount:k,beginDate:n,endDate:o,paymentType:y,productDescription:u,customerSigner:r,signerID:q,signDate:m,contractNO:s,content:t,description:v,ownerID:p,discount:l,salesOpportunityID:h,listTagOptionID:z,isSalesStageWin:w,isSetExpectedDealTime:x},success:function(a){a.success&&(b.hide(),i.remind(2,"添加成功"),b.v&&b.v.refresh&&b.v.refresh(),b.trigger("success"))}},{submitSelector:e})},setupDoms:function(){var a=this.element;this.conTextareaEl=$(".area-auto-height",a)},fillExitsData:function(){var a=this.get("contractID")||void 0,b=this.get("salesOpportunityID")||void 0,c=this.get("salesOpportunityName")||void 0,d=this.get("customerID")||void 0,e=this.get("customerName")||void 0,f=this.element,g=this;a&&(i.disableCrmBtn($(".contract-opp-name-btn",f)),i.disableCrmBtn($(".contract-customer-name-btn",f)),i.disableCrmBtn($(".contract-ownerID-btn",f))),d&&e&&(i.disableCrmBtn($(".contract-customer-name-btn",f)),$(".contract-customer-name",f).attr("data-id",d).val(e)),b&&d&&(i.disableCrmBtn($(".contract-opp-name-btn",f)),i.disableCrmBtn($(".contract-customer-name-btn",f)),$(".contract-opp-name",f).attr("data-id",b).val(c),$(".contract-customer-name",f).attr("data-id",d).val(e));var h=i.getCurrentEmp();$(".contract-ownerID",f).val(h.name).attr("data-id",h.employeeID),$(".contract-signerID",f).val(h.name).attr("data-id",h.employeeID),setTimeout(function(){g.conTextareaEl.trigger("autosize.resize")},1)},setupComponent:function(){this.get("contractID")||void 0;var a=this.element,b=this;this.fillExitsData(),this.signDate=new k({element:$(".contract-signDate",a),placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）",isCRM:!0}),this.beginDate=new k({element:$(".contract-beginDate",a),placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）",isCRM:!0}),this.endDate=new k({element:$(".contract-endDate",a),placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）",isCRM:!0}),this.totalAmount=new l({element:$(".contract-totalAmount",a)}),i.mnSelect($(".contract-paymentType",a),"syncModel",i.getPayWays()),i.mnEvent($(".contract-discount",a),"change",function(){var b=$(".contract-discount",a).find("input").parent(),c=i.mnGetter($(".contract-discount",a));c&&c[0]?b.hide():b.show()}),$(".contract-discount",a).find("input").bind("change",function(a){var b=$(a.target).val(),c=$(a.target);""!=b&&10!=b&&(/^\d{1}(.[0-9]{0,2})?$/.test(b)||i.alert("请输入正确的折扣",function(){c.val("")}))});var c=$(".contract-tags-list-warp",a);j.AdjustTextAreaSize({element:this.conTextareaEl});var d=i.getTagsByType(i.CONSTANT.TAG_TYPE.CONTRACT);_.each(d,function(a){var b=a.name,d=a.options,e="",f="";d.length>0?_.each(d,function(a){var b=a.isDefault;b?(f=a.name,e+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'" data-selected="'+b+'">'+a.name+"</li></ul>"):e+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'">'+a.name+"</li></ul>"}):e='<ul class="mn-select-list"><li class="mn-select-item" data-value="0"></li></ul>',c.append('<li class="fn-clear"> <div class="selects-tit inputs-tit f-business-tag-id" data-fbusinesstagid="'+a.fBusinessTagID+'"> '+b+' </div> <div class="selects-warp"> <span select-cls="" class="mn-select-box "><span class="mn-select-title-wrapper select-for-dialog"><span class="mn-select-title ">'+f+'</span><span class="title-icon"></span></span>'+e+"</span> </div> </li>")}),setTimeout(function(){b.conTextareaEl.trigger("autosize.resize")},1)},fillFormData:function(){this.get("contractID")?this.get("contractID"):void 0;var a=this.get("contractData")?this.get("contractData").value.hContractEntity[0]:void 0,b=this.element;a&&($(".contract-opp-name-btn",b).attr({disabled:!0}).css("opacity",".5"),$(".contract-customer-name-btn",b).attr({disabled:!0}).css("opacity",".5"),$(".contract-ownerID-btn",b).attr({disabled:!0}).css("opacity",".5"),$(".contract-title",b).val(a.title),$(".contract-opp-name",b).attr("data-id",a.salesOpportunityID).val(a.salesOpportunityName),$(".contract-customer-name",b).attr("data-id",a.customerID).val(a.customerName),this.totalAmount.setValue(a.totalAmount),this.signDate.setValue(1e3*a.signDate),this.beginDate.setValue(1e3*a.beginDate),this.endDate.setValue(1e3*a.endDate),$(".contract-ownerID",b).attr("data-id",a.ownerID).val(a.owner.name),$(".contract-signerID",b).attr("data-id",a.signerID).val(a.signer.name),$(".contract-customerSigner",b).val(a.customerSigner),$(".contract-contractNO",b).val(a.contractNO),$(".contract-content",b).val(a.content),$(".contract-productDescription",b).val(a.productDescription),$(".contract-description",b).val(a.description),i.mnSetter($(".contract-paymentType",b),a.paymentType),10==a.discount?(i.mnSetter($(".contract-discount",b),[!1]),$(".contract-discount",b).find("input").val(10),$(".contract-discount",b).find("input").parent().hide()):(i.mnSetter($(".contract-discount",b),[!0]),$(".contract-discount",b).find("input").val(a.discount),$(".contract-discount",b).find("input").parent().show()),_.map(a.fBusinessTagRelations,function(a){a.fBusinessTagOptionID&&i.mnSetter($("[data-fbusinesstagid="+a.fBusinessTagID+"]",b).next().children(".mn-select-box"),a.fBusinessTagOptionID)}),this.conTextareaEl.trigger("autosize.resize"))},selectOpp:function(){this.selectOppDialog.show()},selectCustomer:function(){this.selectCustomerDialog.show()},selectOwner:function(){this.selectOwnerDialog.show()},selectSigner:function(){this.selectSignerDialog.show()}});c.exports=p});