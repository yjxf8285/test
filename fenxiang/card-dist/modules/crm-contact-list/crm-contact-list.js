/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-contact-list/crm-contact-list",["modules/crm-contact-list/crm-contact-list.html","dialog","util","modules/publish/publish-helper","datatable","moment","modules/crm-object-import/crm-object-import","uilibs/pagination2","modules/crm-select-colleague/crm-select-colleague","modules/crm-contact-edit/crm-contact-edit","modules/crm-contact-export/crm-contact-export"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-contact-list/crm-contact-list.html");a("dialog");var h=a("util");a("modules/publish/publish-helper"),a("datatable");var i=a("moment"),j=a("modules/crm-object-import/crm-object-import"),k=a("uilibs/pagination2");a("modules/crm-select-colleague/crm-select-colleague");var l=a("modules/crm-contact-edit/crm-contact-edit"),m=a("modules/crm-contact-export/crm-contact-export"),n=Backbone.View.extend({tagName:"div",className:"competitor-list-module",template:_.template($(g).filter(".crm-contract-list-template").html()),overwriteRowClick:!1,options:{warpEl:null,url:"",data:{},isLoadServerData:!1,isSetting:!1},events:{"click .crm-datatable th":"_crmTableSort","click .create-contract-btn":"_createContract","click .delete-contract-btn":"_deleteContract","click .create-sharetome-btn":"_createAllShareTome","click .remove-sharetome-btn":"_removeAllShareTome","click .contract-import-btn":"_contractImport","click .contract-export-btn":"_contractExport","click .checkbox-selectall-btn":"_checkboxSelectall"},_crmTableSort:function(a){var b=this,c=$(a.target).css("cursor");"col-resize"!=c&&h.crmTableSortSet({element:$(".sort-select-list",this.$el),meEl:$(a.currentTarget),oThs:[{clasName:".crmtable-sort-name",sortType:[2,4]},{clasName:".crmtable-sort-post",sortType:[5,6]},{clasName:".crmtable-sort-department",sortType:[7,8]},{clasName:".crmtable-sort-company",sortType:[9,10]},{clasName:".crmtable-sort-upatetime",sortType:[11,12]}],callback:function(a){b.refresh(a)}})},_removeAllShareTome:function(){var a=this;h.confirm("是否清空全部共享记录","",function(){h.api({url:"/Contact/DeleteShareContactMessageAll",type:"post",dataType:"json",data:{},success:function(b){b.success&&a.refresh()}})})},_createAllShareTome:function(){for(var a=this,b=0,c=a.responseData.value.shareContactDetails,d=0,e=c.length;e>d;d++)c[d].isCreated||b++;h.confirm("共有"+b+"条共享没有创建，您确定要批量创建吗？","",function(){h.api({url:"/Contact/CopyContactsUnCreated",type:"post",dataType:"json",data:{},success:function(b){b.success&&a.refresh()}})})},_contractImport:function(){this.importDialog.show()},_contractExport:function(){this.exportDialog.show(this.options.data)},_followSwitch:function(a){a.stopPropagation();var b=$(a.target),c=b.parents("tr").children().eq(0).find("span").attr("data-value");b.hasClass("customers-following")?h.api({url:"/Contact/ContactCancelFollow",type:"post",dataType:"json",data:{contractID:c},success:function(a){a.success&&b.removeClass("customers-following").addClass("customers-nofollow")}}):h.api({url:"/Contact/ContactFollow",type:"post",dataType:"json",data:{contractID:c},success:function(a){a.success&&b.removeClass("customers-nofollow").addClass("customers-following")}})},_createContract:function(){this.createDialog.show()},_deleteContract:function(){var a=this,b=this.$el.find(".crm-table-bd .crm-datatable tbody"),c=$(".checkbox-for-comtable .mn-checkbox-item",b),d=[];c.each(function(){$(this).is(".mn-selected")&&d.push($(this).data("value"))}),d.length>0?h.confirm("你确定要删除选中的"+d.length+"个联系人吗？","",function(){h.api({url:"/Contact/DeleteContacts",type:"post",dataType:"json",data:{contactIDs:d},success:function(b){if(b.success){var c=b.value.result,d="",e="",f=0,g=0;_.each(c,function(b){var c=b.value,d=b.value1,h=b.value2,i="";_.each(a.products,function(a){a.salesOpportunityID===c&&(i=a.name)}),d?f++:(e+=i+"删除失败，原因："+h+"</br>",g++)}),d+=e+"本次操作有"+f+"个成功，"+g+"个失败",h.alert(d,function(){$(".checkbox-selectall-btn .mn-checkbox-item").removeClass("mn-selected"),a.refresh()})}}})}):h.alert("请选择要删除的联系人")},_getProductTagsDatas:function(){var a=h.getCrmData(),b=a.functionPermissions,c=h.getTagsByType(9),d=[],e=this,f=a.isAllowExportData,g=[{text:"不限",value:0}],i=[{text:"不限",value:0}];_.each(c,function(a){d.push(a),109===a.systemTagCode&&(_.each(a.options,function(a){i.push({text:a.name,value:a.fBusinessTagOptionID})}),e.marketingEventTypeFBusinessTagID=a.fBusinessTagID)}),_.extend(this,{allCompetitorTags:d,competitorscale:g,competitiveness:i,isAllowExportData:f,functionPermissions:b})},initialize:function(){this._getProductTagsDatas();var a=this;this.importDialog=new j({title:"我的联系人导入",downloadApi:"GetMyContactExcelTemplate",importApi:"/Contact/ImportMyContact",downloadText:"我的联系人导入模板"}),this.importDialog.on("uploaded",function(){a.refresh()}),this.exportDialog=new m({type:"list"}),this.createDialog=new l,this.createDialog.v=this,this.render()},render:function(){var a=this.$el,b=this.template;return a.html(b({value:{employees:{}}})),this.options.warpEl.html(a),this.setDataTabel(),this.setupComponent(),this.showFnBtn(),this},showFnBtn:function(){var a=this.$el,b=$(".contract-export-btn",a),c=this.isAllowExportData;c?b.show():b.hide()},setupComponent:function(){var a=this.$el,b=this,c=$(".pagination-wrapper",a),d=$(".states-select-list",a),e=$(".sort-select-list",a);h.mnEvent(e,"change",function(a){h.mnSelect(e,"removeOption",2),$("th",b.oTable).removeClass("sorting_asc").removeClass("sorting_desc"),b.refresh({sortType:a})}),this.pagination=new k({element:c,pageSize:this.options.data.pageSize,totalSize:0,activePageNumber:1}),this.options.isSetting&&(h.mnSelect(d,"addOption",{text:"已删除客户",value:"2"}),h.mnSetter(d,-1)),h.mnEvent(d,"change",function(a){b.options.isSetting?2==a?(b.options.data.createCustomer=-1,b.options.data.isDeleted=1):(b.options.data.createCustomer=a,b.options.data.isDeleted=0):(b.options.data.createCustomer=a,delete b.options.data.isDeleted),b.options.data.pageNumber=1,b.refresh()}),this.pagination.on("page",function(a){b.options.data.pageNumber=a,b.refresh()}),a.on("click",".crm-datatable tbody tr td",function(){var c=$(this).closest("tr"),d=b.oTable.fnGetData(c.get(0)),e=d.contactID,g=window.location.href.split("#")[1];g=g.split("/=/")[0];var i={id:e};if(i=_.extend({},h.getTplQueryParams2(),i),i.returnUrl=g+"/=/param-"+encodeURIComponent(JSON.stringify(i)),!$(this).is(".td-checkbox-warp")){if($(".crm-datatable tbody tr",a).removeClass("row_selected"),c.addClass("row_selected"),b.options.overwriteRowClick)return b.trigger("rowClick",e),void 0;f.navRouter.navigate("#contacts/showcontact/=/param-"+encodeURIComponent(JSON.stringify(i)),{trigger:!0}),f.event.one("dataUpdate",function(){b.options.ID=e,b.refresh()})}})},load:function(){this.options.isLoadServerData=!0},refresh:function(a){a&&_.extend(this.options.data,a),this.pagination.jump(this.options.data.pageNumber,!0),this.oTable.fnReloadAjax()},reSetMnselect:function(){var a=this.$el;h.mnSelect($(".states-select-list",a),"syncModel",[{text:"不限",value:-1},{text:"已关联客户",value:1},{text:"未关联客户",value:0}]),h.mnSelect($(".sort-select-list",a),"syncModel",[{text:"发生变化的在最前面",value:12},{text:"按名称排序",value:2}]),this.pagination.jump(1,!0)},setDataTabel:function(){var a=this,b=this.$el,c=b.find(".crm-table-bd .crm-datatable");this.oTable=c.dataTable({sDom:"Rlfrtip",aoColumns:[{mData:"contactID",sWidth:"26px",sClass:"td-checkbox-warp",bSortable:!1,mRender:function(a){var b='<div class="mn-checkbox-box checkbox-for-comtable">&nbsp;&nbsp;<span data-value="'+a+'" class="mn-checkbox-item"></span> </div>';return b}},{mData:"post",sWidth:"150px",sClass:"black-name crmtable-sort-name",bSortable:!0,mRender:function(a,b,c){var d=c.name||c.contactName,e=c.isDeleted||!1,f="",g="[已删除] ",h="is-del",i=c.isShowBirthDay,j='<span class="birthday-ico"></span>';return e?(g="[已删除] ",h="is-del",f=i?'<span title="'+d+'" style="color:#999;">'+g+d+"</span>"+j:'<span title="'+d+'" style="color:#999;">'+g+d+"</span>"):(g="",h="",f=i?'<span title="'+d+'">'+d+"</span>"+j:'<span title="'+d+'">'+d+"</span>"),f}},{mData:"firstContactWay",sWidth:"180px",sClass:"",bSortable:!1,mRender:function(a){var b=a.typeDesc,c=a.content;c&&(c="："+c);var d='<span title="'+b+c+'">'+b+c+"</span>";return d}},{mData:"post",sWidth:"90px",sClass:"crmtable-sort-post",bSortable:!0,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"department",sWidth:"90px",sClass:"crmtable-sort-department",bSortable:!0,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"company",sWidth:"70px",sClass:"crmtable-sort-company",bSortable:!0,mRender:function(a,b,c){var d=a,e=c.customerID,f="",g=c.customerName;e>0&&(d=g,f="iscontact-yes");var h='<span title="'+d+'" class="'+f+'">'+d+"</span>";return h}},{mData:"followTime",sWidth:"120px",sClass:"crmtable-sort-upatetime",bSortable:!0,mRender:function(a,b,c){var d=c.upatetime||c.shareTime,e='<span title="'+i.unix(d).format("YYYY-MM-DD")+'">'+i.unix(d).format("YYYY-MM-DD")+"</span>";return e}},{mData:"followTime",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}],sAjaxSource:this.options.url,fnServerData:function(b,c,d,e){if(a.options.isLoadServerData){var f=a.options.data;e.jqXHR=h.api({dataType:"json",type:"get",url:b,data:f,beforeSend:function(){h.showGlobalLoading(1)},success:function(b){var c=b.value.totalCount;h.hideGlobalLoading(1),a.responseData=b,a.products=b.value.products,d(a._formatTableData(b)),a.pagination.setTotalSize(c),a.options.ID&&$("[data-value="+a.options.ID+"]").closest("tr").addClass("row_selected"),$(".checkbox-for-comtable .mn-checkbox-item",a.$el).removeClass("mn-selected"),$("tbody tr",a.oTable).each(function(){var a=this;h.mnEvent($(this).find(".mn-checkbox-box"),"change",function(b){0==b.length?$(a).addClass("row_selected"):$(a).removeClass("row_selected")})}),c?($(".count-text").show(),$(".count-num").text(c)):$(".count-text").hide(),a.trigger("loadSuccess",b)}})}},bAutoWidth:!1,bFilter:!1,bPaginate:!1,bInfo:!1,bSort:!1,oLanguage:{sEmptyTable:'<span class="empty-tip">没有获取到联系人</span>'}})},_formatTableData:function(a){var b=[],c=a.value,d=c.contacts||c.shareContactDetails;return _.each(d,function(a){b.push(_.extend({isDir:!0,followTime:0,attachSize:0},a))}),{aaData:b}},_checkboxSelectall:function(a){var b=$(a.currentTarget),c=this.$el.find(".crm-table-bd .crm-datatable tbody"),d=$(".checkbox-for-comtable",c),e=d.find(".mn-checkbox-item");b.is(".mn-selected")?(e.removeClass("mn-selected"),$("tbody tr",this.oTable).removeClass("row_selected")):(e.addClass("mn-selected"),$("tbody tr",this.oTable).addClass("row_selected"))},destroy:function(){this.remove()}});c.exports=n});