/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/fs-worktodo/worktodo-list",["util","modules/feed-list/feed-list-v","modules/feed-list/feed-list-m","modules/feed-list/feed-list-c","./fs-worktodo.html","uilibs/pagination","modules/fs-createremind/fs-todoremind","dialog","spin","moment","modules/publish/publish"],function(a,b,c){var d=window,e=d.FS;e.tpl;var f=a("util"),g=a("modules/feed-list/feed-list-v"),h=a("modules/feed-list/feed-list-m"),i=a("modules/feed-list/feed-list-c"),j=a("./fs-worktodo.html"),k=a("uilibs/pagination"),l=a("modules/fs-createremind/fs-todoremind"),m=a("dialog"),n=(a("spin"),a("moment")),o=a("modules/publish/publish"),p=g.itemV,q=h.itemM,r=i.listC,s=$(j),t=_.template(s.filter(".fs-worktodo-item-wrapper").html()),u=s.filter(".fs-worktodo-modify-wrapper").html(),v=new r,w=f.getContactData(),x=w.u,y=o.atInput;f.tplRouterReg("#worktodo/tododetail/=/:id-:value");var z=new l,A=m.extend({attrs:{content:u,className:"fs-worktodo-modify-dialog",successCb:e.EMPTY_FN},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel"},setup:function(){var a,b=this.element;return this.after("show",function(){a=$(".worktodo-title",b),a.trigger("autosize.resize")}),A.superclass.setup.apply(this,arguments)},render:function(){var a=A.superclass.render.apply(this,arguments);return this._renderCpt(),a},_renderCpt:function(){var a=this.element,b=$(".worktodo-title",a),c=new y({element:b});this.atInput=c},showWithStore:function(a){var b=this.element,c=$(".worktodo-title",b),d=$(".is-important",b);this.store=a,c.val(a.title).trigger("autosize.resize"),a.isImportant?d.prop("checked",!0):d.prop("checked",!1),this.show()},isValid:function(){var a=!0,b=this.getRequestData(),c=this.element,d=$(".worktodo-title",c);return 0==b.title.length&&(f.showInputError(d),a=!1),b.title.length>1e3&&(f.alert("内容不超过1000字"),a=!1),a},getRequestData:function(){var a={},b=this.store,c=this.element,d=$(".worktodo-title",c),e=$(".is-important",c);return a.workToDoListID=b.workToDoListID,a.title=_.str.trim(d.val()),a.isImportant=e.prop("checked"),a},clearForm:function(){var a=this.element,b=$(".worktodo-title",a),c=$(".is-important",a);b.val("").trigger("autosize.resize"),c.prop("checked",!1)},_submit:function(a){var b=this,c=this.getRequestData();this.isValid()&&f.api({type:"post",data:c,url:"/worktodolist/modifyWorkToDoList",success:function(a){a.success&&(b.hide(),b.get("successCb").call(b,a,c))}}),a.preventDefault()},_cancel:function(a){this.clearForm(),this.hide(),a.preventDefault()},destroy:function(){var a;return this.atInput&&this.atInput.destroy(),a=A.superclass.destroy.apply(this,arguments)}}),B=(new A).render(),C=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:45,totalSize:0,visiblePageNums:7},listPath:"/worktodolist/getWorkToDoLists",defaultRequestData:{},searchOpts:{inputSelector:null,btnSelector:null},listEmptyText:"暂无记录"},a||{}),this.opts=a,this.element=$(a.element),this._initPagination(),this.pagination=null,this.tempRequestData={},this.init()};_.extend(C.prototype,{_initPagination:function(){var a=this.opts;a.pagSelector===!1?(this.pagEl=$('<div class="feed-list-pagination"></div>').appendTo(this.element),this.pagEl.hide(),a.pagOpts.pageSize=1e4):this.pagEl=$(a.pagSelector)},init:function(){var a=this,b=this.opts,c=this.element;this.list,c.addClass("fs-worktodo-list").html('<div class="fs-worktodo-list-inner"></div>'),this.pagination=new k(_.extend({element:this.pagEl},b.pagOpts)),this.pagination.on("page",function(){a.empty(),a.fetch()}),this.pagination.render(),b.searchOpts&&b.searchOpts.inputSelector&&this._searchBarInit(),this._initListEmptyTip(),this._regEvents()},_searchBarInit:function(){var a,b=this,c=this.opts,d=c.searchOpts,e=this.element,f=$(d.inputSelector),g=$(d.btnSelector);a=$('<div class="list-search-bar fn-clear"></div>'),a.html('<span class="result-info fn-left">共搜索到<span class="num color-red">0</span>条信息</span><a class="back-l fn-right" href="#" title="返回查看全部"><< 返回查看全部</a>'),a.hide().prependTo(e);var h=$('<span class="empty-h">&#10005;</span>'),i=$('<span class="list-search-input-wrapper"></span>');f.wrap(i),i=f.closest(".list-search-input-wrapper"),h.hide().appendTo(i),f.keydown(function(a){13==a.keyCode&&g.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(h.show(),f.addClass("with-input-value")):(h.hide(),f.removeClass("with-input-value"))}),h.click(function(){f.val(""),f.removeClass("with-input-value"),h.hide()}),a.on("click",".back-l",function(c){var d=$(".list-empty-tip",e);b.reload({keyword:""}),f.val(""),f.removeClass("with-input-value"),h.hide(),a.hide(),d.hide(),c.preventDefault()})},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".num",d);return a.keyword.length>0&&b.success?(e.text(b.value.totalCount),d.show(),void 0):(d.hide(),void 0)},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+e.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.appendTo(a)},_updatelistStatus:function(a){var b,c=this.element,d=$(".list-empty-tip",c);a.success&&(b=a.value.totalCount,0==b?d.show():d.hide())},_regEvents:function(){var a=this,b=this.element;b.on("click",".mark-l",function(b){var c=$(b.currentTarget),d=c.closest(".fs-worktodo-item"),e=$(".is-complete",d),f=e.next(),g=$(".mark-l",d),h=d.data("store");e.prop("checked")?a.setIsCompleted(!1,h.workToDoListID,function(){g.text("标记为已完成"),f.text("未完成"),e.prop("checked",!1)},c):a.setIsCompleted(!0,h.workToDoListID,function(){g.text("标记为未完成"),f.text("已完成"),e.prop("checked",!0)},c),b.preventDefault()}).on("change",".is-complete",function(b){var c=$(b.currentTarget),d=c.closest(".fs-worktodo-item"),e=$(".is-complete",d),f=e.next(),g=$(".mark-l",d),h=d.data("store");e.prop("checked")?a.setIsCompleted(!0,h.workToDoListID,function(){g.text("标记为未完成"),f.text("已完成")},c.closest(".label-for")):a.setIsCompleted(!1,h.workToDoListID,function(){g.text("标记为已完成"),f.text("未完成")},c.closest(".label-for"))}).on("mouseenter",".tbar-l",function(a){var b=$(a.currentTarget),c=$(a.currentTarget).find(".is-complete");c.prop("checked")?b.attr("title","点击设置为未完成"):b.attr("title","点击设置为已完成")}),b.on("click",".del-l-parent",function(a){var b=$(a.currentTarget),c=(b.closest(".fs-worktodo-item"),b.closest(".fs-worktodo-item-actions")),d=$(".cancelmenu",c),e=$(".cancelmenu-box",d);return d.show(),e.animate({top:"0"},400),!1}),b.on("click",".f-cancel",function(a){var b=$(a.currentTarget),c=b.closest(".fs-worktodo-item"),d=$(".cancelmenu",c),e=$(".cancelmenu-box",d);return e.animate({top:"120"},400),!1}),b.on("click",".del-l",function(b){var c=$(b.currentTarget),d=c.closest(".fs-worktodo-item"),e=d.data("store");f.api({type:"post",data:{workToDoListID:e.workToDoListID},url:"/worktodolist/deleteWorkToDoList",success:function(b){b.success&&(a.removeItemEl(d),location.href="#worktodo")}},{submitSelector:c}),b.preventDefault()}),b.on("click",".edit-l",function(b){var c=$(b.currentTarget),d=c.closest(".fs-worktodo-item");$(".fs-worktodo-item-title",d);var e=d.data("store");B.showWithStore(e),B.set("successCb",function(b,c){b.success&&a.updateItem(c.workToDoListID)}),b.preventDefault()}),b.on("click",".aj-remind-btn",function(a){var b=$(a.currentTarget),c=b.closest(".fs-worktodo-item"),d=c.data("store");z.show({workToDoListID:d.workToDoListID}),a.preventDefault()})},setIsCompleted:function(a,b,c,d){var e=this;f.api({type:"post",data:{workToDoListID:b,isCompleted:a},url:"/worktodolist/setIsCompleted",success:function(a){a.success&&c.call(e,a)}},{mask:$(d)})},_createFeedV:function(a,b){var c=$(a),d=$(".fs-worktodo-item-content",c),e=c.data("store"),f=v.parse({success:!0,value:{items:[e.feed]},serviceTime:b}),g=new p({model:new q(f[0]),withAvatar:!1,withActionBtn:!1,detailStyle:1,scheduleStyle:1}).render(),h=g.$el;d.append(h);var i=$(".feed-content-visible-h",h);i.length>0&&(i.click(),i.hide())},_createItem:function(a,b,c){var d,e,g,h=this.element,i=$(".fs-worktodo-list-inner",h);return d=t({workToDoListID:a.workToDoListID,feedID:a.feedID,isCompleted:a.isCompleted,isImportant:a.isImportant,title:a.title.replace(/\n/g,"<br/>"),createTime:f.getDateSummaryDesc(n.unix(a.createTime),n.unix(b),1),isBelongToMe:x.id==a.creatorID?!0:!1,creatorID:a.creatorID,creatorName:a.creatorName}),e=$(d),g=_.find(c,function(b){return b.feedID==a.feedID}),a.feed=g,e.data("store",a).appendTo(i),g&&this._createFeedV(e,b),e},prependNewTask:function(a){var b=this,c=this.element,d=$(".fs-worktodo-list-inner",c);this.showLoading(),f.api({type:"get",data:{workToDoListID:a},url:"/worktodolist/getWorkToDoListByID",success:function(a){var c,e;a.success&&(c=a.value.items,e=a.value.feeds.items,_.each(c,function(c){var f=b._createItem(c,a.serviceTime,e);f.prependTo(d)}),b.pagination.setTotalSize(b.pagination.get("totalSize")+1),b.hideLoading())}})},updateItem:function(a){var b,c=this,d=this.element,e=$(".fs-worktodo-list-inner",d);$(".fs-worktodo-item",e).each(function(){var c=$(this);return c.data("store").workToDoListID==a?(b=c,!1):void 0}),b&&f.api({type:"get",data:{workToDoListID:a},url:"/worktodolist/getWorkToDoListByID",success:function(a){var d,e;a.success&&(d=a.value.items,e=a.value.feeds.items,_.each(d,function(d){var f=c._createItem(d,a.serviceTime,e);f.insertAfter(b),b.remove()}))}})},hlKeyword:function(a){var b,c=this.element;a.length>0&&(b=$(".fs-worktodo-item-title",c),b.each(function(){var b=$(this),c=b.text();b.html(c.replace(new RegExp(a,"g"),'<span class="state-keyword-hl">'+a+"</span>"))}))},fetch:function(){var a=this,b={},c=this.opts,d=this.pagination,e=this.element,g=$(".fs-worktodo-list-inner",e);b=_.extend({pageSize:d.get("pageSize"),pageNumber:d.get("activePageNumber")},b||{}),b=_.isFunction(c.defaultRequestData)?_.extend(c.defaultRequestData(),b):_.extend(c.defaultRequestData,b),b=_.extend({isImportant:"0",isCompleted:"0",keyword:"",pageSize:d.get("pageSize"),pageNumber:d.get("activePageNumber")},b,this.tempRequestData),this.tempRequestData={},this.showLoading(),f.api({type:"get",data:b,url:c.listPath,success:function(c){var d,e,f;c.success&&(d=c.value,e=d.items,f=d.feeds.items,_.each(e,function(b){var d=a._createItem(b,c.serviceTime,f);d.appendTo(g)}),a.hlKeyword(b.keyword),a.pagination.setTotalSize(d.totalCount),a._updateSearchBarState(b,c),a._updatelistStatus(c)),a.hideLoading()}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a){this.tempRequestData=a,this.pagination.jump(1)},reload:function(a){this.load(a)},removeItemEl:function(a){var b=$(a),c=b.data("feedV");c&&c.destroy&&c.destroy(),b.removeData(),b.remove()},empty:function(){var a=$(".fs-worktodo-list-inner",this.element),b=$(".fs-worktodo-item",a);b.each(function(){var a=$(this),b=a.data("feedV");b&&b.destroy&&b.destroy(),a.removeData()}),a.empty()},destroy:function(){this.pagination.destroy(),this.loading&&this.loading.stop(),this.empty(),this.pagination=null,this.tempRequestData={},this.element=null}}),c.exports=C});