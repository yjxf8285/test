/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/fs-like/fs-like",["util","uilibs/pagination","moment","./fs-like.html","./fs-like.css"],function(a,b,c){var d=window,e=d.FS;e.tpl;var f=a("util"),g=a("uilibs/pagination"),h=a("moment"),i=a("./fs-like.html");a("./fs-like.css");var j=f.getContactData(),k=j.u;i=$(i);var l=Backbone.Model.extend({}),m=Backbone.Collection.extend({model:l,sync:function(a,b,c){var d=c.data||{};c.data=_.extend({pageSize:10,pageNumber:1},d),Backbone.sync("read",b,c)},parse:function(a){a.value.items;var b,c,d;return a.success?(b=f.deepClone(a.value.feedLikes),_.each(b,function(b){var e=b.likeType||1;b.sendername=b.employee&&b.employee.name||"已删除用户",b.profileImage=f.getAvatarLink(b.employee&&b.employee.profileImage,2),b.employeeID=b.employee&&b.employee.employeeID,b.feedSenderName='<a href="Index#profile/=/empid-'+b.feedSender.employeeID+'">'+b.feedSender.name+"</a>",b.feedemployeeID=b.feedSender.employeeID,k.employeeID==b.feedemployeeID&&(b.feedSenderName="我"),k.employeeID==b.employeeID&&(b.sendername="我"),2==e?(c="回复",d="回复",k.employeeID==b.feedReplySender.employeeID?(b.feedReplySender.name="我",b.feedSenderName=b.feedReplySender.name):b.feedSenderName='<a href="Index#profile/=/empid-'+b.feedReplySender.employeeID+'">'+b.feedReplySender.name+"</a>"):(c=f.getFeedTypeName(b.feedType),d="工作"),b.feedTypeDescription=c,b.feedTypeDescriptionTop=d,b.likeTime=b.likeTime,b.likeTime=f.getDateSummaryDesc(h.unix(b.likeTime),h.unix(a.serviceTime),2),b.sourceDescription="，来自"+b.sourceDescription||"",1==b.source&&(b.sourceDescription="")})):b=[],b}}),n=Backbone.View.extend({tagName:"div",className:"fs-likelist-item card-border-rad",initialize:function(){var a=i.filter(".fs-likelist-send-item-tpl").html();this.template=_.template(a),this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),o=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:20,visiblePageNums:7},listPath:"/attach_html/getAttachImgFilesOfIReceive",defaultRequestData:{},searchOpts:{inputSelector:null,btnSelector:null},listCb:e.EMPTY_FN,listEmptyText:"暂无记录"},a||{}),this.opts=a,this.element=$(a.element),this.pagEl=$(a.pagSelector),this.pagination=null,this.tempRequestData={},this.init()};_.extend(o.prototype,{init:function(){var a,b=this,c=this.opts,d=this.element;a=new m,a.on("add",function(a){var b;b=new n({model:a}).render(),b.$el.data("itemV",b).appendTo(d)}),this.list=a,a.opts=c,this.pagination=new g(_.extend({element:this.pagEl},c.pagOpts)),this.pagination.on("page",function(){b.empty(),b.fetch()}),this.pagination.render(),c.searchOpts&&c.searchOpts.inputSelector,this._initListEmptyTip()},_searchBarInit:function(){var a,b=this,c=this.opts,d=c.searchOpts,e=this.element,f=$(d.inputSelector),g=$(d.btnSelector);a=$('<div class="list-search-bar fn-clear"></div>'),a.html('<span class="result-info fn-left">共搜索到<span class="num color-red">0</span>条信息</span><a class="back-l fn-right" href="#" title="返回查看全部"><< 返回查看全部</a>'),a.hide().prependTo(e);var h=$('<span class="empty-h">x</span>'),i=$('<span class="list-search-input-wrapper"></span>');f.wrap(i),i=f.closest(".list-search-input-wrapper"),h.hide().appendTo(i),f.keydown(function(a){13==a.keyCode&&g.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(h.show(),f.addClass("with-input-value")):(h.hide(),f.removeClass("with-input-value"))}),h.click(function(){f.val(""),f.removeClass("with-input-value"),h.hide()}),a.on("click",".back-l",function(a){b.reload({keyword:""}),f.val(""),f.removeClass("with-input-value"),h.hide(),a.preventDefault()})},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".num",d);return!a.isFirstChar&&a.keyword.length>0&&b.success?(e.text(b.value.totalCount),d.show(),void 0):(d.hide(),void 0)},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+e.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.appendTo(a)},_updatelistStatus:function(a){var b,c=this.element,d=$(".list-empty-tip",c);a.success&&(b=a.value.totalCount,0==b?d.show():d.hide())},fetch:function(){var a=this,b=this.opts;this.list;var c=this.pagination,d=_.extend({pageSize:c.get("pageSize"),pageNumber:c.get("activePageNumber"),sinceID:0,maxID:0});d=_.isFunction(b.defaultRequestData)?_.extend(b.defaultRequestData(),d):_.extend(b.defaultRequestData,d),d=_.extend(d,this.tempRequestData),this.tempRequestData={},this.showLoading(),this.list.fetch({url:b.listPath,data:d,success:function(d,e){var f;e.success&&(f=e.value,c.setTotalSize(f.totalCount),a._updatelistStatus(e),b.listCb.call(a,e),a.hideLoading())}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a){this.tempRequestData=a,this.pagination.jump(1)},reload:function(a){this.load(a)},empty:function(){var a=this.element,b=$(".fs-likelist-item",a);b.each(function(){var a=$(this),b=a.data("itemV");b.remove(),a.removeData()}),a.empty()},destroy:function(){this.list=null,this.pagination.destroy(),this.loading&&this.loading.stop(),this.empty(),this.pagination=null,this.tempRequestData={},this.element=null}}),c.exports=o});