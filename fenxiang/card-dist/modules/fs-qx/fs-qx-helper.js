/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/fs-qx/fs-qx-helper",["modules/fs-qx/fs-qx.html","dialog","events","util","filter","h5uploader","flashuploader"],function(a,b){var c=window,d=c.FS;d.tpl;var e=a("modules/fs-qx/fs-qx.html"),f=a("dialog"),g=a("events"),h=a("util"),i=a("filter"),j=a("h5uploader"),k=a("flashuploader"),l=$(e),m=i.stringMatch,n=i.startsWith,o=0,p=function(a){a=_.extend({element:null,h5Opts:null,flashOpts:null,h5UploadPath:"/File/UploadFile",flashUploadPath:"/File/UploadFileByForm",onSelect:d.EMPTY_FN,onDelete:d.EMPTY_FN,onProgress:d.EMPTY_FN,onSuccess:d.EMPTY_FN,onFailure:d.EMPTY_FN,onComplete:d.EMPTY_FN,onFileNotFound:function(){$(".submit-modal").hide(),h.alert("网络不佳或不可用，附件上传失败")}},a||{}),this.element=$(a.element),this.opts=a,this.core=null,this.coreType="h5",this.init()};_.extend(p.prototype,{init:function(){var a,b,c=this,e=this.opts,f=this.element,g=new j(_.extend({multiple:!1,accept:"*/*",fileInput:f.get(0),url:e.h5UploadPath,onSelect:function(a){_.each(a,function(a){return e.onSelect.call(c,a)})},onProgress:function(a,b,d){return e.onProgress.call(c,a,b,d)},onSuccess:function(a,b){return e.onSuccess.call(c,a,b)},onFailure:function(a){return e.onFailure.call(c,a)},onFileNotFound:function(a){return e.onFileNotFound.call(c,a)},onComplete:function(){return e.onComplete.call(c)}},e.h5Opts||{}));g.isSupport()||(a=f.parent(),b="fs-qx-flash-uploader-"+o,o++,a.html('<span id="'+b+'"></span>'),g=new k(_.extend({upload_url:d.API_PATH+e.flashUploadPath,file_types:"*.*",file_types_description:"All Files",button_placeholder_id:b,button_text:"",file_queued_handler:function(a){return e.onSelect.call(c,a)},file_dialog_complete_handler:d.EMPTY_FN,upload_progress_handler:function(a,b,d){return e.onProgress.call(c,a,b,d)},upload_error_handler:function(a){return e.onFailure.call(c,a)},upload_success_handler:function(a,b){return e.onSuccess.call(c,a,b)},upload_complete_handler:function(){return e.onComplete.call(c)}},e.flashOpts)),this.element=a,this.coreType="flash"),this.core=g},removeFile:function(a){var b=this.opts,c=this.core;"h5"==this.coreType?c.removeFile(a):"flash"==this.coreType&&c.core.cancelUpload(a,!1),b.onDelete.call(this,a)},removeAllFile:function(){this.core.removeAllFile()},startUpload:function(){var a=this.core;"h5"==this.coreType?a.startUpload():"flash"==this.coreType&&a.core.startUpload()},setDisable:function(a){var b=this.element,c=b.parent(),d=this.core;a=!!a,"h5"==this.coreType?a?(b.prop("disabled",!0).addClass("state-disabled"),c.addClass("state-disabled-wrapper")):(b.prop("disabled",!1).removeClass("state-disabled"),c.removeClass("state-disabled-wrapper")):"flash"==this.coreType&&(d.core.setButtonDisabled(a),a?b.addClass("state-disabled-wrapper"):b.removeClass("state-disabled-wrapper"))},destroy:function(){this.core.destroy&&this.core.destroy()}});var q=function(a){a=_.extend({element:null,cls:""},a||{}),this.opts=a,this.element=$(a.element),this.init()};_.extend(q.prototype,{init:function(){var a,b,c=this,d=this.opts,e=this.element;e.addClass("fs-qx-query "+d.cls),h.placeholder(e),e.width(e.width()-32-5),e.wrap('<span class="fs-qx-query-wrapper" />'),a=e.closest(".fs-qx-query-wrapper"),$('<span class="icon-query"></span>').appendTo(a),$('<span class="icon-empty">&#10005;</span>').appendTo(a),b=$(".icon-empty",a),a.on("click",".icon-empty",function(){e.val("").keyup(),b.hide()}).on("keyup",".fs-qx-query",function(a){var d=_.str.trim(e.val());38!=a.keyCode&&40!=a.keyCode&&(d.length>0?b.show():b.hide(),c.trigger("query",d))}).on("keydown",".fs-qx-query",function(a){38==a.keyCode?c.trigger("keynav","up"):40==a.keyCode?c.trigger("keynav","down"):13==a.keyCode&&(c.trigger("submit",a),a.preventDefault())})},getQuery:function(){return _.str.trim(this.element.val())},reset:function(){var a=this.element,b=a.closest(".fs-qx-query-wrapper"),c=$(".icon-empty",b);c.click()},destroy:function(){var a=this.element,b=a.closest(".fs-qx-query-wrappe");$(".icon-query,.icon-empty",b).remove(),b.off(),a.unwrap(),a.width(a.width()+32+5),this.element=null}}),g.mixTo(q);var r=function(a){a=_.extend({clickUnselect:!0,singleSelect:!1,element:null,cls:"",data:[],emptyTip:"记录为空",filterEmptyTip:"没有筛选条件为{{keyword}}的记录"},a||{}),this.opts=a,this.element=$(a.element),this.data=h.deepClone(a.data),this.init()};_.extend(r.prototype,{init:function(){this._createList(),this._bindEvents()},_bindEvents:function(){var a=this,b=this.opts,c=b.clickUnselect,d=this.element;d.on("click",".letter-group-list .value-item",function(){var b=$(this),d=b.attr("itemid");c&&b.hasClass("state-selected")?a.unselectItem(d):a.selectItem(d)}).on("mouseenter",".letter-group-list .value-item",function(){var a=$(this);a.addClass("state-hover")}).on("mouseleave",".letter-group-list .value-item",function(){var a=$(this);a.removeClass("state-hover")})},_createList:function(a){var b=this.opts,c=b.emptyTip,d=this._formatData(a||this.data),e=d.keys,f=d.values,g=this.element,h="";_.each(e,function(a){var b=f[a],c=b.length,d="";h+='<li class="group-key-item" letter="'+a+'"><div class="index-box fn-clear"><div class="index-keyword fn-left">'+a+'</div><div class="item-length fn-right">'+c+'项</div></div><ul class="value-view">',_.each(b,function(a){d+='<li class="value-item" itemid="'+a.id+'">'+a.name+"</li>"}),h+=d+"</ul></li>"}),0==h.length?g.html('<div class="empty-tip">'+c+"</div>"):g.html('<ul class="letter-group-list">'+h+"</ul>"),b.cls&&$(".letter-group-list",g).addClass(b.cls)},_formatData:function(a){var b={};return b.values=_.groupBy(a,function(a){return a.spell.slice(0,1).toUpperCase()}),b.keys=_.sortBy(_.keys(b.values),function(a){return a}),b},getItemDataById:function(a){var b,c=this.data;return b=_.find(c,function(b){return b.id==a})},selectItem:function(a,b){var c=this.opts,d=c.singleSelect,e=this.element,f=$(".letter-group-list",e),g=$('[itemid="'+a+'"]',f),h=this.getItemDataById(a);d&&this.unselectAllItem(!0),g.length>0&&(g.hasClass("state-selected")||(g.addClass("state-selected"),!b&&this.trigger("select",h,g)))},unselectItem:function(a,b){var c=this.element,d=$(".letter-group-list",c),e=$('[itemid="'+a+'"]',d),f=this.getItemDataById(a);e.length>0&&e.hasClass("state-selected")&&(e.removeClass("state-selected"),!b&&this.trigger("unselect",f,e))},selectAllItem:function(a){var b=this,c=this.data;_.each(c,function(c){b.selectItem(c.id,a)})},unselectAllItem:function(a){var b=this,c=this.data;_.each(c,function(c){b.unselectItem(c.id,a)})},removeItem:function(a,b){var c=this.element,d=$(".letter-group-list",c),e=$('[itemid="'+a+'"]',d),f=this.data,g=this.getItemDataById(a);e.length>0&&(f=_.filter(f,function(b){return b.id!=a}),this.data=f,this._createList(),!b&&this.trigger("remove",g,e))},addItem:function(a,b){var c=this.element,d=$(".letter-group-list",c),e=$('[itemid="'+a.id+'"]',d),f=this.data;0==e.length&&(f.push(a),this.data=f,this._createList(),!b&&this.trigger("add",a,e))},getDataState:function(){var a=this.opts,b=a.data,c=this.data,d={},e=[],f=[];return _.each(c,function(a){_.find(b,function(b){return a.id==b.id})||e.push(a)}),_.each(b,function(a){_.find(c,function(b){return a.id==b.id})||f.push(a)}),d.add=e,d.lost=f,d},filter:function(a){var b,c,d=this.opts,e=d.filterEmptyTip,f=this.data,g=[];a=_.str.trim(a),_.each(f,function(a){a.spell=a.spell.toLowerCase()}),a.length>0?(b=m(f,a,{key:"name"}),c=n(f,a.toLowerCase(),{key:"spell"}),_.each(c,function(a){_.find(b,function(b){return b.id==a.id})||g.push(a)}),g=g.concat(b)):g=f,this._createList(g),a.length>0&&0==g.length&&$(".empty-tip",this.element).html(_.template(e)({keyword:a}))},getSelectedItemData:function(){var a=this.element,b=$(".letter-group-list",a),c=$(".state-selected",b),d=this.data,e=[];return c.each(function(){var a,b=$(this),c=b.attr("itemid");a=_.find(d,function(a){return a.id==c}),a&&e.push(a)}),e},setData:function(a){a=a||[],this.data=a,this._createList()},getData:function(){return this.data},destroy:function(){this.data=null,this.opts=null,this.element.off(),this.element.empty()}}),g.mixTo(r);var s=f.extend({attrs:{width:600,content:l.filter(".fs-qx-join-tpl").html(),className:"fs-qx-join-dialog",unjoinData:{value:[],getter:function(a){return a}},joinData:{value:[],getter:function(a){return a}},unjoinLabel:"未邀请",joinLabel:"已邀请",unit:"人",bbarUnit:"人",inputPlaceholder:"",unjoinEmptyTip:"记录为空",unjoinSearchEmptyTip:"未找到{{keyword}}的记录",joinEmptyTip:"记录为空",joinSearchEmptyTip:"未找到{{keyword}}的记录",successCb:d.EMPTY_FN,moveLeftIntercept:d.EMPTY_FN,moveRightIntercept:d.EMPTY_FN,joinMinNum:-1,joinMinNumTpl:"参与组最少{{joinMinNum}}人"},events:{click:"_clickEl","click .move-right-btn":"_clickMoveRight","click .move-left-btn":"_clickMoveLeft","click .unjoin-wrapper .check-all":"_unjoinSelectAll","click .join-wrapper .check-all":"_joinSelectAll","click .show-add-data-l":"_selectAddJoinItem","click .show-lost-data-l":"_selectLostJoinItem","click .f-sub":"_submit","click .f-cancel":"_cancel"},setup:function(){var a=s.superclass.setup.apply(this,arguments);return this._bindEvents(),a},render:function(){var a=s.superclass.render.apply(this,arguments);return this._renderSelf(),this._renderQuery(),this._renderList(),a},_bindEvents:function(){var a,b=this.element;this.on("statechange",function(c){var d=c.addNum,e=c.lostNum;a=$(".f-sub",b),d+e>0?a.removeClass("button-state-disabled").prop("disabled",!1):a.addClass("button-state-disabled").prop("disabled",!0)})},_clickEl:function(a){a.stopPropagation()},_renderSelf:function(){var a=this.get("unjoinLabel"),b=this.get("joinLabel"),c=this.get("unit"),d=this.get("bbarUnit"),e=this.get("inputPlaceholder"),f=this.element,g=$(".unjoin-wrapper",f),h=$(".join-wrapper",f),i=$(".unjoin-label",f),j=$(".join-label",f);i.text(a),j.text(b),$(".unit",g).text(c),$(".unit",h).text(c),$(".ui-dialog-bbar .unit",f).text(d),$(".box-search",f).attr("placeholder",e)},_renderQuery:function(){var a=this,b=this.element,c=$(".unjoin-wrapper .box-search",b),d=$(".join-wrapper .box-search",b),e=$(".unjoin-wrapper .show-num",b),f=$(".join-wrapper .show-num",b);this.unjoinQuery=new q({element:c,cls:"unjoin-query"}),this.unjoinQuery.on("query",function(c){a.unjoinList.filter(c),c.length>0?($(".num",e).text($(".unjoin-wrapper .value-item",b).length),e.show()):e.hide(),$(".unjoin-wrapper .select-summary .num",b).text(0)}),this.joinQuery=new q({element:d,cls:"join-query"}),this.joinQuery.on("query",function(c){a.joinList.filter(c),c.length>0?($(".num",f).text($(".join-wrapper .value-item",b).length),f.show()):f.hide(),$(".join-wrapper .select-summary .num",b).text(0)})},_renderList:function(){var a=this,b=this.get("unjoinEmptyTip"),c=this.get("joinEmptyTip"),d=this.get("unjoinSearchEmptyTip"),e=this.get("joinSearchEmptyTip"),f=this.element,g=$(".unjoin-wrapper .box-list-wrapper",f),h=$(".join-wrapper .box-list-wrapper",f),i=$(".move-right-btn",f),j=$(".move-left-btn",f),k=$(".unjoin-wrapper .contain-num .num",f),l=$(".join-wrapper .contain-num .num",f),m=$(".unjoin-wrapper .select-summary .num",f),n=$(".join-wrapper .select-summary .num",f),o=$(".join-temp-num",f),p=$(".unjoin-temp-num",f),q=$(".join-wrapper .check-all",f),s=$(".unjoin-wrapper .check-all",f);this.unjoinList=new r({element:g,data:this.get("unjoinData"),cls:"unjoin-list box-list",emptyTip:b,filterEmptyTip:d}),this.unjoinList.on("select",function(){var b=a.unjoinList.getSelectedItemData();i.removeClass("button-state-disabled").prop("disabled",!1),m.text(b.length),b.length==f.find(".unjoin-list .value-item").length?s.prop("checked",!0):s.prop("checked",!1)}).on("unselect",function(){var b=a.unjoinList.getSelectedItemData();0==b.length&&i.addClass("button-state-disabled").prop("disabled",!0),m.text(b.length),s.prop("checked",!1)}),this.unjoinList.on("add",function(){k.text(a.unjoinList.data.length)}).on("remove",function(){k.text(a.unjoinList.data.length)}),this.joinList=new r({element:h,data:this.get("joinData"),cls:"join-list box-list",emptyTip:c,filterEmptyTip:e}),this.joinList.on("select",function(){var b=a.joinList.getSelectedItemData();j.removeClass("button-state-disabled").prop("disabled",!1),n.text(b.length),b.length==f.find(".join-list .value-item").length?q.prop("checked",!0):q.prop("checked",!1)}).on("unselect",function(){var b=a.joinList.getSelectedItemData();0==b.length&&j.addClass("button-state-disabled").prop("disabled",!0),n.text(b.length),q.prop("checked",!1)}),this.joinList.on("add",function(){var b=a.joinList.getDataState();l.text(a.joinList.data.length),o.text(b.add.length),p.text(b.lost.length),a.trigger("statechange",{addNum:b.add.length,lostNum:b.lost.length})}).on("remove",function(){var b=a.joinList.getDataState();l.text(a.joinList.data.length),o.text(b.add.length),p.text(b.lost.length),a.trigger("statechange",{addNum:b.add.length,lostNum:b.lost.length})}),k.text(this.get("unjoinData").length),l.text(this.get("joinData").length)},_clickMoveRight:function(a){var b=this,c=this.get("moveRightIntercept"),d=this.unjoinList,e=this.joinList,f=this.joinQuery,g=this.unjoinQuery,h=$(a.currentTarget),i=this.element,j=$(".unjoin-wrapper .check-all",i),k=$(".unjoin-wrapper .select-summary .num",i),l=d.getSelectedItemData();a.stopPropagation(),l.length>0&&(_.each(l,function(a){c.call(b,a)!==!1&&(e.addItem(a),d.removeItem(a.id))}),h.addClass("button-state-disabled").prop("disabled",!0),j.prop("checked",!1),k.text("0"),f.trigger("query",f.getQuery()),g.trigger("query",g.getQuery()))},_clickMoveLeft:function(a){var b=this,c=this.get("moveLeftIntercept"),d=this.get("joinMinNum"),e=this.get("joinMinNumTpl"),f=this.unjoinList,g=this.joinList,i=this.joinQuery,j=this.unjoinQuery,k=$(a.currentTarget),l=this.element,m=$(".join-wrapper .check-all",l),n=$(".join-wrapper .select-summary .num",l),o=g.getSelectedItemData(),p=g.getData();return a.stopPropagation(),d>-1&&p.length-o.length<d?(h.alert(_.template(e)({joinMinNum:d})),void 0):(o.length>0&&(_.each(o,function(a){c.call(b,a)!==!1&&(g.removeItem(a.id),f.addItem(a))}),k.addClass("button-state-disabled").prop("disabled",!0),m.prop("checked",!1),n.text("0"),i.trigger("query",i.getQuery()),j.trigger("query",j.getQuery())),void 0)},_unjoinSelectAll:function(a){var b=this.unjoinList,c=$(a.currentTarget);c.prop("checked")?b.selectAllItem():b.unselectAllItem()},_joinSelectAll:function(a){var b=this.joinList,c=$(a.currentTarget);c.prop("checked")?b.selectAllItem():b.unselectAllItem()},_selectAddJoinItem:function(a){var b=this.joinList,c=b.getDataState(),d=c.add;d.length>0&&_.each(d,function(a){b.selectItem(a.id)}),a.preventDefault()},_selectLostJoinItem:function(a){var b=this.joinList,c=this.unjoinList,d=b.getDataState(),e=d.lost;e.length>0&&_.each(e,function(a){c.selectItem(a.id)}),a.preventDefault()},_submit:function(a){var b=$(a.currentTarget),c=this.get("successCb"),d=this.joinList;b.hasClass("button-state-disabled")||c&&c.call(this,d.getData())},_cancel:function(){this.hide()},resetInitState:function(){var a=this.element,b=$(".move-right-btn",a),c=$(".move-left-btn",a),d=$(".unjoin-wrapper .contain-num .num",a),e=$(".join-wrapper .contain-num .num",a),f=$(".unjoin-wrapper .select-summary .num",a),g=$(".join-wrapper .select-summary .num",a),h=$(".join-temp-num",a),i=$(".unjoin-temp-num",a),j=$(".check-all",a),k=$(".f-sub",a),l=this.joinList,m=this.unjoinList,n=l.data,o=m.data;c.addClass("button-state-disabled").prop("disabled",!0),b.addClass("button-state-disabled").prop("disabled",!0),d.text(o.length),e.text(n.length),f.text("0"),g.text("0"),h.text("0"),i.text("0"),j.prop("checked",!1),k.addClass("button-state-disabled").prop("disabled",!0),this.joinQuery.reset(),this.unjoinQuery.reset(),l.element.scrollTop(0),m.element.scrollTop(0)},setTitle:function(a){$(".ui-dialog-title",this.element).text(a)},setInitData:function(a){var b=a.joinData,c=a.unjoinData,d=this.joinList,e=this.unjoinList;d.setData(h.deepClone(b)),d.opts.data=b,e.setData(h.deepClone(c)),e.opts.data=c,this.resetInitState()},destroy:function(){var a;return this.unjoinList&&this.unjoinList.destroy(),this.joinList&&this.joinList.destroy(),this.unjoinList=null,this.joinList=null,this.unjoinQuery&&this.unjoinQuery.destroy(),this.joinQuery&&this.joinQuery.destroy(),this.unjoinQuery=null,this.joinQuery=null,a=s.superclass.destroy.apply(this,arguments)}});_.extend(b,{QueryInput:q,LetterGroupList:r,JoinDialog:s,Uploader:p})});