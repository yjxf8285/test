/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/fs-qx/fs-shortmessage-list",["util","modules/feed-list/fl-util","uilibs/pagination","moment","./fs-shortmessage-list.html","./fs-shortmessage-list.css","modules/feed-list/feed-list-helper","modules/fs-attach/fs-attach-preview","modules/fs-attach/fs-attach-file-preview","modules/fs-qx/fs-qx","json","modules/fs-map/fs-map","uilibs/audio-player","./fs-qx-core","events"],function(a,b,c){var d=window,e=d.FS,f=e.tpl,g=a("util");a("modules/feed-list/fl-util");var h=a("uilibs/pagination"),i=a("moment"),j=a("./fs-shortmessage-list.html");a("./fs-shortmessage-list.css"),a("modules/feed-list/feed-list-helper");var k=a("modules/fs-attach/fs-attach-preview"),l=a("modules/fs-attach/fs-attach-file-preview"),m=a("modules/fs-qx/fs-qx.js"),n=a("json"),o=a("modules/fs-map/fs-map"),p=o.FsMapOverlay,q=new p,r=(new k).render(),s=l.FileReader,t=new s,u=a("uilibs/audio-player"),v=g.getContactData(),w=v.u,j=$(j),x=a("./fs-qx-core"),y=x.constants,z=function(){var a={};return _.each(y.messageType,function(b,c){a[c]=_.template(j.filter(".fs-shortmessage-"+c+"-tpl").html())}),a},A=function(a){return e.API_PATH+"/df/GetMp3?clientPath="+a},B=z(),C=function(a,b){var c=b.content,d=y.messageType,e=new RegExp("(http[s]{0,1}|ftp)://[a-zA-Z0-9\\.\\-]+\\.([a-zA-Z]{2,4})(:\\d+)?(/[a-zA-Z0-9\\.\\-~!@#$%^&amp;*+?:_/=<>]*)?|www\\.[a-z0-9\\-]+(\\.[a-zA-Z]{2,4}){1,2}(:\\d+)?/?","gi"),f={typeName:"",senderId:b.senderId,senderName:b.senderName,messageId:b.messageId,messageTime:b.messageTime,profileImage:b.profileImage,createTime:g.getDateSummaryDesc(i.unix(b.messageTime/1e3),i.unix(b.serviceTime),1)};for(var h in d)d.hasOwnProperty(h)&&d[h]==b.messageType&&(f.typeName=h);if(c){switch(b.messageType){case d.image:c=n.parse(c),c.FileSize=g.getFileSize(c.FileSize),c.ThumbnailUrl=g.getFileUrl(c.Thumbnail),c.fileName=c.N,_.extend(f,c);break;case d.document:c=n.parse(c),c.Size=g.getFileSize(c.Size),c.FileType=g.getFileType({name:c.File},!0),c.DownloadUrl=g.getFileUrl(c.File,c.Name,!0),_.extend(f,c);break;case d.audio:c=n.parse(c),c.File=A(c.File),_.extend(f,c);break;case d.location:c=n.parse(c),c.messageTime=parseInt(f.messageTime/1e3,10),_.extend(f,c);break;case d.workNotice:c=n.parse(c),_.extend(f,{title:c.T,desc:c.C,feedid:c.F});break;case d.linkWorkItem:c=n.parse(c);var j={P1:"日志",P2:"周计划",P3:"月计划",A1:"普通审批",A2:"请假单",A3:"报销单",A4:"差旅单",A5:"借款单",W:"指令"},k="";k="W"==c.T?j.W:"P"==c.T&&1==c.ST?i(c.D).format("MM月DD日的日志"):j[c.T+c.ST],_.extend(f,{title:k,desc:c.C,feedid:c.F});break;case d.linkWorkSchdule:c=n.parse(c),_.extend(f,{title:i(c.ST).format("MM月DD日 HH:mm的日程"),desc:c.C,feedid:c.F});break;case d.systemPrompt:c=n.parse(c);var l=y.systemPrompt,m=c.T,o=c.U,p=[],q="";switch(m){case l.exit:q="退出群对话";break;case l.invite:q="邀请",_.each(c.A,function(a){if(a!=o){var b;if(a==w.id)b="你";else{var c=g.getContactDataById(a,"p");c&&(b=c.name)}b&&p.push(b)}}),q+=p.join("、")+"加入群对话";break;case l.kick:q="将",_.each(c.A,function(a){if(a!=o){var b;if(a==w.id)b="你";else{var c=g.getContactDataById(a,"p");c&&(b=c.name)}b&&p.push(b)}}),q+=p.join("、")+"移出群对话";break;case l.name:q=c.V?"将群对话的名称修改为："+c.V:"取消了群对话名称"}f.content=q;break;case d.systemTextPrompt:f.content=c;break;case d.text:default:c=c.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r]/g,"<br/>").replace(new RegExp(" ","g"),"&nbsp;"),c=c.replace(e,function(a){var b=/https{0,1}|ftp/gi;return'<a href="'+(b.test(a)?"":"http://")+a+'" target="_blank">'+a+"</a>"}),c=g.emoji(c),f.content=c}return a[f.typeName](f)}},D=Backbone.Model.extend({}),E=Backbone.Collection.extend({model:D,sync:function(a,b,c){var d=c.data||{};c.data=_.extend({pageSize:10,pageNumber:1},d),Backbone.sync("read",b,c)},parse:function(a){var b=a.value.sessions,c=[];if(a.success){var d=y.messageType;_.each(b,function(b){var f=b.sessionCategory,h=b.lastMessage;if((f==y.sessionType.single||f==y.sessionType.discussion)&&h){var j=h.content,k=h.senderId,l=h.messageType,m={sessionId:b.sessionId,sessionName:b.sessionName,sessionType:f,lastMessageTime:h.messageTime,lastCreateTime:g.getDateSummaryDesc(i.unix(parseInt(h.messageTime/1e3,10)),i.unix(a.serviceTime),1)};if(!k){if(l!=d.systemPrompt)return;k=n.parse(j).U}var o=h.sender;if(f==y.sessionType.discussion){if(m.profileImageUrl=b.portraitPath?g.getFileUrl(b.portraitPath):e.ASSETS_PATH+"/images/group_default_50x50.png",!m.sessionName){var p=[];_.each(b.participantIds,function(a){if(a!=w.id){var b=g.getContactDataById(a,"p");b&&p.push(b.name)}}),m.sessionName=p.join("、")}m.sessionName||(m.sessionName="群对话")}else m.profileImageUrl=o?g.getAvatarLink(o.profileImage,2):e.ASSETS_PATH+"/images/employee_default_120_120.png";m.name=k==w.employeeID?"我":o.name,m.newico=b.notReadFlag?'<div class="img-new"></div>':"",m.content=C(B,{content:j,messageType:l,senderId:k,senderName:m.name,messageId:h.messageId,messageTime:h.messageTime}),c.push(m)}}),c=_.sortBy(c,"lastMessageTime").reverse()}return c}}),F=Backbone.View.extend({tagName:"div",className:"fs-shortmessage-item card-border-rad",events:{"click .feed-img-thumb":"previewImg","click .attach-preview-l":"previewAttach","click .worknotice-content-wrap":"clickWorknotice","click .workSchdule-content-wrap":"clickWorkSchdule","click .workItem-content-wrap":"clickWorkItem","click .shortcut-del-btn":"shortcutDel","click .feed-location-fn-map":"showLocation"},shortcutDel:function(a){var b=this,c=b.options,d=$(a.currentTarget),f=d.attr("data-sessionid"),h=d.attr("data-sessiontype"),i={markAllMessagesDeleted:!0,epTag:e.getAppStore("contactData").epTag,sessionID:f},j=h==y.sessionType.discussion?"ResetDiscussionSession":"ResetSingleSession";h==y.sessionType.discussion?(j="ResetDiscussionSession",i.markSessionHide=!0):(j="ResetSingleSession",i.markSessionDeleted=!0),g.confirm("你确定要从企信列表删除该对话吗？","提示",function(){g.api({url:"/V3Messenger/"+j,type:"post",dataType:"json",data:i,success:function(a){a.success&&(b.remove(),c.removeItemCb&&c.removeItemCb.call(b,a))}})},{onCancel:function(){},width:338})},previewImg:function(a){var b=$(a.currentTarget);r.preview({type:"img",data:[{previewPath:b.attr("data-HDImg")||b.attr("data-Image"),originPath:b.attr("data-Image"),fileName:b.attr("data-name"),thumbPath:b.attr("data-Thumbnail")}],belongToType:"newqx"}),a.preventDefault()},previewAttach:function(a){var b=$(a.currentTarget),c=b.attr("data-file"),d=b.attr("data-name");t.readFile({fileId:g.getFileNamePath(c),fileName:d,filePath:c}),a.preventDefault()},clickWorknotice:function(a){var b=$(a.currentTarget).attr("data-id");b&&f.navRouter.navigate("#stream/showfeed/=/id-"+b+"/datalighted-app|workmessage",{trigger:!0}),a&&a.preventDefault()},clickWorkSchdule:function(a){var b=$(a.currentTarget).attr("data-id");b&&f.navRouter.navigate("#stream/showfeed/=/id-"+b,{trigger:!0}),a&&a.preventDefault()},clickWorkItem:function(a){var b=$(a.currentTarget).attr("data-id");b&&f.navRouter.navigate("#stream/showfeed/=/id-"+b,{trigger:!0}),a&&a.preventDefault()},showLocation:function(a){var b=g.queryToJson($(a.currentTarget).attr("action-data"));q.fixLocation(b),a.preventDefault()},initialize:function(){var a=j.filter(".fs-shortmessage-send-item-tpl").html();this.template=_.template(a),this.listenTo(this.model,"change",this.render)},_renderAudioCpt:function(){var a,b,c=this.$el,d=$(".audio-box",c);d.length>0&&(a=d.attr("data-src"),b=parseInt(d.attr("data-duration")),this.audioPlayer||(this.audioPlayer=new u({element:d,audioSrc:a,length:b,themeStyle:4})))},render:function(){return this.$el.html(this.template(this.model.toJSON())),this._renderAudioCpt(),this},destroy:function(){this.audioPlayer&&this.audioPlayer.destroy(),this.remove()}}),G=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:20,visiblePageNums:7},listPath:"/attach_html/getAttachImgFilesOfIReceive",defaultRequestData:{},searchOpts:{inputSelector:null,btnSelector:null},listCb:e.EMPTY_FN,listEmptyText:"暂无记录"},a||{}),this.opts=a,this.element=$(a.element),this.pagEl=$(a.pagSelector),this.pagination=null,this.tempRequestData={},this.init()};_.extend(G.prototype,{init:function(){var a,b=this,c=this.opts,d=this.element;m.chatPanel,a=new E,a.on("add",function(a){var c;c=new F({model:a,removeItemCb:function(a){a.success&&b.reload()}}).render(),c.$el.data("itemV",c).appendTo(d)}),this.list=a,this.pagination=new h(_.extend({element:this.pagEl},c.pagOpts)),this.pagination.on("page",function(){b.empty(),b.fetch()}),this.pagination.render(),c.searchOpts&&c.searchOpts.inputSelector,this._initListEmptyTip()},_searchBarInit:function(){var a,b=this,c=this.opts,d=c.searchOpts,e=this.element,f=$(d.inputSelector),g=$(d.btnSelector);a=$('<div class="list-search-bar fn-clear"></div>'),a.html('<span class="result-info fn-left">共搜索到<span class="num color-red">0</span>条信息</span><a class="back-l fn-right" href="javascript:void(0)" title="返回查看全部"><< 返回查看全部</a>'),a.hide().prependTo(e);var h=$('<span class="empty-h">&#10005;</span>'),i=$('<span class="list-search-input-wrapper"></span>');f.wrap(i),i=f.closest(".list-search-input-wrapper"),h.hide().appendTo(i),f.keydown(function(a){13==a.keyCode&&g.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(h.show(),f.addClass("with-input-value")):(h.hide(),f.removeClass("with-input-value"))}),h.click(function(){f.val(""),f.removeClass("with-input-value"),h.hide()}),a.on("click",".back-l",function(a){var c=$(".list-empty-tip",e);b.reload({keyword:""}),f.val(""),f.removeClass("with-input-value"),h.hide(),c.hide(),a.preventDefault()})},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".num",d);return!a.isFirstChar&&a.keyword.length>0&&b.success?(e.text(b.value.totalCount),d.show(),void 0):(d.hide(),void 0)},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+e.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.appendTo(a)},_updatelistStatus:function(a){var b,c=this.element,d=$(".list-empty-tip",c);a.success&&(b=a.value.totalCount,0==b?d.show():d.hide())},fetch:function(){var a=this,b=this.opts;this.list;var c=this.pagination,d=_.extend({epTag:e.getAppStore("contactData").epTag,pageSize:c.get("pageSize"),pageNumber:c.get("activePageNumber")});d=_.isFunction(b.defaultRequestData)?_.extend(b.defaultRequestData(),d):_.extend(b.defaultRequestData,d),d=_.extend(d,this.tempRequestData),this.tempRequestData={},this.showLoading(),this.list.fetch({url:b.listPath,data:d,success:function(d,e){var f;e.success&&(f=e.value,c.setTotalSize(f.totalCount),a._updatelistStatus(e),b.listCb.call(a,e),a.hideLoading())}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a){this.tempRequestData=a,this.pagination.jump(1)},reload:function(a){this.load(a)},empty:function(){var a=this.element,b=$(".fs-shortmessagelist-item",a);b.each(function(){var a=$(this),b=a.data("itemV");b.destroy(),a.removeData()}),a.empty()},destroy:function(){this.list=null,this.pagination.destroy(),this.loading&&this.loading.stop(),this.empty(),this.pagination=null,this.tempRequestData={},this.element=null}}),c.exports=G});