/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/fs-qx/fs-qx",["overlay","position","modules/fs-qx/fs-qx.css","modules/fs-qx/fs-qx.html","util","moment","filter","json","uilibs/audio-player","modules/fs-attach/fs-attach-preview","modules/fs-attach/fs-attach-file-preview","modules/fs-map/fs-map","scrollbar","./fs-qx-helper","dialog","events","h5uploader","flashuploader","./fs-qx-core"],function(a,b,c){var d=window,e=d.FS,f=e.tpl,g=a("overlay"),h=a("position"),i=(a("modules/fs-qx/fs-qx.css"),a("modules/fs-qx/fs-qx.html")),j=a("util"),k=a("moment"),l=a("filter"),m=a("json"),n=a("uilibs/audio-player"),o=a("modules/fs-attach/fs-attach-preview"),p=a("modules/fs-attach/fs-attach-file-preview"),q=a("modules/fs-map/fs-map"),r=a("scrollbar"),s=a("./fs-qx-helper"),t=a("./fs-qx-core"),u=$(i),v=_.template(u.filter(".fs-qx-chat-item-tpl").html()),w=_.template(u.filter(".fs-qx-message-item-text-tpl").html()),x=_.template(u.filter(".fs-qx-message-item-img-tpl").html()),y=_.template(u.filter(".fs-qx-message-item-attach-tpl").html()),z=_.template(u.filter(".fs-qx-message-item-audio-tpl").html()),A=_.template(u.filter(".fs-qx-message-item-control-tpl").html()),B=_.template(u.filter(".fs-qx-message-item-location-tpl").html()),C=_.template(u.filter(".fs-qx-message-item-workNotice-tpl").html()),D=_.template(u.filter(".fs-qx-message-item-linkWorkSchdule-tpl").html()),E=_.template(u.filter(".fs-qx-message-item-linkWorkItem-tpl").html()),F=_.template(u.filter(".fs-qx-participant-item-tpl").html()),G=j.getContactData(),H=G.u,I=l.stringMatch,J=l.startsWith,K=(new o).render(),L=p.FileReader,M=new L,N=q.FsMapOverlay,O=new N,P=new RegExp("(http[s]{0,1}|ftp)://[a-zA-Z0-9\\.\\-]+\\.([a-zA-Z]{2,4})(:\\d+)?(/[a-zA-Z0-9\\.\\-~!@#$%^&amp;*+?:_/=<>]*)?|www\\.[a-z0-9\\-]+(\\.[a-zA-Z]{2,4}){1,2}(:\\d+)?/?","gi"),Q=e.pageTitle,R=j.cutBadStr;j.tplRouterReg("#shortmessage/showsession/=/:id-:value");var S=function(a){return a=[].concat(a),_.reject(G.p,function(b){return _.some(a,function(a){return b.id==a})})},T=s.Uploader,U=s.QueryInput,V=s.JoinDialog,W=t.QXModel,X=t.constants,Y=g.extend({attrs:{align:{selfXY:["100%+242px","100%"],baseElement:h.VIEWPORT,baseXY:["100%","100%"]},className:"fs-chat-panel",maxHisNum:100,zIndex:100,activeIndex:-1,joinDialog:null,qxPanel:null},events:{click:"_clickSelf","click .fs-qx-chat-shown .fs-qx-chat-tbar .hide-l":"_clickMinBtn","click .fs-qx-chat-hidden .fs-qx-chat-title":"_clickHiddenTitle","click .fs-qx-chat-shown .fs-qx-chat-tbar .close-l":"_switchToClosed","click .fs-qx-chat-shown .open-dg-l":"_openJoinDialog","click .fs-qx-chat-shown .open-dg-btn":"_openJoinDialog","mouseenter .fs-qx-chat-shown .chat-item":"_enterChatItem","mouseleave .fs-qx-chat-shown .chat-item":"_leaveChatItem","click .chat-nav-panel .chat-item-content":"_clickChatItemNav","click .chat-nav-panel .remove-l":"_clickRemoveChatItemNav","click .fs-qx-chat-shown .chat-title-edit-enable .chat-title-shown":"_clickChatTitleShown","blur .fs-qx-chat-shown .chat-title-edit-enable .title-edit":"_blurChatTitleEdit","keydown .fs-qx-chat-shown .chat-title-edit-enable .title-edit":"_keydownChatTitleEdit","click .fs-qx-chat-shown .nav-up":"_clickNavUp","click .fs-qx-chat-shown .nav-down":"_clickNavDown","click .message-submit-wrapper .remove-l":"_clickUploadRemove","click .message-submit-bbar .f-sub":"_clickSubmit","keydown .fs-qx-chat-shown .message-input":"_keydownInput","blur .fs-qx-chat-shown .message-input":"_blurInput","click .logout-btn":"_clickLogout","click .message-type-image .preview-l":"_previewImg","click .message-type-image .img-wrapper":"_previewImg","click .message-type-document .preview-l":"_previewAttach","click .message-type-location .message-location":"_showLocation","click .message-type-audio .ctr-btn":"_clickAudioPlay","click .state-offline-tip .close-tip-l":"_clickCloseOfflineTip","click .message-type-workNotice .message-content":"_clickShowFeed","click .message-type-linkWorkItem .message-content":"_clickShowWorkItem","click .message-type-linkWorkSchdule .message-content":"_clickWorkSchdule"},setup:function(){var a=Y.superclass.setup.apply(this,arguments);return this.participantPrefix="emp_",this.status="",this._updateStatus("close"),this.sessionList=[],this.cacheSessionList=[],this._setJoinDialog(),this.audioCpts=[],this._bindEvents(),a},_setJoinDialog:function(){this.joinDialog=new V({joinMinNum:3,joinMinNumTpl:"创建群对话至少需要选择{{joinMinNum}}位同事，请确认。"}),this.joinDialog.set("moveLeftIntercept",function(a){return a.id==H.id?(this.joinList.unselectItem(a.id),!1):void 0}),this.joinDialog.set("moveRightIntercept",function(a){return a.id==H.id?(this.unjoinList.unselectItem(a.id),!1):void 0})},showJoinDialog:function(a,b,c){var d=this,e=d.joinDialog;e.show(),e.setInitData({joinData:a,unjoinData:b}),e.set("successCb",function(a){var b=_.map(a,function(a){return a.id});return b.length>100?(j.alert("群对话的人数上限为100位同事，请确认。",function(){}),void 0):b.length<3?(j.alert("创建群对话至少需要选择3位同事，请确认。",function(){}),void 0):(c&&c(b),void 0)})},_updateStatus:function(a){var b=X.chatWinStatus;if(_.contains(b,a))switch(this.status=a,a){case b.close:this.hide(),this.element.hide(),this.stopAllAudio(),this.stopStarHtmlTitle(),W.setDelay(!0);break;case b.min:var c=this.getActiveSession();c&&(this.element.show(),this.element.find(".fs-qx-chat-shown").hide(),this.element.find(".fs-qx-chat-hidden .fs-qx-chat-title").html(c.name).css({background:"#eaeaea",color:"#3d3d3d"}),this.element.find(".fs-qx-chat-hidden .fs-qx-chat-tbar").removeClass("fs-qx-new-message"),this.element.find(".fs-qx-chat-hidden").show());break;case b.open:if(-1==this.get("activeIndex")){if(0==this.sessionList.length)return;this.set("activeIndex",0)}this.show(),this.element.find(".fs-qx-chat-shown").show(),this.element.find(".fs-qx-chat-hidden").hide(),this.element.find(".fs-qx-chat-tbar").attr("class","fs-qx-chat-tbar"),W.setDelay(!1)}},_bindEvents:function(){var a=this;W.on("qxSessionDiscussionAdd qxSessionSingleAdd",function(b){_.each(b,function(b){var c=W.getSessionData(b);if(c.category==X.sessionType.single)for(var d=0;d<a.sessionList.length;d++)if(a.sessionList[d]==a.participantPrefix+c.sessionSubCategory)return a.sessionList[d]=c.id,d==a.get("activeIndex")&&$(".history-h",a.element).removeClass("state-disabled").attr("href","#shortmessage/showsession/=/id-"+c.id),void 0;c&&c.notReadCount>0&&(a.status==X.chatWinStatus.open?a.addSession(b):_.contains(a.sessionList.concat(a.cacheSessionList),b)||a.cacheSessionList.push(b))})}),W.on("qxSessionNewMessage",function(b){var c=a.getActiveSession(),d=c&&c.id;_.each(b,function(b){var c=W.getSessionData(b);return c.id==d?(a.status==X.chatWinStatus.open&&a._getMessages(),void 0):(c&&c.notReadCount>0&&(a.status==X.chatWinStatus.open?a.addSession(b):_.contains(a.sessionList.concat(a.cacheSessionList),b)||a.cacheSessionList.push(b)),void 0)})}),W.on("qxSessionDiscussionRename qxSessionDiscussionMemberChange",function(b){var c=a.element,d=$(".chat-nav-panel",c),e=$(".chat-item",d),f=a.getActiveSession(),g=f&&f.id;_.each(b,function(b){var c=_.indexOf(a.sessionList,b);if(-1!=c){var d=W.getSessionData(b),f=R(d.name);b==g&&(a._renderParticipant(d.participantIds),a.element.find(".avatar-win-inner img").attr("src",d.portraitPath),a.element.find(".chat-title-shown").html(f)),e.eq(c).html('<a href="javascript:;" title="'+f+'" class="chat-item-content fn-clear'+(d.notReadCount>0?" cic-come-on":"")+'"><span class="avatar-wrapper fn-left"><img src="'+d.portraitPath+'" class="avatar-thumb" /></span><span class="chat-name fn-left">'+f+'</span></a><span class="remove-l">×</span>')}})}),W.on("qxSessionDiscussionDel",function(b){var c=!1;_.each(b,function(b){var d=_.indexOf(a.sessionList,b),e=a.get("activeIndex");d>-1&&(a.removeSession(d),d==e&&(c=!0)),a.cacheSessionList=_.without(a.cacheSessionList,b)});var d=a.getActiveSession();"min"==a.status&&c&&(d?a.element.find(".fs-qx-chat-hidden .fs-qx-chat-title").html(d.name):a._updateStatus("close")),a.showNewMessageAlert(a.getUnreadMessageCount())}),W.on("qxNewMessage",function(b,c){a.appendMessageListHtml(b,c)}),W.on("qxSessionNotReadCountChange",function(b){var c=a.get("activeIndex");_.each(b,function(b){var d=W.getSessionData(b),e=_.indexOf(a.sessionList,b);if(-1==e)return 0==d.notReadCount&&(a.cacheSessionList=_.without(a.cacheSessionList,b)),void 0;var f=a.element.find(".chat-list .chat-item:eq("+e+")").find(".chat-item-content");if(d.notReadCount){if(c==e)return;a.status==X.chatWinStatus.open&&j.toggleAnimate({element:f,startProperty:{backgroundColor:"#f4f4f4"},endProperty:{backgroundColor:"#fff1ba"},animateOpts:{easing:"swing",duration:260,complete:function(){var c=a.get("activeIndex");c>-1&&a.sessionList[c]==b&&f.css({background:"transparent",color:"#767573"})}},count:2}),f.addClass("cic-come-on")}else f.removeClass("cic-come-on").removeAttr("style")});var d=a.getUnreadMessageCount();a.showNewMessageAlert(d),d?(a.openNewMessageSound(),a.starHtmlTitle()):(a.stopAllAudio(),a.stopStarHtmlTitle())}),$("body").on("click",".js-qx-quick-reply",function(){var b,c=$(this),d=c.attr("data-sessionid");return d||(b=c.attr("data-employeeid"),d=a.participantPrefix+b),a.openChat(d),!1}),$(d).scroll(function(){a._setPosition()}),$("body").click(function(){a.status==X.chatWinStatus.open&&a._clickMinBtn()})},_clickSelf:function(a){a&&a.stopPropagation()},_clickChatItemNav:function(a){var b=this.element,c=$(".chat-nav-panel",b),d=$(a.currentTarget).closest(".chat-item"),e=$(".chat-item",c);this.set("activeIndex",e.index(d))},_enterChatItem:function(a){$(".remove-l",$(a.currentTarget)).show()},_leaveChatItem:function(a){$(".remove-l",$(a.currentTarget)).hide()},_clickRemoveChatItemNav:function(a){this.removeSession($(a.currentTarget).closest(".chat-item").index())},_clickHiddenTitle:function(a){if(this.sessionList.length>0){var b=this.get("activeIndex");b=0>b?0:b,this.openChat(this.sessionList[b])}else this.cacheSessionList.length&&this.openChat(this.cacheSessionList[0]);a&&a.preventDefault()},_clickMinBtn:function(a){var b=this;"open"==this.status&&b._updateStatus("min"),a&&a.preventDefault()},_switchToClosed:function(a){this._updateStatus("close"),a&&a.preventDefault()},_clickChatTitleShown:function(a){var b=$(a.currentTarget),c=b.closest(".fs-qx-chat-title"),d=$(".title-edit",c),e=$(".join-num",c),f=this.getActiveSession();b.hasClass("state-disabled")&&f!=X.sessionType.discussion||(b.hide(),e.hide(),d.val(f.defaultName).show().get(0).focus()),a.preventDefault()},_keydownChatTitleEdit:function(a){13==a.keyCode&&$(a.currentTarget).blur()},_blurChatTitleEdit:function(a){var b=$(a.currentTarget),c=b.closest(".fs-qx-chat-title"),d=$(".chat-title-shown",c),e=$(".join-num",c),f=_.str.trim(b.val()),g=this.getActiveSession();if(f!=g.defaultName){if(f.length>200)return j.alert("请控制名称在200字内"),void 0;if(b.data("status"))return!1;b.data("status","posting"),W.changeDiscussionName(g.id,f,function(a){a.success&&(d.show(),e.show(),b.hide())},function(){b.data("status",null)})}else d.show(),e.show(),b.hide()},_clickLogout:function(a){var b=this.getActiveSession(),c=this.element,d=$(".chat-nav-panel",c),e=$(".chat-item",d),f=e.eq(this.get("activeIndex"));this.get("qxPanel"),j.confirm("是否要确定退出并删除当前群对话"," ",function(a){var c=this;W.exitDiscussionSession(b.id,{submitSelector:$(a.currentTarget)},function(){c.hide(),$(".remove-l",f).click()})},{messageType:"question",autoHide:!1}),a&&a.preventDefault()},_clickNavDown:function(a){var b=this.element,c=$(".chat-nav-panel .chat-list-wrapper",b),d=$(".chat-list",c),e=c.scrollTop(),f=c.height(),g=d.height();g+4>e+f&&c.scrollTop(e+32),a.preventDefault()},_clickNavUp:function(a){var b=this.element,c=$(".chat-nav-panel .chat-list-wrapper",b),d=c.scrollTop();d>0&&c.scrollTop(d-32),a.preventDefault()},_clickUploadRemove:function(a){var b=this.element,c=$(".message-submit-wrapper",b),d=$(".upload-file",c),e=d.attr("fileid"),f=d.attr("uploadtype");this.imgUploader.setDisable(!1),this.attachUploader.setDisable(!1),this[f+"Uploader"].removeFile(e),c.removeClass("with-upload"),a.preventDefault()},_clickSubmit:function(a){var b=this;this.get("qxPanel");var c=this.element,d=$(".message-submit-wrapper .submit-modal",c),e=$(".message-submit-wrapper .upload-file",c),f=$(".remove-l",e),g=$(".message-input",c),h=_.str.trim(g.val()),i=this.get("activeIndex"),k=this.sessionList[i];if(e.is(":hidden")&&0==h.length)return j.showInputError(g),!1;if(a.preventDefault(),h.length>2e3)return j.alert("发布内容不能超过2000字，目前已超出<em>"+(h.length-2e3)+"</em>个字"),void 0;d.show();try{g.get(0).blur()}catch(l){}this._sendMessage(function(a){var c,e={content:h,fileInfo:a[0]},i=k,j=b.getSessionIdInfoByIdStr(k);"sessionId"==j.type?(e.sessionId=j.id,c=W.getSessionData(j.id),c.category==X.sessionType.single&&(i=b.participantPrefix+c.sessionSubCategory)):e.participantId=j.id,W.sendMessage({data:e,complete:function(){d.hide()},success:function(c){c.success&&(a.length>0&&f.click(),g.val(""),b._removels(i),g.focus())}})},function(){j.alert("上传附件失败，请重试"),d.hide()}),a&&a.preventDefault()},_previewImg:function(a){var b=$(a.currentTarget);b.attr("path");var c=m.parse(decodeURIComponent(b.attr("attachdata")));K.preview({type:"img",data:[{previewPath:c.HDImg||c.Image,originPath:c.Image,thumbPath:c.Thumbnail,createTime:c.createTime,fileName:c.N,fileSize:c.FileSize,fileId:c.attachID}],refId:0,belongToType:"newqx"}),a&&a.preventDefault()},_previewAttach:function(a){var b=$(a.currentTarget);b.attr("path");var c=m.parse(decodeURIComponent(b.attr("attachdata")));M.readFile({fileId:j.getFileNamePath(c.File),fileName:c.Name,filePath:c.File}),a&&a.preventDefault()},_showLocation:function(a){var b=$(a.currentTarget);O.fixLocation({latitude:b.attr("data-latitude"),longitude:b.attr("data-longitude"),address:b.attr("data-address"),createTime:b.attr("data-createTime")},{showQd:!1}),a.preventDefault()},_clickShowFeed:function(a){var b=$(a.currentTarget).attr("data-id");f.navRouter.navigate("#stream/showfeed/=/id-"+b+"/datalighted-app|workmessage",{trigger:!0}),a.preventDefault()},_clickWorkSchdule:function(a){var b=$(a.currentTarget).attr("data-id");f.navRouter.navigate("#stream/showfeed/=/id-"+b,{trigger:!0}),a.preventDefault()},_clickShowWorkItem:function(a){var b=$(a.currentTarget).attr("data-id");f.navRouter.navigate("#stream/showfeed/=/id-"+b,{trigger:!0}),a.preventDefault()},_clickAudioPlay:function(a){a&&a.preventDefault()},_keydownInput:function(a){13==a.keyCode&&($(".fs-qx-chat-shown .f-sub",this.element).click(),a.preventDefault())},_blurInput:function(a){var b=$(".message-input",this.element).val();if(b){var c=this.getActiveSession(),d=c.id;c.category==X.sessionType.single&&(d=this.participantPrefix+c.sessionSubCategory),this._setls(d,b)}a&&a.preventDefault()},_openJoinDialog:function(a){var b=this.getActiveSession();if(b.category==X.sessionType.discussion)this.openInviteJoinDialog();else if(b.category==X.sessionType.single){var c=[],d=b.participantIds;_.each(d,function(a){var b=j.getContactDataById(a,"p");b&&c.push(b)}),this.createDiscussionSession(c,S(d),function(){})}else this.createDiscussionSession([H],S(H.id),function(){});a&&a.preventDefault()},openInviteJoinDialog:function(){var a=this,b=a.getActiveSession(),c=b.participantIds,d=[];_.each(c,function(a){var b=j.getContactDataById(a,"p");b&&d.push(b)}),a.showJoinDialog(d,S(c),function(){var c=a.joinDialog.joinList.getDataState(),d={};d.addParticipantsIDs=[],c.add.length>0&&_.each(c.add,function(a){d.addParticipantsIDs.push(a.id)}),d.delParticipantsIDs=[],c.lost.length>0&&_.each(c.lost,function(a){d.delParticipantsIDs.push(a.id)}),d&&(d.sessionId=b.id,W.inviteDiscussionParticipants(d,function(){a.joinDialog.hide()},{submitSelector:$(".f-sub",a.joinDialog.element)}))})},createDiscussionSession:function(a,b){var c=this;c.showJoinDialog(a,b,function(a){W.createDiscussionSession(a,function(a){c.openChat(a),c.joinDialog.hide()},{submitSelector:$(".f-sub",c.joinDialog.element)})})},starHtmlTitle:function(){var a=0;clearInterval(this.starHtmlTitleTid),this.starHtmlTitleTid=setInterval(function(){document.title=0==a%2?"【新企信】"+Q:"【　　　】"+Q,a++},1e3)},stopStarHtmlTitle:function(){clearInterval(this.starHtmlTitleTid),document.title=Q},openNewMessageSound:function(){var a=this.newMessageAlertPlayer;if(!a){var b=$('<div class="fn-hide-abs"></div>');b.appendTo("body"),a=new n({element:b,audioSrc:e.MODULE_PATH+"/fs-qx/shortmessage.mp3"}),a.shadowEl=b,this.newMessageAlertPlayer=a}a.play()},_sendMessage:function(a,b){var c,d=this,e=this.element,f=$(".message-submit-wrapper .upload-file",e),g=f.attr("uploadtype");f.attr("fileid"),f.is(":visible")?(c=this[g+"Uploader"],this.on("uploaded",function(c,e,f){var g=m.parse(e),h=[];g.success?(h.push({value:"img"==f?2:3,value1:g.value.filePath,value2:c.size,value3:c.name}),a.call(d,h,f)):b&&b.call(d),d.off("uploaded"),d.off("uploadederror")}),this.on("uploadederror",function(){b&&b.call(d),d.off("uploadederror"),d.off("uploaded")}),c.startUpload()):a.call(d,[],g)},_renderNewChatItem:function(a){if(a){var b=this,c=b.getSessionData(a);if(c){var d=$(v({portraitPath:c.portraitPath||e.BLANK_IMG,name:R(c.name)||"",id:c.id||""})).appendTo($(".chat-list",this.element)).find(".chat-item-content");c.notReadCount>0&&(this.status==X.chatWinStatus.open&&j.toggleAnimate({element:d,startProperty:{backgroundColor:"#f4f4f4"},endProperty:{backgroundColor:"#fff1ba"},animateOpts:{easing:"swing",duration:260,complete:function(){var c=b.get("activeIndex");c>-1&&b.sessionList[c]==a&&d.css({background:"transparent",color:"#767573"})}},count:2}),d.addClass("cic-come-on")),$(".message-list-wrapper",this.element).append('<ul class="message-list"></ul>'),this.status==X.chatWinStatus.open&&this._adjustNavScrollTop(),this.updateChatItem()}}},getActiveSession:function(){var a=this.get("activeIndex");if(-1==a)return null;var b=this.sessionList,c=null;return b&&b.length>0&&a>-1&&(c=this.getSessionData(b[a])),c},removeSession:function(a){if(-1!=a){var b=this,c=b.sessionList.length,d=b.get("activeIndex"),e=b.element;W.setSessionData(b.sessionList[a],{readMessageId:null}),b.sessionList.splice(a,1),e.find(".chat-list .chat-item").eq(a).remove(),e.find(".message-list-wrapper .message-list").eq(a).remove(),b.updateChatItem(),d>a?(this.set("activeIndex",d-1,{silent:!0}),"open"==b.status&&b._adjustNavScrollTop()):a==d&&(a==c-1?this.set("activeIndex",a-1):this._onRenderActiveIndex(a))}},addSession:function(a){var b=this;_.contains(b.sessionList,a)||(b.sessionList.push(a),b._renderNewChatItem(a))},_renderParticipant:function(a){var b="";$(".join-num .num",this.element).html(a.length),_.each(a,function(a){if(a){var c=j.getContactDataById(a,"p");c&&(b+=F({id:c.id,name:R(c.name),avatar:j.getAvatarLink(c.profileImagePath,3)}))}}),$(".participant-list-wrapper",this.element).html('<ul class="participant-list">'+b+"</ul>")},_renderActiveSessionInfo:function(){var a=this,b=this.get("activeIndex"),c=a.getActiveSession();if(c){var d=c.category,e=c.name,f=R(e),g=this.element,h=$(".fs-qx-chat-shown .fs-qx-chat-title",g),i=$(".fs-qx-chat-shown .avatar-win",g),j=$(".chat-title-shown",h),k=$(".chat-list-wrapper",g),l=$(".chat-item",k).eq(b),m=$(".avatar-thumb",l),n=$(".chat-name",l),o=$(".history-h",g),p="javascript:void(0)";d==X.sessionType.single?(j.attr("href","#profile/=/empid-"+c.sessionSubCategory),p="#profile/=/empid-"+c.sessionSubCategory):d==X.sessionType.discussion&&(j.attr("href","javascript:;"),a._renderParticipant(c.participantIds)),i.html('<a class="avatar-win-inner" title="'+f+'" href="'+p+'"><img width="50" height="50" src="'+c.portraitPath+'" class="avatar-thumb" /></a>'),m.attr("src",c.portraitPath),j.html(f),n.html(f),c.id?o.removeClass("state-disabled").attr("href","#shortmessage/showsession/=/id-"+c.id):o.addClass("state-disabled"),a.updateLayout()}},_setls:function(a,b){try{var c=window.store.get(X.localStrorageName);c?(c=m.parse(c),c[a]?c[a]=b:(c.queue>=20&&(c.queue.shift(),delete c[a]),c.queue.push(a),c[a]=b)):(c={},c[a]=b,c.queue=[a]),window.store.set(X.localStrorageName,m.stringify(c))}catch(d){}},_getls:function(a){var b="";try{b=m.parse(window.store.get(X.localStrorageName))[a]}catch(c){}return b},_removels:function(a){try{var b=window.store.get(X.localStrorageName);b=m.parse(b),b&&b[a]&&(_.each(b.queue,function(c,d){c==a&&b.queue.splice(d,1)}),delete b[a],window.store.set(X.localStrorageName,m.stringify(b)))}catch(c){}},_adjustNavScrollTop:function(){var a=this.element,b=$(".chat-nav-panel .chat-list-wrapper",a),c=$(".chat-list",a),d=$(".state-active",c),e=$(".chat-item",c).index(d),f=b.height(),g=c.height();b.scrollTop(0),g>f?d.length>0?32*(e+2)+4>f&&b.scrollTop(32*(e+2)-f+4):b.scrollTop(g-f+10):b.scrollTop(0)},_onRenderActiveIndex:function(a){var b,c,d,e,f=this,g=f.element;a>=0?(b=$(".chat-item",g),e=b.eq(a),c=f.getActiveSession(),d=c.category==X.sessionType.single?f.participantPrefix+c.sessionSubCategory:c.id,b.removeClass("state-active"),e.show().addClass("state-active"),$("a",e).stop().removeAttr("style").removeClass("cic-come-on"),g.find(".message-list-wrapper .message-list").eq(a).show().siblings().hide(),$(".message-input",g).val(f._getls(d)),f._renderActiveSessionInfo(),f._getMessages()):f._updateStatus("close")},_getMessages:function(){var a=this,b=a.get("activeIndex"),c=a.getActiveSession(),d=c&&c.id;-1!=b&&c&&d&&W.getMessages(d,function(){})},getFormatCreateTime:function(a){a=k(a);var b=this.serverTime?k.unix(this.serviceTime):k(),c="",d=a.year(),e=a.month(),f=a.date();return b.year()!=a.year()&&(c+=d+"-"),(b.month()!=e||b.date()!=f)&&(c+=e+1+"-"+f),c+=" "+a.format("HH:mm")},getMessageTypeKey:function(a){var b=null,c=X.messageType;for(var d in c)c.hasOwnProperty(d)&&c[d]==a&&(b=d);return b},updateChatItem:function(){this.sessionList.length>1?$(".chat-nav-panel",this.element).show():$(".chat-nav-panel",this.element).hide()},stopAllAudio:function(){_.each(this.audioCpts,function(a){a.stop()})},updateLayout:function(){var a=this.element,b=$(".fs-qx-chat-shown .fs-qx-chat-tbar",a),c=$(".fs-qx-chat-shown .fs-qx-chat-title",a),d=$(".chat-title-shown",c),e=$(".join-num",c),f=$(".open-dg-l",b),g=$(".fs-qx-chat-shown .open-dg-btn",a),h=$(".fs-qx-chat-shown .logout-btn",a),i=$(".chat-nav-panel",a),j=$(".chat-message-panel",a),k=$(".message-submit-wrapper",a),l=$(".message-input",a),m=$(".participant-panel",a),n=$(".message-list-wrapper",a),o=$(".message-submit-bbar .f-sub",a),p=this.get("activeIndex"),q=this.getActiveSession(),r=$("html");if(r.hasClass("lt-ie8")&&b.removeAttr("style"),this.updateChatItem(),k.hasClass("with-upload"))try{this.imgUploader.setDisable(!0),this.attachUploader.setDisable(!0)}catch(s){}else try{this.imgUploader.setDisable(!1),this.attachUploader.setDisable(!1)}catch(s){}var t=function(){l.prop("disabled",!1).focus(),o.removeClass("button-state-disabled").prop("disabled",!1),d.removeClass("state-disabled"),f.removeClass("state-disabled"),g.removeClass("button-state-disabled").prop("disabled",!1),h.removeClass("button-state-disabled").prop("disabled",!1)};if(q.category==X.sessionType.discussion)if(m.show(),j.width(294),l.width(284),e.show(),0!=q.status){try{this.imgUploader.setDisable(!0),this.attachUploader.setDisable(!0)}catch(s){}l.prop("disabled",!0),o.addClass("button-state-disabled").prop("disabled",!0),d.addClass("state-disabled"),f.addClass("state-disabled"),g.addClass("button-state-disabled").prop("disabled",!0),h.addClass("button-state-disabled").prop("disabled",!0),c.removeClass("chat-title-edit-enable")}else t(),c.addClass("chat-title-edit-enable");else t(),m.hide(),j.width(394),l.width(384),e.hide(),c.removeClass("chat-title-edit-enable");r.hasClass("lt-ie8")&&b.width(a.width()-2),$(".chat-item",i).eq(p).find("a").removeAttr("style"),n.scrollTop(1e4)},getMp3Url:function(a){return e.API_PATH+"/df/GetMp3?clientPath="+a},appendMessageListHtml:function(a,b){var c=this,d="",e=b.length,f=_.indexOf(c.sessionList,a),g=[];if(-1!=f){var h=W.getSessionData(a);_.each(b,function(a){if(d+=c.getMessageItemHtml(h,a),a.messageType==X.messageType.audio){var b=m.parse(a.content);g.push({id:a.messageId,file:c.getMp3Url(b.File),duration:b.Duration,style:a.senderId==H.id?3:2})}});var i=c.element.find(".message-list-wrapper .message-list").eq(f);b[0].previousMessageId>h.lastReadMessageId?(d='<li style="text-align:center;margin:0 0 5px;"><a class="history-h" href="#shortmessage/showsession/=/id-'+a+'" title="查看历史聊天记录">查看历史聊天记录</a></li>'+d,i.html(d)):i.append(d),W.updateSessionStatus(a,b[e-1].messageId,function(){});var j=i.find("li").length;j>1e3&&i.find("li:lt("+(j-1e3)+")").remove(),g.length&&_.each(g,function(a){new n({element:$("#js_message_"+a.id),audioSrc:a.file,themeStyle:a.style,length:a.duration})}),$(".message-list-wrapper",c.element).scrollTop(9e5)}},getMessageItemHtml:function(a,b){var c,d,f,g,h=X.messageType,i=b.messageType,l="",n=a;if(n.category==X.sessionType.discussion&&b.messageType!=h.systemPrompt)if(b.senderId==H.id)f="我";else{var o=j.getContactDataById(b.senderId,"p");f=o?o.name:""}else f="";switch(i){case h.image:g=m.parse(b.content),c=x({messageContent:b.messageShowContent,createTime:this.getFormatCreateTime(b.messageTime),employeeName:f,img:'<img class="img-thumb" src="'+j.getFileUrl(g.Thumbnail)+'" />',attachSize:j.getFileSize(g.FileSize),height:g.ThumbH,path:g.Image,attachData:encodeURIComponent(m.stringify(g))});break;case h.document:g=m.parse(b.content),c=y({messageContent:"",createTime:this.getFormatCreateTime(b.messageTime),employeeName:f,attachName:g.Name,attachSize:j.getFileSize(g.Size),attachIcon:'<img class="fs-attach-'+j.getFileType({name:g.File},!0)+'-icon attach-icon" src="'+e.BLANK_IMG+'" />',downloadPath:j.getDfLink(g.File,g.Name,!0),attachData:encodeURIComponent(m.stringify(g)),canPreview:g.Prv});break;case h.audio:g=m.parse(b.content),c=z({messageContent:"",createTime:this.getFormatCreateTime(b.messageTime),employeeName:f,audioSrc:j.getFileUrl(g.File),audioLength:g.Duration,messageId:b.messageId});break;case h.systemPrompt:g=m.parse(b.content);var p=X.systemPrompt,q=g.T,r=g.U,s=j.getContactDataById(r,"p"),t=r==H.id?"你":s?s.name:"",u=[];switch(q){case p.exit:c="退出群对话";break;case p.invite:c="邀请",_.each(g.A,function(a){if(a!=r){var b;if(a==H.id)b="你";else{var c=j.getContactDataById(a,"p");c&&(b=c.name)}b&&u.push(b)}}),c+=u.join("、")+"加入群对话";break;case p.kick:c="将",_.each(g.A,function(a){if(a!=r){var b;if(a==H.id)b="你";else{var c=j.getContactDataById(a,"p");c&&(b=c.name)}b&&u.push(b)}}),c+=u.join("、")+"移出群对话";break;case p.name:c=g.V?"将群对话的名称修改为："+g.V:"取消了群对话名称"}c=t+c,c=A({messageContent:c});break;case h.systemTextPrompt:c=A({messageContent:b.content});break;case h.location:g=m.parse(b.content),c=B({messageContent:g.Text,createTime:this.getFormatCreateTime(b.messageTime),employeeName:f,latitude:g.Latitude,longitude:g.Longitude,address:g.Text,messageTime:parseInt(b.messageTime/1e3,10)});break;case h.workNotice:g=m.parse(b.content),c=C({title:g.T,createTime:this.getFormatCreateTime(b.messageTime),employeeName:f,desc:g.C,feedid:g.F});break;case h.linkWorkItem:g=m.parse(b.content);var v={P1:"日志",P2:"周计划",P3:"月计划",A1:"普通审批",A2:"请假单",A3:"报销单",A4:"差旅单",A5:"借款单",W:"指令"},F={P:" linkWorkItem-post",W:" linkWorkItem-command",A:" linkWorkItem-approval"};l=F[g.T]||"";var G="";G="W"==g.T?v.W:"P"==g.T&&1==g.ST?k(g.D).format("MM月DD日的日志"):v[g.T+g.ST],c=E({title:G,createTime:this.getFormatCreateTime(b.messageTime),employeeName:f,desc:g.C,feedid:g.F});break;case h.linkWorkSchdule:g=m.parse(b.content),c=D({title:k(g.ST).format("MM月DD日 HH:mm的日程"),createTime:this.getFormatCreateTime(b.messageTime),employeeName:f,desc:g.C,feedid:g.F});break;case h.text:default:if(!b.content)return"";d=b.content,d=d.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r]/g,"<br/>").replace(new RegExp(" ","g"),"&nbsp;"),d=d.replace(P,function(a){var b=/https{0,1}|ftp/gi;return'<a href="'+(b.test(a)?"":"http://")+a+'" target="_blank">'+a+"</a>"}),d=j.emoji(d),c=w({messageContent:d,createTime:this.getFormatCreateTime(b.messageTime),employeeName:f})}var I="left";return b.messageType==h.systemPrompt||b.messageType==h.systemTextPrompt?I="center":b.senderId==H.id&&(I="right"),c='<li messageid="'+b.messageId+'" class="message-item message-type-'+this.getMessageTypeKey(b.messageType)+l+" message-position-"+I+' fn-clear">'+c+"</li>"},showNewMessageAlert:function(a){if(this.status!=X.chatWinStatus.open){var b=this.element,c=$(".fs-qx-chat-hidden .fs-qx-chat-tbar",b),d=$(".fs-qx-chat-title",c);if(a>0)this.status==X.chatWinStatus.close&&this._updateStatus("min"),this.element.show(),this.element.find(".fs-qx-chat-shown").hide(),c.addClass("fs-qx-new-message"),d.css({color:"#FFF"}).text("您有"+a+"条新企信"),j.toggleAnimate({element:d,startProperty:{backgroundColor:"#FFF"},endProperty:{backgroundColor:"#f76c05"},animateOpts:{easing:"swing",duration:130},count:2}),this.element.find(".fs-qx-chat-hidden").show();else if("min"==this.status){var e=this.getActiveSession();e?this._updateStatus("min"):this._updateStatus("close")}}},_lazyRenderUploader:function(){var a=this,b=this.element,c=$(".upload-img-h .upload-field",b),d=$(".upload-attach-h .upload-field",b),f=$(".message-submit-wrapper",b),g=$(".upload-file",f),h=function(a,b){var c=j.getFileSize(a.size),d=j.getFileType(a,!0);f.addClass("with-upload"),g.attr("fileid",a.id),g.attr("uploadtype",b),$(".file-name",g).html('<img class="file-icon fs-attach-'+d+'-small-icon" src="'+e.BLANK_IMG+'" /><span class="file-name-content">'+a.name+"（"+c+")</span>"),k.setDisable(!0),l.setDisable(!0)},i=G.u.uploadFileSizeLimit,k=new T({element:c,h5Opts:{multiple:!1,accept:"image/*",filter:function(a){var b=[];return _.each(a,function(a){a.size<1024*1024*i&&a.size>0?"jpg"==j.getFileType(a)?b.push(a):j.alert("请选择图片格式的文件"):j.alert("上传文件不能大于"+i+"m，内容不能为空")}),b}},flashOpts:{file_types:"*.jpg;*.gif;*.jpeg;*.png",file_types_description:"图片格式",file_queued_handler:function(a){return a.size<1024*1024*i&&a.size>0?k.opts.onSelect.call(k,a):(k.core.cancelUpload(a.id,!1),j.alert("上传文件不能大于"+i+"m，内容不能为空"),void 0)}},onSelect:function(a){h(a,"img")},onSuccess:function(b,c){a.trigger("uploaded",b,c,"img")},onFailure:function(b){a.trigger("uploadederror",b)}}),l=new T({element:d,h5Opts:{multiple:!1,accept:"*/*",filter:function(a){var b=[];return _.each(a,function(a){a.size<1024*1024*i&&a.size>0?b.push(a):j.alert("上传文件不能大于"+i+"m，内容不能为空")}),b}},flashOpts:{file_types:"*.*",file_types_description:"所有文件",file_queued_handler:function(a){return a.size<1024*1024*i&&a.size>0?l.opts.onSelect.call(l,a):(l.core.cancelUpload(a.id,!1),j.alert("上传文件不能大于"+i+"m，内容不能为空"),void 0)}},onSelect:function(a){h(a,"attach")},onSuccess:function(b,c){a.trigger("uploaded",b,c,"attach")},onFailure:function(b){a.trigger("uploadederror",b)}});this.imgUploader=k,this.attachUploader=l},_onRenderVisible:function(a){var b=Y.superclass._onRenderVisible.apply(this,arguments);return a&&!this._uploaderReady&&(this._lazyRenderUploader(),this._uploaderReady=!0),b},render:function(){return this.element.html(u.filter(".fs-qx-chat-tpl").html()),Y.superclass.render.apply(this,arguments)},show:function(){return Y.superclass.show.apply(this,arguments)},hide:function(){var a=Y.superclass.hide.apply(this,arguments);return this.clear(),a},clear:function(){var a=this,b=this.element,c=$(".chat-nav-panel",b),d=$(".participant-panel",b);_.each(this.sessionList,function(b){"sessionId"==a.getSessionIdInfoByIdStr(b).type&&W.setSessionData(b,{readMessageId:null})}),this.sessionList=[],this.set("activeIndex",-1),$(".chat-list",c).empty(),$(".message-list",b).remove(),c.hide(),$(".participant-list",c).remove(),d.hide()},getUnreadMessageCount:function(){var a=0;return _.each(this.sessionList.concat(this.cacheSessionList),function(b){var c=W.getSessionData(b);c&&(a+=c.notReadCount)}),a},_appendCacheSession:function(){var a=this,b=a.cacheSessionList;_.each(b,function(b){var c=W.getSessionData(b);c&&c.notReadCount>0&&!_.contains(a.sessionList,b)&&a.addSession(b)}),a.cacheSessionList=[]},openChat:function(a){this._appendCacheSession();var b=this,c=b.get("activeIndex"),d=-1,e=b.getSessionIdInfoByIdStr(a);if("sessionId"==e.type&&(a=e.id),_.each(b.sessionList,function(b,c){return b==a?(d=c,!1):void 0}),-1==d){if(!this.getSessionData(a))return j.alert("该员工已离职，无法与他进行会话。"),!1;
b.addSession(a),d=b.sessionList.length-1}return c!=d?b.set("activeIndex",d):b._getMessages(),b._updateStatus("open"),b.updateLayout(),!0},getSessionData:function(a){var b=this,c=b.getSessionIdInfoByIdStr(a);if("userId"==c.type){var d=j.getContactDataById(c.id,"p");return d?{category:X.sessionType.single,name:d.name,defaultName:d.name,portraitPath:d.profileImage,participantIds:[c.id,H.id],sessionSubCategory:c.id}:null}return W.getSessionData(c.id)},getSessionIdInfoByIdStr:function(a){var b=new RegExp("^"+this.participantPrefix),c=a;return b.test(a)&&(a=a.replace(b,""),c=W.getSessionIdByParticipantIds(a),!c)?{type:"userId",id:a}:{type:"sessionId",id:c}},destroy:function(){var a;return this.serverTime=null,clearInterval(this.starHtmlTitleTid),this.starHtmlTitleTid=null,_.each(this.audioCpts,function(a){a.destroy&&a.destroy()}),this.audioCpts=null,this.newMessageAlertPlayer&&this.newMessageAlertPlayer.destroy(),this.newMessageAlertPlayer&&this.newMessageAlertPlayer.shadowEl.remove(),this.newMessageAlertPlayer&&(this.newMessageAlertPlayer.shadowEl=null),this.newMessageAlertPlayer=null,this.joinDialog&&this.joinDialog.destroy(),this.imgUploader&&this.imgUploader.destroy(),this.attachUploader&&this.attachUploader.destroy(),this.sessionList=[],a=Y.superclass.destroy.apply(this,arguments)}}),Z=g.extend({attrs:{align:{selfXY:["100%+20px","100%"],baseElement:h.VIEWPORT,baseXY:["100%","100%"]},className:"fs-qx",zIndex:100},events:{click:"_clickSelf","click .fs-qx-shown .fs-qx-tbar":"_clickToHidden","click .fs-qx-shown .fs-qx-bbar .hide-h":"_clickToHidden","click .fs-qx-hidden .fs-qx-tbar":"_switchToShown","click .open-dg-l":"_openNewDg","click .fs-qx-group-item .fs-qx-group-hd":"_clickGroupItem"},setup:function(){var a=Z.superclass.setup.apply(this,arguments);return this.groupListData=null,this._setupCpt(),this._initGroupListData(),this._bindEvents(),a},_setupCpt:function(){this.chatPanel=new Y({qxPanel:this}).render()},_initGroupListData:function(){var a=[],b=G.g,c=this.getNoCircleEmployees();a.push({name:'群对话[<span class="total-num">0</span>]',title:"群对话",groupType:"discussion",cls:"discussion-group",memberListData:[]}),a.push({name:'最近联系同事[<span class="total-num">0</span>]',title:"最近联系同事",groupType:"rlm",cls:"rlm-group",memberListData:[]}),b=_.filter(b,function(a){return"999999"!=a.id}),_.each(b,function(b){var c=j.getEmployeeListByCircleId(b.id);c=_.filter(c,function(a){return a.id!=H.id}),c=_.sortBy(c,function(a){return a.spell}),a.push({name:b.name+'[<span class="total-num">'+c.length+"</span>]",title:b.name,groupType:"circle",cls:"circle-group",memberListData:c})}),c=_.filter(c,function(a){return a.id!=H.id}),a.push({name:'无部门[<span class="total-num">'+c.length+"</span>]",title:"无部门",groupType:"noCircle",cls:"no-circle-group",memberListData:c}),this.groupListData=a},_bindEvents:function(){var a=this;$(d).scroll(function(){a._setPosition()}),$("body").on("click",function(){a._switchToHidden()}),W.on("qxSessionSingleAdd",function(){var b=W.getSingleList()||[];a._groupListRendered?$(".rlm-group .total-num",a.element).text(b.length>20?20:b.length):a.groupListData[1].name='最近联系同事[<span class="total-num">'+(b.length>20?20:b.length)+"</span>]",$(".rlm-group").hasClass("state-open")&&a._renderMemberList_rlm(".rlm-group")}),W.on("qxSessionDiscussionAdd qxSessionDiscussionDel qxSessionDiscussionRename qxSessionDiscussionMemberChange qxSessionDiscussionOrderChange",function(){var b=W.getDiscussionList();a._groupListRendered?$(".discussion-group .total-num",a.element).text(b.length):a.groupListData[0].name='群对话[<span class="total-num">'+b.length+"</span>]",$(".discussion-group").hasClass("state-open")&&a._renderMemberList_discussion(".discussion-group")}),W.on("qxSessionSingleOrderChange",function(){$(".rlm-group").hasClass("state-open")&&a._renderMemberList_rlm(".rlm-group")}),a.element.on("click",".js-qx-quick-reply",function(){var b,c=$(this),d=c.attr("data-sessionid");return d||(b=c.attr("data-employeeid"),d="emp_"+b),a.chatPanel.openChat(d),!1})},_clickSelf:function(a){a.stopPropagation()},_clickToHidden:function(a){this._switchToHidden(),a.preventDefault()},_switchToHidden:function(){var a=this.element,b=$(".fs-qx-shown",a),c=$(".fs-qx-hidden",a);b.hide(),c.show()},_switchToShown:function(a){var b=this.element,c=$(".fs-qx-shown",b),d=$(".fs-qx-hidden",b);c.show(),d.hide(),this._prepareGroupList(),this._setPosition(),this.updateQxScrollBar(),a.preventDefault()},_prepareGroupList:function(){this._groupListRendered||(this._renderGroupList(),this._groupListRendered=!0)},_openNewDg:function(a){var b=this.chatPanel,c=$(a.currentTarget);c.hasClass("state-disabled")||b.createDiscussionSession([H],S(H.id)),a.preventDefault(),a.stopPropagation()},_clickGroupItem:function(a){var b=$(a.currentTarget).closest(".fs-qx-group-item"),c=$(".fs-qx-member-list-wrapper",b);b.hasClass("state-open")?(c.hide(),b.addClass("state-collapse").removeClass("state-open")):(this._renderMemberList(b),c=$(".fs-qx-member-list-wrapper",b),c.show(),b.addClass("state-open").removeClass("state-collapse")),this.updateQxScrollBar(),a.preventDefault()},_renderCpt:function(){var a=this,b=this.element,c=$(".fs-qx-list-wrapper",b),d=$(".fs-qx-search",b),e=$(".fs-qx-list-search",b);this.employeeQuery=new U({element:d,cls:"employee-query"}),this.employeeQuery.on("query",function(b){b.length>0?(a._renderSearchList(b),a.switchListPanel("search")):a.switchListPanel("group"),$(".fs-qx-member-item",e).eq(0).addClass("state-selected")}).on("keynav",function(a){var b,c=$(".fs-qx-member-item",e),d=c.filter(".state-selected");0==d.length&&(d=c.eq(0)),"up"==a?(b=d.prev(),0==b.length&&(b=c.last())):"down"==a&&(b=d.next(),0==b.length&&(b=c.first())),d.removeClass("state-selected"),b.addClass("state-selected")}).on("submit",function(a){var b=$(".fs-qx-member-item",e),c=b.filter(".state-selected");0==c.length&&(c=b.eq(0)),$(".member-info",c).click(),a.preventDefault()}),e.on("mouseenter",".fs-qx-member-item",function(a){var b=$(a.currentTarget);$(".fs-qx-member-item",e).removeClass("state-selected"),b.addClass("state-selected")}),this.qxListScrollBar=new r({element:c}),this.qxSearchScrollBar=new r({element:e}),this.qxSearchScrollBar.hide()},_renderSearchList:function(a){var b,c,d=this.element,e=$(".fs-qx-list-search",d),f=S(H.id),g=[];b=I(f,a,{key:"name"}),c=J(f,a,{key:"spell"}),_.each(c,function(a){_.find(b,function(b){return b.id==a.id})||g.push(a)}),g=g.concat(b),this._renderMemberList_circle(e,{memberListData:g})},_renderMemberList:function(a){var b=this.getGroupDataByIndex($(a).attr("groupindex")),c=b.groupType;this["_renderMemberList_"+c].call(this,a,b)},_renderMemberList_discussion:function(a){var b=$(a),c=$(".fs-qx-member-list-wrapper",b),d="",e=W.getDiscussionList();e.length>0&&(d+='<ul class="fs-qx-member-list">',_.each(e,function(a){var b=W.getSessionData(a),c=R(b.name);d+='<li class="fs-qx-member-item js-qx-quick-reply" data-sessionid="'+a+'"><a href="javascript:;" title="'+c,d+=" [共"+b.participantIds.length+'人]" class="member-info fn-clear"><span class="avatar-wrapper fn-left"><img src="',d+=b.portraitPath+'" class="avatar-thumb" /></span><span class="member-name fn-left">',d+=c+'<span class="working-state">&nbsp;['+b.participantIds.length+"]</span></span></a></li>"}),d+="</ul>"),c.html(d),this.updateQxScrollBar()},_renderMemberList_rlm:function(a){var b=W.getSingleList();b.length>20&&(b=b.slice(0,20));var c=$(a),d=$(".fs-qx-member-list-wrapper",c),e="";b.length>0&&(e+='<ul class="fs-qx-member-list">',_.each(b,function(a){var b=W.getSessionData(a),c=R(b.name);e+='<li class="fs-qx-member-item js-qx-quick-reply" data-sessionid="'+a+'"><a href="javascript:;" title="'+c,e+='" class="member-info fn-clear"><span class="avatar-wrapper fn-left"><img src="'+b.portraitPath,e+='" class="avatar-thumb" /></span><span class="member-name fn-left">'+c+"</span></a></li>"}),e+="</ul>"),d.html(e)},_renderMemberList_circle:function(a,b){var c=$(a),d=$(".fs-qx-member-list-wrapper",c),e="",f=b.memberListData;f.length>0&&(e+='<ul class="fs-qx-member-list">',_.each(f,function(a){var b=R(a.name);e+='<li class="fs-qx-member-item js-qx-quick-reply" data-employeeid="'+a.id+'"><a href="javascript:;" title="'+b+'" class="member-info fn-clear"><span class="avatar-wrapper fn-left"><img src="'+j.getAvatarLink(a.profileImagePath,3)+'" class="avatar-thumb" /></span><span class="member-name fn-left">'+b+"</span></a></li>"}),e+="</ul>"),d.html(e),this.updateQxScrollBar()},_renderMemberList_noCircle:function(a,b){this._renderMemberList_circle(a,b)},_renderGroupList:function(){var a=this.groupListData,b=this.element,c=$(".fs-qx-list-wrapper",b),d="";a.length>0&&(d+='<ul class="fs-qx-group-list">',_.each(a,function(a,b){d+='<li class="'+a.cls+' fs-qx-group-item state-collapse" groupindex="'+b+'"><div class="fs-qx-group-hd"><a href="javascript:;" title="'+a.title+'">'+a.name+'</a></div><div class="fs-qx-member-list-wrapper"></div></li>'}),d+="</ul>"),c.html(d),this.updateQxScrollBar()},render:function(){this.element.html(u.filter(".fs-qx-tpl").html());var a=Z.superclass.render.apply(this,arguments);return this._renderCpt(),W.start(),a},show:function(){return Z.superclass.show.apply(this,arguments)},switchListPanel:function(a){a=a||"group";var b=this.qxListScrollBar,c=this.qxSearchScrollBar;"group"==a?(b.show(),b.update(),c.hide()):"search"==a&&(b.hide(),c.show(),c.update())},getNoCircleEmployees:function(){var a,b=G.p;return a=_.filter(b,function(a){return!a.groupIDs||0==a.groupIDs.length})},getGroupDataByIndex:function(a){return a=parseInt(a),_.isNumber(a)?this.groupListData[a]:void 0},updateQxScrollBar:function(){this.qxListScrollBar&&this.qxListScrollBar.update("relative")},destroy:function(){var a;return this.groupListData=null,this.employeeQuery&&this.employeeQuery.destroy(),this.chatPanel&&this.chatPanel.destroy(),this.qxListScrollBar&&this.qxListScrollBar.destroy(),a=Z.superclass.destroy.apply(this,arguments)}});c.exports=new Z});