/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/fs-qx/fs-showsession-list",["util","uilibs/pagination","moment","./fs-showsession-list.html","./fs-showsession-list.css","modules/fs-attach/fs-attach-preview","modules/fs-attach/fs-attach-file-preview","json","modules/fs-map/fs-map","uilibs/audio-player","./fs-qx-core","events"],function(a,b,c){var d=window,e=d.FS,f=e.tpl,g=a("util"),h=a("uilibs/pagination"),i=a("moment"),j=a("./fs-showsession-list.html");a("./fs-showsession-list.css");var k=a("modules/fs-attach/fs-attach-preview"),l=a("modules/fs-attach/fs-attach-file-preview"),m=a("json"),n=a("modules/fs-map/fs-map"),o=(new k).render(),p=l.FileReader,q=new p,r=a("uilibs/audio-player"),s=n.FsMapOverlay,t=new s,u=g.getContactData(),v=u.u,j=$(j),w=a("./fs-qx-core"),x=w.constants,y=function(){var a={};return _.each(x.messageType,function(b,c){a[c]=_.template(j.filter(".fs-showsession-"+c+"-tpl").html())}),a},z=function(a){return e.API_PATH+"/df/GetMp3?clientPath="+a},A=y(),B=function(a,b){var c=b.content,d=x.messageType,f=b.senderId,h=new RegExp("(http[s]{0,1}|ftp)://[a-zA-Z0-9\\.\\-]+\\.([a-zA-Z]{2,4})(:\\d+)?(/[a-zA-Z0-9\\.\\-~!@#$%^&amp;*+?:_/=<>]*)?|www\\.[a-z0-9\\-]+(\\.[a-zA-Z]{2,4}){1,2}(:\\d+)?/?","gi"),j={typeName:"",messageId:b.messageId,messageTime:b.messageTime,createTime:g.getDateSummaryDesc(i.unix(parseInt(b.messageTime/1e3,10)),i.unix(b.serviceTime),1)};if(b.messageType!=d.systemPrompt){var k=b.sender;j.senderId=f,j.name=b.senderId==v.employeeID?"我":k?k.name:"",j.profileImage=k?g.getAvatarLink(k.profileImage,2):e.ASSETS_PATH+"/images/employee_default_120_120.png"}for(var l in d)d.hasOwnProperty(l)&&d[l]==b.messageType&&(j.typeName=l);switch(b.messageType){case d.image:c=m.parse(c),c.FileSize=g.getFileSize(c.FileSize),c.ThumbnailUrl=g.getFileUrl(c.Thumbnail),c.fileName=c.N,_.extend(j,c);break;case d.document:c=m.parse(c),c.Size=g.getFileSize(c.Size),c.FileType=g.getFileType({name:c.File},!0),c.DownloadUrl=g.getFileUrl(c.File,c.Name,!0),_.extend(j,c);break;case d.audio:c=m.parse(c),c.File=z(c.File),_.extend(j,c);break;case d.location:c=m.parse(c),c.messageTime=parseInt(j.messageTime/1e3,10),_.extend(j,c);break;case d.workNotice:c=m.parse(c),_.extend(j,{title:c.T,desc:c.C,feedid:c.F});break;case d.linkWorkItem:c=m.parse(c);var n={P1:"日志",P2:"周计划",P3:"月计划",A1:"普通审批",A2:"请假单",A3:"报销单",A4:"差旅单",A5:"借款单",W:"指令"},o="";o="W"==c.T?n.W:"P"==c.T&&1==c.ST?i(c.D).format("MM月DD日的日志"):n[c.T+c.ST],_.extend(j,{title:o,desc:c.C,feedid:c.F});break;case d.linkWorkSchdule:c=m.parse(c),_.extend(j,{title:i(c.ST).format("MM月DD日 HH:mm的日程"),desc:c.C,feedid:c.F});break;case d.systemPrompt:c=m.parse(c);var p=x.systemPrompt,q=c.T,r=c.U,k=g.getContactDataById(r,"p"),s=[],t="";switch(j.senderId=r,j.name=r==v.employeeID?"我":k?k.name:"",j.profileImage=k?k.profileImage:e.ASSETS_PATH+"/images/employee_default_120_120.png",q){case p.exit:t="退出群对话";break;case p.invite:t="邀请",_.each(c.A,function(a){if(a!=r){var b;if(a==v.id)b="你";else{var c=g.getContactDataById(a,"p");c&&(b=c.name)}b&&s.push(b)}}),t+=s.join("、")+"加入群对话";break;case p.kick:t="将",_.each(c.A,function(a){if(a!=r){var b;if(a==v.id)b="你";else{var c=g.getContactDataById(a,"p");c&&(b=c.name)}b&&s.push(b)}}),t+=s.join("、")+"移出群对话";break;case p.name:t=c.V?"将群对话的名称修改为："+c.V:"取消了群对话名称"}j.content=t;break;case d.systemTextPrompt:j.content=c;break;case d.text:default:c=c.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r]/g,"<br/>").replace(new RegExp(" ","g"),"&nbsp;"),c=c.replace(h,function(a){var b=/https{0,1}|ftp/gi;return'<a href="'+(b.test(a)?"":"http://")+a+'" target="_blank">'+a+"</a>"}),c=g.emoji(c),j.content=c}return a[j.typeName](j)},C=Backbone.Model.extend({}),D=Backbone.Collection.extend({model:C,sync:function(a,b,c){var d=c.data||{};c.data=_.extend({pageSize:10,pageNumber:1},d),Backbone.sync("read",b,c)},parse:function(a){var b=a.value.messages,c=[];if(a.success&&b&&b.length>0){var d=x.messageType;_.each(b,function(b){var f=b.senderId,h=b.messageType,i={};if(h==d.systemTextPrompt)return i.messageTime=b.messageTime,b.serviceTime=a.serviceTime,i.content=B(A,b),i.profileImage="",i.myProfileImage="",i.sessiontype="systemTextPrompt",c.push(i),void 0;if(!f){if(h!=d.systemPrompt)return;f=m.parse(b.content).U}var j=b.sender;if(j){j.profileImage=j.profileImage?g.getAvatarLink(j.profileImage,2):e.ASSETS_PATH+"/images/employee_default_120_120.png";var k,l='<a href="#profile/=/empid-'+f+'"><img src="'+j.profileImage+'" alt="" class="profileImage-mid"></a>';k=j.name,i.sessiontype="",f==v.employeeID?(i.myProfileImage=l,i.profileImage="",i.name="我",i.sessiontype="ismysession"):(i.myProfileImage="",i.profileImage=l,i.name=k),i.messageTime=b.messageTime,b.serviceTime=a.serviceTime,i.content=B(A,b),c.push(i)}}),c=_.sortBy(c,"messageTime").reverse()}return c}}),E=Backbone.View.extend({tagName:"div",className:"fs-showsession-item fn-clear",events:{"click .feed-img-thumb":"previewImg","click .attach-preview-l":"previewAttach","click .worknotice-content-wrap":"clickWorknotice","click .workSchdule-content-wrap":"clickWorkSchdule","click .workItem-content-wrap":"clickWorkItem","click .feed-location-fn-map":"showLocation"},previewImg:function(a){var b=$(a.currentTarget);o.preview({type:"img",data:[{previewPath:b.attr("data-HDImg")||b.attr("data-Image"),originPath:b.attr("data-Image"),fileName:b.attr("data-name"),thumbPath:b.attr("data-Thumbnail")}],belongToType:"newqx"}),a.preventDefault()},previewAttach:function(a){var b=$(a.currentTarget),c=b.attr("data-file"),d=b.attr("data-name");q.readFile({fileId:g.getFileNamePath(c),fileName:d,filePath:c}),a.preventDefault(),a.preventDefault()},showLocation:function(a){var b=g.queryToJson($(a.currentTarget).attr("action-data"));t.fixLocation(b),a.preventDefault()},clickWorknotice:function(a){var b=$(a.currentTarget).attr("data-id");b&&f.navRouter.navigate("#stream/showfeed/=/id-"+b+"/datalighted-app|workmessage",{trigger:!0}),a&&a.preventDefault()},clickWorkSchdule:function(a){var b=$(a.currentTarget).attr("data-id");b&&f.navRouter.navigate("#stream/showfeed/=/id-"+b,{trigger:!0}),a&&a.preventDefault()},clickWorkItem:function(a){var b=$(a.currentTarget).attr("data-id");b&&f.navRouter.navigate("#stream/showfeed/=/id-"+b,{trigger:!0}),a&&a.preventDefault()},initialize:function(){var a=j.filter(".fs-showsession-item-tpl").html();this.template=_.template(a),this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this._renderAudioCpt(),this},_renderAudioCpt:function(){var a,b,c=this.$el,d=$(".audio-box",c);d.length>0&&(a=d.attr("data-src"),b=parseInt(d.attr("data-duration")),this.audioPlayer||(this.audioPlayer=new r({element:d,audioSrc:a,length:b,themeStyle:4})))},destroy:function(){this.audioPlayer&&this.audioPlayer.destroy(),this.remove()}}),F=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:20,visiblePageNums:7},listPath:"/attach_html/getAttachImgFilesOfIReceive",defaultRequestData:{},searchOpts:{inputSelector:null,btnSelector:null},itemRenderCb:e.EMPTY_FN,listCb:e.EMPTY_FN,listEmptyText:"当前会话内没有对话"},a||{}),this.opts=a,this.element=$(a.element),this.pagEl=$(a.pagSelector),this.pagination=null,this.tempRequestData={},this.init()};_.extend(F.prototype,{init:function(){this._initListEmptyTip();var a,b=this,c=this.opts,d=this.element;a=new D,a.on("add",function(a){var e;e=new E({model:a}).render(),e.$el.data("itemV",e).appendTo(d),c.itemRenderCb.call(b,e,a)}),this.list=a,this.pagination=new h(_.extend({element:this.pagEl},c.pagOpts)),this.pagination.on("page",function(){b.empty(),b.fetch()}),this.pagination.render(),c.searchOpts&&c.searchOpts.inputSelector},_searchBarInit:function(){var a,b=this,c=this.opts,d=c.searchOpts,e=this.element,f=$(d.inputSelector),g=$(d.btnSelector);a=$('<div class="list-search-bar fn-clear"></div>'),a.html('<span class="result-info fn-left">共搜索到<span class="num color-red">0</span>条信息</span><a class="back-l fn-right" href="javascript:void(0)" title="返回查看全部"><< 返回查看全部</a>'),a.hide().prependTo(e);var h=$('<span class="empty-h">&#10005;</span>'),i=$('<span class="list-search-input-wrapper"></span>');f.wrap(i),i=f.closest(".list-search-input-wrapper"),h.hide().appendTo(i),f.keydown(function(a){13==a.keyCode&&g.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(h.show(),f.addClass("with-input-value")):(h.hide(),f.removeClass("with-input-value"))}),h.click(function(){f.val(""),f.removeClass("with-input-value"),h.hide()}),a.on("click",".back-l",function(a){var c=$(".list-empty-tip",e);b.reload({keyword:""}),f.val(""),f.removeClass("with-input-value"),h.hide(),c.hide(),a.preventDefault()})},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".num",d);return!a.isFirstChar&&a.keyword.length>0&&b.success?(e.text(b.value.totalCount),d.show(),void 0):(d.hide(),void 0)},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+e.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.insertAfter(a)},_updatelistStatus:function(a){var b,c=this.element,d=$(".list-empty-tip",c.closest(".depw-content-list"));a.success&&(b=a.value.totalCount,0==b?d.show():d.hide())},_hideEmptyTip:function(){var a=this.element,b=$(".list-empty-tip",a.closest(".depw-content-list"));b.hide()},fetch:function(){var a=this,b=this.opts,c=this.pagination,d=_.extend({epTag:e.getAppStore("contactData").epTag,pageSize:c.get("pageSize"),pageNumber:c.get("activePageNumber")});d=_.isFunction(b.defaultRequestData)?_.extend(b.defaultRequestData(),d):_.extend(b.defaultRequestData,d),d=_.extend(d,this.tempRequestData),this.tempRequestData={},this.showLoading(),this.list.fetch({url:b.listPath,data:d,success:function(d,e){var f;e.success&&(f=e.value,c.setTotalSize(f.totalCount),a._updatelistStatus(e),b.listCb.call(a,e),a.hideLoading())}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a){this.tempRequestData=a,this.pagination.jump(1)},reload:function(a){this.load(a)},emptyToService:function(a,b){var c=this,d="/V3Messenger/",f={markAllMessagesDeleted:!0,epTag:e.getAppStore("contactData").epTag,sessionID:a};b==x.sessionType.discussion?(d+="ResetDiscussionSession",f.markSessionHide=!0):(d+="ResetSingleSession",f.markSessionDeleted=!0),g.api({url:d,type:"post",dataType:"json",data:f,success:function(a){a.success&&(c.empty(),c._updatelistStatus({success:!0,value:{totalCount:0}}),c.pagination.reset())}})},empty:function(){var a=this.element,b=$(".fs-showsession-item",a);b.each(function(){var a=$(this),b=a.data("itemV");b.remove(),a.removeData()}),a.empty()},destroy:function(){this.list=null,this.pagination.destroy(),this.loading&&this.loading.stop(),this.empty(),this.pagination=null,this.tempRequestData={},this.element=null}}),c.exports=F});