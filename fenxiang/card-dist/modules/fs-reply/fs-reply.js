/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/fs-reply/fs-reply",["modules/publish/publish","widget","util","moment","modules/fs-reply/fs-reply.html","uilibs/pagination","modules/feed-list/feed-list-helper","./fs-reply-list","modules/card-reply/feed-reply","modules/feed-list/fl-util","modules/fs-attach/fs-attach-preview","modules/fs-attach/fs-attach-file-preview","spin","uilibs/audio-player"],function(a,b,c){var d=window,e=d.FS;e.tpl;var f=a("modules/publish/publish"),g=a("widget"),h=a("util"),i=(a("moment"),a("modules/fs-reply/fs-reply.html")),j=a("uilibs/pagination"),k=(a("modules/feed-list/feed-list-helper"),a("./fs-reply-list")),l=f.atInput,m=f.mediaMaker,n=($(i),k.itemV),o=k.itemM,p=k.listC,q=g.extend({attrs:{trigger:{value:null,getter:function(a){return $(a)}},publishAction:{value:["h5imgupload","h5attachupload","at"],getter:function(a){return[].concat(a)}},sendPath:"/Feed/Reply",getReplyPath:"/Feed/GetFeedReplyByID",defaultRequestData:{value:{},getter:function(a){return _.isFunction(a)?a():a}},replyDefaultRequestData:null,detailDefaultRequestData:{value:{},getter:function(a){return _.isFunction(a)?a():a}},replyCb:function(a){a.success&&this.get("listOpts")&&this.addNewReply(a.value)},bbarTpl:'<span class="fs-reply-send-sms label-for"><input type="checkbox" name="send_sms" />&nbsp;<label>立即发送短信息给：<em class="user-name">xx</em></label></span>',submitText:"回复",triggerText:"回复",placeholder:"添加回复...",defaultContent:"",withMedia:!0,listOpts:{listPath:"/Feed/GetFeedReplysByFeedID",withPagination:!1,activePageNumber:1,replyListCb:e.EMPTY_FN}},events:{"click .fs-reply-sub":"reply","click .new-group-wrapper":"newgrouptoggle"},newgrouptoggle:function(){this.element.find(".newgroup").toggleClass("cur")},setup:function(){var a=q.superclass.setup.apply(this,arguments);return this._bindEvents(),this.items=[],a},_getItemEl:function(a){return $(a).closest(".fs-reply-item")},_renderEl:function(){this.element.addClass("fs-reply").hide(),this._renderHtml()},_initPagination:function(){var a,b=this,c=this.element,d=$(".fs-reply-list",c),e=this.get("listOpts");$('<div class="fs-reply-pagination"></div>').insertAfter(d),$('<div class="fs-reply-pagination"></div>').insertBefore(d),a=$(".fs-reply-pagination",c),this.paginations=[],a.each(function(){var a=new j({element:$(this),pageSize:10,activePageNumber:e.activePageNumber||1}).on("page",function(c){_.each(b.paginations,function(b){b!==a&&b.set("activePageNumber",c)}),b._renderReplyList()}).render();b.paginations.push(a)})},_initReplyListSummary:function(){var a,b=this.element,c=$(".fs-reply-list",b);a=$('<div class="fs-reply-list-summary"></div>'),a.html('后面还有<span class="num">0</span>条回复，<a class="jump-to-detail-l" href="#stream/showfeed" title="">点击查看</span> >>'),a.hide().insertAfter(c)},_setTotalSize:function(a){var b=this.paginations;_.each(b,function(b){b.setTotalSize(a)})},show:function(){var a,b=this.element,c=this.get("defaultContent");this.rendered||this.render(),b.show(),a=$(".fs-reply-input",b),a.is(":visible")&&(a.val(c),h.setCursorPositionEnd(a),a.trigger("autosize.resize")),this.trigger("show")},hide:function(){var a=this.element;a.hide(),this._emptyList(),this.trigger("hide")},refresh:function(){var a=this.paginations[0],b=a.get("activePageNumber");1!=b?a.jump(1):this._renderReplyList()},clearSubmit:function(){var a=$(".fs-reply-submit-box",this.element),b=$(".fs-reply-input",a),c=$(".fs-reply-media",a),d=c.data("media");b.val("").trigger("autosize.resize"),d.resetAll(),d.enableAction("h5imgupload"),d.enableAction("h5attachupload")},_bindEvents:function(){var a=this,b=this.element;this.on("show",function(){a.get("listOpts")&&this._renderReplyList()}),this.get("trigger").addClass("fs-reply-trigger").on("click",function(c){c.preventDefault(),b.is(":visible")?a.hide():a.show()})},_getInputTpl:function(){var a='<div class="fs-reply-input-wrapper"><fieldset><div class="fs-reply-input-inner"><textarea class="fs-reply-input" placeholder="'+this.get("placeholder")+'">'+this.get("defaultContent")+"</textarea>"+"</div>"+"</fieldset>"+'<div class="fs-reply-media"></div>'+'<div class="fs-reply-bbar fn-clear">'+'<div class="fs-reply-bbar-l">'+this.get("bbarTpl")+"</div>"+'<div class="fs-reply-bbar-r"><button type="button" class="fs-reply-sub button-green">'+this.get("submitText")+"</button></div>"+"</div>"+"</div>";return a},_getGroupTpl:function(){var a='<div class="newgroup"><div class="arrow"></div><div class="info">新增同事范围<span class="num">8</span>人：<span class="man">Lucy</span></div></div>';return a},_updateGroupInfo:function(a,b){var c,d,e,f,g,i=this,j=this.element,k=$(".newgroup",j),l=$(".num",k),m=$(".man",k);b?(g=a,h.api({url:"/Feed/GetAddAtEmpRanges",data:{feedID:g,isGetRangeData:!0},success:function(a){var b,c;a.success&&(b=a.value,c=b.addEmployees,c.length>0&&(f=c.join("、")+"。",e=c.length,e>0&&k.show(),l.text(e),m.text(f),i.trigger("addatrange",b)))}})):(c=a.value,d=c.addEmployees,e=d.length,f=d.join("、")+"。",e>0&&k.show(),l.text(e),m.text(f))},_renderHtml:function(){var a=this.element;return a.html('<div class="new-group-wrapper"></div><div class="fs-reply-main-wrapper fs-reply-submit-box">'+this._getInputTpl()+"</div>"),this.get("listOpts")&&($(".new-group-wrapper",a).html(this._getGroupTpl()),$('<div class="fs-reply-list-wrapper"><div class="list-loading"><span class="icon-loading"><img src="'+e.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span></div><div class="fs-reply-list"></div></div>').appendTo(a)),this._renderInput(),this._renderMedia(),a},_renderReplyList:function(){var a,b,c,d,e=this,f=this.element,g=$(".fs-reply-list",f),i=this.get("trigger"),j=$(".num",i),k={},l=this.get("listOpts"),m=this.get("triggerText");l.withPagination?(b=this.paginations[0],c=b.get("pageSize"),d=b.get("activePageNumber")):(a=$(".fs-reply-list-summary",f),c=10,d=1),a&&a.hide(),k=_.extend(k,this.get("defaultRequestData")),k=_.extend(k,{pageSize:c,pageNumber:d}),this._emptyList(),this._showListLoading(),this._replyListXhr&&this._replyListXhr.abort(),this._replyListXhr=h.api({data:k,type:"get",url:l.listPath,success:function(b){var c,d=new p,f=0,h=0;b.success&&(e._updateGroupInfo(b),_.each(b.value.items,function(a){a.feedType=b.value.feedType}),c=d.parse(b),_.each(c,function(a){var b=new n({model:new o(a),replyCb:function(a){a.success&&e.get("listOpts")&&e.addNewReply(a.value)},hideReplyRef:!0}).render();b.$el.appendTo(g),e.items.push(b)}),f=b.value.totalCount,l.withPagination?e._setTotalSize(b.value.totalCount):(h=f-10,h>0?($(".num",a).text(h),$(".jump-to-detail-l",a).attr("href","#stream/showfeed/=/id-"+c[0].feedID+"/pn-2"),a.show()):a.hide()),f>0&&(j.length>0?j.text(f):i.html(m+'(<span class="num">'+f+"</span>)")),e._hideListLoading(),l.replyListCb&&l.replyListCb.call(e,b,k))}},{mask:i})},_renderInput:function(a){var b,c,d=this.element,e=$(a);b=_.isUndefined(a)?$(".fs-reply-main-wrapper .fs-reply-input",d):$(".fs-reply-input",e),c=new l({element:b}),h.placeholder(b),b.keydown(function(a){27==a.keyCode&&a.preventDefault()}),b.data("atInput",c)},_renderMedia:function(a){var b,c,d,e=this.element,f=$(a);_.isUndefined(a)?(b=$(".fs-reply-main-wrapper .fs-reply-media",e),c=$(".fs-reply-main-wrapper .fs-reply-input",e)):(b=$(".fs-reply-media",f),c=$(".fs-reply-input",f)),d=new m({element:b,limitUploadSingle:!0,action:this.get("publishAction"),actionOpts:{at:{inputSelector:c},h5imgupload:{limitUploadSingle:!1}}}),b.data("media",d),this.get("withMedia")||b.addClass("fn-hide-abs")},_emptyList:function(){var a=this.element,b=$(".fs-reply-list",a),c=this.items;_.each(c,function(a){a.destroy&&a.destroy()}),this.items=[],b.empty()},_showListLoading:function(){var a=(this.loading,this.element),b=$(".fs-reply-list-wrapper .list-loading",a);b.show()},_hideListLoading:function(){var a=this.element,b=$(".fs-reply-list-wrapper .list-loading",a);b.hide()},replyValid:function(){var a=$(".fs-reply-submit-box",this.element).eq(0),b=$(".fs-reply-input",a),c=this.getReplyRequestData(),d=!0;return 0==c.replyContent.length?(h.showInputError(b.closest(".fs-reply-input-inner")),d=!1):c.replyContent.length>2e3?(h.alert("发送内容不超过2000字，目前已超出<em>"+(c.replyContent.length-2e3)+"</em>个字"),d=!1):d},getReplyRequestData:function(){var a,b=$(".fs-reply-submit-box",this.element),c=$(".fs-reply-media",b),d=c.data("media"),e={},f=[];return _.extend(e,this.get("defaultRequestData")),e.replyContent=_.str.trim($(".fs-reply-input",b).val()),e.fileInfos=[],a=d.getUploadValue(),_.each(a,function(a){"img"==a.uploadType?e.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&e.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),e.fileInfos.length>0&&0==e.replyContent.length&&(f=h.getAttachTypeName(e.fileInfos),f.length>0&&(e.replyContent=f.length>2?"分享"+f.join("、"):f.length>1?"分享"+f.join("和"):"分享"+f[0])),e},reply:function(a){var b,c,d,e,f=this,g=$(a.currentTarget),i=$(".fs-reply-submit-box",this.element),j=$(".fs-reply-input",i);this.replyValid()&&(c=$(".fs-reply-media",i),d=c.data("media"),d.send(function(a,c){var d=function(){h.api({type:"post",data:b,url:f.get("sendPath"),success:function(b){b.success&&f.clearSubmit(),a(),f.get("replyCb").call(f,b)},error:function(){a(),h.alert("系统繁忙，请稍后重试。")}},{submitSelector:g})};b=f.getReplyRequestData(),_.isFunction(f.get("replyDefaultRequestData"))?_.extend(b,f.get("replyDefaultRequestData").call(f,b)):_.extend(b,f.get("replyDefaultRequestData")),e=h.getAtFromInput(j),e.length>0&&b.feedID?h.api({url:"/Feed/SendFeedReplyAtEmpCheck",data:{feedID:b.feedID,replyContent:b.replyContent},success:function(a){var b,e=!1,f="回复中提到的员工：";a.success&&(b=a.value,e=!b.value,e?(f+=b.value1+"不在信息的原始范围中，是否要添加？添加后他们将能看到信息的原文和所有该信息的回复。",h.confirm(f,"添加范围提示",function(){d()},{onCancel:function(){c.hide()}})):d())}}):d()},i)),a.stopPropagation()},addNewReply:function(a){var b=this,c=this.element,d=$(".fs-reply-list",c),e=this.get("trigger"),f=this.get("triggerText"),g=$(".num",e),i=this.get("listOpts"),j={feedReplyID:a};_.extend(j,this.get("detailDefaultRequestData")),h.api({type:"get",data:j,url:this.get("getReplyPath"),success:function(a){var c,h=new p;a.success&&(c=h.parse(a),_.each(c,function(a){var c=new n({model:new o(a),replyCb:function(a){a.success&&b.get("listOpts")&&b.addNewReply(a.value,a.feedType)},hideReplyRef:!0}).render(),e=c.$el;e.prependTo(d),b.items.push(c)}),i.withPagination&&b._setTotalSize(b.paginations[0].get("totalSize")+1),g.length>0?g.text(parseInt(g.text())+1):e.html(f+'(<span class="num">1</span>)'),b._updateGroupInfo(c[0].feedID,!0))}})},render:function(){var a=this.get("listOpts"),b=q.superclass.render.apply(this,arguments);return this._renderEl(),a&&(a.withPagination?this._initPagination():this._initReplyListSummary()),b},_onRenderFeedOpts:function(){},destroy:function(){var a,b=this.element;return $(".fs-reply-input",b).each(function(){var a=$(this).data("atInput");a&&a.destroy()}),$(".fs-reply-media",b).each(function(){var a=$(this).data("media");a&&a.destroy()}),this.items=[],_.each(this.paginations,function(a){a.destroy()}),this.paginations=[],this._replyListXhr&&this._replyListXhr.abort(),this._replyListXhr=null,a=q.superclass.destroy.apply(this,arguments)}});c.exports=q});