/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/fs-reply/fs-reply-list",["modules/publish/publish","modules/card-reply/feed-reply","modules/feed-list/feed-list-helper","modules/feed-list/fl-util","modules/fs-reply/fs-reply.html","uilibs/pagination","modules/fs-attach/fs-attach-preview","modules/fs-attach/fs-attach-file-preview","spin","moment","util","uilibs/audio-player"],function(a,b,c){function d(a){var b={};return b=_.extend(b,I.common(a)),b.originData=a,b}var e,f,g,h,i=window,j=i.FS,k=a("modules/publish/publish"),l=a("modules/card-reply/feed-reply.js"),m=a("modules/feed-list/feed-list-helper"),n=a("modules/feed-list/fl-util"),o=a("modules/fs-reply/fs-reply.html"),p=a("uilibs/pagination"),q=a("modules/fs-attach/fs-attach-preview"),r=a("modules/fs-attach/fs-attach-file-preview"),s=(a("spin"),a("moment")),t=a("util"),u=k.mediaMaker,v=k.atInput,w=t.getContactData(),x=w.u,y=$(o).filter(".myreply-list-item").html(),z=m.feedContentFormat;m.picturesFormat;var A=m.filesFormat,B=m.feedContentFormat_;new l;var C=(new q).render(),D=r.FileReader,E=new D,F=a("uilibs/audio-player"),G=w.u;h=Backbone.Model.extend({defaults:{}});var H=function(a,b){var c={},d="",a=[].concat(a),e=a.length,f=a[0],g="",h=b,i=e-h;if(0==e&&(c.feedPic=""),1==e&&(c.feedPic='<div class="feed-img-only"><div class="img-num"><img class="feed-img-item" src="'+t.getDfLink(f.attachPath+"3",f.attachName,!1,"jpg")+'"/></div></div>'),e>1&&h>=e)_.each(a,function(a){d+='<div class="img-warp img-num"><img class="feed-img-item" src="'+t.getDfLink(a.attachPath+"3",a.attachName,!1,"jpg")+'"/></div>'}),c.feedPic='<div class="feed-img-many fn-clear">'+d+"</div>";else if(e>h){g='<div class="img-num"><div class="feed-img-item more-link">更多'+i+"张</div></div>";for(var j=0;h-2>=j;j++)d+='<div class="img-warp img-num"><img class="feed-img-item" src="'+t.getDfLink(a[j].attachPath+"3",a[j].attachName,!1,"jpg")+'"/></div>';c.feedPic='<div class="feed-img-many fn-clear">'+d+g+"</div>"}return c},I={common:function(a){var b={};b.replyContent=a.replyContent||"",b.feedID=a.feedID||"",b.feedReplyID=a.feedReplyID||"",b.senderId=a.sender&&a.sender.employeeID||"",b.feedsenderId=a.feedSender&&a.feedSender.employeeID||"",b.profileImage=a.sender&&a.sender.profileImage||"",b.sendername=a.sender&&a.sender.name||"";var c=a.replyToReplyID;G.id==b.senderId&&(b.sendername="我"),b.feedSenderName=a.feedSender&&a.feedSender.name||"",b.feedSenderName='<a href="#profile/=/empid-'+b.feedsenderId+'">'+b.feedSenderName+"</a>",c>0?b.feedSenderName='<a href="#profile/=/empid-'+a.replyToEmployee.employeeID+'">'+a.replyToEmployee.name+"</a>":b.feedSenderName.length>0&&G.id==b.feedsenderId&&(b.feedSenderName="我"),b.feedText=a.feedText||"",b.feedPic=a.feedPic||"",b.feedFiles=a.feedFiles||"",b.feedTypeDescription=a.feedTypeDescription||"",b.createTime=a.createTime||"",b.sourceDescription=a.sourceDescription||"",b.feedContent=a.feedContent,b.replyToContent=a.replyToContent,b.profileImage=t.getAvatarLink(b.profileImage,2),_.extend(b,H(a.pictures||[],5)),_.extend(b,A(a.files||[],a));var d,e,f=a.audio;f?(e=f.attachPath,e=t.getFileNamePath(e)+".mp3",e=t.getDfLink(e,"",!1,""),d=f.attachSize,d=d>60&&3600>d?parseInt(d/60)+":"+parseInt(60*(parseFloat(d/60)-parseInt(d/60))):"00:"+parseInt(d),b.audioBtn='<div class="reply-audio-open-btn audio-btn">('+d+")</div>",b.attachPath=e,b.audioWarp=' <div class="audio-warp"><div class="audio-box"></div></div>'):(b.audioBtn="",b.attachPath="",b.audioWarp="");var g=t.getDateSummaryDesc(s.unix(b.createTime),s.unix(a.serviceTime),1);b.createTime=g;var h=a.feedReplyLikeCount,i=a.isAlreadyLike,j="",k="取消赞",l="cur",m='(<span class="likecountnum">'+h+"</span>)",n=a.feedReplyLiker,o="";o=h>32?"":"disable";var p,q='<div class="bottom-info fn-clear fn-hide" pagenumber="1"><div class="l"><span class="count-number">'+a.feedReplyLikeCount+'</span>个人赞过</div><div class="r"><em class="ico_page_prev disable"><</em>&nbsp;&nbsp;<em class="ico_page_next '+o+'">></em></div></div>',r="",u="",v="",w="";n&&(_.some(n,function(a,b){var c=a.name,d=t.getAvatarLink(a.profileImage,"2"),e=a.employeeID;32>b&&(u+='<a href="#profile/=/empid-'+e+'" class="js-empids" title="'+c+'"><img alt="'+c+'" src="'+d+'"></a>')}),n.length>5?(v='<a href="javascript:;" title="更多" class="islike-tip-more-btn"></a>',p=200):(v='<a href="javascript:;" title="更多" class="islike-tip-more-btn hide"></a>',p=40*n.length)),i||(k="赞",l="",m="",r=""),r='<div class="reply-islike-tip" style="display:none;width: '+p+'px"><div class="toparrow"> <em>◆</em> <span>◆</span> </div><span class="list-warp">'+u+"</span>"+v+q+"</div>",h>0?(m='(<span class="likecountnum">'+h+"</span>)",w=""):(r="",m="",w="fn-hide"),j='<span title="'+k+'" class="islike-btn aj-reply-fn-com-btn '+l+'" title="'+k+'"><b></b> <a class="reply-likecount '+w+'" href="javascript:void(0);">'+m+'</a> </span> <i class="S_txt3">|</i>',b.islike=j,b.liketip=r,b.operationType="";var x="";switch(b.isagreeImg="",a.feedType){case 1:b.operationType="";break;case 2:t.getPlanOperationType(a.operationType)&&(b.operationType="，"+t.getPlanOperationType(a.operationType));break;case 3:t.getWorkOperationTypeName(a.operationType)&&(b.operationType="，"+t.getWorkOperationTypeName(a.operationType));break;case 4:t.getApproveOperationTypeName(a.operationType)&&(b.operationType="，"+t.getApproveOperationTypeName(a.operationType)),x=1==a.operationType?'<img src="../../html/fs/assets/images/agree.gif" alt="" class="approve-isagree">':2==a.operationType?'<img src="../../html/fs/assets/images/unagree.gif" alt="" class="approve-isagree">':"",b.isagreeImg=x;break;default:b.operationType=""}b.source=b.sourceDescription?1==a.source?"":"，来自"+t.getSourceNameFromCode(a.source):"";var y="";_.each(a.replyContent,function(a){y+=z(a)}),b.feedText=y;var C='<div class="img-new"></div>';return b.newico=a.isUnRead?C:"",b.feedFormatContent=B(300,a),a.replyToReplyID>0?(b.feedContent=b.replyToContent,b.feedTypeDescription="回复"):b.feedTypeDescription=t.getFeedTypeName(a.feedType),b}};f=Backbone.Collection.extend({sync:function(a,b,c){var d=c.data||{};c.data=_.extend({circleID:0,subType:0,feedType:0,keyword:"",pageSize:30,pageNumber:2},d),Backbone.sync("read",b,_.extend(c,{apiCb:function(){}}))},parse:function(a){var b=a.value.items,c=a.value,e=[];return _.each(b,function(b,f){b.serviceTime=a.serviceTime,_.isUndefined(b.feedType)&&(b.feedType=c.feedType),_.isUndefined(b.feedSender)&&(b.feedSender=c.feedSender),_.isUndefined(b.feedExtendData)&&(b.feedExtendData=c.feedExtendData),e[f]=d(b)}),e}}),g=Backbone.View.extend({tagName:"div",className:"reply-item fs-list-item card-border-rad",template:_.template(y),hideReplyBtn:!1,events:{"click .aj-Reply":"reply","click .feed-reply-content-visible-h":"frcVisibleH","click .item-media .feed-img-item":"_previewImg","click .item-media .feed-attach .attach-preview-l":"_previewAttach","click .item-media .feed-attach .attach-play-l":"_playAttach","click .reply-audio-open-btn":"_openAudio","click .reply-audio-close-btn":"_closeAudio","mouseenter .islike-btn":"enterIsLike","mouseleave .islike-btn":"leaveIsLike","mouseenter .reply-islike-tip":"enterIsTipLike","mouseleave .reply-islike-tip":"leaveIsTipLike","click .islike-tip-more-btn":"moreTip","click .islike-btn":"sendIsLike","click .reply-islike-tip .ico_page_prev":"likeTipPagePrev","click .reply-islike-tip .ico_page_next":"likeTipPageNext"},frcVisibleH:function(a){var b=this.model,c=b.get("feedFormatContent"),d=c.leftHtml,e=this.$el,f=$(".feed-summary-text",e),g=$(".feed-left-text",e),h=$(".feed-reply-content-visible-h",e),i=$(".feed-content-ellipsis",e);0==g.length?(g=$('<span class="feed-left-text">'+d+"</span>"),g.insertAfter(f),h.text("收起正文"),i.hide()):g.is(":visible")?(g.hide(),h.text("展开正文，（共"+c.feedWordNum+"个字）"),i.show()):(g.show(),h.text("收起正文"),i.hide()),a.preventDefault()},likeTipPagePrev:function(a){var b=$(a.currentTarget),c=b.closest(".reply-item").find(".reply-islike-tip"),d=$(".bottom-info",c),e=Number(d.attr("pagenumber"));b.is(".disable")||this.reloadLikeTipData(c,e-1)},likeTipPageNext:function(a){var b=$(a.currentTarget),c=b.closest(".reply-item").find(".reply-islike-tip"),d=$(".bottom-info",c),e=Number(d.attr("pagenumber"));b.is(".disable")||this.reloadLikeTipData(c,e+1)},leaveIsLike:function(a){var b=$(a.currentTarget);b.closest(".reply-item");var c=function(){$(".reply-islike-tip").hide()};this.likeTimer=setTimeout(c,100)},enterIsLike:function(a){var b=$(a.currentTarget),c=b.closest(".reply-item"),d=c.find(".item-func"),e=$(".reply-islike-tip",c),f=$(".islike-tip-more-btn",c),g=$(".js-empids",c),h=$(".bottom-info",c),i=40;$(".reply-islike-tip").hide(),h.hide(),g.length>8?(g.show().eq(6).nextAll().hide(),i=320,f.show()):(f.hide(),g.show(),i=40*g.length),e.width(i).height("auto");var j=d.position();e.css("top",j.top+45).show(),clearTimeout(this.likeTimer)},sendIsLike:function(a){var b=$(a.currentTarget),c=this,d=b.closest(".reply-item"),e=b.closest(".item-func").find(".reply-islike-tip"),f=b.closest(".fs-list-item").find(".item-face").attr("feedid"),g=b.closest(".reply-item").data("feedreplyid"),h=!0,i=b.is(".cur");i?(h=!1,b.removeClass("cur"),b.attr("title","赞")):(h=!0,b.addClass("cur"),b.attr("title","取消赞")),t.api({url:"/FeedExtend/SetFeedReplyLike",type:"post",data:{feedID:f,feedReplyID:g,isLike:h},dataType:"json",success:function(a){a.success&&c.renderIslikeList(d,e,f,1)}})},enterIsTipLike:function(){clearTimeout(this.likeTimer)},leaveIsTipLike:function(a){$(a.currentTarget);var b=function(){$(".reply-islike-tip").hide()};this.likeTimer=setTimeout(b,0)},reloadLikeTipData:function(a,b){var c=$(".list-warp",a),d=a.closest(".reply-item").data("feedreplyid"),e=$(".bottom-info",a);a.height(191),t.api({url:"/FeedExtend/GetFeedReplyLikersOfFeedID",type:"get",data:{feedReplyID:d,pageSize:32,pageNumber:b},dataType:"json",success:function(a){var d="";a.value.totalCount||0;var f=a.value.pageCount||0,g=a.value.likers;a.success&&(_.each(g,function(a){var b=a.name,c=t.getAvatarLink(a.profileImage,2),e=a.employeeID;d+='<a href="#profile/=/empid-'+e+'" title="'+b+'" class="js-empids"><img alt="'+b+'" src="'+c+'"></a>'}),c.html(d),e.attr("pagenumber",b),1>=b?$(".ico_page_prev",e).addClass("disable"):$(".ico_page_prev",e).removeClass("disable"),b>=f?$(".ico_page_next",e).addClass("disable"):$(".ico_page_next",e).removeClass("disable"))}})},moreTip:function(a){var b=$(a.currentTarget),c=b.closest(".reply-item"),d=$(".reply-islike-tip",c),e=$(".islike-tip-more-btn",c),f=$(".bottom-info",c),g=$(".js-empids",c);d.width(320).height(191),g.show(),f.show(),e.hide()},renderIslikeList:function(a,b,c){$(".item-func",a);var d=a.data("feedreplyid"),e=$(".reply-likecount",a);t.api({url:"/FeedExtend/GetFeedReplyLikersOfFeedID",type:"get",data:{feedReplyID:d,pageSize:32,pageNumber:1},dataType:"json",success:function(d){var f=d.value.totalCount||0,g=d.value.pageCount||0,h=d.value.likers,i=h.length,j="",k="";k=g>1?"":"disable";var l='<div class="bottom-info fn-clear fn-hide" pagenumber="1"><div class="l"><span class="count-number">'+f+'</span>个人赞过</div><div class="r"><em class="ico_page_prev disable"><</em>&nbsp;&nbsp;<em class="ico_page_next '+k+'">></em></div></div>',m="";if(d.success)if(i>0){var n;_.each(h,function(a){var b=a.name,c=t.getAvatarLink(a.profileImage,2),d=a.employeeID;m+='<a href="#profile/=/empid-'+d+'" title="'+b+'" class="js-empids"><img alt="'+b+'" src="'+c+'"></a>'}),e.html('<span class="likecountnum">('+d.value.totalCount+")</span>").show(),h.length>8?(j='<a href="javascript:;" title="更多" class="islike-tip-more-btn"></a>',n=320):(j='<a href="#stream/showfeed/=/id-'+c+'/open-like" title="更多" class="islike-more hide"></a>',n=40*h.length),a.find(".reply-islike-tip")[0]?($(".reply-islike-tip",a).html('<div class="toparrow"> <em>◆</em> <span>◆</span> </div><span class="list-warp">'+m+"</span>"+j+l),$(".reply-islike-tip",a).width(n)):a.append('<div class="reply-islike-tip" pagenum="1" style="display:block;width: '+n+'px"><div class="toparrow"> <em>◆</em> <span>◆</span> </div><span class="list-warp">'+m+"</span>"+j+l+"</div>");var o=$(".reply-islike-tip .islike-tip-more-btn",a),p=$(".js-empids",a);p.length>8?(p.show().eq(6).nextAll().hide(),o.show()):(o.hide(),p.show()),b=a.find(".reply-islike-tip");var q=a.find(".item-func"),r=q.position();b.css("top",r.top+45).show(),b.show()}else e.html("").hide(),a.find(".reply-islike-tip").remove()}})},_openAudio:function(a){var b=$(a.currentTarget),c=this.$el,d=$(".audio-warp",c),e=this.model,f=e.get("attachPath"),g=e.get("originData");b.hide(),d.show(),this.audioPlayer||(this.audioPlayer=new F({element:$(".audio-box",d),audioSrc:f,length:g.audio.attachSize,themeStyle:4}),this.compStore.push(this.audioPlayer)),this.audioPlayer.play()},_renderAudioCpt:function(){var a=this.model,b=a.get("originData"),c=a.get("attachPath"),d=$(".audio-warp",this.$el);b.audio&&(this.audioPlayer||(this.audioPlayer=new F({element:$(".audio-box",d),audioSrc:c,length:b.audio.attachSize,themeStyle:4}),this.compStore.push(this.audioPlayer)))},_previewImg:function(a){var b=this.model,c=b.get("originData"),d=c.pictures,e=[],f=$(a.currentTarget),g=f.closest(".img-num").index();_.each(d,function(a,b){e[b]={source:2,refId:c.feedReplyID||0,previewPath:a.attachPath+"2",originPath:a.attachPath+"1",thumbPath:a.attachPath+"3",createTime:a.createTime,fileName:a.attachName,fileSize:a.attachSize}}),C.preview({type:"img",data:e,refId:c.feedID,belongToType:"reply",activeIndex:g}),a.preventDefault(),a.stopPropagation()},_previewAttach:function(a){var b,c=this.model,d=c.get("originData"),e=d.files,f=$(a.currentTarget),g=f.closest("dl"),h=g.attr("attachid");b=_.find(e,function(a){return a.attachID==h}),E.readFile({fileId:b.attachID,fileName:b.attachName,filePath:b.attachPath}),a.preventDefault(),a.stopPropagation()},_playAttach:function(a){var b,c=this.model,d=c.get("originData"),e=d.files,f=$(a.currentTarget),g=f.closest("dl"),h=g.attr("attachid");b=_.find(e,function(a){return a.attachID==h}),C.preview({type:"audio",data:[{previewPath:j.BLANK_IMG,originPath:b.attachPath,thumbPath:j.BLANK_IMG,createTime:b.createTime,fileName:b.attachName,fileSize:b.attachSize,fileId:b.attachID,employeeName:d.sender.name}],refId:d.feedReplyID,belongToType:t.getAttachSourceName(b.source)}),a.preventDefault(),a.stopPropagation()},reply:function(a){this.options;var b,c=this.model,d=c.get("originData"),e=$(a.currentTarget),f=e.closest(".reply-item"),g=$(".feed-reply",f);this.replyFn||(this.replyFn=new J({model:c,itemV:this}),g.html(this.replyFn.el),this.replyFn.setupComponent()),b=$(".input-text",g),g.is(":visible")?(e.removeClass("fl-common-up-arrow"),g.hide()):(e.addClass("fl-common-up-arrow"),g.show(),b.val("回复@"+d.sender.name+"：").trigger("autosize.resize"),t.setCursorPositionEnd(b))},initialize:function(){this.compStore=[],this.listenTo(this.model,"change",this.render)},render:function(){var a=this.model.toJSON();return this.$el.html(this.template(a)),this.$el.data("feedreplyid",a.feedReplyID),this.options.hideReplyRef&&$(".myreply-content",this.$el).hide(),this.options.hideReplyBtn&&$(".aj-Reply",this.$el).hide(),this._renderAudioCpt(),this},destroy:function(){_.each(this.compStore,function(a){a.destroy&&a.destroy()}),this.compStore=null,this.remove()}});var J=Backbone.View.extend({tagName:"div",className:"replyfn-item",template:_.template($(o).filter(".feed-reply-tpl").html()),events:{"click .f-submit":"submit","click .f-cancel":"cancel"},initialize:function(){var a=this.$el;this.render(),this.originData=this.model.toJSON().originData,this.itemV=this.options.itemV,this.mediaEl=$(".media",a),this.inputTextEl=$(".input-text",a),this.submitBtn=$(".f-submit",a)},setupComponent:function(){var a=this.$el,b=$(".input-text",a),c=$(".media",a);if(!this.media){var d=new u({element:c,action:["h5imgupload","h5attachupload","at"],actionOpts:{at:{inputSelector:b,spOpts:{data:[{title:"同事",type:"p",list:w.p},{title:"部门",type:"g",list:w.g}]}}}});if(this.media=d,!this.atInput){var e=new v({element:b,withAt:!0});this.atInput=e}}},setoData:function(){this.element;var a,b,c=this.inputTextEl.val(),d=this.model.get("feedID"),e=this.model.get("originData"),f=e.feedType,g=e.feedExtendData,h={},i=[],j=this.media.getUploadValue();return h.fileInfos=[],h.replyContent=_.str.trim(c),_.each(j,function(a){"img"==a.uploadType?h.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&h.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),h.fileInfos.length>0&&0==h.replyContent.length&&(i=t.getAttachTypeName(h.fileInfos),i.length>0&&(h.replyContent=i.length>2?"分享"+i.join("、"):i.length>1?"分享"+i.join("和"):"分享"+i[0])),h=_.extend({feedID:d,isSendSms:!1,feedType:f,replyContent:"",replyToEmployeeID:e.sender.employeeID,replyToReplyID:e.feedReplyID},h),3==f?(a=g.value1,b=g.value2):4==f&&(a=e.feedSender.employeeID,b=g.value1),h=_.extend(h,{feedSenderID:a,feedReceiverID:b})},send:function(){var a,b,c=this.$el,d=this.inputTextEl,e=this;this.media.send(function(c,f){var g=function(){t.api({type:"post",data:a,url:"/Feed/Reply",success:function(b){b.success&&(e.cancel(),e.media.resetAll(),e.itemV.options.replyCb&&e.itemV.options.replyCb.call(e.itemV,b,a),n.showAlertDialog("回复成功")),c()},error:function(){c(),t.alert("系统繁忙，请稍后重试。")}},{submitSelector:e.submitBtn})};a=e.setoData(),b=t.getAtFromInput(d),b.length>0&&a.feedID?t.api({url:"/Feed/SendFeedReplyAtEmpCheck",data:{feedID:a.feedID,replyContent:a.replyContent},success:function(a){var b,c=!1,d="回复中提到的员工：";a.success&&(b=a.value,c=!b.value,c?(d+=b.value1+"不在信息的原始范围中，是否要添加？添加后他们将能看到信息的原文和所有该信息的回复。",t.confirm(d,"添加范围提示",function(){g()},{onCancel:function(){f.hide()}})):g())}}):g()},c)},submit:function(){this.isEmpty(this.inputTextEl)&&this.send()},cancel:function(){this.$el.parent().hide(),this.itemV.$el.find(".aj-Reply").removeClass("fl-common-up-arrow"),this.inputTextEl.val("")},formatData:function(a){var b={};return _.extend(b,a),b.profileImage=x.profileImage||"",b},render:function(){var a=this.$el,b=this.template,c=this.model.toJSON().originData;return a.html(b(this.formatData(c))),this},isEmpty:function(a){var b=a.val(),c=!0;return b=$.trim(b),""==b&&(t.showInputError(a),c=!1),b.length>2e3&&(t.alert("发送内容不超过2000字，目前已超出<em>"+(b.length-2e3)+"</em>个字"),c=!1),c},destroy:function(){this.remove()}});e=function(a){a=_.extend({element:null,pagSelector:null,pagOpts:{pageSize:45,totalSize:0,visiblePageNums:7},hideReplyBtn:!1,listPath:"/feed_html/getFeedReplysOfAtMe",defaultRequestData:{},replyCb:j.EMPTY_FN,searchOpts:{inputSelector:null,btnSelector:null},listEmptyText:"暂无记录"},a||{}),this.opts=a,this.element=$(a.element),this.pagEl=$(a.pagSelector),this.items=[],this.list=new f,this.pagination={},this.tempRequestData={},this.init()},_.extend(e.prototype,{init:function(){var a,b=this,c=this.opts,d=this.element,e=this.list;d.addClass("fs-reply-list").html('<div class="fs-reply-list-inner"></div>'),a=$(".fs-reply-list-inner",d),e.on("add",function(e,f){var h,i=f.indexOf(e);h=new g({model:e,hideReplyBtn:c.hideReplyBtn,withReplySuccessTip:!0,replyCb:function(a){c.replyCb.call(this,a)}}).render(),$(".fs-reply-list-inner",d)[0]?a=$(".fs-reply-list-inner",d):($(".list-empty-tip",d)[0]?$(".list-empty-tip",d).before('<div class="fs-reply-list-inner"></div>'):d.append('<div class="fs-reply-list-inner"></div>'),a=$(".fs-reply-list-inner",d)),0==i?h.$el.prependTo(a):h.$el.appendTo(a),b.items.push(h);try{var j=window.store.get("receivedreplies");j=j||"",0==i&&(j=j+"element-"+a.parent().attr("class")+","+a.parent().parent().attr("class")+","+a.parent().parent().parent().attr("class")+ +new Date+"-"),j.length>500&&(j=j.substring(j.length-500)),window.store.set("receivedreplies",j)}catch(k){}});var f=this.pagEl,h=new p(_.extend({element:f},c.pagOpts));h.on("page",function(){b.empty();try{var a=window.store.get("receivedreplies");a=a||"",a=a+"pageevent-"+ +new Date+"-",a.length>500&&(a=a.substring(a.length-500)),window.store.set("receivedreplies",a)}catch(c){}b.fetch()}),h.render(),b.pagination=h,c.searchOpts&&c.searchOpts.inputSelector&&this._searchBarInit(),c.searchSelect&&c.searchSelect.on("searchSelectOk",function(a){a=c.searchSelect.getRequestData(),delete a.employeeIDs,b.reload(a)}),this._initListEmptyTip(),this._regEvents()},_searchBarInit:function(){var a,b,c,d=this,e=this.opts,f=e.searchOpts,g=this.element,h=$(f.inputSelector),i=$(f.btnSelector),j=h.data("isInit");j||(b=$('<span class="empty-h">&#10005;</span>'),c=$('<span class="list-search-input-wrapper"></span>'),h.wrap(c),c=h.closest(".list-search-input-wrapper"),b.hide().appendTo(c),h.keydown(function(a){13==a.keyCode&&i.click()}).keyup(function(){var a=_.str.trim($(this).val());a.length>0?(b.show(),h.addClass("with-input-value")):(b.hide(),h.removeClass("with-input-value"))}),b.click(function(){h.val(""),h.removeClass("with-input-value"),b.hide()}),h.data("isInit",!0)),a=$('<div class="list-search-bar fn-clear"><span class="words"></span><span class="num">0</span>条记录<a class="btn-close" href="#" onclick="return false;"></a></div>'),a.hide().prependTo(g),a.on("click",".btn-close",function(b){var c=$(".list-empty-tip",g),e=$(".empty-h",h.closest(".list-search-input-wrapper"));h.val(""),h.removeClass("with-input-value"),d.opts.searchSelect&&(d.opts.searchSelect._clear(),d.opts.searchSelect.removeAllCondition()),e.hide(),a.hide(),c.hide(),d.reload({keyword:""}),b.preventDefault()}),this.searchBarEl=a},_searchBarDestroy:function(){var a,b,c=this.opts,d=c.searchOpts;this.searchBarEl&&(a=$(d.inputSelector),b=a.closest(".list-search-input-wrapper"),a.insertAfter(b),b.remove(),a.val("").unbind(),a.data("isInit",!1),this.searchBarEl.remove(),this.searchBarEl=null)},_updateSearchBarState:function(a,b){var c=this.element,d=$(".list-search-bar",c),e=$(".words",c),f=$(".num",d);c.hasClass("fs-reply-list")&&c.show();var g=!1;if(a.keyword.length>0&&(g=!0),this.opts.searchSelect){var h=this.opts.searchSelect.getRequestData();(h.employeeIDs.length||h.startTime||h.endTime)&&(g=!0)}if(g&&b.success){if(this.opts.searchSelect){var i=this.opts.searchSelect.getConditionWords();e.html(i)}else e.html("共搜到");return f.text(b.value.totalCount),d.show(),void 0}d.hide()},_updateSearchSelectStatus:function(){var a=this;if(this.opts.searchSelect){var b=this.opts.searchSelect.getConditionWords();b?(this.element.find(".fs-search-select-opts-area").remove(),this.element.prepend(b),$(this.element.find(".fs-search-select-opts-area")).on("click",".btn-close",function(){a.opts.searchSelect._clear(),a.opts.searchSelect.removeAllCondition(),a.reload()})):this.element.find(".fs-search-select-opts-area").remove()}},resetSearch:function(){var a=this.opts,b=a.searchOpts,c=$(b.inputSelector),d=c.closest(".list-search-input-wrapper"),e=$(".empty-h",d);e.click().hide(),this.searchBarEl&&this.searchBarEl.hide()},_initListEmptyTip:function(){var a=this.element,b=$('<div class="list-empty-tip"></div>'),c=this.opts,d=c.listEmptyText;b.html('<img src="'+j.BLANK_IMG+'" alt="loading" class="icon-empty" />&nbsp;&nbsp;<span class="empty-text">'+d+"</span>"),b.appendTo(a)},_updatelistStatus:function(a){var b,c=this.element,d=$(".list-empty-tip",c);a.success&&(b=a.value.totalCount,0==b?d.show():d.hide())},_hideEmptyTip:function(){var a=this.element,b=$(".list-empty-tip",a);b.hide()},_setTotalSize:function(a){this.pagination.setTotalSize(a)},_regEvents:function(){},setReplyBtnVisible:function(a){var b=this.opts;b.hideReplyBtn=!!a},fetch:function(){var a=this,b={},c=this.opts,d=this.pagination;b=_.extend({pageSize:d.get("pageSize"),pageNumber:d.get("activePageNumber")},b||{}),b=_.isFunction(c.defaultRequestData)?_.extend(c.defaultRequestData(),b):_.extend(c.defaultRequestData,b),b=_.extend(b,this.tempRequestData),this.opts.searchSelect&&(data=this.opts.searchSelect.getRequestData(),delete data.employeeIDs,data.keyword=$(this.opts.searchOpts.inputSelector).val(),b=_.extend(b||{},data)),this.tempRequestData={},this.showLoading(),this.list.fetch({url:c.listPath,data:b,success:function(b,c,d){var e;if(c.success){e=c.value,a._setTotalSize(e.totalCount),a.list.lastOriginData=c,a._updateSearchBarState(d.data,c),a._updatelistStatus(c),a.hideLoading();try{var f=window.store.get("receivedreplies");f=f||"",f=f+"success-"+ +new Date+"-",f.length>500&&(f=f.substring(f.length-500)),window.store.set("receivedreplies",f)}catch(g){}}}})},prependItem:function(a,b,c){var d=this,e={feedID:b,feedReplyID:a,feedType:c},f=this.list;t.api({type:"get",data:e,url:"/Feed/GetFeedReplyByID",success:function(a){if(a.success){var b=f.parse(a)[0];f.unshift(b),d._updatelistStatus(a)}}})},showLoading:function(){var a=this.loading,b=this.element,c=$(".list-loading",b);0==c.length&&(c=$('<div class="list-loading"></div>'),c.prependTo(b),c.html('<span class="icon-loading"><img src="'+j.BLANK_IMG+'" alt="loading" /></span>&nbsp;<span class="loading-text">正在加载，请稍候&#8230;</span>'),this.loading=a),c.show()},hideLoading:function(){var a=this.element,b=$(".list-loading",a);b.hide()},load:function(a){this.opts.searchSelect&&(data=this.opts.searchSelect.getRequestData(),delete data.employeeIDs,data.keyword=$(this.opts.searchOpts.inputSelector).val(),a=_.extend(a||{},data)),this._hideEmptyTip(),this.pagination.reset(),this.tempRequestData=a;try{var b=window.store.get("receivedreplies");b=b||"",b=b+"执行load跳第一页-"+ +new Date+"-",b.length>500&&(b=b.substring(b.length-500)),window.store.set("receivedreplies",b)}catch(c){}this.pagination.jump(1)},reload:function(a){this.list.lastOriginData=null,this.load(a)},empty:function(){var a=this.items,b=$(".fs-reply-list-inner",this.element);_.each(a,function(a){a.destroy&&a.destroy()}),b.empty()},destroy:function(){this._searchBarDestroy(),this.pagination.destroy(),this.pagination={},this.loading&&this.loading.stop(),this.empty(),this.list.lastOriginData=null,this.list=null,this.tempRequestData={},this.element.off(),this.element=null}}),_.extend(c.exports,{replyList:e,itemV:g,listC:f,itemM:h})});