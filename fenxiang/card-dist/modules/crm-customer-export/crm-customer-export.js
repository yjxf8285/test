/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-customer-export/crm-customer-export",["dialog","util","modules/crm-customer-export/crm-customer-export.html","modules/crm-select-colleague/crm-select-colleague","moment"],function(a,b,c){var d=a("dialog"),e=window,f=e.FS,g=a("util"),h=a("modules/crm-customer-export/crm-customer-export.html"),i=a("modules/crm-select-colleague/crm-select-colleague"),j=a("moment"),k=d.extend({attrs:{content:h,exportApi:"",isFirstChar:!1,width:480,title:"",hasBelongTo:!1,isMulti:!1,selectColleague:null,closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",belongTo:null,ownerName:"归属人",para:{employeeID:-1,keyword:"",isFirstChar:!1}},setup:function(){var a=k.superclass.setup.apply(this,arguments);return a},render:function(){var a=k.superclass.render.apply(this,arguments);return this._init(),a},_init:function(){var a=this.get("title"),b=this.get("hasBelongTo");$(".crm-customer-export-label-belong-to",this.element).text(this.get("ownerName")+"："),$(".crm-customer-export-title",this.element).text(a),b?$(".crm-customer-export-belong-to-tr",this.element).show():$(".crm-customer-export-belong-to-tr",this.element).hide(),this._initSelectColleague()},_initSelectColleague:function(){var a=this,b=new i({isMultiSelect:a.get("isMulti")?!0:!1,hasWorkLeaveBtn:!1,title:"选择"+this.get("ownerName")});b.on("selected",function(b){a._onColleagueSelect(b)}),a.set("selectColleague",b)},hide:function(){var a=k.superclass.hide.apply(this,arguments);return this.reset(),a},show:function(a){var b=k.superclass.show.apply(this,arguments);if(a){var c=this.get("para");c=_.extend(c,a),this.set("para",c)}return b},events:{"click .crm-customer-export-button-select":"_colleagueSelect","click .crm-customer-export-button-clear":"_colleagueClear","click .crm-customer-export-button-export":"_export"},_colleagueSelect:function(){this.get("selectColleague").show()},_onColleagueSelect:function(a){if(this.get("isMulti")){if(!a.length)return;var b=[];$.each(a,function(a,c){b.push(c.name)}),$(".crm-customer-export-belong-to",this.element).text(b.join(",")).attr("title",b.join(",")),this.set("belongTo",a)}else{if(!a)return;$(".crm-customer-export-belong-to",this.element).text(a.name),this.set("belongTo",a)}$(".crm-customer-export-button-clear",this.element).show()},_colleagueClear:function(){this.reset()},_export:function(){var a=this,b=this.get("belongTo"),c="",d=this.get("para");if(b)if(a.get("isMulti")){var e=[],h=[];$.each(b,function(a,b){e.push(b.name),h.push(b.employeeID)}),d.employeeIDs=h.join(",")}else d.employeeIDs=null,c=b.name,d.employeeID=b.employeeID;else delete d.employeeIDs;d.keyword=$(".crm-customer-export-keyword-input",this.element).val(),d.isFirstChar=this.get("isFirstChar"),g.api({url:this.get("exportApi"),type:"get",dataType:"json",data:d,timeout:12e4,success:function(b){if(b.success){var d=b.serviceTime,e=j.unix(d).format("YYYYMMDDHHmm");$(".crm-customer-export-download",a.element).attr("href",f.API_PATH+"/DF/GetTemp?id="+b.value+"&name="+e+"_"+encodeURI(c)+encodeURI(a.get("title"))+".xls&isAttachment=true"),$(".crm-customer-export-download",a.element).show()}}},{submitSelector:$(".crm-customer-export-button-export",this.element)})},setTitle:function(a){$(".crm-customer-export-title",this.element).text(a)},reset:function(){$(".crm-customer-export-belong-to",this.element).text(""),$(".crm-customer-export-keyword-input",this.element).val(""),this.set("belongTo",null),$(".crm-customer-export-button-clear",this.element).hide(),$(".crm-customer-export-download",this.element).hide()},destroy:function(){var a=k.superclass.destroy.apply(this,arguments);return a}});c.exports=k});