/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-customer-highseas/crm-customer-highseas",["modules/crm-customer-highseas/crm-customer-highseas.html","widget","util","datatable","moment","uilibs/pagination2","modules/crm-customerinsetting-edit/crm-customerinsetting-edit"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var f=a("modules/crm-customer-highseas/crm-customer-highseas.html"),g=a("widget"),h=a("util");a("datatable");var i=a("moment"),j=a("uilibs/pagination2"),k=a("modules/crm-customerinsetting-edit/crm-customerinsetting-edit"),l=g.extend({attrs:{element:null,aoColumns:[{mData:"customerID",sWidth:"26px",sClass:"td-checkbox-warp",bSortable:!1,mRender:function(a){var b='<div class="mn-checkbox-box checkbox-for-comtable">&nbsp;&nbsp;<span data-value="'+a+'" class="mn-checkbox-item"></span> </div>';return b}},{mData:"name",sWidth:"200px",sClass:"black-name crmtable-sort-name",bSortable:!0,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"fCustomerNo",sWidth:"100px",sClass:"black-name crmtable-sort-no",bSortable:!0,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"ownerName",sWidth:"100px",sClass:"black-name crmtable-sort-ownername",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"expireTime",sWidth:"120px",sClass:"crmtable-sort-expireTime",bSortable:!1,asSorting:["desc","asc"],mRender:function(a){if(0==a)return"";var b='<span title="'+i.unix(a).format("YYYY-MM-DD")+'">'+i.unix(a).format("YYYY-MM-DD")+"</span>";return b}},{mData:"remainingDays",sWidth:"120px",sClass:"crmtable-sort-remainingDays",bSortable:!1,mRender:function(a){var b="";return a>0&&(b='<span title="余'+a+'天">余'+a+"天</span>"),0>a&&(b='<span style = "color:red" title="超期'+Math.abs(a)+'天">超期'+Math.abs(a)+"天</span>"),b}},{mData:"createTime",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}],condition:{highSeasID:0,employeeID:-1,keyword:"",sortType:1,pageSize:15,pageNumber:0},oTable:null,firstLoad:!0,editDialog:null,overWriteRowClick:!1,highSeasPermissions:[],isMyHighSeas:!1,isHighSeaAdmin:!1,url:"/HighSeas/GetFCustomersHighSeasForManager"},events:{"click .crm-datatable th":"_crmTableSort","click .checkbox-selectall-btn":"_checkboxSelectall","click .mn-checkbox-item":"_checkOrNot"},setup:function(){var a=l.superclass.render.apply(this,arguments);return this._init(),a},_init:function(){this.element.html(f),this._initDataTabel(),this._initComponent(),this._initCustomerInSettingDialog()},_crmTableSort:function(a){var b=this;h.crmTableSortSet({element:$(".sort-select-list",this.$el),meEl:$(a.currentTarget),oThs:[{clasName:".crmtable-sort-name",sortType:[2,4]}],callback:function(a){b.refresh(a)}})},_initComponent:function(){var a=this.element,b=this,c=$(".pagination-wrapper",a),d=$(".sort-select-list",a);h.mnEvent(d,"change",function(a){h.mnSelect(d,"removeOption",2),b.get("oTable").fnSort([]),b.refresh({sortType:a})}),this.pagination=new j({element:c,pageSize:15,totalSize:0,activePageNumber:1}),this.pagination.on("page",function(a){var c=b.get("condition");c.pageNumber=a,b.set("condition",c),b.refresh(c)}),a.on("click",".crm-datatable tbody tr td",function(){if(!$(this).hasClass("td-checkbox-warp")){var a=$(this).closest("tr"),c=b.get("oTable").fnGetData(a.get(0)),d=c.customerID;if(b.get("overWriteRowClick"))return b.trigger("rowClick",d),void 0;var e=0,f=b.get("isHighSeaAdmin"),g=b.get("isMyHighSeas");g&&(e=f?2:1),b.get("editDialog").show({customerID:d,dialogType:e})}})},refresh:function(a){this.set("firstLoad",!1),h.mnReset($(".crm-customer-highseas-select-all",this.element)),a&&(a=_.extend(this.get("condition"),a),this.set("condition",a),this.pagination.jump(a.pageNumber,!0)),this.get("oTable").fnReloadAjax()},_initDataTabel:function(){var a=this,b=$(".crm-table-bd .crm-datatable",this.element),c=b.dataTable({sDom:"Rlfrtip",aoColumns:a.get("aoColumns"),sAjaxSource:a.get("url"),fnServerData:function(b,c,d,e){if(!a.get("firstLoad")){var f=a.get("condition");e.jqXHR=h.api({dataType:"json",type:"get",url:b,data:f,beforeSend:function(){h.showGlobalLoading(1)},success:function(b){d(a._formatTableData(b));var c=b.value.highSeas.highSeasPermissions;a.set("highSeasPermissions",c);var e=!1,f=h.getCrmData().currentEmp.employeeID,g=_.find(c,function(a){return a.employeeID==f});g&&(e=g.isAdmin),a.set("isHighSeaAdmin",e),a.trigger("isAdmin",e),h.hideGlobalLoading(1);var i=b.value.totalCount;a.pagination.setTotalSize(i),a.trigger("refreshed",i);var j=a.getSelectItems();j.length>0?a.trigger("select"):a.trigger("unselect")}})}},bAutoWidth:!1,bFilter:!1,bPaginate:!1,bInfo:!1,oLanguage:{sEmptyTable:'<span class="empty-tip">该条件下，没有客户</span>'}});this.set("oTable",c)},_initCustomerInSettingDialog:function(){var a=this,b=new k;b.on("success",function(){a.refresh(a.get("condition"))}),this.set("editDialog",b)},_formatTableData:function(a){return{aaData:a.value.customers}},_checkboxSelectall:function(a){var b=$(a.currentTarget),c=$(".crm-table-bd .crm-datatable tbody",this.element),d=$(".checkbox-for-comtable",c),e=d.find(".mn-checkbox-item");b.is(".mn-selected")?(e.removeClass("mn-selected"),$("tbody tr",this.oTable).removeClass("row_selected")):(e.addClass("mn-selected"),$("tbody tr",this.oTable).addClass("row_selected"));var f=this.getSelectItems();f.length>0?this.trigger("select"):this.trigger("unselect")},_checkOrNot:function(a){var b=$(a.currentTarget);b.attr("data-value");var c=this.getSelectItems();b.hasClass("mn-selected")?(b.parent().parent().parent().removeClass("row_selected"),1==c.length&&(this.trigger("unselect"),h.mnReset($(".crm-customer-highseas-select-all",this.element)))):(b.parent().parent().parent().addClass("row_selected"),0==c.length&&this.trigger("select"))},getSelectItems:function(){var a=[],b=$(".crm-table-bd .crm-datatable tbody",this.element);return _.each($(".mn-selected",b),function(b){a.push($(b).attr("data-value"))}),a},destroy:function(){var a=l.superclass.destroy.apply(this,arguments);return this.element.empty(),a}});c.exports=l});