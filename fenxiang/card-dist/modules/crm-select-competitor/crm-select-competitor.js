/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-select-competitor/crm-select-competitor",["dialog","util","uilibs/pagination2","modules/crm-select-competitor/crm-select-competitor.html","moment","datatable","modules/crm-select-opp/crm-select-opp.css"],function(a,b,c){var d=a("dialog"),e=a("util"),f=a("uilibs/pagination2"),g=a("modules/crm-select-competitor/crm-select-competitor.html");a("moment"),a("datatable"),a("modules/crm-select-opp/crm-select-opp.css");var h=d.extend({attrs:{title:"&nbsp;",url:"/Competitor/GetCompetitorList",content:$(g).filter(".crm-add-competitor-dialog"),isMultiSelect:!1,hasDeptTree:!1,hasWorkLeaveBtn:!1,closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",width:800,height:800,condition:{},defaultCondition:{keyword:"",listTagOptionID:"407,0",sortType:0,pageSize:10,pageNumber:1},needToRest:!1,result:[],salesOpportunityID:void 0,competitorID:void 0,competitorName:void 0},setup:function(){var a=h.superclass.setup.apply(this,arguments),b=_.extend({},this.get("defaultCondition"),this.get("condition"));return this.set("condition",b),a},render:function(){for(var a=h.superclass.render.apply(this,arguments),b=[],c=1,d=10;d>=c;c++)b.push({value:10*c+"",text:10*c+""});return e.mnSelect($(".winRate",this.element),"syncModel",b),a},hide:function(a){var b=h.superclass.hide.apply(this,arguments);return this.reset(),a!==!0&&this.v.hide(),b},show:function(a){var b=h.superclass.show.apply(this,arguments);a&&(this.set("competitorData",a),a.competitorName&&this.set("competitorName",a.competitorName),a.competitorID&&this.set("competitorID",a.competitorID),this.fillFormData());try{this.refresh()}catch(c){}return b},reset:function(){var a=this.element;$(".count",a).val(""),$(".price",a).val(""),$(".description",a).val(""),e.mnSetter($(".winRate",a),10),$(".advantage",a).val(""),$(".disadvantage",a).val(""),$(".productDescription",a).val(""),$(".strategies",a).val("")},events:{"click .add-product-back":"_cancel","click .add-product-cancel":"_cancel","click .add-product-submit":"_submit"},_submit:function(){var a=this,b=this.element;this.get("competitorName");var c=this.get("salesOpportunityID"),d=this.get("competitorID"),f=parseInt($(".price",b).val());isNaN(f)&&(f=0);var g=e.mnGetter($(".winRate",b))||10,h=$(".advantage",b).val()||"",i=$(".disadvantage",b).val()||"",j=$(".productDescription",b).val()||"",k=$(".strategies",b).val()||"";e.api({url:"/SalesOpportunity/AddOppCompetitorRelation",type:"post",dataType:"json",data:{salesOpportunityID:c,competitorID:d,price:f,winRate:g,advantage:h,disadvantage:i,productDescription:j,strategies:k},success:function(b){b.success&&(a.hide(),a.v.hide(),e.remind(2,"保存成功"),a.v.trigger("success"))}},{submitSelector:""})},_cancel:function(){this.hide(!0)},destroy:function(){var a;return a=f.superclass.destroy.apply(this,arguments),this.reset(),a},fillFormData:function(){var a=this.get("competitorName"),b=this.element,c=this.get("competitorData")||void 0;c&&($(".competitorName",b).val(a),$(".advantage",b).val(c.advantage),$(".disadvantage",b).val(c.disadvantage),$(".productDescription",b).val(c.productDescription),$(".strategies",b).val(c.strategies))}}),i=d.extend({attrs:{title:"选择对手",url:"/Competitor/GetCompetitorList",content:$(g).filter(".crm-select-competitor-dialog"),isMultiSelect:!1,hasDeptTree:!1,hasWorkLeaveBtn:!1,closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",width:800,height:603,condition:{},defaultCondition:{keyword:"",listTagOptionID:"407,0",sortType:0,pageSize:10,pageNumber:1},needToRest:!1,result:[],salesOpportunityID:void 0,isLoadServerData:!1},setup:function(){var a=i.superclass.setup.apply(this,arguments),b=_.extend({},this.get("defaultCondition"),this.get("condition"));return this.set("condition",b),a},render:function(){var a=i.superclass.render.apply(this,arguments);return this._initTable(),this.addCompetitorDialog=new h({salesOpportunityID:this.get("salesOpportunityID")}),this.addCompetitorDialog.v=this,a},hide:function(){var a=i.superclass.hide.apply(this,arguments);return this.reset(),this.addCompetitorDialog.hide(!0),a},show:function(){var a=i.superclass.show.apply(this,arguments);try{this.refresh()}catch(b){}return a},reset:function(){$(".search-input",this.element).val(""),this.set("condition",this.get("defaultCondition")),this.pagination.jump(1,!0)},events:{"click .fs-col-select-button-close":"hide","click .crm-datatable th":"_crmTableSort","click .crm-datatable tbody tr td":"_selectRow","click .search-button":"_btnSearch","keydown .search-input":"_inputSearch"},_crmTableSort:function(a){var b=this;e.crmTableSortSet({element:$(".sort-select-list",this.$el),meEl:$(a.currentTarget),selectData:[{text:"发生变化的在最前面",value:"0"},{text:"预计成交金额大的在前面",value:"3"},{text:"预计成交日期早的在前面",value:"4"},{text:"销售阶段晚的在最前面",value:"7"},{text:"表格列排序",value:"",selected:!0}],oThs:[{clasName:".crmtable-sort-name",sortType:[8,9]},{clasName:".crmtable-sort-expectedsalesamount",sortType:[3,2]},{clasName:".crmtable-sort-expecteddealtime",sortType:[4,5]},{clasName:".crmtable-sort-salesstage",sortType:[7,6]}],callback:function(a){b.refresh(a)}})},_formatTableData:function(a){var b=[],c=a.value;if(c&&c.competitors)var d=c.competitors;return _.each(d,function(a){b.push(_.extend({isDir:!0,downloadTimes:0,attachSize:0},a))}),{aaData:b}},_btnSearch:function(){this._search()},_inputSearch:function(a){13==a.keyCode&&(this._search(),a.preventDefault())},_search:function(){this.get("condition").keyword=$(".search-input",this.element).val(),this.refresh()},_selectRow:function(a){var b=$(a.target).closest("tr"),c=this.oTable.fnGetData(b.get(0)),d=_.extend({},c,{salesOpportunityID:this.get("salesOpportunityID"),competitorID:c.competitorID,competitorName:c.name});this.addCompetitorDialog.show(d)},_initTable:function(){var a=$(".crm-competitor-list-datatable",this.element),b=this;b.pagination=new f({element:$(".pagination-wrapper",b.element),pageSize:b.get("condition").pageSize,totalSize:0,activePageNumber:1}),b.pagination.on("page",function(a){var c=b.get("condition");c.pageNumber=a,b.set("condition",c),b.refresh()}),this.oTable=a.dataTable({sDom:"Rlfrtip",aoColumns:[{mData:"name",sWidth:"260px",sClass:"black-name crmtable-sort-name",bSortable:!0,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"contactInfo",sWidth:"180px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"competitivenessTagOptionName",sWidth:"100px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"competitorScaleTagOptionName",sWidth:"auto",sClass:"",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"lastEditTime",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}],sAjaxSource:this.get("url"),fnServerData:function(a,c,d,f){if(b.get("isLoadServerData")){var g=b.get("condition");f.jqXHR=e.api({dataType:"json",type:"get",url:a,data:g,beforeSend:function(){e.showGlobalLoading(1)},success:function(a){var c=a.value.totalCount;e.hideGlobalLoading(1),b.responseData=a,b.competitors=a.value.competitors,d(b._formatTableData(a)),b.pagination.setTotalSize(c)}})}},bAutoWidth:!1,bFilter:!1,bPaginate:!1,bInfo:!1,bDestroy:!0,oLanguage:{sEmptyTable:'<span class="empty-tip">没有获取到对手</span>'}})},refresh:function(a){a&&this.set("condition",_.extend(this.get("condition"),a)),this.set("isLoadServerData",!0),this.oTable.fnReloadAjax()},_submit:function(){this.get("isMultiSelect")?this.trigger("selected",this.get("result")):this.trigger("selected",this.get("result")[0]),this.hide()},_cancel:function(){this.hide()},destroy:function(){var a;return a=f.superclass.destroy.apply(this,arguments),this.reset(),a}});c.exports=i});