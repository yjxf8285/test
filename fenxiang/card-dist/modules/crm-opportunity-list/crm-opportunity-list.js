/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-opportunity-list/crm-opportunity-list",["modules/crm-opportunity-list/crm-opportunity-list.html","dialog","util","modules/publish/publish-helper","datatable","moment","modules/crm-date-dialog/crm-date-dialog","uilibs/pagination2","modules/crm-select-colleague/crm-select-colleague","modules/crm-opportunity-edit/crm-opportunity-edit"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-opportunity-list/crm-opportunity-list.html");a("dialog");var h=a("util");a("modules/publish/publish-helper"),a("datatable");var i=a("moment"),j=a("modules/crm-date-dialog/crm-date-dialog"),k=a("uilibs/pagination2"),l=a("modules/crm-select-colleague/crm-select-colleague"),m=a("modules/crm-opportunity-edit/crm-opportunity-edit"),n=Backbone.View.extend({tagName:"div",className:"opportunity-list-module",template:_.template($(g).filter(".crm-contract-list-template").html()),options:{warpEl:null,url:"",data:{},isLoadServerData:!1},events:{"click .crm-datatable th":"_crmTableSort","click .create-opportunity-btn":"_createCompetitor","click .update-opportunity-sowner-btn":"_updateSalesCluesOwner","click .update-opportunity-states-un-btn":"_updateStatesOwner","click .update-opportunity-states-on-btn":"_updateStatesOwner","click .update-opportunity-isreview-yes-btn":"_isreviewYes","click .update-opportunity-isreview-no-btn":"_isreviewNo","click .delete-opportunity-btn":"_deleteCompetitor","click .customers-follow":"_followSwitch","click .checkbox-selectall-btn":"_checkboxSelectall"},_isreviewYes:function(){var a=this,b=this.$el.find(".crm-table-bd .crm-datatable tbody"),c=$(".checkbox-for-comtable .mn-checkbox-item",b),d=[];c.each(function(){$(this).is(".mn-selected")&&d.push($(this).data("value"))}),d.length>0?h.api({url:"/SalesOpportunity/UpdateSalesOpportunitysReview",type:"post",dataType:"json",data:{salesOpportunityIDs:d,isAgree:!0},success:function(b){if(b.success){var c=b.value.result,d="",e="",f=0,g=0;_.each(c,function(b){var c=b.value,d=b.value1,h=b.value2,i="";_.each(a.products,function(a){a.salesOpportunityID===c&&(i=a.name)}),d?f++:(e+=i+"同意审批失败，原因："+h+"</br>",g++)}),d+=e+"本次操作有"+f+"个成功，"+g+"个失败",g.length<=0?(h.remind(2,"同意审批成功"),$(".mn-checkbox-item",a.$el).removeClass("mn-selected")):h.alert(d,function(){a.refresh(),$(".mn-checkbox-item",a.$el).removeClass("mn-selected")})}}}):h.alert("请选择机会")},_isreviewNo:function(){var a=this,b=this.$el.find(".crm-table-bd .crm-datatable tbody"),c=$(".checkbox-for-comtable .mn-checkbox-item",b),d=[];c.each(function(){$(this).is(".mn-selected")&&d.push($(this).data("value"))}),d.length>0?h.api({url:"/SalesOpportunity/UpdateSalesOpportunitysReview",type:"post",dataType:"json",data:{salesOpportunityIDs:d,isAgree:!1},success:function(b){if(b.success){var c=b.value.result,d="",e="",f=0,g=0;_.each(c,function(b){var c=b.value,d=b.value1,h=b.value2,i="";_.each(a.products,function(a){a.salesOpportunityID===c&&(i=a.name)}),d?f++:(e+=i+"同意审批失败，原因："+h+"</br>",g++)}),d+=e+"本次操作有"+f+"个成功，"+g+"个失败",g.length<=0?(h.remind(2,"不同意审批成功"),$(".mn-checkbox-item",a.$el).removeClass("mn-selected")):h.alert(d,function(){a.refresh(),$(".mn-checkbox-item",a.$el).removeClass("mn-selected")})}}}):h.alert("请选择机会")},_followSwitch:function(a){a.stopPropagation();var b=$(a.target),c=b.parents("tr").children().eq(0).find("span").attr("data-value");b.hasClass("customers-following")?h.api({url:"/SalesOpportunity/SalesOpportunityCancelFollow",type:"post",dataType:"json",data:{salesOpportunityID:c},success:function(a){a.success&&b.removeClass("customers-following").addClass("customers-nofollow")}}):h.api({url:"/SalesOpportunity/SalesOpportunityFollow",type:"post",dataType:"json",data:{salesOpportunityID:c},success:function(a){a.success&&b.removeClass("customers-nofollow").addClass("customers-following")}})},_crmTableSort:function(a){var b=this,c=$(a.target).css("cursor");"col-resize"!=c&&h.crmTableSortSet({element:$(".sort-select-list",this.$el),meEl:$(a.currentTarget),selectData:[{text:"发生变化的在最前面",value:"0"},{text:"预计成交金额大的在前面",value:"3"},{text:"预计成交日期早的在前面",value:"4"},{text:"销售阶段晚的在最前面",value:"7"},{text:"表格列排序",value:"",selected:!0}],oThs:[{clasName:".crmtable-sort-name",sortType:[8,9]},{clasName:".crmtable-sort-expectedsalesamount",sortType:[3,2]},{clasName:".crmtable-sort-expecteddealtime",sortType:[4,5]},{clasName:".crmtable-sort-salesstage",sortType:[7,6]}],callback:function(a){b.refresh(a)}})},_createCompetitor:function(){this.createDialog.show()},_updateSalesCluesOwner:function(){var a=this.$el.find(".crm-table-bd .crm-datatable tbody"),b=$(".checkbox-for-comtable .mn-checkbox-item",a),c=[];b.each(function(){$(this).is(".mn-selected")&&c.push($(this).data("value"))}),c.length>0?(this.selectOwner.salesOpportunityIDs=c,this.selectOwner.show()):h.alert("请选择机会")},_updateStatesOwner:function(a){var b=this,c=$(a.currentTarget),d=this.$el.find(".crm-table-bd .crm-datatable tbody"),e=$(".checkbox-for-comtable .mn-checkbox-item",d),f=[],g=c.is(".update-opportunity-states-on-btn");e.each(function(){$(this).is(".mn-selected")&&f.push($(this).data("value"))}),f.length>0?g?h.api({url:"/SalesOpportunity/UpdateSalesOpportunitysStates",type:"post",dataType:"json",data:{salesOpportunityIDs:f,states:1},success:function(a){if(a.success&&a.success){var c=a.value.result,d="",e="",f=0,g=0;_.each(c,function(a){var c=a.value,d=a.value1,h=a.value2,i="";_.each(b.products,function(a){a.salesOpportunityID===c&&(i=a.name)}),d?f++:(e+=i+"启用失败，原因："+h+"<br/>",g++)}),d+=e+"本次操作有"+f+"个成功，"+g+"个失败",0>=g?(h.remind(2,"启用成功"),b.refresh(),$(".mn-checkbox-item",b.$el).removeClass("mn-selected")):h.alert(d,function(){b.refresh(),$(".mn-checkbox-item",b.$el).removeClass("mn-selected")})}}}):h.confirm("你确定要作废选中的"+f.length+"个机会吗？","",function(){h.api({url:"/SalesOpportunity/UpdateSalesOpportunitysStates",type:"post",dataType:"json",data:{salesOpportunityIDs:f,states:2},success:function(a){if(a.success){var c=a.value.result,d="",e="",f=0,g=0;_.each(c,function(a){var c=a.value,d=a.value1,h=a.value2,i="";_.each(b.products,function(a){a.salesOpportunityID===c&&(i=a.name)}),d?f++:(e+=i+"作废失败，原因："+h+"<br/>",g++)}),d+=e+"本次操作有"+f+"个成功，"+g+"个失败",0>=g?(h.remind(2,"作废成功"),b.refresh(),$(".mn-checkbox-item",b.$el).removeClass("mn-selected")):h.alert(d,function(){b.refresh(),$(".mn-checkbox-item",b.$el).removeClass("mn-selected")})}}})}):h.alert("请选择机会")},_deleteCompetitor:function(){var a=this,b=this.$el.find(".crm-table-bd .crm-datatable tbody"),c=$(".checkbox-for-comtable .mn-checkbox-item",b),d=[];c.each(function(){$(this).is(".mn-selected")&&d.push($(this).data("value"))}),d.length>0?h.confirm("你确定要删除选中的"+d.length+"个机会吗？","",function(){h.api({url:"/SalesOpportunity/DeleteSalesOpportunitys",type:"post",dataType:"json",data:{salesOpportunityIDs:d},success:function(b){if(b.success){var c=b.value.result,d="",e="",f=0,g=0;_.each(c,function(b){var c=b.value,d=b.value1,h=b.value2,i="";_.each(a.products,function(a){a.salesOpportunityID===c&&(i=a.name)}),d?f++:(e+=i+"删除失败，原因："+h+"</br>",g++)}),d+=e+"本次操作有"+f+"个成功，"+g+"个失败",h.alert(d,function(){$(".checkbox-selectall-btn .mn-checkbox-item").removeClass("mn-selected"),a.refresh()})}}})}):h.alert("请选择要删除的机会")},_getProductTagsDatas:function(){var a=h.getCrmData(),b=a.salesStagesInUse,c=a.functionPermissions,d=[],e=[];_.each(b,function(a){10!=a.salesStageNo&&11!=a.salesStageNo&&d.push(a.salesStageNo)}),e=[{text:"不限",value:""},{text:"进行中（赢单之前）",value:d},{text:"已结束（赢单和输单）",value:"10,11"}],_.each(b,function(a){e.push({text:a.name,value:a.salesStageNo})}),_.extend(this,{salesStagesInUseList:e,functionPermissions:c})},initialize:function(){this._getProductTagsDatas(),this.render(),this.setDateDialog()},render:function(){var a=this.$el,b=this.template;return a.html(b({value:{employees:{}}})),this.options.warpEl.html(a),this.setDataTabel(),this.setupComponent(),this.createDialog=new m,this.createDialog.v=this,this},setDateDialog:function(){var a=this;a.dateDialog=new j,a.dateDialog.on("enter",function(b){a.options.data.dealDayType=0,a.options.data.beginDealTime=b.startTime,a.options.data.endDealTime=b.endTime,a.curSelect.set("selectedIndex",-1),a.refresh(),$(".dealdaytype-select-list .mn-select-title",a.$el).html(b.timeText),a.dateDialog.hide()}),a.dateDialog.on("cancel",function(){var b=a.options.data.dealDayType||0,c=a.options.data.beginDealTime;if(c>0)return a.curSelect.set("selectedIndex",-1),void 0;var d=$('.ui-select-item[data-value="'+b+'"]',$(a.curSelect.element));$(".dealdaytype-select-list .mn-select-title",a.$el).html(d.text()),a.curSelect.set("selectedIndex",d.index())})},showFnBtn:function(){var a=this.$el,b=$(".create-salesclue-btn",a),c=$(".update-salesclue-sowner-btn",a),d=$(".delete-salesclue-btn",a),e=this.responseData.value.canCreate,f=this.responseData.value.canChangeOwner,g=this.responseData.value.canDelete;e?b.show():b.hide(),f?c.show():c.hide(),g?d.show():d.hide()},setupComponent:function(){var a=this.$el,b=this,c=$(".pagination-wrapper",a),d=$(".dealdaytype-select-list",a),e=$(".isowner-select-list",a),g=$(".isreview-select-list",a),i=$(".sort-select-list",a),j=$(".salesstagenos-select-list",a);h.mnEvent(i,"change",function(a){h.mnSelect(i,"removeOption",4),$("th",b.oTable).removeClass("sorting_asc").removeClass("sorting_desc"),b.refresh({sortType:a})}),this.pagination=new k({element:c,pageSize:this.options.data.pageSize,totalSize:0,activePageNumber:1}),this.selectOwner=new l({isMultiSelect:!1,title:"请选择负责人"}),this.selectOwner.on("selected",function(a){var c=this.salesOpportunityIDs,d=c.length,e=a.employeeID,f=a.name;h.confirm("你确定要将选中的"+d+"个机会的负责人变更为"+f+"吗？","",function(){h.api({url:"/SalesOpportunity/UpdateSalesOpportunitysOwnerID",type:"post",dataType:"json",data:{salesOpportunityIDs:c,ownerID:e},success:function(a){if(a.success){var c=a.value.result,d="",e="",f=0,g=0;_.each(c,function(a){var c=a.value,d=a.value1,h=a.value2,i="";_.each(b.products,function(a){a.salesOpportunityID===c&&(i=a.name)}),d?f++:(e+=i+"变更失败，原因："+h+"</br>",g++)}),d+=e+"本次修改有"+f+"个成功，"+g+"个失败",h.alert(d,function(){$(".checkbox-selectall-btn .mn-checkbox-item").removeClass("mn-selected"),b.refresh()})}}})})}),h.mnSelect(j,"syncModel",this.salesStagesInUseList),h.mnEvent(d,"change",function(a){return 6==a?(b.curSelect=this,b.dateDialog.show(),void 0):(b.options.data.beginDealTime=-1,b.options.data.endDealTime=-1,b.options.data.dealDayType=a,b.refresh(),void 0)}),h.mnEvent(e,"change",function(a){b.options.data.isOwner=a,b.refresh()}),h.mnEvent(j,"change",function(a){b.options.data.salesStageNos=a,b.refresh()}),h.mnEvent(g,"change",function(a){b.options.data.isReview=a,b.refresh()}),this.pagination.on("page",function(a){b.options.data.pageNumber=a,b.refresh()}),a.on("click",".crm-datatable tbody tr td",function(){var c=$(this).closest("tr"),d=b.oTable.fnGetData(c.get(0));encodeURIComponent("/")+"opportunities"+encodeURIComponent("/")+"salesopportunity";var e=d.salesOpportunityID;encodeURIComponent(encodeURI(d.name));var g=window.location.href.split("#")[1];g=g.split("/=/")[0];var i={id:e};i=_.extend({},h.getTplQueryParams2(),i),i.returnUrl=g+"/=/param-"+encodeURIComponent(JSON.stringify(i)),f.event.one("dataUpdate",function(){b.options.ID=e,b.refresh()}),$(this).is(".td-checkbox-warp")||(f.navRouter.navigate("#opportunities/showopportunity/=/param-"+encodeURIComponent(JSON.stringify(i)),{trigger:!0}),$(".crm-datatable tbody tr",a).removeClass("row_selected"),c.addClass("row_selected"))})},load:function(){this.options.isLoadServerData=!0},refresh:function(a){a&&_.extend(this.options.data,a),this.oTable.fnReloadAjax()},reSetMnselect:function(){var a=this.$el,b=h.getCrmData(),c=b.salesStagesInUse;b.functionPermissions;var d=[],e=[];_.each(c,function(a){10!=a.salesStageNo&&11!=a.salesStageNo&&d.push(a.salesStageNo)}),e=[{text:"不限",value:""},{text:"进行中（赢单之前）",value:d},{text:"已结束（赢单和输单）",value:"10,11"}],_.each(c,function(a){e.push({text:a.name,value:a.salesStageNo})}),h.mnSelect($(".salesstagenos-select-list",a),"syncModel",e),h.mnSelect($(".isreview-select-list",a),"syncModel",[{text:"不限",value:-1},{text:"未审核",value:0},{text:"已审核",value:1}]),h.mnSelect($(".dealdaytype-select-list",a),"syncModel",[{text:"不限",value:0},{text:"本月",value:1},{text:"下月",value:2},{text:"本季度",value:3},{text:"下季度",value:4},{text:"本年度",value:5},{text:"自定义",value:"6"}]),h.mnSelect($(".isowner-select-list",a),"syncModel",[{text:"全部",value:-1},{text:"参与",value:0},{text:"负责",value:1}]),h.mnSelect($(".sort-select-list",a),"syncModel",[{text:"发生变化的在最前面",value:0},{text:"预计成交金额大在前",value:3},{text:"预计成交日期早在前",value:4},{text:"销售阶段晚在最前",value:7}]),this.pagination.jump(1,!0)},setDataTabel:function(){var a=this,b=this.$el,c=b.find(".crm-table-bd .crm-datatable");this.oTable=c.dataTable({sDom:"Rlfrtip",aoColumns:[{mData:"salesOpportunityID",sWidth:"26px",sClass:"td-checkbox-warp",bSortable:!1,mRender:function(a){var b='<div class="mn-checkbox-box checkbox-for-comtable">&nbsp;&nbsp;<span data-value="'+a+'" class="mn-checkbox-item"></span> </div>';return b}},{mData:"isFollow",sWidth:"24px",sClass:"customer-foolo",bSortable:!1,mRender:function(a){var b;return b=a?'<div class="customers-follow customers-following" title="取消关注"></div>':'<div class="customers-follow customers-nofollow" title="关注"></div>'}},{mData:"name",sWidth:"117px",sClass:"black-name crmtable-sort-name",bSortable:!0,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"owner",sWidth:"50px",sClass:"",bSortable:!1,mRender:function(a){var b='<span title="'+a.name+'">'+a.name+"</span>";return b}},{mData:"customerName",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"expectedSalesAmount",sWidth:"80px",sClass:"crmtable-sort-expectedsalesamount",bSortable:!0,mRender:function(a){var b=_.str.numberFormat(parseFloat(a),2),c='<span title="'+b+'">'+b+"</span>";return c}},{mData:"expectedDealTime",sWidth:"120px",sClass:"crmtable-sort-expecteddealtime",bSortable:!0,mRender:function(a){var b='<span title="'+i.unix(a).format("YYYY-MM-DD")+'">'+i.unix(a).format("YYYY-MM-DD")+"</span>";return b}},{mData:"salesStage",sWidth:"150px",sClass:"crmtable-sort-salesstage",bSortable:!0,mRender:function(a){var b='<span title="'+a.name+'">'+a.name+"</span>";return b}},{mData:"salesStage",sWidth:"50px",sClass:"",bSortable:!1,mRender:function(a){var b='<span title="'+a.name.winRate+'%">'+a.winRate+"%</span>";return b}},{mData:"lastEditTime",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}],sAjaxSource:this.options.url,fnServerData:function(b,c,d,e){if(a.options.isLoadServerData){var f=a.options.data;f._=(new Date).getTime(),e.jqXHR=h.api({dataType:"json",type:"get",url:b,data:f,beforeSend:function(){h.showGlobalLoading(1)},success:function(b){var c=b.value.totalCount;h.hideGlobalLoading(1),a.responseData=b,a.products=b.value.salesOpportunitys,d(a._formatTableData(b)),a.pagination.setTotalSize(c),a.showFnBtn(),$(".checkbox-for-comtable .mn-checkbox-item",a.$el).removeClass("mn-selected"),a.options.ID&&$("[data-value="+a.options.ID+"]").closest("tr").addClass("row_selected"),$("tbody tr",a.oTable).each(function(){var a=this;h.mnEvent($(this).find(".mn-checkbox-box"),"change",function(b){0==b.length?$(a).addClass("row_selected"):$(a).removeClass("row_selected")})})}})}},bAutoWidth:!1,bFilter:!1,bPaginate:!1,bInfo:!1,bSort:!1,oLanguage:{sEmptyTable:'<span class="empty-tip">没有获取到机会</span>'}})},_formatTableData:function(a){var b=[],c=a.value,d=c.salesOpportunitys;return _.each(d,function(a){b.push(_.extend({isDir:!0,downloadTimes:0,attachSize:0},a))}),{aaData:b}},_checkboxSelectall:function(a){var b=$(a.currentTarget),c=this.$el.find(".crm-table-bd .crm-datatable tbody"),d=$(".checkbox-for-comtable",c),e=d.find(".mn-checkbox-item");b.is(".mn-selected")?(e.removeClass("mn-selected"),$("tbody tr",this.oTable).removeClass("row_selected")):(e.addClass("mn-selected"),$("tbody tr",this.oTable).addClass("row_selected"))},destroy:function(){this.remove()}});c.exports=n});