/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-highsea-editsetting/crm-highsea-editsetting",["dialog","modules/crm-select-colleague/crm-select-colleague","util","modules/crm-highsea-editsetting/crm-highsea-editsetting.html"],function(a,b,c){var d=window,e=d.FS,f=e.tpl,g=f.event,h=a("dialog"),i=a("modules/crm-select-colleague/crm-select-colleague"),j=a("util"),f=a("modules/crm-highsea-editsetting/crm-highsea-editsetting.html"),k=h.extend({attrs:{content:f,lisContent:'<li><div class="-highsea-info"><img class="-highsea-info-avatar" style="width:30px;height:30px;"></img><span class="-highsea-info-name"></span></div><div class="-highsea-checkbox-box fn-left"><span class="label-for"><span class="-highsea-checkbox-item"></span>&nbsp;<label>管理员</label></span></div><div class="-highsea-edit"><span class="-highsea-isnew"></span><a class="-highsea-delete">删除</a></div></li>',width:590,attachId:0,closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",attachName:""},_initSelect:function(){var a=this,b=new i({isMultiSelect:!0,hasWorkLeaveBtn:!1,title:"选择员工"});b.on("selected",function(b){for(var c,d=[],e=0;e<b.length;e++)c={name:b[e].name,id:b[e].employeeID,img:j.getAvatarLink(b[e].profileImage,4),isnew:!0},d.push(c);a._addPersonMod(d)}),this.set("select",b)},_addDialog:function(){for(var a,b=this.get("personMod"),c=[],d=0;d<b.length;d++)c.push(b[d].id);a=c.join(",");var e=this.get("select"),f=e.get("condition");f.exceptEmployeeIDs=a,e.set(f),e.show()},_setRootMod:function(a){var b=this.get("rootMod"),c=$(a.currentTarget),d=c.attr("data-id");_.contains(b,d)?b=_.without(b,d):b.push(d),this.set("rootMod",b),this._refresh()},_addPersonMod:function(a){var b=this.get("personMod");b=b.concat(a),this.set("personMod",b),this._refresh()},_deletePersonMod:function(a){var b=$(a.target).attr("data-id"),c=this.get("personMod"),d=this.get("rootMod"),e=_.filter(c,function(a){return a.id!=b}),f=_.without(d,b);this.set("personMod",e),this.set("rootMod",f),this._refresh()},_refresh:function(){var a=this.get("personMod"),b=this.get("rootMod");this.get("$numperson").text(a.length),this.get("$numroot").text(b.length);var c=this.get("lisContent");this.get("$setcontent").empty();for(var d,e,f=0;f<a.length;f++)e=a[f],d=$(c),d.find(".-highsea-info-avatar").attr("src",e.img),d.find(".-highsea-info-name").text(e.name),d.find(".-highsea-delete").attr("data-id",e.id),d.find(".-highsea-checkbox-box").attr("data-id",e.id),e.isnew&&d.find(".-highsea-isnew").text("新增"),this.get("$setcontent").append(d);for(var g=0;g<b.length;g++)this.element.find('.-highsea-checkbox-box[data-id="'+b[g]+'"]').addClass("-highsea-selected");a.length>0?(this.get("$setcontent").show(),this.get("$titcontent").hide()):(this.get("$setcontent").hide(),this.get("$titcontent").show())},_renderInfo:function(a){this.get("$name").val(a.name),this.get("$upnum").val(a.claimLimitNum),this.get("$recycle").val(a.claimReturnDays);for(var b=a.highSeasPermissions,c=[],d=[],e=0;e<b.length;e++)c.push({name:b[e].employee.name,id:b[e].employeeID,img:j.getAvatarLink(b[e].employee.profileImage,4),isnew:!1}),b[e].isAdmin&&d.push(b[e].employeeID.toString());this.set("personMod",c),this.set("rootMod",d),this._refresh()},_getInfo:function(){for(var a=this.get("personMod"),b=this.get("rootMod"),c=[],d=0;d<a.length;d++)c.push(a[d].id);return{employeeIDs:c.join(","),adminEmpIDs:b.join(","),name:this.get("$name").val(),claimLimitNum:this.get("$upnum").val(),claimReturnDays:this.get("$recycle").val()}},_save:function(){var a=this._getInfo();if(a.claimLimitNum=Number(a.claimLimitNum),a.claimReturnDays=Number(a.claimReturnDays),""==a.name)return j.alert("公海名称不能为空"),void 0;if(a.name.length>200)return j.alert("公海名称字长不得大于200字"),void 0;if(isNaN(a.claimLimitNum)||-1!=a.claimLimitNum.toString().indexOf(".")&&-1==a.claimLimitNum.toString().indexOf("e")||0==a.claimLimitNum)return console.log(a.claimLimitNum),j.alert("认领上限栏内请填写大于0的整数"),void 0;if(isNaN(a.claimReturnDays)||-1!=a.claimLimitNum.toString().indexOf(".")&&-1==a.claimLimitNum.toString().indexOf("e")||0==a.claimReturnDays)return j.alert("回收期限栏内请填写大于0的整数"),void 0;if(a.claimLimitNum>9999)return j.alert("认领上限栏内的数字不能超过9999 请重新填写"),void 0;if(a.claimReturnDays>9999)return j.alert("回收期限栏内的数字不能超过9999 请重新填写"),void 0;var b=this.get("highseaId"),c=this;b?(a.highSeasID=b,j.api({type:"post",url:"/HighSeas/ModifyHighSeas",data:a,success:function(d){d.success&&(c.trigger("modifySuccess",{name:a.name,id:b}),c.hide())}},{mask:!0})):j.api({type:"post",url:"/HighSeas/AddHighSeas",data:a,success:function(b){b.success&&(c.trigger("addSuccess",{name:a.name,id:b.value}),c.hide())}},{mask:!0})},_delete:function(){var a=this,b=this.get("highseaId");b&&j.confirm("1、删除后所有设置了跟进人的客户都会收回。</br>2、删除后该公海内的所有客户都成为未分配客户。</br>3、如果需要将当前公海客户分配到其他公海，请先移动客户</br>&nbsp;&nbsp;&nbsp;&nbsp;再删除当前公海。","是否确定要删除当前公海",function(){j.api({type:"post",url:"/HighSeas/DeleteHighSeas",data:{highSeasID:b},success:function(){a.trigger("deleteSuccess"),g.trigger("deleteHighSeasSuccess"),a.hide()}},{mask:!0})})},setup:function(){var a=k.superclass.setup.apply(this,arguments);return a},render:function(){var a=k.superclass.render.apply(this,arguments);return this._initSelect(),this.set("$setcontent",$(".-highsea-setting-con",this.element)),this.set("$titcontent",$(".-highsea-setting-title",this.element)),this.set("$numperson",$(".-highsea-num-person",this.element)),this.set("$numroot",$(".-highsea-num-root",this.element)),this.set("$name",$(".-highsea-name",this.element)),this.set("$upnum",$(".-highsea-upnum",this.element)),this.set("$recycle",$(".-highsea-recycle",this.element)),this.set("personMod",[]),this.set("rootMod",[]),a},hide:function(){var a=k.superclass.hide.apply(this,arguments);return this.reset(),a},show:function(a){var b=k.superclass.show.apply(this,arguments),c=this;return a&&(c.element.find(".-highsea-btn-delete").show(),c.set("highseaId",a),j.api({type:"get",url:"/HighSeas/GetHighSeasByID",data:{highSeasID:a},success:function(a){c._renderInfo(a.value.highSeas[0])}})),b},events:{"click .-highsea-add":"_addDialog","click .-highsea-delete":"_deletePersonMod","click .-highsea-checkbox-box":"_setRootMod","click .-highsea-btn-save":"_save","click .-highsea-btn-cancel":"hide","click .-highsea-btn-delete":"_delete"},reset:function(){this.element.find(".-highsea-btn-delete").hide(),this.get("$name").val(""),this.get("$upnum").val(20),this.get("$recycle").val(30),this.set("personMod",[]),this.set("rootMod",[]),this.set("highseaId",!1),this._refresh()},destroy:function(){var a=k.superclass.destroy.apply(this,arguments);return a}});c.exports=k});