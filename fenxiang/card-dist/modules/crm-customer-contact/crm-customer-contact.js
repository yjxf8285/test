/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-customer-contact/crm-customer-contact",["modules/crm-customer-contact/crm-customer-contact.html","dialog","util","moment","modules/crm-contact-edit/crm-contact-edit","modules/crm-select-contacts/crm-select-contacts"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-customer-contact/crm-customer-contact.html");a("dialog");var h=a("util"),i=a("moment"),j=a("modules/crm-contact-edit/crm-contact-edit"),k=a("modules/crm-select-contacts/crm-select-contacts"),l=Backbone.View.extend({tagName:"div",className:"customer-basic-module",template:_.template($(g).filter(".crm-customer-baseinfo-template").html()),initialize:function(){var a=this.$el,b=this,c=b.options.customerData.value.fCustomer;a.html(this.template({value:""})),this.panel=$($(g).filter(".crm-operate-contact-panel-template").html()),$(".operate",a).append(this.panel),this.options.warpEl.html(a),h.regGlobalClick(this.panel),this.editExits=new k({title:"选择联系人",url:"/Contact/GetUserContacts/",defaultCondition:{employeeID:h.getCurrentEmp().employeeID,isFirstChar:!1,source:0,createCustomer:0,startDate:0,endDate:0,tagOptionIDsJson:"",sortType:0,keyword:"",isContainSubordinate:0,pageSize:12,pageNumber:1}}),this.editExits.on("selected",function(a){var b=c.customerID,d=[];_.map(a,function(a){d.push(a.contactID)}),h.api({url:"/Contact/BatchCombineContactAndFCustomer",type:"post",dataType:"json",data:{contactIDs:d,customerID:b},success:function(a){a.success}})})},events:{"click .operate":"_operate","click .crm-contact-add-btn":"addContact","click .crm-contact-add-exits-btn":"addExitsContact"},_operate:function(a){a.stopPropagation(),this.panel.show()},addContact:function(a){var b=this.options.customerData.value.FCustomer;a.stopPropagation(),this.panel.hide(),this.createDialog=new j({customerID:b.customerID,customerName:b.name}),this.createDialog.v=this,this.createDialog.show()},addExitsContact:function(){this.editExits.show()}});Backbone.View.extend({tagName:"div",className:"customer-basic-module",template:_.template($(g).filter(".crm-customer-baseinfo-template").html()),options:{warpEl:null,customerData:null},initialize:function(){this.loadData()},render:function(){var a=this.$el,b=this.options.customerData.value.FCustomer,c=this.template;a.html(c({fullName:b.fullName,name:b.name,address:b.address,webSite:b.webSite,introduction:b.introduction,ownerName:b.owner.name,createTime:i.unix(b.createTime).format("YYYY年MM月DD日 HH:mm"),lastChangedTime:i.unix(b.lastChangedTime).format("YYYY年MM月DD日 HH:mm"),value:{tags:[]}}));var d=$(".customer-baseinfo-tag-ul",a),e=[];_.map(b.fBusinessTagRelations,function(a){e.push('<li class="fn-clear"><div class="input-tip">'),e.push(a.fBusinessTagName),e.push('</div><div class="input-wrapper">'),e.push(a.fBusinessTagOptionName),e.push("</div></li>")}),d.html(e.join("")),this.options.warpEl.html(a)},refresh:function(){var a=this.$el,b=this.v.options.customerData.value.fCustomer,c=this.template;a.html(c({fullName:b.fullName,name:b.name,address:b.address,webSite:b.webSite,introduction:b.introduction,ownerName:b.owner.name,createTime:i.unix(b.createTime).format("YYYY年MM月DD日 HH:mm"),lastChangedTime:i.unix(b.lastChangedTime).format("YYYY年MM月DD日 HH:mm"),value:{tags:[]}}));var d=$(".customer-baseinfo-tag-ul",a),e=[];_.map(b.fBusinessTagRelations,function(a){e.push('<li class="fn-clear"><div class="input-tip">'),e.push(a.fBusinessTagName),e.push('</div><div class="input-wrapper">'),e.push(a.fBusinessTagOptionName),e.push("</div></li>")}),d.html(e.join(""))},loadData:function(){var a=this,b=this.options.customerData.value.FCustomer.customerID;h.api({url:"/FCustomer/GetFCustomerDetailByID",type:"get",dataType:"json",data:{customerID:b,attachNum:6},success:function(b){b.success&&(a.responseData=b,a.render())}})}}),c.exports=l});