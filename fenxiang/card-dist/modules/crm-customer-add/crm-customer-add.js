/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-customer-add/crm-customer-add",["modules/crm-customer-add/crm-customer-add.html","dialog","util","modules/publish/publish-helper","modules/crm-select-colleague/crm-select-colleague","moment"],function(a,b,c){var d=window,e=d.FS,f=e.tpl;f.store,f.list;var g=a("modules/crm-customer-add/crm-customer-add.html"),h=a("dialog"),i=a("util"),j=a("modules/publish/publish-helper"),k=a("modules/crm-select-colleague/crm-select-colleague"),l=j.DateSelect;a("moment");var m=h.extend({attrs:{width:760,content:$(g).filter(".dialog-customer-template").html(),closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",className:"dialog-crm",inSetting:!1,customerID:void 0},events:{"click .dialog-button-submit":"submit","click .dialog-button-cancel":"hide","click .ownerID-btn":"showOwerDialog"},showOwerDialog:function(){this.selectOwnerDialog.show()},render:function(){var a=m.superclass.render.apply(this,arguments);return this.setupDoms(),this.setupComponent(),a},hide:function(){var a=m.superclass.hide.apply(this,arguments);return this.reset(),a},reset:function(){$(".area-auto-height",this.element).val("").removeAttr("style"),$(".mn-select-box",this.element).each(function(){i.mnReset($(this))});var a=i.getCurrentEmp();$(".ownerID",this.element).val(a.name).attr("data-id",a.employeeID),$(".dialog-input-text",this.element).val(""),_.map(this.defineDateFieldArray,function(a){a.dateObj.clear()}),this.setupComponent()},show:function(){var a=this,b=m.superclass.show.apply(this,arguments),c=this.get("customerID")?this.get("customerID"):void 0;return c?i.api({url:"/FCustomer/GetCustomerByID",type:"get",dataType:"json",data:{customerID:c},success:function(b){b.success&&(a.set("customerData",b),a.fillFormData())}},{submitSelector:""}):$.browser.mozilla&&setTimeout(function(){$(".area-auto-height",this.element).val("")},1),b},submit:function(a){var b=this,c=this,d=this.get("customerData")?this.get("customerData").value.fCustomer:void 0,e=$(a.currentTarget),f=this.element,g=$(".c-name",f).val(),h=$(".c-number",f).val(),j=$(".c-fullname",f).val(),k=$(".c-address",f).val(),l=$(".c-webSite",f).val(),m=parseInt($(".ownerID",f).attr("data-id")),n=$(".c-introduction",f).val(),o=$(".customer-tags-list-warp > li",f),p=[];o.each(function(){var a=$(".f-business-tag-id",$(this)).data("fbusinesstagid"),b=$(".mn-select-box",$(this)),c=i.mnGetter(b)||0;p.push(a+","+c)});var q=$(".customer-define-fields-list-warp",f),r=[];q.find(".f-user-define-field-num").each(function(){r.push($(this).attr("data-fieldname")+","+($(this).next().find("input").val()||0))}),q.find(".f-user-define-field-text").each(function(){r.push($(this).attr("data-fieldname")+","+($(this).next().find("textarea").val()||""))}),_.map(this.defineDateFieldArray,function(a){r.push(a.fieldName+","+a.dateObj.getTime())}),d?i.api({url:"/FCustomer/ModifyFCustomer",type:"post",dataType:"json",errorMsgTitle:"修改客户发生错误，原因：",data:{customerID:d.customerID,name:g,fullName:j,address:k,webSite:l,introduction:n,listTagOptionID:p,dataList:r,fCustomerNo:h},success:function(a){a.success&&(b.hide(),i.remind(2,"保存成功"),b.v&&b.v.refresh&&b.v.refresh(),b.trigger("success"))}},{submitSelector:e}):i.api({url:c.get("inSetting")?"/FCustomer/AddFCustomerForManager":"/FCustomer/AddFCustomer",type:"post",dataType:"json",errorMsgTitle:"添加客户发生错误，原因：",data:{ownerID:m,name:g,fullName:j,address:k,webSite:l,introduction:n,listTagOptionID:p,dataList:r,fCustomerNo:h},success:function(a){a.success&&(b.hide(),i.remind(2,"添加成功"),b.v&&b.v.refresh&&b.v.refresh(),b.trigger("success"))}},{submitSelector:e})},setupDoms:function(){var a=this.element;this.autoHeightTextarea=$(".area-auto-height",a)},setupComponent:function(){this.get("customerData")&&this.get("customerData").value.fCustomer;var a=this.element,b=$(".customer-tags-list-warp",a),c=i.getTagsByType(i.CONSTANT.TAG_TYPE.CUSTOMER);this.selectOwnerDialog=new k({isMultiSelect:!1,hasWorkLeaveBtn:!1,title:"选择同事"}),this.selectOwnerDialog.on("selected",function(b){$(".ownerID",a).val(b.name).attr("data-id",b.employeeID).trigger("autosize.resize")}),b.html(""),_.each(c,function(a){var c=a.name,d=a.options,e="",f="";d.length>0?_.each(d,function(a){var b=a.isDefault;b?(f=a.name,e+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'" data-selected="'+b+'">'+a.name+"</li></ul>"):e+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'">'+a.name+"</li></ul>"}):e='<ul class="mn-select-list"><li class="mn-select-item" data-value="0"></li></ul>',b.append('<li class="fn-clear"> <div class="selects-tit inputs-tit f-business-tag-id" data-fbusinesstagid="'+a.fBusinessTagID+'"> '+c+' </div> <div class="selects-warp"> <span select-cls="" class="mn-select-box "><span class="mn-select-title-wrapper select-for-dialog"><span class="mn-select-title ">'+f+'</span><span class="title-icon"></span></span>'+e+"</span> </div> </li>")});var d=i.getUserDefineFieldByType(1),e=$(".customer-define-fields-list-warp",a);if(d&&d.length>0&&e.show(),this.defineDateFieldArray=i.generateDefineField(e,d,l),this.get("inSetting")){var f=i.getCurrentEmp();$(".crm-owner-wrapper",a).show(),$(".ownerID",a).val(f.name).attr("data-id",f.employeeID)}j.AdjustTextAreaSize({element:$(".area-auto-height",a)}),$(".area-auto-height",a).trigger("autosize.resize")},fillFormData:function(){var a=this.get("customerData")&&this.get("customerData").value.fCustomer,b=this.element;a&&($(".c-fullname",b).val(a.fullName),$(".c-name",b).val(a.name),$(".c-number",b).val(a.fCustomerNo),$(".c-address",b).val(a.address),$(".c-webSite",b).val(a.webSite),$(".c-introduction",b).val(a.introduction),_.map(a.fBusinessTagRelations,function(a){a.fBusinessTagOptionID&&i.mnSetter($("[data-fbusinesstagid="+a.fBusinessTagID+"]",b).next().children(".mn-select-box"),a.fBusinessTagOptionID)}),$(".area-auto-height",b).trigger("autosize.resize"))}});c.exports=m});