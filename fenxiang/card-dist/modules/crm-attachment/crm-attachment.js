/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-attachment/crm-attachment",["widget","modules/crm-attachment/crm-attachment.html","modules/fs-attach/fs-attach-file-preview","util","modules/fs-qx/fs-qx-helper","modules/crm-file-dialog/crm-file-dialog","moment","uilibs/pagination2","modules/crm-tag-dialog/crm-tag-dialog","modules/crm-attachment-rename/crm-attachment-rename","nprogress"],function(a,b,c){var d=window,e=d.FS,f=a("widget"),g=a("modules/crm-attachment/crm-attachment.html"),h=a("modules/fs-attach/fs-attach-file-preview"),i=h.FileReader,j=new i,k=a("util"),l=a("modules/fs-qx/fs-qx-helper"),m=a("modules/crm-file-dialog/crm-file-dialog"),n=l.Uploader,o=a("moment"),p=a("uilibs/pagination2"),q=a("modules/crm-tag-dialog/crm-tag-dialog"),r=a("modules/crm-attachment-rename/crm-attachment-rename"),s=a("nprogress"),t=f.extend({attrs:{element:null,condition:{},pagination:null,attachUploader:null,fileDialog:null,tagStr:"",returnValues:[],selectedItems:[],tagDialog:null,suportH5:!0,flashFiles:[],contactData:k.getContactData(!0),renameDialog:null},events:{"click .crm-attachment-tag":"_tagFilter","click .crm-attachment-upload":"_upload","click .crm-attachment-no-file-upload":"_upload","click .crm-attachment-checkbox-all":"_toggleAll","click .crm-attachment-checkbox-single":"_toggleSingle","click .crm-attachment-set-tag":"_showTagDialog","click .crm-attachment-delete":"_delete","click .crm-attachment-file-rename":"_showRenameDialog","click .crm-attachment-file-preview":"_preview","mouseover .crm-attachment-file-tr":"_onMouseover","mouseout .crm-attachment-file-tr":"_onMouseout"},setup:function(){var a=t.superclass.render.apply(this,arguments);return this._init(),a},_init:function(){$(this.element).html(g),"undefined"==typeof Worker&&(this.set("suportH5",!1),$(".crm-attachment-file-flash-container",this.element).show()),this._getData(),this._initUploader(),this._initFileDialog(),this._initPagination(),this._initTag(),this._initRenameDialog()},_initUploader:function(){var a=this,b=new n({element:$(".crm-attachment-file-input",this.element),h5Opts:{multiple:!0,accept:"*/*",filter:function(b){return a.uploadFilter(b,"attach")}},flashOpts:{file_types:"*.*",file_types_description:"所有文件"},onSuccess:function(b,c){var d=a.get("returnValues"),e=JSON.parse(c).value;if(a.get("suportH5"))d.push({value:3,value1:e.filePath,value2:b.size,value3:b.name});else{var f=a.get("attachUploader"),g=a.get("fileDialog"),h=g.get("status"),i=a.get("flashFiles"),i=_.filter(i,function(a){return a.id!=b.id});d.push({value:3,value1:e.filePath,value2:b.size,value3:b.name}),f.removeFile(b.id,!1),i.length>0&&f.startUpload(),a.set("flashFiles",i),a.set("attachUploader",f),"show"!=h&&g.show(),g.add(b,e.filePath)}a.set("returnValues",d)},onProgress:function(){},onFailure:function(){k.alert("上传失败，请重试！"),a.get("attachUploader").removeAllFile(),s.done()},onSelect:function(b){if(a.get("suportH5")){var c=a.get("fileDialog"),d=c.get("status");"show"!=d&&c.show(),c.add(b)}else{var e=a.uploadFilter([b],"attach"),f=a.get("flashFiles");_.each(e,function(b){0==f.length&&a.get("attachUploader").startUpload(),f.push(b)}),a.set("flashFiles",f)}},onComplete:function(){a.get("suportH5")&&(s.done(),a._postData(),a.get("attachUploader").removeAllFile())}});this.set("attachUploader",b)},uploadFilter:function(a,b){a=[].concat(a);var c,d=[],e=[],f=this.get("contactData").u.uploadFileSizeLimit,g=this.get("attachUploader");return e=g.core.fileFilter,_.each(a,function(a){a.size<1024*1024*f&&a.size>0&&(_.find(e,function(b){return b.name==a.name})||("img"==b&&"jpg"==k.getFileType(a)&&d.push(a),"attach"==b&&d.push(a)))}),d.length<a.length&&("img"==b?c="选择的文件类型必须为jpg、gif、jpeg或png，大小不能超过"+f+"MB且文件名不能相同，内容不能为空。本次添加了"+d.length+"个文件。":"attach"==b&&(c="选择的文件大小不能超过"+f+"MB且文件名不能相同，内容不能为空。本次添加了"+d.length+"个文件。"),k.alert(c)),d},_initFileDialog:function(){var a=this,b=this.get("condition"),c=new m({fbrType:b.fbrType,dataID:b.dataID});c.on("fileSelect",function(){var b=$(".crm-attachment-file-input",a.element);"undefined"!=typeof Worker?b.click():k.alert("当前浏览器不能满足html5版的上传功能，请尝试其他浏览器")}),c.on("delete",function(b,c){if(!a.get("suportH5")){var d=a.get("returnValues");c&&(d=_.filter(d,function(a){return a.value1!=c}),a.set("returnValues",d))}a.get("attachUploader").removeFile(b)}),c.on("submit",function(b){a.set("tagStr",b),a.get("suportH5")?(a.get("attachUploader").startUpload(),s.start()):a._postData()}),c.on("cancel",function(){a.get("suportH5")||a.set("returnValues",[]),a.get("attachUploader").removeAllFile()}),this.set("fileDialog",c)},_initPagination:function(){var a=this,b=a.get("condition"),c=new p({element:$(".crm-attachment-page",a.element),pageSize:b.pageSize,totalSize:0,activePageNumber:1});c.on("page",function(c){b=a.get("condition"),b.pageNumber=c,a.set("condition",b),a._getData(b)}),a.set("pagination",c)},_initTag:function(){var a=this,b=new q({});b.on("submit",function(b){a._setTag(b)}),this.set("tagDialog",b)},_initRenameDialog:function(){var a=this,b=new r({});b.on("submit",function(b,c,d){a._rename(b,c,d)}),this.set("renameDialog",b)},_getData:function(a){var b=this;if(!a){a=this.get("condition");var c={fbrType:4,dataID:92,attachType:0,tagName:"",pageSize:10,pageNumber:1};a=_.extend(c,a),this.set("condition",a)}k.api({url:"/CrmAttach/GetCrmAttachFiles",type:"get",dataType:"json",data:a,success:function(c){if(c.success){var d=c.value.tags;b._generateTagHtml(d);var e=c.value.feedAttachEntitys;e.length>0?(b.get("pagination").setTotalSize(c.value.totalCount),b._generateFilesHtml(e),$(".crm-attachment-file-contanner",b.element).show(),$(".crm-attachment-no-file",b.element).hide(),$(".crm-attachment-no-file-flash",b.element).hide()):""!=a.tagName?(a.tagName="",b._getData()):($(".crm-attachment-file-contanner",b.element).hide(),b.get("suportH5")?$(".crm-attachment-no-file",b.element).show():$(".crm-attachment-no-file-flash",b.element).show())}}})},_generateTagHtml:function(a){var b=this.get("condition"),c="";""==b.tagName&&(c="crm-attachment-tag-disable");var d="<a class = 'crm-attachment-tag "+c+"' data-value = ''>全部</a>";a&&a.length>0&&_.each(a,function(a){c="",b.tagName==a.value&&(c="crm-attachment-tag-disable"),d+="<a class = 'crm-attachment-tag "+c+"' data-value = '"+a.value+"'>"+a.value+"</a>"}),$(".crm-attachment-tags",this.element).html(d)},_generateFilesHtml:function(a){var b="";!a||a.length<1||(this.set("selectedItems",[]),$(".crm-attachment-checkbox-all",this.element).hasClass("mn-selected")&&$(".crm-attachment-checkbox-all",this.element).removeClass("mn-selected"),_.each(a,function(a){var c="",d="";a.canPreview||(c="fn-hide"),_.each(a.tags,function(a){d+="<a class = 'crm-attachment-tag' data-value = '"+a+"'>"+a+"</a>&nbsp;"}),b+="<tr fileId = '"+a.attachID+"tr' class = 'crm-attachment-file-tr'><td><div class='mn-checkbox-box'><span class = 'mn-checkbox-item crm-attachment-checkbox-single' data-value = '"+a.attachID+"'></span></div></td>",b+="<td><img title = '"+a.attachName+"' src='"+e.BLANK_IMG+"' alt='icon' class='crm-attachment-image fs-attach-"+k.getFileType({name:a.attachName},!0)+"-small-icon file-icon fn-left'/><div class ='crm-attachment-file-name fn-left fn-text-overflow' title = '"+a.attachName+"'>"+a.attachName+"</div></td>",b+="<td class = 'crm-attachment-file-td'>"+k.getFileSize(a.attachSize)+"</td>",b+="<td class = 'crm-attachment-file-td'>"+d+"</td>",b+="<td class = 'crm-attachment-file-td'>"+a.employee.name+"</td>",b+="<td class = 'crm-attachment-file-td'>"+o.unix(a.createTime).format("YYYY年MMMDD日")+"</td>",b+="<td><a fileId = '"+a.attachID+"' data-name = '"+a.attachName+"' class = 'crm-attachment-file-rename'>重命名</a><a  href = '"+k.getDfLink(a.attachPath,a.attachName,!0)+"' title = '"+a.attachName+"' target ='_blank'>下载</a><a data-attachID = '"+a.attachID+"' data-attachName = '"+a.attachName+"' data-attachPath = '"+a.attachPath+"' class = 'crm-attachment-file-preview "+c+"'>预览</a></td></tr>"}),$(".crm-attachment-file-body",this.element).html(b))},_postData:function(){var a=this,b=this.get("tagStr"),c=this.get("returnValues"),d=this.get("condition"),e={tagNames:b,fileInfos:c,fbrType:d.fbrType,dataID:d.dataID};k.api({url:"/CrmAttach/AddCrmAttachs",type:"post",dataType:"json",data:e,success:function(b){return b.success?(a.set("returnValues",[]),a.reload(),k.remind(2,"上传成功"),s.done(),a.trigger("uploaded"),void 0):(k.remind(2,"上传失败，请重新上传"),s.done(),void 0)}})},_tagFilter:function(a){var b=$(a.currentTarget);if(b&&!b.hasClass("crm-attachment-tag-disable")){var c=b.attr("data-value"),d=this.get("condition");$("[data-value="+d.tagName+"]").removeClass("crm-attachment-tag-disable"),d.tagName=c,this.set("condition",d),$("[data-value="+d.tagName+"]").addClass("crm-attachment-tag-disable"),this._getData(d)}},_upload:function(){var a=$(".crm-attachment-file-input",self.element);"undefined"!=typeof Worker?a.click():k.alert("当前浏览器不能满足html5版的上传功能，请尝试其他浏览器")},reload:function(){var a=this.get("condition");this._getData(a)},reset:function(a){if(a){var b={fbrType:0,dataID:0,attachType:0,tagName:"",pageSize:10,pageNumber:1};a=_.extend(b,a),this.set("condition",a)}this.reload(a)},_toggleAll:function(a){var b=$(a.currentTarget);if(b){var c=this.get("selectedItems");c=[];var d=!0;b.hasClass("mn-selected")&&(d=!1),_.each($(".crm-attachment-checkbox-single",this.element),function(a){d?($(a).addClass("mn-selected"),$("[fileid="+$(a).attr("data-value")+"tr]").addClass("crm-attachment-file-tr-selected"),c.push($(a).attr("data-value"))):($(a).removeClass("mn-selected"),$("[fileid="+$(a).attr("data-value")+"tr]").removeClass("crm-attachment-file-tr-selected"))}),this.set("selectedItems",c)}},_toggleSingle:function(a){var b=$(a.currentTarget);if(b){var c=this.get("selectedItems");b.hasClass("mn-selected")?(c=_.without(c,b.attr("data-value")),$("[fileid="+$(b).attr("data-value")+"tr]").removeClass("crm-attachment-file-tr-selected")):(c.push(b.attr("data-value")),$("[fileid="+$(b).attr("data-value")+"tr]").addClass("crm-attachment-file-tr-selected")),this.set("selectedItems",c)}},_onMouseover:function(a){var b=$(a.currentTarget);b&&b.addClass("crm-attachment-file-tr-active")},_onMouseout:function(a){var b=$(a.currentTarget);b&&b.removeClass("crm-attachment-file-tr-active")},_showTagDialog:function(){var a=this.get("selectedItems");if(a.length<1)return k.alert("请选择要设置标签的附件。"),void 0;var b=this.get("condition"),c={};c={fbrType:b.fbrType,dataID:b.dataID},this.get("tagDialog").willShow(c)},_showRenameDialog:function(a){var b=$(a.currentTarget),c=b.attr("fileId"),d=b.attr("data-name");this.get("renameDialog").show(c,d)},_setTag:function(a){var b=this,c=this.get("condition"),d=this.get("selectedItems");if(!(d.length<1)){var e={fbrType:c.fbrType,dataID:c.dataID,attachIDs:d,tagNames:a};k.api({url:"/CrmAttach/SetCrmAttachTags",type:"post",dataType:"json",data:e,success:function(a){a.success&&(k.remind(2,"设置成功"),b.set("selectedItems",[]),b.reload())}})}},_rename:function(a,b,c){var d=this,e=this.get("condition"),f={fbrType:e.fbrType,dataID:e.dataID,attachID:a,oldAttachName:b,newAttachName:c};k.api({url:"/CrmAttach/ModifyCrmAttachName",type:"post",dataType:"json",data:f,success:function(a){a.success&&d.reload()}})},_preview:function(a){var b=$(a.currentTarget);b&&j.readFile({fileId:b.attr("data-attachID"),fileName:b.attr("data-attachName"),filePath:b.attr("data-attachPath")})},_delete:function(){var a=this.get("selectedItems");if(a.length<1)return k.alert("请选择要删除的附件。"),void 0;var b=this;k.confirm("您确定要删除选中的"+a.length+"个附件吗？","",function(){var c=b.get("condition"),d={fbrType:c.fbrType,dataID:c.dataID,attachIDs:a};k.api({url:"/CrmAttach/DeleteCrmAttachs",type:"post",dataType:"json",data:d,success:function(a){a.success&&(k.remind(2,"删除成功"),b.set("selectedItems",[]),b.trigger("uploaded"),b.reload())}})})},render:function(){var a=t.superclass.render.apply(this,arguments);return a},destroy:function(){var a=t.superclass.render.apply(this,arguments);return a}});c.exports=t});