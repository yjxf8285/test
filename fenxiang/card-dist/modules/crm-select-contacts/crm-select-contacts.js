/**
 * 纷享模块逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("modules/crm-select-contacts/crm-select-contacts",["dialog","util","uilibs/pagination2","modules/crm-select-contacts/crm-select-contacts.html"],function(a,b,c){var d=a("dialog"),e=a("util"),f=a("uilibs/pagination2"),g=a("modules/crm-select-contacts/crm-select-contacts.html"),h=d.extend({attrs:{title:"选择联系人",type:"search",url:"/Contact/GetUserContacts/",content:g,closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",width:800,height:600,condition:{},needToRest:!1,defaultCondition:{employeeID:0,isFirstChar:!1,source:0,createCustomer:0,startDate:0,endDate:0,tagOptionIDsJson:"",sortType:0,keyword:"",isContainSubordinate:0,pageSize:12,pageNumber:1},result:[]},setup:function(){var a=h.superclass.setup.apply(this,arguments),b=e.deepClone(this.get("defaultCondition"));return this.set("condition",b),this.render(),a},render:function(){var a=h.superclass.render.apply(this,arguments);return this._initOthers(),a},hide:function(){var a=h.superclass.hide.apply(this,arguments);return this.reset(),a},show:function(a){var b=this,c=h.superclass.show.apply(this,arguments);return a&&this.set("result",a),this._getData(this.get("condition"),function(){b.hide()}),c},reset:function(){this._unselectAll(),$(".crm-select-contacts-search-input",this.element).val("");var a=e.deepClone(this.get("defaultCondition"));this.set("condition",a)},events:{"click .crm-contacts-multiselect-info":"_showSelected","click .crm-select-contacts-unselect-all":"_unselectAll","click .crm-select-contacts-search-button":"_onButtonClick","keydown .crm-select-contacts-search-input":"_onButtonKeydown","click .crm-select-contacts-colleague":"_onColleageClick","mouseover .crm-select-contacts-colleague":"_onColleageMouseOver","mouseout .crm-select-contacts-colleague":"_onColleageMouseOut","click .crm-select-contacts-button-ok":"_submit","click .crm-select-contacts-button-cancel":"_cancel"},_initOthers:function(){this.get("title")&&$(".crm-select-contacts-title").text(this.get("title")),"modify"==this.get("type")&&($(".crm-select-contacts-search-title-container",this.element).hide(),$(".crm-select-contacts-result-info",this.element).hide());var a=this;a.get("condition").pageSize&&(a.pagination=new f({element:$(".crm-select-contacts-result-pagination",a.element),pageSize:a.get("condition").pageSize,totalSize:0,activePageNumber:1}),a.pagination.on("page",function(b){var c=a.get("condition");c.pageNumber=b,a.set("condition",c),a._getData(c)}))},_getData:function(a,b){var c=this;e.api({url:this.get("url"),type:"get",dataType:"json",data:a,success:function(a){return a.success?(c._getColleagueHtml(a.value.contacts,a.value.totalCount),!0):(b(),!1)}},{mask:c.element,maskCls:"self-cls"})},_getColleagueHtml:function(a,b){var c="",d=this;return a?(b>=0&&this.pagination.setTotalSize(b),$(".crm-select-contacts-result-container",this.element).empty(),_.each(a,function(a){var b=d.get("result"),f=_.find(b,function(b){return b.contactID==a.contactID});c+=f?"<div class = 'crm-select-contacts-colleague crm-select-contacts-colleague-selected fn-left fn-clear' data-value = '"+a.contactID+"' data-name ='"+a.name+"'  data-post = '"+a.post+"' data-department = '"+a.department+"' data-company = '"+a.company+"' data-picturePath = '"+a.picturePath+"'>":"<div class = 'crm-select-contacts-colleague fn-left fn-clear' data-value = '"+a.contactID+"' data-name ='"+a.name+"' data-post = '"+a.post+"' data-department = '"+a.department+"' data-company = '"+a.company+"' data-picturePath = '"+a.picturePath+"'>",c+="<img src ='"+e.getAvatarLink(a.picturePath,"2")+"' class = 'crm-select-contacts-colleague-img' data-value = '"+a.contactID+"' data-name ='"+a.name+"' data-picturePath = '"+a.picturePath+"' />",c+="<div class = 'crm-select-contacts-colleague-info'><div class = 'crm-select-contacts-colleague-name fn-text-overflow' title = '"+a.name+"'>"+a.name+"</div>",c+="<div class = 'crm-select-contacts-colleague-department fn-text-overflow' title = '"+a.post+"&nbsp;"+a.department+"'>"+a.post+"&nbsp;"+a.department+"</div></div><div class = 'crm-select-contacts-colleague-select fn-hide fn-right'>&nbsp;</div>",c+="<div class = 'crm-select-contacts-colleague-company fn-clear fn-text-overflow' title = '"+a.company+"'>"+a.company+"</div></div>"}),$(".crm-select-contacts-result-container",this.element).html(c),void 0):c},_showSelected:function(){this.get("needToRest")||(this.set("needToRest",!0),$(".crm-select-contacts-search-box",this.element).css("width",$(".crm-select-contacts-search-box",this.element).width()-103),$(".crm-select-contacts-search-input",this.element).css("width",$(".crm-select-contacts-search-input",this.element).width()-103),$(".crm-select-contacts-unselect-all",this.element).show(),$(".crm-select-contacts-result-box",this.element).hide(),$(".crm-select-contacts-result-selected-box",this.element).show())},_unselectAll:function(){var a=this.get("result");$(".crm-contacts-multiselect-info",this.element).hide(),$(".crm-contacts-multiselect-number",this.element).text(0),_.each(a,function(a){$("[data-value="+a.contactID+"]",$(".crm-select-contacts-result-box",this.element)).removeClass("crm-select-contacts-colleague-selected")}),this.set("result",[]),this._toSelecting(),$(".crm-select-contacts-result-selected-box",this.element).empty()},_toSelecting:function(){this.get("needToRest")&&(this.set("needToRest",!1),$(".crm-select-contacts-search-box",this.element).css("width",$(".crm-select-contacts-search-box",this.element).width()+103),$(".crm-select-contacts-search-input",this.element).css("width",$(".crm-select-contacts-search-input",this.element).width()+103),$(".crm-select-contacts-unselect-all",this.element).hide(),$(".crm-select-contacts-result-selected-box",this.element).hide(),$(".crm-select-contacts-result-box",this.element).show())},_onButtonClick:function(){var a=this.get("condition");a.keyword=$(".crm-select-contacts-search-input",this.element).val(),this.set("condition",a),this._toSelecting(),this._getData(a)},_onButtonKeydown:function(a){var b=a.which;13==b&&(this._onButtonClick(),a.preventDefault())},_onColleageClick:function(a){var b=this.get("result");$(a.currentTarget).hasClass("crm-select-contacts-colleague-selected")?($(a.currentTarget).removeClass("crm-select-contacts-colleague-selected"),b=_.filter(b,function(b){return b.contactID!=$(a.currentTarget).attr("data-value")}),$("[data-value="+$(a.currentTarget).attr("data-value")+"]",$(".crm-select-contacts-result-selected-box",this.element)).remove(),$("[data-value="+$(a.currentTarget).attr("data-value")+"]",$(".crm-select-contacts-result-box",this.element)).removeClass("crm-select-contacts-colleague-selected")):($(a.currentTarget).addClass("crm-select-contacts-colleague-selected"),b.push({contactID:$(a.currentTarget).attr("data-value"),name:$(a.currentTarget).attr("data-name"),post:$(a.currentTarget).attr("data-post"),company:$(a.currentTarget).attr("data-company"),department:$(a.currentTarget).attr("data-department"),picturePath:$(a.currentTarget).attr("data-picturePath")}),$(".crm-select-contacts-result-selected-box",this.element).append($(a.currentTarget).clone(!0))),this.set("result",b),b.length>0&&$(".crm-contacts-multiselect-info",this.element).show(),b.length<=0&&($(".crm-contacts-multiselect-info",this.element).hide(),this._toSelecting()),$(".crm-contacts-multiselect-number",this.element).text(b.length)},_onColleageMouseOver:function(a){!$(a.currentTarget).hasClass("crm-select-contacts-colleague-active")&&$(a.currentTarget).hasClass("crm-select-contacts-colleague")&&$(a.currentTarget).addClass("crm-select-contacts-colleague-active")},_onColleageMouseOut:function(a){$(a.currentTarget).hasClass("crm-select-contacts-colleague-active")&&$(a.currentTarget).removeClass("crm-select-contacts-colleague-active")},_submit:function(){this.trigger("selected",this.get("result")),this.hide()},_cancel:function(){this.hide()},destroy:function(){var a;return this.reset(),a=h.superclass.destroy.apply(this,arguments)}});c.exports=h});