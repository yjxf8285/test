/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/circles/atcircle/atcircle",["util","moment","modules/feed-list/feed-list","tpls/stream/stream-common"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=e.event,g=a("util"),h=(a("moment"),a("modules/feed-list/feed-list")),i=a("tpls/stream/stream-common"),j=g.getContactData(),k=i.InviteColleague;b.init=function(){var a,c,d=b.tplEl,e=b.tplName,i=$(".search-inp",d),l=$(".search-btn",d),m=$(".circles-nav-list",d),n="",o=$(".feed-list",d),p=$(".feed-list-pagination",d),q=$(".plan-status-type",d),r=$(".info-type-wrapper",d),s=j.p,t=j.u,u=g.getTplQueryParams(),v=$(".right-img-wrap",d),w=$(".right-htitle-wrap",d),x=u?parseInt(u.cid):0,y=function(a){a=a||"send",$(".status-wrapper",q).each(function(){var a=$(this);$("a",a).removeClass("depw-tabs-aon").eq(0).addClass("depw-tabs-aon")}),"send"==a?($(".plan-wrapper,.approve-wrapper,.work-wrapper",q).hide(),$(".include-file-wrap",q).show(),$(".plan-status-wrap",q).show()):"received"==a&&($(".plan-wrapper,.approve-wrapper,.work-wrapper,.include-file-wrap",q).hide(),$(".plan-status-wrap",q).show())},z=j.g;z=_.filter(z,function(a){return"999999"!=a.id}),_.each(z,function(a){a&&(n+='<li class="circle-nav-item fni-dep-con"><a class="circle-l tpl-nav-lb tpl-nav-lbq" href="#circles/atcircle/=/cid-'+a.id+'" title="">'+a.name+"</a></li>")}),m.html(n),g.regTplNav($(".circle-nav-item a",m)),c=new h({element:o,pagSelector:p,pagOpts:{pageSize:45,visiblePageNums:7},loadSize:15,withFeedRemind:!1,withLazyload:!0,listPath:"/feed/getFeedsFromCircleSend",defaultRequestData:function(){var a=$(".subtype-wrapper",q).filter(":visible"),b=g.getTplQueryParams();return{circleID:b?b.cid:0,subType:$(".depw-tabs-aon",a).attr("subtype")||0,feedAttachType:$(".include-file-wrap .depw-tabs-aon",d).attr("attachtype"),feedType:$(".plan-status-wrap .depw-tabs-aon",d).attr("feedtype"),keyword:_.str.trim(i.val())}},searchOpts:{inputSelector:i,btnSelector:l}}),c.load(),q.on("click",".plan-status",function(a){var b=$(this);b.hasClass("plan-status")&&($(".subtype-wrapper",q).hide(),b.is("[feedname]")&&$("."+b.attr("feedname")+"-wrapper").show()),a.preventDefault()}).on("click",".depw-tabs-a",function(){var a=$(this),b=a.closest(".status-wrapper"),d=a.attr("infotype");$(".depw-tabs-a",b).removeClass("depw-tabs-aon"),a.addClass("depw-tabs-aon"),"send"==d?c.opts.listPath="/feed/getFeedsFromCircleSend":"received"==d&&(c.opts.listPath="/feed/getFeeds"),c.reload()}),r.on("click","a",function(a){var b=$(this),d=b.attr("infotype"),e=r.next(".plan-status-type").find(".status-wrapper");e.find("a"),y(d),"send"==d?(e.filter(".include-file-wrap").show(),c.opts.listPath="/feed/getFeedsFromCircleSend"):(e.filter(".include-file-wrap").hide(),c.opts.listPath="/feed/getFeeds"),$("a",r).removeClass("depw-menu-aon"),b.addClass("depw-menu-aon"),c.reload(),a.preventDefault()}),l.click(function(a){c.reload(),a.preventDefault()});var A=function(a,b){var c,e=[];b?e=b:(s=_.reject(s,function(a){return a.id==t.id}),"999999"==x?e=s:_.each(s,function(a){var b=a.groupIDs;_.contains(b,x)&&e.push(a)}),e=e.slice(0,35)),$(".tpl-c .depw-title",d).text(a?a.name:""),c=a?a.name||t.allCompanyDefaultString:"",w.html('<span class="circle-name">'+c+"（"+e.length+"）"+'</span><span class="rt-apv right-yq-apv fn-hide"><a href="javascript:;" class="invite-apv fna-blue">邀请同事</a></span>'),n="",_.each(e,function(a){n+='<a href="#profile/=/empid-'+a.id+'" title="'+a.name+'"><img src="'+a.profileImage+'" /></a>'}),v.html(n),"999999"!=x&&$(".view-all-employee-l",d).attr("href","#circles/allcolleague/=/id-"+x+"/name-"+encodeURIComponent(c))};a=g.getContactDataById(x,"g"),a?A(a):parseInt(x)>0&&g.api({url:"/circle/getAllEmployees1",data:{circleID:x,keyword:"",userRole:0,isStop:0,isExceptCurrentUser:!0,isFirstChar:!1,pageSize:1e3,pageNumber:1},type:"get",success:function(a){var b;a.success&&(b=a.value,A({name:"已停用"},_.map(b.items.slice(0,35),function(a){return{id:a.employeeID,name:a.name,profileImage:g.getAvatarLink(a.profileImage,2)}})))}}),t.isAdmin?$(".right-yq-apv",w).show():$(".right-yq-apv",w).hide(),new k({trigger:$(".invite-apv",w)}).render(),f.one("beforeremove",function(a){a==e&&(c.destroy(),c=null)})}});