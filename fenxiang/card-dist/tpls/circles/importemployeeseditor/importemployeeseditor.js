/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/circles/importemployeeseditor/importemployeeseditor",["util","json","uilibs/pagination"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=a("util"),g=a("json"),h=a("uilibs/pagination"),i=function(a){var b=a.importEmployeePropertys,c=[];return _.each(b,function(a){var b=c[a.rowNo-1]||{},d=b[a.fieldName]||{};d.value=a.fieldValue,d.isError=a.isError,d.errorMessage=a.errorMessage||"",b[a.fieldName]=d,b.Index=a.rowNo,c[a.rowNo-1]=b}),c};b.init=function(){var a=f.getTplStore("departmentstaff","importData"),c=i(a);b.tplName;var d=b.tplEl,j=function(a){a=$.extend({element:d},a||{}),this.opts=a,this.element=a.element,this.init()};$.extend(j.prototype,{init:function(){this.element,this.opts,$("body").append('<div class="errtip">该昵称已经被系统内的其他员工使用</div>'),this.bindEvents()},showErr:function(a){var b=this.element,c=$(".importemployeeseditor-table tbody",b),d=$(".importemployeeseditor-table tbody tr",b),e=$(".importemployeeseditor-tabletit",b),f=$(".data-input",c),g=0;f.each(function(){var a=$(this).data("errormessage");a&&($(this).addClass("err"),$(this).closest("tr").addClass("errrow"),g++)}),d.each(function(){var a=$(this).is(".errrow");a||$(this).addClass("rightrow")}),d.length,$("tr.errrow",c).length;var h=a.employees,i=0,j=0;_.each(h,function(a){a.errorCount>0&&(i++,j+=a.errorCount)}),e.html('<span class="tit">批量导入员工</span><span class="info">（共有数据<b class="green">'+h.length+"</b>行，其中错误数据<b>"+i+"</b>行，共有<b>"+j+"</b>个错误）</span>")},trOdd:function(){var a=this.element,b=$(".importemployeeseditor-table tbody tr",a);b.each(function(a){a%2&&$(this).addClass("odd")})},bindEvents:function(){var a=this.element,b=this;a.on("click",".importemployeeseditor-table tr",function(){$(".importemployeeseditor-table tr",a).removeClass("cur"),$(this).addClass("cur")}),a.on("focus",".importemployeeseditor-table .data-input",function(){$(this).addClass("cur")}),a.on("blur",".importemployeeseditor-table .data-input",function(){$(this).removeClass("cur")}),a.on("mouseenter",".importemployeeseditor-table .data-input.err",function(){var a=$(this),b=a.data("errormessage"),c=a.width()+10,d=a.offset(),e=$(".errtip");e.css({top:d.top,left:d.left+c}).text(b).show()}),a.on("mouseout",".importemployeeseditor-table .data-input.err",function(){var a=$(".errtip");a.hide()}),a.on("click",".j-submit",function(){b.importEmployeesForUpdatePropertys($(this))})},importEmployeesForUpdatePropertys:function(b){var d=this.element,h=this,j=$("#importemployeeseditor-labelid-1",d),l=j.is(":checked"),n=$(".importemployeeseditor-table tbody",d);$(".importemployeeseditor-table tbody tr",d);var o=$(".data-input",n),p=$("#importemployeeseditor-labelid-0",d),q=p.is(":checked"),r=$("tr.rightrow",n),s=[],t="";if(q){if(0==r.length)return f.alert("没有正确的数据，不能提交"),!1;_.each($(".data-input",r),function(a){var a=$(a),b=a.data("a"),c=a.data("b"),d=a.val();s.push({A:b,B:c,C:d})}),t=g.stringify(s);var u={jsonString:t,isSendSMS:l};f.api({url:"/Management/ImportEmployeesForUpdatePropertys",type:"post",dataType:"json",data:u,beforeSend:function(){},success:function(b){var d;if(b.success){if(b.value.importSucceed&&f.showSucessTip("导入成功"),d=b.value,0==d.importEmployeePropertys.length)return e.navRouter.navigate("#departmentstaff",{trigger:!0}),void 0;c=i(d),a=d,m.setTotalSize(c.length),h.fetch(c.slice(0,k),d)}}},{submitSelector:b})}else{_.each(o,function(a){var a=$(a),b=a.data("a"),c=a.data("b"),d=a.val();s.push({A:b,B:c,C:d})}),t=g.stringify(s);var u={jsonString:t,isSendSMS:l};f.api({url:"/Management/ImportEmployeesForUpdatePropertys",type:"post",dataType:"json",data:u,beforeSend:function(){},success:function(b){var d;if(b.success){if(b.value.importSucceed&&f.showSucessTip("导入成功"),d=b.value,0==d.importEmployeePropertys.length)return e.navRouter.navigate("#departmentstaff",{trigger:!0}),void 0;c=i(d),a=d,m.setTotalSize(c.length),h.fetch(c.slice(0,k),d)}}},{submitSelector:b})}},fetch:function(a,b){var c=this,d=this.element,e=$(".importemployeeseditor-table tbody",d),f="";_.each(a,function(a){var b=a.Index,c=a.Account.value,d=a.Account.errorMessage,e=a.Department.value,g=a.Department.errorMessage,h=a.Email.value,i=a.Email.errorMessage,j=a.FullName.value,k=a.FullName.errorMessage,l=a.Mobile.value,m=a.Mobile.errorMessage,n=a.Name.value,o=a.Name.errorMessage,p=a.Password.value,q=a.Password.errorMessage,r=a.Post.value,s=a.Post.errorMessage;f+="<tr> <td>"+b+'</td> <td><input type="text" class="data-input" value="'+j+'" title="'+j+'" data-a="FullName" data-errormessage="'+k+'" data-b="'+b+'"></td> <td><input type="text" class="data-input" value="'+n+'" title="'+n+'" data-a="Name" data-errormessage="'+o+'" data-b="'+b+'"></td> <td><input type="text" class="data-input" value="'+c+'" title="'+c+'" data-a="Account" data-errormessage="'+d+'" data-b="'+b+'"></td> <td><input type="text" class="data-input" value="'+p+'" title="'+p+'" data-a="Password" data-errormessage="'+q+'" data-b="'+b+'"></td> <td><input type="text" class="data-input" value="'+l+'" title="'+l+'" data-a="Mobile" data-errormessage="'+m+'" data-b="'+b+'"></td> <td><input type="text" class="data-input" value="'+e+'" title="'+e+'" data-a="Department" data-errormessage="'+g+'" data-b="'+b+'"></td> <td><input type="text" class="data-input" value="'+h+'" title="'+h+'" data-a="Email" data-errormessage="'+i+'" data-b="'+b+'"></td> <td><input type="text" class="data-input" value="'+r+'" title="'+r+'" data-a="Post" data-errormessage="'+s+'" data-b="'+b+'"></td> </tr>'}),e.html(f),c.trOdd(),c.showErr(b)},destroy:function(){}});var k=1e3,l=new j,m=new h({element:$(".pagination-box",d),pageSize:k});m.render(),m.setTotalSize(c.length),l.fetch(c.slice(0,k),a),m.on("page",function(b){var d=(b-1)*k,e=d+k;l.fetch(c.slice(d,e),a)}),$(".return-back-btn",d).on("click",function(){e.navRouter.navigate("#departmentstaff/=/enter-import",{trigger:!0})})}});