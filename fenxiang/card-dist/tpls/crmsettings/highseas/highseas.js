/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/crmsettings/highseas/highseas",["util","modules/crm-list-header/crm-list-header","modules/crm-customer-highseas/crm-customer-highseas","modules/crm-object-import/crm-object-import","modules/crm-customer-export/crm-customer-export","../settings-common","dialog","modules/crm-high-seas/crm-high-seas","../settings-common.html","../settings-common.css","modules/crm-highsea-editsetting/crm-highsea-editsetting","modules/crm-select-highseas/crm-select-highseas","modules/crm-seaselect-follow/crm-seaselect-follow"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=e.event,g=a("util"),h=a("modules/crm-list-header/crm-list-header"),i=a("modules/crm-customer-highseas/crm-customer-highseas"),j=a("modules/crm-object-import/crm-object-import"),k=a("modules/crm-customer-export/crm-customer-export"),l=a("../settings-common"),m=a("modules/crm-highsea-editsetting/crm-highsea-editsetting"),n=a("modules/crm-select-highseas/crm-select-highseas"),o=a("modules/crm-seaselect-follow/crm-seaselect-follow");b.init=function(){var a=b.tplEl,c=b.tplName,d=null,p=null,q={highSeasID:0,employeeID:-1,keyword:"",pageSize:15,pageNumber:0},r=$(".crm-crmsettings-filterinfo",a),s=null,t=null,u=null,v=null,w=null,x=0,y=null;l.createCrmSettingLeftNav(a,c),f.on("switched",function(a){var b;a==c&&($(".nav-highseas").addClass("state-active"),b=g.getTplQueryParams2(),b&&(q.highSeasID=b.id,x=b.id,d&&d.refresh(q),p&&p.setTitle(b.name),t&&t.setTitle(b.name+"客户导出")))});var z=function(){p=new h({element:$(".high-seas-header",a),title:"",searchPlaceholder:"搜索客户、客户编号"}),p.on("search",function(a){d.refresh({keyword:a})})},A=function(){d=new i({element:$(".high-seas-list",a),condition:q,url:"/HighSeas/GetFCustomersHighSeasForManager"}),d.on("select",function(){$(".crm-highseas-select-show",a).show(),$(".crm-highseas-unselect-show",a).hide()}),d.on("unselect",function(){$(".crm-highseas-unselect-show",a).show(),$(".crm-highseas-select-show",a).hide()}),d.on("refreshed",function(a){p&&p.setCount(a)})},B=function(){s||(s=new j({title:"客户导入",downloadApi:"GetFCustomerHighSeasExcelTemplate",importApi:"/HighSeas/ImportFCustomerHighSeas",downloadText:"公海客户导入模板"}),s.on("uploaded",function(){d.refresh(q)}))},C=function(){t||(t=new k({title:"客户导出",hasBelongTo:!0,ownerName:"跟进人",exportApi:"/HighSeas/ExportFCustomersHighSeasExcel"}))},D=function(){u||(u=new o,u.on("selected",function(a){var b=d.getSelectItems();g.confirm("是否将选中的"+b.length+"个客户的跟进人设置为"+a.name+"？","",function(){g.api({url:"/HighSeas/AllocateCustomersForManager",type:"post",dataType:"json",data:{employeeID:a.employeeID,customerIDs:b.join(",")},success:function(a){if(a.success){var b=a.value.result,c=0,e=0;_.each(b,function(a){a.value1?c++:e++}),g.alert("本次调整有"+c+"个成功，"+e+"个失败"),d.refresh()}}})})}))},E=function(){v||(v=new o({title:"选择跟进人"}),v.on("selected",function(a){q.employeeID=a.employeeID,r.find("span").text(a.name),r.show(),d.refresh()}))},F=function(){w||(w=new m,w.on("modifySuccess",function(a){l.refreshHighSeas(),d.refresh(q),p.setTitle(a.name)}),w.on("deleteSuccess",function(){l.refreshHighSeas(),e.navRouter.navigate("#crmsettings/unallocatedcustomers",{trigger:!0})}))},G=function(){y||(y=new n({title:"选择公海",url:"/HighSeas/GetAllHighSeas/",hasCreate:!0}),y.on("selected",function(a){var b=d.getSelectItems();g.confirm("是否将选中的"+b.length+"个客户移动到"+a.name+"？","",function(){g.api({url:"/HighSeas/MoveHighseasCustomersForManager",type:"post",dataType:"json",data:{targetHighSeasID:a.id,customerIDs:b.join(",")},success:function(a){a.success&&d.refresh(q)}})})}),y.on("created",function(){l.refreshHighSeas()}))},H=function(){$(".crm-customer-import",a).on("click",function(){s.show()}),$(".crm-customer-export",a).on("click",function(){t.show({highSeasID:x})}),$(".crm-set-owner",a).on("click",function(){u.show(d.get("highSeasPermissions"))}),$(".crm-cancel-owner",a).on("click",function(){var a=d.getSelectItems();g.confirm("是否要取消选中的"+a.length+"个客户的跟进人？","",function(){g.api({url:"/HighSeas/TakeBackCustomersForManager",type:"post",dataType:"json",data:{customerIDs:a.join(",")},success:function(a){a.success&&d.refresh()}})})}),$(".crm-move-other",a).on("click",function(){y.show(x)}),$(".crm-remove-from-highseas",a).on("click",function(){var a=d.getSelectItems();g.confirm("是否要将选中的"+a.length+"个客户移出该公海？","",function(){var b={highSeasID:x,customerIDs:a.join(",")};g.api({url:"/HighSeas/RemoveHighseasCustomers",type:"post",dataType:"json",data:b,success:function(a){a.success&&d.refresh(q)}})})}),$(".crm-highsea-edit",a).on("click",function(){w.show(x)}),$(".crm-filter-by-employee",a).on("click",function(){v.show(d.get("highSeasPermissions"))}),r.find("a").on("click",function(){q.employeeID=-1,d.refresh(q),r.hide()})};!function(){z(),A(),B(),C(),E(),F(),G(),D(),H()}()}});