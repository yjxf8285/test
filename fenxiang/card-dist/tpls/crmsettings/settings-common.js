/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/crmsettings/settings-common",["dialog","modules/crm-high-seas/crm-high-seas","util","./settings-common.html","./settings-common.css"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.event;var f=a("dialog"),g=a("modules/crm-high-seas/crm-high-seas"),h=a("util"),i=a("./settings-common.html"),j=(a("./settings-common.css"),$(i));b.init=function(a){var b,c=h.getContactData(),d=c.u,e=j.filter(".settings-tpl-left").html(),f=$(".crm-tpl-l .tpl-inner",a);f.html(e),b=$(".bind-email-l-wrapper",f);var g=$(".settings-nav-list",a);g.find("li > a").click(function(){var a=$(this);g.find("li > a").removeClass("depw-menu-aon"),a.addClass("depw-menu-aon")}),d.exmailDomain&&b.show(),h.regTplNav($("a",g),"depw-menu-aon")},b.saveSuccessAnimated=function(a){var b=$(".save-success-apv",a);b.animate({top:"0px"},300,function(){setTimeout(function(){b.animate({top:"54px"},300)},2e3)})},b.refreshHighSeas=function(){b.highSeasWidget&&b.highSeasWidget.refresh()},b.highSeasWidget=null,b.createCrmSettingLeftNav=function(a){var c=j.filter(".crm-settings-left-tpl").html(),d=$(".crm-tpl-l .tpl-inner",a),e=h.getCrmData(),i=e.tags;d.html(_.template(c)({tagData:_.map(i,function(a){return{tagType:a.value,tagName:a.value1}}),userDefineFieldData:[{tagType:1,tagName:"客户"},{tagType:2,tagName:"联系人"},{tagType:3,tagName:"机会"}]})),d.on("click",".nav-highseas",function(a){$(".ul-list",d).hide(),null==b.highSeasWidget?(b.highSeasWidget=new g({api:"/HighSeas/GetAllHighSeas"}),b.highSeasWidget.on("list",function(a,c){b.trigger("list",a,c)})):b.highSeasWidget.refresh();var c=$(".label-manage-list",d);c.hide(),b.highSeasWidget.show(a),a.preventDefault(),a.stopPropagation()}),d.on("click",".label-manage-l",function(a){$(".ul-list",d).hide();var c=$(".label-manage-list",d);c.show(),b.highSeasWidget&&b.highSeasWidget.hide(),a.preventDefault(),a.stopPropagation()}),d.on("click",".label-salesstage-l",function(a){$(".ul-list",d).hide();var c=$(".label-manage-list",d);c.hide(),l.load(),b.highSeasWidget&&b.highSeasWidget.hide(),a.preventDefault(),a.stopPropagation()}),d.on("click",".user-define-field-l",function(a){$(".ul-list",d).hide(),b.highSeasWidget&&b.highSeasWidget.hide();var c=$(".user-define-field-list",d);c.show(),a.preventDefault(),a.stopPropagation()}),h.regGlobalClick($(".label-manage-list",d)),h.regGlobalClick($(".user-define-field-list",d)),h.regTplNav($(".tpl-nav-l",d),"state-active"),h.regTplNav($(".user-define-field-list a",d),"state-active"),h.regTplNav($(".label-manage-list a",d),"state-active");var k=f.extend({attrs:{width:500,closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",content:j.filter(".crm-salesstagedialog-tpl").html(),className:"dialog-createnewproductdialog"},events:{"click .js-inuse":"selectTr","click .button-submit":"submit","click .button-cancel":"hide"},selectTr:function(a){var b=$(a.currentTarget),c=b.closest("tr"),d=c.find("td input");b.parent().is(".mn-disabled-checkbox-box")?(a.preventDefault(),a.stopPropagation()):b.is(".mn-selected")?(d.prop("disabled",!0),b.data("value",!1)):(d.prop("disabled",!1),b.data("value",!0))},load:function(){var a=this;h.api({url:"/SalesStage/GetAllSalesStages",type:"get",dataType:"json",success:function(b){if(b.success){var c=b.value.salesStages,d=$(".salesstagedialog-table tbody",a.element),e="";_.each(c,function(a){var b=a.salesStageNo,c=a.inUse,d=a.name,f=a.winRate,g="",h="",i="";c?i="mn-selected":g='disabled="disabled"',(10==b||11==b)&&(g='disabled="disabled"',h="mn-disabled-checkbox-box"),e+='<tr data-salesstageno="'+b+'"> <td><div class="mn-checkbox-box checkbox-for-comtable '+h+'">&nbsp;&nbsp;<span class="mn-checkbox-item js-inuse '+i+'" data-value="'+c+'"></span> </div></td> <td><input type="text" class="crm-textfield input-name" value="'+d+'" '+g+'></td> <td><input type="text" class="crm-textfield input-winrate" value="'+f+'" '+g+"></td> </tr>"}),d.html(e),a.show()}}})},submit:function(){var a=this,b=$(".salesstagedialog-table tbody",a.element),c=[];b.find("tr").each(function(){var a=$(this).data("salesstageno"),b=$(this).find(".js-inuse").data("value"),d=$(this).find(".input-name").val(),e=$(this).find(".input-winrate").val();c.push({inUse:b,name:d,salesStageNo:a,winRate:Number(e)})}),h.confirm("您确定要保存您对销售阶段设置的修改吗？","",function(){h.api({url:"/SalesStage/SetSalesStages",type:"post",data:{salesStagesJson:c},dataType:"json",success:function(b){b.success&&(h.remind(1,"修改成功"),a.load())}})})}}),l=new k;l.render()}});