/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/contracts/showcontract/showcontract",["util","modules/feed-list/feed-list","dialog","moment","datatable","confirmbox","uilibs/tabs2","modules/publish/publish-helper","modules/crm-attachment-simple/crm-attachment-simple","modules/crm-attachment/crm-attachment","modules/crm-select-colleague/crm-select-colleague","modules/crm-salesclue-edit/crm-salesclue-edit","modules/crm-contract-edit/crm-contract-edit","modules/crm-publish/crm-publish","modules/crm-paymentplan-edit/crm-paymentplan-edit","modules/crm-paymentrecord-edit/crm-paymentrecord-edit","modules/crm-follow-up/crm-follow-up"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.event;var f=a("util"),g=a("modules/feed-list/feed-list");a("dialog");var h=a("moment");a("datatable"),a("confirmbox");var i=a("uilibs/tabs2");a("modules/publish/publish-helper");var j=a("modules/crm-attachment-simple/crm-attachment-simple"),k=a("modules/crm-attachment/crm-attachment"),l=a("modules/crm-select-colleague/crm-select-colleague");a("modules/crm-salesclue-edit/crm-salesclue-edit");var m=a("modules/crm-contract-edit/crm-contract-edit"),n=a("modules/crm-publish/crm-publish"),o=a("modules/crm-paymentplan-edit/crm-paymentplan-edit"),p=a("modules/crm-paymentrecord-edit/crm-paymentrecord-edit"),q=a("modules/crm-follow-up/crm-follow-up"),r=function(a){a=$.extend({element:null},a||{}),this.options=a,this.$el=a.element,this.myID=this.options.queryParams.id,this.init()};$.extend(r.prototype,{init:function(){this.$el,this._getTagsDatas(),this.setupComponent(),this.bindEvents(),this._getContractPaymentsByContractID();var a=this,c=b.tplName;e.event.one("beforeremove",function(b){b==c&&a.destroy()})},_getContractPaymentsByContractID:function(){var a=this,b=$(".returned-money-warp",this.$el),c=$(".plan-warp",b),d=$(".record-warp",b),e=[],g=[],i=function(b){var d="";g=[],_.each(b,function(b){var c=b.contractPaymentPlanID,e=b.ownerID,f=b.owner.name,i=_.str.numberFormat(parseFloat(b.amount),2),j=_.str.numberFormat(parseFloat(b.paidAmount),2),k=_.str.numberFormat(parseFloat(b.unPaidAmount),2),l=b.paymentTimes,m=b.expectedTime,n=b.isPaied;n=n?"已付清":"未付清",m=h.unix(m).format("YYYY年MM月DD日"),g.push({contractPaymentPlanID:c,contractID:a.myID,contractTitle:$(".crm-detail-tab").find(".hd-titname").text(),ownerID:e,ownerName:f,paymentTimes:l,paymentTime:b.expectedTime,amount:b.amount}),d+='<tr><td class="text-black">'+i+'</td> <td class="text-black">'+j+'</td><td class="text-black">'+k+"</td> <td>"+l+"期</td> <td>"+m+"</td> <td>"+n+'</td> <td> <a class="plan-modify-btn" href="javascript:;" data-id="'+c+'">编辑</a> <a class="plan-del-btn" href="javascript:;" data-id="'+c+'">删除</a> <a class="record-add-btn-b" href="javascript:;" data-id="'+c+'">添加回款记录</a> </td> <td></td> </tr>'}),$(".crm-com-table tbody",c).html(d)},j=function(a){var b="";_.each(a,function(a){var c=a.contractPaymentRecordID,d=_.str.numberFormat(parseFloat(a.amount),2),f=a.paymentType,g=a.paymentTimes,i=a.paymentTime,j=a.isBilling,k="",l="";switch(e.push({contractPaymentRecordID:c,amount:d,paymentType:f,paymentTimes:g,paymentTime:i,isBilling:j}),j?(k="已开票",l="设置为未开票"):(k="未开票",l="设置为已开票"),i=h.unix(i).format("YYYY年MM月DD日"),f){case 1:f="支票";break;case 2:f="现金";break;case 3:f="邮政汇款";break;case 4:f="电汇";break;case 5:f="网上转账";break;case 6:f="其他"}b+=' <tr> <td class="text-black">'+d+"</td> <td>"+f+"</td> <td>"+g+"期</td> <td>"+i+"</td> <td>"+k+'</td> <td> <a class="record-modify-btn" href="javascript:;" data-id="'+c+'">编辑</a> <a class="record-del-btn" href="javascript:;" data-id="'+c+'">删除</a> <a class="record-setticket-btn" href="javascript:;" data-id="'+c+'" >'+l+"</a> </td> <td></td> </tr>"}),$(".crm-com-table tbody",d).html(b)},k=function(){f.api({url:"/Contract/GetContractPaymentsByContractID",type:"post",dataType:"json",data:{contractID:a.myID},success:function(a){if(a.success){var b=a.value.contractPaymentPlans,e=a.value.contractPaymentRecords;b.length>0?(i(b),$(".crm-com-table",c).show(),$(".plan-add-btn",c).show(),$(".isnodatatip",c).hide()):($(".crm-com-table",c).hide(),$(".plan-add-btn",c).hide(),$(".isnodatatip",c).show()),e.length>0?(j(e),$(".crm-com-table",d).show(),$(".record-add-btn",d).show(),$(".isnodatatip",d).hide()):($(".crm-com-table",d).hide(),$(".record-add-btn",d).hide(),$(".isnodatatip",d).show())}}})};c.on("click",".plan-add-btn",function(){a.addPaymentPlanDialog.show()}),c.on("click",".plan-add-btn-b",function(){a.addPaymentPlanDialog.show()}),c.on("click",".record-add-btn-b",function(){var b=$(this),c=b.data("id"),d=_.filter(g,function(a){return a.contractPaymentPlanID==c?a:void 0});a.addPaymentRecordDialog.show(d[0])}),c.on("click",".plan-modify-btn",function(){var b=$(this),c=b.data("id"),d=_.filter(g,function(a){return a.contractPaymentPlanID==c?a:void 0});a.editPaymentPlanDialog.show(d[0])}),c.on("click",".plan-del-btn",function(){var b=$(this),c=b.data("id");f.confirm("你确定要删除该回款计划吗？","",function(){f.api({url:"/Contract/DeleteContractPaymentPlans",type:"post",dataType:"json",data:{contractPaymentPlanIDs:c},success:function(b){b.success&&(f.remind(2,"删除成功"),a.refreshPayment())}})})}),d.on("click",".record-add-btn",function(){a.addPaymentRecordDialog.show()}),d.on("click",".record-add-btn-b",function(){a.addPaymentRecordDialog.show()}),d.on("click",".record-modify-btn",function(){var b=$(this),c=b.data("id"),d=_.filter(e,function(a){return a.contractPaymentRecordID==c?a:void 0});a.editPaymentRecordDialog.show(d[0])}),d.on("click",".record-del-btn",function(){var b=$(this),c=b.data("id");f.confirm("你确定要删除该回款记录吗？","",function(){f.api({url:"/Contract/DeleteContractPaymentRecords",type:"post",dataType:"json",data:{contractPaymentRecordIDs:c},success:function(b){b.success&&(f.remind(2,"删除成功"),a.refreshPayment())}})})}),d.on("click",".record-setticket-btn",function(){var a=$(this),b=a.data("id"),c=!0,d="已开票";"设置为已开票"==a.text()?(a.text("设置为未开票"),c=!0,d="已开票"):(a.text("设置为已开票"),c=!1,d="未开票"),f.api({url:"/Contract/UpdateContractPaymentRecordsIsBilling",type:"post",dataType:"json",data:{contractPaymentRecordIDs:b,isBilling:c},success:function(a){a.success&&(f.remind(2,"设置成功，状态："+d),k())}})}),k(),this.refreshPayment=function(){k(),this.refresh()}},bindEvents:function(){var a=this.$el,b=this;f.mnEvent($(".updatestates-select-list",a),"change",function(c,d){var e=b.responseData.value.remainingDaysDesc;f.confirm("是否确定要将当前合同的【状态】变更为【"+d+"】？"," ",function(){f.api({url:"/Contract/UpdateContractsStates",type:"post",dataType:"json",data:{contractIDs:b.myID,states:c},success:function(a){if(a.success){var c=a.value.result,d="";_.each(c,function(a){var c=a.value1,e=a.value2;c?(f.remind(1,"变更成功"),b.load()):(d="变更合同状态失败,原因没有权限："+e,f.alert(d,function(){}))})}}})},{onCancel:function(){$(".updatestates-select-list",a).find(".mn-select-title").text(e)}})}),a.on("click",".crm-button-back",function(){b._backToListPage()}),a.on("click",".returned-seemore-btn",function(){b.tab.select("tab-returned-money")}),a.on("click",".delete-btn",function(){b._delete()}),a.on("click",".modify-btn",function(){b.modifyCompetitorDialog.show()}),a.on("click",".canchangeowner-btn",function(){b.selectColleagueS.show()}),a.on("click",".follow-switch-btn",function(a){b._switchFollow(a)}),this.selectColleagueS.on("selected",function(c){var d=b.responseData.value.contract.owner.employeeID;f.confirm("你确定要将合同的负责人变更为"+c.name+"吗？"," ",function(){f.api({url:"/Contract/UpdateContractsOwnerID",type:"post",dataType:"json",data:{contractIDs:b.myID,ownerID:c.employeeID},success:function(e){if(e.success){var g=e.value.result,h="";_.each(g,function(e){var g=e.value1,i=e.value2;g?(f.remind(1,"变更成功"),$(".owner-name",a).text(c.name),b.followUp.replace(d,c)):(h="变更合同的负责人失败，原因："+i+"</br>",f.alert(h))})}}})})})},_switchFollow:function(a){var b=$(a.target),c=this;b.hasClass("following")?f.api({url:"/Contract/ContractCancelFollow",type:"post",dataType:"json",data:{contractID:c.myID},success:function(a){a.success&&b.removeClass("following").addClass("no-follow").text("关注")}}):f.api({url:"/Contract/ContractFollow",type:"post",dataType:"json",data:{contractID:c.myID},success:function(a){a.success&&b.removeClass("no-follow").addClass("following").text("已关注")}})},_getTagsDatas:function(){var a=f.getCrmData(),b=a.functionPermissions,c=f.getTagsByType(9),d=[],e=this,g=[{text:"不限",value:0}],h=[{text:"不限",value:0}];_.each(c,function(a){d.push(a),109===a.systemTagCode&&(_.each(a.options,function(a){h.push({text:a.name,value:a.fBusinessTagOptionID})}),e.marketingEventTypeFBusinessTagID=a.fBusinessTagID)}),_.extend(this,{allTags:d,competitorscale:g,competitiveness:h,functionPermissions:b})},setCrmAttachment:function(){var a=this,b=$(".crm-attachment-simple-warp",this.$el);this.attachment=new j({element:b,condition:{dataID:a.myID,fbrType:6}}),this.attachment.render(),this.attachment.on("toAll",function(){a.tab.select("tab-files")}),this.attachment.on("uploaded",function(){a.attachmentList.reload()})},setAttachmentList:function(){var a=this,b=$(".crm-attachmentlist-simple-warp",this.$el);this.attachmentList=new k({element:b,condition:{fbrType:6,dataID:a.myID}}),this.attachmentList.on("uploaded",function(){a.attachment.reload()})},setFeedList:function(){var a=this,b=$(".crm-feed-list-warp",this.$el),c=$(".feed-list-pagination",this.$el),d=$("",this.$el);this.feedList=new g({element:b,pagSelector:c,pagOpts:{pageSize:15,visiblePageNums:3},GetBatchFilesSource:1,crmParam:{type:"contract",id:a.myID},listPath:"/CrmFeed/GetFeeds",defaultRequestData:function(){return{fbrType:6,dataID:a.myID,type:1,keyword:_.str.trim(d.val())}},listEmptyText:"暂无记录"}),this.feedList.load()},showFnBtn:function(){var a=this.$el,b=this.responseData.value,c=b.canModify,d=b.canDelete,e=b.canChangeOwner;c?$(".modify-btn",a).show():$(".modify-btn",a).hide(),d?$(".delete-btn",a).show():$(".delete-btn",a).hide(),e?$(".canchangeowner-btn-r",a).show():$(".canchangeowner-btn-r",a).hide()},render:function(){var a,b,c=this.$el,d=this,e=this.responseData.value.contract||null,g=this.responseData.value.customer||0,i="",j=$(".follow-switch-btn",c),k=f.getTplQueryParams2();if(g?(b={id:g.customerID,returnUrl:"contracts/showcontract/=/param-"+encodeURIComponent(JSON.stringify(k))},$(".jdata-customername",c).html('<a href="#customers/showcustomer/=/param-'+encodeURIComponent(JSON.stringify(b))+'">'+g.name+"</a>")):$(".jdata-customername",c).html('<a href="javascript:;"></a>'),e){switch(a=e.fBusinessTagRelations,i="",_.each(a,function(a){var b=a.fBusinessTagName,c=a.fBusinessTagOptionName;i+='<li class="fn-clear"><span class="input-tip">'+b+'</span><div class="input-wrapper">'+c+"</div></li>"}),$(".product-fbusinesstagrelations",c).html(i),e.isFollow?j.addClass("following").text("已关注"):j.addClass("no-follow").text("关注"),$(".hd-titname",c).text(e.title),$(".jdata-ownername",c).text(e.owner.name),$(".jdata-creatorname",c).text(e.creator.name),$(".jdata-createtime",c).text(h.unix(e.createTime).format("YYYY年MMMDD日 HH:mm")),$(".jdata-lasteditemployeename",c).text(e.lastEditEmployee.name),$(".jdata-lastedittime",c).text(h.unix(e.lastEditTime).format("YYYY年MMMDD日 HH:mm")),$(".jdata-name",c).text(e.name),$(".jdata-company",c).text(e.company),e.oristates=e.states,e.states){case 1:e.states="执行前";break;case 2:e.states="执行中";break;case 3:e.states="结束";break;case 4:e.states="意外终止"}$(".updatestates-select-list",c).find(".mn-select-title").text(e.states),e.discount>=10?e.discount="无折扣":e.discount+="折",$(".jdata-discount",c).text(e.discount),$(".jdata-remainingdaysdesc",c).text(this.responseData.value.remainingDaysDesc+(1==e.oristates||2==e.oristates?"天":"")),$(".jdata-contractperiod",c).text(this.responseData.value.contractPeriod+"天"),$(".jdata-contractno",c).text(e.contractNO),$(".jdata-content",c).text(e.content),$(".jdata-productdescription",c).text(e.productDescription),$(".jdata-paymenttypedesc",c).text(e.paymentTypeDesc),$(".jdata-customersigner",c).text(e.customerSigner),$(".jdata-signername",c).text(e.signer.name),$(".jdata-states",c).text(e.states),$(".jdata-customerstatetagoptionname",c).text(e.customerStateTagOptionName),$(".jdata-plannum",c).text(this.responseData.value.planNum+"期"),$(".jdata-recordnum",c).text(this.responseData.value.recordNum+"笔"),$(".jdata-plantotalamount",c).text(_.str.numberFormat(parseFloat(this.responseData.value.planTotalAmount),2)),$(".jdata-recordtotalamount",c).text(_.str.numberFormat(parseFloat(this.responseData.value.recordTotalAmount),2)),this.responseData.value.recordTotalAmount>0?e.totalAmount?$(".jadta-recordstates",c).text("已回款"+parseFloat(100*(this.responseData.value.recordTotalAmount/e.totalAmount)).toFixed(4)+"%"):$(".jadta-recordstates",c).text(""):$(".jadta-recordstates",c).text("未回款"),$(".jdata-totalamount",c).text(_.str.numberFormat(parseFloat(e.totalAmount),2)+"元"),$(".jdata-actualincome",c).text("￥"+_.str.numberFormat(parseFloat(e.actualIncome),2)),$(".jdata-begindate",c).text(h.unix(e.beginDate).format("YYYY年MM月DD日")),$(".jdata-enddate",c).text(h.unix(e.endDate).format("YYYY年MM月DD日")),$(".jdata-signdate",c).text(h.unix(e.signDate).format("YYYY年MM月DD日")),$(".jdata-location",c).text(e.location),$(".jdata-expectedcost",c).text(_.str.numberFormat(parseFloat(e.expectedCost),2)),$(".jdata-actualcost",c).text(_.str.numberFormat(parseFloat(e.actualCost),2)),$(".jdata-expectedincome",c).text(_.str.numberFormat(parseFloat(e.expectedIncome),2)),$(".jdata-actualincome",c).text(_.str.numberFormat(parseFloat(e.actualIncome),2)),$(".jdata-l",c).text(e.L),$(".jdata-executiondescription",c).text(e.executionDescription),$(".jdata-summary",c).text(e.summary),$(".jdata-effect",c).text(e.effect),$(".jdata-description",c).text(e.description)}this.showFnBtn(),this.addPaymentPlanDialog=new o({contractID:e.contractID,contractTitle:e.title,ownerID:Number(e.owner.employeeID),ownerName:e.owner.name}),this.addPaymentPlanDialog.v=this,this.editPaymentPlanDialog=new o({contractID:e.contractID,contractTitle:e.title,ownerID:Number(e.owner.employeeID),ownerName:e.owner.name}),this.addPaymentRecordDialog=new p({contractID:e.contractID,ownerID:Number(e.owner.employeeID),ownerName:e.owner.name}),this.editPaymentRecordDialog=new p({contractID:e.contractID,ownerID:Number(e.owner.employeeID),ownerName:e.owner.name}),this.addPaymentPlanDialog.on("success",function(){d.refreshPayment()}),this.editPaymentPlanDialog.on("success",function(){d.refreshPayment()}),this.addPaymentRecordDialog.on("success",function(){d.refreshPayment()}),this.editPaymentRecordDialog.on("success",function(){d.refreshPayment()})},load:function(){var a=this.$el,b=this;f.api({url:"/Contract/GetContractDetailByID",type:"get",dataType:"json",data:{contractID:b.myID,attachNum:6},success:function(c){if(c.success){b.responseData=c,b.render();var d=[],e=c.value.contract.contractParticipants;_.each(e,function(a){var b=a.employee;d.push(b)}),b.followUp=new q({element:$(".contract-partin",a),addApi:"/Contract/AddContractParticipants",deleteApi:"/Contract/DeleteContractParticipants",parameter:{contractID:b.myID,employeeIDs:""},selectColleagueS:b.selectColleagueS,ownerID:c.value.contract.ownerID,items:d,title:"合同参与人",typeName:"合同",name:"参与人",btnAddTitle:"添加合同参与人",addWinTitle:"选择参与人"})}else f.alert(c.message,function(){b._backToListPage()},{zIndex:3e3})}},{errorAlertModel:"1"})},refresh:function(){this.load()},_backToListPage:function(){var a=f.getTplQueryParams2();e.navRouter.navigate(a.returnUrl,{trigger:!0}),e.event.trigger("dataUpdate")},_delete:function(){var a=this;f.confirm("你确定要删除该合同吗？删除后将不可恢复。","",function(){f.api({url:"/Contract/DeleteContracts",type:"post",dataType:"json",data:{contractIDs:a.myID},success:function(b){if(b.success){var c=b.value.result,d=c[0],e=d.value1,g=d.value2;e?a._backToListPage():f.alert("删除失败，原因："+g)}}})})},setPublish:function(){var a=this,b=this.$el,c=this.options.queryParams.id;this.feedpublish=new n({element:$(".feed-submit-box-warp",b),title:"新建合同记录",placeholder:"发布新合同记录",type:"feed",condition:{fileInfos:[],feedContent:"",fbrType:6,dataID:c},display:["picture","attach","at","topic"]}),this.feedpublish.on("post",function(){a.feedList.load()})},setupComponent:function(){var a=this,b=$(".tab-menu",this.$el);this.modifyCompetitorDialog=new m({contractID:this.options.queryParams&&this.options.queryParams.id}),this.modifyCompetitorDialog.on("success",function(){a.refresh()}),this.modifyCompetitorDialog.v=this,this.tab=new i({element:b,container:this.$el,items:[{value:"tab-time-line",text:"时间线"},{value:"tab-returned-money",text:"回款明细"},{value:"tab-base-info",text:"基本信息"},{value:"tab-files",text:"附件"}]}),this.selectColleagueS=new l({isMultiSelect:!1,title:"请选择负责人"}),this.setPublish(),this.setFeedList(),this.setCrmAttachment(),this.setAttachmentList()},destroy:function(){this.feedpublish&&this.feedpublish.destroy()}}),b.init=function(){var a=b.tplEl;b.tplName;var c=f.getTplQueryParams2(),d=new r({element:a,queryParams:c});d.load()}});