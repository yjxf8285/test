/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/test13/test13",["moment","widget","modules/card-reply/feed-reply"],function(a,b){var c=a("moment"),d=a("widget"),e=d.extend({attrs:{initFocusDate:{getter:function(a){return a||(a=c()),c(c(a).format("YYYY-MM-DD"),"YYYY-MM-DD")}},currentDate:{getter:function(a){return a?c(a,"YYYY-MM-DD"):this.get("initFocusDate")},setter:function(a){return a.format("YYYY-MM-DD")}},panelState:"",inputSelect:!0},events:{"click .card-calendar-nav-prev":"_clickNavPrev","click .card-calendar-nav-next":"_clickNavNext","click .card-calendar-title .label-year":"_clickLabelYear","click .card-calendar-title .label-month":"_clickLabelMonth","click .card-calendar-year-panel .year-nav-prev":"_clickYearNavPrev","click .card-calendar-year-panel .year-nav-next":"_clickYearNavNext","click .card-calendar-year-panel .year-item":"_clickYearItem","click .card-calendar-month-panel .month-item":"_clickMonthItem","click .card-calendar-date-panel .date-body .date-cell":"_clickDateCell"},setup:function(){var a,b=this;return a=e.superclass.setup.apply(this,arguments),this._stampStore={},this.get("inputSelect")&&this.on("dateclick",function(a){b.removeStamp("selected"),b.setStamp("selected",c(a,"YYYY-MM-DD")),b.updateDateView()}),a},render:function(){var a=e.superclass.render.apply(this,arguments);return this._renderSelf(),this._initFocusDate(),a},setStamp:function(a,b){var d=this._stampStore[a]||[];_.isUndefined(b)||(b=[].concat(b),b=_.map(b,function(a){return c(a)}),_.each(b,function(a){_.some(d,function(b){return b==a.format("YYYY-MM-DD")})||d.push(a.format("YYYY-MM-DD"))}),this._stampStore[a]=d)},getStamp:function(a){return _.isUndefined(a)?this._stampStore:this._stampStore[a]},removeStamp:function(a,b){var d=this;return _.isUndefined(a)?(this._stampStore={},void 0):_.isUndefined(b)?(this._stampStore[a]=[],void 0):(b=[].concat(b),b=_.map(b,function(a){return c(a)}),_.each(b,function(b){d._stampStore[a]=_.reject(d._stampStore[a],function(a){return b.format("YYYY-MM-DD")==a})}),void 0)},updateDateView:function(){var a=this.get("panelState"),b=this.element,c=$(".card-calendar-date-panel",b),d=$(".date-body td",c),e=this._stampStore,f=_.keys(e);"date"==a&&_.each(f,function(a){d.removeClass("stamp-"+a),_.each(e[a],function(b){d.filter('[data-date="'+b+'"]').addClass("stamp-"+a)})})},_initFocusDate:function(){var a=this.get("initFocusDate");this._renderDatePanel(a),this.set("currentDate",this.get("initFocusDate")),this.set("panelState","date")},_clickNavPrev:function(){var a=this.get("currentDate");a=a.subtract("months",1),this._renderDatePanel(a),this.set("currentDate",a),this.set("panelState","date")},_clickNavNext:function(){var a=this.get("currentDate");a=a.add("months",1),this._renderDatePanel(a),this.set("currentDate",a),this.set("panelState","date")},_clickLabelYear:function(){var a=this.get("currentDate"),b=this.get("panelState");"year"==b?(this._renderDatePanel(a),this.set("panelState","date")):(this._renderYearPanel(a.format("YYYY")),this.set("panelState","year"))},_clickLabelMonth:function(){var a=this.get("currentDate"),b=this.get("panelState");"month"==b?(this._renderDatePanel(a),this.set("panelState","date")):(this._renderMonthPanel(),this.set("panelState","month"))},_clickYearNavPrev:function(){var a=this.element,b=$(".card-calendar-year-panel",a),c=$("li.year-item",b).eq(0).data("year");this._renderYearPanel(c)},_clickYearNavNext:function(){var a=this.element,b=$(".card-calendar-year-panel",a),c=$("li.year-item",b).last().data("year");this._renderYearPanel(c)},_clickYearItem:function(a){var b=$(a.currentTarget),d=b.data("year");this.set("currentDate",c(d+"-"+this.get("currentDate").format("MM-DD"),"YYYY-MM-DD")),b.addClass("is-current-year").siblings(".year-item").removeClass("is-current-year")},_clickMonthItem:function(a){var b=$(a.currentTarget),d=this.get("currentDate"),e=b.data("month");this.set("currentDate",c(d.format("YYYY")+"-"+e+"-"+d.format("DD"),"YYYY-M-DD")),b.addClass("is-current-month").siblings(".month-item").removeClass("is-current-month")},_clickDateCell:function(a){var b=$(a.currentTarget),c=b.closest("td"),d=c.data("date");this.trigger("dateclick",d)},_renderSelf:function(){var a=this.element;a.addClass("card-calendar"),a.html('<div class="card-calendar-tbar"><div class="card-calendar-nav-prev">&#139;</div><div class="card-calendar-title"><span class="label-year">0000</span>年<span class="label-month">00</span>月</div><div class="card-calendar-nav-next">&#155;</div></div><div class="card-calendar-body"><div class="card-calendar-date-panel card-calendar-panel"></div><div class="card-calendar-year-panel card-calendar-panel"></div><div class="card-calendar-month-panel card-calendar-panel"></div></div>')},_renderDatePanel:function(a){var b,c,d=this.element,e=$(".card-calendar-date-panel",d),f=this.get("initFocusDate"),g=a.clone().startOf("month"),h=g.startOf("week"),i='<table cellpadding="0" cellspacing="0">',j=0;for(i+='<thead class="day-title"><tr><th><span class="date-cell">日</span></th><th><span class="date-cell">一</span></th><th><span class="date-cell">二</span></th><th><span class="date-cell">三</span></th><th><span class="date-cell">四</span></th><th><span class="date-cell">五</span></th><th><span class="date-cell">六</span></th></tr></thead>',i+='<tbody class="date-body">';42>j;)b=h.clone(),b.add("d",j),c=parseInt(b.format("M"))<parseInt(a.format("M"))?"prev-month-date state-inactive":parseInt(b.format("M"))>parseInt(a.format("M"))?"next-month-date state-inactive":"current-month-date state-active",b.isSame(f)&&(c+=" is-init-focus-date"),0==j%7&&(i+=0==j?"<tr>":"</tr><tr>"),i+='<td data-date="'+b.format("YYYY-MM-DD")+'" class="'+c+'"><span class="date-cell">'+b.format("D")+"</span></td>",j++;i+="</tr></tbody>",i+="</table>",e.html(i),this.updateDateView()},_renderYearPanel:function(a){var b,c=this.element,d=$(".card-calendar-year-panel",c),e=this.get("currentDate"),f="";for(a=parseInt(a),b=a-6;a-1>=b;b++)f+='<li data-year="'+b+'" class="year-item">'+b+"</li>";for(f+='<li data-year="'+a+'" class="year-item">'+a+"</li>",b=a+1;a+6>=b;b++)f+='<li data-year="'+b+'" class="year-item">'+b+"</li>";f='<ul class="fn-clear"><li class="year-nav-prev">&#8230;</li>'+f+'<li class="year-nav-next">&#8230;</li></ul>',d.html(f),$('[data-year="'+e.format("YYYY")+'"]',d).addClass("is-current-year")},_renderMonthPanel:function(){var a,b=this.element,c=$(".card-calendar-month-panel",b),d=this.get("currentDate"),e="",f=parseInt(d.format("M"));for(a=1;12>=a;a++)e+='<li class="month-item" data-month="'+a+'">'+(new Array(2-a.toString().length+1).join("0")+a)+"</li>";e='<ul class="fn-clear">'+e+"</ul>",c.html(e),$('[data-month="'+f+'"]',c).addClass("is-current-month")},_onChangeCurrentDate:function(a){var b=this.element,d=$(".card-calendar-tbar",b),e=$(".label-year",d),f=$(".label-month",d);a&&(a=c(a,"YYYY-MM-DD"),e.text(a.format("YYYY")),f.text(a.format("MM")))},_onChangePanelState:function(a){var b=this.element;$(".card-calendar-panel",b).hide(),$(".card-calendar-"+a+"-panel",b).show()},destroy:function(){var a;return this._stampStore=null,a=e.superclass.destroy.apply(this,arguments)}}),f=a("modules/card-reply/feed-reply.js");b.init=function(){var a=b.tplEl;b.tplName;var c=$(".calendar",a);new e({element:c}).render();var d=$(".feed-reply",a),g=new f({element:d,showMainInput:!1,title:""});g.show(),g.refreshList(),g.on("replycount",function(a){alert(a)})}});