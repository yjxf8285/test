/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/marketings/showmarketing/showsalesclue",["util","modules/feed-list/feed-list","dialog","moment","uilibs/tabs2","./showcompetitor-dialog.html","modules/publish/publish-helper","modules/crm-attachment-simple/crm-attachment-simple","modules/crm-attachment/crm-attachment","modules/crm-select-colleague/crm-select-colleague"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.event;var f=a("util"),g=a("modules/feed-list/feed-list"),h=a("dialog"),i=a("moment"),j=a("uilibs/tabs2"),k=a("./showcompetitor-dialog.html"),l=a("modules/publish/publish-helper"),m=a("modules/crm-attachment-simple/crm-attachment-simple"),n=a("modules/crm-attachment/crm-attachment"),o=a("modules/crm-select-colleague/crm-select-colleague"),p=function(a){a=$.extend({element:null},a||{}),this.options=a,this.$el=a.element,this.init()};$.extend(p.prototype,{init:function(){this.$el,this._getTagsDatas(),this.setupComponent(),this.bindEvents(),this.modifyCompetitorDialog=new q,this.modifyCompetitorDialog.v=this},bindEvents:function(){var a=this.$el,b=this,c=this.options.queryParams.id;a.on("click",".showproduct-back-btn",function(){b._backToListPage()}),a.on("click",".delete-product-btn",function(){b._deleteProduct()}),a.on("click",".modify-product-btn",function(){b.modifyCompetitorDialog.show()}),a.on("click",".canchangeowner-product-btn",function(){b.selectColleagueS.show()}),this.selectColleagueS.on("selected",function(a){f.api({url:"/Competitor/UpdateCompetitorOwnerID",type:"post",dataType:"json",data:{competitorID:c,ownerID:a.employeeID},success:function(a){a.success&&(f.remind(1,"变更成功"),b.load())}})})},_getTagsDatas:function(){var a=f.getCrmData(),b=a.functionPermissions,c=f.getTagsByType(6),d=[],e=this,g=[{text:"不限",value:0}],h=[{text:"不限",value:0}];_.each(c,function(a){d.push(a),106===a.systemTagCode&&(_.each(a.options,function(a){g.push({text:a.name,value:a.fBusinessTagOptionID})}),e.competitorscaleFBusinessTagID=a.fBusinessTagID),111===a.systemTagCode&&(_.each(a.options,function(a){h.push({text:a.name,value:a.fBusinessTagOptionID})}),e.competitivenessFBusinessTagID=a.fBusinessTagID)}),_.extend(this,{allCompetitorTags:d,competitorscale:g,competitiveness:h,functionPermissions:b})},setCrmAttachment:function(){var a=this,b=$(".crm-attachment-simple-warp",this.$el),c=this.responseData.value.feedAttachEntitys;this.attachment=new m({element:b,items:c}),this.attachment.render(),this.attachment.on("toAll",function(){a.tab.select("tab-files")})},setAttachmentList:function(){var a=this,b=$(".crm-attachmentlist-simple-warp",this.$el),c=this.options.queryParams.id;this.attachmentList=new n({element:b,condition:{fbrType:5,dataID:c}}),this.attachmentList.on("uploaded",function(){a.attachment.reload()})},setFeedList:function(){var a=$(".crm-feed-list-warp",this.$el),b=$(".feed-list-pagination",this.$el),c=$("",this.$el),d=this.options.queryParams.id;this.feedList=new g({element:a,pagSelector:b,pagOpts:{pageSize:16,visiblePageNums:3},listPath:"/CrmFeed/GetFeeds",defaultRequestData:function(){return{fbrType:4,dataID:d,type:1,keyword:_.str.trim(c.val())}},listEmptyText:"暂无记录"}),this.feedList.load()},showFnBtn:function(){var a=this.$el,b=this.responseData.value,c=b.canModify,d=b.canDelete,e=b.canChangeOwner;c?$(".modify-product-btn",a).show():$(".modify-product-btn",a).hide(),d?$(".delete-product-btn",a).show():$(".delete-product-btn",a).hide(),e?$(".canchangeowner-product-btn",a).show():$(".canchangeowner-product-btn",a).hide()},render:function(){var a=this.$el,b=this.responseData.value.competitor,c=b.name,d=b.description,e=b.creator.name,f=b.owner.name,g=b.advantage,h=b.disadvantage,j=b.strategies,k=b.salesSituation,l=b.marketingSituation,m=b.contactInfo,n=i.unix(b.createTime).format("YYYY年MMMDD日 HH:mm"),o=b.lastEditEmployee.name,p=i.unix(b.lastEditTime).format("YYYY年MMMDD日 HH:mm"),q=b.fBusinessTagRelations,r="";_.each(q,function(a){var b=a.fBusinessTagName,c=a.fBusinessTagOptionName;r+='<li><span class="tit">'+b+'</span><span class="value">'+c+"</span></li>"}),$(".showproduct-hd-titname",a).text(c),$(".product-name",a).text(c),$(".owner-name",a).text(f),$(".baseinfo-advantage",a).text(g),$(".baseinfo-disadvantage",a).text(h),$(".baseinfo-strategies",a).text(j),$(".baseinfo-salessituation",a).text(k),$(".baseinfo-marketingsituation",a).text(l),$(".baseinfo-contactinfo",a).text(m),$(".baseinfo-description",a).text(d),$(".product-creatorname",a).text(e),$(".product-createtime",a).text(n),$(".product-lasteditemployeename",a).text(o),$(".product-lastedittime",a).text(p),$(".product-fbusinesstagrelations",a).html(r),this.showFnBtn(),this.setFeedList(),this.setCrmAttachment(),this.setAttachmentList()},load:function(){this.$el;var a=this.options.queryParams.id,b=this;f.api({url:"/Competitor/GetCompetitorDetailByID",type:"get",dataType:"json",data:{competitorID:a,attachNum:6},success:function(a){a.success&&(b.responseData=a,b.render())}})},_backToListPage:function(){var a=decodeURIComponent(this.options.queryParams.returnUrl);e.navRouter.navigate(a,{trigger:!0})},_deleteProduct:function(){var a=this,b=this.responseData.value.competitor.competitorID;f.confirm("你确定要删除该竞争对手吗？删除后将不可恢复。","",function(){f.api({url:"/Competitor/DeleteCompetitors",type:"post",dataType:"json",data:{competitorIDs:b},success:function(b){if(b.success){var c=b.value.result,d=c[0],e=d.value1,g=d.value2;e?a._backToListPage():f.alert("删除失败，原因："+g)}}})})},setupComponent:function(){var a=$(".top-menu-tab",this.$el);this.tab=new j({element:a,container:this.$el,items:[{value:"tab-time-line",text:"时间线"},{value:"tab-base-info",text:"基本信息"},{value:"tab-files",text:"附件"}]}),f.autoAdjustPos($(".flaot-left-menu",this.$el)),this.selectColleagueS=new o({isMultiSelect:!1,title:"请选择负责人"})},destroy:function(){}});var q=h.extend({attrs:{width:760,content:$(k).filter(".dialog-createnewcompetitortags-template").html(),className:"dialog-createnewcompetitortags"},events:{"click .button-submit":"submit","click .button-cancel":"hide"},render:function(){var a=q.superclass.render.apply(this,arguments);return this.setupDoms(),this.setupComponent(),a},hide:function(){var a=q.superclass.hide.apply(this,arguments);return this.clear(),a},show:function(){var a=q.superclass.show.apply(this,arguments);return this.showDefautData(),a},showDefautData:function(){var a=this.element,b=this.v.responseData.value.competitor,c=b.name,d=b.description;b.creator.name,b.owner.name;var e=b.advantage,f=b.disadvantage,g=b.strategies,h=b.salesSituation,i=b.marketingSituation,j=b.contactInfo;$(".competitor-name",a).val(c),$(".competitor-advantage",a).val(e),$(".competitor-disadvantage",a).val(f),$(".competitor-strategies",a).val(g),$(".competitor-salesSituation",a).val(h),$(".competitor-marketingSituation",a).val(i),$(".competitor-contactInfo",a).val(j),$(".competitor-description",a).val(d)},clear:function(){$(".area-auto-height",this.element).val(""),$(".mn-select-box",this.element).each(function(){f.mnReset($(this))})},submit:function(a){var b=this,c=$(a.currentTarget),d=this.element,e=this.v.responseData.value.competitor.competitorID,g=$(".competitor-name",d).val(),h=$(".competitor-advantage",d).val(),i=$(".competitor-disadvantage",d).val(),j=$(".competitor-strategies",d).val(),k=$(".competitor-salesSituation",d).val(),l=$(".competitor-marketingSituation",d).val(),m=$(".competitor-contactInfo",d).val(),n=$(".competitor-description",d).val(),o=$(".product-tags-list-warp > li",d),p=[];o.each(function(){var a=$(".selects-tit",$(this)).data("fbusinesstagid"),b=$(".mn-select-box",$(this)),c=f.mnGetter(b)||0;p.push(a+","+c)}),f.api({url:"/Competitor/UpdateCompetitor",type:"post",dataType:"json",data:{competitorID:e,name:g,advantage:h,disadvantage:i,strategies:j,salesSituation:k,marketingSituation:l,contactInfo:m,description:n,listTagOptionID:p},success:function(a){a.success&&(b.hide(),b.v.load())}},{submitSelector:c})},setupDoms:function(){var a=this.element;this.conTextareaEl=$(".area-auto-height",a)},setupComponent:function(){var a=this.element,b=$(".product-tags-list-warp",a),c=this.v.allCompetitorTags;l.AdjustTextAreaSize({element:this.conTextareaEl}),_.each(c,function(a){var c=a.name,d=a.options,e="",f="";d.length>0?_.each(d,function(a){var b=a.isDefault;b&&(f=a.name),e+='<ul class="mn-select-list"><li class="mn-select-item" data-value="'+a.fBusinessTagOptionID+'" data-selected="'+b+'">'+a.name+"</li></ul>"}):e='<ul class="mn-select-list"><li class="mn-select-item" data-value="0"></li></ul>',b.append('<li class="fn-clear"> <div class="selects-tit" data-fbusinesstagid="'+a.fBusinessTagID+'"> '+c+' </div> <div class="selects-warp"> <span select-cls="product-tags-list-selects" class="mn-select-box "><span class="mn-select-title-wrapper select-for-dialog"><span class="mn-select-title ">'+f+'</span><span class="title-icon"></span></span>'+e+"</span> </div> </li>")})}});b.init=function(){var a=b.tplEl;b.tplName;var c=f.getTplQueryParams(),d=new p({element:a,queryParams:c});d.load()}});