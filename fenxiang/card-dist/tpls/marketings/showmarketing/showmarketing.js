/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/marketings/showmarketing/showmarketing",["util","modules/feed-list/feed-list","dialog","moment","uilibs/tabs2","modules/publish/publish-helper","modules/crm-attachment-simple/crm-attachment-simple","modules/crm-attachment/crm-attachment","modules/crm-select-colleague/crm-select-colleague","modules/crm-salesclue-edit/crm-salesclue-edit","modules/crm-marketing-edit/crm-marketing-edit","modules/crm-publish/crm-publish","modules/crm-follow-up/crm-follow-up"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.event;var f=a("util"),g=a("modules/feed-list/feed-list");a("dialog");var h=a("moment"),i=a("uilibs/tabs2");a("modules/publish/publish-helper");var j,k=a("modules/crm-attachment-simple/crm-attachment-simple"),l=a("modules/crm-attachment/crm-attachment"),m=a("modules/crm-select-colleague/crm-select-colleague"),n=a("modules/crm-salesclue-edit/crm-salesclue-edit"),o=a("modules/crm-marketing-edit/crm-marketing-edit"),p=a("modules/crm-publish/crm-publish"),q=a("modules/crm-follow-up/crm-follow-up"),r=function(a){a=$.extend({element:null},a||{}),this.options=a,this.$el=a.element,this.init()};$.extend(r.prototype,{init:function(){this.$el;var a=this;this._getTagsDatas(),this.setupComponent(),this.setFeedList(),this.setAttachmentList(),this.bindEvents(),this.createSalesclueDailog=new n({marketingEventID:this.options.queryParams&&this.options.queryParams.id}),this.createSalesclueDailog.v=this,this.modifyCompetitorDialog=new o({marketingEventID:this.options.queryParams&&this.options.queryParams.id}),this.modifyCompetitorDialog.v=this,this.modifyCompetitorDialog.on("success",function(){a.refresh()});var a=this,c=b.tplName;e.event.one("beforeremove",function(b){b==c&&a.destroy()})},bindEvents:function(){var a=this.$el,b=this,c=this.options.queryParams.id,d=function(d,g){f.confirm("是否确定要将当前活动的【状态】变更为【"+g+"】吗？","",function(){j=f.mnGetter($(".updatestates-select-list",a)),f.api({url:"/MarketingEvent/UpdateMarketingEventsStates",type:"post",dataType:"json",data:{marketingEventIDs:c,states:d},success:function(a){a.success&&b.load()}})},{onCancel:function(){e()}})},e=function(){f.mnOffEvent($(".updatestates-select-list",a),"change",d),f.mnSetter($(".updatestates-select-list",a),j),f.mnEvent($(".updatestates-select-list",a),"change",d)};f.mnEvent($(".updatestates-select-list",a),"change",d),a.on("click",".crm-button-back",function(){b._backToListPage()}),a.on("click",".delete-btn",function(){b._delete()}),a.on("click",".modify-btn",function(){b.modifyCompetitorDialog.show()}),a.on("click",".canchangeowner-btn",function(){b.selectColleagueS.show()}),a.on("click",".create-salesclue-btn",function(){b.createSalesclueDailog.show()}),a.on("click",".follow-switch-btn",function(a){b._switchFollow(a)}),this.selectColleagueS.on("selected",function(d){var e=b.responseData.value.marketingEvent.owner.employeeID;f.confirm("你确定要将市场活动的负责人变更为"+d.name+"吗？","",function(){f.api({url:"/MarketingEvent/UpdateMarketingEventsOwnerID",type:"post",dataType:"json",data:{marketingEventIDs:c,ownerID:d.employeeID},success:function(c){if(c.success){var g=c.value.result,h="";_.each(g,function(c){var g=c.value1,i=c.value2;g?(f.remind(1,"变更成功"),$(".owner-name",a).text(d.name),b.followUpBox.replace(e,d)):(h="变更市场活动的负责人失败，原因："+i+"</br>",f.alert(h))})}}})})})},_switchFollow:function(a){var b=$(a.target),c=this.options.queryParams.id;b.hasClass("following")?f.api({url:"/MarketingEvent/MarketingEventCancelFollow",type:"post",dataType:"json",data:{marketingEventID:c},success:function(a){a.success&&b.removeClass("following").addClass("no-follow").text("关注")}}):f.api({url:"/MarketingEvent/MarketingEventFollow",type:"post",dataType:"json",data:{marketingEventID:c},success:function(a){a.success&&b.removeClass("no-follow").addClass("following").text("已关注")}})},_getTagsDatas:function(){var a=f.getCrmData(),b=a.functionPermissions,c=f.getTagsByType(9),d=[],e=this,g=[{text:"不限",value:0}],h=[{text:"不限",value:0}];_.each(c,function(a){d.push(a),109===a.systemTagCode&&(_.each(a.options,function(a){h.push({text:a.name,value:a.fBusinessTagOptionID})}),e.marketingEventTypeFBusinessTagID=a.fBusinessTagID)}),_.extend(this,{allTags:d,competitorscale:g,competitiveness:h,functionPermissions:b})},setCrmAttachment:function(){var a=this,b=this.options.queryParams.id,c=$(".crm-attachment-simple-warp",this.$el);this.attachment=new k({element:c,condition:{dataID:b,fbrType:7}}),this.attachment.render(),this.attachment.on("toAll",function(){a.tab.select("tab-files")}),this.attachment.on("uploaded",function(){a.attachmentList.reload()})},setAttachmentList:function(){var a=this,b=$(".crm-attachmentlist-simple-warp",this.$el),c=this.options.queryParams.id;this.attachmentList=new l({element:b,condition:{fbrType:7,dataID:c}}),this.attachmentList.on("uploaded",function(){a.attachment.reload()})},setFeedList:function(){var a=$(".crm-feed-list-warp",this.$el),b=$(".feed-list-pagination",this.$el),c=$("",this.$el),d=this.options.queryParams.id;this.feedList=new g({element:a,pagSelector:b,pagOpts:{pageSize:15,visiblePageNums:3},GetBatchFilesSource:1,crmParam:{type:"marketing",id:d},listPath:"/CrmFeed/GetFeeds",defaultRequestData:function(){return{fbrType:7,dataID:d,type:1,keyword:_.str.trim(c.val())}},listEmptyText:"暂无记录"}),this.feedList.load()},showFnBtn:function(){var a=this.$el,b=this.responseData.value,c=b.canModify,d=b.canDelete,e=b.canChangeOwner;c?$(".modify-product-btn",a).show():$(".modify-product-btn",a).hide(),d?$(".delete-product-btn",a).show():$(".delete-product-btn",a).hide(),e?$(".canchangeowner-product-btn",a).show():$(".canchangeowner-product-btn",a).hide()},render:function(){var a,b=this.$el,c=this.responseData.value.marketingEvent||null,d="",e=$(".follow-switch-btn",b);if(c){switch(a=c.fBusinessTagRelations,d="",_.each(a,function(a){var b=a.fBusinessTagName,c=a.fBusinessTagOptionName;d+='<li class="fn-clear"><span class="input-tip">'+b+'</span><div class="input-wrapper">'+c+"</div></li>"}),$(".product-fbusinesstagrelations",b).html(d),c.isFollow?e.addClass("following").text("已关注"):e.addClass("no-follow").text("关注"),$(".hd-titname",b).text(c.name),$(".jdata-ownername",b).text(c.owner.name),$(".jdata-createtime",b).text(h.unix(c.createTime).format("YYYY年MMMDD日 HH:mm")),$(".jdata-lasteditemployeename",b).text(c.lastEditEmployee.name),$(".jdata-lastedittime",b).text(h.unix(c.lastEditTime).format("YYYY年MMMDD日 HH:mm")),$(".jdata-name",b).text(c.name),$(".jdata-company",b).text(c.company),j=c.states,c.states){case 1:c.states="已计划";break;case 2:c.states="进行中";break;case 3:c.states="已结束";break;case 4:c.states="终止"}$(".updatestates-select-list .mn-select-title",b).text(c.states),$(".jdata-states",b).text(c.states),f.mnSetter($(".mn-radio-box",b),c.gender),$(".jdata-expectedincome",b).text("￥"+_.str.numberFormat(parseFloat(c.expectedIncome),2)),$(".jdata-actualincome",b).text("￥"+_.str.numberFormat(parseFloat(c.actualIncome),2)),$(".jdata-begindate",b).text(h.unix(c.beginDate).format("YYYY-MM-DD")),$(".jdata-enddate",b).text(h.unix(c.endDate).format("YYYY-MM-DD")),$(".jdata-location",b).text(c.location),$(".jdata-expectedcost",b).text(_.str.numberFormat(parseFloat(c.expectedCost),2)),$(".jdata-actualcost",b).text(_.str.numberFormat(parseFloat(c.actualCost),2)),$(".jdata-expectedincome",b).text(_.str.numberFormat(parseFloat(c.expectedIncome),2)),$(".jdata-actualincome",b).text(_.str.numberFormat(parseFloat(c.actualIncome),2)),$(".jdata-l",b).text(c.marketingPlan),$(".jdata-executiondescription",b).text(c.executionDescription),$(".jdata-summary",b).text(c.summary),$(".jdata-effect",b).text(c.effect),$(".jdata-description",b).text(c.description)}this.showFnBtn()},load:function(){var a=this.$el,b=this.options.queryParams.id,c=this;f.api({url:"/MarketingEvent/GetMarketingEventDetailByID",type:"get",dataType:"json",data:{marketingEventID:b,attachNum:6},success:function(d){if(d.success){c.responseData=d,c.render();var e=[],g=d.value.marketingEvent.marketingParticipants;_.each(g,function(a){e.push(a.employee)}),c.followUpBox||(c.followUpBox=new q({element:$(".crm_follow_up",a),addApi:"/MarketingEvent/AddMarketingParticipants",deleteApi:"/MarketingEvent/DeleteMarketingParticipants",parameter:{marketingEventID:b,employeeIDs:""},selectColleagueS:c.selectColleagueS,items:e,ownerID:d.value.marketingEvent.ownerID,btnAddTitle:"联合参与人",addWinTitle:"选择联合参与人",title:"联合参与人",typeName:"市场",name:"联合参与人"}))}else f.alert(d.message,function(){c._backToListPage()},{zIndex:3e3})}},{errorAlertModel:"1"})},refresh:function(){this.load()},_backToListPage:function(){var a=f.getTplQueryParams2();e.navRouter.navigate(a.returnUrl,{trigger:!0}),e.event.trigger("dataUpdate")},_delete:function(){var a=this,b=this.options.queryParams.id;f.confirm("你确定要删除该市场活动吗？删除后将不可恢复。","",function(){f.api({url:"/MarketingEvent/DeleteCompetitors",type:"post",dataType:"json",data:{marketingEventIDs:b},success:function(b){if(b.success){var c=b.value.result,d=c[0],e=d.value1,g=d.value2;e?a._backToListPage():f.alert("删除失败，原因："+g)}}})})},setPublish:function(){var a=this,b=this.$el,c=this.options.queryParams.id;this.feedpublish=new p({element:$(".feed-submit-box-warp",b),title:"新建市场活动记录",placeholder:"发布新市场活动记录",type:"feed",condition:{fileInfos:[],feedContent:"",fbrType:7,dataID:c},display:["picture","attach","at","topic"]}),this.feedpublish.on("post",function(){a.feedList.load()})},setupComponent:function(){var a=$(".tab-menu",this.$el);this.tab||(this.tab=new i({element:a,container:this.$el,items:[{value:"tab-time-line",text:"时间线"},{value:"tab-base-info",text:"基本信息"},{value:"tab-files",text:"附件"}]})),this.setCrmAttachment(),this.selectColleagueS||(this.selectColleagueS=new m({isMultiSelect:!1,title:"请选择负责人"})),this.setPublish()},destroy:function(){this.feedpublish&&this.feedpublish.destroy()}}),b.init=function(){var a=b.tplEl;b.tplName;var c=f.getTplQueryParams2(),d=new r({element:a,queryParams:c});d.load()}});