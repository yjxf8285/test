/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/entinfomgt/entinfomgt",["util","json","modules/fs-qx/fs-qx-helper"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=(e.store,e.event),g=a("util"),h=a("json"),i=a("modules/fs-qx/fs-qx-helper"),j=i.JoinDialog,k=i.Uploader;b.init=function(){var a=b.tplEl,c=b.tplName,e=$(".flag-left-list",a),i=$(".ent-setup-wrap",a),l=$(".login-setup-wrap",a),m=$(".custom-manage-wrap",a),n=$(".modify-full-company-limit-wrap",a);e.find("li").click(function(){e.find("a").removeClass("fl-item-on");var a=$(this),b=a.index();$("a",a).addClass("fl-item-on"),0==b?(i.show(),l.hide(),m.hide(),n.hide()):1==b?(i.hide(),m.hide(),l.show(),n.hide()):2==b?(i.hide(),l.hide(),m.show(),n.hide()):3==b&&(i.hide(),l.hide(),m.hide(),n.show())});var o=$(".lsu-inp-text",a),p=$(".lsu-view-color",a),q=$(".lsu-sel-wrap",a),r=$(".lsu-sel-view",a),s=$(".lsu-view-cvalue",q),t=$(".lsu-sel-list",q);t.find("li").click(function(){var a=$(this);t.find("li").removeClass("lslon"),a.addClass("lslon");var b=a.attr("color");s.css("background-color",b),p.css("background-color",b),o.val(b.slice(1,7)),t.hide()}),r.click(function(a){r.addClass("lsuvcon"),t.is(":visible")?t.hide():t.show(),a.stopPropagation()}),$(document).click(function(){t.hide(),r.removeClass("lsuvcon")}),o.keyup(function(){var a=$(this),b=a.val();6==a.val().length&&p.css("background-color","#"+b)});var u=$(".sms-enterprise-name",i),v=$(".sms-enterprise-btn",i),w=$(".all-company-inp",i),x=$(".all-company-btn",i),y=$(".enterprise-bgcolor-btn",a),z=$(".enterprise-bgc-default-btn",a);g.api({type:"get",data:{},url:"/Management/GetEnterpriseInfo",success:function(a){if(a.success){var b=a.value,c=b.enterpriseName,d=b.allCompanyDefaultString,e=b.enterpriseBackgroundColor;u.val(c),w.val(d),o.val(e),p.css("background-color","#"+e);var f=t.find("li");f.each(function(){var a=$(this);a.attr("color").slice(1)==e&&(a.addClass("lslon"),s.css("background-color","#"+e))})}}}),v.click(function(){var a=_.str.trim(u.val());0==a.length?g.showInputError(u):g.api({type:"post",data:{enterpriseName:a},url:"/Management/SetEnterpriseName",success:function(b){b.success&&($(".hd .enterprise-name").text(a),g.alert("保存成功。"))}})}),x.click(function(){var a=_.str.trim(w.val());0==a.length?g.showInputError(w):g.api({type:"post",data:{allCompanyDefaultString:a},url:"/Management/SetAllCompanyDefaultString",success:function(b){b.success&&(g.setTplStore("entinfomgt",{enterpriseName:a}),g.alert("保存成功。"))}})}),y.click(function(){var a=_.str.trim(o.val());a.length<6?g.showInputError(o):g.api({type:"post",data:{backgroundColor:a},url:"/Management/SetEnterpriseBackgroundColor",success:function(a){a.success&&g.alert("保存成功。")}})}),z.click(function(){var a="a6ce39";g.api({type:"post",data:{backgroundColor:a},url:"/Management/SetEnterpriseBackgroundColor",success:function(b){b.success&&(o.val(a),p.css("background-color","#"+a),s.css("background-color","#"+a),t.find("li").removeClass("lslon"),t.find("li").eq(0).addClass("lslon"))}})});var A=$(".up-logo-file",a),B=$(".up-logo-default-btn",a),C=$(".up-mainimg-file",a),D=$(".up-mainimg-default-btn",a),E=$(".hd .logo-img"),F=$(".logo-img",a),G=$(".login-img",a),H=d.getAppStore("globalData"),I=d.API_PATH+"/Authorize/GetLogoImg?type=1&ent="+H.enterprise,J=d.API_PATH+"/Authorize/GetLogoImg?type=2&ent="+H.enterprise;new k({element:A,h5UploadPath:"/Management/uploadFile",flashUploadPath:"/Management/UploadFileByForm",h5Opts:{multiple:!1,accept:"image/*",filter:function(a){var b=[];return _.each(a,function(a){"jpg"==g.getFileType(a)?b.push(a):g.alert("请选择图片格式的文件")}),b}},flashOpts:{file_types:"*.jpg;*.gif;*.jpeg;*.png",file_types_description:"图片格式",button_width:80,button_height:25},onSelect:function(){this.startUpload()},onSuccess:function(a,b){var c,d=h.parse(b);d.success&&(c=d.value.filePath,g.api({type:"post",data:{logoPath:c},url:"/Management/UploadLogo",success:function(a){var b=new Date/1;a.success&&(E.attr("src",I+"&r="+b),F.attr("src",I+"&r="+b))}}))},onComplete:function(){this.removeAllFile()}}),new k({element:C,h5UploadPath:"/Management/uploadFile",flashUploadPath:"/Management/UploadFileByForm",h5Opts:{multiple:!1,accept:"image/*",filter:function(a){var b=[];return _.each(a,function(a){"jpg"==g.getFileType(a)?b.push(a):g.alert("请选择图片格式的文件")}),b}},flashOpts:{file_types:"*.jpg;*.gif;*.jpeg;*.png",file_types_description:"图片格式",button_width:80,button_height:25},onSelect:function(){this.startUpload()},onSuccess:function(a,b){var c,d=h.parse(b);d.success&&(c=d.value.filePath,g.api({type:"post",data:{picPath:c},url:"/Management/UploadMainPic",success:function(a){var b=new Date/1;a.success&&G.attr("src",J+"&r="+b)}}))},onComplete:function(){this.removeAllFile()}}),B.click(function(){g.api({type:"post",url:"/Management/ClearLogo",success:function(a){var b=new Date/1;a.success&&(E.attr("src",I+"&r="+b),F.attr("src",I+"&r="+b))}})}),D.click(function(){g.api({type:"post",url:"/Management/ClearMainPic",success:function(a){var b=new Date/1;a.success&&G.attr("src",J+"&r="+b)}})}),F.attr("src",I+"&r="+new Date/1),G.attr("src",J+"&r="+new Date/1),m.on("click",".f-sub",function(){var a=$(".control-modify-parent",m).prop("checked");g.api({type:"post",data:{isAllow:!a},url:"/Management/SetIsAllowSetOwnLeader",success:function(b){b.success&&(H.isAllowSetOwnLeader=!a,g.alert("保存成功"))}})}),m.on("click",".f-sub-exportdata",function(){var a=$(".control-modify-exportdata",m).prop("checked");g.api({type:"post",data:{isAllow:!a},url:"/Management/SetIsAllowExportData",success:function(b){b.success&&(H.isAllowExportData=!a,g.alert("保存成功"))}})}),m.on("click",".f-sub-isforbidden",function(){var a=$(".control-modify-isforbidden",m).prop("checked");g.api({type:"post",data:{isForbidden:a},url:"/Management/SetIsForbiddenCreateFCustomer",success:function(b){b.success&&(H.isForbiddenCreateFCustomer=!a,g.alert("保存成功"))}})}),f.on("switched",function(a){a==c&&($(".control-modify-parent",m).prop("checked",!H.isAllowSetOwnLeader),$(".control-modify-exportdata",m).prop("checked",!H.isAllowExportData),$(".control-modify-isforbidden",m).prop("checked",H.isForbiddenCreateFCustomer))}),H.isLoginPagePersonalization&&$(".login-setting-item",a).show();var K=function(a){a=$.extend({element:null},a||{}),this.opts=a,this.element=a.element,this.init()};$.extend(K.prototype,{init:function(){this.element,this.opts,this.render(),this.bindEvents()},render:function(){this.setDom(),this._getAllShortEmployees()},load:function(){var a=this;g.api({url:"/Management/GetFullCompanyLimitWithEmployee",type:"get",dataType:"json",success:function(b){var c=b.value.employees;b.success&&(a.modifyEmployeeBd.html(a._formatListHtml(c)),a.employeesCountEl.html(c.length))}}),g.api({url:"/Management/GetFullCompanyLimitWithCircle",type:"get",dataType:"json",success:function(b){var c=b.value.circles;b.success&&(a.modifyCircleBd.html(a._formatListHtml(c)),a.circlesCountEl.html(c.length))}})},setDom:function(){var a=this.element;this.modifyEmployeeBd=a.find(".modify-employee-bd"),this.modifyCircleBd=a.find(".modify-circle-bd"),this.employeesCountEl=a.find(".employees-count"),this.circlesCountEl=a.find(".circles-count")},bindEvents:function(){var a=this.element,b=this;a.on("click",".modify-employee-submit-btn",function(){b.employeesDialog?b.employeesDialog.show():b._renderEmployeesDialog(),b.employeesDialog.setTitle("选择员工"),g.api({url:"/Management/GetFullCompanyLimitWithEmployee",type:"get",dataType:"json",success:function(a){var c=a.value.employees;a.success&&(_.each(c,function(a){a.id=a.employeeID}),b._setEmployeeInitData(c))}})}),a.on("click",".modify-circle-submit-btn",function(){b.circlesDialog?b.circlesDialog.show():b._renderCirclesDialog(),b.circlesDialog.setTitle("选择部门"),g.api({url:"/Management/GetFullCompanyLimitWithCircle",type:"get",dataType:"json",success:function(a){var c=a.value.circles;a.success&&b._setCircleInitData(c)}})})},destroy:function(){this.element.remove()},_getAllShortEmployees:function(){var a=this;g.api({url:"/Management/GetAllShortEmployees",type:"get",dataType:"json",data:{},success:function(b){var c=b.value;b.success&&(_.each(c,function(a){a.id=a.employeeID}),a.allEmployeesData=c)}}),g.api({url:"/Management/GetAllCircleInfos",type:"get",dataType:"json",data:{},success:function(b){var c=b.value;b.success&&(a.allCirclesData=c)}})},_renderEmployeesDialog:function(){this.employeesDialog=new j({unjoinLabel:"未选员工",joinLabel:"已选员工",unit:"项",bbarUnit:"人",inputPlaceholder:"输入关键词，快速筛选员工",unjoinEmptyTip:"没有未选员工",unjoinSearchEmptyTip:"没有筛选条件为{{keyword}}的员工",joinEmptyTip:"没有已选员工",joinSearchEmptyTip:"没有筛选条件为{{keyword}}的员工"}).render().show()},_renderCirclesDialog:function(){this.circlesDialog=new j({unjoinLabel:"未选部门",joinLabel:"已选部门",unit:"项",bbarUnit:"项",inputPlaceholder:"输入关键词，快速筛选部门",unjoinEmptyTip:"没有未选部门",unjoinSearchEmptyTip:"没有筛选条件为{{keyword}}的部门",joinEmptyTip:"没有已选部门",joinSearchEmptyTip:"没有筛选条件为{{keyword}}的部门"}).render().show()},_setEmployeeInitData:function(a){var b=this.employeesDialog,c=this,d=[];_.each(a,function(a){d.push(a.employeeID)});var e=g.excludeDataByKey(d,"id",c.allEmployeesData);b.setInitData({joinData:a,unjoinData:e}),b.set("successCb",function(){var a=this.joinList.getDataState(),d=a.lost,e=a.add,f=[],h=[];_.each(e,function(a){h.push(a.employeeID)}),_.each(d,function(a){f.push(a.employeeID)}),g.api({url:"/Management/ModifyFullCompanyLimitWithEmployee",type:"post",dataType:"json",data:{addEmployeeIDs:h,deleteEmployeeIDs:f},success:function(a){a.success&&(b.hide(),c.load())}},{submitSelector:$(".f-sub",b.element)})})},_setCircleInitData:function(a){var b=this.circlesDialog,c=this,d=[];_.each(a,function(a){d.push(a.id)});var e=g.excludeDataByKey(d,"id",c.allCirclesData);b.setInitData({joinData:a,unjoinData:e}),b.set("successCb",function(){var a=this.joinList.getDataState(),d=a.lost,e=a.add,f=[],h=[];_.each(e,function(a){h.push(a.id)}),_.each(d,function(a){f.push(a.id)}),g.api({url:"/Management/ModifyFullCompanyLimitWithCircle",type:"post",dataType:"json",data:{addCircleIDs:h,deleteCircleIDs:f},success:function(a){a.success&&(b.hide(),c.load())}},{submitSelector:$(".f-sub",b.element)})})},_formatListHtml:function(a){var b="",c="";return _.each(a,function(a){b+="<li>"+a.name+"</li>"}),c='<ul class="modify-com-list fn-clear">'+b+"</ul>"}});var L=new K({element:n});L.load()}});