/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/plan/plan",["util","modules/feed-list/feed-list","./plan-common","moment","./plan-common.html","modules/publish/publish","dialog"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=(e.store,e.event),g=a("util"),h=a("modules/feed-list/feed-list"),i=a("./plan-common"),j=a("modules/publish/publish"),k=a("dialog"),l=j.atInput,m=k.extend({attrs:{width:"440px",className:"plan-bat-remark-dialog",list:null},events:{"click .f-sub":"_submit","click .f-cancel":"_cancel","click .all-checked":"_checkAll","click .rate-chk":"_cancelCheckAll"},_renderCpt:function(){var a=this.element,b=$(".comment-input",a),c=new l({element:b,withAt:!0});this.atInput=c},render:function(){var a=m.superclass.render.apply(this,arguments);return this._renderCpt(),a},show:function(){var a=m.superclass.show.apply(this,arguments);return this._createPlanInfo(),a},hide:function(){var a=m.superclass.hide.apply(this,arguments);return this._clear(),a},getRequestData:function(){var a=this.element,b=$(".comment-input",a),c=$(".comment-field",a),d=$(".is-send-sms",a),e={},f=_.str.trim(b.val());return e.replyContent=f,e.feedIDAndRates=[],c.each(function(){var a=$(this),b=$(".rate-select",a),c=$(".rate-chk",a),d=a.attr("feedids").split(","),f=b.val();c.prop("checked")&&_.each(d,function(a){e.feedIDAndRates.push({feedID:a,rate:f})})}),e.isSendSms=d.prop("checked"),e},isValid:function(){var a=this.element,b=$(".comment-input",a),c=$(".comment-field",a),d=this.getRequestData();return 0==d.replyContent.length?(g.showInputError(b),!1):0==c.length?(g.alert("没有需要您点评的日志"),!1):d.replyContent.length>2e3?(g.alert("点评内容不能超过2000字，目前已超出<em>"+(d.replyContent.length-2e3)+"</em>个字"),!1):0==d.feedIDAndRates.length?(g.alert("请勾选点评内容"),!1):!0},_clear:function(){var a=this.element,b=$(".comment-input",a),c=$(".comment-field",a),d=$(".is-send-sms",a);b.val("").trigger("autosize.resize"),c.remove(),d.prop("checked",!1)},_checkAll:function(){var a=this.element,b=$(".all-checked",a),c=$(".rate-chk",a);b.prop("checked")?c.prop("checked",!0):c.prop("checked",!1)},_cancelCheckAll:function(){var a=this.element,b=$(".all-checked",a),c=$(".rate-chk",a);c.filter(":checked").length==c.length?b.prop("checked",!0):b.prop("checked",!1)},_submit:function(){var a=this,b=this.getRequestData();this.isValid()&&g.api({data:b,url:"/feedplan/batchFeedPlanComment",success:function(b){b.success&&(a.hide(),a.get("list")&&a.get("list").reload())}})},_cancel:function(){this.hide()},_getPlanInfoCompiled:function(){var a='<tr employeeid="{{employeeId}}" feedids="{{feedIDs}}" class="comment-field"><td align="left" width="30"><input type="checkbox" class="rate-chk" checked="checked" /></td><td align="left"><img class="pldp_tdimg_head" src="{{profileImage}}" width="25" height="25" />{{employeeName}}</td><td align="left" class="color-999999">评分:<select class="rate-select"><option value="5">五分：非常满意</option><option value="4">四分：超过预期</option><option value="3" selected="selected">三分：符合要求</option><option value="2">二分：不合格</option><option value="1">一分：严重批评</option></select></td><td width="90"><a href="javascript:;" class="fna-blue">共{{count}}条未点评</a></td></tr>';return _.template(a)},_createPlanInfo:function(){var a=this._getPlanInfoCompiled(),b=this.element,c=$(".all-checked-wrapper",b);g.api({url:"/feedplan/getBatchFeedPlanCommentInfos",type:"get",success:function(b){var d,e="";b.success&&(d=b.value.items,_.each(d,function(b){e+=a({employeeId:b.employeeID,employeeName:b.employee.name,profileImage:g.getAvatarLink(b.employee.profileImage,3),feedIDs:b.feedIDs.join(","),count:b.feedIDs.length})}),$(e).insertAfter(c),0==d.length?($(".dialog-empty-wrap").show(),$(".rph-list-wrap").hide()):($(".dialog-empty-wrap").hide(),$(".rph-list-wrap").show()))}})},destroy:function(){var a;return this.atInput&&this.atInput.destroy(),a=m.superclass.destroy.apply(this,arguments)}});b.init=function(){var a,c,d=b.tplName,e=b.tplEl,g=$(".feed-list",e),j=$(".feed-list-pagination",e),k=$(".plan-status-type",e),l=$(".search-inp",e),n=$(".search-btn",e);i.init(e,d),a=new m({trigger:$("#btn-remark-plan",e),content:$(".bat-remark-plan-tpl",e).html()}).render(),c=new h({element:g,pagSelector:j,pagOpts:{pageSize:10,visiblePageNums:7},listPath:"/FeedPlan/GetFeedPlanOfIVetting",defaultRequestData:function(){var a=$(".plan-status",k),b=$(".plan-type",k),c=a.filter(".depw-tabs-aon").attr("val"),d=b.filter(".depw-tabs-aon").attr("val");return{type:c,planType:d,keyword:_.str.trim(l.val())}},searchOpts:{inputSelector:l,btnSelector:n}}),a.set("list",c),k.on("click",".plan-status,.plan-type",function(a){var b=$(this);b.hasClass("plan-status")?($(".plan-status",k).removeClass("depw-tabs-aon"),b.addClass("depw-tabs-aon")):($(".plan-type",k).removeClass("depw-tabs-aon"),b.addClass("depw-tabs-aon")),c.reload(),a.preventDefault()}),n.click(function(a){c.reload(),a.preventDefault()});var o=function(){c.destroy()};f.one("beforeremove",function(a){a==d&&o()}),$(".plan-status",k).removeClass("depw-tabs-aon").eq(0).addClass("depw-tabs-aon"),$(".plan-type",k).removeClass("depw-tabs-aon").eq(0).addClass("depw-tabs-aon"),c.reload()}});