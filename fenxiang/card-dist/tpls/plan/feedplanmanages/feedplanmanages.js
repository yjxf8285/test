/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/plan/feedplanmanages/feedplanmanages",["util","../plan-common","moment","../plan-common.html","tpls/approve/approve-common","modules/fs-qx/fs-qx-helper"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=e.event,g=a("util"),h=a("../plan-common"),i=a("tpls/approve/approve-common"),j=a("modules/fs-qx/fs-qx-helper"),k=j.JoinDialog,l=i.AllApproveValid;b.init=function(){var a=b.tplEl,c=b.tplName,e=g.getContactData(),i=e.u,j=i.inVipService;h.init(a,c);var m=function(a){a=$.extend({element:$("body")},a||{}),this.opts=a,this.element=a.element,this.init()};$.extend(m.prototype,{init:function(){this.inVipServiceFn(),this.bindEvents(),this.setYearMonth(),this.renderCircleDialog(),this.renderEmployeesDialog()},inVipServiceFn:function(){var a=this.element,b=$(".j-submit-btn",a),c=$(".total-download-time",a);$(".readme-list",a),j?$(".readme-list",a).remove():(b.addClass("button-state-disabled"),g.api({url:"/file/GetDownLoadLimit",type:"get",dataType:"json",data:{bussinessType:2},beforeSend:function(){},success:function(d){if(d.success){var e=d.value.value,f=d.value.value1,g=e-f;c.text(e),g>0?(parseFloat(g)/e<=.1?(b.text("生成报表（余"+g+"次）"),$(".readme-list",a).show()):(b.text("生成报表"),$(".readme-list",a).hide()),b.data("value",g),b.data("total",e),b.removeClass("button-state-disabled")):(b.text("生成报表（余0次）"),$(".readme-list",a).show())}}}))},bindEvents:function(){var a=this.element,b=this;a.on("click",".j-submit-btn",function(a){var c=$(a.currentTarget);c.is(".button-state-disabled")||(0==b.circleJoinData.length&&0==b.employeesJoinData.length?g.alert("部门或者员工至少选择一个"):(b.inVipServiceFn(),b.getMonthFeedPlanExcel()))}),a.on("click",".feedplanmanages-downbtn",function(b){var c=$(b.currentTarget),d=$(".j-submit-btn",a),e=d.data("value"),f=d.data("total");parseFloat(e-1)/f<=.1?(d.text("生成报表（余"+(e-1)+"次）"),$(".readme-list",a).show()):$(".readme-list",a).hide(),1==e&&d.addClass("button-state-disabled"),c.hide()}),a.on("click",".j-select-circle",function(){b.getAllCircleInfos()}),a.on("click",".j-select-employee",function(){b.getAllShortEmployees()}),a.on("click",".j-circle-warp .j-select-clear",function(){var a=$(this).closest(".rwarp").find(".circle-warp");b.circleJoinData=[],a.hide(),$(this).hide()}),a.on("click",".j-employees-warp .j-select-clear",function(){var a=$(this).closest(".rwarp").find(".circle-warp");b.employeesJoinData=[],a.hide(),$(this).hide()}),a.on("click",".circle-warp b",function(){var a=$(this).closest("dd"),c=$(this).closest(".circle-warp"),d=$(this).closest(".rwarp").find(".j-select-clear"),e=a.data("id"),f=a.data("type");"c"==f?b.circleJoinData=g.excludeDataByKey(e,"id",b.circleJoinData):b.employeesJoinData=g.excludeDataByKey(e,"id",b.employeesJoinData),a.remove(),""==c.html()&&(c.hide(),d.hide())})},getAllShortEmployees:function(){var a=this;g.api({url:"/Employee/GetAllShortEmployees",type:"get",dataType:"json",data:{},success:function(b){var c=b.value;b.success&&(_.each(c,function(a){a.id=a.employeeID}),a.allEmployeesData=c,a.modifyEmployeesDialog())}})},getAllCircleInfos:function(){var a=this;g.api({url:"/Employee/GetAllCircleInfos",type:"get",dataType:"json",data:{},success:function(b){b.success&&(a.allCircleData=b.value,a.modifyCircleDialog())}})},renderEmployeesDialog:function(){this.employeesDialog=new k({unjoinLabel:"未选员工",joinLabel:"已选员工",unit:"项",bbarUnit:"个员工",inputPlaceholder:"输入关键词，快速筛选员工",unjoinEmptyTip:"没有未选员工",unjoinSearchEmptyTip:"没有筛选条件为{{keyword}}的员工",joinEmptyTip:"没有已选员工",joinSearchEmptyTip:"没有筛选条件为{{keyword}}的员工"}).render(),this.employeesDialog.setTitle("选择员工"),this.employeesJoinData=[]},renderCircleDialog:function(){this.circleDialog=new k({unjoinLabel:"未选部门",joinLabel:"已选部门",unit:"项",bbarUnit:"部门",inputPlaceholder:"输入关键词，快速筛选部门",unjoinEmptyTip:"没有未选部门",unjoinSearchEmptyTip:"没有筛选条件为{{keyword}}的部门",joinEmptyTip:"没有已选部门",joinSearchEmptyTip:"没有筛选条件为{{keyword}}的部门"}).render(),this.circleDialog.setTitle("选择部门"),this.circleJoinData=[]},modifyEmployeesDialog:function(){var a=this,b=this.employeesDialog,c=a.employeesJoinData,d=[];_.each(c,function(a){d.push(a.id)});var e=g.excludeDataByKey(d,"id",a.allEmployeesData);b.setInitData({joinData:c,unjoinData:e}),b.show(),b.set("successCb",function(b){a.employeesJoinData=b,this.hide(),a.showEmployeesDom()})},modifyCircleDialog:function(){var a=this,b=this.circleDialog,c=a.circleJoinData,d=[];_.each(c,function(a){d.push(a.id)});var e=g.excludeDataByKey(d,"id",a.allCircleData);e=_.reject(e,function(a){return a.isStop}),b.setInitData({joinData:c,unjoinData:e}),b.show(),b.set("successCb",function(c){a.circleJoinData=c,b.hide(),a.showCircleDom()})},showEmployeesDom:function(){var a=this.element,b=$(".j-employees-warp",a),c=$(".circle-warp",b),d=$(".j-select-clear",b),e=this.employeesJoinData,f="";$.each(e,function(a,b){f+='<dd data-id="'+b.id+'" data-type="p">'+b.name+"<b> ×</b></dd>"}),c.html(f).show(),d.show()},showCircleDom:function(){var a=this.element,b=$(".j-circle-warp",a),c=$(".circle-warp",b),d=$(".j-select-clear",b),e=this.circleJoinData,f="";$.each(e,function(a,b){f+='<dd data-id="'+b.id+'" data-type="c">'+b.name+"<b> ×</b></dd>"}),c.html(f).show(),d.show()},getMonthFeedPlanExcel:function(){var a=this.element,b=$(".feedplanmanages-downbtn",a),c=$(".feedplanmanages-top-selcetyear",a),e=$(".feedplanmanages-top-selcetmonth",a),f="",h="",i=/,$/gi;$.each(this.circleJoinData,function(a,b){f+=""+b.id+","}),$.each(this.employeesJoinData,function(a,b){h+=""+b.id+","}),g.api({url:"/Feed/GetMonthFeedPlanExcel",type:"get",dataType:"json",timeout:12e4,data:{circleIDs:f.replace(i,""),employeeIDs:h.replace(i,""),year:c.val(),month:e.val()},beforeSend:function(){b.show().addClass("loading").html("正在生成报表，请稍后...")},success:function(a){a.success?b.attr("href",d.API_PATH+"/df/gettemp1?id="+a.value+"&name=员工月度日志统计报表.xls&bussinessType=2").removeClass("loading").html("生成完毕，点击下载报表"):b.hide()}},{modal:$(".j-submit-btn",a)})},setYearMonth:function(){var a=this.element,b=$(".feedplanmanages-top-selcetyear",a),c=$(".feedplanmanages-top-selcetmonth",a),d=(new Date).getFullYear(),e=(new Date).getMonth()+1,f="";10>e&&(e="0"+e);for(var g=2012;d>=g;g++)f+='<option value="'+g+'"> '+g+"年 </option>",b.html(f);b.val(d),c.val(e)},destroy:function(){}}),new m({element:a});var n=new l({defaultRequestData:function(){return{functionNo:6}},successCb:function(a){a.success}});f.one("switched",function(a){a==c&&n.show()})}});