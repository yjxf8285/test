/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/opportunities/showopportunity/showopportunity",["util","modules/feed-list/feed-list","dialog","moment","uilibs/tabs2","modules/publish/publish-helper","modules/crm-attachment-simple/crm-attachment-simple","modules/crm-attachment/crm-attachment","modules/crm-select-colleague/crm-select-colleague","modules/crm-opportunity-edit/crm-opportunity-edit","modules/crm-detaillists/crm-detaillists","modules/crm-select-competitor/crm-select-competitor","modules/crm-select-product/crm-select-product","modules/crm-productinopp-edit/crm-productinopp-edit","modules/crm-select-contacts/crm-select-contacts","modules/crm-competitorinopp-edit/crm-competitorinopp-edit","modules/crm-contract-edit/crm-contract-edit","modules/crm-contact-view/crm-contact-view","modules/crm-publish/crm-publish","modules/crm-follow-up/crm-follow-up","modules/crm-contact-box/crm-contact-box","modules/crm-chart/mainchart"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.event;var f=a("util"),g=a("modules/feed-list/feed-list"),h=a("dialog"),i=a("moment"),j=a("uilibs/tabs2");a("modules/publish/publish-helper");var k=a("modules/crm-attachment-simple/crm-attachment-simple"),l=a("modules/crm-attachment/crm-attachment"),m=a("modules/crm-select-colleague/crm-select-colleague"),n=a("modules/crm-opportunity-edit/crm-opportunity-edit"),o=a("modules/crm-detaillists/crm-detaillists"),p=a("modules/crm-select-competitor/crm-select-competitor"),q=a("modules/crm-select-product/crm-select-product"),r=a("modules/crm-productinopp-edit/crm-productinopp-edit"),s=a("modules/crm-select-contacts/crm-select-contacts"),t=a("modules/crm-competitorinopp-edit/crm-competitorinopp-edit"),u=a("modules/crm-contract-edit/crm-contract-edit"),v=a("modules/crm-contact-view/crm-contact-view"),w=a("modules/crm-publish/crm-publish"),x=a("modules/crm-follow-up/crm-follow-up"),y=a("modules/crm-contact-box/crm-contact-box"),z=a("modules/crm-chart/mainchart"),A=function(a){a=$.extend({element:null},a||{}),this.options=a,this.$el=a.element,this.myID=this.options.queryParams.id,this.init()};$.extend(A.prototype,{init:function(){this.$el,this._getTagsDatas(),this.setupComponent(),this.bindEvents();var a=this,c=b.tplName;e.event.one("beforeremove",function(b){b==c&&a.destroy()})},bindEvents:function(){var a=this.$el,b=this;f.mnGetter($(".updatestates-select-list",a)),f.mnEvent($(".updatestates-select-list",a),"change",function(a,c){a!=b.salesStageNo&&(b.updateSalesOpportunitySalesStageNo.val=a,b.updateSalesOpportunitySalesStageNo.text=c,b.updateSalesOpportunitySalesStageNo.show())}),f.mnEvent($(".isoutreport-btn",a),"change",function(a){a=1==a?!0:!1,f.api({url:"/SalesOpportunity/UpdateSalesOpportunityOutReportFlag",type:"post",dataType:"json",data:{salesOpportunityID:b.myID,isOutReport:a},success:function(a){a.success&&f.remind(2,"修改成功")}})}),a.on("click",".crm-button-back",function(){b._backToListPage()}),a.on("click",".delete-btn",function(){b._delete()}),a.on("click",".modify-btn",function(){b.editOppDialog.show()}),a.on("click",".canchangeowner-btn",function(){b.selectColleagueS.show()}),a.on("click",".update-opportunity-states-un-btn",function(){f.confirm("你确定要作废选该销售机会吗？","",function(){f.api({url:"/SalesOpportunity/UpdateSalesOpportunitysStates",type:"post",dataType:"json",data:{salesOpportunityIDs:b.myID,states:2},success:function(a){if(a.success){var c=a.value&&a.value.result&&a.value.result[0];c&&(c.value1?(f.remind(2,"作废机会成功"),b.refresh()):f.alert("作废销售机会失败，原因："+c.value2))}}})})}),a.on("click",".update-opportunity-states-on-btn",function(){f.confirm("你确定要启用选该销售机会吗？","",function(){f.api({url:"/SalesOpportunity/UpdateSalesOpportunitysStates",type:"post",dataType:"json",data:{salesOpportunityIDs:b.myID,states:1},success:function(a){if(a.success){var c=a.value&&a.value.result&&a.value.result[0];c&&(c.value1?(f.remind(2,"启用机会成功！"),b.refresh()):f.alert("启用销售机会失败，原因："+c.value2))}}})})}),a.on("click",".follow-switch-btn",function(a){b._switchFollow(a)}),a.on("click",".add-contract-in-opp",function(){b.addContractDialog.show()}),a.on("click",".modify-contracts-in-opp",function(a){b.editContractDialog.show({contractID:$(a.target).parent().parent().attr("data-id")})}),a.on("click",".add-product-in-opp",function(){b.addProductSelectDialog.show()}),a.on("click",".modify-product-in-opp",function(a){b.modifyProductInOppDialog.show({flag:"view",oppProductRelationID:$(a.target).parent().parent().attr("data-id")})}),a.on("click",".add-competitor-in-opp",function(){b.addCompetitorSelectDialog.show()}),a.on("click",".add-contracts-in-opp",function(){b.addContractDialog.show()}),a.on("click",".modify-competitor-in-opp",function(a){b.modifyCompetitorInOppDialog.show({flag:"view",salesOpportunityID:b.options.queryParams.id,competitorID:$(a.target).parent().parent().attr("data-id")})}),this.selectColleagueS.on("selected",function(c){var d=$(".owner-name",a).attr("data-ownerId")||b.responseData.value.salesOpportunity.owner.employeeID;f.confirm("你确定要将销售机会的负责人变更为"+c.name+"吗？","",function(){f.api({url:"/SalesOpportunity/UpdateSalesOpportunitysOwnerID",type:"post",dataType:"json",data:{salesOpportunityIDs:b.myID,ownerID:c.employeeID},success:function(e){if(e.success){var g=e.value.result,h="";_.each(g,function(e){var g=e.value1,i=e.value2;g?(f.remind(1,"变更成功"),$(".owner-name",a).text(c.name).attr("data-ownerId",c.employeeID),b.followUpBox.replace(d,c)):(h="变更销售机会的负责人失败，原因："+i+"</br>",f.alert(h))})}}})})})},_switchFollow:function(a){var b=$(a.target),c=this;b.hasClass("following")?f.api({url:"/SalesOpportunity/SalesOpportunityCancelFollow",type:"post",dataType:"json",data:{salesOpportunityID:c.myID},success:function(a){a.success&&b.removeClass("following").addClass("no-follow").text("关注")}}):f.api({url:"/SalesOpportunity/SalesOpportunityFollow",type:"post",dataType:"json",data:{salesOpportunityID:c.myID},success:function(a){a.success&&b.removeClass("no-follow").addClass("following").text("已关注")}})},_getTagsDatas:function(){var a=f.getCrmData(),b=a.functionPermissions,c=f.getTagsByType(9),d=[],e=this,g=[{text:"不限",value:0}],h=[{text:"不限",value:0}];_.each(c,function(a){d.push(a),109===a.systemTagCode&&(_.each(a.options,function(a){h.push({text:a.name,value:a.fBusinessTagOptionID})}),e.marketingEventTypeFBusinessTagID=a.fBusinessTagID)}),_.extend(this,{allTags:d,competitorscale:g,competitiveness:h,functionPermissions:b})},setCrmAttachment:function(){var a=this,b=$(".crm-attachment-simple-warp",this.$el);this.attachment=new k({element:b,condition:{dataID:a.myID,fbrType:3}}),this.attachment.render(),this.attachment.on("toAll",function(){a.tab.select("tab-files")}),this.attachment.on("uploaded",function(){a.attachmentList.reload()})},setAttachmentList:function(){var a=this,b=$(".crm-attachmentlist-simple-warp",this.$el);this.attachmentList=new l({element:b,condition:{fbrType:3,dataID:a.myID}}),this.attachmentList.on("uploaded",function(){a.attachment.reload()})},setFeedList:function(){var a=$(".crm-feed-list-warp",this.$el),b=$(".feed-list-pagination",this.$el),c=$("",this.$el),d=this;this.feedList=new g({element:a,pagSelector:b,pagOpts:{pageSize:15,visiblePageNums:3},GetBatchFilesSource:1,crmParam:{type:"opportunity",id:d.options.queryParams.id},listPath:"/CrmFeed/GetFeeds",defaultRequestData:function(){return{fbrType:3,dataID:d.myID,type:1,keyword:_.str.trim(c.val())}},listEmptyText:"暂无记录"}),this.feedList.load()},showFnBtn:function(){var a=this.$el,b=this.responseData.value,c=b.canModify,d=b.canDelete,e=b.canChangeOwner;c?$(".modify-product-btn",a).show():$(".modify-product-btn",a).hide(),d?$(".delete-product-btn",a).show():$(".delete-product-btn",a).hide(),e?$(".canchangeowner-product-btn",a).show():$(".canchangeowner-product-btn",a).hide()},render:function(){var a,b,c=this.$el,d=this.responseData.value.customer||null,e=this.responseData.value.salesOpportunity,g="",h=$(".follow-switch-btn",c),j=f.getTplQueryParams2();d?(b={id:d.customerID,returnUrl:"opportunities/showopportunity/=/param-"+encodeURIComponent(JSON.stringify(j))},$(".jdata-customername",c).html('<a href="#customers/showcustomer/=/param-'+encodeURIComponent(JSON.stringify(b))+'">'+d.name+"</a>")):$(".jdata-customername",c).html('<a href="javascript:;"></a>');var k="",l="",m="",n=this.responseData.value.salesOpportunity.oppProductRelations||null,o=this.responseData.value.salesOpportunity.oppCompetitorRelations||null,p=this.responseData.value.contracts||null;if(n&&n.length>0?(_.each(n,function(a){k+=' <li data-id="'+a.oppProductRelationID+'"> <span class="tit"><a href="javascript:;" class="modify-product-in-opp">'+a.productName+'</a></span> <span class="value" title="单价 '+_.str.numberFormat(a.unitAmount,2)+" * 数量 "+_.str.numberFormat(a.count,4)+'">￥'+_.str.numberFormat(a.totalAmount)+"</span> </li>"}),$(".detail-left-list-product",c).html('<ul class="detail-left-list-ul">'+k+"</ul>"),$(".detail-left-list-product",c).parent().find(".fn-right").show()):($(".detail-left-list-product",c).html('<div class="text-align-c"> 当前机会下没有产品，<a href="javascript:;" class="add-product-in-opp">立即添加</a></div>'),$(".detail-left-list-product",c).parent().find(".fn-right").hide()),o&&o.length>0?(_.each(o,function(a){l+=' <li data-id="'+a.competitorID+'"  data-opp-id="'+a.salesOpportunityID+'"> <span class="tit"><a href="javascript:;" class="modify-competitor-in-opp">'+a.name+'</a></span> <span class="value">赢率'+a.winRate+"%</span> </li>"}),$(".detail-left-list-competitors",c).html('<ul class="detail-left-list-ul">'+l+"</ul>"),$(".detail-left-list-competitors",c).parent().find(".fn-right").show()):($(".detail-left-list-competitors",c).html('<div class="text-align-c"> 当前机会下没有竞争对手，<a href="javascript:;" class="add-competitor-in-opp">立即添加</a></div>'),$(".detail-left-list-competitors",c).parent().find(".fn-right").hide()),p&&p.length>0?(_.each(p,function(a){m+=' <li data-id="'+a.contractID+'"> <span class="tit"><a href="javascript:;" class="modify-contracts-in-opp">'+a.title+'</a></span> <span class="value">'+a.statesDesc+"</span> </li>"}),$(".detail-left-list-contracts",c).html('<ul class="detail-left-list-ul">'+m+"</ul>"),$(".detail-left-list-contracts",c).parent().find(".fn-right").show()):($(".detail-left-list-contracts",c).html('<div class="text-align-c"> 当前机会下没有合同，<a href="javascript:;" class="add-contracts-in-opp">立即添加</a></div>'),$(".detail-left-list-contracts",c).parent().find(".fn-right").hide()),e){e.isOutReport?$(".isoutreport-btn",c).find(".mn-checkbox-item").removeClass("mn-selected"):$(".isoutreport-btn",c).find(".mn-checkbox-item").addClass("mn-selected"),a=e.fBusinessTagRelations,g="",_.each(a,function(a){var b=a.fBusinessTagName,c=a.fBusinessTagOptionName;g+='<li class="fn-clear"><span class="input-tip">'+b+'</span><div class="input-wrapper">'+c+"</div></li>"}),$(".product-fbusinesstagrelations",c).html(g);var q=$(".opportunity-define-field-tag-ul",c),r=[];switch(e.userDefineFieldDataList&&e.userDefineFieldDataList.textList&&_.map(e.userDefineFieldDataList.textList,function(a){""!=a.value&&(r.push('<li class="fn-clear"><div class="input-tip">'),r.push(a.fieldDescription),r.push('</div><div class="textarea-wrapper">'),r.push(a.value),r.push("</div></li>"))}),e.userDefineFieldDataList&&e.userDefineFieldDataList.dateList&&_.map(e.userDefineFieldDataList.dateList,function(a){a.value>0&&(r.push('<li class="fn-clear"><div class="input-tip">'),r.push(a.fieldDescription),r.push('</div><div class="input-wrapper">'),r.push(i.unix(a.value).format("YYYY年MM月DD日")),r.push("</div></li>"))}),e.userDefineFieldDataList&&e.userDefineFieldDataList.numList&&_.map(e.userDefineFieldDataList.numList,function(a){r.push('<li class="fn-clear"><div class="input-tip">'),r.push(a.fieldDescription),r.push('</div><div class="input-wrapper">'),r.push(a.value),r.push("</div></li>")}),r.length>0?(q.show(),q.html(r.join(""))):q.hide(),e.isFollow?h.addClass("following").text("已关注"):h.addClass("no-follow").text("关注"),$(".hd-titname",c).text(e.name),$(".jdata-ownername",c).text(e.owner.name),$(".jdata-createtime",c).text(i.unix(e.createTime).format("YYYY年MMMDD日 HH:mm")),$(".jdata-lasteditemployeename",c).text(e.lastEditEmployee.name),$(".jdata-lastedittime",c).text(i.unix(e.lastEditTime).format("YYYY年MMMDD日 HH:mm")),$(".jdata-name",c).text(e.name),$(".jdata-company",c).text(e.company),e.states){case 1:$(".update-opportunity-states-btn",c).text("作废").addClass("update-opportunity-states-un-btn").removeClass("update-opportunity-states-on-btn");break;case 2:$(".update-opportunity-states-btn",c).text("启用").addClass("update-opportunity-states-on-btn").removeClass("update-opportunity-states-un-btn")}$(".jdata-expecteddealtime",c).text(i.unix(e.expectedDealTime).format("YYYY年MM月DD日")),$(".jdata-expectedincome",c).text("￥"+_.str.numberFormat(parseFloat(e.expectedIncome),2)),$(".tab-time-line-box .jdata-expectedsalesamount",c).text("￥"+_.str.numberFormat(parseFloat(e.expectedSalesAmount),2)),$(".tab-time-line-box .jdata-maybeamount",c).text("￥"+_.str.numberFormat(parseFloat(e.expectedSalesAmount*e.salesStage.winRate/100),2)),$(".tab-base-info-box .jdata-expectedsalesamount",c).text(_.str.numberFormat(parseFloat(e.expectedSalesAmount),2)+"元"),$(".tab-base-info-box .jdata-maybeamount",c).text(_.str.numberFormat(parseFloat(e.expectedSalesAmount*e.salesStage.winRate/100),2)+"元"),$(".jdata-foundtime",c).text(i.unix(e.foundTime).format("YYYY-MM-DD")),$(".updatestates-select-list",c).find(".mn-select-title").text(e.salesStage.name+"（"+e.salesStage.winRate+"%）"),$(".jdata-salesstage",c).text(e.salesStage.name+"，赢率"+e.salesStage.winRate+"%"),$(".jdata-l",c).text(e.L),$(".jdata-executiondescription",c).text(e.executionDescription),$(".jdata-summary",c).text(e.summary),$(".jdata-effect",c).text(e.effect),$(".jdata-demands",c).text(e.demands),$(".jdata-description",c).text(e.description)}this.showFnBtn()},load:function(){var a=this.$el,b=this.options.queryParams.id,c=this;f.api({url:"/SalesOpportunity/GetSalesOpportunityDetailByID",type:"get",dataType:"json",data:{salesOpportunityID:b,attachNum:6},success:function(d){if(d.success){c.responseData=d,c.render(),c.addContractDialog||(c.addContractDialog=new u({salesOpportunityID:d.value.salesOpportunity.salesOpportunityID,salesOpportunityName:d.value.salesOpportunity.name,customerID:d.value.customer.customerID,customerName:d.value.customer.name}),c.addContractDialog.on("success",function(){c.refresh(),c.detaillistContracts.refresh()}),c.editContractDialog=new u,c.editContractDialog.on("success",function(){c.refresh(),c.detaillistContracts.refresh()}),c.editOppDialog=new n({salesOpportunityID:c.options.queryParams&&c.options.queryParams.id,customerName:d.value&&d.value.customer&&d.value.customer.name}),c.editOppDialog.on("success",function(){c.refresh()}),c.editOppDialog.v=c);var e=[],g=d.value.salesOpportunity.oppCombineSalers;_.each(g,function(a){e.push(a.employee)}),c.setPublish(),c.followUpBox||(c.followUpBox=new x({element:$(".crm_follow_up",a),addApi:"/SalesOpportunity/AddOppCombineSalers",deleteApi:"/SalesOpportunity/DeleteOppCombineSaler",parameter:{salesOpportunityID:b,employeeIDs:""},selectColleagueS:c.selectColleagueS,items:e,ownerID:d.value.salesOpportunity.ownerID,title:"联合跟进人",typeName:"机会",name:"联合跟进人"}));var h=d.value.salesOpportunity.oppContactRelations;c.contactBoxModify?c.contactBoxModify.reload(h):(c.contactBoxModify=new y({element:$(".crm_contact_modify",a),customerID:d.value.customer.customerID,combineApi:"/SalesOpportunity/SetOppContacts",type:"modify",parameter:{salesOpportunityID:b,contactIDs:[]},items:h}),c.contactBoxModify.on("modify",function(){c.detaillistContacts.refresh()}),c.contactBoxModify.on("onNew",function(){c.modifyDialog.show()}));var i=d.value.salesOpportunity.salesStage.salesStageNo,j=f.getCrmData(),k=j.salesStagesInUse,l=[];_.each(k,function(a){l.push({text:a.name+"（"+a.winRate+"%）",value:a.salesStageNo,selected:a.salesStageNo==i?!0:!1,defaultSelected:a.salesStageNo==i?!0:!1})}),c.salesStageNo=i,f.mnSelect($(".updatestates-select-list",this.$el),"syncModel",l),c.updateSalesOpportunitySalesStageNo=new B({content:a.filter(".opportunitysalesstageno-tpl").html()}),c.updateSalesOpportunitySalesStageNo.v=c,c.updateSalesOpportunitySalesStageNo.defaultText=$(".updatestates-select-list",a).find(".mn-select-title").text(),c.updateSalesOpportunitySalesStageNo.defaulValue=i,c.mainchart=new z.Salesstage($(".crm-left-mainchart",a),i),c._detaillistContacts(),c._initModifyDialog()}else f.alert(d.message,function(){c._backToListPage()},{zIndex:3e3})}},{errorAlertModel:"1"})},refresh:function(){this.load()},_backToListPage:function(){var a=f.getTplQueryParams2();e.navRouter.navigate(a.returnUrl,{trigger:!0}),e.event.trigger("dataUpdate")},_delete:function(){var a=this;f.confirm("你确定要删除该销售机会吗？删除后将不可恢复。","",function(){f.api({url:"/SalesOpportunity/DeleteSalesOpportunitys",type:"post",dataType:"json",data:{salesOpportunityIDs:a.myID},success:function(b){if(b.success){var c=b.value.result,d=c[0],e=d.value1,g=d.value2;e?a._backToListPage():f.alert("删除失败，原因："+g)}}})})},_detaillistContacts:function(){var a=this,b=this.$el;this.detaillistContacts||(this.detaillistContacts=new o({warpEl:$(".tab-contact-box",b),title:"联系人",rightTopBTnText:"修改",operationClass:"table-modify-btn",url:"/SalesOpportunity/GetContactsByOppID",data:{salesOpportunityID:a.myID},emptyStr:"当前机会下没有获取到联系人",jDatas:"contacts",thDatas:["姓名","联系方式","职务","部门","公司"],aoColumnsData:[{mData:"name",sWidth:"200px",sClass:"text-black",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"firstContactWay",sWidth:"120px",sClass:"",bSortable:!1,mRender:function(a){var b=a.typeDesc,c=a.content;c&&(c="："+c);var d='<span title="'+b+c+'">'+b+c+"</span>";return d}},{mData:"post",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"department",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"company",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"blank",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}]}),this.detaillistContacts.refresh(),this.detaillistContacts.on("add",function(){a.modifyDialog.show()}),this.detaillistContacts.on("modify",function(b){a.modifyDialog.show(b)}),this.detaillistContacts.on("tr",function(b){a.contactViewDialog.show({contactID:b.contactID})}))},_initModifyDialog:function(){var a=this;a.modifyDialog=new s({title:"选择联系人",url:"/Contact/GetContactsByCustomerID",type:"modify",defaultCondition:{customerID:a.responseData.value.salesOpportunity.customerID}}),a.modifyDialog.on("selected",function(b){var c={},d=[];_.each(b,function(a){d.push(a.contactID)}),c.contactIDs=d,c.salesOpportunityID=a.myID,f.api({url:"/SalesOpportunity/SetOppContacts",type:"post",dataType:"json",data:c,success:function(b){b.success&&(a.detaillistContacts.refresh(),a.refresh())}})})},_detaillistContracts:function(){var a=this,b=this.$el,c=this;this.detaillistContracts=new o({warpEl:$(".tab-contract-box",b),title:"合同",url:"/SalesOpportunity/GetContractsByOppID",data:{salesOpportunityID:a.myID},emptyStr:"当前机会下没有获取到合同",jDatas:"contracts",thDatas:["标题","合同编号","状态","开始日期","结束日期","操作"],aoColumnsData:[{mData:"title",sWidth:"200px",sClass:"text-black",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"contractNO",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"statesDesc",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"beginDate",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+i.unix(a).format("YYYY-MM-DD")+'">'+i.unix(a).format("YYYY-MM-DD")+"</span>";return b}},{mData:"endDate",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+i.unix(a).format("YYYY-MM-DD")+'">'+i.unix(a).format("YYYY-MM-DD")+"</span>";return b}},{mData:"blank",sWidth:"200px",bSortable:!1,mRender:function(){var a='<a href="javascript:;" class="table-modify-btn">编辑</a> <a href="javascript:;" class="table-del-btn">删除</a>';return a}},{mData:"blank",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}]}),this.detaillistContracts.on("tr",function(b){a.editContractDialog.show({contractID:b.contractID})}),this.detaillistContracts.on("add",function(){a.addContractDialog.show()}),this.detaillistContracts.on("modify",function(b){a.editContractDialog.show({contractID:b.contractID})}),this.detaillistContracts.on("del",function(a){var b=this;f.confirm("你确定要解除该合同与此机会的关系吗？","",function(){f.api({url:"/SalesOpportunity/DeleteOppContractRelation",type:"post",dataType:"json",data:{salesOpportunityID:a.salesOpportunityID,contractID:a.contractID},success:function(a){a.success&&(c.refresh(),b.refresh())}})})})},_detaillistProduct:function(){var a=this,b=this.$el,c=this;this.detaillistProduct=new o({warpEl:$(".tab-product-box",b),title:"产品",url:"/SalesOpportunity/GetOppProductRelationsByOppID",data:{salesOpportunityID:a.myID},emptyStr:"当前机会下没有获取到产品",jDatas:"oppProductRelations",thDatas:["名称","单位","单价","数量","总价","操作"],aoColumnsData:[{mData:"productName",sWidth:"200px",sClass:"text-black",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"unit",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"unitAmount",sWidth:"90px",bSortable:!1,mRender:function(a){var b=_.str.numberFormat(parseFloat(a),2),c='<span title="'+b+'">'+b+"</span>";return c}},{mData:"count",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"totalAmount",sWidth:"90px",bSortable:!1,mRender:function(a){var b=_.str.numberFormat(parseFloat(a),2),c='<span title="'+b+'">'+b+"</span>";return c}},{mData:"blank",sWidth:"200px",bSortable:!1,mRender:function(){var a='<a href="javascript:;" class="table-modify-btn">编辑</a> <a href="javascript:;" class="table-del-btn">删除</a>';return a}},{mData:"blank",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}]}),this.detaillistProduct.on("add",function(){a.myID,a.addProductSelectDialog.show()}),this.detaillistProduct.on("modify",function(b){a.modifyProductInOppDialog.show({flag:"edit",oppProductRelationID:b.oppProductRelationID})}),this.detaillistProduct.on("tr",function(b){a.modifyProductInOppDialog.show({flag:"view",oppProductRelationID:b.oppProductRelationID})}),this.detaillistProduct.on("del",function(a){var b=this;f.confirm("你确定要删除该产品吗？","",function(){f.api({url:"/SalesOpportunity/DeleteOppProductRelation",type:"post",dataType:"json",data:{oppProductRelationID:a.oppProductRelationID},success:function(a){a.success&&(c.refresh(),b.refresh())}})})})},_detaillistCompetitor:function(){var a=this,b=this.$el,c=this;this.detaillistCompetitor=new o({warpEl:$(".tab-competitor-box",b),title:"竞争对手",url:"/SalesOpportunity/GetOppCompetitorRelationsByOppID",data:{salesOpportunityID:a.myID},emptyStr:"当前机会下没有获取到竞争对手",jDatas:"oppCompetitorRelations",thDatas:["名称","报价","赢率","优势","劣势","操作"],aoColumnsData:[{mData:"name",sWidth:"200px",sClass:"text-black",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"price",sWidth:"90px",bSortable:!1,mRender:function(a){var b=_.str.numberFormat(parseFloat(a),2),c='<span title="'+b+'">'+b+"</span>";return c}},{mData:"winRate",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'%">'+a+"%</span>";return b}},{mData:"advantage",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"disadvantage",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"blank",sWidth:"200px",bSortable:!1,mRender:function(){var a='<a href="javascript:;" class="table-modify-btn">编辑</a> <a href="javascript:;" class="table-del-btn">删除</a>';return a}},{mData:"blank",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}]}),this.detaillistCompetitor.on("add",function(){a.addCompetitorSelectDialog.show()}),this.detaillistCompetitor.on("modify",function(b){a.modifyCompetitorInOppDialog.show({flag:"edit",salesOpportunityID:b.salesOpportunityID,competitorID:b.competitorID})}),this.detaillistCompetitor.on("tr",function(b){a.modifyCompetitorInOppDialog.show({flag:"view",salesOpportunityID:b.salesOpportunityID,competitorID:b.competitorID})}),this.detaillistCompetitor.on("del",function(a){var b=this;f.confirm("你确定要删除该竞争对手吗？","",function(){f.api({url:"/SalesOpportunity/DeleteOppCompetitorRelation",type:"post",dataType:"json",data:{salesOpportunityID:a.salesOpportunityID,competitorID:a.competitorID},success:function(a){a.success&&(c.refresh(),b.refresh())}})})})},setPublish:function(){var a=this,b=this.$el,c=this.options.queryParams.id;this.feedpublish||(this.feedpublish=new w({element:$(".feed-submit-box-warp",b),title:"新建销售记录",placeholder:"发布新销售记录",type:"event",condition:{associationContactIDs:"",fileInfos:[],isAllDayEvent:!1,startTime:0,remindType:1,isSentSms:!1,feedContent:"",parentFeedID:0,listTagOptionID:[],fbrType:3,customerID:a.responseData.value.salesOpportunity.customerID,contactIDs:0,salesOpportunityID:c},display:["time","contact","picture","attach","tag","at","topic"]}),this.feedpublish.on("post",function(){a.feedList.load()}))},setupComponent:function(){var a=this.$el,b=this,c=$(".tab-menu",a),d=this.options.queryParams&&this.options.queryParams.id;this.selectColleagueS=new m({isMultiSelect:!1,title:"请选择负责人"}),this.setFeedList(),this.setCrmAttachment(),this.setAttachmentList(),this._detaillistProduct(),this._detaillistCompetitor(),this._detaillistContracts(),this.tab=new j({element:c,container:this.$el,items:[{value:"tab-time-line",text:"时间线"},{value:"tab-base-info",text:"基本信息"},{value:"tab-contact",text:"联系人"},{value:"tab-product",text:"产品"},{value:"tab-competitor",text:"竞争对手"},{value:"tab-contract",text:"合同"},{value:"tab-files",text:"附件"}]}),this.tab.on("change",function(a,c){switch(c){case"tab-product":b.detaillistProduct.refresh();break;case"tab-competitor":b.detaillistCompetitor.refresh();break;case"tab-contract":b.detaillistContracts.refresh()}}),this.contactViewDialog=new v,this.addCompetitorSelectDialog=new p({salesOpportunityID:d}),this.addCompetitorSelectDialog.on("success",function(){b.detaillistCompetitor.refresh(),b.refresh()}),this.addProductSelectDialog=new q({salesOpportunityID:d}),this.addProductSelectDialog.on("success",function(){b.detaillistProduct.refresh(),b.refresh()}),this.modifyProductInOppDialog=new r({salesOpportunityID:d}),this.modifyProductInOppDialog.on("success",function(){b.detaillistProduct.refresh(),b.refresh()}),this.modifyCompetitorInOppDialog=new t({salesOpportunityID:d}),this.modifyCompetitorInOppDialog.on("success",function(){b.detaillistCompetitor.refresh(),b.refresh()}),this.addContactsDialog=new s({defaultCondition:{employeeID:f.getCurrentEmp().employeeID}}),this.addContactsDialog.on("selected",function(){b.detaillistContacts.refresh()})},destroy:function(){this.feedpublish&&this.feedpublish.destroy(),this.contactBoxModify&&this.contactBoxModify.destroy()}});var B=h.extend({attrs:{content:$(e).filter(".opportunitysalesstageno-tpl").html(),closeTpl:"<div class = 'crm-ui-dialog-close'>×</div>",className:"dialog-updatesalesopportunitysalesstagenodialog"},events:{"click .f-submit":"submit","click .f-cancel":"hide"},hide:function(){var a=B.superclass.hide.apply(this,arguments),b=$(".updatestates-select-list",this.v.$el);return f.mnSetter(b,this.defaulValue),a},show:function(){var a=B.superclass.show.apply(this,arguments),b=this.v.responseData.serviceTime||0,c=this.v.responseData.value.salesOpportunity.expectedDealTime||0,d=this.val,e=new Date(1e3*b).getMonth()+1,f=new Date(1e3*c).getMonth()+1;return 10==d?f!=e&&$(".set-nowtime",this.element).show():$(".set-nowtime",this.element).hide(),$(".text",this.element).text(this.text),$(".con",this.element).show(),a},submit:function(){var a=!1,b=this,c=$(".set-nowtime-checkbox",this.element);a=1==f.mnGetter(c)?!0:!1,f.api({url:"/SalesOpportunity/UpdateSalesOpportunitySalesStageNo",type:"post",dataType:"json",data:{salesOpportunityID:b.v.myID,isSetExpectedDealTime:a,salesStageNo:b.val},success:function(a){a.success&&(f.remind(1,"变更成功"),b.v.refresh()),b.hide()}})}});b.init=function(){var a=b.tplEl;b.tplName;var c=f.getTplQueryParams2(),d=new A({element:a,queryParams:c});d.load()}});