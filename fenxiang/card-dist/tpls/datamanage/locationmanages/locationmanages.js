/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/datamanage/locationmanages/locationmanages",["util","modules/fs-qx/fs-qx-helper","modules/publish/publish-helper","moment"],function(a,b){var c=window,d=c.FS;d.tpl;var e=a("util"),f=a("modules/fs-qx/fs-qx-helper"),g=a("modules/publish/publish-helper");a("moment");var h=f.JoinDialog,i=g.DateSelect;b.init=function(){b.tplName;var a=b.tplEl,c=function(a){a=$.extend({element:$("body")},a||{}),this.opts=a,this.element=a.element,this.init()};$.extend(c.prototype,{init:function(){this.bindEvents(),this.renderCircleDialog(),this.renderEmployeesDialog(),this.setDateSelect()},setDateSelect:function(){var a=new i({element:$(".j-starttime-warp"),placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）"}),b=new i({element:$(".j-endtime-warp"),placeholder:"选择日期",formatStr:"YYYY年MM月DD日（dddd）"});this.starttimeDs=a,this.endtimeDs=b},bindEvents:function(){var a=this.element,b=this;a.on("click",".j-submit-btn",function(){0==b.circleJoinData.length&&0==b.employeesJoinData.length?e.alert("部门或者员工至少选择一个"):b.getLocationResultExcel()}),a.on("click",".j-select-circle",function(){b.getAllCircleInfos()}),a.on("click",".j-select-employee",function(){b.getAllShortEmployees()}),a.on("click",".j-circle-warp .j-select-clear",function(){var a=$(this).closest(".rwarp").find(".circle-warp");b.circleJoinData=[],a.hide(),$(this).hide()}),a.on("click",".j-employees-warp .j-select-clear",function(){var a=$(this).closest(".rwarp").find(".circle-warp");b.employeesJoinData=[],a.hide(),$(this).hide()}),a.on("click",".circle-warp b",function(){var a=$(this).closest("dd"),c=$(this).closest(".circle-warp"),d=$(this).closest(".rwarp").find(".j-select-clear"),f=a.data("id"),g=a.data("type");"c"==g?b.circleJoinData=e.excludeDataByKey(f,"id",b.circleJoinData):b.employeesJoinData=e.excludeDataByKey(f,"id",b.employeesJoinData),a.remove(),""==c.html()&&(c.hide(),d.hide())}),a.on("click",".locationmanages-downbtn",function(a){var b=$(a.currentTarget);e.confirm("是否要保存签到统计报表","提示",function(){window.open(b.attr("href")),b.hide()},{onCancel:function(){b.hide()}}),a.preventDefault()})},getAllShortEmployees:function(){var a=this;e.api({url:"/Management/GetAllShortEmployees",type:"get",dataType:"json",data:{},success:function(b){var c=b.value;b.success&&(_.each(c,function(a){a.id=a.employeeID}),a.allEmployeesData=c,a.modifyEmployeesDialog())}})},getAllCircleInfos:function(){var a=this;e.api({url:"/Management/GetAllCircleInfos",type:"get",dataType:"json",data:{},success:function(b){b.success&&(a.allCircleData=b.value,a.modifyCircleDialog())}})},renderEmployeesDialog:function(){this.employeesDialog=new h({unjoinLabel:"未选员工",joinLabel:"已选员工",unit:"项",bbarUnit:"个员工",inputPlaceholder:"输入关键词，快速筛选员工",unjoinEmptyTip:"没有未选员工",unjoinSearchEmptyTip:"没有筛选条件为{{keyword}}的员工",joinEmptyTip:"没有已选员工",joinSearchEmptyTip:"没有筛选条件为{{keyword}}的员工"}).render(),this.employeesDialog.setTitle("选择员工"),this.employeesJoinData=[]},renderCircleDialog:function(){this.circleDialog=new h({unjoinLabel:"未选部门",joinLabel:"已选部门",unit:"项",bbarUnit:"部门",inputPlaceholder:"输入关键词，快速筛选部门",unjoinEmptyTip:"没有未选部门",unjoinSearchEmptyTip:"没有筛选条件为{{keyword}}的部门",joinEmptyTip:"没有已选部门",joinSearchEmptyTip:"没有筛选条件为{{keyword}}的部门"}).render(),this.circleDialog.setTitle("选择部门"),this.circleJoinData=[]},modifyEmployeesDialog:function(){var a=this,b=this.employeesDialog,c=a.employeesJoinData,d=[];_.each(c,function(a){d.push(a.id)});var f=e.excludeDataByKey(d,"id",a.allEmployeesData);b.setInitData({joinData:c,unjoinData:f}),b.show(),b.set("successCb",function(b){a.employeesJoinData=b,this.hide(),a.showEmployeesDom()})},modifyCircleDialog:function(){var a=this,b=this.circleDialog,c=a.circleJoinData,d=[];_.each(c,function(a){d.push(a.id)});var f=e.excludeDataByKey(d,"id",a.allCircleData);f=_.reject(f,function(a){return a.isStop}),b.setInitData({joinData:c,unjoinData:f}),b.show(),b.set("successCb",function(c){a.circleJoinData=c,b.hide(),a.showCircleDom()})},showEmployeesDom:function(){var a=this.element,b=$(".j-employees-warp",a),c=$(".circle-warp",b),d=$(".j-select-clear",b),e=this.employeesJoinData,f="";$.each(e,function(a,b){f+='<dd data-id="'+b.id+'" data-type="p">'+b.name+"<b> ×</b></dd>"}),c.html(f).show(),d.show()},showCircleDom:function(){var a=this.element,b=$(".j-circle-warp",a),c=$(".circle-warp",b),d=$(".j-select-clear",b),e=this.circleJoinData,f="";$.each(e,function(a,b){f+='<dd data-id="'+b.id+'" data-type="c">'+b.name+"<b> ×</b></dd>"}),c.html(f).show(),d.show()},getLocationResultExcel:function(){var a=this.element,b=$(".locationmanages-downbtn",a),c=$(".j-locationmanages-checkbox",a),f=c.prop("checked"),g="",h="",i=/,$/gi,j=this.starttimeDs,k=this.endtimeDs,l=j.getValue(!0),m=k.getValue(!0);l=l?l.unix():0,m=m?m.add("days",1).subtract("seconds",1).unix():0,$.each(this.circleJoinData,function(a,b){g+=""+b.id+","}),$.each(this.employeesJoinData,function(a,b){h+=""+b.id+","}),e.api({url:"/Location/GetLocationResultExcel",type:"get",dataType:"json",data:{circleIDs:g.replace(i,""),employeeIDs:h.replace(i,""),startTime:l,endTime:m,isExportContent:f},beforeSend:function(){b.show().addClass("loading").html("正在生成报表，请稍后...")},success:function(a){a.success?b.attr("href",d.API_PATH+"/df/gettemp?id="+a.value+"&name=签到统计报表.xls").removeClass("loading").html("生成完毕，点击下载报表"):b.hide()}},{modal:$(".j-submit-btn",a)})},destroy:function(){}}),e.regTplNav($(".tpl-l .flag-left-list a",a),"fl-item-on")}});