/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/stream/stream",["util","moment","json","events","uilibs/tabs","dialog","modules/publish/publish","modules/fs-schedule/fs-schedule","validator","store","./stream-common","assets/zclip/1.1.1/zclip","./stream-common.html","modules/feed-list/feed-list","modules/fs-search-select/fs-search-select","modules/fs-announcement/fs-announcement","modules/fs-createremind/fs-createremind","modules/fs-worktodo/fs-worktodo","modules/fs-select-city/fs-select-city"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=a("util"),g=a("moment"),h=a("json"),i=a("events"),j=a("uilibs/tabs"),k=a("dialog"),l=a("modules/publish/publish.js"),m=a("modules/fs-schedule/fs-schedule"),n=a("validator"),o=a("store"),p=a("./stream-common"),q=a("modules/feed-list/feed-list"),r=a("modules/fs-search-select/fs-search-select"),s=a("modules/fs-announcement/fs-announcement"),t=a("modules/fs-createremind/fs-createremind"),u=a("modules/fs-worktodo/fs-worktodo"),v=a("modules/fs-select-city/fs-select-city"),w=new t,x=new v,y=l.atInput,z=l.mediaMaker,A=l.selectBar,B=l.dateSelect,C=l.timeSelect,D=l.Receipt,E=l.MyHistoryPlan,F=s.NewNoticeDialog,G=s.NoticeBanner,H=u.NewWorktodoDialog,I=p.InviteColleague,J=function(a){a=_.extend({tplEl:null,tplName:"",autoInit:!0,feedListPath:"/Feed/GetFeeds",applyFeedlistRd:{},beforeFeedListParse:function(a){return a},feedListSuccessCb:d.EMPTY_FN,addFeedCb:d.EMPTY_FN,feedlistConfig:{},reloadAfterTplSwitch:!1},a||{}),this.opts=a,this.tplEl=a.tplEl||b.tplEl,this.tplName=a.tplName||b.tplName,this.activeIndex=0,a.autoInit&&this.init()};_.extend(J.prototype,{init:function(){this.dataInit(),this.publishInit(),this.feedInit(),this.rightSideBarInit(),this.otherInit()},calMedia:function(){var a=this;if($.browser.msie&&7==document.documentMode)this.timer&&clearTimeout(this.timer),this.timer=null,this.timer=setTimeout(function(){var b=$(".media-share",a.tplEl),c=$($(".media",a.tplEl)[a.activeIndex]);hMS=b.height(),c.css("height",hMS);var d=c.position();b.css({top:d.top-36,left:d.left+1})},5);else{var b=$(".media-share",this.tplEl),c=$($(".media",this.tplEl)[this.activeIndex]);hMS=b.height(),c.css("height",hMS);var d=c.position();b.css({top:d.top-36,left:d.left+1})}},bindIptMedia:function(){var a=this,b=$(".publish-input");$(".media-share",this.tplEl),b.on("resizecomplete",function(){a.calMedia(a.activeIndex)})},dataInit:function(){var a=f.getContactData();this.contactPersonData=a.p,this.contactGroupData=a.g,this.currentUserData=a.u},atInputInit:function(){var a=this,b=$(".publish-wrapper",this.tplEl),c=$(".publish-input",b);new y({element:c}),c.keydown(function(a){27==a.keyCode&&a.preventDefault()}),e.event.on("switched",function(b){b==a.tplName&&c.trigger("autosize.resize")})},publishInit:function(){var a,b=this,d=$(".publish-wrapper",this.tplEl),e=$(".at-input",d),g=$(".media-share",d),h=f.getEnterpriseConfig(107,!0)||{};this.atInputInit(),e.click(function(){$(".fs-qx .fs-qx-tbar .hide-l").trigger("click"),$(".fs-chat-panel .fs-qx-chat-tbar .hide-l").trigger("click")}),a=new z({element:g,action:["h5imgupload","h5attachupload","vote","at","topic","customer","contacts"],actionOpts:{vote:{contactData:this.contactPersonData},at:{inputSelector:e},topic:{inputSelector:e},h5imgupload:{flashFallback:!0},h5attachupload:{flashFallback:!0}}}),a.on("filechange",function(){b.calMedia()});var i=new j({element:d,triggers:$(".fs-publish-nav",d),panels:$(".fs-publish-panel",d),activeTriggerClass:"ui-tab-item-current",activeIndex:0,triggerType:"click",withTabEffect:!0,triggerBgTop:"5px",triggerBgLeft:15,triggerBgCls:"publish-tab-trigger-wrapper"}).render();$(".media",i.get("panels")).data("media",a),d.on("click",".panel-visible-h",function(){var a=$(this),c=a.closest(".fs-publish-panel"),d=$(".fs-publish-form",c),e=$(".form-thumb",c);d.hide(),e.show(),a.hide(),b.trigger("publishhide",c),o.enabled&&o.set("lastInputFeedInfo",null),$(".media-share").hide()}).on("click",".ui-tab-item-current a",function(a){var b=i.get("panels").eq(i.get("activeIndex")),c=$(".form-thumb",b);c.click(),a.preventDefault()}).on("click",".form-thumb",function(){var a=$(this),c=a.closest(".fs-publish-panel"),d=$(".fs-publish-form",c),e=$(".panel-visible-h",c);d.show(),$(".publish-input",d).get(0).focus(),a.hide(),e.show(),b.trigger("publishshow",c),$(".media-share").show(),b.calMedia()}).on("click",".fs-publish-log-form .publish-input-wrapper fieldset",function(){$("textarea",this).get(0).focus()}),i.on("switched",function(d,e){var g=i.get("panels").eq(d),j=i.get("panels").eq(-1==e?0:e),k=$(".publish-input",g),l=3==e?$(".publish-input",j).first():$(".publish-input",j).last(),m=$(".form-thumb",g),n=g.attr("feedname"),o=$(".media",g),p=l.val();g.data("rendered")||(b[n+"Init"]&&b[n+"Init"](),g.data("rendered",!0)),m.is(":visible")&&m.click(),0==$(".media-share",o).length,"share"==g.attr("feedname")?a.showAction("vote"):a.hideAction("vote"),p.length>0?(3==d?k.first():k.last()).val(p).keyup().change():(3==d?k.first():k.last()).val("").keyup().change(),f.setCursorPositionEnd(3==d?k.first():k.last()),$(c).scrollTop(0),k.trigger("autosize.resize"),(3==d?k.first():k.last()).get(0).focus(),$(".fs-guide-send-receipt-bracket,.fs-guide-history-plan-bracket").remove(),"share"==n?!b.currentUserData.isDemoAccount&&h.IsShowReceiptTip&&0==$(".fs-guide-bracket").length&&f.showGuideTip($(".sms-wrapper",g),{leftLeftIncrement:0,rightLeftIncrement:0,imageName:"receiption.png",imagePosition:{top:"-94px",left:"20px"},renderCb:function(a,b,c,d){var e=$('<div class="fs-guide-shadow-link"></div>'),g=$('<div class="fs-guide-shadow-link"></div>'),i=function(){h.IsShowReceiptTip=!1,f.setEnterpriseConfig(107,h,!0),f.updateEnterpriseConfig(107),b.remove(),c.remove(),$(".fs-guide-history-plan-bracket").css("visibility","visible")};b.addClass("fs-guide-send-receipt-bracket"),c.addClass("fs-guide-send-receipt-bracket"),$(".fs-guide-history-plan-bracket").css("visibility","hidden"),e.css({width:"26px",height:"26px",position:"absolute",top:"9px",left:"236px",cursor:"pointer"}).appendTo(a),g.css({width:"140px",height:"32px",position:"absolute",top:"124px",left:"88px",cursor:"pointer"}).appendTo(a),e.click(function(){i()}),g.click(function(){i()}),d.one("click",function(){i()})}}):"plan"==n&&(b.currentUserData.isDemoAccount||h.IsSkipPlan||f.showGuideTip($(".show-history-plan-l",g),{leftTopIncrement:-5,rightTopIncrement:-5,rightLeftIncrement:-5,imageName:"history-plan.png",imagePosition:{top:"-160px",left:"-225px"},imagePlace:"left",renderCb:function(a,b,c,d){var e=$('<div class="fs-guide-shadow-link"></div>'),g=function(){h.IsSkipPlan=!0,f.setEnterpriseConfig(107,h,!0),f.updateEnterpriseConfig(107),b.remove(),c.remove()};b.addClass("fs-guide-history-plan-bracket"),c.addClass("fs-guide-history-plan-bracket"),e.css({width:"26px",height:"26px",position:"absolute",top:"4px",right:"24px",cursor:"pointer"}).appendTo(a),e.click(function(){g()}),d.one("click",function(){g()})}})),b.activeIndex=d,$(".media-share").show(),b.calMedia()});var k,l;o.enabled&&(l=e,l.keyup(function(){var a=$(this),c=_.str.trim(a.val()),d=a.attr("name"),e=_.extend(o.get("lastInputFeedInfo")||{},{employeeId:b.currentUserData.id});e[d]=c,o.set("lastInputFeedInfo",e)}),k=o.get("lastInputFeedInfo"),k&&k.employeeId==this.currentUserData.id?(l.filter('[name="content"]').val(k.content).keyup().change(),l.filter('[name="report"]').val(k.report).keyup().change(),l.filter('[name="plan"]').val(k.plan).keyup().change()):o.set("lastInputFeedInfo",null)),i.trigger("switched",0,-1),this.publishTabs=i,b.bindIptMedia()},getAtContent:function(a){return f.getAtFromInput(a)},groupAtContent:function(a,b){var c=this,d=[],e=[],f=[],g=[],h=$(a);return h.each(function(){d=d.concat(c.getAtContent(this))}),d.length>0&&(e=_.filter(d,function(a){return c.isExistContactData(a)?!0:(f.push(a),!1)}),_.each(e,function(a){c.isIncludeInRange(a,b)||g.push(a)})),g=_.map(g,function(a){var b,d="g";return b=c.getContactDataByName(a,"g"),b||(b=c.getContactDataByName(a,"p"),d="p"),_.extend({type:d},b)}),{noExist:f,noInclude:g,validAtContent:e}},isExistContactData:function(a){var b,c=this.contactPersonData,d=this.contactGroupData;return b=_.find(c,function(b){return b.name==a?!0:void 0}),b||(b=_.find(d,function(b){return b.name==a&&999999!=b.id?!0:void 0})),!!b},getContactDataById:function(a,b){var c="g"==b?this.contactGroupData:this.contactPersonData;return _.find(c,function(b){return b.id==a})},getContactDataByName:function(a,b){var c="g"==b?this.contactGroupData:this.contactPersonData;return _.find(c,function(b){return b.name==a})},isIncludeInRange:function(a,b){var c,d,e=this,f=(this.contactPersonData,this.contactGroupData),g=b.getSelectedData(),h=g.p||[],i=g.g||[],j=!1;return d=_.find(f,function(b){return b.name==a?!0:void 0}),d?_.find(i,function(b){return c=e.getContactDataById(b,"g"),c.name==a?j=!0:void 0}):(_.find(h,function(b){return c=e.getContactDataById(b,"p"),c.name==a?j=!0:void 0}),j||_.find(i,function(b){return c=e.getContactDataById(b,"g"),c&&_.contains(e.getContactDataByName(a,"p").groupIDs,c.id)?j=!0:void 0})),j},getPublishDefaultUser:function(a){return f.getPublishDefaultUser(a)},getPublishRange:function(a){return f.getPublishRange(a)},planInit:function(){var a,b,d=this,e=$(".publish-wrapper",this.tplEl),g=$(".fs-publish-plan",e),h=$(".publish-input",g),i=$(".publish-topic-tip",g),k=$(".send-sms",g),l=$(".publish-extend",g),m=$(".show-history-plan-l",g),o=function(){var a=b.get("activeIndex"),c=b.get("panels").eq(a),d=$(".selectbar",c).data("sb");return d},p=function(){var c,d={},e=b.get("activeIndex"),f=b.get("panels").eq(e),h=o(),i=h.getSelectedData(),j=$(".ksfw .selectbar",g).data("sb"),k=j.getSelectedData();return _.each(["report","plan","content"],function(a){var b=$('[name="'+a+'"]',g);d[a]=_.str.trim(b.val())}),d.planType=f.attr("logtype"),d.leaderID=i.p?i.p[0]:"",d.circleIDs=k.g||[],d.employeeIDs=k.p||[],d.leaderID.length>0&&d.employeeIDs.push(d.leaderID),d.fileInfos=[],c=a.getUploadValue(),_.each(c,function(a){"img"==a.uploadType?d.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&d.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),d.isSendSms=$('[name="sendSms"]',g).prop("checked"),d},q=function(){var a=!0,b=p(),c=o();return 0==b.leaderID.length&&(a=!1,$(".input-tip",c.element).click()),h.each(function(){var b=$(this),c=_.str.trim(b.val()),d=b.attr("name");return"report"==d&&c.length>2e3?(f.alert("工作总结不能超过2000字，目前已超出<em>"+(c.length-2e3)+"</em>个字"),a=!1,!1):"plan"==d&&c.length>2e3?(f.alert("工作计划不能超过2000字，目前已超出<em>"+(c.length-2e3)+"</em>个字"),a=!1,!1):"content"==d&&c.length>1e4?(f.alert("心得体会不能超过10000字，目前已超出<em>"+(c.length-1e4)+"</em>个字"),a=!1,!1):void 0}),a},r=function(){h.val("").height(50).change(),a.resetAll(),$(".fs-guide-history-plan-bracket").remove(),$(".ksfw .selectbar",g).each(function(){$(this).data("sb").removeAllItem()}),k.prop("checked",!1),i.hide(),$(".media-share").hide()},s=function(){var a=$(".ksfw .selectbar",g).data("sb");return d.groupAtContent(h,a)},t=function(){var a=p(),b=a.leaderID,c=f.getContactDataById(b,"p"),d=a.employeeIDs,e=a.circleIDs,g=e.join(",")+"|"+d.join(","),h="",i=f.getPersonalConfig("planLeaders")||[],j=f.getPersonalConfig("planEmployees")||[],k=f.getPersonalConfig("planRanges")||[];return i=_.filter(i,function(a){return a.dataID!=b}),i.unshift({dataID:b,isCircle:!1,name:c.name}),i.length>5&&i.pop(),_.each(d,function(a){var b=f.getContactDataById(a,"p");j=_.filter(j,function(b){return b.dataID!=a}),j.unshift({dataID:a,isCircle:!1,name:b.name}),j.length>5&&j.pop()}),e.length+d.length>1&&(k=_.filter(k,function(a){return a.dataIDs!=g}),_.each(e,function(a){var b=f.getContactDataById(a,"g");h+=b.name+"，"}),_.each(d,function(a){var b=f.getContactDataById(a,"p");h+=b.name+"，"}),h.length>0&&(h=h.slice(0,-1)),k.unshift({dataIDs:g,names:h}),k.length>5&&k.pop()),{planLeaders:i,planEmployees:j,planRanges:k}},u=function(){$(".selectbar",l).each(function(){var a=$(this).data("sb");a.opts.acInitData=d.getPublishDefaultUser("planLeaders")}),$(".ksfw .selectbar",g).each(function(){var a=$(this).data("sb");a.opts.acInitData=d.getPublishRange("plan")})},v=new E({inputSelector:{today:h.eq(0),tomorrow:h.eq(1),xdth:h.eq(2)}});m.click(function(a){v.show(),a.preventDefault()}),a=$(".media",g).data("media"),h.keyup(function(){var a=$(this),b=_.str.trim(a.val());a.attr("name"),/#[^\n]+?#/g.test(b)?i.slideDown(200,function(){$(c).trigger("resize")}):i.slideUp(200,function(){$(c).trigger("resize")})}),b=new j({element:l,triggers:$(".publish-extend-nav",l),panels:$(".publish-extend-panel",l),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click",triggerBgTop:"0"}).render(),b.on("switch",function(a){var c=b.get("panels").eq(a),d=c.attr("logtypetext").split(","),e=$(".publish-input-wrapper label",g).slice(0,2);e.each(function(a){var b=$(this),c=$(".logtype-text",b);c.text(d[a])}),v.set("planType",a+1)}).on("switched",function(a,c){var d,e,g=b.get("panels").eq(a),h=b.get("panels").eq(c),i=$(".selectbar",g).data("sb"),j=$(".selectbar",h).data("sb"),k=j.getSelectedData();i.removeAllItem(),k.p&&(d=k.p[0],e={id:d,name:f.getContactDataById(d,"p").name,type:"p"},i.addItem(e))}),$(".selectbar",l).each(function(){var a=d.getPublishDefaultUser("planLeaders"),b=a[0].store,c=b[0],e=[];c&&(e=[{id:c.id,name:c.value,type:"p"}]);var g=f.deepClone(d.contactPersonData);g=_.filter(g,function(a){return a.id!=d.currentUserData.id});var h=new A({element:this,data:[{title:"同事",type:"p",list:g}],title:"选择点评人",singleCked:!0,acInitData:d.getPublishDefaultUser("planLeaders"),defaultSelectedData:e,autoCompleteTitle:"请输入姓名或拼音"});$(this).data("sb",h)}),$(".ksfw .selectbar",g).each(function(){var a=new A({element:this,data:[{title:"同事",type:"p",list:d.contactPersonData},{title:"部门",type:"g",list:d.contactGroupData,unitSuffix:"个部门"}],acInitData:d.getPublishRange("plan"),title:"选择抄送范围&#8230;",autoCompleteTitle:"请输入部门或同事的名称或拼音"});$(this).data("sb",a),a.on("inputshow",function(){a.setAcInitData(d.getPublishRange("plan"))})});var w=new n({element:$(".fs-publish-log-form",g),autoSubmit:!1,checkOnSubmit:!0,onFormValidated:function(a,b){a&&_.each(b,function(a){var b=a[2];b.hasClass("publish-input")&&d.publishErrorHl(b.closest(".publish-input-wrapper"))})}});w.addItem({element:h,required:!0,display:"请输入内容"}),h.change(function(){var a=!0,b=w.query(h);h.each(function(){var b=$(this),c=_.str.trim(b.val());return c.length>0?(a=!1,!1):void 0}),b.set("required",a)}),this.on("publishhide",function(a){"plan"==a.attr("feedname")&&r()}),this.regValidator({validator:w,media:a,isValid:q,clear:r,sendPath:"/FeedPlan/SendFeedPlan",getRequestData:p,groupAt:s,getPersonalConfig:t,updateSbAcInitData:u})},approveInit:function(){var a,b,c=this,d=$(".publish-wrapper",this.tplEl),e=$(".fs-publish-approve",d),i=$(".at-input",e),k=$(".publish-topic-tip",e),l=$(".send-sms",e),m=$(".publish-extend",e),o=$(".leave",e),p=$(".baoxiao",e),q=$(".trip",e),r=$(".load",e),s=q.parents(".publish-extend-panel"),t=$(".leave-row-tpl",e).html(),u=$(".baoxiao-row-tpl",e).html(),v=$(".trip-row-tpl",e).html(),w=$(".baoxiao-summary",e),y=$(".upper-text",w),z=$(".num-text",w),D=$(".total-time-span",e),E=0,F=3,G=3,H=3,I=function(a){var b,c,d,e,g,h,i,j,k=$(a||t),l=$(".time-span-edit",k);return k.appendTo(o),g=$(".start-date-wrapper",k),b=new B({element:g,placeholder:"选择日期"}),i=$(".end-date-wrapper",k),d=new B({element:i,placeholder:"选择日期"}),h=$(".start-time-wrapper",k),c=new C({element:h,placeholder:"选择时间"}),j=$(".end-time-wrapper",k),e=new C({element:j,placeholder:"选择时间"}),b.on("change",function(){""==c.getValue()&&c.selector.select(0),l.val(f.countTime(b,c,d,e)),J()}),d.on("change",function(){""==e.getValue()&&e.selector.select(0),l.val(f.countTime(b,c,d,e)),J()}),c.on("change",function(){l.val(f.countTime(b,c,d,e)),J()}),e.on("change",function(){l.val(f.countTime(b,c,d,e)),J()}),$(".cate",o).unbind("change"),$(".cate",k).change(function(){I()}),k},J=function(){var a=$("input.time-span-edit",o),b=0;a.each(function(){var a=$(this),c=_.str.trim(a.val());c.length>0&&(c=parseFloat(c),isNaN(c)?a.val("0"):(c=parseFloat(c.toFixed(1)),b+=c,a.val(c)))}),$(".num",D).text(b.toFixed(1))},K=function(a){if(!(q.find(".trip-num-edit").length>=20)){var b,c,d,e,f,g,h,i,j=$(a||v);return j.appendTo(q),q.find(".trip-num-edit").last().val(q.find(".trip-num-edit").length),f=$(".start-date-wrapper",j),b=new B({element:f,placeholder:"选择日期"}),h=$(".end-date-wrapper",j),d=new B({element:h,placeholder:"选择日期"}),g=$(".start-time-wrapper",j),c=new C({element:g,placeholder:"选择时间"}),i=$(".end-time-wrapper",j),e=new C({element:i,placeholder:"选择时间"}),b.on("change",function(){""==c.getValue()&&c.selector.select(0)}),d.on("change",function(){""==e.getValue()&&e.selector.select(0)}),$(".trip-wrapper").bind("mousedown",function(){document.body.click()}),$(".departure-edit",q).unbind("selected"),$(".departure-edit",j).bind("selected",function(){K()}),j}},L=function(a){var b=$(a||u);return b.appendTo(p),$("input",p).unbind("change"),$("input",b).change(function(){L()}),b},M=function(){var a=b.get("activeIndex"),c=b.get("panels").eq(a),d=$(".selectbar",c).data("sb");return d},N=function(){var c,d={},f=b.get("activeIndex"),i=b.get("panels").eq(f),j=$($(".selectbar",i)[0]).data("sb"),k=j.getSelectedData(),l=$(".ksfw .selectbar",e).data("sb"),m=l.getSelectedData();if(d.content=_.str.trim($('[name="content"]',e).val()),d.approveType=i.attr("approvetype"),d.currentApproverID=k.p?k.p[0]:"",d.circleIDs=m.g||[],d.employeeIDs=m.p||[],d.currentApproverID.length>0&&d.employeeIDs.push(d.currentApproverID),d.approveDetail=[],"2"==d.approveType&&$("tbody tr",o).each(function(){var a=$(this),b=$(".start-date-wrapper input",a).val(),c=$(".start-time-wrapper input",a).val(),e=$(".end-date-wrapper input",a).val(),f=$(".end-time-wrapper input",a).val();d.approveDetail.push({reasonType:parseInt($(".cate",a).val()),reasonTypeDesc:$(".cate option:selected",a).text(),startDate:b,stopDate:e,startTime:c,stopTime:f,beginTime:b?g(b+" "+c,"YYYYMMDD HH:mm").unix():0,endTime:e?g(e+" "+f,"YYYYMMDD HH:mm").unix():0,hours:parseFloat(_.str.trim($(".time-span-edit",a).val()))})}),"3"==d.approveType&&$("tbody tr",p).each(function(){var a=$(this);d.approveDetail.push({title:_.str.trim($(".cate",a).val()),amount:parseFloat(_.str.trim($(".amount",a).val())),remark:_.str.trim($(".mark",a).val())})}),"4"==d.approveType){d.approveDetail={};var n=$(".trip-tripers",i).data("sb"),t=n.getSelectedData();d.approveDetail.memberIDs=t.p||[],d.approveDetail.memberIDs.length>0&&$.merge(d.employeeIDs,d.approveDetail.memberIDs),d.approveDetail.approveReason=s.find(".trip-reason").val(),d.approveDetail.approveBudget=parseFloat(s.find(".trip-budget").val())||0,d.approveDetail.approvePrepayments=parseFloat(s.find(".trip-advance").val())||0,d.approveDetail.items=[],$("tbody tr",q).each(function(){var a=$(this),b=$(".start-date-wrapper input",a).val(),c=$(".start-time-wrapper input",a).val(),e=$(".end-date-wrapper input",a).val(),f=$(".end-time-wrapper input",a).val();d.approveDetail.items.push({idx:$(".trip-num-edit",a).val(),startPoint:$(".departure-edit",a).text(),endPoint:$(".destination-edit",a).text(),beginDate:b,stopDate:e,beginTime:c,stopTime:f,startTime:b?g(b+" "+c,"YYYYMMDD HH:mm").unix():0,endTime:e?g(e+" "+f,"YYYYMMDD HH:mm").unix():0,vehicle:parseInt($(".vehicle",a).val()),daysNumber:parseInt(_.str.trim($(".stay-days-edit",a).val()))})})}return"5"==d.approveType&&(d.approveDetail={},d.approveDetail.reason=$(".loan-reason",r).val(),d.approveDetail.amount=parseFloat(r.find(".loan-amount").val())),"4"==d.approveType?d.approveDetail.items=_.reject(d.approveDetail.items,function(a){var b=!0;return _.find(a,function(a,c){return"idx"!=c&&a?(b=!1,!0):void 0}),b}):5!=d.approveType&&(d.approveDetail=_.reject(d.approveDetail,function(a){var b=!0;return _.find(a,function(a){return a?(b=!1,!0):void 0}),b})),d.approveDetail=h.stringify(d.approveDetail),d.fileInfos=[],c=a.getUploadValue(),_.each(c,function(a){"img"==a.uploadType?d.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&d.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),d.isSendSms=$('[name="sendSms"]',e).prop("checked"),d},O=function(){var a=!0,b=N(),c=b.approveType,d=h.parse(b.approveDetail),e=M();if(0==b.currentApproverID.length)return a=!1,$(".input-tip",e.element).click(),!1;if(b.content.length>2e3)return f.alert("发布内容不能超过2000字，目前已超出<em>"+(b.content.length-2e3)+"</em>个字"),a=!1,!1;if("2"==c&&(a=!_.find(d,function(a){return a.reasonType?0==a.beginTime?(f.alert("请假开始时间不能为空"),!0):0==a.endTime?(f.alert("请假结束时间不能为空"),!0):g.unix(a.beginTime).isAfter(g.unix(a.endTime))?(f.alert("结束时间需大于开始时间"),!0):g.unix(a.beginTime).isSame(g.unix(a.endTime))?(f.alert("结束时间需大于开始时间"),!0):a.hours?isNaN(a.hours)?(f.alert("请输入有效的请假时间"),!0):void 0:(f.alert("请输入请假时间，以小时计算"),!0):(f.alert("请假事项不能为空"),!0)})),"3"==c&&(a=!_.find(d,function(a){return a.title?a.amount?isNaN(a.amount)?(f.alert("请输入有效的报销金额"),!0):void 0:(f.alert("请输入报销金额"),!0):(f.alert("报销项名称不能为空"),!0)})),"4"==c){if(d.memberIDs.length<=0)return f.alert("请选择出差人"),a=!1,!1;if(!$.trim(d.approveReason))return f.alert("请输入出差事由"),a=!1,!1;if(d.approveBudget&&!(parseInt(d.approveBudget)>=0&&parseInt(d.approveBudget)<1e5))return f.alert("预算金额最小0元，最多不超过10万元"),a=!1,!1;if(d.approvePrepayments&&!(parseInt(d.approvePrepayments)>=0&&parseInt(d.approvePrepayments)<1e5))return f.alert("预支金额最小0元，最多不超过10万元"),a=!1,!1;a=!_.find(d.items,function(a){return a.startPoint?0==a.startTime?(f.alert("请填写行程"+a.idx+"的出发时间"),!0):a.endPoint?0==a.endTime?(f.alert("请填写行程"+a.idx+"的到达时间"),!0):g.unix(a.startTime).isAfter(g.unix(a.endTime))?(f.alert("结束时间需大于开始时间"),!0):a.vehicle?0==a.daysNumber||a.daysNumber&&!isNaN(a.daysNumber)?parseInt(a.daysNumber)>=0&&parseInt(a.daysNumber)<1e3?void 0:(f.alert("住宿天数最少0天，最多不超过1000天"),!0):(f.alert("请正确填写行程"+a.idx+"的住宿天数，只能为正整数，不住宿填0"),!0):(f.alert("请选择行程"+a.idx+"的交通工具"),!0):(f.alert("请填写行程"+a.idx+"的目的地"),!0):(f.alert("请填写行程"+a.idx+"的出发地"),!0)})}if("5"==c){if(!$.trim(d.reason))return f.alert("请输入借款事由"),a=!1,!1;if(!$.trim(d.amount))return f.alert("请输入借款金额"),a=!1,!1;if(isNaN(d.amount))return f.alert("请输入正确的借款金额"),a=!1,!1;if(!(parseInt(d.amount)>0&&parseInt(d.amount)<1e5))return f.alert("借款金额最小1元，最多不超过10万元"),a=!1,!1}return a},P=function(){for(E=0;F>E;E++)I()},Q=function(){for(E=0;G>E;E++)L()},R=function(){for(E=0;H>E;E++)K();s.find(".trip-reason").val("").trigger("autosize.resize"),s.find(".trip-budget").val(""),s.find(".trip-advance").val("")},S=function(){$(".loan-loaner",r).val(f.getCurrentEmp().name),$(".loan-reason",r).val("").trigger("autosize.resize"),$(".loan-amount",r).val("")},T=function(){i.val("").height(50),a.resetAll(),$("tbody",o).empty(),$("tbody",p).empty(),$("tbody",q).empty(),$(".num",D).text("0"),y.text(""),z.text(""),P(),Q(),R(),S(),$(".ksfw .selectbar",e).each(function(){$(this).data("sb").removeAllItem()}),$(".trip-tripers",e).data("sb").removeAllItem(),$(".trip-tripers",e).data("sb").addItem({id:f.getCurrentEmp().id,name:f.getCurrentEmp().name,type:"p"}),l.prop("checked",!1),k.hide()},U=function(){var a=$(".ksfw .selectbar",e).data("sb");return c.groupAtContent(i,a)},V=function(){var a=N(),b=a.currentApproverID,c=f.getContactDataById(b,"p"),d=a.employeeIDs,e=a.circleIDs,g=e.join(",")+"|"+d.join(","),h="",i=f.getPersonalConfig("approveApprovers")||[],j=f.getPersonalConfig("approveEmployees")||[],k=f.getPersonalConfig("approveRanges")||[];return i=_.filter(i,function(a){return a.dataID!=b}),i.unshift({dataID:b,isCircle:!1,name:c.name}),i.length>5&&i.pop(),_.each(d,function(a){var b=f.getContactDataById(a,"p");j=_.filter(j,function(b){return b.dataID!=a}),j.unshift({dataID:a,isCircle:!1,name:b.name}),j.length>5&&j.pop()}),e.length+d.length>1&&(k=_.filter(k,function(a){return a.dataIDs!=g}),_.each(e,function(a){var b=f.getContactDataById(a,"g");h+=b.name+"，"}),_.each(d,function(a){var b=f.getContactDataById(a,"p");h+=b.name+"，"}),h.length>0&&(h=h.slice(0,-1)),k.unshift({dataIDs:g,names:h}),k.length>5&&k.pop()),{approveApprovers:i,approveEmployees:j,approveRanges:k}},W=function(){$(".selectbar",m).each(function(){var a=$(this).data("sb");a.opts.acInitData=c.getPublishDefaultUser("approveApprovers")}),$(".ksfw .selectbar",e).each(function(){var a=$(this).data("sb");a.opts.acInitData=c.getPublishRange("approve")})};P(),Q(),R(),S(),o.on("change","input.time-span-edit",function(){var a=$("input.time-span-edit",o),b=0;a.each(function(){var a=$(this),c=_.str.trim(a.val());c.length>0&&(c=parseFloat(c),isNaN(c)?a.val("0"):(c=parseFloat(c.toFixed(1)),b+=c,a.val(c)))}),$(".num",D).text(b.toFixed(1))}),p.on("change","input.amount",function(){var a=$("input.amount",p),b=0;a.each(function(){var a=$(this),c=_.str.trim(a.val());c.length>0&&(c=parseFloat(c),isNaN(c)?a.val("非有效数字"):(c=parseFloat(c.toFixed(2)),b+=c,a.val(c.toFixed(2))))}),b=parseFloat(b.toFixed(2)),y.text(f.digitUppercase(b)),z.text(b.toFixed(2))}),q.on("change","input.stay-days-edit",function(){var a=$(this),b=_.str.trim(a.val());b.length>0&&(b=parseFloat(b),isNaN(b)?a.val(""):(b=parseFloat(b.toFixed(2)),a.val(b.toFixed(0))))}),s.find(".trip-reason").on("change",function(){s.find(".trip-reason").trigger("autosize.resize")}),q.on("click",".departure-edit, .destination-edit",function(){x.show($(this))}),s.on("change","input.trip-budget, input.trip-advance",function(){var a=$(this),b=_.str.trim(a.val());b.length>0&&(b=parseFloat(b),isNaN(b)?a.val(""):(b=parseFloat(b.toFixed(2)),a.val(b.toFixed(2))))}),r.on("change","input.loan-amount",function(){var a=$(this),b=_.str.trim(a.val());b.length>0&&(b=parseFloat(b),isNaN(b)?a.val(""):(b=parseFloat(b.toFixed(2)),a.val(b.toFixed(2))))}),r.find(".loan-reason").on("change",function(){r.find(".loan-reason").trigger("autosize.resize")}),a=$(".media",e).data("media"),i.keyup(function(){$(this);var a=_.str.trim($(this).val());/#[^\n]+?#/g.test(a)?k.slideDown(200):k.slideUp(200)}),e.on("keydown",".baoxiao-wrapper input,.leave-wrapper input",function(a){13==a.keyCode&&(a.preventDefault(),a.stopPropagation())}),b=new j({element:m,triggers:$(".publish-extend-nav",m),panels:$(".publish-extend-panel",m),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click",triggerBgTop:"0"}).render(),b.on("switched",function(a,c){var d,e,g=b.get("panels").eq(a),h=b.get("panels").eq(c),i=$(".selectbar",g).data("sb"),j=$(".selectbar",h).data("sb"),k=j.getSelectedData();i.removeAllItem(),k.p&&(d=k.p[0],e={id:d,name:f.getContactDataById(d,"p").name,type:"p"},i.addItem(e))}),$(".selectbar",m).each(function(){var a=$(this),b=a.hasClass("trip-tripers");if(b){j=[{id:f.getCurrentEmp().id,name:f.getCurrentEmp().name,type:"p"}];var d=f.deepClone(c.contactPersonData),e=new A({element:this,data:[{title:"同事",type:"p",list:d}],singleCked:!1,acInitData:g,defaultSelectedData:j,title:"选择出差人",autoCompleteTitle:"请输入姓名或拼音"});a.data("sb",e)}else{var g=c.getPublishDefaultUser("approveApprovers"),h=g[0].store,i=h[0],j=[];i&&(j=[{id:i.id,name:i.value,type:"p"}]);var d=f.deepClone(c.contactPersonData);d=_.filter(d,function(a){return a.id!=c.currentUserData.id});var e=new A({element:this,data:[{title:"同事",type:"p",list:d}],singleCked:!0,acInitData:g,defaultSelectedData:j,title:"选择审批人",autoCompleteTitle:"请输入姓名或拼音"});a.data("sb",e)}}),$(".ksfw .selectbar",e).each(function(){var a=new A({element:this,data:[{title:"同事",type:"p",list:c.contactPersonData},{title:"部门",type:"g",list:c.contactGroupData,unitSuffix:"个部门"}],acInitData:c.getPublishRange("approve"),title:"选择抄送范围&#8230;",autoCompleteTitle:"请输入部门或同事的名称或拼音"});$(this).data("sb",a)});var X=new n({element:$(".fs-publish-approve-form",e),autoSubmit:!1,checkOnSubmit:!0,onFormValidated:function(a,b){a&&_.each(b,function(a){var b=a[2];b.hasClass("publish-input")&&c.publishErrorHl(b.closest(".publish-input-wrapper"))})}});X.addItem({element:$('[name="content"]',e),required:!0,errormessageRequired:""}),this.on("publishhide",function(a){"approve"==a.attr("feedname")&&T()}),this.regValidator({validator:X,media:a,isValid:O,clear:T,sendPath:"/FeedApprove/SendFeedApprove",getRequestData:N,groupAt:U,getPersonalConfig:V,updateSbAcInitData:W})},workInit:function(){var a,b,c,d=this,e=$(".publish-wrapper",this.tplEl),h=$(".fs-publish-work",e),i=$(".publish-input",h),j=$(".publish-topic-tip",h),k=$(".send-sms",h),l=$(".publish-extend",h),m=$(".sms-warn-counts",h),o=$(".sms-warn-list",h),p=$(".sms-warn-tpl",h).html(),q=$(".task-complete-datetime",h),r=$(".date-select-wrapper",q),s=$(".time-select-wrapper",q);b=new B({element:r,placeholder:"请选择日期",formatStr:"YYYY年MM月DD日（dddd）"}),c=new C({element:s,placeholder:"请选择时间"}),b.on("change",function(){""==c.getValue()&&""!=b.getValue()&&c.selector.select(0)});var t=function(a,b){var c,d,e,f,g,h;return a=a||{counts:0},b=b||p,h=_.template(b),c=$(h(a)),c.appendTo(o),d=$(".date-select-wrapper",c),e=$(".time-select-wrapper",c),f=new B({element:d,placeholder:"请选择日期",formatStr:"YYYY年MM月DD日（dddd）"}),g=new C({element:e,placeholder:"请选择时间"}),c.data("dateSelect",f),c.data("timeSelect",g),f.on("change",function(){""==g.getValue()&&""!=f.getValue()&&g.selector.select(0)}),c},u=function(){var e,f={},i=$(".selectbar",l).data("sb"),j=i.getSelectedData(),k=$(".sms-warn-list .sms-warn",h),n=$(".ksfw .selectbar",h).data("sb"),o=n.getSelectedData(),p=b.getValue(),q=c.getValue();return f.content=_.str.trim($('[name="content"]',h).val()),f.assignerID=d.currentUserData.id,f.executerID=j.p||[],f.deadline=p.length>0?g(p+" "+q,"YYYYMMDD HH:mm").unix():"",f.smsRemindType=parseInt($(":checked",m).val())+1,f.smsRemindTimes=[],k.each(function(){var a=$(this),b=a.data("dateSelect"),c=a.data("timeSelect"),d=b.getValue(),e=c.getValue();d.length>0&&f.smsRemindTimes.push({value:f.smsRemindTimes.length+1,value1:g(d+" "+e,"YYYYMMDD HH:mm").unix()})}),f.circleIDs=o.g||[],f.employeeIDs=o.p||[],f.employeeIDs=f.employeeIDs.concat(f.executerID),f.fileInfos=[],e=a.getUploadValue(),_.each(e,function(a){"img"==a.uploadType?f.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&f.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),f.isSendSms=$('[name="sendSms"]',h).prop("checked"),f},v=function(){var a,b=!0,c=u(),e=$(".selectbar",l).data("sb");return 0==c.executerID.length&&(b=!1,$(".input-wrapper",e.element).click()),c.content.length>2e3?(f.alert("发布内容不能超过2000字，目前已超出<em>"+(c.content.length-2e3)+"</em>个字"),b=!1,!1):(0==c.deadline.length&&(b=!1,a=$(".date-select-wrapper input",q),0==_.str.trim(a.val()).length&&d.publishErrorHl(a),a=$(".time-select-wrapper input",q),0==_.str.trim(a.val()).length&&d.publishErrorHl(a)),$(".sms-warn-datetime",o).filter(":visible").each(function(){var a=$(".date-select-wrapper input",this);0==_.str.trim(a.val()).length&&(d.publishErrorHl($(".date-select-wrapper input",this)),b=!1)}),b)},w=function(){i.val("").height(50),a.resetAll(),b.clear(),c.clear(),$("input",m).eq(0).click(),$(".ksfw .selectbar",h).each(function(){$(this).data("sb").removeAllItem()}),k.prop("checked",!1),j.hide()},x=function(){var a=$(".ksfw .selectbar",h).data("sb");return d.groupAtContent(i,a)},y=function(){var a=u(),b=a.executerID,c=a.employeeIDs,d=a.circleIDs,e=d.join(",")+"|"+c.join(","),g="",h=f.getPersonalConfig("workExecuters")||[],i=f.getPersonalConfig("workEmployees")||[],j=f.getPersonalConfig("workRanges")||[];return _.each(b,function(a){h=_.filter(h,function(b){return b.dataID!=a})}),_.each(b,function(a){var b=f.getContactDataById(a,"p");h.unshift({dataID:a,isCircle:!1,name:b.name})}),h.length>5&&h.pop(),_.each(c,function(a){var b=f.getContactDataById(a,"p");i=_.filter(i,function(b){return b.dataID!=a}),i.unshift({dataID:a,isCircle:!1,name:b.name}),i.length>5&&i.pop()}),d.length+c.length>1&&(j=_.filter(j,function(a){return a.dataIDs!=e}),_.each(d,function(a){var b=f.getContactDataById(a,"g");g+=b.name+"，"}),_.each(c,function(a){var b=f.getContactDataById(a,"p");g+=b.name+"，"}),g.length>0&&(g=g.slice(0,-1)),j.unshift({dataIDs:e,names:g}),j.length>5&&j.pop()),{workExecuters:h,workEmployees:i,workRanges:j}
},z=function(){$(".selectbar",l).each(function(){var a=$(this).data("sb");a.opts.acInitData=d.getPublishDefaultUser("workExecuters")}),$(".ksfw .selectbar",h).each(function(){var a=$(this).data("sb");a.opts.acInitData=d.getPublishRange("work")})};a=$(".media",h).data("media"),i.keyup(function(){$(this);var a=_.str.trim($(this).val());/#[^\n]+?#/g.test(a)?j.slideDown(200):j.slideUp(200)}),$(".selectbar",l).each(function(){var a=d.getPublishDefaultUser("workExecuters"),b=a[0].store,c=b[0],e=[];c&&(e=[{id:c.id,name:c.value,type:"p"}]);var g=f.deepClone(d.contactPersonData);g=_.filter(g,function(a){return a.id!=d.currentUserData.id});var h=new A({element:this,data:[{title:"同事",type:"p",list:g}],singleCked:!1,title:"选择执行人",acInitData:a,defaultSelectedData:e,autoCompleteTitle:"请输入姓名或拼音"});$(this).data("sb",h)}),m.on("click","input",function(){var a=$(this),b=0,c=parseInt(a.val()),d=$(".sms-warn",o),e=d.length;if(e>=c)d.slice(c).remove();else for(b=0;c-e>b;b++)t({counts:f.changeToChineseNum(b+1+e)})}),$(".ksfw .selectbar",h).each(function(){var a=new A({element:this,data:[{title:"同事",type:"p",list:d.contactPersonData},{title:"部门",type:"g",list:d.contactGroupData,unitSuffix:"个部门"}],title:"选择抄送范围&#8230;",acInitData:d.getPublishRange("work"),autoCompleteTitle:"请输入部门或同事的名称或拼音"});$(this).data("sb",a)});var D=new n({element:$(".fs-publish-work-form",h),autoSubmit:!1,checkOnSubmit:!0,onFormValidated:function(a,b){a&&_.each(b,function(a){var b=a[2];b.hasClass("publish-input")&&d.publishErrorHl(b.closest(".publish-input-wrapper"))})}});D.addItem({element:$('[name="content"]',h),required:!0,errormessageRequired:""}),this.on("publishhide",function(a){"work"==a.attr("feedname")&&w()}),this.regValidator({validator:D,media:a,isValid:v,clear:w,sendPath:"/FeedWork/BatchSendFeedWork",getRequestData:u,groupAt:x,getPersonalConfig:y,updateSbAcInitData:z})},shareInit:function(){var a,b,d=this,e=$(".publish-wrapper",this.tplEl),g=$(".fs-publish-share",e),h=$(".publish-input",g),i=$(".is-send-sms",g),j=$(".is-receipt",g),k=$(".receipt-tip",g),l=$(".send-sms-g",e),m=$(".send-sms-p",e),o=$(".publish-topic-tip",g),p=function(){var b,c,d={},e=$(".ksfw .selectbar",g).data("sb"),h=e.getSelectedData(),k=l.val(),n=m.val(),o=[],p={};return d.content=_.str.trim($('[name="content"]',g).val()),d.circleIDs=h.g||[],d.employeeIDs=h.p||[],d.isSendReceipt=j.prop("checked"),d.smsCircleIDs=k?k.split(","):[],d.smsEmployeeIDs=n?n.split(","):[],d.fileInfos=[],b=a.getUploadValue(),_.each(b,function(a){"img"==a.uploadType?d.fileInfos.push({value:2,value1:a.pathName,value2:a.size,value3:a.name}):"attach"==a.uploadType&&d.fileInfos.push({value:3,value1:a.pathName,value2:a.size,value3:a.name})}),d.isSendSms="1"==i.val()?!0:!1,d.fileInfos.length>0&&0==d.content.length&&(o=f.getAttachTypeName(d.fileInfos),o.length>0&&(d.content=o.length>2?"分享"+o.join("、"):o.length>1?"分享"+o.join("和"):"分享"+o[0])),a.isActive("vote")?(c=a.voteGetValue(),_.each(c,function(a,b){p[b]=a.value}),_.extend(d,{vote:p}),_.extend(d,{voteOptions:p.voteOptions})):d.vote=null,d},q=function(){var b=!0,c=p(),e=$(".ksfw .selectbar",g).data("sb"),i=s(),j=i.noExist,k=i.noInclude;return 0==c.content.length?(d.publishErrorHl(h.closest(".publish-input-wrapper")),!1):c.content.length>1e4?(f.alert("发布内容不能超过10000字，目前已超出<em>"+(c.content.length-1e4)+"</em>个字"),b=!1,!1):0==c.circleIDs.length&&0==c.employeeIDs.length?k.length>0?b=!0:j.length>0?(f.confirm("您通过@提到当中 "+j.join("，")+" 不是员工姓名或部门的名称，是否继续？","提示",function(a){$(".input-wrapper",e.element).click(),a.stopPropagation()},{onCancel:function(){}}),b=!1):($(".input-wrapper",e.element).click(),b=!1):(b=!0,a.isActive("vote")?b=a.voteIsValid():b)},r=function(){h.val("").height(50),a.resetAll(),$(".ksfw .selectbar",g).each(function(){$(this).data("sb").removeAllItem()}),i.val("0"),w(),j.prop("checked",!1),w(),o.hide()},s=function(){var a=$(".ksfw .selectbar",g).data("sb");return d.groupAtContent(h,a)},t=function(){var a=p(),b=a.employeeIDs,c=a.circleIDs,d=c.join(",")+"|"+b.join(","),e="",g=f.getPersonalConfig("shareEmployees")||[],h=f.getPersonalConfig("shareRanges")||[];return _.each(b,function(a){var b=f.getContactDataById(a,"p");g=_.filter(g,function(b){return b.dataID!=a}),g.unshift({dataID:a,isCircle:!1,name:b.name}),g.length>5&&g.pop()}),c.length+b.length>1&&(h=_.filter(h,function(a){return a.dataIDs!=d}),_.each(c,function(a){var b=f.getContactDataById(a,"g");e+=b.name+"，"}),_.each(b,function(a){var b=f.getContactDataById(a,"p");e+=b.name+"，"}),e.length>0&&(e=e.slice(0,-1)),h.unshift({dataIDs:d,names:e}),h.length>5&&h.pop()),{shareEmployees:g,shareRanges:h}},u=function(){var a=$(".ksfw .selectbar",g).data("sb");a.opts.acInitData=d.getPublishRange("share")},v=function(a){var c,d,e=[];_.isEmpty(a)?k.text("").hide():(c=a.g||[],d=a.p||[],c.length>0&&e.push(c.length+"个部门"),d.length>0&&e.push(d.length+"个人"),l.val(c.join(",")),m.val(d.join(",")),i.val($(".is-sms-send",b.element).prop("checked")?"1":"0"),k.text("已选择"+e.join("，")).show())},w=function(){l.val(""),m.val(""),i.val("0"),k.empty().hide()};h.keyup(function(){var a=$(this),b=_.str.trim(a.val());/#[^\n]+?#/g.test(b)?o.slideDown(200,function(){$(c).trigger("resize")}):o.slideUp(200,function(){$(c).trigger("resize")})}),a=$(".media",g).data("media"),a||(a=new z({element:$(".media",g),action:["h5imgupload","h5attachupload","vote","at","topic"],actionOpts:{vote:{contactData:this.contactPersonData},at:{inputSelector:h},topic:{inputSelector:h},h5imgupload:{flashFallback:!0},h5attachupload:{flashFallback:!0}}})),$(".ksfw .selectbar",g).each(function(){var a=new A({element:this,data:[{title:"同事",type:"p",list:d.contactPersonData},{title:"部门",type:"g",list:d.contactGroupData,unitSuffix:"个部门"}],title:"选择发送范围&#8230;",acInitData:d.getPublishRange("share"),autoCompleteTitle:"请输入部门或同事的名称或拼音"});$(this).data("sb",a)}),b=new D({inputSelector:h,rangeSb:$(".ksfw .selectbar",g).data("sb"),submitCb:function(a){v(a),this.hide()},cancelCb:function(){j.prop("checked",!1),w()}}),j.click(function(){var a=j.prop("checked");a?b.show():w()});var x=new n({element:$(".fs-publish-share-form",g),autoSubmit:!1,checkOnSubmit:!0,onFormValidated:function(a,b){a&&_.each(b,function(a){var b=a[2];b.hasClass("publish-input")&&d.publishErrorHl(b.closest(".publish-input-wrapper"))})}});x.addItem({element:$('[name="content"]',g),required:!1,errormessageRequired:""}),this.on("publishhide",function(a){"share"==a.attr("feedname")&&r()}),this.regValidator({validator:x,media:a,isValid:q,clear:r,sendPath:"/Feed/SendFeed",getRequestData:p,groupAt:s,getPersonalConfig:t,updateSbAcInitData:u,feedType:"share"})},feedInit:function(){var a=this,b=this.opts;this.searchSelect=new r({trigger:$(".search-select-btn",this.tplEl),associatedIpt:$(".search-inp",this.tplEl),selectColleague:!0,customClass:"fs-main-feed-list"});var c,g=$(".feed-list",this.tplEl),h=$(".search-inp",g),i=$(".search-btn",g),k=$(".feed-tabs",g),l=function(a){var b=$(a),c=b.data("feedList");c&&c.loadKill(),c&&c.empty()},m=function(a){0==a.get("activeIndex")?a.trigger("switched",0,-1):a.switchTo(0)},n=function(b){b.success&&"stream"==a.tplName&&a.createRightSbContent()};this.currentFeedList=null,c=new j({element:k,triggers:$(".feed-main-item",k),panels:$(".feed-main-panel",k),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click"}).render(),c.on("switched",function(e){var g,k,o,p,r,s,t=this.get("panels").eq(e),u=$(".feed-list",t),v=$(".feed-list-pagination",t),w=t.attr("feedtype"),x=t.attr("feedname");"0"==w||"1"==w||"9998"==w?(o=t.data("feedList"),p=t.attr("subtype"),"0"==w?s="您所属的部门中还没有人发言，您来发布第一个分享吧~":"1"==w?(r=function(){m(c)},s=1==p?"您所属的部门中还没有人发布过公告":"您所属的部门中还没有人发布过分享"):"9998"==w&&(s="您所属的部门中还没有人发布过CRM信息"),o?o.reload():(o=new q(_.extend({element:u,pagSelector:v,pagOpts:{pageSize:45,visiblePageNums:7},loadSize:15,withFeedRemind:!0,withLazyload:!0,listPath:b.feedListPath,beforeListParse:b.beforeFeedListParse,listEmptyText:s,listSuccessCb:function(){var a=parseInt(f.getTplStore("stream","maxFeedId")||0);o.lastMaxId>a&&(f.setTplStore("stream",{maxFeedId:o.lastMaxId}),d.circleRemind("stop"),d.circleRemind("start")),b.feedListSuccessCb&&b.feedListSuccessCb.apply(this,arguments)},searchSelect:a.searchSelect,defaultRequestData:function(){var a=b.applyFeedlistRd;return _.isFunction(a)&&(a=a(o)),_.extend({circleID:0,subType:p?p:0,feedType:w,keyword:_.str.trim(h.val())},a)},searchOpts:{inputSelector:h,btnSelector:i},feedRemindClickCb:r,itemWorktodoCb:n},b.feedlistConfig)),o.load(),t.data("feedList",o)),a.currentFeedList=o):(g=$(".feed-sub-list",t),k=g.data("subTabs"),g.data("rendered")?m(k):(k=new j({element:g,triggers:$(".feed-"+x+"-item",g),panels:$(".feed-"+x+"-panel",g),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click",withTabEffect:!1}).render().on("switched",function(d){var e,f=this.get("panels").eq(d),g=$(".feed-list",f),j=$(".feed-list-pagination",f),k=f.attr("subtype"),l=f.data("feedList");l?l.reload():("2"==w?e="您所属的部门中还没有人发布过日志":"3"==w?e="您所属的部门中还没有人发布过指令":"4"==w&&(e="您所属的部门中还没有人发布过审批"),l=new q(_.extend({element:g,pagSelector:j,pagOpts:{pageSize:45,visiblePageNums:7},loadSize:15,withFeedRemind:!0,withLazyload:!0,listPath:b.feedListPath,beforeListParse:b.beforeFeedListParse,listSuccessCb:b.feedListSuccessCb,listEmptyText:e,defaultRequestData:function(){var a=b.applyFeedlistRd;return _.isFunction(a)&&(a=a(l)),_.extend({circleID:0,subType:k,feedType:w,keyword:_.str.trim(h.val())},a)},searchSelect:a.searchSelect,searchOpts:{inputSelector:h,btnSelector:i},feedRemindClickCb:function(){m(c)},itemWorktodoCb:n},b.feedlistConfig)),l.load(),f.data("feedList",l)),a.currentFeedList=l}).on("switch",function(a,b){l(this.get("panels").eq(b))}),k.trigger("switched",0,-1),g.data("rendered",!0),g.data("subTabs",k)))}).on("switch",function(a,b){l(this.get("panels").eq(b))}),m(c);var o=!0;e.event.on("switched",function(d){d==a.tplName?(o||(a.createRightSbContent&&a.createRightSbContent(),a.schedule&&a.schedule.refreshScheduleDate(),a.currentFeedList&&a.currentFeedList.lazyload.open(),b.reloadAfterTplSwitch&&m(c)),o=!1):a.currentFeedList&&a.currentFeedList.lazyload.pause()}),i.click(function(){a.currentFeedList.pagination.reset(),a.currentFeedList.reload()}),this.feedListTabs=c},addFeedToMain:function(a){var b=this.currentFeedList,c=this.opts,d=c.addFeedCb;a=[].concat(a),_.each(a,function(a){b.unshiftFromFeedId(a)}),$(".feed-demo-wrapper",b.element).remove(),d.call(this,a)},rightSideBarInit:function(){var a=this,b=this.tplEl,d=f.getContactData(),e=d.u,h=f.getEnterpriseConfig(107,!0)||{},i=$(".home-right-content",b),j=$(".right-img-wrap",b),k=$(".right-htitle-wrap",b),l=$(".todolist-wrapper",b),n=$(".right-todolist-wrap",l),o=$(".right-votes-wrap",b),p=$(".right-fixedtopics-wrap",b),q=$(".right-newtopics-wrap",b),r=$(".fs-schedule-holder",b),s=$(".add-schedule-l",b),t=new m({element:r,scheduleDeleteCb:function(b,c){var d,e,f,g=a.currentFeedList,h=g.element;b.success&&(e=b.value,f=c.feedID,d=$('[feedid="'+f+'"]',h).closest(".list-item"),d.length>0&&d.slideUp(600))}});t.render(),this.schedule=t,s.click(function(a){t.showAddDialog(new Date),a.preventDefault()}),$(c).scroll(function(){$(c).resize().unbind("scroll",arguments.callee)});var u=function(a){var b=[];_.each(a,function(a){b.push({startDate:new Date(1e3*a.startTime),creatorId:a.creatorID})}),t.set("scheduleDate",b)},v=t.getCurrentMonthRange(),x=function(a,b){a=a||"show";var c=$(b),d=$(".worktodo-icopenoff",c),e=$(".worktodo-item-control",c),f=$(".worktodo-item",c);"show"==a?(f.show(),d.html("收起"),e.removeClass("worktodo-item-open"),e.addClass("worktodo-item-off"),c.data("status","show")):(f.hide().slice(0,10).show(),d.html("展开"),e.removeClass("worktodo-item-off"),e.addClass("worktodo-item-open"),c.data("status","hide"))},y=$(".worktodo-item-control",b);y.on("click",function(){var a=$(".worktodo-icopenoff",l),b=a.html();"展开"==b?x("show",l):x("hide",l)});var z=function(){f.api({type:"get",data:{circleID:"0",startTimeTicks:g(v.startDate).unix(),endTimeTicks:g(v.endDate).unix()},url:"/globalInfo/getShortcutInfo",success:function(a){var c,g=d.p;if(a.success){c=a.value.inCircleEmployeeIDs||[],c.length>16&&(c=c.slice(0,16)),j.empty(),_.each(c,function(a){var b=_.find(g,function(b){return b.id==a});if(b){var c=b.name,d=b.id,e=b.profileImage,f="<a href='#profile/=/empid-"+d+"' title='"+c+"'><img src='"+e+"' width='24' height='24' /></a>";j.append(f)}});var m;m=a.value.thisCircle,k.html("全部同事("+m.memberCount+')<span class="rt-apv right-yq-apv fn-hide"><a href="javascript:;" class="invite-apv fna-blue">邀请同事</a></span>'),d.u.isAdmin?($(".right-yq-apv",k).show(),!e.isDemoAccount&&h.IsShowInviteEmployeeTask&&f.showGuideTip($(".invite-apv",k),{leftTopIncrement:-5,rightTopIncrement:-5,rightLeftIncrement:-5,imageName:"invite-task.png",imagePosition:{top:"-100px",left:"-280px"},imagePlace:"left",renderCb:function(a,b,c,d){var e=$('<div class="fs-guide-shadow-link"></div>'),g=$('<div class="fs-guide-shadow-link"></div>');$(".fs-guide-group-bracket,.fs-guide-avatar-bracket,.fs-guide-send-receipt-bracket,.fs-guide-history-plan-bracket").css("visibility","hidden");var i=function(){h.IsShowInviteEmployeeTask=!1,f.setEnterpriseConfig(107,h,!0),f.updateEnterpriseConfig(107),b.remove(),c.remove(),$(".fs-guide-avatar-bracket").css("visibility","visible")};e.css({width:"26px",height:"26px",position:"absolute",top:"7px",left:"197px",cursor:"pointer"}).appendTo(a),g.css({width:"122px",height:"32px",position:"absolute",top:"129px",left:"46px",cursor:"pointer"}).appendTo(a),e.click(function(){i()}),g.click(function(){i()}),d.one("click",function(){i()})}})):$(".right-yq-apv",k).hide(),new I({trigger:$(".invite-apv",k)}).render();var r;if(r=a.value.toDoList,$(".todolist-count").text(r.length),r.length>0){n.empty(),_.each(r,function(a){var b,c,d="",f=a.creatorID,g=a.creatorName,h=a.isImportant;c=h?"color-red":"",d=f==e.id?a.title:'<span class="color-blue">'+g+"：</span>"+a.title,b="<li class='worktodo-item' worktodoid='"+a.workToDoListID+"'><input type='checkbox' class='is-complete' /><a href='#worktodo/tododetail/=/id-"+a.workToDoListID+"' class='tpl-nav-l "+c+"' title='"+a.title+"'>"+d+"</a></li>",n.append(b)});var s=$(".worktodo-icnumber",y);r.length>10?($(".worktodo-item",n).slice(0,10).show(),y.show(),s.html(r.length-10),l.data("status","hide"),x("hide",l)):($(".worktodo-item",n).show(),y.hide())}else n.html("<li class='color-999999'>无待办事项</li>");n.find(">li>input[type=checkbox]").click(function(){1==$(this).prop("checked")?$(this).next().css("text-decoration","line-through"):$(this).next().css("text-decoration","none")});var t;t=a.value.fixedTopics,t.length<1?$(".fixedtopics-wrapper").hide():$(".fixedtopics-wrapper").show(),p.empty(),_.each(t,function(a){var b,c=a.topicID;b="<li><a href='#stream/showtopic/=/id-"+c+"' class='tpl-nav-l fna-blue'>#"+a.name+"#</a><span class='rfl-li-apv color-999999'>"+a.count+"</span></li>",p.append(b)});var v;v=a.value.newTopics,v.length<1?$(".newtopics-wrapper").hide():$(".newtopics-wrapper").show(),q.empty(),_.each(v,function(a){var b,c=a.topicID;b="<li><a href='#stream/showtopic/=/id-"+c+"' class='tpl-nav-l fna-blue'>#"+a.name+"#</a><span class='rfl-li-apv color-999999'>"+a.count+"</span></li>",q.append(b)});var w;w=a.value.votes,w.length>10&&(w=w.slice(0,10)),w.length<1?$(".right-votes-title-wrap").parent().hide():$(".right-votes-title-wrap").parent().show(),o.empty(),_.each(w,function(a){var b,c=a.feedID;b="<li class='hr-vote'><a href='#stream/showfeed/=/id-"+c+"/showvotedetail-1' class='fna-blue'>"+a.title+"</a></li><li class='padL25 color-999999'>已有"+a.voteEmpCount+"人参与</li>",o.append(b)}),u(a.value.scheduleDates),f.tplRouterReg($(".tpl-nav-l",i));var z=$(".feed-remind-wrapper",b);z[0]&&$(".remind-count-num",z).html(a.value.timingMessageRemaindOfToday)}}})};z(),f.tplRouterReg("#stream/showfeed/=/:id-:value"),f.tplRouterReg("#stream/showfeed/=/:id-:value/:pn-:value"),f.tplRouterReg("#stream/showfeed/=/:id-:value/:showvotedetail-:value"),this.createRightSbContent=z,function(){var a=$(".right-todolist-wrap",b),c=$(".add-worktodo-l",b),d=function(a,b,c,d){f.api({type:"post",data:{workToDoListID:b,isCompleted:a},url:"/worktodolist/setIsCompleted",success:function(a){a.success&&c.call(this,a)}},{mask:d})};new H({trigger:c,successCb:function(){z(),this.hide()}}),a.on("change",".is-complete",function(a){var b=$(a.currentTarget),c=b.closest(".worktodo-item"),e=$(".is-complete",c),f=c.attr("worktodoid");e.prop("checked")?d(!0,f,function(){c.addClass("worktodo-state-undone")},b):d(!1,f,function(){c.removeClass("worktodo-sstate-undone")},b)}).on("mouseenter",".worktodo-item",function(a){var b=$(a.currentTarget),c=b.find(".is-complete");c.prop("checked")?c.attr("title","点击设置为未完成"):c.attr("title","点击设置为已完成")}),f.tplRouterReg("#worktodo/tododetail/=/:id-:value")}(),function(){var a=$(".feed-remind-wrapper",b),c=$(".add-remind-btn",a);c.on("click",function(){w.show()})}(),_.some(e.functionPermissions,function(a){return 1==a.value})?($(".right-notice-wrap",b).show(),new F({trigger:$(".add-notice-l",b),successCb:function(b){b.success&&(a.addFeedToMain(b.value),a.noticeBanner&&a.reRenderNoticeBanner(),this.hide())}})):$(".right-notice-wrap",b).hide()},otherInit:function(){var a=this,b=this.tplEl;f.api({type:"get",data:{},url:"/FeedAnnounce/GetAnnouncesOfIsShow",success:function(c){if(c.success){var d=c.value,e=[];d.length<1?$(".main-announcement",b).hide():(_.each(d,function(a,b){var c=a.createTime||a.isShowTime,d=a.title,f=a.feedID;e[b]='公告：<time class="color-999999">'+g.unix(c).format("MM-DD")+"</time> "+d+'（<a href="#stream/showfeed/=/id-'+f+'" class="fna-blue">详情</a>）'}),a.noticeBanner=new G({element:$(".main-announcement",b),data:e}))}}}),e.event.on("switched",function(b){b==a.tplName&&a.noticeBanner&&a.reRenderNoticeBanner()})},reRenderNoticeBanner:function(){var a=this.noticeBanner,b=this.tplEl;f.api({type:"get",data:{},url:"/FeedAnnounce/GetAnnouncesOfIsShow",success:function(c){if(c.success){var d=c.value,e=[];d.length<1?$(".main-announcement",b).hide():(_.each(d,function(a,b){var c=a.createTime||a.isShowTime,d=a.title,f=a.feedID;e[b]='公告：<time class="color-999999">'+g.unix(c).format("MM-DD")+"</time> "+d+'（<a href="#stream/showfeed/=/id-'+f+'" class="fna-blue">详情</a>）'}),a.updateData(e))}}})},publishErrorHl:function(a){var b=$(a);f.showInputError(b)},regValidator:function(a){var b=this,c=this.opts,d=c.publishCb,e=c.refreshAfterPublish,g=a.validator,h=a.media,i=a.sendPath,j=a.isValid,k=a.clear,l=a.getRequestData,m=a.groupAt,n=a.getPersonalConfig,p=a.updateSbAcInitData,q=a.feedType,r=g.element,s=$(".panel-visible-h",r.closest(".fs-publish-panel"));g.on("formValidated",function(a){if(!a&&j()){var c=m(),g=c.noExist,t=c.noInclude,u=c.validAtContent,v=l(),w=function(){h.send(function(a){var c;v=_.extend(v,{fileInfos:l().fileInfos}),"share"==q&&0==v.circleIDs.length&&1==v.employeeIDs.length&&(c=f.getContactDataById(v.employeeIDs[0],"p"),c.id!=b.currentUserData.id&&(_.contains(u,c.name)||(v.content=v.content+"\n"+"@"+c.name))),v.contactIDs=h.getContactIDs(),v.customerIDs=h.getCustomerIDs();var g=n();_.each(g,function(a,b){f.setPersonalConfig(b,a)}),p&&p(),f.updatePersonalConfig();var j=h.getCustomerConfig()||[],m=h.getContactsConfig()||[];f.setCustomerConfig(j),f.setContactsConfig(m),f.api({url:i,type:"post",data:v,success:function(c){c.success&&(c.value&&(e?b.currentFeedList&&b.currentFeedList.reload():b.addFeedToMain(c.value)),k(),s.click(),o.set("lastInputFeedInfo",null),d&&d.call(b,c,v),$(".media-share",b.tplEl).hide()),a()},error:function(){a(),f.alert("系统繁忙，请稍后重试。")}},{submitSelector:$('[type="submit"]',r)})},r.closest(".publish-wrapper"))},x=function(){var a,b=[],c=[],d=[],e=[];return _.some(v.circleIDs,function(a){return"999999"==a})?(w(),void 0):(t.length>0?(_.each(t,function(a){"p"==a.type?_.some(d,function(b){return b.id==a.id})||d.push(a):_.some(e,function(b){return b.id==a.id})||e.push(a)}),d.length>0&&(b.push(d.length+"人"),c=c.concat(_.map(d,function(a){return a.name}))),e.length>0&&(b.push(e.length+"部门"),c=c.concat(_.map(e,function(a){return a.name}))),b.length>0?(b="（共"+b.join("，")+"）",c=c.join("、")):(b="",c=""),a="您通过@提到当中 "+c+b+"不在您选择的范围中，是否要将这些人和部门包含在发布的范围当中",f.confirm(a,"提示",function(){v.employeeIDs=v.employeeIDs.concat(_.map(d,function(a){return a.id})),v.circleIDs=v.circleIDs.concat(_.map(e,function(a){return a.id})),w()},{onCancel:function(){}})):w(),void 0)},y=function(){g.length>0?f.confirm("您通过@提到当中 "+g.join(",")+"不是员工姓名或部门的名称，是否继续？","提示",function(){x()},{onCancel:function(){}}):_.some(v.circleIDs,function(a){return"999999"==a})?w():x()};-1!=v.content.search("附件")&&0==v.fileInfos.length?f.confirm("您在正文的文字中提到了“附件”，但是您却没有添加任何附件。是否确定发布不含附件的信息？","提示",function(){y()}):y()}})}}),i.mixTo(J);var K=k.extend({attrs:{width:"440px",className:"enter-demo-dialog",content:'<div class="ui-dialog-title">快速体验</div><div class="ui-dialog-body"><span>是否进入模拟体验帐号？</span></div><div class="ui-dialog-bbar fn-clear"><button type="button" class="f-sub button-submit">进入</button>&nbsp;&nbsp;<button type="button" class="f-cancel button-cancel">取消</button></div></div>'},events:{"click .f-sub":"_submit","keydown .captcha":"_keydownCaptcha","click .f-cancel":"_cancel","click .captcha-img":"_clickCaptcha"},_submit:function(a){var b=this,c=this.element,e=$(".captcha",c),g=$(".f-sub",c);_.str.trim(e.val()),this.captchaKey,f.api({type:"get",data:{},url:d.BASE_PATH+"/DemoAccount/SimpleLogin",success:function(a){var c;a.success?(c=a.data,o.set("openReturnAccount",!0),location.href=d.BASE_PATH+"/"+c):(f.alert("登录失败，"+a.error),b.updateCaptchaKey())}},{autoPrependPath:!1,submitSelector:g}),a.preventDefault(),a.stopPropagation()},_keydownCaptcha:function(a){13==a.keyCode&&this._submit(a)},_cancel:function(){this.hide()},_clickCaptcha:function(){this.updateCaptchaKey()},_clear:function(){var a=this.element,b=$(".captcha",a),c=$(".captcha-img",a);b.val(""),c.attr("src",d.BLANK_IMG)},updateCaptchaKey:function(){var a=new Date,b=this.element,c=$(".captcha-img",b);this.captchaKey=Math.ceil(a.getTime()/1e3),c.attr("src",d.BASE_PATH+"/DemoAccount/GetCodeImg?key="+this.captchaKey)},show:function(){var a=K.superclass.show.apply(this,arguments);return this.updateCaptchaKey(),a},hide:function(){var a=K.superclass.hide.apply(this,arguments);return this._clear(),a},destroy:function(){var a;return a=K.superclass.destroy.apply(this,arguments)}});b.init=function(){var a,c,e=b.tplEl,g=b.tplName,h=$(".fxiaoke-helper",e),i=$(".home-center-list",e),j=d.getAppStore("contactData"),k=j.assistentConfig,l="";k=_.filter(k,function(a){return"OpenBrowser"==a.funcCode}),k=_.sortBy(k,function(a){return a.order}),f.getContactData().u.isAdmin?($(".with-admin",h).show(),$(".without-admin",h).hide()):($(".with-admin",h).hide(),$(".without-admin",h).show()),p.init(e,g),_.each(k,function(a){l+='<li class="action-item"><a href="'+d.API_PATH+a.webUrl+'" target="_blank">'+a.displayName+"</a>"}),$(l).appendTo($(".helper-actions .action-list",h)),h.on("click",".invite-employee-l",function(a){$(".tpl-r .colleague-section .invite-apv",e).click(),a.preventDefault()}),c=new K,h.on("click",".enter-demo-l",function(a){c.show(),a.preventDefault()}),a=new J({feedListSuccessCb:function(b,c){var d=(c.feedType,c.keyword),f=a.currentFeedList;b.success&&b.value.items.length<15&&0==d.length?(i=$(".home-center-list",e),j.isDemoAccount||(h.appendTo($(".feed-list-inner",f.element)),h.show())):h.hide()}})},b.Stream=J});