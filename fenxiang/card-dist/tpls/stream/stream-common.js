/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/stream/stream-common",["util","assets/zclip/1.1.1/zclip","dialog","./stream-common.html"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.event;var f=a("util"),g=a("assets/zclip/1.1.1/zclip"),h=a("dialog"),i=a("./stream-common.html"),j=$(i),k=j.filter(".invite-apv-tpl"),l='手机或邮箱：<input type="text" class="invite-inp" /><span class="invite-inp-cerror" style="display:none;">格式错误</span>',m=h.extend({attrs:{width:"500px",className:"invite-apv-dialog",list:null,content:k.html()},tabStatus:"email",timer:null,linkText:"",createLinkStart:!1,createLinkSuc:!1,zclip:null,events:{"click .f-sub":"_submit","click .f-cancel":"_cancel","click .invite-amore-add":"_addField","click .dialog-invite-tab span":"_tabHandle","focus .invite-inp":"_inputFocus","blur .invite-inp":"_inputBlur"},_tabHandle:function(a){var b=this.element,c=$(a.target),d=c.index();return c.hasClass("cur")?!1:(c.addClass("cur").siblings().removeClass("cur"),$(".ui-dialog-text",b).hide(),$(".ui-dialog-text",b).eq(d).show(),0==d?this.tabStatus="email":(this._copy(),this.tabStatus="link",this._createLink()),void 0)},_createLink:function(){var a=this;a.createLinkStart||a.createLinkSuc||(a.createLinkStart=!0,$(".invite-link-box",this.element).html("邀请链接正在生成..."),setTimeout(function(){f.api({type:"post",url:"/Invite/GetInviteMessage",success:function(b){b.success&&(a.linkText=b.value,$(".invite-link-box",a.element).html("<span>"+a.linkText+"</span>"),a.createLinkStart=!1,a.createLinkSuc=!0)}})},300))},_copy:function(){var a=this;a.zclip||(a.zclip=new g($(".f-copy",a.element),{copy:function(){return a.createLinkSuc?a.linkText:""},beforeCopy:function(){return a.createLinkStart?(f.alert("正在生成邀请链接请稍等！"),!1):void 0},afterCopy:function(){a.createLinkSuc&&(a.timer||($(".copy-suc-tip",a.element).show(),a.timer=setTimeout(function(){$(".copy-suc-tip",a.element).hide(),clearTimeout(a.timer),a.timer=null},2e3)))}}))},_addField:function(){var a=this.element,b=$(".invite-item",a);b.last().after("<div class='invite-item'>"+l+"</div>")},_inputFocus:function(a){var b=this.element,c=$(a.target),d=$(".invite-inp",b);d.removeClass("invite-inp-on"),c.addClass("invite-inp-on"),c.removeClass("invite-inp-onerror"),c.next().hide()},_inputBlur:function(a){var b=this.element,c=$(a.target),d=$(".invite-inp",b);d.removeClass("invite-inp-on");var e=/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/,g=_.str.trim(c.val());g.length>0&&(f.isMobilePhoneNum(g)||e.test(g)||(c.addClass("invite-inp-onerror"),c.next().show()))},show:function(){var a=m.superclass.show.apply(this,arguments);return"link"==this.tabStatus&&$(".dialog-invite-tab span",this.element).eq(0).trigger("click"),a},hide:function(){var a=m.superclass.hide.apply(this,arguments);return this._clear(),a},getRequestData:function(){var a=this.element,b=$(".invite-inp",a),c=[];return b.each(function(){var a=$(this),b=_.str.trim(a.val());b.length>0&&c.push(b)}),c},isValid:function(){var a=this.element,b=!0,c=$(".invite-inp",a),d=/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/;c.val();var e=this.getRequestData();return 0==e.length?(f.alert("请输入需要邀请的员工的手机或邮箱。"),!1):(c.each(function(){var a=_.str.trim($(this).val());return a.length>0&&!f.isMobilePhoneNum(a)&&!d.test(a)?(f.alert("手机或邮箱格式不正确。"),b=!1,!1):void 0}),b)},_clear:function(){var a=this.element,b=$(".invite-inp",a),c=$(".invite-item",a);b.removeClass("invite-inp-onerror"),b.next().hide(),b.val(""),c.slice(5).remove(),this.createLinkSuc=!1,$(".invite-link-box",this.element).html("邀请链接正在生成...")},_submit:function(a){var b=this,c=$(a.target),d=this.getRequestData();this.isValid()&&d.length>0&&f.confirm("本次邀请"+d.length+"个用户","提示",function(){f.api({type:"post",url:"/Invite/InvitePerson",data:{contacts:d.join(",")},success:function(a){a.success&&b.hide()}},{submitSelector:c})},{onCancel:function(){return!1},messageType:"",width:380})},_cancel:function(){this.hide()}});b.InviteColleague=m;var n=!0,o=!0;b.init=function(a){var b=$(".tpl-l .tpl-inner",a),g=f.getContactData(),h=g.u,i=h.groupIDs,k=g.g,l=g.p,m={},p=[],q=_.template(j.filter(".stream-tpl-left").html());_.extend(m,{userName:h.name,profileImage:h.profileImage}),_.each(i,function(a){var b=_.find(k,function(b){return b.id==a});b&&p.push({groupName:b.name,groupID:b.id,cTitle:encodeURIComponent(b.name)})}),m.groups=p,m.allCompanyDefaultString=h.allCompanyDefaultString,b.html(q(m)),h.isAdmin&&!h.isDemoAccount&&0==p.length&&l.length>=5&&n&&f.showGuideTip($(".group-list",b),{leftLeftIncrement:0,rightLeftIncrement:-14,imageName:"stream-menu.png",imagePosition:{top:"-90px",left:"20px"},renderCb:function(a,b,c,e){var f=$('<div class="fs-guide-shadow-link"></div>'),g=$('<div class="fs-guide-shadow-link"></div>'),i=function(){b.remove(),c.remove(),$(".fs-guide-group-bracket").remove(),n=!1,$(".fs-guide-send-receipt-bracket").css("visibility","visible")};$(".fs-guide-send-receipt-bracket,.fs-guide-history-plan-bracket").css("visibility","hidden"),b.addClass("fs-guide-group-bracket"),c.addClass("fs-guide-group-bracket"),f.css({width:"26px",height:"26px",position:"absolute",top:"8px",left:"240px",cursor:"pointer"}).appendTo(a),g.css({width:"158px",height:"32px",position:"absolute",top:"124px",left:"83px",cursor:"pointer"}).appendTo(a),f.click(function(){i()}),g.click(function(){window.open(d.BASE_PATH+"/h/home/admin?enterprise="+h.enterpriseAccount+"&account="+h.account+"&showcircleguide=yes")}),e.click(function(){i()})}}),!h.isDemoAccount&&0==h.profileImagePath.length&&o&&f.showGuideTip($(".head-img-wrap",b),{leftLeftIncrement:0,rightLeftIncrement:-14,imageName:"avatar.png",imagePosition:{top:"-34px",left:"20px"},renderCb:function(a,b,c){var d=$('<div class="fs-guide-shadow-link"></div>'),f=$('<div class="fs-guide-shadow-link"></div>'),g=function(){b.remove(),c.remove(),$(".fs-guide-avatar-bracket").remove(),o=!1,$(".fs-guide-group-bracket").css("visibility","visible")};b.addClass("fs-guide-avatar-bracket"),c.addClass("fs-guide-avatar-bracket"),$(".fs-guide-group-bracket,.fs-guide-send-receipt-bracket,.fs-guide-history-plan-bracket").css("visibility","hidden"),d.css({width:"26px",height:"26px",position:"absolute",top:"16px",left:"200px",cursor:"pointer"}).appendTo(a),f.css({width:"140px",height:"32px",position:"absolute",top:"115px",left:"68px",cursor:"pointer"}).appendTo(a),d.click(function(){g()}),f.click(function(){e.navRouter.navigate("#settings/avatarsetting",{trigger:!0}),g()})}});var r=$(".group-list",b),s=$(".fni-dep-con",r),t=$(".left-deplist-tpl",b),u=$(".deplist-control",t);s.length>5?(s.hide(),s.slice(0,5).show(),t.show(),t.click(function(){"展开"==u.html()?(s.show(),u.html("收起")):(s.slice(5,s.length).hide(),u.html("展开"))})):(s.show(),t.hide());var v=$(".online-status-wrap",b),w=$(".online-status-drop",v),x=$(".online-status-text",v),y=$(".online-status-list",v);f.placeholder(x),v.on("mouseenter",function(){v.addClass("online-status-border")}).on("mouseleave",function(){y.is(":hidden")&&v.removeClass("online-status-border")}),w.on("click",function(a){y.toggle(),a.stopPropagation()}),y.find("a").click(function(){var a=$(this).html();x.val(a),x.attr("title",a),y.hide(),x.blur()}),f.regGlobalClick(y);var z=h.workingState||"忙碌中，请勿打扰";x.val(z).attr("title",z).blur(function(){var a=$(this).val();a!=z&&(f.api({type:"post",data:{workingState:a},url:"/Account/UpdateWorkingState",success:function(a){a.success}}),z=a,""==x.val()?x.attr("title","请输入工作状态"):x.attr("title",z))}),f.regTplNav($(".tpl-nav-lb",b)),f.tplRouterReg("#department/=/:cid-:value/:ctitle-:value"),f.tplRouterReg($(".files-nav-list .tpl-nav-lb",b)),f.autoAdjustPos(b),f.autoAdjustPos($(".tpl-r .tpl-inner",a)),function(b){var c="__FXIAOKE__LIGHTICON__",d="__FXIAOKE__LIGHTICON__SECONDS__",e=new Date,f=[e.getFullYear(),e.getMonth()+1,e.getDate()],g=b.localStorage||{getItem:function(){return 0},setItem:function(){},removeItem:function(){}},h=$(".tutorials-video-wrap .tv-btn",a),i=$(".right-qq-apv"),j=g.getItem(c),k=1*g.getItem(d),l=e.getSeconds(),m=0;j&&j==f.join("-")||(k&&k>0?m=k>l?60-(l+60)+k:60-l+k:(m=60,g.setItem(d,l)),h.addClass("tv-btn-active"),i.addClass("right-qq-apv-active"),setTimeout(function(){h.removeClass("tv-btn-active"),i.removeClass("right-qq-apv-active"),g.setItem(d,"-1"),g.setItem(c,f.join("-"))},1e3*m))}(c)}});