/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/salesclues/showsalesclue/showsalesclue",["util","modules/feed-list/feed-list","dialog","moment","uilibs/tabs2","modules/crm-salesclue-list/crm-salesclue-list.html","modules/publish/publish-helper","modules/crm-attachment-simple/crm-attachment-simple","modules/crm-attachment/crm-attachment","modules/crm-select-colleague/crm-select-colleague","modules/crm-salesclue-edit/crm-salesclue-edit","modules/crm-opportunity-salesclue-edit/crm-opportunity-salesclue-edit","modules/crm-publish/crm-publish"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.event;var f=a("util"),g=a("modules/feed-list/feed-list");a("dialog");var h=a("moment"),i=a("uilibs/tabs2");a("modules/crm-salesclue-list/crm-salesclue-list.html"),a("modules/publish/publish-helper");var j=a("modules/crm-attachment-simple/crm-attachment-simple"),k=a("modules/crm-attachment/crm-attachment"),l=a("modules/crm-select-colleague/crm-select-colleague"),m=a("modules/crm-salesclue-edit/crm-salesclue-edit"),n=a("modules/crm-opportunity-salesclue-edit/crm-opportunity-salesclue-edit"),o=a("modules/crm-publish/crm-publish"),p=function(a){a=$.extend({element:null},a||{}),this.options=a,this.$el=a.element,this.init()};$.extend(p.prototype,{init:function(){this.$el;var a=this;this._getTagsDatas(),this.setupComponent(),this.bindEvents(),this.modifyCompetitorDialog=new m({salesclueID:this.options.queryParams&&this.options.queryParams.id}),this.modifyCompetitorDialog.on("success",function(){a.refresh()}),this.modifyCompetitorDialog.v=this;var a=this,c=b.tplName;e.event.one("beforeremove",function(b){b==c&&a.destroy()})},bindEvents:function(){var a=this.$el,b=this,c=this.options.queryParams.id;f.mnEvent($(".updatesalescluesstates-select-list",a),"change",function(a){f.api({url:"/SalesClue/UpdateSalesCluesStates",type:"post",dataType:"json",data:{salesClueIDs:c,states:a},success:function(a){a.success&&(f.remind(1,"变更成功"),b.refresh())}})}),a.on("click",".crm-button-back",function(){b._backToListPage()}),a.on("click",".delete-btn",function(){b._deleteProduct()}),a.on("click",".modify-btn",function(){b.modifyCompetitorDialog.show()}),a.on("click",".canchangeowner-btn",function(){b.selectColleagueS.show()}),a.on("click",".create-opportunity-btn",function(){var a=$(this);a.is(".crm-button-state-disabled")||b.createDialog.show()}),this.selectColleagueS.on("selected",function(b){f.api({url:"/SalesClue/UpdateSalesCluesOwnerID",type:"post",dataType:"json",data:{salesClueIDs:c,ownerID:b.employeeID},success:function(c){c.success&&(f.remind(1,"变更成功"),$(".owner-name",a).text(b.name).attr("data-ownerId",b.employeeID))}})})},_getTagsDatas:function(){var a=f.getCrmData(),b=a.functionPermissions,c=f.getTagsByType(9),d=[],e=this,g=[{text:"不限",value:0}],h=[{text:"不限",value:0}];_.each(c,function(a){d.push(a),109===a.systemTagCode&&(_.each(a.options,function(a){h.push({text:a.name,value:a.fBusinessTagOptionID})}),e.marketingEventTypeFBusinessTagID=a.fBusinessTagID)}),_.extend(this,{allTags:d,competitorscale:g,competitiveness:h,functionPermissions:b})},setCrmAttachment:function(){var a=this,b=$(".crm-attachment-simple-warp",this.$el),c=this.options.queryParams.id;this.attachment||(this.attachment=new j({element:b,condition:{fbrType:8,dataID:c}})),this.attachment.render(),this.attachment.on("toAll",function(){a.tab.select("tab-files")}),this.attachment.on("uploaded",function(){a.attachmentList.reload()})},setAttachmentList:function(){var a=this,b=$(".crm-attachmentlist-simple-warp",this.$el),c=this.options.queryParams.id;this.attachmentList||(this.attachmentList=new k({element:b,condition:{fbrType:8,dataID:c}})),this.attachmentList.on("uploaded",function(){a.attachment.reload()})},setFeedList:function(){var a=$(".crm-feed-list-warp",this.$el),b=$(".feed-list-pagination",this.$el),c=$("",this.$el),d=this.options.queryParams.id;this.feedList=new g({element:a,pagSelector:b,pagOpts:{pageSize:15,visiblePageNums:3},GetBatchFilesSource:1,crmParam:{type:"salesclue",id:d},listPath:"/CrmFeed/GetFeeds",defaultRequestData:function(){return{fbrType:8,dataID:d,type:1,keyword:_.str.trim(c.val())}},listEmptyText:"暂无记录"}),this.feedList.load()},showFnBtn:function(){var a=this.$el,b=this.responseData.value,c=b.canModify,d=b.canDelete,e=b.salesClue.isCreateOpportunity,f=b.canChangeOwner;c?$(".modify-btn",a).show():$(".modify-btn",a).hide(),e?$(".create-opportunity-btn",a).text("已创建机会").addClass("crm-button-state-disabled"):$(".create-opportunity-btn",a).text("新建机会...").removeClass("crm-button-state-disabled"),d?$(".delete-btn",a).show():$(".delete-btn",a).hide(),f?$(".canchangeowner-btn",a).show():$(".canchangeowner-btn",a).hide()},render:function(){var a=this.$el,b=this.responseData.value.salesClue||{},c=b.fBusinessTagRelations,d="";switch(_.each(c,function(a){var b=a.fBusinessTagName,c=a.fBusinessTagOptionName;d+='<li class="fn-clear"><span class="input-tip">'+b+'</span><div class="input-wrapper">'+c+"</div></li>"}),$(".hd-titname",a).text(b.name+" "+b.company),$(".marketing-ownername",a).text(b.owner.name),$(".marketing-createtime",a).text(h.unix(b.createTime).format("YYYY年MMMDD日 HH:mm")),$(".marketing-lasteditemployeename",a).text(b.lastEditEmployee.name),$(".marketing-lastedittime",a).text(h.unix(b.lastEditTime).format("YYYY年MMMDD日 HH:mm")),$(".marketing-name",a).text(b.name),$(".marketing-company",a).text(b.company),b.states){case 1:b.states="未处理";break;case 2:b.states="已联系";break;case 3:b.states="关闭"}$(".marketing-states",a).text(b.states),$(".updatesalescluesstates-select-list .mn-select-title",a).text(b.states),f.mnSetter($(".mn-radio-box",a),b.gender),$(".marketing-post",a).text(b.post),$(".marketing-tel",a).text(b.tel),$(".marketing-mobile",a).text(b.mobile),$(".marketing-email",a).text(b.email),$(".marketing-province",a).text(b.province),$(".marketing-weibo",a).text(b.weibo),$(".marketing-wechat",a).text(b.weChat),$(".marketing-address",a).text(b.address),$(".marketing-postcode",a).text(b.postCode),$(".marketing-qq",a).text(b.qq),$(".marketing-description",a).text(b.description),$(".product-fbusinesstagrelations",a).html(d),this.createDialog=new n({salesClueID:b.salesClueID,customerName:b.company||"",contactName:b.name||""}),this.createDialog.v=this,this.showFnBtn()},load:function(){this.$el;var a=this.options.queryParams.id,b=this;f.api({url:"/SalesClue/GetSalesClueDetailByID",type:"get",dataType:"json",data:{salesClueID:a,attachNum:6},success:function(a){a.success?(b.responseData=a,b.render(),b.setCrmAttachment(),b.setAttachmentList()):f.alert(a.message,function(){b._backToListPage()},{zIndex:3e3})}},{errorAlertModel:"1"})},refresh:function(){this.load()},_backToListPage:function(){var a=f.getTplQueryParams2();e.navRouter.navigate(a.returnUrl,{trigger:!0}),e.event.trigger("dataUpdate")},_deleteProduct:function(){var a=this,b=this.responseData.value.salesClue.salesClueID;f.confirm("你确定要删除该销售线索吗？删除后将不可恢复。","",function(){f.api({url:"/SalesClue/DeleteSalesClues",type:"post",dataType:"json",data:{salesClueIDs:b},success:function(b){if(b.success){var c=b.value.result,d=c[0],e=d.value1,g=d.value2;e?a._backToListPage():f.alert("删除失败，原因："+g)}}})})},setPublish:function(){var a=this,b=this.$el,c=this.options.queryParams.id;this.feedpublish=new o({element:$(".feed-submit-box-warp",b),title:"新建线索记录",placeholder:"发布新线索记录",type:"feed",condition:{fileInfos:[],feedContent:"",fbrType:8,dataID:c},display:["picture","attach","at","topic"]}),this.feedpublish.on("post",function(){a.feedList.load()})},setupComponent:function(){var a=$(".tab-menu",this.$el);this.tab=new i({element:a,container:this.$el,items:[{value:"tab-time-line",text:"时间线"},{value:"tab-base-info",text:"基本信息"},{value:"tab-files",text:"附件"}]}),this.selectColleagueS=new l({isMultiSelect:!1,title:"请选择负责人"}),this.setPublish(),this.setFeedList()},destroy:function(){this.feedpublish&&this.feedpublish.destroy()}}),b.init=function(){var a=b.tplEl;b.tplName;var c=f.getTplQueryParams2(),d=new p({element:a,queryParams:c});d.load()}});