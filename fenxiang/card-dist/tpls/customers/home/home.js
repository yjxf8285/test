/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/customers/home/home",["util","modules/crm-list-header/crm-list-header","modules/crm-customer-list/crm-customer-list","modules/crm-subordinate-select/crm-subordinate-select","modules/crm-high-seas/crm-high-seas"],function(a,b){var c=window,d=c.FS,e=d.tpl,f=e.event;e.store,e.list;var g,h,i,j=a("util"),k=a("modules/crm-list-header/crm-list-header"),l=a("modules/crm-customer-list/crm-customer-list"),m=a("modules/crm-subordinate-select/crm-subordinate-select"),n=a("modules/crm-high-seas/crm-high-seas");b.init=function(){function a(a){var b=$(".crm-list-left-nav li a",c);if(a&&a.employeeID&&a.employeeName&&a.employeeID!=j.getCurrentEmp().employeeID){$(".employee-name",b).text(a.employeeName);var d=c.find("a.state-active").children(".employee-name").text()+c.find("a.state-active").children().last().text();i.setTitle(d)}else $(".employee-name",b).text("我")}var c=b.tplEl,f=e.event,o=$(".crm-tpl-l .tpl-inner",c);g=b.tplName;var p=null,q=$(".crm-list-left-nav",c),r=$(".customer-list-warp",c);h=new l({warpEl:r,url:"/FCustomer/GetFCustomers"}),i=new k({element:$(".crm-list-hd",c),title:"我的客户",searchPlaceholder:"搜索客户、客户编号"}),i.on("search",function(a){h.refresh({keyword:a,isFirstChar:!1})}),p||(p=new n({api:"/HighSeas/GetMyHighSeas",navClass:".crm-high-sea-mine",canCreate:!1,url:"#customers/highseas/"}),f.on("deleteHighSeasSuccess",function(){p.refresh()})),o.on("click",".crm-high-sea-mine",function(a){p.show(a),a.preventDefault(),a.stopPropagation()});var s=d.getAppStore("contactData").currentMember,t=d.getAppStore("contactData").isAllowExportData,u=s.employeeID;t?$(".customer-export",c).show():$(".customer-export",c).hide();var v=new m({element:$(".customers-img-wrap",c),employeeName:s.name,imageSrc:j.getAvatarLink(s.profileImage,"2"),canSelect:s.subEmployees?!0:!1});v.on("selected",function(b){h.options.data.employeeID=b.employeeID,u==b.employeeID?($(".top-fn-btns",c).show(),$(".employee-name",q).text("我"),i.setTitle("我的客户"),$(".crm-high-sea-mine",c).show()):($(".top-fn-btns",c).hide(),$(".employee-name",q).text(b.name),i.setTitle(b.name+"的客户"),$(".crm-high-sea-mine",c).hide()),h&&h.refresh({employeeID:b.employeeID,listTagOptionID:"1,0",keyword:"",isFirstChar:!1,queryType:2,sortType:1,employeeName:b.name,profileImage:b.profileImage}),h&&h.reSetMnselect(),h&&h.selectFilterbar&&h.selectFilterbar.reSet(),e.navRouter.navigate("#customers/home"),$(".crm-list-left-nav li a",c).removeClass("state-active").eq(1).addClass("state-active"),a({employeeID:b.employeeID,employeeName:b.name,profileImage:b.profileImage})});var w,x,y;w=j.getTplQueryParams2(),x=w&&w.queryType?w.queryType:2,4==x?($(".top-fn-btns",c).hide(),$(".crm-list-left-nav li a",c).eq(0).addClass("state-active")):2==x?($(".top-fn-btns",c).show(),$(".crm-list-left-nav li a",c).eq(1).addClass("state-active")):3==x?($(".top-fn-btns",c).hide(),$(".crm-list-left-nav li a",c).eq(2).addClass("state-active")):$(".top-fn-btns",c).show(),y={employeeID:u,pageSize:10,queryType:parseFloat(x)},a(),w&&w.t&&(new Date).getTime()-parseFloat(w.t)<1e3?h.refresh(y,x):h&&h.refresh(y,x)},f.on("switched",function(a,b){var c,d,e;if(a==g){if(c=j.getTplQueryParams2(),c&&c.id)return;d=c&&c.queryType||2,e={queryType:parseFloat(d),listTagOptionID:"1,0",keyword:"",isFirstChar:!1,sortType:1,pageSize:10,pageNumber:1};var f=$(".crm-list-left-nav .state-active");$(".crm-list-left-nav li a",b).removeClass("state-active"),4==d?($(".top-fn-btns",b).hide(),$(".crm-list-left-nav li a",b).eq(0).addClass("state-active")):2==d?("我"==f.find(".employee-name").text()?$(".top-fn-btns",b).show():$(".top-fn-btns",b).hide(),$(".crm-list-left-nav li a",b).eq(1).addClass("state-active")):3==d?($(".top-fn-btns",b).hide(),$(".crm-list-left-nav li a",b).eq(2).addClass("state-active")):$(".top-fn-btns",b).show(),i.setTitle($(".crm-list-left-nav .state-active").text()+j.addListTitle($(".crm-list-left-nav .state-active").text(),"客户",2)),i.clearSearch(),h&&h.refresh(e),h&&h.reSetMnselect(),h&&h.selectFilterbar&&h.selectFilterbar.reSet()}})});