/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/customers/showcustomer/showcustomer",["util","uilibs/search-box","uilibs/tabs2","modules/crm-attachment/crm-attachment","modules/crm-select-colleague/crm-select-colleague","modules/crm-customerinsetting-edit/crm-customerinsetting-edit","modules/crm-customer-timeline/crm-customer-timeline","modules/crm-customer-baseinfo/crm-customer-baseinfo","modules/crm-contract-edit/crm-contract-edit","modules/crm-contact-edit/crm-contact-edit","modules/crm-contact-view/crm-contact-view","modules/crm-select-contacts/crm-select-contacts","modules/crm-opportunity-edit/crm-opportunity-edit","modules/crm-productinopp-edit/crm-productinopp-edit","modules/crm-detaillists/crm-detaillists","moment","modules/crm-contact-operation/crm-contact-operation"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.store,e.list;var f=a("util"),g=(a("uilibs/search-box"),a("uilibs/tabs2")),h=a("modules/crm-attachment/crm-attachment"),i=a("modules/crm-select-colleague/crm-select-colleague"),j=a("modules/crm-customerinsetting-edit/crm-customerinsetting-edit"),k=a("modules/crm-customer-timeline/crm-customer-timeline"),l=a("modules/crm-customer-baseinfo/crm-customer-baseinfo"),m=a("modules/crm-contract-edit/crm-contract-edit"),n=a("modules/crm-contact-edit/crm-contact-edit"),o=(a("modules/crm-contact-view/crm-contact-view"),a("modules/crm-select-contacts/crm-select-contacts")),p=a("modules/crm-opportunity-edit/crm-opportunity-edit"),q=a("modules/crm-productinopp-edit/crm-productinopp-edit"),r=a("modules/crm-detaillists/crm-detaillists"),s=a("moment"),t=a("modules/crm-contact-operation/crm-contact-operation"),u=function(a){a=$.extend({element:null},a||{}),this.options=a,this.$el=a.element,this.init()};b.init=function(){new u({element:b.tplEl})},$.extend(u.prototype,{init:function(){var a,c=this.options.element,u=b.tplName,v=$(".customer-status-select",c),w=$(".tab-time-line-box",c),x=$(".tab-base-info-box",c);$(".tab-contacts-box",c);var y=f.getTplQueryParams2(),z=Backbone.View.extend({el:c,events:{"click .customer-to-follow-btn":"_switchFollow","click .crm-button-back":"_pageBack","click .customers-edit-btn":"_editCustomer","click .customers-chg-respo-btn":"_chgResp","click .customer-detail-resp":"_chgResp"},initialize:function(){this._getCustomerTagsDatas(),this.render(),this.myID=y.id},destroy:function(){this.timeline&&this.timeline.destroy(),this.contactsDialog&&this.contactsDialog.destroy(),this.editDialog&&this.editDialog.destroy(),this.selectColleague&&this.selectColleague.destroy(),this.selectColleague&&this.selectColleague.destroy()},render:function(){this.loadCustomerData()},_detaillistContacts:function(){var a=this,b=this,c=this.$el,d=!1,e=" ",g=this.options.customerData.value.FCustomer.owner.employeeID||0,h='没有联系人，立即<a href="javascript:;" class="table-add-btn">新建</a>或<a href="javascript:;" class="table-modify-btn">选择已有</a> ';g==this.currentEmpID?(d=!0,e="操作 ∨",h='没有联系人，立即<a href="javascript:;" class="table-add-btn">新建</a>或<a href="javascript:;" class="table-modify-btn">选择已有</a> '):(d=!0,e="操作 ∨",h='没有联系人，立即<a href="javascript:;" class="table-add-btn">新建</a>'),this.detaillistContacts=new r({warpEl:$(".tab-contacts-box",c),title:"联系人",operation:d,rightTopBTnText:e,operationClass:"table-operation-btn",url:"/FCustomer/GetContactsByCustomerID",data:{customerID:a.myID},hideAddBtn:!0,emptyStr:h,jDatas:"Contacts",thDatas:["姓名","联系方式","职务","部门","公司","操作"],aoColumnsData:[{mData:"name",sWidth:"200px",sClass:"text-black",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"firstContactWay",sWidth:"120px",sClass:"",bSortable:!1,mRender:function(a){var b=a.typeDesc,c=a.content;c&&(c="："+c);var d='<span title="'+b+c+'">'+b+c+"</span>";return d}},{mData:"post",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"department",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"company",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"blank",sWidth:"200px",bSortable:!1,mRender:function(){var a='<a href="javascript:;" class="table-del-btn">取消关联</a>';return a}},{mData:"blank",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}]}),this.detaillistContacts.on("del",function(a){var c=this;f.confirm("你确定要将联系人"+a.name+"从客户"+a.customerName+"下移除吗？","",function(){f.api({url:"/Contact/UnCombineContactAndFCustomer",type:"post",dataType:"json",data:{contactID:a.contactID},success:function(a){a.success&&(c.refresh(),b.refresh())}})})}),this.detaillistContacts.on("add",function(){a.addContactDialog.show({customerID:y.id,customerName:b.options.customerData.value.FCustomer.name||b.options.customerData.value.FCustomer.customerName})}),this.detaillistContacts.on("modify",function(){b.contactsDialog.show()}),this.detaillistContacts.on("tr",function(b){a.editContactDialog.show({contactID:b.contactID})})},_detaillistOpp:function(){var a=this,b=this,c=this.$el;this.detaillistOpp=new r({warpEl:$(".tab-opp-box",c),title:"机会",url:"/SalesOpportunity/GetSalesOpportunitysByCustomerID",data:{customerID:a.myID},emptyStr:"当前客户下没有获取到机会",jDatas:"salesOpportunitys",thDatas:["名称","负责人","状态","金额","预计成交日期","销售阶段","赢率","操作"],aoColumnsData:[{mData:"name",sWidth:"100px",sClass:"text-black",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"owner",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a.name+'">'+a.name+"</span>";return b}},{mData:"statesDesc",sWidth:"30px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"expectedSalesAmount",sWidth:"90px",bSortable:!1,mRender:function(a){a=_.str.numberFormat(parseFloat(a),2);var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"expectedDealTime",sWidth:"60px",sClass:"crmtable-sort-expecteddealtime",bSortable:!1,mRender:function(a){var b='<span title="'+s.unix(a).format("YYYY-MM-DD")+'">'+s.unix(a).format("YYYY-MM-DD")+"</span>";return b}},{mData:"salesStage",sWidth:"90px",sClass:"crmtable-sort-salesstage",bSortable:!1,mRender:function(a){var b='<span title="'+a.name+'">'+a.name+"</span>";return b}},{mData:"salesStage",sWidth:"30px",sClass:"",bSortable:!1,mRender:function(a){var b='<span title="'+a.name.winRate+'%">'+a.winRate+"%</span>";return b}},{mData:"blank",sWidth:"50px",bSortable:!1,mRender:function(){var a='<a href="javascript:;" class="table-modify-btn">编辑</a> <a href="javascript:;" class="table-del-btn">删除</a>';return a}},{mData:"blank",sClass:"th-blank",sWidth:"10px",bSortable:!1,mRender:function(){var a="";return a}}]}),this.detaillistOpp.on("add",function(){a.myID,b.addOppDialog.show()}),this.detaillistOpp.on("tr",function(a){var b=a.salesOpportunityID||0;encodeURIComponent("/")+"customers"+encodeURIComponent("/")+"showcustomer";var c=window.location.href.split("#")[1],d={id:b};d=_.extend({},f.getTplQueryParams2(),d),d.returnUrl=c,e.navRouter.navigate("#opportunities/showopportunity/=/param-"+encodeURIComponent(JSON.stringify(d)),{trigger:!0})}),this.detaillistOpp.on("modify",function(a){b.modifyOppDialog.show({salesOpportunityID:a.salesOpportunityID})}),this.detaillistOpp.on("del",function(a){var b=this;f.confirm("你确定要删除该机会吗？","",function(){f.api({url:"/SalesOpportunity/DeleteSalesOpportunitys",type:"post",dataType:"json",data:{salesOpportunityIDs:a.salesOpportunityID},success:function(a){a.success&&(a.value.result[0].value1?b.refresh():f.alert("删除销售机会失败，原因："+a.value.result[0].value2))}})})})},_detaillistContracts:function(){var a=this,b=this,c=this.$el;this.detaillistContracts=new r({warpEl:$(".tab-contract-box",c),title:"合同",url:"/Contract/GetContractsByCustomerID",data:{customerID:a.myID},emptyStr:"当前客户下没有获取到合同",jDatas:"hContractEntity",thDatas:["标题","合同编号","状态","开始日期","结束日期","操作"],aoColumnsData:[{mData:"title",sWidth:"200px",sClass:"text-black",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"contractNO",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"statesDesc",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"beginDate",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+s.unix(a).format("YYYY-MM-DD")+'">'+s.unix(a).format("YYYY-MM-DD")+"</span>";return b}},{mData:"endDate",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+s.unix(a).format("YYYY-MM-DD")+'">'+s.unix(a).format("YYYY-MM-DD")+"</span>";return b}},{mData:"blank",sWidth:"200px",bSortable:!1,mRender:function(){var a='<a href="javascript:;" class="table-modify-btn">编辑</a> <a href="javascript:;" class="table-del-btn">删除</a>';return a}},{mData:"blank",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}]}),this.detaillistContracts.on("add",function(){a.myID,b.addContractDialog.show()}),this.detaillistContracts.on("modify",function(a){b.modifyContractDialog.show({contractID:a.contractID})}),this.detaillistContracts.on("tr",function(a){var b=a.contractID||0;encodeURIComponent("/")+"customers"+encodeURIComponent("/")+"showcustomer";var c=window.location.href.split("#")[1],d={id:b};d=_.extend({},f.getTplQueryParams2(),d),d.returnUrl=c,e.navRouter.navigate("#contracts/showcontract/=/param-"+encodeURIComponent(JSON.stringify(d)),{trigger:!0})}),this.detaillistContracts.on("del",function(a){var b=this;f.confirm("你确定要删除该合同吗？","",function(){f.api({url:"/Contract/DeleteContracts",type:"post",dataType:"json",data:{contractIDs:a.contractID},success:function(a){a.success&&b.refresh()}})})})},_detaillistProduct:function(){var a=this,b=this.$el;this.detaillistProduct=new r({warpEl:$(".tab-product-box",b),title:"产品",url:"/FCustomer/GetProductRelationsByCustomerID",data:{customerID:a.myID},hideAddBtn:!0,emptyStr:"当前客户下没有获取到产品，请在机会下添加",jDatas:"oppProductRelations",thDatas:["名称","单位","单价","数量","总价"],aoColumnsData:[{mData:"productName",sWidth:"200px",sClass:"text-black",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"unit",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"unitAmount",sWidth:"90px",bSortable:!1,mRender:function(a){var b=_.str.numberFormat(parseFloat(a),2),c='<span title="'+b+'">'+b+"</span>";return c}},{mData:"count",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+a+'">'+a+"</span>";return b}},{mData:"totalAmount",sWidth:"90px",bSortable:!1,mRender:function(a){var b=_.str.numberFormat(parseFloat(a),2),c='<span title="'+b+'">'+b+"</span>";return c}},{mData:"blank",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}]}),this.detaillistProduct.on("add",function(){a.myID}),this.detaillistProduct.on("modify",function(){}),this.detaillistProduct.on("tr",function(b){a.addProductDialog.show({oppProductRelationID:b.oppProductRelationID})}),this.detaillistProduct.on("del",function(a){var b=this;f.confirm("你确定要删除该产品吗？","",function(){f.api({url:"/FCustomer/DeleteOppProductRelation",type:"post",dataType:"json",data:{oppProductRelationID:a.oppProductRelationID},success:function(a){a.success&&b.refresh()}})})}),this.detaillistProduct.$el.find(".table-add-btn").hide(),this.detaillistProduct.on("loadSuccess",function(){a.detaillistProduct.$el.find(".table-add-btn").hide()})},setComponent:function(){var b=this.$el,e=this,j=this,k=this.options.customerData.value.FCustomer,l=e.options.customerData.value.FCustomer.fBusinessTagRelations[0].fBusinessTagOptionName;this._detaillistProduct(),this._detaillistContracts(),this._detaillistOpp(),this.selectColleague=new i({isMultiSelect:!1,hasWorkLeaveBtn:!1,title:"选择负责人"}),this.selectColleague.on("selected",function(a){var c=e.options.customerData.value.FCustomer.ownerID;f.confirm("您确定要将该销售客户的负责人变更为【"+a.name+"】吗?"," ",function(){f.api({url:"/FCustomer/ModifyFCustomerOwner",type:"post",dataType:"json",data:{customerID:y.id,ownerID:a.employeeID},success:function(d){d.success&&(f.remind(1,"变更成功"),$(".customer-detail-resp",b).text(a.name),e.options.customerData.value.FCustomer.ownerID=a.employeeID,j.timeline.followUpBox.replace(c,a),location.reload())}},{submitSelector:""})})});var m=[];_.map(d.getAppStore("contactData").fBusinessTags,function(b){101==b.systemTagCode&&(a=b.fBusinessTagID,_.map(b.options,function(a){a.fBusinessTagOptionID==(k.fBusinessTagRelations[0]&&k.fBusinessTagRelations[0].fBusinessTagOptionID)?m.push({text:a.name,value:a.fBusinessTagOptionID,selected:!0}):m.push({text:a.name,value:a.fBusinessTagOptionID})}),f.mnSelect(v,"syncModel",m))}),f.mnEvent($(".customer-status-select",c),"change",function(a,c){f.confirm("是否确定要将当前客户的【客户状态】修改为【"+c+"】?"," ",function(){f.api({url:"/FCustomer/ModifyCustomerState",type:"post",dataType:"json",data:{customerID:y.id,tagOptionID:a},success:function(a){a.success?(f.remind(2,"修改成功"),e.refresh()):$(".customer-status-select",b).find(".mn-select-title").text(l)}},{submitSelector:""})},{onCancel:function(){$(".customer-status-select",b).find(".mn-select-title").text(l)}})});var n=$(".tab-menu",this.$el);this.tab=new g({element:n,container:this.$el,items:[{value:"tab-time-line",text:"时间线"},{value:"tab-base-info",text:"基本信息"},{value:"tab-contacts",text:"联系人"},{value:"tab-opp",text:"机会"},{value:"tab-contract",text:"合同"},{value:"tab-product",text:"产品"},{value:"tab-files",text:"附件"}]}),this.tab.on("change",function(a,b){switch(b){case"tab-product":e.detaillistProduct.refresh();break;case"tab-opp":e.detaillistOpp.refresh();break;case"tab-contract":e.detaillistContracts.refresh();break;case"tab-contacts":e.detaillistContacts.refresh()}});var o=$(".tab-files-box",this.$el),p=y.id;this.attachmentList=new h({element:o,condition:{fbrType:1,dataID:p}}),this.attachmentList.on("uploaded",function(){j.timeline.attachment.reload()})},selectChgFun:function(a,b){f.confirm("是否确定要将当前客户的【客户状态】修改为【"+b+"】?"," ",function(){f.api({url:"/FCustomer/ModifyCustomerState",type:"post",dataType:"json",data:{customerID:y.id,tagOptionID:a},success:function(){f.remind(2,"修改成功")}},{submitSelector:""})})},_setPageInfo:function(){var a=this.$el,b=this.options.customerData.value.FCustomer;$(".crm-detail-tab",a).children("h1").text(b.name),$(".customer-detail-resp",a).text(b.owner.name);var c=$(".customer-to-follow-btn",a);b.isFollowed?c.addClass("following").text("已关注"):c.addClass("no-follow").text("关注")},loadCustomerData:function(){var a=this;f.api({url:"/FCustomer/GetFCustomerDetailByID",type:"get",dataType:"json",data:{customerID:y.id,attachNum:6},success:function(b){b.success?(a.options.customerData=b,a.setComponent(),a.timeline=new k({warpEl:w,customerData:a.options.customerData,detail:a,selectColleagueS:a.selectColleague}),a.timeline.v=a,a.baseinfo=new l({warpEl:x,customerData:a.options.customerData,detail:a}),a.baseinfo.v=a,a.editDialog=new j({warpEl:"",customerID:a.options.customerData.value.FCustomer.customerID}),a.editDialog.v=a,a.editDialog.on("success",function(){a.refresh()}),a.addContractDialog=new m({customerID:a.options.customerData.value.FCustomer.customerID,customerName:a.options.customerData.value.FCustomer.name}),a.addContractDialog.on("success",function(){a.detaillistContracts.refresh(),a.timeline.refresh()}),a.modifyContractDialog=new m,a.modifyContractDialog.on("success",function(){a.detaillistContracts.refresh()}),a.addOppDialog=new p({customerID:a.options.customerData.value.FCustomer.customerID,customerName:a.options.customerData.value.FCustomer.name}),a.addOppDialog.on("success",function(){a.detaillistOpp.refresh(),a.timeline.refresh()}),a.addContactDialog=new n({customerID:a.options.customerData.value.FCustomer.customerID,customerName:a.options.customerData.value.FCustomer.name}),a.editContactDialog=new n,a.editContactDialog.on("updateSuccess",function(){a.detaillistContacts.refresh(),a.timeline.refresh()}),a.addContactDialog.on("success",function(){a.detaillistContacts.refresh(),a.timeline.refresh()}),a.addProductDialog=new q,a.addProductDialog.on("success",function(){a.timeline.refresh(),a.detaillistProduct.refresh()}),a.modifyOppDialog=new p,a.modifyOppDialog.on("success",function(){a.detaillistOpp.refresh()}),a.contactsDialog=new o({title:"给客户选择联系人",defaultCondition:{employeeID:f.getCrmData().currentEmp.employeeID}}),a.contactsDialog.on("selected",function(b){var c={customerID:y.id},d=[];_.each(b,function(a){d.push(a.contactID)}),c.contactIDs=d,f.api({url:"/Contact/BatchCombineContactAndFCustomer",type:"post",dataType:"json",data:c,success:function(b){b.success&&(a.detaillistContacts.refresh(),a.timeline.refresh())}})}),a._detaillistContacts(),a.operation=new t({element:$(".table-operation-btn",a.$el.find(".tab-contacts-box")),isFollow:b.value.FCustomer.ownerID!=f.getCrmData().currentEmp.employeeID}),a.operation.on("new",function(){a.addContactDialog.show({customerID:y.id,customerName:a.options.customerData.value.FCustomer.name||a.options.customerData.value.FCustomer.customerName})}),a.operation.on("select",function(){a.contactsDialog.show()}),a._setPageInfo()):f.alert(b.message,function(){a._pageBack()})}},{errorAlertModel:"1"})},refresh:function(){var b=this;f.api({url:"/FCustomer/GetFCustomerDetailByID",type:"get",dataType:"json",data:{customerID:y.id,attachNum:6},success:function(c){if(c.success){b.options.customerData=c,b.timeline?b.timeline.refresh():b.timeline=new k({warpEl:w,customerData:b.options.customerData,detail:b}),b.baseinfo?b.baseinfo.refresh():b.baseinfo=new l({warpEl:x,customerData:b.options.customerData,detail:b}),b._setPageInfo();var e=[],g=b.options.customerData.value.FCustomer;_.map(d.getAppStore("contactData").fBusinessTags,function(b){101==b.systemTagCode&&(a=b.fBusinessTagID,_.map(b.options,function(a){a.fBusinessTagOptionID==(g.fBusinessTagRelations[0]&&g.fBusinessTagRelations[0].fBusinessTagOptionID)?e.push({text:a.name,value:a.fBusinessTagOptionID,selected:!0}):e.push({text:a.name,value:a.fBusinessTagOptionID})}),f.mnSelect(v,"syncModel",e))})}else f.alert(c.message,function(){b._pageBack()})}},{submitSelector:""})},refreshRespName:function(a){$(".customer-detail-resp",this.element).text(a.name);var b=this.options.customerData.value.FCustomer.ownerID;this.timeline.followUpBox.replace(b,a),this.options.customerData.value.FCustomer.ownerID=a.employeeID},_getCustomerTagsDatas:function(){var a=f.getCrmData(),b=a.fBusinessTags,c=a.functionPermissions,d=a.currentEmp.employeeID,e=[],g=[],h=[{text:"不限",value:0}];_.each(b,function(a){a.type===f.CONSTANT.TAG_TYPE.CUSTOMER?(e.push(a),_.each(a.options,function(a){h.push({text:a.name,value:a.fBusinessTagOptionID})})):a.type===f.CONSTANT.TAG_TYPE.CONTACTS&&g.push(a)}),this.tags=e,this.currentEmpID=d,this.productLineTagsForList=h,this.functionPermissions=c},_switchFollow:function(a){var b=$(a.target),c=this.options.customerData.value.FCustomer.customerID;b.hasClass("following")?f.api({url:"/FCustomer/CancelFCustomerFollow",type:"post",dataType:"json",data:{customerID:c},success:function(a){a.success&&b.removeClass("following").addClass("no-follow").text("关注")}}):f.api({url:"/FCustomer/FCustomerFollow",type:"post",dataType:"json",data:{customerID:c},success:function(a){a.success&&b.removeClass("no-follow").addClass("following").text("已关注")}})},_pageBack:function(){y.returnUrl?(e.navRouter.navigate(y.returnUrl,{trigger:!0}),e.event.trigger("dataUpdate")):e.navRouter.navigate("#customers/home",{trigger:!0})},_editCustomer:function(){this.editDialog.show({dialogType:3,flag:"edit"})},_chgResp:function(){this.selectColleague.show()}});this.customerDetail=new z;var A=this;e.event.one("beforeremove",function(a){a==u&&A.destroy()})},destroy:function(){this.customerDetail.destroy()}})});