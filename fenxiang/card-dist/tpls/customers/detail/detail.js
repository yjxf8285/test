/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/customers/detail/detail",["util","uilibs/search-box","modules/crm-customer-baseinfo/crm-customer-baseinfo","modules/crm-customer-timeline/crm-customer-timeline","uilibs/tabs2","modules/crm-attachment/crm-attachment","modules/crm-select-colleague/crm-select-colleague","modules/crm-customer-edit/crm-customer-edit"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.store,e.list;var f=a("util"),g=(a("uilibs/search-box"),a("modules/crm-customer-baseinfo/crm-customer-baseinfo")),h=a("modules/crm-customer-timeline/crm-customer-timeline"),i=a("uilibs/tabs2"),j=a("modules/crm-attachment/crm-attachment"),k=a("modules/crm-select-colleague/crm-select-colleague"),l=a("modules/crm-customer-edit/crm-customer-edit");b.init=function(){var a,c=b.tplEl,m=(b.tplName,$(".customer-status-select",c)),n=$(".tab-time-line-box",c),o=$(".tab-base-info-box",c),p=$(".top-menu-tab",c),q=f.getTplQueryParams2(),r=Backbone.View.extend({el:c,events:{"click .customer-to-follow-btn":"_switchFollow","click .button-back":"_pageBack","click .customers-edit-btn":"_editCustomer","click .customers-chg-respo-btn":"_chgResp","click .customer-detail-resp":"_chgResp"},initialize:function(){this._getCustomerTagsDatas(),this.render()},render:function(){this.loadCustomerData()},setComponent:function(){var b=this.$el,c=this,e=this.options.customerData.value.fCustomer;this.selectColleague=new k({isMultiSelect:!1,hasWorkLeaveBtn:!1,title:"选择负责人"}),this.selectColleague.on("selected",function(a){f.confirm("您确定要将该销售客户的负责人变更为【"+a.name+"】吗?"," ",function(){f.api({url:"/FCustomer/ModifyFCustomerOwner",type:"post",dataType:"json",data:{customerID:q.id,ownerID:a.employeeID},success:function(){$(".customer-detail-resp",b).text(a.name)}},{submitSelector:""})})}),d.getAppStore("contactData").fBusinessTags.map(function(b){if(101==b.systemTagCode){a=b.fBusinessTagID;var d=[];b.options.map(function(a){a.fBusinessTagOptionID==(e.fBusinessTagRelations[0]&&e.fBusinessTagRelations[0].fBusinessTagOptionID)?d.push({text:a.name,value:a.fBusinessTagOptionID,selected:!0}):d.push({text:a.name,value:a.fBusinessTagOptionID})}),f.mnSelect(m,"syncModel",d),f.mnEvent(m,"change",function(b,d){f.confirm("是否确定要将当前客户的【客户状态】修改为【"+d+"】?"," ",function(){f.api({url:"/FCustomer/ModifyCustomerState",type:"post",dataType:"json",data:{customerID:q.id,tagOptionID:b},success:function(){var e=c.options.customerData.value.fCustomer.fBusinessTagRelations;_.each(e,function(c){c.fBusinessTagID==a&&(c.fBusinessTagOptionID=b,c.fBusinessTagOptionName=d)})}},{submitSelector:""})})})}}),this.tab=new i({element:p,container:this.$el,items:[{value:"tab-time-line",text:"时间线"},{value:"tab-base-info",text:"基本信息"},{value:"tab-contacts",text:"联系人"},{value:"tab-opp",text:"机会"},{value:"tab-contract",text:"合同"},{value:"tab-product",text:"产品"},{value:"tab-files",text:"附件"}]});var g=$(".tab-files-box",this.$el),h=q.id;this.attachmentList=new j({element:g,condition:{fbrType:1,dataID:h}}),this.attachmentList.on("uploaded",function(){}),this._setPageInfo()},_setPageInfo:function(){var a=this.$el,b=this.options.customerData.value.fCustomer;$(".customers-detail-hd",a).children("h1").text(b.name),$(".customer-detail-resp",a).text(b.owner.name);var c=$(".customer-to-follow-btn",a);b.isFollowed?c.addClass("customers-detail-following").text("已关注"):c.addClass("customers-detail-no-follow").text("关注")},loadCustomerData:function(){var a=this;f.api({url:"/FCustomer/GetCustomerByID",type:"get",dataType:"json",data:{customerID:q.id},success:function(b){b.success&&(a.options.customerData=b,a.setComponent(),a.timeline=new h({warpEl:n,customerData:a.options.customerData,detail:a}),a.timeline.v=a,a.baseinfo=new g({warpEl:o,customerData:a.options.customerData,detail:a}),a.baseinfo.v=a)}},{submitSelector:""})},refresh:function(){var a=this;f.api({url:"/FCustomer/GetCustomerByID",type:"get",dataType:"json",data:{customerID:q.id},success:function(b){b.success&&(a.options.customerData=b,a.timeline?a.timeline.refresh():a.timeline=new h({warpEl:n,customerData:a.options.customerData,detail:a}),a.baseinfo?a.baseinfo.refresh():a.baseinfo=new g({warpEl:o,customerData:a.options.customerData,detail:a}))}},{submitSelector:""})},_getCustomerTagsDatas:function(){var a=f.getCrmData(),b=a.fBusinessTags,c=a.functionPermissions,d=[],e=[{text:"不限",value:0}];_.each(b,function(a){a.type===f.CONSTANT.TAG_TYPE.CUSTOMER&&(d.push(a),_.each(a.options,function(a){e.push({text:a.name,value:a.fBusinessTagOptionID})}))}),this.tags=d,this.productLineTagsForList=e,this.functionPermissions=c},_switchFollow:function(a){var b=$(a.target),c=this.options.customerData.value.fCustomer.customerID;b.hasClass("customers-detail-following")?f.api({url:"/FCustomer/CancelFCustomerFollow",type:"post",dataType:"json",data:{customerID:c},success:function(a){a.success&&b.removeClass("customers-detail-following").addClass("customers-detail-no-follow").text("关注")}}):f.api({url:"/FCustomer/FCustomerFollow",type:"post",dataType:"json",data:{customerID:c},success:function(a){a.success&&b.removeClass("customers-detail-no-follow").addClass("customers-detail-following").text("已关注")}})},_pageBack:function(){var a=decodeURIComponent(q.returnUrl);if(a.indexOf("/=/")>0);else{var b={refresh:"false"};q.queryType&&(b.queryType=q.queryType),a+="/=/param-"+encodeURIComponent(JSON.stringify(b))}e.navRouter.navigate(a,{trigger:!0})},_editCustomer:function(){var a=this;this.editDialog&&(this.editDialog.v=null,this.editDialog=null),this.editDialog=new l({warpEl:"",customerData:a.options.customerData}),this.editDialog.v=this,this.editDialog.show()},_chgResp:function(){this.selectColleague.show()}});new r}});