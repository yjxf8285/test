/**
 * 纷享页面逻辑
 * @Author: 纷享网页前端部
 * @Date: 2014-11-03
 */
define("tpls/contacts/showcontact/showcontact",["util","modules/feed-list/feed-list","dialog","moment","uilibs/tabs2","modules/crm-select-colleague/crm-select-colleague","modules/publish/publish-helper","modules/crm-attachment-simple/crm-attachment-simple","modules/crm-attachment/crm-attachment","modules/crm-modify-records/crm-modify-records","modules/crm-salesclue-edit/crm-salesclue-edit","modules/crm-select-customer/crm-select-customer","modules/crm-contact-edit/crm-contact-edit","modules/crm-detaillists/crm-detaillists","modules/crm-publish/crm-publish","uilibs/tabs"],function(a,b){var c=window,d=c.FS,e=d.tpl;e.event;var f=a("util"),g=a("modules/feed-list/feed-list");a("dialog");var h=a("moment"),i=a("uilibs/tabs2"),j=a("modules/crm-select-colleague/crm-select-colleague");a("modules/publish/publish-helper");var k=a("modules/crm-attachment-simple/crm-attachment-simple"),l=a("modules/crm-attachment/crm-attachment"),m=a("modules/crm-modify-records/crm-modify-records");a("modules/crm-salesclue-edit/crm-salesclue-edit");var n=a("modules/crm-select-customer/crm-select-customer"),o=a("modules/crm-contact-edit/crm-contact-edit"),p=a("modules/crm-detaillists/crm-detaillists"),q=a("modules/crm-publish/crm-publish"),r=a("uilibs/tabs"),s=function(a){a=$.extend({element:null},a||{}),this.options=a,this.$el=a.element,this.myID=this.options.queryParams.id,this.init()};$.extend(s.prototype,{init:function(){this.$el,this._getTagsDatas(),this.setupComponent(),this.bindEvents();var a=this,c=b.tplName;e.event.one("beforeremove",function(b){b==c&&a.destroy()})},bindEvents:function(){var a=this.$el,b=this;f.mnEvent($(".updatestates-select-list",a),"change",function(a,c){f.confirm("是否确定要将当前合同的【状态】变更为【"+c+"】？","",function(){f.api({url:"/Contact/UpdateContractsStates",type:"post",dataType:"json",data:{contractIDs:b.myID,states:a},success:function(a){a.success&&(f.remind(1,"变更成功"),b.load())}})})}),a.on("click",".crm-button-back",function(){b._backToListPage()}),a.on("click",".delete-btn",function(){b._delete()}),a.on("click",".create-btn",function(a){var c=$(a.target),d=b.responseData.value.contact.company;d?f.confirm("是否通过该联系人创建相关客户?","&nbsp;",function(){f.api({url:"/FCustomer/AddFCustomerByContactID",type:"post",dataType:"json",data:{contactID:b.myID},success:function(a){a.success&&(c.hide(),b.refresh(),b.tab.select("tab-time-line"))}})}):f.alert("没有公司名称不能创建相关客户。")}),a.on("click",".modify-btn",function(){b.modifyCompetitorDialog.show()}),a.on("click",".batchcombinecontactandfcustomer-btn",function(){var a=b.responseData.value.contact.company||"";b.customerDialog.show(a)}),a.on("click",".uncombinecontactandfcustomer-btn",function(){b._unCombineContactAndFCustomer(),b.tab.select("tab-time-line")}),a.on("click",".follow-switch-btn",function(a){b._switchFollow(a)}),this.customerDialog.on("selected",function(a){b._batchCombineContactAndFCustomer(a)})},_switchFollow:function(a){var b=$(a.target),c=this;b.hasClass("following")?f.api({url:"/Contact/ContractCancelFollow",type:"post",dataType:"json",data:{contractID:c.myID},success:function(a){a.success&&b.removeClass("following").addClass("no-follow").text("关注")}}):f.api({url:"/Contact/ContractFollow",type:"post",dataType:"json",data:{contractID:c.myID},success:function(a){a.success&&b.removeClass("no-follow").addClass("following").text("已关注")}})},_getTagsDatas:function(){var a=f.getCrmData(),b=a.functionPermissions,c=f.getTagsByType(9),d=[],e=this,g=a.currentEmp.employeeID,h=[{text:"不限",value:0}],i=[{text:"不限",value:0}];_.each(c,function(a){d.push(a),109===a.systemTagCode&&(_.each(a.options,function(a){i.push({text:a.name,value:a.fBusinessTagOptionID})}),e.marketingEventTypeFBusinessTagID=a.fBusinessTagID)}),_.extend(this,{allTags:d,competitorscale:h,currentEmpId:g,functionPermissions:b})},setCrmAttachment:function(){var a=this,b=$(".crm-attachment-simple-warp",this.$el);this.attachment=new k({element:b,condition:{dataID:a.myID,fbrType:2}}),this.attachment.render(),this.attachment.on("toAll",function(){a.tab.select("tab-files")}),this.attachment.on("uploaded",function(){a.attachmentList.reload()})},setAttachmentList:function(){var a=this,b=$(".crm-attachmentlist-simple-warp",this.$el);this.attachmentList=new l({element:b,condition:{fbrType:2,dataID:a.myID}}),this.attachmentList.on("uploaded",function(){a.attachment.reload()})},setFeedList:function(){var a=this;$(".crm-feed-list-warp",this.$el),$(".feed-list-pagination",this.$el);var b=$(".search-inp",this.$el),c=$(".search-btn",this.$el),d=$(".feed-tabs",this.$el);this.feedTabs=new r({element:d,triggers:$(".ui-tab-item",d),panels:$(".ui-tab-panel",d),activeIndex:0,activeTriggerClass:"ui-tab-item-current",triggerType:"click"}).render(),this.feedTabs.on("switched",function(d){var e=this.get("panels").eq(d);a.feedList=new g({element:$(".crm-feed-list-warp",e),pagSelector:$(".feed-list-pagination",e),pagOpts:{pageSize:15,visiblePageNums:3},GetBatchFilesSource:1,crmParam:{type:"contact",id:a.myID},listPath:"/CrmFeed/GetFeeds",defaultRequestData:function(){return{feedType:d,fbrType:2,dataID:a.myID,type:1,keyword:_.str.trim(b.val())}},listEmptyText:"暂无记录",searchOpts:{inputSelector:b,btnSelector:c}}),a.feedList.load()}),this.feedTabs.trigger("switched",0,-1),c.on("click",function(c){a.feedList.reload({keyword:_.str.trim(b.val())}),c.preventDefault()})},showFnBtn:function(){var a=this.$el,b=this.responseData.value,c=b.canModify,d=b.canDelete,e=b.canChangeOwner,f=b.contact.creatorID,g=this.currentEmpId;c?$(".modify-btn",a).show():$(".modify-btn",a).hide(),d?$(".delete-btn",a).show():$(".delete-btn",a).hide(),e?$(".canchangeowner-btn",a).show():$(".canchangeowner-btn",a).hide(),f!=g&&($(".batchcombinecontactandfcustomer-btn",a).hide(),$(".uncombinecontactandfcustomer-btn",a).hide())},render:function(){var a,b,c=this.$el,d=this,e=this.responseData.value.contact||null,g=this.responseData.value.customer||0,i="",j=$(".follow-switch-btn",c),k="",l="",m='<span class="birthday-info">'+e.monthOfBirth+"月"+e.dayOfBirth+"日是"+e.name+"的生日,记得送去温馨的祝福哦！</span>",n=f.getTplQueryParams2();if(e.isShowBirthDay||(m=""),g&&g.customerID>0?(a=g.name||"",$(".jdata-customer-fullname",c).text(g.fullName),$(".jdata-customer-name",c).text(g.name),$(".jdata-customer-address",c).text(g.address),$(".jdata-customer-website",c).text(g.webSite),$(".jdata-customer-introduction",c).text(g.introduction),g?(b={id:g.customerID,returnUrl:"contacts/showcontact/=/param-"+encodeURIComponent(JSON.stringify(n))},$(".jdata-customername",c).html('<a href="#customers/showcustomer/=/param-'+encodeURIComponent(JSON.stringify(b))+'" style="line-height:13px;">'+g.name+"</a>").show()):$(".jdata-customername",c).html('<a href="javascript:;"></a>').hide(),g.fBusinessTagRelations&&(_.each(g.fBusinessTagRelations,function(a){var b=a.fBusinessTagName,c=a.fBusinessTagOptionName;i+='<li class="fn-clear"><span class="input-tip">'+b+'</span><div class="input-wrapper">'+c+"</div></li>"}),$(".customerfbusinesstagrelations",c).html(i))):$(".jdata-customername",c).html('<a href="javascript:;"></a>').hide(),e.customerID>0?($(".batchcombinecontactandfcustomer-btn",c).hide(),$(".create-btn",c).hide(),$(".uncombinecontactandfcustomer-btn",c).show(),b={id:e.customerID,returnUrl:"contacts/showcontact/=/param-"+encodeURIComponent(JSON.stringify(n))},$(".isbatch-warp",c).html('<span class="words">已关联到客户“</span><a title="'+a+'" class="link" href="#customers/showcustomer/=/param-'+encodeURIComponent(JSON.stringify(b))+'">'+a+"</a>"+'<span class="words">”</span>').addClass("cur")):($(".batchcombinecontactandfcustomer-btn",c).show(),$(".create-btn",c).show(),$(".uncombinecontactandfcustomer-btn",c).hide(),$(".isbatch-warp",c).html("尚未关联到客户").removeClass("cur")),e){e.fBusinessTagRelations&&(_.each(e.fBusinessTagRelations,function(a){var b=a.fBusinessTagName,c=a.fBusinessTagOptionName;i+='<li class="fn-clear"><span class="input-tip">'+b+'</span><div class="input-wrapper">'+c+"</div></li>"}),$(".product-fbusinesstagrelations",c).html(i));var p=$(".contact-define-field-tag-ul",c),q=[];e.userDefineFieldDataList&&e.userDefineFieldDataList.textList&&_.map(e.userDefineFieldDataList.textList,function(a){""!=a.value&&(q.push('<li class="fn-clear"><div class="input-tip">'),q.push(a.fieldDescription),q.push('</div><div class="textarea-wrapper">'),q.push(a.value),q.push("</div></li>"))}),e.userDefineFieldDataList&&e.userDefineFieldDataList.dateList&&_.map(e.userDefineFieldDataList.dateList,function(a){a.value>0&&(q.push('<li class="fn-clear"><div class="input-tip">'),q.push(a.fieldDescription),q.push('</div><div class="input-wrapper">'),q.push(h.unix(a.value).format("YYYY年MM月DD日")),q.push("</div></li>"))}),e.userDefineFieldDataList&&e.userDefineFieldDataList.numList&&_.map(e.userDefineFieldDataList.numList,function(a){q.push('<li class="fn-clear"><div class="input-tip">'),q.push(a.fieldDescription),q.push('</div><div class="input-wrapper">'),q.push(a.value),q.push("</div></li>")}),q.length>0?(p.show(),p.html(q.join(""))):p.hide(),e.contactWayObject.length>0?(_.each(e.contactWayObject,function(a){var b=a.typeDesc,c=a.content;l+='<li class="fn-clear"><span class="input-tip">'+b+'</span><div class="input-wrapper">'+c+"</div></li>"}),$(".contactwayobject-warp-baseinfo",c).html(l).show(),$(".contactwayobject-warp",c).html("<ul>"+l+"</ul>")):($(".contactwayobject-warp-baseinfo",c).hide(),$(".contactwayobject-warp",c).html('<div class="text-align-c">当前联系人没有联系方式</div>')),e.addressObject.length>0?(_.each(e.addressObject,function(a){k+='<li class="fn-clear"><span class="input-tip">地址</span><div class="input-wrapper">'+a+"</div></li>"}),$(".addressobject-warp",c).html(k).show()):$(".addressobject-warp",c).hide();var r=e.yearOfBirth+"年",s=e.monthOfBirth+"月",t=e.dayOfBirth+"日";!e.yearOfBirth&&(r=""),!e.monthOfBirth&&(s=""),!e.dayOfBirth&&(t=""),$(".birthday-warp",c).html('<li class="fn-clear"><span class="input-tip">生日</span><div class="input-wrapper">'+r+s+t+"</div></li>"),e.isFollow?j.addClass("following").text("已关注"):j.addClass("no-follow").text("关注"),$(".hd-titname",c).html(e.name+m),$(".jdata-creatorname",c).text(e.creator.name),$(".jdata-creatorname",c).text(e.creator.name),$(".jdata-createtime",c).text(h.unix(e.createTime).format("YYYY年MMMDD日 HH:mm")),$(".jdata-lastedittime",c).text(h.unix(e.lastEditTime).format("YYYY年MMMDD日 HH:mm")),$(".jdata-name",c).text(e.name),$(".jdata-post",c).text(e.post),$(".jdata-department",c).text(e.department),$(".jdata-company",c).text(e.company),$(".jdata-website",c).text(e.webSite),$(".jdata-remark",c).text(e.remark)}this.showFnBtn(),this.modifyCompetitorDialog=new o({contactID:this.options.queryParams&&this.options.queryParams.id}),this.modifyCompetitorDialog.on("success",function(){d.refresh()}),this.modifyCompetitorDialog.v=this},load:function(){this.$el;var a=this;f.api({url:"/Contact/GetContactDetailByID",type:"get",dataType:"json",data:{contactID:a.myID,attachNum:6},success:function(b){b.success?(a.responseData=b,a.render(),a.setPublish(),a.setCard(b.value.contact.picturePath)):f.alert(b.message,function(){a._backToListPage()},{zIndex:3e3})}},{errorAlertModel:"1"})},setCard:function(a){var b=this.$el;return""==a?($(".contacts-card-box",b).hide(),void 0):($(".contacts-card-box",b).show(),$(".contacts-card-image",b).attr("src",f.getAvatarLink(a,1)),void 0)},refresh:function(){this.load()},_backToListPage:function(){var a=f.getTplQueryParams2();e.navRouter.navigate(a.returnUrl,{trigger:!0}),e.event.trigger("dataUpdate")},_delete:function(){var a=this;f.confirm("你确定要删除该联系人吗？删除后将不可恢复。","",function(){f.api({url:"/Contact/DeleteContact",type:"post",dataType:"json",data:{contactID:a.myID},success:function(b){b.success&&a._backToListPage()}})})},_batchCombineContactAndFCustomer:function(a){var b=this;f.api({url:"/Contact/BatchCombineContactAndFCustomer",type:"post",dataType:"json",data:{customerID:a.customerID,contactIDs:b.myID},success:function(a){a.success&&(b.tab.select("tab-time-line"),b.refresh())}})},_unCombineContactAndFCustomer:function(){var a=this;f.confirm("你确定要将该联系人从客户下移除吗？此操作不可恢复。","",function(){f.api({url:"/Contact/UnCombineContactAndFCustomer",type:"post",dataType:"json",data:{contactID:a.myID},success:function(b){b.success&&a.refresh()}})})},_detaillistShareContacts:function(){var a=this,b=this.$el;this.detaillistShareContacts?this.detaillistShareContacts.refresh():this.detaillistShareContacts=new p({warpEl:$(".tab-share-contact-box",b),rightTopBTnText:"共享",title:"共享联系人",pagination:!0,url:"/Contact/GetShareContactsToOthers",data:{employeeID:0,contactID:a.myID,pageSize:10,pageNumber:1},emptyStr:"暂无共享",emptyBtnWords:"立即共享",jDatas:"shareContactDetails",thDatas:["描述","共享时间","操作"],aoColumnsData:[{mData:"employeeName",sWidth:"500px",sClass:"text-black",bSortable:!1,mRender:function(b,c,d){var e="";e=a.currentEmpId==d.shareEmployeeID?"我":d.shareName;var f='<span title="'+b+'">'+e+"共享给"+b+"</span>";return f}},{mData:"shareTime",sWidth:"90px",bSortable:!1,mRender:function(a){var b='<span title="'+h.unix(a).format("YYYY-MM-DD")+'">'+h.unix(a).format("YYYY-MM-DD")+"</span>";return b}},{mData:"blank",sWidth:"200px",bSortable:!1,mRender:function(a,b,c){var d="";return d=c.isCreated?"已创建":'<a href="javascript:;" class="table-del-btn">删除</a>'}},{mData:"blank",sClass:"th-blank",bSortable:!1,mRender:function(){var a="";return a}}]}),this.detaillistShareContacts.on("add",function(){a.selectColleague.show({exceptEmployeeIDs:f.getCurrentEmp().employeeID})}),this.detaillistShareContacts.on("del",function(a){var b=this;f.confirm("你确定要删除该共享吗？","",function(){f.api({url:"/Contact/DeleteShareContactMessageByID",type:"post",dataType:"json",data:{shareContactMessageID:a.shareContactMessageID},success:function(a){a.success&&b.refresh()}})})})},_modifyRecords:function(){var a=this,b=$(".crm-modifyrecords-wrap",this.$el);this.modifyrecords=new m({wrapEl:b,contactId:this.options.queryParams&&this.options.queryParams.id,recordsUrl:"/Contact/GetSnapshotsOfContactID",snapshotsUrl:"/Contact/GetContactSnapshotTwoEntity",restoreUrl:"/Contact/RestoreSnapshot",v:a})},_selectColleague:function(){var a=this;this.selectColleague=new j({isMultiSelect:!0,hasWorkLeaveBtn:!1}),this.selectColleague.on("selected",function(b){for(var c=a.options.queryParams&&a.options.queryParams.id,d=[],e=0,g=b.length;g>e;e++)d.push(b[e].employeeID);d.length&&f.api({url:"//Contact/ShareContactToEmployees",type:"post",dataType:"json",data:{contactID:c,employeeIDs:d},success:function(){f.remind(2,"成功共享联系人"),a.detaillistShareContacts.refresh()}})})},setPublish:function(){var a=this,b=this.$el,c=a.myID.toString();this.feedpublish||(this.feedpublish=new q({element:$(".feed-submit-box-warp",b),title:"新建销售记录",placeholder:"发布新销售记录",isContact:!0,type:"event",contactInfo:a.responseData.value.contact,condition:{associationContactIDs:"",fileInfos:[],isAllDayEvent:!1,startTime:0,remindType:1,isSentSms:!1,feedContent:"",parentFeedID:0,listTagOptionID:[],fbrType:2,customerID:a.responseData.value.contact.customerID,contactIDs:c,salesOpportunityID:a.responseData.value.contact.salesOpportunityID},display:["time","picture","attach","tag","at","topic"]}),this.feedpublish.on("post",function(){a.feedList.load({keyword:""}),a.feedTabs.switchTo(0)}))},setupComponent:function(){var a=this,b=$(".tab-menu",this.$el);this.setFeedList(),this.setCrmAttachment(),this.setAttachmentList(),this._detaillistShareContacts(),this._modifyRecords(),this._selectColleague(),this.tab=new i({element:b,container:this.$el,items:[{value:"tab-time-line",text:"时间线"},{value:"tab-base-info",text:"基本信息"},{value:"tab-share-contact",text:"共享联系人"},{value:"tab-customer-info",text:"客户信息"},{value:"tab-modify-records",text:"修改记录"},{value:"tab-files",text:"附件"}]}),this.customerDialog=new n({defaultCondition:{keyword:"",employeeID:a.currentEmpId}}),this.tab.on("change",function(b,c){switch(c){case"tab-share-contact":a.detaillistShareContacts.refresh();break;case"tab-competitor":a.detaillistCompetitor.refresh();break;case"tab-contract":a.detaillistContracts.refresh();break;case"tab-modify-records":a.modifyrecords.refresh();break;case"tab-customer-info":a.refresh();var d=$(".havecustomer-info-warp",this.$el),e=$(".nocustomer-info-warp",this.$el),f=a.responseData.value.customer;f&&f.customerID>0?(e.hide(),d.show()):(e.show(),d.hide())}})},destroy:function(){this.feedpublish&&this.feedpublish.destroy()}}),b.init=function(){var a=b.tplEl;b.tplName;var c=f.getTplQueryParams2(),d=new s({element:a,queryParams:c});d.load()}});